# Neo4j Data Pipeline Schema Definition
#
# This YAML file defines the complete schema for:
# 1. Data extraction (transform_to_neo4j.py)
# 2. Neo4j import (import_to_neo4j.py)
#
# To add a new entity type:
# 1. Add node definition under 'nodes'
# 2. Add relationship definitions under 'relationships' (if applicable)
# 3. Implement extractor function matching the signature
#
# All specs are automatically validated on load.

# =============================================================================
# Node Definitions
# =============================================================================
nodes:
  command:
    name: commands
    label: Command
    csv_filename: commands.csv
    id_field: id
    description: Command definitions
    fields:
      - id
      - name
      - category
      - command
      - description
      - subcategory
      - filled_example  # Pre-filled command example
      - notes
      - oscp_relevance
      # Enriched fields (stored as JSON strings)
      - examples
      - educational
      - related_commands
      - troubleshooting
      - flag_explanations
      - prerequisites
      - alternatives
      - next_steps
    extractor: _extract_commands_csv

  attack_chain:
    name: attack_chains
    label: AttackChain
    csv_filename: attack_chains.csv
    id_field: id
    description: Attack chain metadata
    fields:
      - id
      - name
      - description
      - version
      - category
      - platform
      - difficulty
      - time_estimate
      - oscp_relevant
      - notes
    extractor: _extract_attack_chains_csv

  cheatsheet:
    name: cheatsheets
    label: Cheatsheet
    csv_filename: cheatsheets.csv
    id_field: id
    description: OSCP cheatsheets with scenarios and command references
    fields:
      - id
      - name
      - description
      - tags
      - educational_header
      - scenarios
      - sections
    extractor: _extract_cheatsheets_csv

  tag:
    name: tags
    label: Tag
    csv_filename: tags.csv
    id_field: name
    description: Unique tags
    fields:
      - name
      - category
    extractor: _extract_unique_tags_adapted

  variable:
    name: variables
    label: Variable
    csv_filename: variables.csv
    id_field: name
    description: Command variables
    fields:
      - id
      - name
      - description
      - example
      - required
    extractor: _extract_variables_nodes

  flag:
    name: flags
    label: Flag
    csv_filename: flags.csv
    id_field: id
    description: Command flags
    fields:
      - id
      - flag
      - explanation
    extractor: _extract_flags_nodes

  indicator:
    name: indicators
    label: Indicator
    csv_filename: indicators.csv
    id_field: id
    description: Success/failure indicators
    fields:
      - id
      - pattern
      - indicator_type
    extractor: _extract_indicators_nodes

  chain_step:
    name: chain_steps
    label: ChainStep
    csv_filename: chain_steps.csv
    id_field: id
    description: Chain steps
    fields:
      - id
      - name
      - objective
      - description
      - expected_output
      - notes
    extractor: _extract_chain_steps_nodes

  # =========================================================================
  # Writeup Nodes
  # =========================================================================
  writeup:
    name: writeups
    label: Writeup
    csv_filename: writeups.csv
    id_field: id
    description: Machine writeups with attack phases and learnings
    fields:
      - id
      - name
      - platform
      - machine_type
      - difficulty
      - os
      - os_version
      - ip_address
      - oscp_relevance
      - oscp_reasoning
      - exam_applicable
      - synopsis
      - total_duration_minutes
      - release_date
      - retire_date
      - writeup_author
      - writeup_date
      - tags
      - machine_author
      - points
      - attack_phases
    extractor: _extract_writeups_nodes

  cve:
    name: cves
    label: CVE
    csv_filename: cves.csv
    id_field: cve_id
    description: CVE vulnerability entries discovered in writeups
    fields:
      - cve_id
      - name
      - description
      - severity
      - component
      - version
      - exploitability
      - type
    extractor: _extract_cve_nodes

  technique:
    name: techniques
    label: Technique
    csv_filename: techniques.csv
    id_field: name
    description: Attack techniques demonstrated in writeups
    fields:
      - name
      - category
      - difficulty
      - description
      - oscp_applicable
      - steps
      - detection_difficulty
      - references
    extractor: _extract_technique_nodes

  platform:
    name: platforms
    label: Platform
    csv_filename: platforms.csv
    id_field: name
    description: Training platforms (HackTheBox, ProvingGrounds, etc.)
    fields:
      - name
      - url
      - type
    extractor: _extract_platform_nodes

  skill:
    name: skills
    label: Skill
    csv_filename: skills.csv
    id_field: name
    description: Skills required or learned from writeups
    fields:
      - name
      - category
      - oscp_importance
    extractor: _extract_skill_nodes

  # =========================================================================
  # Engagement Tracking Nodes
  # =========================================================================
  # NOTE: Engagement tracking (Client, Engagement, Target, Finding, Service)
  # is handled by the Python CLI (crack engagement/target/finding commands)
  # using Neo4j directly, not the CSV import pipeline. These nodes are
  # created dynamically during active engagements, not bulk imported.
  # See: tools/engagement/adapter.py for the Neo4j adapter.

# =============================================================================
# Relationship Definitions
# =============================================================================
relationships:
  command_has_variable:
    name: command_has_variable
    rel_type: USES_VARIABLE
    csv_filename: command_has_variable.csv
    start_label: Command
    end_label: Variable
    start_id_col: command_id
    end_id_col: variable_id
    start_id_field: id
    end_id_field: name
    description: Command uses variable
    fields:
      - command_id
      - variable_id
      - position
      - example
      - required
    extractor: _extract_command_variables_rels

  command_has_flag:
    name: command_has_flag
    rel_type: HAS_FLAG
    csv_filename: command_has_flag.csv
    start_label: Command
    end_label: Flag
    start_id_col: command_id
    end_id_col: flag_id
    start_id_field: id
    end_id_field: id
    description: Command has flag option
    fields:
      - command_id
      - flag_id
      - position
    extractor: _extract_command_flags_rels

  command_has_indicator:
    name: command_has_indicator
    rel_type: HAS_INDICATOR
    csv_filename: command_has_indicator.csv
    start_label: Command
    end_label: Indicator
    start_id_col: command_id
    end_id_col: indicator_id
    start_id_field: id
    end_id_field: id
    description: Command has output indicator
    fields:
      - command_id
      - indicator_id
      - indicator_type
    extractor: _extract_command_indicators_rels

  command_tagged_with:
    name: command_tagged_with
    rel_type: TAGGED
    csv_filename: command_tagged_with.csv
    start_label: Command
    end_label: Tag
    start_id_col: command_id
    end_id_col: tag_name
    start_id_field: id
    end_id_field: name
    description: Command tagged with tag
    fields:
      - command_id
      - tag_name
    extractor: _extract_command_tag_rels

  command_alternative_for:
    name: command_alternative_for
    rel_type: ALTERNATIVE
    csv_filename: command_alternative_for.csv
    start_label: Command
    end_label: Command
    start_id_col: command_id
    end_id_col: alternative_command_id
    start_id_field: id
    end_id_field: id
    description: Command is alternative to another
    fields:
      - command_id
      - alternative_command_id
    extractor: _extract_command_alternatives_rels

  command_requires:
    name: command_requires
    rel_type: PREREQUISITE
    csv_filename: command_requires.csv
    start_label: Command
    end_label: Command
    start_id_col: command_id
    end_id_col: prerequisite_command_id
    start_id_field: id
    end_id_field: id
    description: Command requires prerequisite command
    fields:
      - command_id
      - prerequisite_command_id
    extractor: _extract_command_prerequisites_rels

  command_next_step:
    name: command_next_step
    rel_type: NEXT_STEP
    csv_filename: command_next_step.csv
    start_label: Command
    end_label: Command
    start_id_col: command_id
    end_id_col: next_step_command_id
    start_id_field: id
    end_id_field: id
    description: Command has logical next step
    fields:
      - command_id
      - next_step_command_id
    extractor: _extract_command_next_steps_rels

  chain_contains_step:
    name: chain_contains_step
    rel_type: HAS_STEP
    csv_filename: chain_contains_step.csv
    start_label: AttackChain
    end_label: ChainStep
    start_id_col: chain_id
    end_id_col: step_id
    start_id_field: id
    end_id_field: id
    description: Attack chain contains step
    fields:
      - chain_id
      - step_id
      - order
    extractor: _extract_chain_steps_rels

  step_uses_command:
    name: step_uses_command
    rel_type: EXECUTES
    csv_filename: step_uses_command.csv
    start_label: ChainStep
    end_label: Command
    start_id_col: step_id
    end_id_col: command_id
    start_id_field: id
    end_id_field: id
    description: Chain step executes command
    fields:
      - step_id
      - command_id
    extractor: _extract_step_commands_rels

  chain_tagged_with:
    name: chain_tagged_with
    rel_type: TAGGED
    csv_filename: chain_tagged_with.csv
    start_label: AttackChain
    end_label: Tag
    start_id_col: chain_id
    end_id_col: tag_name
    start_id_field: id
    end_id_field: name
    description: Attack chain tagged with tag
    fields:
      - chain_id
      - tag_name
    extractor: _extract_chain_tag_rels

  cheatsheet_references_command:
    name: cheatsheet_references_command
    rel_type: REFERENCES_COMMAND
    csv_filename: cheatsheet_references_command.csv
    start_label: Cheatsheet
    end_label: Command
    start_id_col: cheatsheet_id
    end_id_col: command_id
    start_id_field: id
    end_id_field: id
    description: Cheatsheet references command in scenario or section
    fields:
      - cheatsheet_id
      - command_id
      - context
      - scenario_title
      - section_title
      - example
      - shows
    extractor: _extract_cheatsheet_command_rels

  cheatsheet_tagged_with:
    name: cheatsheet_tagged_with
    rel_type: TAGGED
    csv_filename: cheatsheet_tagged_with.csv
    start_label: Cheatsheet
    end_label: Tag
    start_id_col: cheatsheet_id
    end_id_col: tag_name
    start_id_field: id
    end_id_field: name
    description: Cheatsheet tagged with tag
    fields:
      - cheatsheet_id
      - tag_name
    extractor: _extract_cheatsheet_tag_rels

  # =========================================================================
  # Writeup Relationships
  # =========================================================================
  writeup_demonstrates_command:
    name: writeup_demonstrates_command
    rel_type: DEMONSTRATES
    csv_filename: writeup_demonstrates_command.csv
    start_label: Writeup
    end_label: Command
    start_id_col: writeup_id
    end_id_col: command_id
    start_id_field: id
    end_id_field: id
    description: Writeup demonstrates usage of command
    fields:
      - writeup_id
      - command_id
      - phase
      - step_number
      - context
      - command_executed
      - success
      - notes
      - flags_used
      - output_snippet
      - url_visited
    extractor: _extract_writeup_demonstrates_command_rels

  writeup_failed_attempt:
    name: writeup_failed_attempt
    rel_type: FAILED_ATTEMPT
    csv_filename: writeup_failed_attempt.csv
    start_label: Writeup
    end_label: Command
    start_id_col: writeup_id
    end_id_col: command_id
    start_id_field: id
    end_id_field: id
    description: Writeup documents failed attempt with command
    fields:
      - writeup_id
      - command_id
      - phase
      - attempt
      - command_executed
      - expected
      - actual
      - reason
      - solution
      - lesson_learned
      - time_wasted_minutes
      - importance
    extractor: _extract_writeup_failed_attempt_rels

  writeup_exploits_cve:
    name: writeup_exploits_cve
    rel_type: EXPLOITS_CVE
    csv_filename: writeup_exploits_cve.csv
    start_label: Writeup
    end_label: CVE
    start_id_col: writeup_id
    end_id_col: cve_id
    start_id_field: id
    end_id_field: cve_id
    description: Writeup exploits CVE vulnerability
    fields:
      - writeup_id
      - cve_id
      - phase
      - exploitation_method
      - severity
      - location
      - parameter
    extractor: _extract_writeup_exploits_cve_rels

  writeup_teaches_technique:
    name: writeup_teaches_technique
    rel_type: TEACHES_TECHNIQUE
    csv_filename: writeup_teaches_technique.csv
    start_label: Writeup
    end_label: Technique
    start_id_col: writeup_id
    end_id_col: technique_name
    start_id_field: id
    end_id_field: name
    description: Writeup teaches attack technique
    fields:
      - writeup_id
      - technique_name
      - phase
      - difficulty
      - oscp_applicable
    extractor: _extract_writeup_teaches_technique_rels

  writeup_from_platform:
    name: writeup_from_platform
    rel_type: FROM_PLATFORM
    csv_filename: writeup_from_platform.csv
    start_label: Writeup
    end_label: Platform
    start_id_col: writeup_id
    end_id_col: platform_name
    start_id_field: id
    end_id_field: name
    description: Writeup is from training platform
    fields:
      - writeup_id
      - platform_name
      - machine_type
      - release_date
      - retire_date
    extractor: _extract_writeup_from_platform_rels

  writeup_requires_skill:
    name: writeup_requires_skill
    rel_type: REQUIRES_SKILL
    csv_filename: writeup_requires_skill.csv
    start_label: Writeup
    end_label: Skill
    start_id_col: writeup_id
    end_id_col: skill_name
    start_id_field: id
    end_id_field: name
    description: Writeup requires prerequisite skill
    fields:
      - writeup_id
      - skill_name
      - importance
    extractor: _extract_writeup_requires_skill_rels

  writeup_teaches_skill:
    name: writeup_teaches_skill
    rel_type: TEACHES_SKILL
    csv_filename: writeup_teaches_skill.csv
    start_label: Writeup
    end_label: Skill
    start_id_col: writeup_id
    end_id_col: skill_name
    start_id_field: id
    end_id_field: name
    description: Writeup teaches new skill
    fields:
      - writeup_id
      - skill_name
      - proficiency_level
      - practice_value
    extractor: _extract_writeup_teaches_skill_rels

  # =========================================================================
  # Engagement Tracking Relationships
  # =========================================================================
  # NOTE: Engagement tracking relationships are created dynamically by the
  # Python CLI during active engagements. See: tools/engagement/adapter.py

# =============================================================================
# Configuration Notes
# =============================================================================
#
# Extractor Function Signature:
#   def extractor_name(commands: List[Dict], chains: List[Dict],
#                      cheatsheets: List[Dict]) -> List[Dict]
#
# Node Extractors:
#   - Must return List[Dict] with keys matching 'fields'
#   - Must include 'id_field' in returned dictionaries
#
# Relationship Extractors:
#   - Must return List[Dict] with keys matching 'fields'
#   - Must include 'start_id_col' and 'end_id_col' in returned dictionaries
#
# ID Fields:
#   - 'id_field' in nodes: Field used as primary key
#   - 'start_id_field'/'end_id_field' in relationships: Which field to match on
#
# Example:
#   If variable.id_field = 'name', then command->variable relationships
#   use variable.name instead of variable.id for matching
