{
  "id": "bloodhound-custom-cypher-workflow",
  "name": "BloodHound Custom Cypher Query Workflow",
  "description": "Advanced BloodHound enumeration using custom Cypher queries when pre-built queries return 'No paths found'.\n\nThis chain focuses specifically on the CRITICAL scenario: You've collected BloodHound data, imported it, marked your compromised user as owned, run 'Shortest Paths to Domain Admins' query, and got 'No paths found'. This does NOT mean no path exists - it means you need custom Cypher queries to discover non-obvious attack paths.\n\nWHY THIS MATTERS: Pre-built BloodHound queries are optimized for DIRECT paths (user \u2192 DA in 1-3 hops). Real-world AD environments have INDIRECT paths that require intermediate pivots: compromise user A \u2192 discover user A has AdminTo on system B \u2192 discover system B has DA service session \u2192 harvest DA credentials. These multi-stage paths are INVISIBLE to pre-built queries but DISCOVERABLE with custom Cypher.\n\nCRITICAL pentest PATTERN: When BloodHound says 'no paths found', students often give up and pivot to different attack vectors. WRONG. The correct approach: iterate through ALL compromised users with custom Cypher queries checking AdminTo, HasSession, and MemberOf relationships. The writeup demonstrates: pete (no path) \u2192 mike (AdminTo CLIENT75) \u2192 CLIENT75 (has DA session) \u2192 domain compromise.\n\nSUCCESS RATE: Very high (70-80% of 'no paths found' scenarios CAN find paths with custom queries). The key is knowing WHICH queries to run and WHEN to run them.\n\nLESSON FROM CORP-DCSYNC WRITEUP: 'BloodHound no paths found doesn't mean no path exists - means you need to compromise intermediate accounts first. Custom Cypher queries reveal paths that pre-built queries miss.'",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - pentest Track",
    "created": "2025-11-25",
    "updated": "2025-11-25",
    "tags": [
      "ACTIVE_DIRECTORY",
      "ENUMERATION",
      "BLOODHOUND",
      "CYPHER",
      "PRIVILEGE_ESCALATION"
    ],
    "category": "enumeration",
    "platform": "active-directory",
    "references": [
      "https://bloodhound.readthedocs.io/en/latest/data-analysis/cypher-queries.html",
      "https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/",
      "https://neo4j.com/docs/cypher-manual/current/",
      "https://github.com/BloodHoundAD/BloodHound"
    ]
  },
  "difficulty": "intermediate",
  "time_estimate": "10 minutes (5 min pre-built queries, 5 min custom queries)",
  "prerequisites": [
    "BloodHound data collected and imported to Neo4j",
    "At least one compromised domain user account",
    "BloodHound GUI running and connected to Neo4j",
    "Understanding of AD relationships (AdminTo, HasSession, MemberOf)",
    "Basic Cypher query syntax knowledge"
  ],
  "notes": "This chain is CRITICAL when pre-built queries fail. It teaches systematic enumeration of attack paths using custom Cypher queries.\n\nCRITICAL SUCCESS FACTORS:\n1. Mark ALL compromised users as owned (not just first user)\n2. Test custom queries for EACH compromised user individually\n3. Look for AdminTo relationships first (lateral movement opportunities)\n4. Check HasSession on systems where you have AdminTo (credential harvest opportunities)\n5. Iterate - finding one intermediate user may unlock paths for others\n\nCOMMON FAILURES:\n- Only testing one compromised user: Test ALL users, some have paths others don't\n- Giving up after pre-built queries fail: This is when custom queries become critical\n- Wrong Cypher syntax: Username format is 'USER@DOMAIN.COM' (uppercase, with domain)\n- Not marking users as owned: Query results won't show paths FROM owned principals\n- Searching for paths TO wrong target: Use 'DOMAIN ADMINS@DOMAIN.COM' (group name with space)\n\nCYPHER QUERY PATTERNS:\n\nAdminTo enumeration:\nMATCH (u:User {name:'USER@DOMAIN.COM'})-[:AdminTo]->(c:Computer) RETURN u,c\n\nHasSession on specific computer:\nMATCH (c:Computer {name:'SYSTEM.DOMAIN.COM'})<-[:HasSession]-(u:User) RETURN c,u\n\nPaths to Domain Admins (custom depth):\nMATCH p=(u:User {name:'USER@DOMAIN.COM'})-[*1..3]->(g:Group {name:'DOMAIN ADMINS@DOMAIN.COM'}) RETURN p\n\nFind high-value targets (DA sessions):\nMATCH (u:User)-[:MemberOf*1..]->(g:Group {name:'DOMAIN ADMINS@DOMAIN.COM'})\nMATCH (u)-[:HasSession]->(c:Computer)\nRETURN u.name, c.name\n\nALTERNATIVE METHODS:\n- Manual JSON parsing: jq '.data[] | select(.Properties.name==\"USER@DOMAIN.COM\")' users.json\n- Neo4j Browser: Direct Neo4j web interface (http://localhost:7474) for advanced queries\n- Command-line cypher-shell: cypher-shell -u neo4j -p password < queries.cypher\n\nTIME ESTIMATES:\n- Mark users as owned: 1 minute per user\n- Run pre-built queries: 2 minutes\n- Custom AdminTo queries: 2 minutes (test all users)\n- Custom HasSession queries: 2 minutes\n- Path validation: 3 minutes\n- TOTAL: 10 minutes from 'no paths' to identified attack path\n\nWHY CUSTOM QUERIES WORK:\n- Pre-built queries optimize for DIRECT paths (shortest distance)\n- Real attacks use INDIRECT paths (compromise intermediate accounts)\n- Custom queries let you ask specific questions: 'Which systems can THIS user admin?'\n- Iterative approach: Each discovered relationship unlocks new query possibilities",
  "steps": [
    {
      "id": "mark-owned-users",
      "name": "Mark All Compromised Users as Owned",
      "objective": "Mark all compromised domain users as 'owned' in BloodHound to enable owned-principal queries",
      "description": "Mark every compromised user account as owned in BloodHound GUI. This is CRITICAL because pre-built queries filter for paths FROM owned principals.\n\nProcess:\n1. Open BloodHound GUI\n2. Use search bar to find first compromised user (type username)\n3. Right-click user node \u2192 'Mark User as Owned'\n4. Verify: User icon shows red skull icon\n5. Repeat for ALL compromised users (pete, mike, dave, etc.)\n\nWhy This Matters:\n- Pre-built query 'Shortest Paths to Domain Admins from Owned Principals' ONLY shows paths from marked users\n- If you forget to mark a user as owned, their paths won't appear in queries\n- Marking multiple users increases chances of finding attack path\n\nExpected State:\n- All compromised users show red skull icon in BloodHound\n- Node info panel shows 'Owned: Yes'\n- Pre-built queries now include these users in results\n\nTroubleshooting:\n- Can't find user: Check username format (should be 'user@domain.com' lowercase)\n- Multiple users with same name: Check SID or full distinguished name\n- Mark doesn't persist: BloodHound database may not be writable (check Neo4j permissions)\n- User not in database: Re-run BloodHound collection, ensure user exists in domain\n\nCLI Alternative (if GUI unavailable):\nUsing cypher-shell:\n```\nMATCH (u:User {name:'PETE@CORP.LOCAL'}) SET u.owned=true RETURN u.name\n```\n\nBatch marking (if many users):\n```\nMATCH (u:User) WHERE u.name IN ['PETE@CORP.LOCAL', 'MIKE@CORP.LOCAL', 'DAVE@CORP.LOCAL'] SET u.owned=true RETURN u.name\n```\n\nVerification:\nRun query to list all owned users:\n```\nMATCH (u:User {owned:true}) RETURN u.name\n```\n\nCommon Mistake:\nMarking only FIRST compromised user. The writeup shows: pete had NO paths, but mike (also compromised) had AdminTo on CLIENT75. Test ALL users.",
      "command_ref": null,
      "evidence": [
        "All compromised users show red skull icon in BloodHound",
        "Node info confirms 'Owned: Yes' for each user",
        "Cypher query confirms owned=true property set"
      ],
      "dependencies": [],
      "repeatable": true,
      "success_criteria": [
        "All compromised users marked as owned",
        "Red skull icons visible on user nodes",
        "Cypher verification query confirms owned=true"
      ],
      "failure_conditions": [
        "User not found in database: Re-run BloodHound collection",
        "Mark doesn't save: Check Neo4j database write permissions",
        "Multiple users with same name: Use full distinguished name or SID"
      ],
      "next_steps": [
        "run-prebuilt-queries"
      ]
    },
    {
      "id": "run-prebuilt-queries",
      "name": "Run Pre-Built Queries and Document Results",
      "objective": "Execute BloodHound pre-built queries to establish baseline before moving to custom queries",
      "description": "Run BloodHound's pre-built queries to check for obvious attack paths. When these fail (return 'No paths found'), this validates the need for custom Cypher queries.\n\nPre-Built Queries to Run:\n\n1. 'Shortest Paths to Domain Admins from Owned Principals'\n   - Analysis tab \u2192 Pre-Built Queries \u2192 Pathfinding\n   - Click query name to execute\n   - Expected result: Graph showing paths OR 'No paths found'\n\n2. 'Shortest Paths to High Value Targets from Owned Principals'\n   - Broader than Domain Admins (includes Enterprise Admins, other groups)\n   - May find paths even if DA query fails\n\n3. 'Find Computers where Domain Users are Local Admin'\n   - Shows systems with over-privileged access\n   - Filter results for owned users\n\n4. 'List all Owned Principals'\n   - Verification query: confirms all users marked correctly\n   - Should show pete, mike, dave, etc.\n\nDocumenting Results:\n- 'No paths found': Proceed to custom Cypher queries (expected scenario)\n- Paths found: Document path, validate it's exploitable, execute attack\n- Partial results: Some users have paths, others don't (iterate with custom queries)\n\nCRITICAL UNDERSTANDING:\n'No paths found' from pre-built queries does NOT mean:\n- No attack path exists\n- You should give up on BloodHound\n- Lateral movement is impossible\n\nIt DOES mean:\n- No DIRECT path from owned users to Domain Admins\n- Need to find INDIRECT paths via intermediate systems/users\n- Time to use custom Cypher queries\n\nQuery Execution Tips:\n- Wait 5-10 seconds for large domains (thousands of users)\n- If query hangs, check Neo4j CPU usage (may need optimization)\n- Graph view can be zoomed (scroll wheel) and panned (drag)\n- Node info: Click any node to see properties, relationships, permissions\n\nExpected Timeline:\n- Small domain (<100 users): Queries run in 1-2 seconds\n- Medium domain (100-1000 users): 5-10 seconds per query\n- Large domain (>1000 users): May need query optimization or timeout adjustment\n\nTroubleshooting:\n- All queries return empty: Check if users actually marked as owned (step 1)\n- Query timeout: Increase Neo4j timeout in BloodHound settings\n- Can't find Analysis tab: Check BloodHound version (v4+ has different UI)\n- Graph too complex: Use filters to hide low-value nodes",
      "command_ref": "bloodhound-analyze-paths",
      "evidence": [
        "Screenshot or note of query results",
        "Documentation of 'No paths found' status",
        "List of queries executed with timestamps"
      ],
      "dependencies": [
        "mark-owned-users"
      ],
      "repeatable": true,
      "success_criteria": [
        "All 4 pre-built queries executed",
        "Results documented (paths found or 'no paths')",
        "Confirmed need for custom queries if 'no paths found'"
      ],
      "failure_conditions": [
        "Queries return empty: Users not marked as owned correctly",
        "Query timeout: Increase Neo4j timeout settings",
        "Database not responding: Restart Neo4j service"
      ],
      "next_steps": [
        "enumerate-adminto"
      ]
    },
    {
      "id": "enumerate-adminto",
      "name": "Enumerate AdminTo Relationships for Each User",
      "objective": "Use custom Cypher to find all systems where compromised users have local admin privileges",
      "description": "Run custom Cypher query to enumerate AdminTo relationships for each compromised user. This identifies lateral movement opportunities.\n\nCustom Cypher Query:\n```\nMATCH (u:User {name:'PETE@CORP.LOCAL'})-[:AdminTo]->(c:Computer)\nRETURN u.name, c.name\n```\n\nExecution Process:\n1. Open BloodHound GUI\n2. Click 'Raw Query' field at top (or query icon)\n3. Paste query with first compromised user\n4. Replace 'PETE@CORP.LOCAL' with actual username (UPPERCASE, with @DOMAIN)\n5. Press Enter or click Execute\n6. Review results in graph view and table view\n7. Repeat for ALL compromised users\n\nExpected Results:\n- List of systems where user has local admin\n- Graph showing user \u2192 AdminTo \u2192 computer relationships\n- System hostnames with domain suffix (CLIENT75.CORP.LOCAL)\n\nExample Output:\n```\nu.name              | c.name\n--------------------|----------------------\nPETE@CORP.LOCAL     | (no results)\nMIKE@CORP.LOCAL     | CLIENT75.CORP.LOCAL\nDAVE@CORP.LOCAL     | WORKSTATION10.CORP.LOCAL\n```\n\nInterpretation:\n- Pete: No AdminTo relationships (dead end for this user)\n- Mike: AdminTo on CLIENT75 (LATERAL MOVEMENT OPPORTUNITY)\n- Dave: AdminTo on WORKSTATION10 (LATERAL MOVEMENT OPPORTUNITY)\n\nNext Steps After Finding AdminTo:\n1. Document all AdminTo relationships\n2. Prioritize: Servers > Workstations (more likely to have valuable sessions)\n3. Check for HasSession relationships on these systems (step 4)\n4. Plan lateral movement using evil-winrm, PSExec, or WMI\n\nAdvanced Query (All Users at Once):\n```\nMATCH (u:User {owned:true})-[:AdminTo]->(c:Computer)\nRETURN u.name, c.name\n```\n\nThis shows AdminTo for ALL owned users in one query. Faster but may be overwhelming with many results.\n\nQuery Variants:\n\nCount AdminTo relationships:\n```\nMATCH (u:User {name:'MIKE@CORP.LOCAL'})-[:AdminTo]->(c:Computer)\nRETURN u.name, count(c) as admin_count\n```\n\nFilter for specific computer types:\n```\nMATCH (u:User {owned:true})-[:AdminTo]->(c:Computer)\nWHERE c.operatingsystem CONTAINS 'Server'\nRETURN u.name, c.name, c.operatingsystem\n```\n\nTroubleshooting:\n- No results for any user: Check username format (must be 'USER@DOMAIN.COM')\n- 'Invalid property' error: User not in database, check collection\n- Too many results: Filter by OS, last logon, or other properties\n- Can't copy query: Type manually, ensure quotes are correct (single quotes for strings)\n\nCRITICAL: Don't stop after first user with no AdminTo. Iterate through ALL users. The writeup shows pete had nothing, but mike had CLIENT75.",
      "command_ref": "bloodhound-cypher-query",
      "evidence": [
        "List of all AdminTo relationships for compromised users",
        "Systems identified for lateral movement",
        "Graph screenshot showing relationships"
      ],
      "dependencies": [
        "run-prebuilt-queries"
      ],
      "repeatable": true,
      "success_criteria": [
        "Query executed for all compromised users",
        "At least 1 AdminTo relationship found",
        "Target systems documented for next steps"
      ],
      "failure_conditions": [
        "No AdminTo for any user: Users may have limited privileges, check group memberships instead",
        "Syntax error: Verify username format and Cypher syntax",
        "Query returns too many results: Add filters for OS or last logon time"
      ],
      "next_steps": [
        "check-sessions"
      ]
    },
    {
      "id": "check-sessions",
      "name": "Check for High-Value Sessions on Accessible Systems",
      "objective": "Query for Domain Admin sessions on systems where compromised users have AdminTo access",
      "description": "Use custom Cypher to check if systems (where you have AdminTo) have Domain Admin sessions cached. This identifies credential harvesting opportunities.\n\nCustom Cypher Query:\n```\nMATCH (c:Computer {name:'CLIENT75.CORP.LOCAL'})<-[:HasSession]-(u:User)\nRETURN c.name, u.name, u.enabled\n```\n\nExecution Process:\n1. Take list of systems from step 3 (where you have AdminTo)\n2. For EACH system, run query to check sessions\n3. Replace 'CLIENT75.CORP.LOCAL' with actual system name\n4. Look for Domain Admin accounts in results\n5. Verify user is enabled (u.enabled = true)\n\nExpected Results:\n```\nc.name                   | u.name                    | u.enabled\n-------------------------|---------------------------|----------\nCLIENT75.CORP.LOCAL      | ADMINISTRATOR@CORP.LOCAL  | true\nCLIENT75.CORP.LOCAL      | WORKSTATION_USER@CORP.LOCAL | true\n```\n\nInterpretation:\n- ADMINISTRATOR session on CLIENT75: JACKPOT! This is Domain Admin\n- WORKSTATION_USER session: Standard user, less valuable\n- Focus on: Administrator, svc_admin, any account with 'admin' in name\n\nVerify Domain Admin Membership:\nCustom query to check if user is Domain Admin:\n```\nMATCH (u:User {name:'ADMINISTRATOR@CORP.LOCAL'})-[:MemberOf*1..]->(g:Group {name:'DOMAIN ADMINS@CORP.LOCAL'})\nRETURN u.name, g.name\n```\n\nIf query returns results: User IS Domain Admin\nIf query returns empty: User is not Domain Admin, check other groups\n\nAdvanced Query (All Sessions on Accessible Systems):\n```\nMATCH (u:User {owned:true})-[:AdminTo]->(c:Computer)\nMATCH (c)<-[:HasSession]-(u2:User)\nWHERE u2.enabled = true\nRETURN u.name as owned_user, c.name as system, u2.name as session_user\n```\n\nThis finds ALL sessions on ALL systems where owned users have AdminTo. Faster for multiple systems.\n\nPrioritization:\n1. Domain Admins: Highest priority (instant domain compromise)\n2. Enterprise Admins: Even higher privileges (multi-domain access)\n3. Service accounts: Often reused passwords, lateral movement\n4. IT/helpdesk accounts: Over-privileged, may have access to sensitive systems\n\nQuery Variants:\n\nFilter for admin-like names:\n```\nMATCH (c:Computer {name:'CLIENT75.CORP.LOCAL'})<-[:HasSession]-(u:User)\nWHERE u.name CONTAINS 'ADMIN' OR u.name CONTAINS 'SVC'\nRETURN c.name, u.name\n```\n\nCheck session count:\n```\nMATCH (c:Computer {name:'CLIENT75.CORP.LOCAL'})<-[:HasSession]-(u:User)\nRETURN c.name, count(u) as session_count\n```\n\nTroubleshooting:\n- No sessions found: System may be offline, check last logon time\n- Only computer accounts: No user sessions cached, target different system\n- Can't verify DA membership: Check group name format ('DOMAIN ADMINS@DOMAIN.COM')\n- Too many sessions: Filter for enabled=true and admin-like names\n\nCRITICAL SUCCESS: Found CLIENT75 has ADMINISTRATOR session + mike has AdminTo on CLIENT75 = Attack Path!\nNext: Lateral movement to CLIENT75 \u2192 credential harvest \u2192 domain compromise",
      "command_ref": "bloodhound-cypher-query",
      "evidence": [
        "List of sessions on accessible systems",
        "Domain Admin sessions identified",
        "Verification of DA group membership",
        "Target system prioritized for credential harvest"
      ],
      "dependencies": [
        "enumerate-adminto"
      ],
      "repeatable": true,
      "success_criteria": [
        "Sessions queried for all AdminTo systems",
        "At least 1 high-value session identified",
        "Confirmed user is Domain Admin or privileged",
        "Attack path documented: owned user \u2192 AdminTo \u2192 system \u2192 HasSession \u2192 DA"
      ],
      "failure_conditions": [
        "No sessions found: Systems may be offline or haven't been logged into recently",
        "Only standard user sessions: Target servers instead of workstations",
        "Can't verify group membership: Check group name format and domain"
      ],
      "next_steps": [
        "validate-attack-path"
      ]
    },
    {
      "id": "validate-attack-path",
      "name": "Validate and Document Attack Path",
      "objective": "Verify the discovered attack path is exploitable and document complete chain",
      "description": "Validate that the discovered attack path is actually exploitable before executing the attack. This prevents wasting time on broken paths.\n\nAttack Path Format:\nCompromised User \u2192 AdminTo \u2192 System \u2192 HasSession \u2192 Domain Admin\n\nExample from Corp-DCSync Writeup:\nMIKE@CORP.LOCAL \u2192 AdminTo \u2192 CLIENT75 \u2192 HasSession \u2192 ADMINISTRATOR@CORP.LOCAL\n\nValidation Checklist:\n\n1. Compromised User Access:\n   - Confirm you have credentials for mike (password or hash)\n   - Test authentication: crackmapexec smb <any_system> -u mike -p <password>\n   - Verify mike is marked as owned in BloodHound\n\n2. AdminTo Relationship:\n   - Confirm mike has local admin on CLIENT75\n   - Test access: crackmapexec smb CLIENT75 -u mike -p <password>\n   - Look for 'Pwn3d!' indicator (confirms local admin)\n\n3. System Accessibility:\n   - Confirm CLIENT75 is online: ping CLIENT75.CORP.LOCAL\n   - Check WinRM port: nmap -p 5985,5986 CLIENT75.CORP.LOCAL\n   - Check SMB port: nmap -p 445 CLIENT75.CORP.LOCAL\n\n4. Session Validity:\n   - BloodHound data may be stale (hours/days old)\n   - Administrator session MIGHT have logged out\n   - Service sessions more reliable (persist until reboot)\n   - Validation: Execute attack, check mimikatz output for session\n\n5. Domain Admin Verification:\n   - Confirm ADMINISTRATOR is actually Domain Admin\n   - Command: net group \"Domain Admins\" /domain (from any domain system)\n   - Look for Administrator in member list\n\nDocumenting Attack Path:\n\nText Format:\n```\nAttack Path Discovered:\n- Owned User: mike@corp.local (credentials: mike:Password123!)\n- AdminTo: CLIENT75.CORP.LOCAL (validated with crackmapexec Pwn3d!)\n- HasSession: administrator@corp.local (Domain Admin confirmed)\n- Attack Vector: Lateral movement to CLIENT75 \u2192 mimikatz credential dump \u2192 extract DA hash \u2192 domain compromise\n- Estimated Time: 15 minutes\n- Prerequisites: None (mike credentials sufficient)\n```\n\nVisual Format (Graph Export):\n1. In BloodHound, run custom query to show full path:\n```\nMATCH p=(u:User {name:'MIKE@CORP.LOCAL'})-[:AdminTo]->(c:Computer)<-[:HasSession]-(admin:User)-[:MemberOf*1..]->(g:Group {name:'DOMAIN ADMINS@CORP.LOCAL'})\nRETURN p\n```\n2. Export graph: Right-click \u2192 Export Graph \u2192 PNG\n3. Save for documentation\n\nAlternative Paths:\nIf primary path fails validation:\n- Check OTHER compromised users (dave, pete) for different paths\n- Check OTHER systems where mike has AdminTo\n- Look for group membership paths (MemberOf relationships)\n- Consider Kerberoasting or AS-REP roasting as alternatives\n\nCommon Validation Failures:\n- System offline: Target different system from AdminTo list\n- Session stale: Proceed anyway, check mimikatz output for current sessions\n- No WinRM: Use PSExec or WMI for lateral movement\n- Account disabled: Verify with 'net user <username> /domain'\n\nSuccess Criteria:\n- All 5 validation checks pass\n- Attack path documented completely\n- Ready to execute: lateral movement \u2192 credential harvest \u2192 escalation",
      "command_ref": "crackmapexec-smb-users",
      "evidence": [
        "Complete attack path documented",
        "Crackmapexec validation showing Pwn3d",
        "BloodHound graph export showing full path",
        "System accessibility confirmed (ping/nmap)"
      ],
      "dependencies": [
        "check-sessions"
      ],
      "repeatable": true,
      "success_criteria": [
        "All validation checks pass",
        "Attack path fully documented",
        "Prerequisites identified and met",
        "Backup paths identified if primary fails"
      ],
      "failure_conditions": [
        "System offline: Choose alternative system from AdminTo list",
        "No WinRM: Plan alternative lateral movement (PSExec, WMI)",
        "Session stale: Proceed anyway or wait for user logon"
      ],
      "next_steps": []
    }
  ]
}