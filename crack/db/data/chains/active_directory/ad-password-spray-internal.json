{
  "id": "ad-password-spray-internal",
  "name": "Active Directory Internal Password Spray Attack",
  "description": "Comprehensive internal password spraying attack chain from domain-joined Windows or internal Linux position.\n\nDiscovers password policy, enumerates users, sprays passwords using optimal method (LDAP/SMB/Kerberos), validates credentials, identifies local admin rights, and establishes lateral movement path to domain compromise.",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - pentest Track",
    "created": "2025-11-10",
    "updated": "2025-11-10",
    "tags": [
      "ACTIVE_DIRECTORY",
      "PASSWORD_SPRAY",
      "INTERNAL",
      "LDAP",
      "SMB",
      "KERBEROS",
      "CREDENTIAL_ACCESS",
      "LATERAL_MOVEMENT",
      "PRIVILEGE_ESCALATION"
    ],
    "category": "credential-access",
    "platform": "active-directory",
    "references": [
      "https://github.com/ZilentJack/Spray-Passwords",
      "https://github.com/byt3bl33d3r/CrackMapExec",
      "https://github.com/ropnop/kerbrute",
      "https://attack.mitre.org/techniques/T1110/003/"
    ]
  },
  "difficulty": "intermediate",
  "time_estimate": "30 minutes",
  "prerequisites": [
    "Access to domain-joined Windows system (RDP, WinRM, or command execution) OR internal network position from Linux",
    "Valid domain user credentials (even low-privilege user)",
    "Network access to domain controller (ports 88, 389, 445)",
    "PowerShell access (for Windows LDAP method) OR Linux with kerbrute/crackmapexec"
  ],
  "notes": "certification CRITICAL: This chain demonstrates COMPLETE internal password spraying workflow. Key decision point: Step 3 (choose-spray-method) branches into 3 parallel paths based on your position and requirements. Windows + policy-aware \u2192 PowerShell LDAP (spray-passwords-ldap). Linux + need admin detection \u2192 CrackMapExec SMB (crackmapexec-smb-spray). Linux + maximum speed/stealth \u2192 Kerbrute (kerbrute-passwordspray). ALL METHODS WORK but have different trade-offs. EXAM STRATEGY: If on Windows, use PowerShell LDAP (automatic policy compliance). If on Linux, use Kerbrute for initial spray (fast), then CrackMapExec for admin validation. TIMING: Policy check (5s) + user enum (30s) + spray (1-3min) + validation (30s) = 3-5 minutes per password. CRITICAL: ALWAYS check policy first (step 1) to avoid lockouts.",
  "steps": [
    {
      "id": "discover-password-policy",
      "name": "Discover Domain Password Policy",
      "objective": "Retrieve lockout threshold, observation window, and lockout duration to calculate safe spray limits",
      "description": "METHOD SELECTION: Windows domain-joined \u2192 use net-accounts-policy (fastest, <5 seconds, built-in command).\nLinux with credentials \u2192 use crackmapexec-policy (SMBv2/v3 support, reliable).\nLinux without credentials (rare) \u2192 try enum4linux-policy (null session attempt).\n\nCRITICAL OUTPUT: Lockout threshold (e.g., 5) = max failed attempts before lockout.\nObservation window (e.g., 30min) = time until counter resets.\nLockout duration (e.g., 30min) = how long account stays locked.\n\nSAFE SPRAY CALCULATION: threshold - 1 = safe attempts (e.g., 5 threshold = 4 safe attempts).\nTest 4 passwords max, then wait observation window duration before next round.",
      "command_ref": "net-accounts-policy",
      "evidence": [
        "Lockout threshold documented (e.g., 5 attempts)",
        "Lockout observation window documented (e.g., 30 minutes)",
        "Lockout duration documented (e.g., 30 minutes)",
        "Safe spray limit calculated (threshold - 1)"
      ],
      "dependencies": [],
      "repeatable": false,
      "success_criteria": [
        "Password policy successfully retrieved",
        "Lockout settings documented",
        "Safe spray calculation completed"
      ],
      "failure_conditions": [
        "Access denied (not domain user or wrong credentials)",
        "Connection refused (ports blocked)",
        "System error 1355 (not domain-joined system)"
      ],
      "next_steps": [
        "enumerate-domain-users"
      ]
    },
    {
      "id": "enumerate-domain-users",
      "name": "Enumerate Valid Domain Users",
      "objective": "Build list of valid usernames to spray passwords against",
      "description": "METHOD SELECTION: External or Linux \u2192 kerbrute-userenum-ad (fastest, Kerberos-based, thousands per second).\nLinux with credentials \u2192 ldapsearch-users-ad (comprehensive, gets all AD users via LDAP).\nWindows \u2192 PowerShell LDAP query (built-in, no tools needed).\nLegacy/null session \u2192 enum4linux-users-ad (SMB-based).\n\nRECOMMENDED: Kerbrute for speed (enumerates 10k usernames in 30-60 seconds).\nSave valid usernames to file (users.txt) for next step.\n\nOPTIONAL: Filter for high-value targets (admin accounts, service accounts) but usually spray against all users for maximum coverage.",
      "command_ref": "kerbrute-userenum-ad",
      "evidence": [
        "Valid username list saved to file (users.txt)",
        "50-200+ valid usernames identified",
        "Username format documented (DOMAIN\\username or username@domain.com)"
      ],
      "dependencies": [
        "discover-password-policy"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least 10 valid usernames identified",
        "Usernames saved in correct format for spray tool",
        "No account lockouts triggered during enumeration"
      ],
      "failure_conditions": [
        "Couldn't find any KDCs (wrong DC IP or Kerberos blocked)",
        "Zero valid usernames found (wrong domain or wordlist)",
        "Connection timeout (network connectivity issue)"
      ],
      "next_steps": [
        "choose-spray-method"
      ]
    },
    {
      "id": "choose-spray-method",
      "name": "Choose Password Spraying Method",
      "objective": "Select optimal spray method based on your position and requirements",
      "description": "DECISION MATRIX:\n\n[Windows domain-joined + PowerShell access] \u2192 USE spray-passwords-ldap (PowerShell LDAP method).\nADVANTAGES: Policy-aware (automatic lockout protection), low noise (LDAP authentication = normal traffic), no external tools needed.\nDISADVANTAGES: Windows only, slower (1-2 attempts/sec).\n\n[Linux + need admin detection] \u2192 USE crackmapexec-smb-spray.\nADVANTAGES: Shows (Pwn3d!) for local admin rights immediately, works from Linux.\nDISADVANTAGES: NOISY (full SMB connections logged), slow (2-3 sec per attempt), NOT policy-aware (manual calculation required).\n\n[Linux + maximum speed/stealth] \u2192 USE kerbrute-passwordspray.\nADVANTAGES: FASTEST (hundreds/sec), STEALTHIEST (2 UDP packets only), cross-platform.\nDISADVANTAGES: Doesn't check admin rights, NOT policy-aware.\n\nRECOMMENDATION: If Windows \u2192 PowerShell LDAP.\nIf Linux \u2192 Kerbrute for initial spray, then CrackMapExec for admin validation.\n\nThis step branches into parallel paths (spray-ldap OR spray-smb OR spray-kerberos).",
      "command_ref": "concept-decision",
      "evidence": [
        "Spray method selected and documented",
        "Trade-offs understood (speed vs stealth vs admin detection)",
        "Tool availability confirmed"
      ],
      "dependencies": [
        "enumerate-domain-users"
      ],
      "repeatable": false,
      "success_criteria": [
        "Method selected based on position and requirements",
        "Tool available and tested",
        "Command syntax prepared"
      ],
      "failure_conditions": [
        "None - this is a decision point, not an executable step"
      ],
      "next_steps": [
        "spray-ldap",
        "spray-smb",
        "spray-kerberos"
      ]
    },
    {
      "id": "spray-ldap",
      "name": "Spray Password via PowerShell LDAP (Windows Method)",
      "objective": "Spray common password using PowerShell DirectoryEntry LDAP authentication",
      "description": "FROM WINDOWS ONLY: Use Spray-Passwords.ps1 script (C:\\Tools\\Spray-Passwords.ps1 on many lab systems).\n\nThis script automatically:\n(1) Reads password policy to respect lockout settings.\n(2) Enumerates all domain users via LDAP.\n(3) Attempts authentication for each user with supplied password.\n(4) Spaces attempts to stay under lockout threshold.\n\nCOMMAND: powershell -ep bypass -c \"C:\\Tools\\Spray-Passwords.ps1 -Pass 'Password123!' -Admin\".\nThe -Admin flag includes administrator accounts (default excludes them).\nUse -File flag for multiple passwords instead of -Pass for single password.\n\nTIMING: 2-3 minutes for 100 users with single password.\n\nNOISE LEVEL: Very low - generates Event ID 4776 (NTLM credential validation) which looks like normal user logins.",
      "command_ref": "spray-passwords-ldap",
      "evidence": [
        "Output shows: Guessed password for user: 'username' = 'Password123!'",
        "Valid credentials documented in output",
        "No account lockouts triggered"
      ],
      "dependencies": [
        "choose-spray-method"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least one valid credential found",
        "Script respects lockout threshold automatically",
        "Credentials documented for next steps"
      ],
      "failure_conditions": [
        "Access denied (need domain user context)",
        "Execution policy error (use -ep bypass)",
        "Script not found (upload Spray-Passwords.ps1 or use GitHub version)"
      ],
      "next_steps": [
        "validate-found-credentials"
      ]
    },
    {
      "id": "spray-smb",
      "name": "Spray Password via CrackMapExec SMB (Linux Method)",
      "objective": "Spray password via SMB with immediate admin rights detection",
      "description": "FROM LINUX: Use CrackMapExec with users.txt from step 2.\n\nCOMMAND: crackmapexec smb TARGET -u users.txt -p 'Password123!' -d domain.com --continue-on-success.\nThe --continue-on-success flag prevents stopping at first valid credential (tests all users).\n\nCRITICAL: CrackMapExec does NOT check password policy - you must manually limit attempts.\nBased on policy from step 1, spray maximum (threshold - 1) passwords total.\nExample: 5 threshold = spray 4 different passwords max, with 30min wait between each.\n\nBONUS FEATURE: CrackMapExec shows (Pwn3d!) if credentials have local admin rights on target system.\nThis immediately identifies privilege escalation opportunities.\n\nTARGET can be any domain-joined system IP or domain controller.\n\nTIMING: 2-3 minutes for 50 users.",
      "command_ref": "crackmapexec-smb-spray",
      "evidence": [
        "Output shows [+] domain.com\\username:Password123!",
        "Pwn3d! indicator shown for admin accounts",
        "Valid credentials and admin rights documented"
      ],
      "dependencies": [
        "choose-spray-method"
      ],
      "repeatable": true,
      "success_criteria": [
        "Valid credentials identified",
        "Admin rights status known (Pwn3d! or not)",
        "Manual spray count tracking maintained"
      ],
      "failure_conditions": [
        "STATUS_ACCOUNT_LOCKED_OUT (exceeded threshold - CRITICAL FAILURE)",
        "Connection refused (SMB port blocked)",
        "STATUS_LOGON_FAILURE for all users (wrong password)"
      ],
      "next_steps": [
        "validate-found-credentials"
      ]
    },
    {
      "id": "spray-kerberos",
      "name": "Spray Password via Kerbrute Kerberos (Linux/Windows Fast Method)",
      "objective": "Spray password using Kerberos pre-authentication for maximum speed and stealth",
      "description": "CROSS-PLATFORM: Use Kerbrute from Linux or Windows.\n\nCOMMAND: kerbrute passwordspray -d domain.com --dc DC_IP users.txt 'Password123!'.\nUses Kerberos AS-REQ for authentication - only 2 UDP packets per attempt.\n\nFASTEST METHOD: Can test hundreds of attempts per second.\n\nSTEALTHIEST: Generates minimal logging (Event ID 4768/4771 - normal Kerberos traffic).\n\nCRITICAL: Does NOT check password policy - manually limit to (threshold - 1) attempts per user per observation window.\n\nSave results: add -o valid_creds.txt flag.\n\nTIMING: 10-30 seconds for 100 users.\n\nLIMITATION: Does NOT show local admin rights (use CrackMapExec in next step for admin validation).",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Output shows [+] VALID LOGIN: user@domain.com:Password123!",
        "Valid credentials saved to file",
        "Spray completed in <60 seconds"
      ],
      "dependencies": [
        "choose-spray-method"
      ],
      "repeatable": true,
      "success_criteria": [
        "Valid credentials identified",
        "Results saved to file",
        "No network errors or timeouts"
      ],
      "failure_conditions": [
        "Couldn't find any KDCs (wrong DC IP)",
        "context deadline exceeded (timeout)",
        "Zero valid logins (wrong password)"
      ],
      "next_steps": [
        "validate-found-credentials"
      ]
    },
    {
      "id": "validate-found-credentials",
      "name": "Validate and Check Admin Rights",
      "objective": "Confirm credentials are valid and identify systems where user has local admin privileges",
      "description": "Use CrackMapExec to:\n(1) Validate credentials via SMB authentication.\n(2) Check for local admin rights on network systems.\n(3) Identify best pivot targets.\n\nSUBNET SCAN: crackmapexec smb 192.168.50.0/24 -u username -p 'Password123!' -d domain.com.\nThis scans entire /24 subnet and shows which systems display (Pwn3d!) = local admin rights.\n\nSINGLE TARGET: Test against specific high-value targets (domain controller, servers, administrator workstations).\n\nLook for: [+] = valid credentials.\n[+] (Pwn3d!) = valid credentials + local admin = full system compromise possible.\n\nTIME ESTIMATE: 2-3 minutes for /24 subnet scan.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "Credentials validated successfully",
        "List of systems with (Pwn3d!) indicator",
        "Local admin rights documented for lateral movement planning"
      ],
      "dependencies": [
        "spray-ldap",
        "spray-smb",
        "spray-kerberos"
      ],
      "repeatable": true,
      "success_criteria": [
        "Credentials confirmed valid",
        "Admin rights status determined",
        "Target systems for lateral movement identified"
      ],
      "failure_conditions": [
        "STATUS_LOGON_FAILURE (credentials invalid or expired)",
        "Connection refused (SMB port blocked)",
        "No (Pwn3d!) systems found (standard user only)"
      ],
      "next_steps": [
        "lateral-movement-admin",
        "lateral-movement-standard-user"
      ]
    },
    {
      "id": "lateral-movement-admin",
      "name": "Lateral Movement via Local Admin Access",
      "objective": "Compromise systems where user has local admin rights to extract additional credentials",
      "description": "IF PWND SYSTEMS FOUND (from previous step): User has local admin = can execute code as SYSTEM.\n\nATTACK PLAN:\n(1) Use psexec/wmiexec/evil-winrm to get SYSTEM shell on (Pwn3d!) system.\n(2) Dump SAM database: crackmapexec smb TARGET -u username -p password -d domain.com --sam (extracts local user hashes).\n(3) Dump LSA secrets: crackmapexec smb TARGET -u username -p password -d domain.com --lsa (extracts cached domain credentials, service account passwords).\n(4) Dump LSASS memory with Mimikatz (extract Kerberos tickets, plaintext passwords).\n(5) Search for cached Domain Admin credentials or service accounts with high privileges.\n(6) Use extracted credentials for further lateral movement.\n\npentest STRATEGY: Local admin on ONE workstation can lead to domain compromise if Domain Admin credentials are cached or Kerberos tickets are available.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "SYSTEM shell obtained on target",
        "SAM/LSA secrets dumped",
        "Additional credentials extracted",
        "Kerberos tickets or cached creds found"
      ],
      "dependencies": [
        "validate-found-credentials"
      ],
      "repeatable": true,
      "success_criteria": [
        "Additional credentials extracted from compromised system",
        "Lateral movement path to additional systems established",
        "High-privilege credentials found (Domain Admin or service accounts)"
      ],
      "failure_conditions": [
        "AV/EDR blocks credential dumping",
        "No cached credentials on target system",
        "Defensive tools detect and block lateral movement"
      ],
      "next_steps": []
    },
    {
      "id": "lateral-movement-standard-user",
      "name": "Lateral Movement as Standard Domain User",
      "objective": "Leverage standard user credentials for AD enumeration and alternative pivoting",
      "description": "IF NO PWND SYSTEMS: User is standard domain user (no local admin anywhere).\n\nSTILL VALUABLE - standard domain users can:\n(1) Enumerate Active Directory (users, groups, computers, GPOs, ACLs).\n(2) Access file shares (look for passwords in files, scripts, GPP passwords in SYSVOL).\n(3) Kerberoast (request service tickets and crack offline).\n(4) AS-REP roast (attack users with pre-auth disabled).\n(5) Search for ACL abuse opportunities (GenericAll, WriteDACL, etc.).\n(6) Attempt local privilege escalation on accessible systems (unquoted service paths, weak permissions, AlwaysInstallElevated).\n(7) Authenticate to web applications, VPN, Citrix, or other services.\n\npentest STRATEGY: Standard user credentials are STARTING POINT for AD attacks, not dead end.\nProceed with AD enumeration and privilege escalation techniques.",
      "command_ref": "concept-enumeration",
      "evidence": [
        "AD enumeration performed with valid credentials",
        "File shares accessed and searched",
        "Kerberoastable accounts identified",
        "ACL abuse opportunities found"
      ],
      "dependencies": [
        "validate-found-credentials"
      ],
      "repeatable": true,
      "success_criteria": [
        "AD enumeration completed",
        "Additional attack vectors identified",
        "Privilege escalation opportunities discovered"
      ],
      "failure_conditions": [
        "No additional enumeration possible",
        "All privilege escalation attempts fail",
        "Credentials provide no useful access"
      ],
      "next_steps": []
    }
  ]
}