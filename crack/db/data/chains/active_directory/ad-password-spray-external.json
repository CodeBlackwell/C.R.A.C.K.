{
  "id": "ad-password-spray-external",
  "name": "Active Directory External Password Spray Attack",
  "description": "External password spraying attack chain from no credentials to valid domain access using Kerberos pre-authentication.\n\nEnumerates valid usernames, sprays common passwords, validates credentials, and identifies local admin access - all from external network position with only UDP 88 access to domain controller.",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - pentest Track",
    "created": "2025-11-10",
    "updated": "2025-11-10",
    "tags": [
      "ACTIVE_DIRECTORY",
      "PASSWORD_SPRAY",
      "KERBEROS",
      "EXTERNAL",
      "CREDENTIAL_ACCESS",
      "QUICK_WIN"
    ],
    "category": "credential-access",
    "platform": "active-directory",
    "references": [
      "https://github.com/ropnop/kerbrute",
      "https://attack.mitre.org/techniques/T1110/003/",
      "https://www.offensive-security.com/offsec/understanding-kerberos-double-hop/"
    ]
  },
  "difficulty": "intermediate",
  "time_estimate": "15 minutes",
  "prerequisites": [
    "Network access to domain controller UDP port 88 (Kerberos)",
    "Domain name identified (e.g., corp.com via DNS, SMB banner, or LDAP)",
    "Domain controller IP address (via DNS, port scan, or OSINT)",
    "Kerbrute tool available on attack box",
    "Username wordlist (SecLists recommended)"
  ],
  "notes": "CRITICAL: This is the PRIMARY method for external password spraying. Requires ONLY UDP 88 access to DC - no SMB, LDAP, or internal network needed. Generates minimal noise (Event ID 4768/4771 - normal Kerberos traffic). SPEED: Fastest password attack method - 2 UDP packets per attempt, hundreds of attempts per second. STEALTH: Extremely low detection risk - appears as normal authentication traffic. EXAM STRATEGY: Use this when you've identified AD but have no credentials. Success rate highest with common passwords (Welcome2023!, Password123!, CompanyName2023!). CRITICAL WARNING: Does NOT check password policy - you must manually calculate safe spray limits to avoid lockouts. Recommended: max 3-4 password attempts per user per 30 minutes.",
  "steps": [
    {
      "id": "verify-kerberos-access",
      "name": "Verify Kerberos Port Access",
      "objective": "Confirm UDP port 88 is accessible on domain controller for Kerberos authentication",
      "description": "Use nmap to verify Kerberos port 88/UDP is reachable.\nThis is REQUIRED for Kerbrute to function.\n\nIf port 88 is blocked, this attack chain cannot proceed (fall back to internal spray methods).",
      "command_ref": "nmap-udp-scan",
      "evidence": [
        "Nmap shows 88/udp open|open|filtered kerberos-sec",
        "Domain controller responds to UDP 88 traffic",
        "No firewall blocking Kerberos port"
      ],
      "dependencies": [],
      "repeatable": true,
      "success_criteria": [
        "Port 88/UDP is open or open|filtered",
        "Kerberos service identified",
        "No connection refused errors"
      ],
      "failure_conditions": [
        "Port 88/UDP is closed or filtered",
        "Firewall blocking all UDP traffic",
        "DC IP address incorrect (no response)"
      ],
      "next_steps": [
        "enumerate-valid-users"
      ]
    },
    {
      "id": "enumerate-valid-users",
      "name": "Enumerate Valid Domain Usernames",
      "objective": "Validate usernames against domain using Kerberos AS-REQ to build target list for spraying",
      "description": "Use kerbrute userenum with username wordlist.\nKerbrute sends AS-REQ (TGT request) for each username.\nDomain controller responds differently for valid users (PREAUTH_REQUIRED) vs invalid users (PRINCIPAL_UNKNOWN).\nThis identifies valid usernames without authentication.\n\nRecommended wordlist: /usr/share/seclists/Usernames/Names/names.txt (common first names) or /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt (comprehensive).\n\nSave valid usernames to file with -o flag for next step.",
      "command_ref": "kerbrute-userenum-ad",
      "evidence": [
        "List of valid usernames saved to valid_users.txt",
        "Kerbrute shows [+] VALID USERNAME: user@domain.com",
        "5-50 valid usernames identified from wordlist"
      ],
      "dependencies": [
        "verify-kerberos-access"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least 5 valid usernames identified",
        "Usernames saved to file for password spraying",
        "No network errors or timeouts"
      ],
      "failure_conditions": [
        "Couldn't find any KDCs (DC IP wrong or port blocked)",
        "context deadline exceeded (network timeout)",
        "Zero valid usernames found (wrong domain name or wordlist)"
      ],
      "next_steps": [
        "spray-common-password"
      ]
    },
    {
      "id": "spray-common-password",
      "name": "Spray Common Password Against Valid Users",
      "objective": "Test single common password against all valid usernames to find working credentials",
      "description": "Use kerbrute passwordspray with valid username list from previous step.\nTest ONE common password (e.g., SecureP@ss123!, Welcome2023!, Password123!, CompanyName2023!).\nKerbrute attempts Kerberos authentication for each user.\nSuccess = TGT issued (valid credentials).\nFailure = PREAUTH_FAILED (wrong password).\n\nONLY 2 UDP packets per attempt = extremely fast.\n\nCRITICAL: Only spray 3-4 passwords total to avoid lockout risk (most domains have 5 attempt threshold).\nExample: spray 'Password123!', wait 30min, spray 'Welcome2023!', wait 30min, spray 'Summer2023!'.\n\nSave results with -o flag.",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Valid credentials found and saved to file",
        "Kerbrute shows [+] VALID LOGIN: user@domain.com:Password123!",
        "At least one successful authentication"
      ],
      "dependencies": [
        "enumerate-valid-users"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least one valid credential pair identified",
        "Username and password documented",
        "No account lockouts triggered"
      ],
      "failure_conditions": [
        "Zero valid logins found (try different password)",
        "Couldn't find any KDCs (network issue)",
        "context deadline exceeded (timeout)"
      ],
      "next_steps": [
        "validate-credentials",
        "spray-additional-password"
      ]
    },
    {
      "id": "spray-additional-password",
      "name": "Spray Additional Password (Optional)",
      "objective": "Test second/third common password if first spray found zero credentials",
      "description": "If first password spray was unsuccessful, wait 30+ minutes for observation window to reset, then spray a different common password.\nLimit to 3-4 total passwords to stay under typical lockout threshold of 5 attempts.\n\nCommon pentest-relevant passwords: Password123!, Welcome2023!, CompanyName2023!, Summer2023!, Winter2023!, Spring2023!, Autumn2023!, Admin123!, Password1, Passw0rd!.\n\nTIMING: Wait at least 30 minutes between spray attempts (common observation window duration).\nUse timer to track when safe to spray again.",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Additional valid credentials found",
        "Multiple username:password pairs identified",
        "Spray timing logged (30min intervals)"
      ],
      "dependencies": [
        "spray-common-password"
      ],
      "repeatable": true,
      "success_criteria": [
        "Waited minimum 30 minutes since last spray",
        "Different password tested than previous attempts",
        "Valid credentials found or max attempts (4) reached"
      ],
      "failure_conditions": [
        "Account lockout triggered (sprayed too fast)",
        "No valid credentials after 4 password attempts",
        "Network connectivity lost"
      ],
      "next_steps": [
        "validate-credentials"
      ]
    },
    {
      "id": "validate-credentials",
      "name": "Quick-Validate Found Credentials",
      "objective": "Confirm credentials are valid and still active using fast Kerberos validation",
      "description": "Use kerbrute passwordspray with single-user file containing found username to re-validate credentials.\nThis ensures credentials weren't disabled since discovery and confirms password is correct.\nTakes <5 seconds.\n\nCreates file with found username (echo 'username' > single_user.txt) then runs kerbrute passwordspray to confirm.\n\nAlternative: skip to next step (admin validation) which also confirms credentials work.",
      "command_ref": "kerbrute-validate-creds",
      "evidence": [
        "Credentials re-validated successfully",
        "[+] VALID LOGIN confirmation",
        "Timestamp of validation logged"
      ],
      "dependencies": [
        "spray-common-password"
      ],
      "repeatable": true,
      "success_criteria": [
        "Credentials confirmed valid",
        "Authentication successful",
        "Account not disabled or locked"
      ],
      "failure_conditions": [
        "Credentials no longer valid (password changed)",
        "Account locked out (too many spray attempts)",
        "Account disabled by administrator"
      ],
      "next_steps": [
        "check-admin-rights"
      ]
    },
    {
      "id": "check-admin-rights",
      "name": "Check for Local Admin Rights on Network Systems",
      "objective": "Identify which systems the compromised user has local administrator privileges on",
      "description": "Use CrackMapExec to scan target subnet (or specific IPs) with found credentials.\nCME tests SMB authentication and checks if user can access ADMIN$ share (indicates local admin).\nPwn3d! indicator = local admin rights = can execute code as SYSTEM.\n\nScan single IP first to verify credentials work with SMB, then scan subnet /24 to find all systems where user is admin.\nExample: crackmapexec smb 10.10.10.0/24 -u username -p password -d domain.com.\nLook for (Pwn3d!) in output.\n\nIf user is admin on workstations, pivot there to dump credentials (SAM, LSA, LSASS) for lateral movement.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "List of systems showing (Pwn3d!) indicator",
        "Local admin rights identified on X systems",
        "SMB authentication successful"
      ],
      "dependencies": [
        "validate-credentials"
      ],
      "repeatable": true,
      "success_criteria": [
        "Credentials validated via SMB",
        "Local admin systems identified (if any)",
        "Subnet scan completed"
      ],
      "failure_conditions": [
        "SMB port 445 blocked (external firewall)",
        "STATUS_LOGON_FAILURE (credentials wrong for SMB)",
        "Connection refused (no SMB access from external position)"
      ],
      "next_steps": [
        "lateral-movement-prep",
        "dump-credentials-via-smb"
      ]
    },
    {
      "id": "lateral-movement-prep",
      "name": "Prepare for Lateral Movement and Privilege Escalation",
      "objective": "Plan next attack phase based on admin rights discovery results",
      "description": "DECISION TREE based on previous step results:\n\n(1) If user has Pwn3d! on any systems \u2192 proceed to dump-credentials-via-smb step to extract SAM/LSA/LSASS credentials.\n\n(2) If user has NO admin rights \u2192 attempt evil-winrm or RDP login as standard user, then perform local privilege escalation (check for vulnerable services, unquoted service paths, AlwaysInstallElevated, etc.).\n\n(3) If SMB access denied (external position) \u2192 use credentials for other services: WinRM (evil-winrm), RDP, VPN access, web application authentication, or pivot through VPN/Citrix to internal network then retry SMB.\n\npentest STRATEGY: Even standard domain user credentials are valuable - can enumerate AD, access file shares, pivot to other services.\nDon't stop if no local admin found.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "Attack plan documented based on discovered access level",
        "Next steps prioritized (admin access vs standard user pivoting)",
        "Alternative access methods identified"
      ],
      "dependencies": [
        "check-admin-rights"
      ],
      "repeatable": false,
      "success_criteria": [
        "Attack plan created based on results",
        "Next exploitation phase identified",
        "Credentials documented for future use"
      ],
      "failure_conditions": [
        "No additional access paths identified",
        "Credentials useless (no services accessible)",
        "All lateral movement attempts blocked"
      ],
      "next_steps": []
    }
  ]
}