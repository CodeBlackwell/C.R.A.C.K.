{
  "id": "ad-password-spray-safe",
  "name": "Safe Lockout-Aware Password Spraying",
  "description": "Ultra-safe password spraying attack chain with strict lockout avoidance. Discovers password policy, calculates safe spray limits, implements time-delayed spraying with observation window tracking, and maintains spray logs to prevent accidental lockouts. Critical for OSCP exam where account lockouts can fail objectives.",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - OSCP Track",
    "created": "2025-11-10",
    "updated": "2025-11-10",
    "tags": [
      "OSCP:HIGH",
      "ACTIVE_DIRECTORY",
      "PASSWORD_SPRAY",
      "SAFE",
      "LOCKOUT_AVOIDANCE",
      "CREDENTIAL_ACCESS",
      "EXAM_CRITICAL"
    ],
    "category": "credential-access",
    "platform": "active-directory",
    "references": [
      "https://attack.mitre.org/techniques/T1110/003/",
      "https://www.microsoft.com/en-us/security/blog/2020/04/23/protecting-organization-password-spray-attacks/",
      "https://github.com/ropnop/kerbrute"
    ]
  },
  "difficulty": "intermediate",
  "time_estimate": "60-90 minutes (includes observation window wait times)",
  "oscp_relevant": true,
  "prerequisites": [
    "Network access to domain controller (Kerberos, SMB, or LDAP)",
    "Username list (from enumeration or wordlist)",
    "Access to password policy (via net accounts, enum4linux, or crackmapexec)",
    "Timer or clock for tracking observation windows",
    "Spray log to track attempts per user (spreadsheet or text file)"
  ],
  "notes": "OSCP EXAM CRITICAL: This chain is designed for ZERO LOCKOUT RISK. Use when: (1) OSCP exam environment (lockouts = failed objective). (2) Red team engagement with strict ROE (no disruption). (3) High-value target where stealth is paramount. (4) Strict password policy (3 attempt threshold or below). KEY DIFFERENCES from normal spray: (1) Conservative attempt limit (threshold - 2 instead of threshold - 1). (2) Extended wait time (observation window + 5 minutes buffer). (3) Spray logging to track attempts per user. (4) Single-password rounds (not batch). (5) Validation after each round. TRADE-OFF: SLOWER (requires wait periods) but ZERO RISK. TIME COMMITMENT: With 30min observation window and 5 passwords, total time = 5 passwords × 30min wait = 2.5 hours minimum. Plan accordingly for exam time management.",
  "steps": [
    {
      "id": "discover-policy-detailed",
      "name": "Discover and Document Password Policy in Detail",
      "objective": "Retrieve complete password policy and document all lockout-related settings for calculation",
      "description": "Use appropriate method based on position: net-accounts-policy (Windows), crackmapexec-policy (Linux+creds), enum4linux-policy (Linux+null session), or ldapsearch-policy (LDAP). DOCUMENT THESE VALUES: (1) Lockout threshold (e.g., 5). (2) Lockout observation window (e.g., 30 minutes). (3) Lockout duration (e.g., 30 minutes). (4) Minimum password length (helps craft password list). (5) Password complexity (helps understand requirements). CREATE SPRAY LOG: Set up tracking spreadsheet or file with columns: Username, Password1_Time, Password2_Time, Password3_Time, Total_Attempts, Status. This log prevents accidental re-spraying of users who've already received max attempts.",
      "command_ref": "crackmapexec-policy",
      "evidence": [
        "Lockout threshold documented",
        "Observation window documented",
        "Lockout duration documented",
        "Spray log created with tracking columns",
        "Policy details saved to file for reference"
      ],
      "dependencies": [],
      "repeatable": false,
      "success_criteria": [
        "All policy values retrieved and documented",
        "Spray log template created",
        "Safe spray limits calculated"
      ],
      "failure_conditions": [
        "Cannot retrieve password policy (no access method works)",
        "Incomplete policy information (missing observation window)",
        "Access denied to all enumeration methods"
      ],
      "next_steps": [
        "calculate-safe-limits"
      ]
    },
    {
      "id": "calculate-safe-limits",
      "name": "Calculate Conservative Safe Spray Limits",
      "objective": "Determine maximum safe attempts per user with safety margin to prevent lockouts",
      "description": "CONSERVATIVE CALCULATION (Ultra-Safe): Safe attempts = Lockout threshold - 2. Example: threshold 5 → spray 3 passwords max (not 4). This provides TWO layers of safety: (1) -1 for user's own failed login attempts. (2) -1 for timing uncertainty and network delays. OBSERVATION WINDOW BUFFER: Add 5 minutes to observation window for safety. Example: 30min window → wait 35min between spray rounds. Why? Clock skew between attacker and DC, network delays, ensure counter fully resets. TOTAL PASSWORD LIMIT: Calculate how many passwords you can safely test in available time. Formula: max_passwords = (available_time_minutes - spray_time) / (observation_window + buffer). Example: 3 hour exam window, 30min observation window → max 5 passwords total (5 × 35min = 175min = 2h55m). DOCUMENT: Write these values in spray log header for reference.",
      "command_ref": null,
      "evidence": [
        "Safe attempt limit calculated (threshold - 2)",
        "Buffered wait time calculated (observation window + 5 min)",
        "Maximum password count determined based on time budget",
        "Calculations documented in spray log"
      ],
      "dependencies": [
        "discover-policy-detailed"
      ],
      "repeatable": false,
      "success_criteria": [
        "Conservative safe limits calculated",
        "Time budget planned",
        "Buffer times added for safety"
      ],
      "failure_conditions": [
        "None - this is a calculation step"
      ],
      "next_steps": [
        "prepare-username-list"
      ]
    },
    {
      "id": "prepare-username-list",
      "name": "Enumerate and Prepare Username List",
      "objective": "Build validated username list and pre-populate spray log",
      "description": "Enumerate valid usernames using kerbrute-userenum-ad (fastest, most reliable). Save results to users.txt. SPRAY LOG SETUP: Add each validated username to spray log with empty timestamp columns. This creates accountability for each spray round. OPTIONAL FILTERING: Consider filtering list: (1) Exclude administrator and krbtgt (high-value, closely monitored). (2) Exclude service accounts if identifiable (often have complex passwords). (3) Focus on standard user accounts. (4) Prioritize accounts with description fields suggesting human users (not computers/services). REASONING: Fewer targets = faster spray rounds = more passwords testable in time budget. For exam: 20-50 users is manageable, 200+ users takes too long with safe timing.",
      "command_ref": "kerbrute-userenum-ad",
      "evidence": [
        "Valid username list created (users.txt)",
        "Usernames added to spray log",
        "Optional filtering applied and documented",
        "Username count appropriate for time budget"
      ],
      "dependencies": [
        "calculate-safe-limits"
      ],
      "repeatable": true,
      "success_criteria": [
        "At least 10 valid usernames identified",
        "Spray log pre-populated with usernames",
        "Username list saved and backed up"
      ],
      "failure_conditions": [
        "Zero valid usernames found (wrong domain or method)",
        "Enumeration triggers alerts (switch to stealthier method)",
        "Too many usernames for time budget (need to filter)"
      ],
      "next_steps": [
        "spray-round-1"
      ]
    },
    {
      "id": "spray-round-1",
      "name": "Spray Round 1 - First Password Attempt",
      "objective": "Test first common password against all users with full logging",
      "description": "SELECT PASSWORD: Choose most common default password. Examples: Password123!, Welcome2023!, CompanyName2023! (replace CompanyName with actual org name from OSINT). EXECUTE SPRAY: Use kerbrute passwordspray (fastest, stealthiest). COMMAND: kerbrute passwordspray -d domain.com --dc DC_IP users.txt 'Password123!'. LOG RESULTS: Immediately update spray log: (1) Add timestamp in Password1_Time column for all users. (2) Mark successful authentications with username:password in Status column. (3) Increment Total_Attempts counter for each user. (4) Note any errors or anomalies. SET TIMER: Start countdown timer for (observation_window + buffer) minutes. Example: 30min window + 5min buffer = 35 minute timer. DO NOT spray again until timer expires.",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Spray completed for all users",
        "Results logged with timestamps",
        "Valid credentials found (if any)",
        "Timer set for next round",
        "No account lockouts detected"
      ],
      "dependencies": [
        "prepare-username-list"
      ],
      "repeatable": false,
      "success_criteria": [
        "Spray completed successfully",
        "All users attempted with Password #1",
        "Results documented in spray log",
        "Timer set for observation window + buffer"
      ],
      "failure_conditions": [
        "Account lockout detected (CRITICAL - abort spray chain)",
        "Network errors preventing completion",
        "Tool failure mid-spray (restart with logging)"
      ],
      "next_steps": [
        "wait-observation-window-1",
        "validate-round-1-creds"
      ]
    },
    {
      "id": "validate-round-1-creds",
      "name": "Validate Round 1 Found Credentials (If Any)",
      "objective": "Immediately validate and leverage any credentials found in Round 1",
      "description": "IF VALID CREDENTIALS FOUND in Round 1: Don't wait for next round - immediately leverage them. VALIDATION: Use kerbrute-validate-creds or crackmapexec-validate-admin to confirm credentials work. DECISION POINT: (1) If credentials give local admin access (Pwn3d!) → proceed to lateral movement, objective achieved, spray chain can stop. (2) If credentials are standard user → use for AD enumeration (may find more attack vectors), then continue spray chain for additional credentials. (3) If no credentials found in Round 1 → proceed to wait-observation-window-1 step. TIME MANAGEMENT: If exam, evaluate: is local admin access sufficient for objective? Or need more credentials? Don't waste time spraying if objective is met.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "Found credentials validated",
        "Admin rights status determined",
        "Decision made (continue spray or pivot to exploitation)"
      ],
      "dependencies": [
        "spray-round-1"
      ],
      "repeatable": false,
      "success_criteria": [
        "Credentials validated if found",
        "Attack decision made based on access level",
        "Spray log updated with validation results"
      ],
      "failure_conditions": [
        "Credentials invalid (expired or wrong)",
        "Validation triggers lockout (unlikely but check)"
      ],
      "next_steps": [
        "wait-observation-window-1",
        "lateral-movement-from-spray"
      ]
    },
    {
      "id": "wait-observation-window-1",
      "name": "Wait for Observation Window to Reset (Round 1 → 2)",
      "objective": "Wait full observation window + buffer to ensure failed attempt counter resets",
      "description": "WAIT TIME: Observation window (from policy) + 5 minute buffer. Example: 30min + 5min = 35 minutes total. CRITICAL: Wait time is measured from LAST spray attempt completion (end of spray-round-1 step). Use timer app or alarm. DO NOT spray early - even 1 minute early could result in lockout if clocks are not synchronized. PRODUCTIVE USE OF WAIT TIME: (1) Validate credentials from Round 1 if found. (2) Enumerate AD with found credentials. (3) Perform non-password attacks (Kerberoasting, AS-REP roasting). (4) Search file shares for passwords. (5) Plan next password choices. (6) Review spray log for accuracy. WHEN TIMER EXPIRES: Proceed to spray-round-2. Update spray log to note observation window completion.",
      "command_ref": null,
      "evidence": [
        "Full wait time completed (observation window + buffer)",
        "Timer confirmation documented",
        "Wait time used productively (other enumeration)",
        "Spray log notes observation window reset"
      ],
      "dependencies": [
        "spray-round-1"
      ],
      "repeatable": false,
      "success_criteria": [
        "Minimum wait time (observation window + buffer) elapsed",
        "No premature spray attempts",
        "Spray log confirms ready for Round 2"
      ],
      "failure_conditions": [
        "None - this is a wait step"
      ],
      "next_steps": [
        "spray-round-2"
      ]
    },
    {
      "id": "spray-round-2",
      "name": "Spray Round 2 - Second Password Attempt",
      "objective": "Test second common password after observation window reset",
      "description": "VERIFY WAIT COMPLETE: Confirm timer expired and observation window + buffer elapsed. SELECT PASSWORD #2: Choose different password from Round 1. Examples: Welcome2023!, Summer2023!, Winter2023!, Company123! (vary by season, year, company name). EXECUTE SPRAY: Same method as Round 1 - kerbrute passwordspray -d domain.com --dc DC_IP users.txt 'Welcome2023!'. LOG RESULTS: Update spray log Password2_Time column with timestamps. Update Total_Attempts counter (should show 2 for all users now). Document any successful authentications. SET TIMER AGAIN: Start (observation window + buffer) timer for Round 2 → 3 transition. ALERT CHECK: Monitor for any lockout alerts or defensive responses. If any user locked out - ABORT spray chain immediately.",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Round 2 spray completed",
        "Different password than Round 1 tested",
        "Spray log updated with Round 2 timestamps",
        "Total_Attempts = 2 for all users",
        "No lockouts detected"
      ],
      "dependencies": [
        "wait-observation-window-1"
      ],
      "repeatable": false,
      "success_criteria": [
        "Spray completed successfully",
        "All users attempted with Password #2",
        "Spray log accurate",
        "No account lockouts"
      ],
      "failure_conditions": [
        "Account lockout detected (ABORT)",
        "Network errors",
        "Defensive response detected (IDS alerts, admin activity)"
      ],
      "next_steps": [
        "wait-observation-window-2",
        "validate-round-2-creds"
      ]
    },
    {
      "id": "validate-round-2-creds",
      "name": "Validate Round 2 Found Credentials",
      "objective": "Validate credentials from Round 2 and evaluate if additional rounds needed",
      "description": "IF CREDENTIALS FOUND in Round 2: Validate immediately with crackmapexec-validate-admin. Check for local admin rights. CUMULATIVE EVALUATION: Review credentials from Round 1 + Round 2. Questions: (1) Do you have local admin anywhere? (2) Do you have enough access for objectives? (3) Is additional spraying worth the time investment? DECISION MATRIX: [Local admin found] → Stop spray chain, proceed to lateral movement. [Multiple standard user accounts found] → Evaluate if enough for AD enumeration and Kerberoasting. [Zero credentials found] → Continue spray chain to Round 3. TIME BUDGET CHECK: Calculate remaining time and how many more rounds possible. Example: 60min left, 35min per round = 1 more round maximum.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "Round 2 credentials validated",
        "Cumulative access evaluated (Round 1 + 2)",
        "Decision made on continuing spray chain",
        "Time budget checked"
      ],
      "dependencies": [
        "spray-round-2"
      ],
      "repeatable": false,
      "success_criteria": [
        "Credentials validated if found",
        "Strategic decision made (continue or pivot)",
        "Time budget assessed"
      ],
      "failure_conditions": [
        "Credentials invalid",
        "Insufficient time for additional rounds"
      ],
      "next_steps": [
        "wait-observation-window-2",
        "spray-round-3",
        "lateral-movement-from-spray"
      ]
    },
    {
      "id": "wait-observation-window-2",
      "name": "Wait for Observation Window to Reset (Round 2 → 3)",
      "objective": "Wait full observation window + buffer before Round 3",
      "description": "SAME PROCESS as wait-observation-window-1. Wait (observation window + buffer) minutes. CRITICAL ASSESSMENT: At this point you've invested 70+ minutes (2 spray rounds + 2 wait periods). Evaluate: (1) Is objective achievable with current access? (2) Is additional spraying worth remaining time? (3) Should pivot to other attack methods? ALTERNATIVE ATTACKS: Use wait time for: Kerberoasting (crack service account tickets offline), AS-REP roasting, ACL abuse hunting, GPP password searches, SMB share enumeration. SPRAY LOG REVIEW: Verify Total_Attempts column shows 2 for all users. Ensure no users accidentally sprayed 3 times (would risk lockout in Round 3).",
      "command_ref": null,
      "evidence": [
        "Full wait time completed",
        "Strategic assessment documented",
        "Spray log verified (all users at 2 attempts)",
        "Alternative attacks attempted during wait"
      ],
      "dependencies": [
        "spray-round-2"
      ],
      "repeatable": false,
      "success_criteria": [
        "Minimum wait time elapsed",
        "Spray log accuracy verified",
        "Strategic plan for Round 3 or alternative"
      ],
      "failure_conditions": [
        "None - this is a wait step"
      ],
      "next_steps": [
        "spray-round-3"
      ]
    },
    {
      "id": "spray-round-3",
      "name": "Spray Round 3 - Third Password Attempt (Final Safe Round)",
      "objective": "Test third password - final round before reaching conservative safe limit",
      "description": "FINAL ROUND: With threshold-2 calculation, Round 3 is the LAST safe spray for threshold 5 (3 attempts). Do not proceed to Round 4 without re-evaluating risk. SELECT PASSWORD #3: Choose third distinct password. Examples: Spring2023!, Autumn2023!, Password1, Passw0rd!. EXECUTE SPRAY: kerbrute passwordspray with Password #3. LOG METICULOUSLY: Update spray log Password3_Time column. Total_Attempts should now be 3 for all users. This is AT the conservative safe limit. FINAL VALIDATION: Immediately validate any credentials found. Evaluate total credential haul: Round 1 + 2 + 3 results. DECISION POINT: Stop here (recommended) or risk Round 4 with reduced safety margin (threshold-1 instead of threshold-2).",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Round 3 completed successfully",
        "Spray log shows Total_Attempts = 3 for all users",
        "Conservative safe limit reached",
        "All credentials validated",
        "Final assessment documented"
      ],
      "dependencies": [
        "wait-observation-window-2"
      ],
      "repeatable": false,
      "success_criteria": [
        "Spray completed without lockouts",
        "Final credentials validated",
        "Strategic decision made (stop or continue with higher risk)"
      ],
      "failure_conditions": [
        "Account lockout (CRITICAL FAILURE)",
        "Defensive response detected",
        "Time budget exhausted"
      ],
      "next_steps": [
        "final-validation-and-exploitation",
        "optional-spray-round-4"
      ]
    },
    {
      "id": "final-validation-and-exploitation",
      "name": "Final Credential Validation and Exploitation",
      "objective": "Consolidate all found credentials and execute optimal exploitation path",
      "description": "CONSOLIDATE RESULTS: Review spray log for all successful authentications from Rounds 1-3. VALIDATE ALL: Use crackmapexec-validate-admin to scan subnet with each credential pair. Create matrix: Username × Systems → show which users have admin on which systems. PRIORITIZE: (1) Credentials with most (Pwn3d!) systems = best pivot. (2) Credentials with server access (higher privilege data). (3) Credentials with no admin = use for AD enumeration. EXPLOITATION: Execute lateral movement to (Pwn3d!) systems, dump SAM/LSA/LSASS, extract additional credentials, search for Domain Admin cached creds or Kerberos tickets. OSCP SUCCESS: Local admin on any system is usually sufficient for initial foothold objective. Proceed to privilege escalation and post-exploitation.",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "All credentials validated across network",
        "Admin access matrix created",
        "Exploitation priorities identified",
        "Lateral movement executed",
        "Objectives achieved or progress documented"
      ],
      "dependencies": [
        "spray-round-3"
      ],
      "repeatable": false,
      "success_criteria": [
        "All credentials validated",
        "Optimal exploitation path executed",
        "Objectives met or maximum progress achieved"
      ],
      "failure_conditions": [
        "All credentials invalid or non-admin",
        "Lateral movement blocked",
        "Insufficient access for objectives"
      ],
      "next_steps": []
    },
    {
      "id": "optional-spray-round-4",
      "name": "Optional Round 4 - Higher Risk (Threshold-1)",
      "objective": "Test fourth password with reduced safety margin if absolutely necessary",
      "description": "HIGH RISK - ONLY IF NECESSARY: Round 4 uses threshold-1 safety margin instead of threshold-2. Example: threshold 5 → 4 attempts (only 1 attempt buffer instead of 2). RISK ASSESSMENT: (1) Users might have failed login themselves = lockout. (2) Clock skew could cause timing issues = lockout. (3) Reduced margin for error. WHEN TO ATTEMPT: (1) Exam time running out and need credentials desperately. (2) High confidence that users haven't failed logins (monitoring). (3) Absolutely critical to test one more password. PROCESS: Same as previous rounds but with heightened monitoring. Watch for ANY lockout indicators. If single lockout detected - ABORT immediately. PASSWORD SELECTION: Choose highest probability password for final attempt. RECOMMENDATION: Generally NOT worth the risk. Stop at Round 3 unless absolutely critical.",
      "command_ref": "kerbrute-passwordspray",
      "evidence": [
        "Risk assessment documented",
        "Round 4 executed (if decision was to proceed)",
        "Lockout monitoring active",
        "Results logged"
      ],
      "dependencies": [
        "spray-round-3"
      ],
      "repeatable": false,
      "success_criteria": [
        "Round 4 completed without lockouts (if executed)",
        "Risk justified by criticality",
        "Spray log updated"
      ],
      "failure_conditions": [
        "Account lockout (CRITICAL - expected higher risk)",
        "Time budget insufficient for wait period",
        "Risk not justified"
      ],
      "next_steps": [
        "final-validation-and-exploitation"
      ]
    }
  ]
}
