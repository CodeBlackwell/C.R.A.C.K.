"""
Tests for macOS MDM exploitation plugin

Validates:
- MDM service detection (HTTPS, APNs ports)
- DEP reconnaissance tasks
- Serial number exploitation workflow
- Unauthorized enrollment testing
- Configuration profile analysis
- SCEP certificate enrollment
- MDM command interception
- Persistence mechanisms
- Organizational reconnaissance
- Comprehensive OSCP metadata
"""

import pytest
from crack.track.services.macos_mdm_exploitation import MacOSMDMExploitationPlugin


class TestMacOSMDMExploitationPlugin:
    """Test suite for macOS MDM exploitation plugin"""

    @pytest.fixture
    def plugin(self):
        """Create plugin instance"""
        return MacOSMDMExploitationPlugin()

    def test_plugin_properties(self, plugin):
        """PROVES: Plugin has correct basic properties"""
        assert plugin.name == "macos-mdm"
        assert 443 in plugin.default_ports
        assert 2195 in plugin.default_ports  # APNs provider API
        assert 2196 in plugin.default_ports  # APNs feedback
        assert 5223 in plugin.default_ports  # APNs device connection
        assert 'mdm' in plugin.service_names
        assert 'device-enrollment' in plugin.service_names

    def test_detect_mdm_service(self, plugin):
        """PROVES: Detects MDM services by service name"""
        port_info = {
            'port': 443,
            'service': 'mdm',
            'state': 'open'
        }
        assert plugin.detect(port_info) is True

    def test_detect_apple_mdm(self, plugin):
        """PROVES: Detects Apple MDM indicators"""
        port_info = {
            'port': 443,
            'service': 'https',
            'version': 'Apple MDM Server',
            'state': 'open'
        }
        assert plugin.detect(port_info) is True

    def test_detect_dep_service(self, plugin):
        """PROVES: Detects DEP-related services"""
        port_info = {
            'port': 443,
            'service': 'device-enrollment',
            'state': 'open'
        }
        assert plugin.detect(port_info) is True

    def test_detect_apns_ports(self, plugin):
        """PROVES: Detects Apple Push Notification Service ports"""
        # APNs provider API
        assert plugin.detect({'port': 2195, 'service': 'unknown'}) is True

        # APNs feedback service
        assert plugin.detect({'port': 2196, 'service': 'unknown'}) is True

        # APNs device connection
        assert plugin.detect({'port': 5223, 'service': 'unknown'}) is True

    def test_no_false_positives_generic_https(self, plugin):
        """PROVES: Does not trigger on generic HTTPS without MDM indicators"""
        port_info = {
            'port': 443,
            'service': 'https',
            'version': 'Apache/2.4.41',
            'state': 'open'
        }
        assert plugin.detect(port_info) is False

    def test_task_tree_structure(self, plugin):
        """PROVES: Generates comprehensive MDM exploitation task tree"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Root task
        assert tasks['id'] == 'macos-mdm-443'
        assert tasks['type'] == 'parent'
        assert 'children' in tasks
        assert len(tasks['children']) > 0

    def test_reconnaissance_phase(self, plugin):
        """PROVES: Includes MDM reconnaissance tasks"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find recon phase
        recon_phase = None
        for child in tasks['children']:
            if 'recon' in child['id']:
                recon_phase = child
                break

        assert recon_phase is not None
        assert recon_phase['type'] == 'parent'
        assert len(recon_phase['children']) > 0

        # Check for server fingerprinting
        task_ids = [t['id'] for t in recon_phase['children']]
        assert any('server-id' in tid for tid in task_ids)

    def test_mdm_server_fingerprinting(self, plugin):
        """PROVES: Includes MDM server identification task"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find fingerprinting task
        fingerprint_task = None
        for phase in tasks['children']:
            if 'recon' in phase['id']:
                for task in phase['children']:
                    if 'server-id' in task['id']:
                        fingerprint_task = task
                        break

        assert fingerprint_task is not None
        assert 'metadata' in fingerprint_task
        metadata = fingerprint_task['metadata']

        # Verify task details
        assert 'curl' in metadata['command']
        assert '192.168.45.100' in metadata['command']
        assert 'OSCP:HIGH' in metadata['tags']
        assert 'QUICK_WIN' in metadata['tags']
        assert 'flag_explanations' in metadata
        assert 'success_indicators' in metadata
        assert len(metadata['success_indicators']) > 0

    def test_dep_profile_discovery(self, plugin):
        """PROVES: Includes DEP profile endpoint discovery"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find DEP profile discovery
        dep_task = None
        for phase in tasks['children']:
            if 'recon' in phase['id']:
                for task in phase['children']:
                    if 'dep-profile' in task['id']:
                        dep_task = task
                        break

        assert dep_task is not None
        metadata = dep_task['metadata']
        assert '/profile' in metadata['command']
        assert 'flag_explanations' in metadata
        assert 'next_steps' in metadata
        assert len(metadata['next_steps']) > 0

    def test_certificate_analysis(self, plugin):
        """PROVES: Includes SSL certificate analysis for intelligence"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find certificate analysis task
        cert_task = None
        for phase in tasks['children']:
            if 'recon' in phase['id']:
                for task in phase['children']:
                    if 'cert-analysis' in task['id']:
                        cert_task = task
                        break

        assert cert_task is not None
        metadata = cert_task['metadata']
        assert 'openssl' in metadata['command']
        assert 's_client' in metadata['command']
        assert 'flag_explanations' in metadata
        assert 'alternatives' in metadata

    def test_serial_number_exploitation_phase(self, plugin):
        """PROVES: Includes serial number exploitation tasks"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find serial exploit phase
        serial_phase = None
        for child in tasks['children']:
            if 'serial-exploit' in child['id']:
                serial_phase = child
                break

        assert serial_phase is not None
        assert serial_phase['type'] == 'parent'
        assert len(serial_phase['children']) >= 3

    def test_serial_number_format_analysis(self, plugin):
        """PROVES: Includes serial number format education"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find serial format task
        format_task = None
        for phase in tasks['children']:
            if 'serial-exploit' in phase['id']:
                for task in phase['children']:
                    if 'serial-number-format' in task['id']:
                        format_task = task
                        break

        assert format_task is not None
        assert format_task['type'] == 'manual'
        metadata = format_task['metadata']
        assert 'notes' in metadata
        assert 'C02L13ECF8J2' in metadata['notes']  # Example serial
        assert 'manufacturing location' in metadata['notes'].lower()
        assert 'year of manufacture' in metadata['notes'].lower()

    def test_dep_activation_record_retrieval(self, plugin):
        """PROVES: Includes DEP activation record exploitation"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find DEP activation task
        activation_task = None
        for phase in tasks['children']:
            if 'serial-exploit' in phase['id']:
                for task in phase['children']:
                    if 'dep-activation-record' in task['id']:
                        activation_task = task
                        break

        assert activation_task is not None
        assert activation_task['type'] == 'manual'
        metadata = activation_task['metadata']

        # Verify comprehensive notes
        assert 'notes' in metadata
        assert 'LLDB' in metadata['notes']
        assert 'cloudconfigurationd' in metadata['notes']
        assert 'iprofiles.apple.com' in metadata['notes']
        assert 'success_indicators' in metadata
        assert 'failure_indicators' in metadata
        assert 'alternatives' in metadata

    def test_tesla_protocol_analysis(self, plugin):
        """PROVES: Includes Tesla/Absinthe protocol analysis"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find Tesla protocol task
        tesla_task = None
        for phase in tasks['children']:
            if 'serial-exploit' in phase['id']:
                for task in phase['children']:
                    if 'tesla-absinthe' in task['id']:
                        tesla_task = task
                        break

        assert tesla_task is not None
        metadata = tesla_task['metadata']
        assert 'Absinthe' in metadata['notes']
        assert 'NACInit' in metadata['notes']
        assert 'encryption' in metadata['notes'].lower()

    def test_unauthorized_enrollment_phase(self, plugin):
        """PROVES: Includes unauthorized enrollment attack tasks"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find enrollment phase
        enrollment_phase = None
        for child in tasks['children']:
            if 'enrollment-attack' in child['id']:
                enrollment_phase = child
                break

        assert enrollment_phase is not None
        assert enrollment_phase['type'] == 'parent'
        assert len(enrollment_phase['children']) >= 3

    def test_mdm_enrollment_testing(self, plugin):
        """PROVES: Includes MDM enrollment authentication testing"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find enrollment test
        enrollment_test = None
        for phase in tasks['children']:
            if 'enrollment-attack' in phase['id']:
                for task in phase['children']:
                    if 'mdm-enrollment-test' in task['id']:
                        enrollment_test = task
                        break

        assert enrollment_test is not None
        metadata = enrollment_test['metadata']
        assert 'curl' in metadata['command']
        assert 'POST' in metadata['command']
        assert 'OSCP:HIGH' in metadata['tags']
        assert 'EXPLOIT' in metadata['tags']

        # Check for critical security warning
        indicators = metadata['success_indicators']
        assert any('CRITICAL' in indicator for indicator in indicators)

    def test_mobileconfig_analysis(self, plugin):
        """PROVES: Includes configuration profile analysis"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find mobileconfig analysis
        config_task = None
        for phase in tasks['children']:
            if 'enrollment-attack' in phase['id']:
                for task in phase['children']:
                    if 'mobileconfig-analysis' in task['id']:
                        config_task = task
                        break

        assert config_task is not None
        assert config_task['type'] == 'manual'
        metadata = config_task['metadata']

        # Verify comprehensive analysis notes
        assert 'notes' in metadata
        assert 'com.apple.mdm' in metadata['notes']
        assert 'com.apple.security.scep' in metadata['notes']
        assert 'WiFi' in metadata['notes']
        assert 'VPN' in metadata['notes']
        assert 'plutil' in metadata['notes']

    def test_scep_enrollment(self, plugin):
        """PROVES: Includes SCEP certificate enrollment testing"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find SCEP task
        scep_task = None
        for phase in tasks['children']:
            if 'enrollment-attack' in phase['id']:
                for task in phase['children']:
                    if 'scep-enrollment' in task['id']:
                        scep_task = task
                        break

        assert scep_task is not None
        metadata = scep_task['metadata']
        assert '/scep' in metadata['command']
        assert 'GetCACert' in metadata['command']
        assert 'openssl' in metadata['command']
        assert 'OSCP:HIGH' in metadata['tags']

    def test_mdm_command_interception_phase(self, plugin):
        """PROVES: Includes MDM command interception tasks"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find interception phase
        interception_phase = None
        for child in tasks['children']:
            if 'interception' in child['id']:
                interception_phase = child
                break

        assert interception_phase is not None
        assert interception_phase['type'] == 'parent'

    def test_apns_analysis(self, plugin):
        """PROVES: Includes APNs push notification analysis"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find APNs analysis
        apns_task = None
        for phase in tasks['children']:
            if 'interception' in phase['id']:
                for task in phase['children']:
                    if 'apns-analysis' in task['id']:
                        apns_task = task
                        break

        assert apns_task is not None
        metadata = apns_task['metadata']
        assert 'notes' in metadata
        assert '2195' in metadata['notes']  # APNs port
        assert 'tcpdump' in metadata['notes'].lower()

    def test_mdm_command_structure_analysis(self, plugin):
        """PROVES: Includes MDM protocol command analysis"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find command structure analysis
        cmd_task = None
        for phase in tasks['children']:
            if 'interception' in phase['id']:
                for task in phase['children']:
                    if 'command-structure' in task['id']:
                        cmd_task = task
                        break

        assert cmd_task is not None
        metadata = cmd_task['metadata']
        assert 'plist' in metadata['notes'].lower()
        assert 'DeviceInformation' in metadata['notes']
        assert 'EraseDevice' in metadata['notes']

    def test_persistence_phase(self, plugin):
        """PROVES: Includes MDM persistence mechanisms"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find persistence phase
        persistence_phase = None
        for child in tasks['children']:
            if 'persistence' in child['id']:
                persistence_phase = child
                break

        assert persistence_phase is not None
        assert persistence_phase['type'] == 'parent'

    def test_mdm_profile_persistence(self, plugin):
        """PROVES: Includes malicious MDM profile installation for persistence"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find persistence task
        persist_task = None
        for phase in tasks['children']:
            if 'persistence' in phase['id']:
                for task in phase['children']:
                    if 'profile-persist' in task['id']:
                        persist_task = task
                        break

        assert persist_task is not None
        assert persist_task['type'] == 'manual'
        metadata = persist_task['metadata']
        assert 'PERSISTENCE' in metadata['tags']
        assert 'POST-EXPLOIT' in metadata['tags']
        assert 'notes' in metadata
        assert 'com.apple.mdm' in metadata['notes']
        assert 'PayloadRemovalDisallowed' in metadata['notes']

    def test_configuration_harvesting(self, plugin):
        """PROVES: Includes credential harvesting from MDM profiles"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find harvesting task
        harvest_task = None
        for phase in tasks['children']:
            if 'persistence' in phase['id']:
                for task in phase['children']:
                    if 'config-harvest' in task['id']:
                        harvest_task = task
                        break

        assert harvest_task is not None
        metadata = harvest_task['metadata']
        assert 'profiles show' in metadata['command']
        assert 'CREDS' in metadata['tags']
        assert 'POST-EXPLOIT' in metadata['tags']
        assert 'WiFi passwords' in ' '.join(metadata['success_indicators'])

    def test_organizational_reconnaissance_phase(self, plugin):
        """PROVES: Includes organizational intelligence gathering"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find org recon phase
        org_recon = None
        for child in tasks['children']:
            if 'org-recon' in child['id']:
                org_recon = child
                break

        assert org_recon is not None
        assert org_recon['type'] == 'parent'

    def test_serial_enumeration(self, plugin):
        """PROVES: Includes systematic serial number enumeration"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find serial enumeration
        enum_task = None
        for phase in tasks['children']:
            if 'org-recon' in phase['id']:
                for task in phase['children']:
                    if 'serial-enumeration' in task['id']:
                        enum_task = task
                        break

        assert enum_task is not None
        metadata = enum_task['metadata']
        assert 'OSINT' in metadata['tags']
        assert 'LinkedIn' in metadata['notes']
        assert 'brute-force' in metadata['notes'].lower()

    def test_mdm_vendor_identification(self, plugin):
        """PROVES: Includes MDM vendor identification for exploit research"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find vendor ID task
        vendor_task = None
        for phase in tasks['children']:
            if 'org-recon' in phase['id']:
                for task in phase['children']:
                    if 'vendor-id' in task['id']:
                        vendor_task = task
                        break

        assert vendor_task is not None
        metadata = vendor_task['metadata']
        assert 'Jamf' in metadata['notes']
        assert 'Intune' in metadata['notes']
        assert 'Workspace ONE' in metadata['notes']

    def test_exploit_research_with_version(self, plugin):
        """PROVES: Generates exploit research tasks when version detected"""
        tasks = plugin.get_task_tree(
            '192.168.45.100',
            443,
            {'service': 'mdm', 'version': 'Jamf Pro 10.25.0'}
        )

        # Find exploit research phase
        exploit_phase = None
        for child in tasks['children']:
            if 'exploit-research' in child['id']:
                exploit_phase = child
                break

        assert exploit_phase is not None
        assert exploit_phase['type'] == 'parent'

        # Should have searchsploit and GitHub search
        task_ids = [t['id'] for t in exploit_phase['children']]
        assert any('searchsploit' in tid for tid in task_ids)
        assert any('github' in tid for tid in task_ids)

    def test_remediation_guidance(self, plugin):
        """PROVES: Includes security remediation guidance"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        # Find remediation task
        remediation = None
        for child in tasks['children']:
            if 'remediation' in child['id']:
                remediation = child
                break

        assert remediation is not None
        assert remediation['type'] == 'manual'
        metadata = remediation['metadata']
        assert 'Enrollment Protection' in metadata['notes']
        assert 'Certificate Pinning' in metadata['notes']
        assert 'Monitoring & Logging' in metadata['notes']

    def test_oscp_metadata_completeness(self, plugin):
        """PROVES: All command tasks have complete OSCP metadata"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        def check_command_task(task):
            """Recursively check command tasks for metadata"""
            if task['type'] == 'command':
                assert 'metadata' in task
                metadata = task['metadata']

                # Required fields
                assert 'command' in metadata
                assert 'description' in metadata
                assert 'tags' in metadata
                assert len(metadata['tags']) > 0

                # OSCP educational fields
                assert 'flag_explanations' in metadata
                assert 'success_indicators' in metadata
                assert 'failure_indicators' in metadata or 'next_steps' in metadata
                assert 'alternatives' in metadata or 'notes' in metadata

                # Success/failure indicators should have content
                if 'success_indicators' in metadata:
                    assert len(metadata['success_indicators']) >= 2
                if 'failure_indicators' in metadata:
                    assert len(metadata['failure_indicators']) >= 1

            # Recurse into children
            if 'children' in task:
                for child in task['children']:
                    check_command_task(child)

        check_command_task(tasks)

    def test_manual_task_documentation(self, plugin):
        """PROVES: Manual tasks have comprehensive educational notes"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        def check_manual_task(task):
            """Recursively check manual tasks"""
            if task['type'] == 'manual':
                assert 'metadata' in task
                metadata = task['metadata']

                # Manual tasks should have extensive notes
                assert 'notes' in metadata
                assert len(metadata['notes']) > 200  # Substantial content

                # Should have educational value
                assert 'description' in metadata

            # Recurse
            if 'children' in task:
                for child in task['children']:
                    check_manual_task(child)

        check_manual_task(tasks)

    def test_all_phases_present(self, plugin):
        """PROVES: All exploitation phases are present"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        phase_ids = [child['id'] for child in tasks['children']]

        # Check for all major phases
        assert any('recon' in pid for pid in phase_ids)
        assert any('serial-exploit' in pid for pid in phase_ids)
        assert any('enrollment' in pid for pid in phase_ids)
        assert any('interception' in pid for pid in phase_ids)
        assert any('persistence' in pid for pid in phase_ids)
        assert any('org-recon' in pid for pid in phase_ids)
        assert any('remediation' in pid for pid in phase_ids)

    def test_high_value_targets_tagged(self, plugin):
        """PROVES: High-value exploitation tasks are tagged OSCP:HIGH"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        high_value_count = 0

        def count_high_value(task):
            nonlocal high_value_count
            if task.get('type') == 'command':
                metadata = task.get('metadata', {})
                if 'OSCP:HIGH' in metadata.get('tags', []):
                    high_value_count += 1

            if 'children' in task:
                for child in task['children']:
                    count_high_value(child)

        count_high_value(tasks)

        # Should have multiple high-value tasks
        assert high_value_count >= 5

    def test_quick_wins_present(self, plugin):
        """PROVES: Quick win tasks are identified"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        quick_wins = []

        def find_quick_wins(task):
            if task.get('type') == 'command':
                metadata = task.get('metadata', {})
                if 'QUICK_WIN' in metadata.get('tags', []):
                    quick_wins.append(task['name'])

            if 'children' in task:
                for child in task['children']:
                    find_quick_wins(child)

        find_quick_wins(tasks)

        # Should have quick win opportunities
        assert len(quick_wins) >= 3

    def test_no_hardcoded_credentials(self, plugin):
        """PROVES: No hardcoded credentials or sensitive data in plugin"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        import json
        task_json = json.dumps(tasks)

        # Check for common credential patterns
        forbidden_patterns = [
            'password=',
            'passwd=',
            'api_key=',
            'secret=',
            'token='
        ]

        for pattern in forbidden_patterns:
            assert pattern not in task_json.lower()

    def test_placeholder_usage(self, plugin):
        """PROVES: Uses target placeholders correctly"""
        tasks = plugin.get_task_tree('192.168.45.100', 443, {'service': 'mdm'})

        def check_placeholders(task):
            if task.get('type') == 'command':
                metadata = task.get('metadata', {})
                command = metadata.get('command', '')

                # Local commands (profiles, security) don't need target
                local_commands = ['profiles', 'security', 'defaults', 'plutil']
                is_local = any(cmd in command for cmd in local_commands)

                if not is_local:
                    # Remote commands should contain target
                    assert '192.168.45.100' in command or '{target}' in command, \
                        f"Command should reference target: {command}"

                # Should not have placeholder artifacts
                assert '<TARGET>' not in command
                assert '<IP>' not in command

            if 'children' in task:
                for child in task['children']:
                    check_placeholders(child)

        check_placeholders(tasks)
