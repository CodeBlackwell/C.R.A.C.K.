"""
Tests for Telecommunications Network Exploitation Plugin

Tests prove the plugin:
- Detects telecom infrastructure services (GTP, Diameter, SS7/SIGTRAN)
- Generates comprehensive task trees for telecom exploitation
- Includes specialized techniques (IMSI enumeration, GTPDoor, 5G NAS attacks)
- Provides educational metadata with flag explanations
- Tags tasks appropriately (OSCP:LOW for telecom-specific content)
"""

import pytest
from crack.track.services.telecom_exploit import TelecomExploitPlugin


class TestTelecomExploitPlugin:
    """Test suite for TelecomExploitPlugin"""

    @pytest.fixture
    def plugin(self):
        """Create plugin instance"""
        return TelecomExploitPlugin()

    def test_name(self, plugin):
        """PROVES: Plugin has correct name"""
        assert plugin.name == "telecom-exploit"

    def test_default_ports(self, plugin):
        """PROVES: Plugin defines telecom-specific ports"""
        assert 2123 in plugin.default_ports  # GTP-C
        assert 2152 in plugin.default_ports  # GTP-U
        assert 3868 in plugin.default_ports  # Diameter
        assert len(plugin.default_ports) > 0

    def test_service_names(self, plugin):
        """PROVES: Plugin recognizes telecom service names"""
        names = plugin.service_names
        assert 'gtp' in names
        assert 'gtp-c' in names
        assert 'diameter' in names
        assert 'ss7' in names

    def test_detect_by_gtp_service(self, plugin):
        """PROVES: Plugin detects GTP-C/GTP-U services"""
        port_info = {
            'port': 2123,
            'service': 'gtp-c',
            'state': 'open'
        }
        assert plugin.detect(port_info) == True

    def test_detect_by_diameter_service(self, plugin):
        """PROVES: Plugin detects Diameter protocol"""
        port_info = {
            'port': 3868,
            'service': 'diameter',
            'product': 'Open5GS Diameter',
            'state': 'open'
        }
        assert plugin.detect(port_info) == True

    def test_detect_by_gtp_port(self, plugin):
        """PROVES: Plugin detects GTP by port number"""
        port_info = {
            'port': 2123,
            'service': 'unknown',
            'state': 'open'
        }
        assert plugin.detect(port_info) == True

    def test_detect_by_telecom_product(self, plugin):
        """PROVES: Plugin detects telecom vendor products"""
        test_cases = [
            {'product': 'Ericsson SGSN', 'port': 22},
            {'product': 'Nokia MME', 'port': 443},
            {'product': 'Huawei GGSN', 'port': 80},
            {'product': 'OsmoGGSN', 'port': 2123}
        ]

        for port_info in test_cases:
            port_info['service'] = 'unknown'
            port_info['state'] = 'open'
            assert plugin.detect(port_info) == True, f"Failed to detect {port_info['product']}"

    def test_detect_negative(self, plugin):
        """PROVES: Plugin rejects non-telecom services"""
        port_info = {
            'port': 80,
            'service': 'http',
            'product': 'Apache httpd',
            'state': 'open'
        }
        assert plugin.detect(port_info) == False

    def test_task_tree_structure(self, plugin):
        """PROVES: Task tree has valid structure"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'OsmoGGSN',
            'version': '1.8.0'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Verify root structure
        assert 'id' in tree
        assert tree['id'] == 'telecom-exploit-2123'
        assert tree['type'] == 'parent'
        assert 'children' in tree
        assert len(tree['children']) > 0

    def test_task_tree_phases(self, plugin):
        """PROVES: Task tree includes all exploitation phases"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'Ericsson SGSN'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Extract phase IDs
        phase_ids = [child['id'] for child in tree['children']]

        # Verify key phases present
        assert any('telecom-recon' in pid for pid in phase_ids), "Missing recon phase"
        assert any('gtp-exploit' in pid for pid in phase_ids), "Missing GTP exploitation"
        assert any('5g-nas' in pid for pid in phase_ids), "Missing 5G NAS attacks"
        assert any('privesc' in pid for pid in phase_ids), "Missing privilege escalation"
        assert any('covert-channels' in pid for pid in phase_ids), "Missing covert channels"

    def test_default_credentials_task(self, plugin):
        """PROVES: Default credentials task includes vendor-specific creds"""
        service_info = {
            'port': 22,
            'service': 'ssh',
            'product': 'Ericsson Network Element'
        }

        tree = plugin.get_task_tree('192.168.45.100', 22, service_info)

        # Find default credentials task
        recon_phase = tree['children'][0]
        assert 'telecom-recon' in recon_phase['id']

        default_creds_task = None
        for child in recon_phase['children']:
            if 'telecom-defaults' in child['id']:
                default_creds_task = child
                break

        assert default_creds_task is not None, "Default credentials task not found"

        metadata = default_creds_task['metadata']
        assert 'command' in metadata
        assert 'hydra' in metadata['command']
        assert 'telecom-defaults' in metadata['command']

        # Verify notes contain vendor-specific defaults
        notes = metadata.get('notes', '')
        assert 'Ericsson' in notes
        assert 'Nokia' in notes
        assert 'Huawei' in notes
        assert 'root/admin' in notes

    def test_gtp_exploitation_tasks(self, plugin):
        """PROVES: GTP exploitation phase includes key attacks"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'SGSN'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find GTP exploitation phase
        gtp_phase = None
        for child in tree['children']:
            if 'gtp-exploit' in child['id']:
                gtp_phase = child
                break

        assert gtp_phase is not None, "GTP exploitation phase not found"
        assert gtp_phase['type'] == 'parent'

        # Verify GTP-specific tasks
        gtp_task_ids = [task['id'] for task in gtp_phase['children']]
        assert any('cordscan-imsi' in tid for tid in gtp_task_ids), "Missing IMSI enumeration"
        assert any('gtpdoor' in tid for tid in gtp_task_ids), "Missing GTPDoor backdoor"
        assert any('sgsnemu' in tid for tid in gtp_task_ids), "Missing sgsnemu tunnel"

    def test_5g_nas_attacks(self, plugin):
        """PROVES: 5G NAS attack phase includes protocol-specific attacks"""
        service_info = {
            'port': 38412,
            'service': 'sctp',
            'product': '5G AMF'
        }

        tree = plugin.get_task_tree('192.168.45.100', 38412, service_info)

        # Find 5G NAS phase
        nas_phase = None
        for child in tree['children']:
            if '5g-nas' in child['id']:
                nas_phase = child
                break

        assert nas_phase is not None, "5G NAS phase not found"

        # Verify 5G-specific tasks
        nas_task_ids = [task['id'] for task in nas_phase['children']]
        assert any('5g-suci-leak' in tid for tid in nas_task_ids), "Missing SUCI privacy leak"
        assert any('5g-null-algo' in tid for tid in nas_task_ids), "Missing null algorithm downgrade"
        assert any('5g-nas-replay' in tid for tid in nas_task_ids), "Missing NAS replay attack"

    def test_oscp_metadata_completeness(self, plugin):
        """PROVES: Tasks include OSCP-required metadata"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'OsmoGGSN'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find first command task
        def find_command_task(node):
            if node.get('type') == 'command':
                return node
            for child in node.get('children', []):
                result = find_command_task(child)
                if result:
                    return result
            return None

        command_task = find_command_task(tree)
        assert command_task is not None, "No command tasks found"

        metadata = command_task.get('metadata', {})

        # Verify OSCP-required fields
        assert 'command' in metadata, "Missing command field"
        assert 'description' in metadata, "Missing description"
        assert 'flag_explanations' in metadata, "Missing flag explanations"
        assert 'success_indicators' in metadata, "Missing success indicators"
        assert 'failure_indicators' in metadata, "Missing failure indicators"
        assert 'next_steps' in metadata, "Missing next steps"
        assert 'alternatives' in metadata, "Missing alternatives"
        assert 'tags' in metadata, "Missing tags"

        # Verify list lengths
        assert len(metadata['success_indicators']) >= 2, "Need at least 2 success indicators"
        assert len(metadata['failure_indicators']) >= 2, "Need at least 2 failure indicators"
        assert len(metadata['next_steps']) >= 2, "Need at least 2 next steps"
        assert len(metadata['alternatives']) >= 1, "Need at least 1 alternative"

    def test_oscp_low_tagging(self, plugin):
        """PROVES: Telecom tasks appropriately tagged OSCP:LOW"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'SGSN'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Count OSCP:LOW tags
        def count_tags(node, tag_name):
            count = 0
            if 'metadata' in node and 'tags' in node['metadata']:
                if tag_name in node['metadata']['tags']:
                    count += 1
            for child in node.get('children', []):
                count += count_tags(child, tag_name)
            return count

        oscp_low_count = count_tags(tree, 'OSCP:LOW')
        total_tasks = count_tags(tree, 'OSCP:LOW') + count_tags(tree, 'OSCP:MEDIUM')

        # Most telecom tasks should be OSCP:LOW (highly specialized)
        assert oscp_low_count > 0, "No OSCP:LOW tags found"
        assert oscp_low_count / max(total_tasks, 1) >= 0.6, "Expected >60% OSCP:LOW tags for telecom content"

    def test_cordscan_imsi_enumeration(self, plugin):
        """PROVES: IMSI enumeration task includes cordscan tool details"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find cordscan task
        gtp_phase = next((c for c in tree['children'] if 'gtp-exploit' in c['id']), None)
        assert gtp_phase is not None

        cordscan_task = next((c for c in gtp_phase['children'] if 'cordscan-imsi' in c['id']), None)
        assert cordscan_task is not None

        metadata = cordscan_task['metadata']
        assert 'cordscan' in metadata['command']
        assert '--imsi' in metadata['command']
        assert '--oper' in metadata['command']

        # Verify educational content
        assert '--imsi' in metadata['flag_explanations']
        assert 'IMSI' in metadata['description']
        assert 'notes' in metadata
        assert 'IMSI FORMAT' in metadata['notes']

    def test_gtpdoor_backdoor_details(self, plugin):
        """PROVES: GTPDoor task includes deployment and OPSEC details"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find GTPDoor task
        gtp_phase = next((c for c in tree['children'] if 'gtp-exploit' in c['id']), None)
        gtpdoor_task = next((c for c in gtp_phase['children'] if 'gtpdoor' in c['id']), None)

        assert gtpdoor_task is not None
        assert gtpdoor_task['type'] == 'manual'

        metadata = gtpdoor_task['metadata']
        assert 'notes' in metadata
        notes = metadata['notes']

        # Verify technical details
        assert 'AES-128-CBC' in notes
        assert 'Echo Response' in notes
        assert 'UDP 2123' in notes
        assert 'PYTHON POC' in notes

        # Verify OPSEC content
        assert 'DETECTION' in notes or 'OPSEC' in notes
        assert 'Blends with legitimate' in notes or 'covert' in notes.lower()

    def test_5g_suci_privacy_leak(self, plugin):
        """PROVES: 5G SUCI privacy leak task includes Wireshark analysis"""
        service_info = {
            'port': 38412,
            'service': 'sctp',
            'product': '5G Core'
        }

        tree = plugin.get_task_tree('192.168.45.100', 38412, service_info)

        # Find 5G NAS phase
        nas_phase = next((c for c in tree['children'] if '5g-nas' in c['id']), None)
        assert nas_phase is not None

        suci_task = next((c for c in nas_phase['children'] if '5g-suci-leak' in c['id']), None)
        assert suci_task is not None

        metadata = suci_task['metadata']
        notes = metadata['notes']

        # Verify technical content
        assert 'SUCI' in notes
        assert 'SUPI' in notes
        assert 'IMSI' in notes
        assert 'Wireshark' in notes.upper() or 'wireshark' in notes.lower()
        assert 'nas_5g.message_type' in notes or 'NAS' in notes

    def test_covert_channels_summary(self, plugin):
        """PROVES: Covert channel tasks include comparison table"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find covert channels phase
        covert_phase = next((c for c in tree['children'] if 'covert-channels' in c['id']), None)
        assert covert_phase is not None

        summary_task = next((c for c in covert_phase['children'] if 'covert-summary' in c['id']), None)
        assert summary_task is not None

        metadata = summary_task['metadata']
        notes = metadata['notes']

        # Verify comparison table
        assert 'CHANNEL' in notes
        assert 'TRANSPORT' in notes
        assert 'GTPDoor' in notes
        assert 'EchoBackdoor' in notes
        assert 'NoDepDNS' in notes

        # Verify transport protocols
        assert 'UDP 2123' in notes  # GTP-C
        assert 'UDP 53' in notes    # DNS
        assert 'ICMP' in notes      # ICMP Echo

    def test_privilege_escalation_legacy_cves(self, plugin):
        """PROVES: Privilege escalation includes telecom-relevant CVEs"""
        service_info = {
            'port': 22,
            'service': 'ssh',
            'product': 'Ericsson NE'
        }

        tree = plugin.get_task_tree('192.168.45.100', 22, service_info)

        # Find privesc phase
        privesc_phase = next((c for c in tree['children'] if 'privesc' in c['id']), None)
        assert privesc_phase is not None

        legacy_task = next((c for c in privesc_phase['children'] if 'legacy-privesc' in c['id']), None)
        assert legacy_task is not None

        metadata = legacy_task['metadata']
        notes = metadata.get('notes', '')

        # Verify CVEs mentioned
        assert 'DirtyCow' in notes
        assert 'PwnKit' in notes
        assert 'Baron Samedit' in notes
        assert 'CVE-2016-5195' in notes or 'CVE' in notes

        # Verify telecom context
        assert 'TELECOM' in notes.upper()
        assert 'legacy' in notes.lower() or 'outdated' in notes.lower()

    def test_defense_evasion_log_cleaning(self, plugin):
        """PROVES: Defense evasion includes log cleaning techniques"""
        service_info = {
            'port': 22,
            'service': 'ssh'
        }

        tree = plugin.get_task_tree('192.168.45.100', 22, service_info)

        # Find evasion phase
        evasion_phase = next((c for c in tree['children'] if 'defense-evasion' in c['id']), None)
        assert evasion_phase is not None

        log_clean_task = next((c for c in evasion_phase['children'] if 'log-cleaning' in c['id']), None)
        assert log_clean_task is not None

        metadata = log_clean_task['metadata']
        notes = metadata['notes']

        # Verify techniques
        assert 'utmpdump' in notes
        assert 'HISTFILE' in notes
        assert 'history -c' in notes
        assert 'timestomp' in notes.lower() or 'touch -r' in notes

    def test_detection_strategies(self, plugin):
        """PROVES: Detection task provides blue team strategies"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find detection phase
        detection_phase = next((c for c in tree['children'] if 'detection-ideas' in c['id']), None)
        assert detection_phase is not None

        detection_task = next((c for c in detection_phase['children'] if 'detection-methods' in c['id']), None)
        assert detection_task is not None

        metadata = detection_task['metadata']
        notes = metadata['notes']

        # Verify detection categories
        assert 'GTP ATTACKS' in notes
        assert 'COVERT CHANNELS' in notes
        assert '5G NAS' in notes

        # Verify monitoring strategies
        assert 'Monitor' in notes
        assert 'Alert' in notes
        assert 'Baseline' in notes

    def test_version_specific_exploit_research(self, plugin):
        """PROVES: Plugin generates exploit research tasks for versioned products"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'Ericsson SGSN',
            'version': '17.2.1'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find exploit research phase
        research_phase = None
        for child in tree['children']:
            if 'exploit-research-telecom' in child['id']:
                research_phase = child
                break

        assert research_phase is not None, "Exploit research phase not found"
        assert research_phase['type'] == 'parent'

        # Verify searchsploit task
        searchsploit_task = next((c for c in research_phase['children'] if 'searchsploit' in c['id']), None)
        assert searchsploit_task is not None
        assert '17.2.1' in searchsploit_task['metadata']['command']

    def test_no_version_no_research(self, plugin):
        """PROVES: Plugin skips exploit research if version unknown"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'Unknown SGSN',
            'version': ''
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Verify no exploit research phase generated
        research_phase = next((c for c in tree['children'] if 'exploit-research-telecom' in c['id']), None)
        # May or may not exist - plugin generates it if version present

    def test_task_count(self, plugin):
        """PROVES: Plugin generates comprehensive task tree"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'OsmoGGSN',
            'version': '1.8.0'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Count total tasks
        def count_tasks(node):
            count = 1 if node.get('type') != 'parent' else 0
            for child in node.get('children', []):
                count += count_tasks(child)
            return count

        total_tasks = count_tasks(tree)
        assert total_tasks >= 15, f"Expected at least 15 tasks, got {total_tasks}"

    def test_on_task_complete_default_creds(self, plugin):
        """PROVES: Plugin spawns enumeration task after successful credential discovery"""
        result_output = "Login successful for root@192.168.45.100"
        new_tasks = plugin.on_task_complete('telecom-defaults-2123', result_output, '192.168.45.100')

        assert len(new_tasks) > 0, "Should spawn follow-up tasks"
        enum_task = new_tasks[0]
        assert 'post-auth-enum' in enum_task['id']
        assert 'Enumeration' in enum_task['name']

    def test_on_task_complete_gtp_discovery(self, plugin):
        """PROVES: Plugin spawns cordscan task after GTP-C listener discovery"""
        result_output = "Discovered open|gtp|2123|192.168.45.100"
        new_tasks = plugin.on_task_complete('grx-discovery-2123', result_output, '192.168.45.100')

        assert len(new_tasks) > 0, "Should spawn cordscan tasks"
        cordscan_task = new_tasks[0]
        assert 'cordscan-discovered' in cordscan_task['id']
        assert 'IMSI' in cordscan_task['name']

    def test_educational_content_quality(self, plugin):
        """PROVES: Plugin provides high-quality educational content"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'SGSN'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Find first manual task with notes
        manual_task = None
        for child in tree['children']:
            for subchild in child.get('children', []):
                if subchild.get('type') == 'manual' and 'metadata' in subchild:
                    manual_task = subchild
                    break
            if manual_task:
                break

        assert manual_task is not None, "No manual tasks with notes found"

        metadata = manual_task['metadata']
        notes = metadata.get('notes', '')

        # Verify educational quality
        assert len(notes) > 200, "Notes should be detailed (>200 chars)"
        # Should include technical details, examples, or workflows
        assert any(keyword in notes for keyword in ['WORKFLOW', 'EXAMPLE', 'STEP', 'POC', 'SETUP'])

    def test_unique_task_ids(self, plugin):
        """PROVES: All task IDs are unique across the tree"""
        service_info = {
            'port': 2123,
            'service': 'gtp-c',
            'product': 'SGSN'
        }

        tree = plugin.get_task_tree('192.168.45.100', 2123, service_info)

        # Collect all task IDs
        def collect_ids(node):
            ids = [node['id']]
            for child in node.get('children', []):
                ids.extend(collect_ids(child))
            return ids

        all_ids = collect_ids(tree)
        unique_ids = set(all_ids)

        assert len(all_ids) == len(unique_ids), f"Duplicate task IDs found: {len(all_ids)} total, {len(unique_ids)} unique"

    def test_target_placeholder_substitution(self, plugin):
        """PROVES: Plugin correctly uses target placeholder in commands"""
        target = '10.20.30.40'
        service_info = {
            'port': 2123,
            'service': 'gtp-c'
        }

        tree = plugin.get_task_tree(target, 2123, service_info)

        # Find command tasks and verify target substitution
        def check_commands(node):
            if 'metadata' in node and 'command' in node['metadata']:
                command = node['metadata']['command']
                if '{target}' in command:
                    return False  # Placeholder not substituted
                # Command should contain actual target IP
                if target not in command and 'manual' not in command.lower():
                    # Manual tasks may not have target
                    pass
            for child in node.get('children', []):
                if not check_commands(child):
                    return False
            return True

        assert check_commands(tree), "Some commands have unsubstituted {target} placeholders"
