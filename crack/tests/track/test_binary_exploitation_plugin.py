"""
Binary Exploitation Plugin Tests

Tests the binary exploitation service plugin for buffer overflow methodology.
"""

import pytest
from crack.track.services.binary_exploitation import BinaryExploitationPlugin
from crack.track.services.registry import ServiceRegistry


@pytest.fixture
def plugin():
    """Create binary exploitation plugin instance"""
    return BinaryExploitationPlugin()


class TestBinaryExploitationPluginInterface:
    """PROVES: Binary exploitation plugin implements required ServicePlugin interface"""

    def test_plugin_name(self, plugin):
        """Plugin has correct name"""
        assert plugin.name == "binary-exploitation"

    def test_plugin_has_default_ports(self, plugin):
        """Plugin has default_ports property (empty for binary analysis)"""
        assert hasattr(plugin, 'default_ports')
        assert isinstance(plugin.default_ports, list)
        # Binary exploitation is file-based, not port-based
        assert len(plugin.default_ports) == 0

    def test_plugin_has_service_names(self, plugin):
        """Plugin has service_names list"""
        assert hasattr(plugin, 'service_names')
        assert isinstance(plugin.service_names, list)
        assert len(plugin.service_names) > 0
        assert 'binary' in plugin.service_names

    def test_plugin_implements_detect(self, plugin):
        """Plugin implements detect() method"""
        assert hasattr(plugin, 'detect')
        assert callable(plugin.detect)

        # Test detect returns bool
        port_info = {'port': 9999, 'service': 'test', 'state': 'open'}
        result = plugin.detect(port_info)
        assert isinstance(result, bool)

    def test_plugin_implements_get_task_tree(self, plugin):
        """Plugin implements get_task_tree() method"""
        assert hasattr(plugin, 'get_task_tree')
        assert callable(plugin.get_task_tree)


class TestBinaryExploitationDetection:
    """PROVES: Plugin detection logic identifies binary exploitation contexts"""

    def test_detects_binary_service(self, plugin):
        """Detects explicitly marked binary analysis"""
        assert plugin.detect({'service': 'binary', 'port': 9999, 'binary_analysis': True})

    def test_detects_executable_service(self, plugin):
        """Detects executable service"""
        assert plugin.detect({'service': 'executable', 'port': 9999})

    def test_detects_bof_service(self, plugin):
        """Detects buffer overflow marked service"""
        assert plugin.detect({'service': 'bof', 'port': 9999})

    def test_detects_buffer_overflow_product(self, plugin):
        """Detects buffer overflow in product field"""
        assert plugin.detect({'service': 'custom', 'product': 'buffer overflow vuln', 'port': 9999})

    def test_does_not_detect_regular_services(self, plugin):
        """Does not detect regular network services"""
        assert not plugin.detect({'service': 'http', 'port': 80})
        assert not plugin.detect({'service': 'ssh', 'port': 22})
        assert not plugin.detect({'service': 'mysql', 'port': 3306})

    def test_detects_with_binary_analysis_flag(self, plugin):
        """Detects when binary_analysis flag is set"""
        assert plugin.detect({'service': 'custom', 'port': 9999, 'binary_analysis': True})


class TestBinaryExploitationTaskGeneration:
    """PROVES: Plugin generates comprehensive buffer overflow methodology task trees"""

    def test_generates_valid_task_tree_structure(self, plugin):
        """Generates valid task tree with required fields"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={
                'version': '1.0',
                'binary_path': '/opt/vuln_binary',
                'platform': 'linux'
            }
        )

        # Validate root structure
        assert isinstance(task_tree, dict)
        assert 'id' in task_tree
        assert 'name' in task_tree
        assert 'type' in task_tree
        assert 'children' in task_tree
        assert task_tree['type'] == 'parent'
        assert task_tree['id'] == 'binary-exploit-methodology'

    def test_generates_linux_exploitation_phases(self, plugin):
        """Linux exploitation includes all phases"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={
                'binary_path': '/opt/vuln',
                'platform': 'linux'
            }
        )

        children = task_tree['children']
        assert len(children) >= 4  # At least 4 phases

        # Verify phase IDs
        phase_ids = [child['id'] for child in children]
        assert 'phase-1-discovery' in phase_ids
        assert 'phase-2-control' in phase_ids
        assert 'phase-3-badchars' in phase_ids
        assert 'phase-4-linux-exploit' in phase_ids

    def test_generates_windows_exploitation_phases(self, plugin):
        """Windows exploitation includes SEH techniques"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={
                'binary_path': 'C:\\vuln.exe',
                'platform': 'windows'
            }
        )

        children = task_tree['children']
        phase_ids = [child['id'] for child in children]
        assert 'phase-4-windows-exploit' in phase_ids

        # Find Windows exploit phase
        windows_phase = next((c for c in children if c['id'] == 'phase-4-windows-exploit'), None)
        assert windows_phase is not None
        assert windows_phase['type'] == 'parent'

        # Check for SEH exploitation
        seh_tasks = [t for t in windows_phase['children'] if 'seh' in t['id'].lower()]
        assert len(seh_tasks) > 0

    def test_phase_1_discovery_tasks(self, plugin):
        """Phase 1 includes file analysis, protection check, fuzzing"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_1 = task_tree['children'][0]
        assert phase_1['id'] == 'phase-1-discovery'

        task_ids = [t['id'] for t in phase_1['children']]
        assert 'file-analysis' in task_ids
        assert 'protection-analysis' in task_ids
        assert 'fuzzing-crash' in task_ids

    def test_phase_2_control_tasks(self, plugin):
        """Phase 2 includes pattern generation, offset finding, control verification"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_2 = task_tree['children'][1]
        assert phase_2['id'] == 'phase-2-control'

        task_ids = [t['id'] for t in phase_2['children']]
        assert 'generate-pattern' in task_ids
        assert 'find-offset' in task_ids
        assert 'verify-control' in task_ids

    def test_phase_3_badchars_tasks(self, plugin):
        """Phase 3 includes bad character discovery"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_3 = task_tree['children'][2]
        assert phase_3['id'] == 'phase-3-badchars'

        task_ids = [t['id'] for t in phase_3['children']]
        assert 'generate-badchars' in task_ids
        assert 'test-badchars' in task_ids

    def test_linux_exploitation_strategies(self, plugin):
        """Linux phase includes ret2win, shellcode, ROP strategies"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        linux_phase = task_tree['children'][3]
        assert linux_phase['id'] == 'phase-4-linux-exploit'

        task_ids = [t['id'] for t in linux_phase['children']]
        assert 'ret2win-linux' in task_ids
        assert 'stack-shellcode-linux' in task_ids
        assert 'rop-linux' in task_ids

    def test_windows_seh_exploitation(self, plugin):
        """Windows phase includes SEH-specific tasks"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': 'C:\\vuln.exe', 'platform': 'windows'}
        )

        windows_phase = task_tree['children'][3]
        seh_task = next((t for t in windows_phase['children'] if t['id'] == 'seh-overflow'), None)
        assert seh_task is not None
        assert seh_task['type'] == 'parent'

        seh_subtasks = [t['id'] for t in seh_task['children']]
        assert 'verify-seh-overwrite' in seh_subtasks
        assert 'find-pop-pop-ret' in seh_subtasks
        assert 'seh-jump-back' in seh_subtasks
        assert 'windows-shellcode' in seh_subtasks


class TestBinaryExploitationMetadata:
    """PROVES: Tasks include complete OSCP-required metadata"""

    def test_file_analysis_has_complete_metadata(self, plugin):
        """File analysis task has all metadata fields"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_1 = task_tree['children'][0]
        file_analysis = next((t for t in phase_1['children'] if t['id'] == 'file-analysis'), None)

        assert file_analysis is not None
        metadata = file_analysis['metadata']

        # Required fields
        assert 'command' in metadata
        assert 'description' in metadata
        assert 'tags' in metadata
        assert 'flag_explanations' in metadata
        assert 'success_indicators' in metadata
        assert 'failure_indicators' in metadata
        assert 'next_steps' in metadata
        assert 'alternatives' in metadata
        assert 'notes' in metadata

        # Validate content
        assert metadata['command'].startswith('file ')
        assert len(metadata['tags']) > 0
        assert 'OSCP:HIGH' in metadata['tags']
        assert len(metadata['success_indicators']) > 0
        assert len(metadata['alternatives']) > 0

    def test_protection_analysis_has_flag_explanations(self, plugin):
        """Protection analysis explains checksec flags"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_1 = task_tree['children'][0]
        protection_task = next((t for t in phase_1['children'] if t['id'] == 'protection-analysis'), None)

        assert protection_task is not None
        metadata = protection_task['metadata']

        assert 'flag_explanations' in metadata
        assert '--file' in metadata['flag_explanations']
        assert len(metadata['flag_explanations']['--file']) > 0

    def test_pattern_create_has_oscp_tags(self, plugin):
        """Pattern generation task has OSCP relevance tags"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_2 = task_tree['children'][1]
        pattern_task = next((t for t in phase_2['children'] if t['id'] == 'generate-pattern'), None)

        assert pattern_task is not None
        metadata = pattern_task['metadata']

        assert 'tags' in metadata
        assert 'OSCP:HIGH' in metadata['tags']
        assert 'QUICK_WIN' in metadata['tags']

    def test_shellcode_generation_has_alternatives(self, plugin):
        """Shellcode generation task provides manual alternatives"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        # Find shellcode generation task
        linux_phase = task_tree['children'][3]
        shellcode_parent = next((t for t in linux_phase['children'] if t['id'] == 'stack-shellcode-linux'), None)
        assert shellcode_parent is not None

        shellcode_task = next((t for t in shellcode_parent['children'] if t['id'] == 'generate-shellcode-linux'), None)
        assert shellcode_task is not None

        metadata = shellcode_task['metadata']
        assert 'alternatives' in metadata
        assert len(metadata['alternatives']) >= 2
        # Check for pwntools alternative
        assert any('pwntools' in alt.lower() or 'pwn' in alt.lower() for alt in metadata['alternatives'])

    def test_manual_tasks_have_next_steps(self, plugin):
        """Manual tasks include detailed next_steps guidance"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': 'C:\\vuln.exe', 'platform': 'windows'}
        )

        # Find a manual task
        phase_2 = task_tree['children'][1]
        verify_control = next((t for t in phase_2['children'] if t['id'] == 'verify-control'), None)

        assert verify_control is not None
        assert verify_control['type'] == 'manual'
        metadata = verify_control['metadata']

        assert 'next_steps' in metadata
        assert len(metadata['next_steps']) >= 3
        # Verify steps are actionable
        assert any('exploit' in step.lower() for step in metadata['next_steps'])

    def test_command_tasks_have_success_failure_indicators(self, plugin):
        """Command tasks include success and failure indicators"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        phase_1 = task_tree['children'][0]
        fuzzing_task = next((t for t in phase_1['children'] if t['id'] == 'fuzzing-crash'), None)

        assert fuzzing_task is not None
        metadata = fuzzing_task['metadata']

        assert 'success_indicators' in metadata
        assert len(metadata['success_indicators']) >= 2
        assert any('segmentation' in ind.lower() or 'crash' in ind.lower()
                   for ind in metadata['success_indicators'])

        assert 'failure_indicators' in metadata
        assert len(metadata['failure_indicators']) >= 2


class TestBinaryExploitationEdgeCases:
    """PROVES: Plugin handles edge cases and platform variations"""

    def test_handles_unknown_platform(self, plugin):
        """Handles unknown platform with generic tasks"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'unknown'}
        )

        # Should still generate tasks
        assert 'children' in task_tree
        assert len(task_tree['children']) >= 3  # At least discovery, control, badchars

        # Last phase should be generic
        last_phase = task_tree['children'][-1]
        assert 'generic' in last_phase['id']

    def test_handles_missing_binary_path(self, plugin):
        """Handles missing binary_path gracefully"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'platform': 'linux'}
        )

        # Should still generate with placeholder path
        assert 'children' in task_tree
        phase_1 = task_tree['children'][0]
        file_task = phase_1['children'][0]

        # Should have some path (default placeholder)
        assert 'command' in file_task['metadata']
        assert 'file ' in file_task['metadata']['command']

    def test_handles_version_info(self, plugin):
        """Includes version info in task context"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={
                'version': 'vuln-server-1.2.3',
                'binary_path': '/opt/vuln',
                'platform': 'linux'
            }
        )

        # Should generate tasks (version doesn't break generation)
        assert len(task_tree['children']) >= 4

    def test_linux_stack_shellcode_subtasks(self, plugin):
        """Linux stack shellcode includes NX check, shellcode gen, JMP ESP finding"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        linux_phase = task_tree['children'][3]
        shellcode_parent = next((t for t in linux_phase['children']
                                if t['id'] == 'stack-shellcode-linux'), None)

        assert shellcode_parent is not None
        assert shellcode_parent['type'] == 'parent'

        subtask_ids = [t['id'] for t in shellcode_parent['children']]
        assert 'check-nx' in subtask_ids
        assert 'generate-shellcode-linux' in subtask_ids
        assert 'find-jmp-esp' in subtask_ids

    def test_windows_includes_standard_eip_and_egghunter(self, plugin):
        """Windows includes both SEH and standard EIP exploitation"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': 'C:\\vuln.exe', 'platform': 'windows'}
        )

        windows_phase = task_tree['children'][3]
        task_ids = [t['id'] for t in windows_phase['children']]

        assert 'seh-overflow' in task_ids
        assert 'standard-eip-windows' in task_ids
        assert 'egghunter-windows' in task_ids


class TestBinaryExploitationRegistry:
    """PROVES: Plugin registers correctly with ServiceRegistry"""

    def test_plugin_registered_in_service_registry(self):
        """Binary exploitation plugin is registered"""
        ServiceRegistry.initialize_plugins()
        plugin = ServiceRegistry.get_plugin_by_name('binary-exploitation')
        assert plugin is not None
        assert isinstance(plugin, BinaryExploitationPlugin)

    def test_plugin_in_all_plugins_list(self):
        """Plugin appears in all plugins list"""
        ServiceRegistry.initialize_plugins()
        all_plugins = ServiceRegistry.get_all_plugins()
        names = [p.name for p in all_plugins]
        assert 'binary-exploitation' in names


class TestBinaryExploitationOSCPRelevance:
    """PROVES: Plugin focuses on OSCP-relevant exploitation techniques"""

    def test_includes_oscp_high_tags(self, plugin):
        """Critical tasks tagged OSCP:HIGH"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        # Collect all tags
        def get_all_tags(node):
            tags = []
            if 'metadata' in node:
                tags.extend(node['metadata'].get('tags', []))
            for child in node.get('children', []):
                tags.extend(get_all_tags(child))
            return tags

        all_tags = get_all_tags(task_tree)
        assert 'OSCP:HIGH' in all_tags

        # Count OSCP:HIGH tasks
        oscp_high_count = all_tags.count('OSCP:HIGH')
        assert oscp_high_count >= 5  # At least 5 critical tasks

    def test_includes_quick_wins(self, plugin):
        """Includes QUICK_WIN tasks for rapid assessment"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        def get_all_tags(node):
            tags = []
            if 'metadata' in node:
                tags.extend(node['metadata'].get('tags', []))
            for child in node.get('children', []):
                tags.extend(get_all_tags(child))
            return tags

        all_tags = get_all_tags(task_tree)
        assert 'QUICK_WIN' in all_tags

    def test_includes_manual_techniques(self, plugin):
        """Includes MANUAL tasks for exam scenarios"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        def get_all_tags(node):
            tags = []
            if 'metadata' in node:
                tags.extend(node['metadata'].get('tags', []))
            for child in node.get('children', []):
                tags.extend(get_all_tags(child))
            return tags

        all_tags = get_all_tags(task_tree)
        assert 'MANUAL' in all_tags

        # Check for manual task types
        def get_all_types(node):
            types = [node.get('type')] if 'type' in node else []
            for child in node.get('children', []):
                types.extend(get_all_types(child))
            return types

        all_types = get_all_types(task_tree)
        assert 'manual' in all_types

    def test_provides_tool_alternatives(self, plugin):
        """Every automated task has manual alternatives"""
        task_tree = plugin.get_task_tree(
            target='192.168.45.100',
            port=9999,
            service_info={'binary_path': '/opt/vuln', 'platform': 'linux'}
        )

        def get_command_tasks(node):
            tasks = []
            if node.get('type') == 'command' and 'metadata' in node:
                tasks.append(node)
            for child in node.get('children', []):
                tasks.extend(get_command_tasks(child))
            return tasks

        command_tasks = get_command_tasks(task_tree)
        assert len(command_tasks) > 0

        # Every command task should have alternatives
        for task in command_tasks:
            metadata = task['metadata']
            assert 'alternatives' in metadata, f"Task {task['id']} missing alternatives"
            assert len(metadata['alternatives']) > 0, f"Task {task['id']} has empty alternatives"
