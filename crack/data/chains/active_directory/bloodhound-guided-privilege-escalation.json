{
  "id": "ad-bloodhound-guided-privesc",
  "name": "BloodHound-Guided Privilege Escalation",
  "description": "Complete BloodHound workflow from data collection to privilege escalation exploitation using graph analysis and custom Cypher queries.\n\nThis chain demonstrates the COMPLETE BloodHound methodology for discovering privilege escalation paths in Active Directory. Starts with data collection using bloodhound-python or SharpHound, imports data into Neo4j via BloodHound GUI, runs pre-built queries to find paths to Domain Admins, and when those fail (COMMON scenario), uses custom Cypher queries to discover non-obvious attack paths through AdminTo, HasSession, and group membership relationships.\n\nCRITICAL OSCP PATTERN: Pre-built queries often return 'No paths found' for standard domain users. This does NOT mean no path exists - it means you need custom Cypher queries to find intermediate pivots. The writeup demonstrates: pete (standard user) had no direct path, but mike (another standard user) had AdminTo relationship with CLIENT75, which had Domain Admin service session. This path is INVISIBLE to pre-built queries but DISCOVERABLE with custom Cypher.\n\nWHY THIS MATTERS: BloodHound is MANDATORY for OSCP AD sets. Understanding custom Cypher queries is the difference between 'no paths found' (dead end) vs finding the attack chain (domain compromise). Time investment: 20 minutes BloodHound analysis can save 2+ hours of trial-and-error lateral movement attempts.\n\nSUCCESS RATE: High in corporate and OSCP lab environments (70-80% of AD domains have exploitable BloodHound paths). The key is knowing WHEN to use custom queries (after pre-built fail) and WHICH queries to run (AdminTo for lateral movement, HasSession for credential harvest, MemberOf for privilege escalation).",
  "version": "1.0.0",
  "metadata": {
    "author": "CRACK Development Team - OSCP Track",
    "created": "2025-11-25",
    "updated": "2025-11-25",
    "tags": [
      "OSCP:HIGH",
      "ACTIVE_DIRECTORY",
      "BLOODHOUND",
      "ENUMERATION",
      "PRIVILEGE_ESCALATION",
      "CYPHER_QUERIES",
      "GRAPH_ANALYSIS",
      "NEO4J"
    ],
    "category": "enumeration",
    "platform": "active-directory",
    "references": [
      "https://github.com/BloodHoundAD/BloodHound",
      "https://github.com/fox-it/BloodHound.py",
      "https://posts.specterops.io/introducing-bloodhound-4-0-the-azure-update-9b2b26c5e350",
      "https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/",
      "https://neo4j.com/docs/cypher-manual/current/"
    ]
  },
  "difficulty": "intermediate",
  "time_estimate": "20 minutes",
  "oscp_relevant": true,
  "prerequisites": [
    "Valid domain user credentials (ANY domain user can run BloodHound)",
    "BloodHound installed on Kali (bloodhound-python) OR SharpHound on Windows",
    "Neo4j database running (sudo neo4j start)",
    "BloodHound GUI accessible (bloodhound in terminal)",
    "Network access to domain controller for LDAP queries (port 389/636)"
  ],
  "notes": "OSCP BLOODHOUND METHODOLOGY: BloodHound is the FIRST enumeration step for AD environments. Provides complete domain relationship map in 5 minutes vs hours of manual enumeration. CRITICAL LESSON from Corp-DCSync writeup: Pre-built query 'Shortest Paths to Domain Admins' returned 'No paths found' for pete. Custom Cypher query revealed mike had AdminTo on CLIENT75, which had Domain Admin service session. This pattern is COMMON in OSCP labs - standard users don't have direct paths, but INTERMEDIATE systems do. TIME BUDGET: 5 min data collection + 5 min upload/ingest + 10 min analysis = 20 minutes MAXIMUM. If no clear path after 20 min, proceed with what you have and revisit after compromising additional accounts. EXAM TIP: Clear old BloodHound data before each new domain (Database Info → Clear Database). Cross-contamination from previous labs causes wrong attack paths. MANUAL ALTERNATIVE: If BloodHound GUI fails, parse JSON with jq: jq '.data[] | select(.Properties.name==\"USER@DOMAIN.COM\")' users.json. COMPLEMENTARY TO: CrackMapExec enumeration (provides user lists for BloodHound targeting), Kerberoasting (service accounts found via BloodHound SPN queries), AS-REP roasting (pre-auth disabled users found via BloodHound).",
  "steps": [
    {
      "id": "authenticate-domain",
      "name": "Authenticate to Domain with Valid Credentials",
      "objective": "Establish authenticated domain user session required for LDAP queries and data collection",
      "description": "REQUIREMENT: Valid domain user credentials.\nANY domain user can run BloodHound - no special privileges required. Even low-privilege standard user accounts can enumerate complete domain structure via LDAP queries.\n\nAUTHENTICATION METHODS:\n\nLINUX (bloodhound-python):\nCredentials provided via command line:\nbloodhound-python -u <USERNAME> -p '<PASSWORD>' -d <DOMAIN> -ns <DC_IP> -c All --zip\n\nPassword prompted interactively OR provided inline.\nAlternative: Use NTLM hash with -hashes flag OR Kerberos ticket with -k flag.\n\nWINDOWS (SharpHound.exe):\nUse current user session (if domain-joined) OR runas /netonly /user:<DOMAIN>\\<USERNAME> cmd.exe to inject credentials.\nSharpHound.exe automatically uses current session context - no credential parameters needed.\n\nVERIFICATION:\n\nLinux: bloodhound-python -u pete -p 'Nexus123!' -d corp.com -ns 192.168.223.70 -c All --zip\nExpected: 'Resolved Collection Methods: ...' (authentication successful)\nFailure: 'Could not connect to LDAP' OR 'Authentication failed' (check credentials/DC IP)\n\nWindows: whoami /groups (should show domain groups like 'DOMAIN USERS')\n\nTIME SYNC CRITICAL:\nKerberos authentication requires time sync within 5 minutes of DC.\nFix clock skew: sudo ntpdate <DC_IP> OR sudo rdate -n <DC_IP>\nVerify: date (check time matches DC time closely)\nError without sync: KRB_AP_ERR_SKEW (Clock skew too great)\n\nCOMMON FAILURES:\n\n1. STATUS_LOGON_FAILURE:\nCause: Invalid credentials, wrong domain, or account locked.\nSolution: Verify credentials with crackmapexec smb <DC_IP> -u <USER> -p '<PASS>' -d <DOMAIN>\n\n2. Connection timeout:\nCause: DC unreachable or LDAP port blocked.\nSolution: Test connectivity: nc -zv <DC_IP> 389 (LDAP) AND nc -zv <DC_IP> 636 (LDAPS)\n\n3. KDC_ERR_C_PRINCIPAL_UNKNOWN:\nCause: Wrong username or domain name.\nSolution: Check domain name: nslookup <DC_IP> (should return domain FQDN)\n\nOSCP TIP: Test authentication BEFORE starting BloodHound collection to avoid wasting time. 30 seconds validation saves 5 minutes troubleshooting failed collection.\n\nTIME ESTIMATE: 1-2 minutes (includes time sync and verification).",
      "command_ref": "bloodhound-python-collect",
      "evidence": [
        "Credentials authenticate successfully to domain controller",
        "LDAP connection established (no timeout or access denied errors)",
        "Time synchronized within 5 minutes of DC (no KRB_AP_ERR_SKEW)",
        "Domain user context confirmed (whoami /groups shows domain groups on Windows)"
      ],
      "dependencies": [],
      "repeatable": false,
      "success_criteria": [
        "Authentication succeeds without errors",
        "LDAP queries respond (no connection timeout)",
        "No Kerberos clock skew errors",
        "Domain context established"
      ],
      "failure_conditions": [
        "STATUS_LOGON_FAILURE (invalid credentials - verify with crackmapexec)",
        "Connection timeout (DC unreachable - verify network access to port 389/636)",
        "KRB_AP_ERR_SKEW (time sync issue - run ntpdate <DC_IP>)",
        "KDC_ERR_C_PRINCIPAL_UNKNOWN (wrong username or domain)"
      ],
      "next_steps": [
        "collect-bloodhound-data"
      ]
    },
    {
      "id": "collect-bloodhound-data",
      "name": "Collect BloodHound Data with All Collection Methods",
      "objective": "Execute BloodHound data collection to enumerate users, computers, groups, sessions, trusts, and ACLs",
      "description": "COLLECTION METHODS:\n\nbloodhound-python (Linux - RECOMMENDED for OSCP):\nbloodhound-python -u <USERNAME> -p '<PASSWORD>' -d <DOMAIN> -ns <DC_IP> -c All --zip\n\nFlags explained:\n-c All: Collect ALL data (users, groups, computers, sessions, trusts, ACLs, containers)\n--zip: Automatically create ZIP file for easy upload (bh.zip)\n-ns <DC_IP>: Specify DNS server (use DC IP for reliable resolution)\n\nOutput:\n[*] Resolved Collection Methods: Group, LocalAdmin, Session, Trusts, ACL, ObjectProps, Container\n[*] Connecting to LDAP server: dc01.corp.com\n[+] Done in 00M 45S\n[*] Compressing output into bh.zip\n\nResult: bh.zip file created (500KB-5MB depending on domain size)\nContains: users.json, computers.json, groups.json, sessions.json, trusts.json, acls.json, containers.json\n\nSharpHound.exe (Windows - if RDP/WinRM access):\nSharpHound.exe -c All --zipfilename bh.zip\n\nAdvantages over bloodhound-python:\n- Collects local admin sessions (bloodhound-python uses LDAP only, misses some sessions)\n- Faster for large domains (native C# vs Python)\n\nDisadvantages:\n- Requires Windows code execution (may trigger AV)\n- Requires file transfer to Kali for analysis\n\nCOLLECTION SCOPES:\n\n-c All: COMPLETE collection (recommended - only 5 extra seconds vs partial)\n-c Session: ONLY user sessions (fast but incomplete)\n-c DCOnly: Domain Controller data only (excludes workstation sessions - NOT recommended)\n\nCRITICAL FOR OSCP: ALWAYS use -c All. Session data is CRITICAL for finding Domain Admin credentials cached on workstations (the service session pattern from writeup). DCOnly collection MISSES this goldmine.\n\nTROUBLESHOOTING:\n\n1. 'Could not resolve domain':\nCause: DNS resolution failing.\nSolution: Use -ns flag with DC IP: -ns 192.168.223.70\n\n2. 'No session data collected':\nCause: bloodhound-python limitation (LDAP-based, doesn't enumerate all sessions).\nSolution: Use SharpHound.exe if Windows access available OR accept reduced session data.\nAlternative: Manual session enumeration: crackmapexec smb <SUBNET> -u <USER> -p '<PASS>' --sessions\n\n3. Collection hangs:\nCause: Large domain (1000+ users) or network latency.\nSolution: Wait (can take 5-10 minutes for very large domains) OR use --dns-tcp flag for stability.\n\n4. Partial data (empty users.json):\nCause: Insufficient LDAP permissions OR wrong base DN.\nSolution: Verify authentication successful, try --dns-tcp, check LDAP not blocked.\n\nDATA VERIFICATION:\n\nunzip -l bh.zip\nExpected files:\nusers.json (100KB-1MB)\ncomputers.json (50KB-500KB)\ngroups.json (50KB-200KB)\nsessions.json (10KB-100KB)\ntrusts.json (small, <10KB)\nacls.json (large, 1MB-10MB)\n\nQuick check:\njq '.data | length' users.json\nExpected: 10+ users (small domain) to 1000+ users (large domain)\nIf 0: Collection failed, troubleshoot authentication/LDAP access.\n\nOSCP EXAM SCENARIO: Small domain (10-50 users, 5-20 computers). Collection completes in 30-90 seconds. Output file <1MB.\n\nTIME ESTIMATE: 30 seconds - 2 minutes (OSCP typical), up to 10 minutes (large corporate domains).",
      "command_ref": "bloodhound-python-collect",
      "evidence": [
        "bh.zip file created with all JSON files",
        "users.json contains user data (jq '.data | length' users.json shows count >0)",
        "computers.json contains computer data",
        "sessions.json contains session data (critical for service session attacks)",
        "File sizes reasonable (users.json 100KB-1MB, not 0 bytes)",
        "No collection errors or partial data warnings"
      ],
      "dependencies": [
        "authenticate-domain"
      ],
      "repeatable": true,
      "success_criteria": [
        "bh.zip created successfully",
        "All JSON files present in ZIP",
        "User count >0 (verify with jq)",
        "Computer count >0",
        "Session data present (even if limited)",
        "No LDAP access denied errors"
      ],
      "failure_conditions": [
        "Could not resolve domain (DNS issue - use -ns flag with DC IP)",
        "Connection timeout (LDAP port 389 blocked - verify firewall rules)",
        "Empty JSON files (authentication or permission issue)",
        "Collection hangs indefinitely (large domain or network latency)",
        "AV blocks SharpHound.exe (use bloodhound-python from Kali instead)"
      ],
      "next_steps": [
        "upload-to-bloodhound"
      ]
    },
    {
      "id": "upload-to-bloodhound",
      "name": "Upload Data to BloodHound GUI and Verify Ingestion",
      "objective": "Import collected JSON data into Neo4j database via BloodHound GUI for graph analysis",
      "description": "PREREQUISITE: Neo4j running and BloodHound GUI launched.\n\nStart Neo4j:\nsudo neo4j start\nVerify: sudo neo4j status (should show 'active (running)')\nDefault credentials: neo4j:neo4j (change on first login)\n\nStart BloodHound GUI:\nbloodhound\nLogin: neo4j / <your_password>\nExpected: BloodHound interface opens with 'Upload Data' button.\n\nUPLOAD PROCESS:\n\n1. Click 'Upload Data' button (top-right, database icon with up arrow)\n2. Select bh.zip file OR drag-and-drop ZIP file into window\n3. Ingestion begins automatically\n\nIngestion Output:\n[*] Processing users.json\n[+] Imported 25 users\n[*] Processing computers.json\n[+] Imported 8 computers\n[*] Processing groups.json\n[+] Imported 12 groups\n[*] Processing sessions.json\n[+] Imported 45 sessions\n[*] Processing trusts.json\n[+] Imported 0 trusts (no domain trusts in small domains - normal)\n[*] Processing acls.json\n[+] Imported 1250 ACL relationships\n\nExpected completion: 10-30 seconds for OSCP-sized domain.\n\nVERIFICATION:\n\nDatabase Info (bottom-left icon):\n- Users: 25 (should match 'jq '.data | length' users.json')\n- Computers: 8\n- Groups: 12\n- Sessions: 45\n- ACLs: 1250\n- Relationships: ~1500-2000 total\n\nIf counts are 0: Upload failed, data not ingested.\n\nSearch bar test:\nType a known username (e.g., 'pete' from enumeration).\nExpected: User node appears, click to view properties.\nProperties show: name, domain, enabled, description, password last set, etc.\n\nCRITICAL: CLEAR OLD DATA BEFORE NEW UPLOADS\n\nProblem: Previous lab domains still in database cause confusion.\nSymptom: Queries return results from WRONG domain.\n\nSolution:\nDatabase Info → Clear Database → Confirm\nWaits 5-10 seconds for deletion.\nVerify: All counts show 0.\nThen upload new domain data.\n\nOSCP EXAM TIP: Clear database at START of each AD target. Prevents cross-contamination between exam machines.\n\nTROUBLESHOOTING:\n\n1. 'Could not connect to Neo4j':\nCause: Neo4j not running OR wrong credentials.\nSolution: sudo neo4j status, verify running. Reset password if needed: sudo neo4j-admin set-initial-password <newpass>\n\n2. Upload hangs or fails:\nCause: Large JSON files (>10MB) OR corrupted ZIP.\nSolution: Extract ZIP, upload individual JSON files: Upload Data → select users.json, then computers.json, etc.\nAlternative: Increase Neo4j heap memory in /etc/neo4j/neo4j.conf: dbms.memory.heap.max_size=2G\n\n3. Zero nodes imported:\nCause: Empty JSON files (collection failed in step 2).\nSolution: Return to step 2, troubleshoot collection, re-collect data.\n\n4. Partial import (users imported but no sessions):\nCause: sessions.json empty (bloodhound-python limitation) OR excluded from collection.\nSolution: Re-collect with -c All flag. If still empty, accept reduced session data (common with bloodhound-python).\n\nMANUAL VERIFICATION QUERIES:\n\nDatabase Info → Raw Query (bottom icon, </> symbol)\n\nTest query 1 (count users):\nMATCH (u:User) RETURN count(u)\nExpected: Same count as Database Info\n\nTest query 2 (list users):\nMATCH (u:User) RETURN u.name LIMIT 10\nExpected: User list appears (pete@corp.com, mike@corp.com, etc.)\n\nTest query 3 (check sessions):\nMATCH (c:Computer)<-[:HasSession]-(u:User) RETURN c.name, u.name LIMIT 10\nExpected: Computer-user session pairs.\nIf empty: No sessions imported (bloodhound-python limitation OR -c Session not used).\n\nTIME ESTIMATE: 30 seconds - 2 minutes (upload + verification).",
      "command_ref": "bloodhound-upload-data",
      "evidence": [
        "BloodHound GUI shows successful import messages",
        "Database Info displays correct node counts (users, computers, groups)",
        "Search bar finds known users from enumeration",
        "Raw query 'MATCH (u:User) RETURN count(u)' returns expected user count",
        "Relationship count >0 (ACLs, group memberships, sessions imported)"
      ],
      "dependencies": [
        "collect-bloodhound-data"
      ],
      "repeatable": true,
      "success_criteria": [
        "Data imported without errors",
        "Database Info counts match JSON file data",
        "Users searchable in search bar",
        "At least one session relationship exists (if sessions were collected)",
        "No 'connection failed' or 'import failed' errors"
      ],
      "failure_conditions": [
        "Could not connect to Neo4j (Neo4j not running - sudo neo4j start)",
        "Upload fails with timeout (large files - upload individually or increase heap memory)",
        "Zero nodes imported (empty JSON files - re-collect data)",
        "Old domain data still present (forgot to clear database - clear and re-upload)"
      ],
      "next_steps": [
        "analyze-prebuilt-queries"
      ]
    },
    {
      "id": "analyze-prebuilt-queries",
      "name": "Run Pre-Built Queries to Find Privilege Escalation Paths",
      "objective": "Execute BloodHound's built-in queries to identify shortest paths to Domain Admins from compromised users",
      "description": "PRE-BUILT QUERY WORKFLOW:\n\nBloodHound provides ~40 pre-built queries organized by attack category.\nAccess: Three horizontal lines icon (top-left) → Analysis\n\nCRITICAL FIRST STEP: Mark compromised users as 'Owned'.\n\nSearch bar → type compromised username (e.g., 'pete').\nRight-click user node → 'Mark User as Owned' (node turns red skull icon).\nRepeat for ALL compromised accounts (pete, mike, dave, etc.).\n\nWHY: 'Owned Principals' queries ONLY work if users marked as owned.\n\nPRIMARY QUERY: Shortest Paths to Domain Admins from Owned Principals\n\nLocation: Analysis → Domain → 'Shortest Paths to Domain Admins from Owned Principals'\n\nExpected behavior:\n\nSUCCESS SCENARIO (uncommon for standard users):\nGraph displays: owned_user → [relationship chain] → Domain Admins group\nRelationship examples:\n- pete → MemberOf → IT Admins → AdminTo → DC01 → Domain Admins\n- mike → GenericAll → sql_service → MemberOf → Domain Admins\n\nFAILURE SCENARIO (COMMON - this is NORMAL):\n'No Data Returned'\nOR\nGraph shows owned user node with NO connections to Domain Admins.\n\nCRITICAL OSCP LESSON: This does NOT mean no path exists!\n\nFrom Corp-DCSync writeup:\npete@corp.com marked as owned.\nQuery: 'Shortest Paths to Domain Admins from Owned Principals'\nResult: NO DATA RETURNED\n\nInterpretation: pete has no DIRECT privilege escalation path.\npete is standard domain user with no AdminTo, GenericAll, or other exploitable permissions to privileged accounts.\n\nSOLUTION: Proceed to step 5 (custom Cypher queries) to find INDIRECT paths.\n\nALTERNATIVE PRE-BUILT QUERIES (try these if primary fails):\n\n1. Find Workstations where Domain Users can RDP:\nAnalysis → Domain → 'Find Workstations where Domain Users can RDP'\nLooks for: (Domain Users group) → CanRDP → (Computer)\nUse case: If compromised user can RDP to workstation, gain interactive access for credential dumping.\n\n2. Find Computers where Domain Users are Local Admin:\nAnalysis → Domain → 'Find Computers where Domain Users are Local Admin'\nLooks for: (Domain Users group) → AdminTo → (Computer)\nUse case: If compromised user has local admin, can use PSExec/WinRM for SYSTEM shell.\n\n3. Shortest Paths to High Value Targets:\nAnalysis → Pathfinding → 'Shortest Paths to High Value Targets'\nSelect: Start node = owned user, End node = Domain Admins\nLooks for: ANY relationship chain, not just 'shortest'.\nMay reveal longer paths missed by 'Shortest Paths' query.\n\n4. Find Principals with DCSync Rights:\nAnalysis → Domain → 'Find Principals with DCSync Rights'\nLooks for: Users/groups with DS-Replication-Get-Changes permissions.\nUse case: If owned user has DCSync rights (rare), instant domain compromise.\n\nQUERY INTERPRETATION:\n\nEDGE TYPES (relationship types between nodes):\n\n- AdminTo: Local administrator on computer (CAN: PSExec, WinRM, WMI for SYSTEM shell)\n- MemberOf: Group membership (CAN: Inherit group privileges)\n- HasSession: User logged into computer (CAN: Credential harvest with mimikatz if you're local admin)\n- GenericAll: Full control over object (CAN: Change password, add to groups, modify ACLs)\n- WriteDACL: Write ACL permissions (CAN: Grant yourself GenericAll)\n- WriteOwner: Change object owner (CAN: Make yourself owner, then WriteDACL, then GenericAll)\n- AllExtendedRights: All extended rights (CAN: Force-ChangePassword, Read LAPS password)\n- ForceChangePassword: Reset user password (CAN: Change password, authenticate as user)\n\nATTACK PATH EXAMPLES:\n\nExample 1 (Direct):\npete → AdminTo → FILE01 → HasSession → maria (Domain Admin)\nAttack: PSExec to FILE01 as pete → mimikatz dumps maria's credentials → Pass-the-Hash as Domain Admin.\n\nExample 2 (Indirect):\npete → MemberOf → Help Desk → ForceChangePassword → sql_service → MemberOf → Domain Admins\nAttack: Reset sql_service password (Help Desk privilege) → Authenticate as sql_service → Domain Admin access.\n\nExample 3 (ACL Abuse):\npete → WriteDACL → IT_Admin group → MemberOf → Domain Admins\nAttack: Grant GenericAll to IT_Admin group → Add pete to IT_Admin → Domain Admin via group membership.\n\nTIME BUDGET: 5 minutes MAXIMUM for pre-built queries.\n\nIf no clear path after 5 minutes → Proceed to custom Cypher queries (step 5).\nDon't waste time clicking through every pre-built query - most won't apply to your scenario.\n\nTIME ESTIMATE: 2-5 minutes (mark owned, run queries, interpret results).",
      "command_ref": "bloodhound-analyze-paths",
      "evidence": [
        "Compromised users marked as 'Owned' (red skull icon in graph)",
        "Pre-built query 'Shortest Paths to Domain Admins from Owned Principals' executed",
        "Query result: EITHER privilege escalation path displayed OR 'No Data Returned'",
        "If path found: Attack chain documented (edge types and target systems identified)",
        "If no path: Documented for proceeding to custom Cypher queries (expected outcome)"
      ],
      "dependencies": [
        "upload-to-bloodhound"
      ],
      "repeatable": true,
      "success_criteria": [
        "All compromised users marked as owned",
        "Pre-built queries executed without errors",
        "Results interpreted correctly (path found OR explicitly no path)",
        "Attack edges understood (AdminTo, HasSession, MemberOf, GenericAll, etc.)",
        "Decision made: exploit found path OR proceed to custom queries"
      ],
      "failure_conditions": [
        "Forgot to mark users as owned (queries return empty - mark users first)",
        "Query returns error (database connection issue - verify Neo4j running)",
        "Cannot interpret graph (read edge types, understand relationships)",
        "Assumed 'No Data' means no attack path exists (WRONG - proceed to custom queries)"
      ],
      "next_steps": [
        "custom-cypher-queries"
      ]
    },
    {
      "id": "custom-cypher-queries",
      "name": "Execute Custom Cypher Queries to Find Hidden Attack Paths",
      "objective": "Use custom Cypher queries to discover privilege escalation paths missed by pre-built queries",
      "description": "WHEN TO USE CUSTOM QUERIES:\n\nPre-built query returned 'No Data' (step 4 failed).\nOwned user is standard domain user with no direct privilege escalation path.\n\nCRITICAL PATTERN from writeup:\npete@corp.com: Pre-built query found NO path.\nCustom query revealed: mike@corp.com (another standard user) has AdminTo → CLIENT75.\nSecond query: CLIENT75 has HasSession → maria@corp.com (Domain Admin).\nATTACK PATH: pete → enumerate users → mike credentials → lateral movement to CLIENT75 → mimikatz dumps maria → Domain Admin.\n\nThis path is INVISIBLE to 'Shortest Paths' query because pete doesn't have the AdminTo relationship - mike does.\n\nCUSTOM CYPHER QUERY ACCESS:\n\nBloodHound GUI: Bottom-left icon (</> symbol) → 'Raw Query'\nOR\nSearch bar: Type advanced Cypher syntax directly.\n\nQUERY 1: Find systems where compromised user has local admin\n\nMATCH (u:User {name:'PETE@CORP.COM'})-[:AdminTo]->(c:Computer)\nRETURN u,c\n\nReplace 'PETE@CORP.COM' with your owned username (UPPERCASE, include @DOMAIN.COM).\n\nExpected results:\nSUCCESS: Graph shows pete → AdminTo → [list of computers]\nExample: pete → AdminTo → WORKSTATION01, WORKSTATION02\nAction: Can PSExec/WinRM to these systems for SYSTEM shell.\n\nNO RESULTS: pete has no local admin rights on any systems.\nAction: Try Query 2 (test other compromised users).\n\nQUERY 2: Find systems where ANOTHER user has local admin\n\nMATCH (u:User {name:'MIKE@CORP.COM'})-[:AdminTo]->(c:Computer)\nRETURN u,c\n\nReplace 'MIKE' with other domain users found during enumeration (dave, jeff, stephanie, etc.).\n\nCorp-DCSync example:\nQuery for mike: FOUND → mike → AdminTo → CLIENT75.CORP.COM\nThis is the BREAKTHROUGH - mike has access even though pete doesn't.\n\nAction: Obtain mike's credentials (password spray, AS-REP roasting, Kerberoasting) → lateral movement to CLIENT75.\n\nQUERY 3: Find Domain Admin sessions on discovered computers\n\nMATCH (c:Computer {name:'CLIENT75.CORP.COM'})<-[:HasSession]-(u:User)\nRETURN c,u\n\nReplace 'CLIENT75.CORP.COM' with computer from Query 2.\n\nExpected results:\nSUCCESS: Graph shows CLIENT75 ← HasSession ← [list of users]\nExample: CLIENT75 ← HasSession ← maria@CORP.COM, dave@CORP.COM\n\nCheck user properties:\nClick maria node → Properties → memberOf: 'DOMAIN ADMINS@CORP.COM'\n\nCRITICAL DISCOVERY: Domain Admin has session on workstation!\nSession type in properties: 'Session: Service from 0' (service account - persists until reboot).\n\nAction: Lateral movement to CLIENT75 with mike credentials → mimikatz dumps maria's Domain Admin credentials → escalate to Domain Admin.\n\nQUERY 4: Find ALL sessions on a computer (broader search)\n\nMATCH (c:Computer {name:'CLIENT75.CORP.COM'})<-[:HasSession]-(u:User)\nRETURN c.name, u.name, u.description\n\nReturns: Computer name, username, user description (shows group memberships).\nUseful for: Identifying non-admin high-value users (SQL admins, backup operators, etc.).\n\nQUERY 5: Find privilege escalation through group membership\n\nMATCH (u:User {name:'PETE@CORP.COM'})-[:MemberOf*1..3]->(g:Group {name:'DOMAIN ADMINS@CORP.COM'})\nRETURN p\n\n*1..3 = traverse 1 to 3 group memberships.\nExample path: pete → MemberOf → IT Admins → MemberOf → Server Operators → MemberOf → Domain Admins\n\nLikely result: NO PATH (standard users not in privileged groups).\nBut worth checking - may find nested group memberships missed by pre-built queries.\n\nQUERY 6: Find computers where Domain Users group has RDP or admin access\n\nMATCH (g:Group {name:'DOMAIN USERS@CORP.COM'})-[:CanRDP|AdminTo]->(c:Computer)\nRETURN g,c\n\n|CanRDP|AdminTo| = match EITHER relationship type.\nUseful: If Domain Users group over-privileged (common misconfiguration).\n\nQUERY 7: Find users with DCSync rights\n\nMATCH (u:User)-[:GetChanges|GetChangesAll]->(d:Domain)\nRETURN u.name\n\nFinds: Users with DS-Replication-Get-Changes permissions (can perform DCSync).\nRare for standard users, but if found = instant domain compromise.\n\nQUERY ITERATION STRATEGY:\n\n1. Query owned user (pete) for AdminTo → If NONE, go to step 2.\n2. Query OTHER users (mike, dave, jeff, etc.) for AdminTo → Find systems with admin access.\n3. Query discovered systems for HasSession → Find high-value users (Domain Admins).\n4. Verify exploitable path: Can you obtain credentials for user with AdminTo? Can you access system with HasSession?\n5. Document attack chain: owned_user → intermediate_user credentials → lateral movement → credential harvest → privilege escalation.\n\nMANUAL JSON PARSING ALTERNATIVE (if BloodHound GUI unavailable):\n\njq '.data[] | select(.Properties.name==\"PETE@CORP.COM\") | .Aces' users.json\nShows: ACL permissions for pete (GenericAll, WriteDACL, etc.).\n\njq '.data[] | select(.Properties.serviceprincipalnames != null) | .Properties.name' users.json\nShows: Users with SPNs (Kerberoasting targets).\n\njq '.data[] | select(.Properties.dontreqpreauth == true) | .Properties.name' users.json\nShows: Users with pre-auth disabled (AS-REP roasting targets).\n\nTROUBLESHOOTING:\n\n1. Query returns syntax error:\nCause: Wrong Cypher syntax OR wrong node/relationship name.\nSolution: Copy query EXACTLY from examples, replace only username/computer name. Node names case-sensitive: User not user.\n\n2. Query returns no results:\nCause: User/computer name wrong OR relationship doesn't exist.\nSolution: Verify name with search bar first. Check spelling and domain (PETE@CORP.COM not PETE).\n\n3. Don't understand graph results:\nCause: Need to learn edge types.\nSolution: Click relationship edge → Properties shows relationship type. Read BloodHound edge documentation.\n\n4. Too many results:\nCause: Query too broad.\nSolution: Add LIMIT clause: MATCH ... RETURN ... LIMIT 10\n\nOSCP EXAM STRATEGY:\n\nTest top 5 users from enumeration (most common usernames: admin, administrator, user, backup, service).\nTest top 5 computers (DCs, file servers, SQL servers most likely to have admin sessions).\nDon't spend >10 minutes on custom queries - if no path found, proceed with credential attacks (Kerberoasting, AS-REP roasting, password spray).\n\nTIME ESTIMATE: 5-10 minutes (iterate through 5-10 custom queries).",
      "command_ref": "bloodhound-cypher-query",
      "evidence": [
        "Custom Cypher queries executed successfully (no syntax errors)",
        "AdminTo relationships discovered for compromised or enumerated users",
        "HasSession relationships found on accessible systems",
        "Attack path documented: user → AdminTo → Computer → HasSession → Domain Admin",
        "Intermediate credentials identified (which user needs compromising for lateral movement)"
      ],
      "dependencies": [
        "analyze-prebuilt-queries"
      ],
      "repeatable": true,
      "success_criteria": [
        "Custom queries reveal attack path missed by pre-built queries",
        "Intermediate user with AdminTo relationship identified",
        "System with Domain Admin session identified",
        "Attack chain documented and validated",
        "Query syntax correct (no Cypher errors)"
      ],
      "failure_conditions": [
        "Syntax errors prevent query execution (copy examples exactly, replace only names)",
        "Cannot interpret query results (learn edge types, read BloodHound docs)",
        "No AdminTo or HasSession relationships found (rare - may need alternative attacks)",
        "Queries timeout (domain too large - add LIMIT clause)"
      ],
      "next_steps": [
        "validate-attack-path"
      ]
    },
    {
      "id": "validate-attack-path",
      "name": "Validate Discovered Attack Path is Exploitable",
      "objective": "Verify the BloodHound-discovered attack path is feasible and systems are accessible",
      "description": "VALIDATION CHECKLIST:\n\nFrom Corp-DCSync example, discovered path:\nmike@CORP.COM → AdminTo → CLIENT75.CORP.COM → HasSession → maria@CORP.COM (Domain Admin)\n\nValidation steps:\n\n1. VERIFY SYSTEM ACCESSIBLE:\n\nPing test:\nping -c 3 192.168.223.75\nExpected: Reply from 192.168.223.75\nFailure: Request timeout (system offline or firewall blocking ICMP).\n\nPort scan:\nsudo nmap -p 445,5985,5986 -Pn 192.168.223.75\nExpected:\n445/tcp open (SMB - for PSExec)\n5985/tcp open (WinRM - for Evil-WinRM)\nOR 5986/tcp open (WinRM HTTPS)\n\nFailure: Ports filtered (firewall blocking lateral movement protocols).\nAlternative: Try RDP (3389), WMI (135), or DCOM (varies).\n\n2. VERIFY USER CREDENTIALS OBTAINABLE:\n\nFrom BloodHound: Need mike@CORP.COM credentials for CLIENT75 access.\n\nCheck if credentials already known:\ngrep -i 'mike' /path/to/credentials.txt\n\nIf NOT known, plan credential acquisition:\n\nOption A: Password spray (if password policy allows):\ncrackmapexec smb 192.168.223.70 -u mike -p password_list.txt -d corp.com\nRisk: Account lockout if threshold exceeded.\n\nOption B: AS-REP roasting (if mike has pre-auth disabled):\nimpacket-GetNPUsers corp.com/mike -no-pass -dc-ip 192.168.223.70\nSuccess: Returns AS-REP hash for offline cracking.\n\nOption C: Kerberoasting (if mike has SPN):\nimpacket-GetUserSPNs corp.com/pete:Nexus123! -request | grep mike\nSuccess: Returns TGS hash for offline cracking.\n\nOption D: Credential reuse from other compromises:\nTest known passwords: crackmapexec smb 192.168.223.70 -u mike -p 'Nexus123!' (try pete's password).\n\nCorp-DCSync result: mike's password = Darkness1099! (obtained via password spray).\n\n3. VERIFY ADMIN ACCESS TO SYSTEM:\n\nTest credentials:\ncrackmapexec smb 192.168.223.75 -u mike -p 'Darkness1099!' -d corp.com\n\nExpected output:\n[+] 192.168.223.75:445 CLIENT75 [+] corp.com\\mike:Darkness1099! (Pwn3d!)\n       ^^^^^^^^ (Pwn3d!) indicator = local admin access CONFIRMED.\n\nFailure outputs:\n[+] corp.com\\mike:Darkness1099! (no Pwn3d): Valid credentials but NOT local admin.\nSolution: BloodHound data wrong OR permissions changed. Find alternative system.\n\n[-] STATUS_LOGON_FAILURE: Invalid credentials.\nSolution: Password wrong OR account locked. Re-verify credentials.\n\n4. VERIFY SESSION EXISTS (optional but recommended):\n\nFrom Kali:\ncrackmapexec smb 192.168.223.75 -u mike -p 'Darkness1099!' -d corp.com --sessions\n\nExpected output:\ncorp.com\\maria (Domain Admin session present)\n\nFailure: No sessions OR maria logged off.\nSolution: Session data may be stale (BloodHound collection was hours/days ago). User may have logged off.\nAlternative: Proceed with credential dump anyway - cached credentials persist even after logoff.\n\nFrom Windows (if RDP/WinRM access):\nquser\nOR\nquery user\n\nShows: Currently logged-on users (interactive sessions only, doesn't show service sessions).\n\n5. VERIFY MIMIKATZ CAN RUN (if AV present):\n\nTest on compromised system first (if you have another Windows access):\n.\\mimikatz.exe \"exit\"\n\nExpected: Mimikatz banner, then exits.\nFailure: File deleted immediately (Windows Defender detected and quarantined).\nSolution: Use alternative (Invoke-Mimikatz PowerShell in-memory, procdump + pypykatz, disable Defender).\n\nPATH VALIDATION DECISION TREE:\n\nSystem accessible + Credentials obtainable + Admin access confirmed = PROCEED TO EXPLOITATION (proceed to attack)\n\nSystem accessible + Credentials obtainable + Admin access DENIED = BloodHound data wrong, find alternative path\n\nSystem accessible + Credentials NOT obtainable = Plan credential acquisition (password spray, AS-REP/Kerberoast, credential reuse)\n\nSystem NOT accessible = System offline or firewalled, find alternative path\n\nDOCUMENTATION:\n\nCreate attack plan file:\necho \"ATTACK PATH VALIDATION\" > attack_plan.txt\necho \"\" >> attack_plan.txt\necho \"Target: CLIENT75.CORP.COM (192.168.223.75)\" >> attack_plan.txt\necho \"Access: mike@CORP.COM (Darkness1099!) - LOCAL ADMIN\" >> attack_plan.txt\necho \"Objective: Dump maria@CORP.COM (Domain Admin) credentials from LSASS\" >> attack_plan.txt\necho \"Method: Evil-WinRM → Upload Mimikatz → privilege::debug → sekurlsa::logonpasswords\" >> attack_plan.txt\necho \"Expected: maria NTLM hash → Pass-the-Hash to DC → Domain Admin access\" >> attack_plan.txt\n\nOSCP EXAM TIP: Validation prevents wasting time on dead-end attack paths. 5 minutes validation saves 30 minutes failed exploitation attempts.\n\nTIME ESTIMATE: 3-5 minutes (connectivity checks, credential verification, admin access confirmation).",
      "command_ref": "crackmapexec-validate-admin",
      "evidence": [
        "Target system responsive (ping succeeds)",
        "Required ports open (445 SMB, 5985/5986 WinRM)",
        "Credentials obtained for user with AdminTo relationship",
        "crackmapexec confirms (Pwn3d!) local admin access",
        "Attack plan documented with specific steps and expected outcomes"
      ],
      "dependencies": [
        "custom-cypher-queries"
      ],
      "repeatable": true,
      "success_criteria": [
        "System accessible via network",
        "Credentials for lateral movement user obtained or obtainable",
        "Local admin access confirmed with crackmapexec",
        "Session validation performed (optional)",
        "Attack path documented and ready for exploitation"
      ],
      "failure_conditions": [
        "System unreachable (offline or firewalled - find alternative path)",
        "Cannot obtain credentials (no password spray/AS-REP/Kerberoast success - try credential reuse)",
        "Valid credentials but no admin access (BloodHound data wrong - verify AdminTo relationship)",
        "All lateral movement ports blocked (445, 5985, 3389, 135 all filtered - find alternative route)"
      ],
      "next_steps": []
    }
  ]
}
