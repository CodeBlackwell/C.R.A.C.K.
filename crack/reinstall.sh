#!/bin/bash
# Reinstall CRACK in development mode
# Supports: pip, uv, and handles Kali/Debian externally-managed Python

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { echo -e "${GREEN}[+]${NC} $1"; }
warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[-]${NC} $1"; exit 1; }
section() { echo -e "\n${CYAN}=== $1 ===${NC}"; }

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# =============================================================================
# CRACK CLI Installation
# =============================================================================
section "Installing CRACK CLI"

# Detect package manager
if command -v uv &>/dev/null; then
    PKG_MGR="uv"
    INSTALL_CMD="uv pip install -e ."
    UNINSTALL_CMD="uv pip uninstall crack -y"
elif [ -n "$VIRTUAL_ENV" ]; then
    PKG_MGR="pip (venv)"
    INSTALL_CMD="python3 -m pip install -e ."
    UNINSTALL_CMD="python3 -m pip uninstall crack -y"
else
    PKG_MGR="pip (system)"
    INSTALL_CMD="python3 -m pip install -e . --break-system-packages"
    UNINSTALL_CMD="python3 -m pip uninstall crack -y --break-system-packages"
fi

info "Using: $PKG_MGR"

# Uninstall existing
info "Uninstalling crack..."
$UNINSTALL_CMD 2>/dev/null || true

# Install in dev mode
info "Installing crack in development mode..."
$INSTALL_CMD

# Verify
if command -v crack &>/dev/null; then
    info "Success! CRACK installed at: $(which crack)"
    crack --version 2>/dev/null || true
else
    warn "Installed but 'crack' not in PATH. Try: source ~/.bashrc"
fi

# =============================================================================
# Crackpedia Installation
# =============================================================================
section "Installing Crackpedia"

CRACKPEDIA_DIR="$SCRIPT_DIR/crackpedia"

if [ -d "$CRACKPEDIA_DIR" ]; then
    # Install npm dependencies if needed
    if [ ! -d "$CRACKPEDIA_DIR/node_modules" ]; then
        info "Installing Crackpedia npm dependencies..."
        cd "$CRACKPEDIA_DIR"
        npm install
        cd "$SCRIPT_DIR"
    else
        info "Crackpedia dependencies already installed"
    fi

    # Create launcher script
    LAUNCHER="/usr/local/bin/crackpedia"
    info "Creating crackpedia launcher..."

    sudo tee "$LAUNCHER" > /dev/null << EOF
#!/bin/bash
# Crackpedia launcher - auto-generated by reinstall.sh
cd "$CRACKPEDIA_DIR"
./start.sh "\$@"
EOF

    sudo chmod +x "$LAUNCHER"

    if command -v crackpedia &>/dev/null; then
        info "Success! Crackpedia installed at: $(which crackpedia)"
    else
        warn "Launcher created but not in PATH"
    fi
else
    warn "Crackpedia directory not found at $CRACKPEDIA_DIR - skipping"
fi

# =============================================================================
# B.R.E.A.C.H. Installation
# =============================================================================
section "Installing B.R.E.A.C.H."

BREACH_DIR="$SCRIPT_DIR/breach"

if [ -d "$BREACH_DIR" ]; then
    # Install npm dependencies if needed
    if [ ! -d "$BREACH_DIR/node_modules" ]; then
        info "Installing B.R.E.A.C.H. npm dependencies..."
        cd "$BREACH_DIR"
        npm install
        cd "$SCRIPT_DIR"
    else
        info "B.R.E.A.C.H. dependencies already installed"
    fi

    # Create launcher script
    BREACH_LAUNCHER="/usr/local/bin/crack-breach"
    info "Creating crack-breach launcher..."

    sudo tee "$BREACH_LAUNCHER" > /dev/null << EOF
#!/bin/bash
# B.R.E.A.C.H. launcher - auto-generated by reinstall.sh
cd "$BREACH_DIR"
./start.sh "\$@"
EOF

    sudo chmod +x "$BREACH_LAUNCHER"

    if command -v crack-breach &>/dev/null; then
        info "Success! B.R.E.A.C.H. installed at: $(which crack-breach)"
    else
        warn "Launcher created but not in PATH"
    fi
else
    warn "B.R.E.A.C.H. directory not found at $BREACH_DIR - skipping"
fi

# =============================================================================
# Summary
# =============================================================================
section "Installation Complete"
echo ""
info "Available commands:"
echo "  crack        - CRACK CLI toolkit"
echo "  crackpedia   - GUI command encyclopedia"
echo "  crack-breach - B.R.E.A.C.H. pentesting workbench (--debug for debug mode)"
