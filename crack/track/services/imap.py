"""
IMAP service enumeration plugin

Generates comprehensive tasks for IMAP enumeration including:
- Banner grabbing and capability enumeration (143, 993)
- NTLM authentication information disclosure (Windows servers)
- Credential testing and brute-force
- Mailbox enumeration and email access
- SSL/TLS certificate analysis

Extracted from Nmap Cookbook Chapter 6:
- Brute forcing IMAP passwords recipe
- Retrieving the capabilities of an IMAP mail server recipe

Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class IMAPPlugin(ServicePlugin):
    """IMAP enumeration plugin"""

    @property
    def name(self) -> str:
        return "imap"

    @property
    def default_ports(self) -> List[int]:
        return [143, 993]

    @property
    def service_names(self) -> List[str]:
        return ['imap', 'imaps', 'imap4', 'imap4-ssl']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect IMAP services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate IMAP enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', '')
        is_ssl = port == 993 or 'ssl' in service_info.get('service', '').lower()

        tasks = {
            'id': f'imap-enum-{port}',
            'name': f'IMAP Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # Task 1: Banner Grabbing and Capability Enumeration
        if is_ssl:
            # Port 993 (IMAPS - SSL/TLS)
            tasks['children'].append({
                'id': f'banner-grab-{port}',
                'name': 'Banner Grabbing (IMAPS SSL/TLS)',
                'type': 'command',
                'metadata': {
                    'command': f'openssl s_client -connect {target}:{port} -quiet',
                    'description': 'Connect to IMAPS over SSL/TLS and grab banner',
                    'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                    'flag_explanations': {
                        's_client': 'OpenSSL SSL/TLS client tool',
                        '-connect': f'Connect to {target}:{port}',
                        '-quiet': 'Suppress verbose SSL handshake output'
                    },
                    'success_indicators': [
                        'SSL handshake successful',
                        '* OK banner received',
                        'Server name and version displayed',
                        'CAPABILITY response shown'
                    ],
                    'failure_indicators': [
                        'SSL handshake failed',
                        'Connection refused',
                        'Wrong SSL/TLS version',
                        'Certificate verification failed'
                    ],
                    'next_steps': [
                        'Note IMAP server software and version',
                        'Check certificate for internal hostnames',
                        'Test IMAP commands for functionality',
                        'Try NTLM info disclosure if Windows server'
                    ],
                    'alternatives': [
                        f'nmap -p{port} -sV --script ssl-cert {target}',
                        f'nmap -p{port} --script imap-capabilities {target}',
                        f'telnet {target} {port} # May fail without SSL'
                    ],
                    'notes': 'Port 993 uses implicit SSL/TLS. Certificate may leak internal server names.',
                    'time_estimate': '10-30 seconds'
                }
            })
        else:
            # Port 143 (IMAP plaintext)
            tasks['children'].append({
                'id': f'banner-grab-{port}',
                'name': 'Banner Grabbing (IMAP plaintext)',
                'type': 'command',
                'metadata': {
                    'command': f'nc -vn {target} {port}',
                    'description': 'Connect to IMAP server and grab banner (reveals version and capabilities)',
                    'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                    'flag_explanations': {
                        '-v': 'Verbose output (shows connection details)',
                        '-n': 'Numeric IP addresses only (no DNS resolution)',
                        f'{port}': f'Target IMAP port {port}'
                    },
                    'success_indicators': [
                        '* OK response (service ready)',
                        'Server software name visible (Dovecot, Courier, Exchange)',
                        'Capability list shown',
                        'Connection successful'
                    ],
                    'failure_indicators': [
                        'Connection refused',
                        'Connection timeout',
                        'No banner received',
                        'STARTTLS required'
                    ],
                    'next_steps': [
                        'Note server software for exploit research',
                        'Check capabilities for authentication methods',
                        'Test LOGIN command if plaintext auth allowed',
                        'Try NTLM info disclosure if Windows'
                    ],
                    'alternatives': [
                        f'telnet {target} {port}',
                        f'nmap -p{port} -sV {target}',
                        f'nmap -p{port} --script imap-capabilities {target}'
                    ],
                    'notes': 'Banner often reveals server type: Dovecot, Courier-IMAP, Microsoft Exchange, Cyrus. Critical for vulnerability research.',
                    'time_estimate': '10-30 seconds'
                }
            })

        # Task 2: Capability Enumeration (Automated)
        tasks['children'].append({
            'id': f'capabilities-{port}',
            'name': 'Capability Enumeration',
            'type': 'command',
            'metadata': {
                'command': f'nmap -p{port} --script imap-capabilities {target}',
                'description': 'Enumerate IMAP server capabilities (AUTH methods, commands, extensions)',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'AUTOMATED'],
                'flag_explanations': {
                    f'-p{port}': f'Target port {port}',
                    '--script imap-capabilities': 'NSE script to query server CAPABILITY command'
                },
                'success_indicators': [
                    'Capability list retrieved',
                    'Authentication methods shown (LOGIN, PLAIN, NTLM, etc.)',
                    'Extensions listed (IDLE, NAMESPACE, SORT, etc.)',
                    'IMAP protocol version identified'
                ],
                'failure_indicators': [
                    'Script failed',
                    'Connection refused',
                    'No capabilities returned',
                    'STARTTLS required but failed'
                ],
                'next_steps': [
                    'Identify authentication methods (PLAIN, LOGIN, NTLM)',
                    'Note if plaintext auth allowed (security issue)',
                    'Check for STARTTLS support',
                    'Proceed with credential testing'
                ],
                'alternatives': [
                    f'''Manual via nc:
nc {target} {port}
A1 CAPABILITY
(Server responds with capability list)''',
                    f'openssl s_client -connect {target}:{port} -quiet (if SSL)'
                ],
                'notes': '''
IMAP Capabilities Defined by RFC 3501:
- IMAP4rev1: Protocol version
- LOGIN: Username/password authentication
- AUTH=PLAIN: Base64 encoded plaintext auth
- AUTH=LOGIN: Base64 LOGIN method
- AUTH=NTLM: NTLM authentication (Windows)
- STARTTLS: TLS upgrade support
- IDLE: Server push notifications
- NAMESPACE: Mailbox namespace
- LITERAL+: Large data uploads
- SORT: Server-side sorting
'''
            }
        })

        # Task 3: NTLM Information Disclosure (Windows servers)
        if 'windows' in version.lower() or 'microsoft' in version.lower() or 'exchange' in version.lower():
            tasks['children'].append({
                'id': f'ntlm-info-{port}',
                'name': 'NTLM Authentication Info Disclosure',
                'type': 'parent',
                'children': [
                    {
                        'id': f'ntlm-manual-{port}',
                        'name': 'NTLM Info (Manual)',
                        'type': 'manual',
                        'metadata': {
                            'description': 'Extract internal information via NTLM authentication headers',
                            'tags': ['OSCP:HIGH', 'MANUAL', 'WINDOWS'],
                            'notes': f'''
Windows IMAP servers (Exchange, IIS) supporting NTLM leak internal information in auth headers:
- Internal hostname
- Domain name
- Windows version

Manual Steps:
1. Connect: telnet {target} {port}  OR  openssl s_client -connect {target}:{port} -quiet
2. Wait for * OK banner
3. Type: A1 AUTHENTICATE NTLM
4. Server responds with: +  (ready for NTLM exchange)
5. Type: TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
   (This is NTLM Type 1 message: base64 of NTLMSSP negotiate)
6. Server responds with Base64 NTLM Type 2 Challenge containing version info
7. Decode Base64 response to see internal hostname, domain, Windows version

Example:
$ telnet {target} {port}
* OK The Microsoft Exchange IMAP4 service is ready.
A1 AUTHENTICATE NTLM
+
TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAA<long base64>
(Decode this to extract info)

Success: Internal hostname/domain/version disclosed
Failure: AUTH NTLM not supported, authentication required, connection closed

Why This Works:
NTLM Type 2 challenge response contains:
- NetBIOS domain name
- NetBIOS computer name
- DNS domain name
- DNS hostname
- Windows version (major.minor.build)

Server sends this BEFORE authentication completes. No valid credentials needed!

Next Steps:
- Document exact Windows version for exploit research
- Note internal hostname for DNS/network recon
- Use domain name for AD enumeration
- Test hostname on other services (SMB, RDP)
''',
                            'success_indicators': [
                                '+ (NTLM supported)',
                                'Base64 challenge response returned',
                                'Internal hostname visible after decoding',
                                'Domain name disclosed'
                            ],
                            'failure_indicators': [
                                'AUTH NTLM not supported',
                                'A1 NO AUTHENTICATE failed',
                                'Connection closed',
                                'No NTLM in CAPABILITY list'
                            ]
                        }
                    },
                    {
                        'id': f'ntlm-nmap-{port}',
                        'name': 'NTLM Info (Automated)',
                        'type': 'command',
                        'metadata': {
                            'command': f'nmap -p{port} --script imap-ntlm-info {target}',
                            'description': 'Automated NTLM information extraction via nmap NSE',
                            'tags': ['OSCP:HIGH', 'AUTOMATED', 'QUICK_WIN', 'WINDOWS'],
                            'flag_explanations': {
                                f'-p{port}': f'Target port {port}',
                                '--script imap-ntlm-info': 'NSE script to extract NTLM info disclosure'
                            },
                            'success_indicators': [
                                'NetBIOS_Domain_Name disclosed',
                                'NetBIOS_Computer_Name disclosed',
                                'DNS_Domain_Name disclosed',
                                'DNS_Computer_Name disclosed',
                                'Windows version revealed'
                            ],
                            'failure_indicators': [
                                'NTLM not supported',
                                'Script failed',
                                'No info disclosed',
                                'Authentication required'
                            ],
                            'next_steps': [
                                'Research Windows version for exploits (searchsploit)',
                                'Use domain info for AD enumeration',
                                'Check internal hostname for other services',
                                'Cross-reference with SMTP/POP3 NTLM info'
                            ],
                            'alternatives': [
                                'Manual method (see NTLM Info Manual task)',
                                'Metasploit: auxiliary/scanner/imap/imap_version'
                            ],
                            'notes': 'Works on Exchange and Windows IMAP servers. Information leaked before authentication completes.'
                        }
                    }
                ]
            })

        # Task 4: Credential Testing
        tasks['children'].append({
            'id': f'credential-test-{port}',
            'name': 'Credential Testing',
            'type': 'parent',
            'children': [
                {
                    'id': f'default-creds-{port}',
                    'name': 'Test Default Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test common default IMAP credentials (manual quick wins)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'QUICK_WIN'],
                        'notes': f'''
Test Common Default Credentials First (Quick Wins):

Manual Test:
nc {target} {port}  OR  openssl s_client -connect {target}:{port} -quiet
A1 LOGIN username password
(Success: A1 OK LOGIN Ok, Failure: A1 NO LOGIN failed)

Default Combinations to Try:
admin:admin
admin:password
administrator:administrator
root:root
test:test
user:user
imap:imap

Organization-Specific:
- Company name as username/password
- admin:CompanyName123
- firstname.lastname:Password123

Service-Specific:
- dovecot:dovecot
- postmaster:postmaster
- webmail:webmail

Why Default Creds:
- Admins forget to change defaults
- Test/dev servers deployed to production
- Legacy systems with unchanged passwords
- Quick win before brute-force

Success Indicators:
A1 OK LOGIN completed
A1 OK [CAPABILITY ...] logged in
A1 OK Logged in

Failure Indicators:
A1 NO LOGIN failed
A1 NO [AUTHENTICATIONFAILED] Authentication failed
Connection closed

Next Steps if Successful:
1. List mailboxes: A2 LIST "" "*"
2. Select inbox: A3 SELECT INBOX
3. List messages: A4 FETCH 1:* (FLAGS)
4. Read emails: A5 FETCH 1 BODY[TEXT]
5. Search for sensitive keywords: A6 SEARCH TEXT "password"

OSCP TIP:
Always try default credentials BEFORE brute-force. Saves time, less noisy.
''',
                        'success_indicators': [
                            'LOGIN OK',
                            'Authentication successful',
                            'Mailbox access granted'
                        ],
                        'failure_indicators': [
                            'LOGIN failed',
                            'Invalid credentials',
                            'Account locked',
                            'Authentication required'
                        ],
                        'alternatives': [
                            f'curl -k "imap://{target}/" --user admin:admin',
                            'Evolution GUI mail client',
                            'Thunderbird with manual IMAP setup'
                        ]
                    }
                },
                {
                    'id': f'found-creds-{port}',
                    'name': 'Test Previously Found Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test credentials discovered elsewhere (credential reuse is common)',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'notes': f'''
CREDENTIAL REUSE TESTING:

If you've found credentials from:
- SMB enumeration (smbclient, enum4linux)
- Web application exploitation
- SQL injection
- FTP anonymous access
- SSH password found
- Default credentials on other services
- Password spray results
- Web form brute-force

→ TEST THEM ON IMAP!

Why:
- Users reuse passwords across services
- Same credentials for email, SMB, SSH common
- Admins use consistent passwords
- Email access reveals MORE credentials

Email Content Often Contains:
- Additional username/password pairs
- VPN configuration files
- Network diagrams
- Confidential data (PII, financial)
- API keys, tokens
- Reset password links (hijackable)

Testing Method:
curl -k 'imap://{target}/' --user username:password
(Lists mailboxes if successful)

Read First Email:
curl -k 'imap://{target}/INBOX;MAILINDEX=1' --user username:password

Search for Keywords:
curl -k 'imap://{target}/INBOX?TEXT password' --user username:password

Interactive Access:
nc {target} {port}
A1 LOGIN username password
A2 LIST "" "*"
A3 SELECT INBOX
A4 FETCH 1:* (BODY[HEADER.FIELDS (FROM SUBJECT DATE)])
A5 FETCH 1 BODY[TEXT]

Mailboxes to Check:
- INBOX (incoming mail)
- Drafts (saved passwords, unsent messages)
- Sent Items (outgoing communications)
- Trash (deleted but recoverable)
- Archives (old but valuable)

Keywords to Search:
- password
- credentials
- username
- admin
- vpn
- ssh
- key
- secret
- confidential

OSCP EXAM TIP:
Email access can chain attacks. Found web admin creds → Check email → Find SSH keys → Privilege escalation.

Always document source of credentials in OSCP report!
Example: "Credentials obtained from HTTP POST to /login.php used successfully on IMAP port 143"
''',
                        'success_indicators': [
                            'LOGIN successful',
                            'Mailbox list retrieved',
                            'Emails readable',
                            'Additional credentials found in emails'
                        ],
                        'failure_indicators': [
                            'Authentication failed',
                            'Account locked after attempts',
                            'Credentials invalid on this service'
                        ],
                        'alternatives': [
                            'Evolution mail client (GUI - user friendly)',
                            'Thunderbird IMAP setup',
                            'mutt command-line mail client'
                        ]
                    }
                }
            ]
        })

        # Task 5: Brute-force Attack
        tasks['children'].append({
            'id': f'imap-bruteforce-{port}',
            'name': 'Credential Brute-force',
            'type': 'parent',
            'children': [
                {
                    'id': f'imap-bruteforce-nmap-{port}',
                    'name': 'Brute-force (Nmap)',
                    'type': 'command',
                    'metadata': {
                        'command': f'nmap -p{port} --script imap-brute --script-args userdb=/usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt,passdb=/usr/share/wordlists/rockyou.txt {target}',
                        'description': 'Brute-force IMAP authentication with nmap NSE script',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'NOISY'],
                        'flag_explanations': {
                            f'-p{port}': f'Target port {port}',
                            '--script imap-brute': 'NSE brute-force script for IMAP',
                            '--script-args userdb=': 'Custom username wordlist path',
                            '--script-args passdb=': 'Custom password wordlist path'
                        },
                        'success_indicators': [
                            'Valid credentials found',
                            '[143][imap] host: X login: Y password: Z',
                            'Account credentials listed in output',
                            'Statistics show successful attempts'
                        ],
                        'failure_indicators': [
                            'All login attempts failed',
                            'Account lockout triggered',
                            'Connection rate-limited',
                            'No accounts discovered'
                        ],
                        'next_steps': [
                            'Document discovered credentials',
                            'Test credentials on other services (SMTP, POP3, SSH, SMB)',
                            'Access mailboxes to read emails',
                            'Search emails for additional credentials',
                            'Check for sensitive data in email content'
                        ],
                        'alternatives': [
                            f'hydra -L users.txt -P passwords.txt {target} imap -s {port}',
                            f'medusa -h {target} -U users.txt -P passwords.txt -M imap',
                            'Metasploit: auxiliary/scanner/imap/imap_login'
                        ],
                        'notes': '''
Nmap imap-brute Script Details (from Nmap Cookbook Chapter 6):

Authentication Methods Supported:
- LOGIN (most common)
- PLAIN (Base64 encoded)
- CRAM-MD5 (challenge-response)
- DIGEST-MD5 (challenge-response)
- NTLM (Windows)

Default Wordlists:
- /nselib/data/usernames.lst
- /nselib/data/passwords.lst

Script Arguments:
- brute.mode=user (test all passwords per user)
- brute.mode=pass (test all users per password - better for avoiding lockout)
- brute.firstOnly (stop after first valid account)
- unpwdb.timelimit=60m (set timeout)

Performance Tips:
- Use small, targeted wordlists
- Start with top-usernames-shortlist.txt (20 common names)
- Use organization-specific passwords (Company123, etc.)
- Password spray (one password, all users) to avoid lockout

OSCP EXAM:
- Brute-force is time-consuming (10-30 minutes)
- Try default credentials first
- Try discovered credentials first
- Only brute-force if other methods fail
- Document time spent for exam time management
''',
                        'time_estimate': '10-30 minutes (depending on wordlist size)'
                    }
                },
                {
                    'id': f'imap-bruteforce-hydra-{port}',
                    'name': 'Brute-force (Hydra)',
                    'type': 'command',
                    'metadata': {
                        'command': f'hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/wordlists/rockyou.txt {target} imap -s {port} -t 4 -V',
                        'description': 'Brute-force IMAP credentials using Hydra (faster than nmap)',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'NOISY'],
                        'flag_explanations': {
                            '-L': 'Username wordlist path',
                            '-P': 'Password wordlist path',
                            'imap': 'Protocol/service to attack',
                            f'-s {port}': f'Service port {port}',
                            '-t 4': 'Parallel tasks (4 threads - not too aggressive)',
                            '-V': 'Verbose output (show each attempt)'
                        },
                        'success_indicators': [
                            '[143][imap] host: X login: Y password: Z',
                            'Valid credentials found',
                            'Login successful message'
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Account lockout',
                            'Connection rate-limited',
                            'Too slow (wordlist too large)'
                        ],
                        'next_steps': [
                            'Save discovered credentials',
                            'Test on other services (SMTP, POP3, SSH, HTTP)',
                            'Read user emails for intelligence',
                            'Search emails for additional credentials'
                        ],
                        'alternatives': [
                            f'nmap --script imap-brute {target} -p{port}',
                            f'medusa -h {target} -U users.txt -P passwords.txt -M imap',
                            'Metasploit: auxiliary/scanner/imap/imap_login'
                        ],
                        'notes': '''
Hydra is faster than nmap for brute-force but less stealthy.

Smart Brute-force Strategy:
1. Password Spray (avoid lockout):
   hydra -L users.txt -p Password123 {target} imap
   (Test one password across all users)

2. Common Passwords First:
   hydra -L users.txt -P /usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-100.txt {target} imap

3. Targeted Attack (discovered username):
   hydra -l admin -P rockyou.txt {target} imap

Performance:
- -t 4: 4 parallel tasks (safe, won't trigger defenses)
- -t 16: 16 tasks (faster, may trigger lockout)
- -t 64: 64 tasks (very fast, will trigger defenses)

OSCP EXAM:
- Only if other methods fail (time-consuming)
- Document attempts in report
- Show manual alternatives you tried first
''',
                        'time_estimate': '15-45 minutes'
                    }
                }
            ]
        })

        # Task 6: Mailbox Enumeration (Post-Access)
        tasks['children'].append({
            'id': f'mailbox-enum-{port}',
            'name': 'Mailbox Enumeration (Post-Authentication)',
            'type': 'manual',
            'metadata': {
                'description': 'Enumerate mailboxes and read emails after successful authentication',
                'tags': ['OSCP:HIGH', 'MANUAL', 'POST_EXPLOIT'],
                'notes': f'''
MAILBOX ENUMERATION (After Successful Login):

Connection:
nc {target} {port}
OR
openssl s_client -connect {target}:{port} -quiet

Commands:
A1 LOGIN username password
A2 LIST "" "*"                          (List all mailboxes)
A3 SELECT INBOX                         (Open inbox)
A4 STATUS INBOX (MESSAGES UNSEEN)       (Count messages)
A5 FETCH 1:* (FLAGS)                    (List all messages with flags)
A6 FETCH 1 BODY[HEADER]                 (Read message 1 headers)
A7 FETCH 1 BODY[TEXT]                   (Read message 1 body)
A8 SEARCH TEXT "password"               (Search for keyword)
A9 SEARCH FROM "admin"                  (Search by sender)
A10 LOGOUT

Common Mailboxes:
- INBOX (incoming mail)
- Drafts (unsent messages - often contain credentials)
- Sent (outgoing mail - shows communication patterns)
- Trash (deleted but recoverable)
- Archive (old but valuable)
- Junk (spam - sometimes important)

Keywords to Search:
- password
- credentials
- admin
- secret
- confidential
- vpn
- ssh
- key
- root
- backup
- database

Curl Commands (Easier):
curl -k 'imap://{target}/' --user username:password
(Lists mailboxes)

curl -k 'imap://{target}/INBOX;MAILINDEX=1' --user username:password
(Reads first email)

curl -k 'imap://{target}/INBOX?TEXT password' --user username:password
(Searches for "password")

curl -k 'imap://{target}/INBOX?FROM admin' --user username:password
(Searches for emails from admin)

GUI Alternatives:
1. Evolution (user-friendly):
   evolution
   (Add account: {target}, IMAP, username, password)

2. Thunderbird:
   thunderbird
   (Manual account setup)

3. mutt (terminal-based):
   mutt -f imap://username@{target}

What to Look For in Emails:
- Plain-text passwords (users send credentials via email!)
- Attachments with credentials (.txt, .xlsx, .doc)
- VPN configurations
- SSH keys (id_rsa.pub, private keys)
- API keys and tokens
- Password reset links (can be replayed)
- Network diagrams and documentation
- Confidential business data

OSCP EXAM TIP:
- Email access often provides credentials for other services
- Always check Drafts folder (users save credentials there)
- Search for organization name (e.g., "OSCP Labs password")
- Document email sources properly for report
- Screenshot relevant emails as proof

Example Finding Documentation:
"Email enumeration on IMAP port 143 using credentials admin:password (discovered via SMB enumeration) revealed SSH private key in Drafts folder. Key used for privilege escalation on target 192.168.45.200."
''',
                'success_indicators': [
                    'Mailbox list retrieved',
                    'Emails readable',
                    'Sensitive data found in emails',
                    'Additional credentials discovered'
                ],
                'failure_indicators': [
                    'Authentication failed',
                    'Mailboxes empty',
                    'No sensitive data found',
                    'Connection timeout'
                ],
                'alternatives': [
                    'Evolution GUI (apt install evolution)',
                    'Thunderbird mail client',
                    'curl IMAP commands (as shown above)',
                    'mutt terminal client'
                ]
            }
        })

        # Task 7: SSL/TLS Certificate Analysis (if SSL)
        if is_ssl or port == 993:
            tasks['children'].append({
                'id': f'ssl-cert-analysis-{port}',
                'name': 'SSL/TLS Certificate Analysis',
                'type': 'command',
                'metadata': {
                    'command': f'nmap -p{port} --script ssl-cert {target}',
                    'description': 'Analyze SSL/TLS certificate for internal hostnames and misconfigurations',
                    'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'RECON'],
                    'flag_explanations': {
                        f'-p{port}': f'Target port {port} (IMAPS)',
                        '--script ssl-cert': 'NSE script to extract and analyze SSL certificate'
                    },
                    'success_indicators': [
                        'Certificate details retrieved',
                        'Subject CN (Common Name) shown',
                        'SubjectAltName with hostnames',
                        'Internal hostnames leaked',
                        'Organization info disclosed'
                    ],
                    'failure_indicators': [
                        'Certificate validation failed',
                        'Self-signed certificate warning',
                        'Expired certificate',
                        'No certificate found'
                    ],
                    'next_steps': [
                        'Document internal hostnames (CN, SANs)',
                        'Test hostnames on other services',
                        'Check for certificate vulnerabilities',
                        'Note organization name for OSINT'
                    ],
                    'alternatives': [
                        f'openssl s_client -connect {target}:{port} -showcerts',
                        f'nmap -p{port} --script ssl-cert,ssl-enum-ciphers {target}',
                        'SSLyze tool: sslyze --regular {target}:{port}'
                    ],
                    'notes': '''
SSL Certificate Information Leakage:

Common Findings:
- Subject CN: mail.internal.company.local (internal hostname!)
- SubjectAltName: webmail.company.com, mail.company.com, smtp.company.com
- Organization: Company Inc.
- Location: City, State, Country

Why Important:
- Internal hostnames not visible externally
- SANs reveal all services using certificate
- Self-signed certs indicate dev/test environments
- Expired certs show poor security practices

Certificate Vulnerabilities:
- SSLv2/SSLv3 enabled (POODLE, DROWN)
- Weak ciphers (RC4, DES, 3DES)
- Heartbleed (OpenSSL < 1.0.1g)
- Certificate pinning bypass
- Name mismatch attacks

OSCP TIP:
Internal hostnames from certificates can be added to /etc/hosts and tested directly.
'''
                }
            })

        # Task 8: Exploit Research (if version detected)
        if version:
            tasks['children'].append({
                'id': f'exploit-research-{port}',
                'name': f'Exploit Research: {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-imap-{port}',
                        'name': f'SearchSploit: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit {version}',
                            'description': 'Search ExploitDB for known IMAP vulnerabilities',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'success_indicators': [
                                'Exploits found for version',
                                'CVE numbers identified',
                                'PoC code available'
                            ],
                            'failure_indicators': [
                                'No exploits found',
                                'Version too new/old',
                                'Search returned unrelated results'
                            ],
                            'next_steps': [
                                'Review exploit code for applicability',
                                'Check exploit prerequisites',
                                'Test PoC in safe environment',
                                'Read exploit documentation'
                            ],
                            'alternatives': [
                                f'searchsploit {product}',
                                'Google: "{version} exploit"',
                                'exploit-db.com web search'
                            ]
                        }
                    },
                    {
                        'id': f'cve-lookup-imap-{port}',
                        'name': f'CVE Lookup: {version}',
                        'type': 'manual',
                        'metadata': {
                            'description': 'Search CVE databases for version-specific vulnerabilities',
                            'tags': ['RESEARCH', 'OSCP:HIGH'],
                            'notes': f'''
Research {version} vulnerabilities:

CVE Databases:
- cve.mitre.org
- nvd.nist.gov (National Vulnerability Database)
- cvedetails.com

Search Terms:
- "{version} vulnerability"
- "{product} exploit"
- "{version} CVE"

GitHub:
- github.com/search?q={version}+exploit
- github.com/search?q={product}+vulnerability

Known Vulnerable IMAP Servers:
- Dovecot < 2.3.16 (multiple CVEs)
- Courier-IMAP < 5.0.5 (CVEs)
- UW-IMAP (legacy, many vulnerabilities)
- Cyrus IMAP < 3.4.0 (CVEs)

Common IMAP Vulnerabilities:
- Buffer overflows (remote code execution)
- Authentication bypass
- Directory traversal (read arbitrary files)
- Format string vulnerabilities
- Denial of service

OSCP-Relevant CVEs:
- Dovecot: CVE-2019-11500 (STARTTLS auth bypass)
- Cyrus IMAP: CVE-2019-19783 (buffer overflow)
- Courier-IMAP: CVE-2018-12550 (format string)

Next Steps:
- Download PoC exploits
- Verify version exact match
- Test in isolated environment first
- Document exploit path for report
''',
                            'success_indicators': [
                                'CVE found for exact version',
                                'Exploit code available',
                                'Vulnerability confirmed applicable'
                            ]
                        }
                    }
                ]
            })

        return tasks
