"""
POP3 service enumeration plugin

Generates comprehensive tasks for POP3 enumeration including:
- Banner grabbing and capability enumeration (110, 995)
- NTLM authentication information disclosure (Windows servers)
- Credential testing and brute-force
- Email retrieval and post-authentication access

Extracted from Nmap Cookbook Chapter 6:
- Brute forcing POP3 passwords recipe
- Retrieving the capabilities of a POP3 mail server recipe

Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class POP3Plugin(ServicePlugin):
    """POP3 enumeration plugin"""

    @property
    def name(self) -> str:
        return "pop3"

    @property
    def default_ports(self) -> List[int]:
        return [110, 995]

    @property
    def service_names(self) -> List[str]:
        return ['pop3', 'pop3s', 'spop3']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect POP3 services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate POP3 enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', '')
        is_ssl = port == 995 or 'ssl' in service_info.get('service', '').lower()

        tasks = {
            'id': f'pop3-enum-{port}',
            'name': f'POP3 Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # Task 1: Banner Grabbing and Capability Enumeration
        if is_ssl:
            # Port 995 (POP3S - SSL/TLS)
            tasks['children'].append({
                'id': f'banner-grab-{port}',
                'name': 'Banner Grabbing (POP3S SSL/TLS)',
                'type': 'command',
                'metadata': {
                    'command': f'openssl s_client -connect {target}:{port} -quiet',
                    'description': 'Connect to POP3S over SSL/TLS and grab banner',
                    'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                    'flag_explanations': {
                        's_client': 'OpenSSL SSL/TLS client tool',
                        '-connect': f'Connect to {target}:{port}',
                        '-quiet': 'Suppress verbose SSL handshake output'
                    },
                    'success_indicators': [
                        'SSL handshake successful',
                        '+OK banner received',
                        'Server name and version displayed',
                        'POP3 server ready message'
                    ],
                    'failure_indicators': [
                        'SSL handshake failed',
                        'Connection refused',
                        'Wrong SSL/TLS version',
                        'Certificate verification failed'
                    ],
                    'next_steps': [
                        'Note POP3 server software and version',
                        'Check certificate for internal hostnames',
                        'Test POP3 commands (USER, PASS, STAT, LIST)',
                        'Try NTLM info disclosure if Windows server'
                    ],
                    'alternatives': [
                        f'nmap -p{port} -sV --script ssl-cert {target}',
                        f'nmap -p{port} --script pop3-capabilities {target}',
                        f'telnet {target} {port} # May fail without SSL'
                    ],
                    'notes': 'Port 995 uses implicit SSL/TLS. Certificate may leak internal server names.',
                    'time_estimate': '10-30 seconds'
                }
            })
        else:
            # Port 110 (POP3 plaintext)
            tasks['children'].append({
                'id': f'banner-grab-{port}',
                'name': 'Banner Grabbing (POP3 plaintext)',
                'type': 'command',
                'metadata': {
                    'command': f'nc -vn {target} {port}',
                    'description': 'Connect to POP3 server and grab banner (reveals version and server type)',
                    'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                    'flag_explanations': {
                        '-v': 'Verbose output (shows connection details)',
                        '-n': 'Numeric IP addresses only (no DNS resolution)',
                        f'{port}': f'Target POP3 port {port}'
                    },
                    'success_indicators': [
                        '+OK response (service ready)',
                        'Server software name visible (Dovecot, Courier, Exchange, qpopper)',
                        'Version number in banner',
                        'Connection successful'
                    ],
                    'failure_indicators': [
                        'Connection refused',
                        'Connection timeout',
                        'No banner received',
                        'STLS required (upgrade to TLS needed)'
                    ],
                    'next_steps': [
                        'Note server software for exploit research',
                        'Test USER/PASS authentication',
                        'Try default credentials',
                        'Test NTLM info disclosure if Windows'
                    ],
                    'alternatives': [
                        f'telnet {target} {port}',
                        f'nmap -p{port} -sV {target}',
                        f'nmap -p{port} --script pop3-capabilities {target}'
                    ],
                    'notes': 'Banner often reveals: Dovecot, qpopper, Courier, Exchange, Cyrus POP3. Critical for vulnerability research.',
                    'time_estimate': '10-30 seconds'
                }
            })

        # Task 2: Capability Enumeration (Automated)
        tasks['children'].append({
            'id': f'capabilities-{port}',
            'name': 'Capability Enumeration',
            'type': 'command',
            'metadata': {
                'command': f'nmap -p{port} --script pop3-capabilities {target}',
                'description': 'Enumerate POP3 server capabilities (AUTH methods, commands, extensions)',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'AUTOMATED'],
                'flag_explanations': {
                    f'-p{port}': f'Target port {port}',
                    '--script pop3-capabilities': 'NSE script to query CAPA command'
                },
                'success_indicators': [
                    'Capability list retrieved',
                    'Authentication methods shown (USER, SASL, etc.)',
                    'Extensions listed (TOP, UIDL, PIPELINING)',
                    'Server info disclosed'
                ],
                'failure_indicators': [
                    'Script failed',
                    'Connection refused',
                    'No capabilities returned',
                    'STLS required but failed'
                ],
                'next_steps': [
                    'Identify authentication methods',
                    'Check for STLS support (TLS upgrade)',
                    'Note if plaintext auth allowed (security issue)',
                    'Proceed with credential testing'
                ],
                'alternatives': [
                    f'''Manual via nc:
nc {target} {port}
CAPA
(Server responds with capability list)''',
                    f'openssl s_client -connect {target}:{port} -quiet (if SSL), then CAPA'
                ],
                'notes': '''
POP3 Capabilities (RFC 2449):
- USER: Username/password authentication
- SASL: SASL authentication mechanisms
- RESP-CODES: Extended response codes
- LOGIN-DELAY: Minimum seconds between login attempts
- PIPELINING: Multiple commands in one request
- TOP: Retrieve message headers + n lines
- UIDL: Unique ID listing
- IMPLEMENTATION: Server software info
- STLS: STARTTLS for TLS upgrade
'''
            }
        })

        # Task 3: NTLM Information Disclosure (Windows servers)
        if 'windows' in version.lower() or 'microsoft' in version.lower() or 'exchange' in version.lower():
            tasks['children'].append({
                'id': f'ntlm-info-{port}',
                'name': 'NTLM Authentication Info Disclosure',
                'type': 'parent',
                'children': [
                    {
                        'id': f'ntlm-manual-{port}',
                        'name': 'NTLM Info (Manual)',
                        'type': 'manual',
                        'metadata': {
                            'description': 'Extract internal information via NTLM authentication headers',
                            'tags': ['OSCP:HIGH', 'MANUAL', 'WINDOWS'],
                            'notes': f'''
Windows POP3 servers (Exchange) supporting NTLM leak internal information:
- Internal hostname
- Domain name
- Windows version

Manual Steps:
1. Connect: telnet {target} {port}  OR  openssl s_client -connect {target}:{port} -quiet
2. Wait for +OK banner
3. Type: AUTH NTLM
4. Server responds with: +  (ready for NTLM exchange)
5. Type: TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
   (This is NTLM Type 1 message: base64 of NTLMSSP negotiate)
6. Server responds with: + <base64-challenge>
   (NTLM Type 2 Challenge containing version info)
7. Decode Base64 response to extract internal hostname, domain, Windows version

Example:
$ telnet {target} {port}
+OK Microsoft Exchange POP3 server ready.
AUTH NTLM
+
TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAA<long base64 challenge>
(Decode this to extract info)

Decoding:
echo "TlRMTVNTUAACAAAA..." | base64 -d | hexdump -C
OR use ntlm-info Python script

Success: Internal hostname/domain/version disclosed
Failure: AUTH NTLM not supported, connection closed

Why This Works:
NTLM Type 2 challenge contains:
- NetBIOS domain name
- NetBIOS computer name
- DNS domain name
- DNS hostname
- Windows version (major.minor.build)

Server sends this BEFORE authentication. No valid credentials needed!

Next Steps:
- Document exact Windows version for exploit research
- Note internal hostname for DNS/network recon
- Use domain name for AD enumeration
- Test hostname on other services (SMB, RDP, IMAP, SMTP)
''',
                            'success_indicators': [
                                '+ (NTLM supported)',
                                'Base64 challenge response returned',
                                'Internal hostname visible after decoding',
                                'Domain name disclosed'
                            ],
                            'failure_indicators': [
                                'AUTH NTLM not supported',
                                '-ERR Authentication method not supported',
                                'Connection closed',
                                'No NTLM in CAPA list'
                            ]
                        }
                    },
                    {
                        'id': f'ntlm-nmap-{port}',
                        'name': 'NTLM Info (Automated)',
                        'type': 'command',
                        'metadata': {
                            'command': f'nmap -p{port} --script pop3-ntlm-info {target}',
                            'description': 'Automated NTLM information extraction via nmap NSE',
                            'tags': ['OSCP:HIGH', 'AUTOMATED', 'QUICK_WIN', 'WINDOWS'],
                            'flag_explanations': {
                                f'-p{port}': f'Target port {port}',
                                '--script pop3-ntlm-info': 'NSE script to extract NTLM info disclosure'
                            },
                            'success_indicators': [
                                'NetBIOS_Domain_Name disclosed',
                                'NetBIOS_Computer_Name disclosed',
                                'DNS_Domain_Name disclosed',
                                'DNS_Computer_Name disclosed',
                                'Windows version revealed'
                            ],
                            'failure_indicators': [
                                'NTLM not supported',
                                'Script failed',
                                'No info disclosed',
                                'Authentication required'
                            ],
                            'next_steps': [
                                'Research Windows version for exploits (searchsploit)',
                                'Use domain info for AD enumeration',
                                'Check internal hostname for other services',
                                'Cross-reference with SMTP/IMAP NTLM info'
                            ],
                            'alternatives': [
                                'Manual method (see NTLM Info Manual task)',
                                'Metasploit: auxiliary/scanner/pop3/pop3_version'
                            ],
                            'notes': 'Works on Exchange and Windows POP3 servers. Information leaked before authentication completes.'
                        }
                    }
                ]
            })

        # Task 4: Credential Testing
        tasks['children'].append({
            'id': f'credential-test-{port}',
            'name': 'Credential Testing',
            'type': 'parent',
            'children': [
                {
                    'id': f'default-creds-{port}',
                    'name': 'Test Default Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test common default POP3 credentials (manual quick wins)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'QUICK_WIN'],
                        'notes': f'''
Test Common Default Credentials First (Quick Wins):

Manual Test:
nc {target} {port}  OR  openssl s_client -connect {target}:{port} -quiet
USER username
PASS password
(Success: +OK Logged in, Failure: -ERR Authentication failed)

Example Session:
+OK POP3 server ready
USER admin
+OK
PASS admin
+OK Logged in
STAT
+OK 5 12345  (5 messages, 12345 bytes total)

Default Combinations to Try:
admin:admin
admin:password
administrator:administrator
root:root
test:test
user:user
postmaster:postmaster

Organization-Specific:
- Company name as username/password
- admin:CompanyName123
- firstname.lastname:Password123

Why Default Creds:
- Admins forget to change defaults
- Test/dev servers deployed to production
- Legacy systems with unchanged passwords
- Quick win before brute-force

Success Indicators:
+OK Logged in
+OK Welcome
+OK Authentication successful

Failure Indicators:
-ERR Authentication failed
-ERR Invalid login
-ERR [AUTH] Authentication failed

Next Steps if Successful:
1. List messages: STAT (count and size)
2. List all: LIST (message numbers and sizes)
3. Retrieve message 1: RETR 1
4. Retrieve headers only: TOP 1 0
5. Get unique IDs: UIDL
6. Delete message: DELE 1 (careful!)
7. Logout: QUIT

OSCP TIP:
Always try default credentials BEFORE brute-force. Saves time, less noisy.
POP3 downloads and deletes by default - be careful not to delete victim's mail!
''',
                        'success_indicators': [
                            '+OK Logged in',
                            'Authentication successful',
                            'Mail access granted'
                        ],
                        'failure_indicators': [
                            '-ERR Authentication failed',
                            'Invalid credentials',
                            'Account locked',
                            'Too many failed attempts'
                        ],
                        'alternatives': [
                            f'Manual: telnet {target} {port}, then USER/PASS',
                            'curl pop3://admin:admin@{target}/ --list-only',
                            'Evolution GUI mail client'
                        ]
                    }
                },
                {
                    'id': f'found-creds-{port}',
                    'name': 'Test Previously Found Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test credentials discovered elsewhere (credential reuse is common)',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'notes': f'''
CREDENTIAL REUSE TESTING:

If you've found credentials from:
- SMB enumeration (smbclient, enum4linux)
- Web application exploitation
- SQL injection
- FTP, SSH, IMAP (test on POP3 too!)
- Default credentials on other services
- Password spray results

→ TEST THEM ON POP3!

Why:
- Users reuse passwords across services
- Same credentials for email, SMB, SSH common
- Email access reveals MORE credentials
- POP3 often overlooked by admins (weak passwords)

POP3 vs IMAP:
- POP3: Downloads and (often) deletes emails from server
- IMAP: Keeps emails on server, syncs across devices
- Both may use same credentials
- If IMAP found, try those creds on POP3 (and vice versa)

Testing Method:
nc {target} {port}
USER username
PASS password
STAT
LIST
RETR 1  (retrieve first email)
QUIT

Safer Testing (doesn't delete):
1. Connect and auth (USER/PASS)
2. Use TOP instead of RETR:
   TOP 1 0  (headers only)
   TOP 1 10 (headers + 10 lines)
3. Use UIDL to get message IDs (track what exists)
4. Don't use DELE (delete command)

Email Content Often Contains:
- Additional credentials
- VPN configurations
- SSH keys
- API tokens
- Password reset links
- Confidential data

OSCP EXAM TIP:
- Email access can chain attacks
- Found web creds → Check email → Find SSH keys → Privilege escalation
- Always document credential source in OSCP report

Example Documentation:
"Credentials obtained from HTTP POST to /login.php (admin:password123) used successfully on POP3 port 110. Email #3 contained SSH private key for user 'root' on target 192.168.45.200."

WARNING:
POP3 clients often DELETE emails after retrieval (default behavior).
Use TOP command instead of RETR to read without deleting.
Or use IMAP if available (keeps emails on server).
''',
                        'success_indicators': [
                            '+OK Logged in',
                            'Mail list retrieved',
                            'Emails readable',
                            'Additional credentials found in emails'
                        ],
                        'failure_indicators': [
                            'Authentication failed',
                            'Account locked',
                            'Credentials invalid on this service'
                        ],
                        'alternatives': [
                            'curl pop3://user:pass@{target}/ --list-only',
                            'Evolution mail client (GUI)',
                            'Thunderbird POP3 setup'
                        ]
                    }
                }
            ]
        })

        # Task 5: Brute-force Attack
        tasks['children'].append({
            'id': f'pop3-bruteforce-{port}',
            'name': 'Credential Brute-force',
            'type': 'parent',
            'children': [
                {
                    'id': f'pop3-bruteforce-nmap-{port}',
                    'name': 'Brute-force (Nmap)',
                    'type': 'command',
                    'metadata': {
                        'command': f'nmap -p{port} --script pop3-brute --script-args userdb=/usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt,passdb=/usr/share/wordlists/rockyou.txt {target}',
                        'description': 'Brute-force POP3 authentication with nmap NSE script',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'NOISY'],
                        'flag_explanations': {
                            f'-p{port}': f'Target port {port}',
                            '--script pop3-brute': 'NSE brute-force script for POP3',
                            '--script-args userdb=': 'Custom username wordlist path',
                            '--script-args passdb=': 'Custom password wordlist path'
                        },
                        'success_indicators': [
                            'Valid credentials found',
                            'webmaster : abc123',
                            'acc1 : password',
                            'Accounts listed in output'
                        ],
                        'failure_indicators': [
                            'All login attempts failed',
                            'Account lockout triggered',
                            'Connection rate-limited',
                            'No accounts discovered'
                        ],
                        'next_steps': [
                            'Document discovered credentials',
                            'Test credentials on other services (SMTP, IMAP, SSH, SMB)',
                            'Retrieve emails to read content',
                            'Search emails for additional credentials'
                        ],
                        'alternatives': [
                            f'hydra -L users.txt -P passwords.txt {target} pop3 -s {port}',
                            f'medusa -h {target} -U users.txt -P passwords.txt -M pop3',
                            'Metasploit: auxiliary/scanner/pop3/pop3_login'
                        ],
                        'notes': '''
Nmap pop3-brute Script Details (from Nmap Cookbook Chapter 6):

Default Wordlists:
- /nselib/data/usernames.lst
- /nselib/data/passwords.lst

Script Arguments:
- userdb=<path> (custom username list)
- passdb=<path> (custom password list)
- unpwdb.timelimit=0 (run indefinitely)
- unpwdb.timelimit=60m (set timeout)

Performance Tips:
- Use small, targeted wordlists
- Start with top-usernames-shortlist.txt (20 common names)
- Use organization-specific passwords (Company123, etc.)
- POP3 brute-force slower than other protocols

OSCP EXAM:
- Brute-force is time-consuming (10-30 minutes)
- Try default credentials first
- Try discovered credentials first
- Only brute-force if other methods fail
- Document time spent for exam time management

WARNING:
POP3 servers may rate-limit or lockout accounts after failed attempts.
''',
                        'time_estimate': '10-30 minutes (depending on wordlist size)'
                    }
                },
                {
                    'id': f'pop3-bruteforce-hydra-{port}',
                    'name': 'Brute-force (Hydra)',
                    'type': 'command',
                    'metadata': {
                        'command': f'hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/wordlists/rockyou.txt {target} pop3 -s {port} -t 4 -V',
                        'description': 'Brute-force POP3 credentials using Hydra (faster than nmap)',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'NOISY'],
                        'flag_explanations': {
                            '-L': 'Username wordlist path',
                            '-P': 'Password wordlist path',
                            'pop3': 'Protocol/service to attack',
                            f'-s {port}': f'Service port {port}',
                            '-t 4': 'Parallel tasks (4 threads - not too aggressive)',
                            '-V': 'Verbose output (show each attempt)'
                        },
                        'success_indicators': [
                            '[110][pop3] host: X login: Y password: Z',
                            'Valid credentials found',
                            'Login successful message'
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Account lockout',
                            'Connection rate-limited',
                            'Too slow (wordlist too large)'
                        ],
                        'next_steps': [
                            'Save discovered credentials',
                            'Test on other services (SMTP, IMAP, SSH, HTTP)',
                            'Retrieve and read user emails',
                            'Search emails for additional credentials'
                        ],
                        'alternatives': [
                            f'nmap --script pop3-brute {target} -p{port}',
                            f'medusa -h {target} -U users.txt -P passwords.txt -M pop3',
                            'Metasploit: auxiliary/scanner/pop3/pop3_login'
                        ],
                        'notes': '''
Hydra is faster than nmap for brute-force but less stealthy.

Smart Brute-force Strategy:
1. Password Spray (avoid lockout):
   hydra -L users.txt -p Password123 {target} pop3
   (Test one password across all users)

2. Common Passwords First:
   hydra -L users.txt -P /usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-100.txt {target} pop3

3. Targeted Attack (discovered username):
   hydra -l admin -P rockyou.txt {target} pop3

Performance:
- -t 4: 4 parallel tasks (safe, won't trigger defenses)
- -t 16: 16 tasks (faster, may trigger lockout)
- -t 64: 64 tasks (very fast, will trigger defenses)

OSCP EXAM:
- Only if other methods fail (time-consuming)
- Document attempts in report
- Show manual alternatives you tried first
''',
                        'time_estimate': '15-45 minutes'
                    }
                }
            ]
        })

        # Task 6: Email Retrieval (Post-Access)
        tasks['children'].append({
            'id': f'email-retrieval-{port}',
            'name': 'Email Retrieval (Post-Authentication)',
            'type': 'manual',
            'metadata': {
                'description': 'Retrieve and read emails after successful authentication',
                'tags': ['OSCP:HIGH', 'MANUAL', 'POST_EXPLOIT'],
                'notes': f'''
EMAIL RETRIEVAL (After Successful Login):

Connection:
nc {target} {port}
OR
openssl s_client -connect {target}:{port} -quiet

POP3 Commands:
USER username
PASS password
STAT                        (Get message count and total size)
LIST                        (List all messages with sizes)
LIST 1                      (Get size of message 1)
UIDL                        (Get unique IDs for all messages)
TOP 1 0                     (Get headers of message 1 - NO DELETE)
TOP 1 10                    (Get headers + 10 lines - NO DELETE)
RETR 1                      (Retrieve full message 1 - MAY DELETE*)
DELE 1                      (Delete message 1)
RSET                        (Undelete marked messages)
QUIT                        (Close connection, commit deletions)

*IMPORTANT: RETR behavior depends on client
- Traditional POP3: RETR + QUIT = message deleted from server
- Some servers: Message stays until DELE command
- TOP command is SAFER - reads without deleting

Example Session:
+OK POP3 server ready
USER admin
+OK
PASS password123
+OK Logged in
STAT
+OK 5 12345        (5 messages, 12345 bytes total)
LIST
+OK
1 2345
2 1234
3 3456
4 2000
5 3000
.
TOP 1 0            (Read message 1 headers ONLY - safe)
+OK
From: ceo@company.com
To: admin@company.com
Subject: VPN Access
Date: Mon, 1 Jan 2024 10:00:00 -0500

.
TOP 1 100          (Read headers + 100 lines of body)
+OK
[Full headers]

Here are the VPN credentials:
Username: vpnuser
Password: SuperSecret123!

.
QUIT
+OK Bye

Safer Retrieval (curl - doesn't delete):
curl pop3://username:password@{target}/ --list-only
(Lists messages)

curl pop3://username:password@{target}/1
(Retrieves message 1)

Keywords to Search:
- password
- credentials
- username
- admin
- secret
- vpn
- ssh
- key
- api
- token
- database
- backup

What to Look For in Emails:
- Plain-text passwords (users send credentials via email!)
- Attachments with credentials (.txt, .xlsx, .doc, .csv)
- VPN configurations
- SSH keys
- API keys and tokens
- Password reset links (can be replayed)
- Network diagrams
- Confidential business data
- Internal communications revealing structure

OSCP EXAM TIP:
- Email access often provides credentials for other services
- Document email sources properly for report
- Screenshot relevant emails as proof
- IMPORTANT: Use TOP command to avoid deleting victim's mail
- If you must use RETR, save all emails first

Example Finding Documentation:
"Email retrieval on POP3 port 110 using credentials admin:password (discovered via web form brute-force) revealed VPN credentials in email subject 'VPN Access'. Credentials used for privilege escalation on internal network segment."

WARNING:
Traditional POP3 downloads and DELETES emails from server.
- Use TOP command instead of RETR when possible
- Or connect with IMAP if available (port 143/993)
- Document that you did NOT delete victim's mail in report
''',
                'success_indicators': [
                    'Message list retrieved',
                    'Emails readable',
                    'Sensitive data found in emails',
                    'Additional credentials discovered'
                ],
                'failure_indicators': [
                    'Authentication failed',
                    'Mailbox empty',
                    'No sensitive data found',
                    'Connection timeout'
                ],
                'alternatives': [
                    'curl pop3://user:pass@{target}/ --list-only',
                    'curl pop3://user:pass@{target}/1 (retrieve message 1)',
                    'Evolution GUI (user-friendly)',
                    'Thunderbird mail client'
                ]
            }
        })

        # Task 7: SSL/TLS Certificate Analysis (if SSL)
        if is_ssl or port == 995:
            tasks['children'].append({
                'id': f'ssl-cert-analysis-{port}',
                'name': 'SSL/TLS Certificate Analysis',
                'type': 'command',
                'metadata': {
                    'command': f'nmap -p{port} --script ssl-cert {target}',
                    'description': 'Analyze SSL/TLS certificate for internal hostnames and misconfigurations',
                    'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'RECON'],
                    'flag_explanations': {
                        f'-p{port}': f'Target port {port} (POP3S)',
                        '--script ssl-cert': 'NSE script to extract and analyze SSL certificate'
                    },
                    'success_indicators': [
                        'Certificate details retrieved',
                        'Subject CN (Common Name) shown',
                        'SubjectAltName with hostnames',
                        'Internal hostnames leaked',
                        'Organization info disclosed'
                    ],
                    'failure_indicators': [
                        'Certificate validation failed',
                        'Self-signed certificate warning',
                        'Expired certificate',
                        'No certificate found'
                    ],
                    'next_steps': [
                        'Document internal hostnames (CN, SANs)',
                        'Test hostnames on other services',
                        'Check for certificate vulnerabilities',
                        'Note organization name for OSINT'
                    ],
                    'alternatives': [
                        f'openssl s_client -connect {target}:{port} -showcerts',
                        f'nmap -p{port} --script ssl-cert,ssl-enum-ciphers {target}',
                        'SSLyze tool: sslyze --regular {target}:{port}'
                    ],
                    'notes': '''
SSL Certificate Information Leakage:

Common Findings:
- Subject CN: mail.internal.company.local (internal hostname!)
- SubjectAltName: pop3.company.com, mail.company.com
- Organization: Company Inc.
- Location: City, State, Country

Why Important:
- Internal hostnames not visible externally
- SANs reveal all services using certificate
- Self-signed certs indicate dev/test environments
- Expired certs show poor security practices

OSCP TIP:
Internal hostnames from certificates can be added to /etc/hosts and tested directly.
'''
                }
            })

        # Task 8: Exploit Research (if version detected)
        if version:
            tasks['children'].append({
                'id': f'exploit-research-{port}',
                'name': f'Exploit Research: {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-pop3-{port}',
                        'name': f'SearchSploit: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit {version}',
                            'description': 'Search ExploitDB for known POP3 vulnerabilities',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'success_indicators': [
                                'Exploits found for version',
                                'CVE numbers identified',
                                'PoC code available'
                            ],
                            'failure_indicators': [
                                'No exploits found',
                                'Version too new/old',
                                'Search returned unrelated results'
                            ],
                            'next_steps': [
                                'Review exploit code for applicability',
                                'Check exploit prerequisites',
                                'Test PoC in safe environment',
                                'Read exploit documentation'
                            ],
                            'alternatives': [
                                f'searchsploit {product}',
                                'Google: "{version} exploit"',
                                'exploit-db.com web search'
                            ]
                        }
                    },
                    {
                        'id': f'cve-lookup-pop3-{port}',
                        'name': f'CVE Lookup: {version}',
                        'type': 'manual',
                        'metadata': {
                            'description': 'Search CVE databases for version-specific vulnerabilities',
                            'tags': ['RESEARCH', 'OSCP:HIGH'],
                            'notes': f'''
Research {version} vulnerabilities:

CVE Databases:
- cve.mitre.org
- nvd.nist.gov (National Vulnerability Database)
- cvedetails.com

Search Terms:
- "{version} vulnerability"
- "{product} exploit"
- "{version} CVE"

GitHub:
- github.com/search?q={version}+exploit
- github.com/search?q={product}+vulnerability

Known Vulnerable POP3 Servers:
- qpopper < 4.0.19 (multiple CVEs)
- Dovecot < 2.3.16 (CVEs)
- Courier POP3 (various vulnerabilities)
- Cyrus POP3 (buffer overflow CVEs)

Common POP3 Vulnerabilities:
- Buffer overflows (remote code execution)
- Authentication bypass
- Format string vulnerabilities
- Denial of service

OSCP-Relevant CVEs:
- qpopper: CVE-2005-1151 (buffer overflow)
- Dovecot: CVE-2019-11500 (auth bypass)
- Cyrus: CVE-2019-19783 (buffer overflow)

Next Steps:
- Download PoC exploits
- Verify version exact match
- Test in isolated environment first
- Document exploit path for report
''',
                            'success_indicators': [
                                'CVE found for exact version',
                                'Exploit code available',
                                'Vulnerability confirmed applicable'
                            ]
                        }
                    }
                ]
            })

        return tasks
