"""
iOS Testing Environment & Configuration Plugin

Generates tasks for iOS pentesting environment setup and testing operations including:
- iOS testing environment setup (Simulator, physical device, jailbreak)
- Frida installation and configuration (device + client)
- Burp Suite proxy configuration (physical device + simulator + USB)
- Basic iOS testing operations (device access, app extraction, data transfer)
- iOS security testing workflow best practices

Extracted from HackTricks: mobile-pentesting/ios-pentesting/
- ios-testing-environment.md
- frida-configuration-in-ios.md
- burp-configuration-for-ios.md
- basic-ios-testing-operations.md

Generated by: CrackPot v1.0

Note: This plugin focuses on iOS testing environment preparation and configuration.
Not network-service based; designed for manual invocation during mobile pentesting projects.
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class iOSTestingEnvironmentPlugin(ServicePlugin):
    """iOS pentesting testing environment and operations plugin"""

    @property
    def name(self) -> str:
        return "ios-testing-environment"

    @property
    def default_ports(self) -> List[int]:
        return []  # Not port-based; testing environment setup

    @property
    def service_names(self) -> List[str]:
        return ['ios-testing', 'ios-env', 'mobile-ios-setup']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """
        Detect iOS testing environment context

        This plugin does not auto-detect from network scans.
        It's designed for manual invocation during iOS testing projects.
        """
        # Manual-only plugin for iOS testing environment setup
        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate iOS testing environment setup task tree"""

        ios_version = service_info.get('version', 'unknown')
        device_type = service_info.get('product', 'iOS device')

        tasks = {
            'id': 'ios-test-env-setup',
            'name': f'iOS Testing Environment Setup: {device_type}',
            'type': 'parent',
            'children': []
        }

        # SECTION 1: iOS Testing Environment Setup
        tasks['children'].append(self._create_environment_setup())

        # SECTION 2: Frida Installation & Configuration
        tasks['children'].append(self._create_frida_setup())

        # SECTION 3: Burp Suite Configuration
        tasks['children'].append(self._create_burp_setup())

        # SECTION 4: Basic iOS Testing Operations
        tasks['children'].append(self._create_basic_operations())

        # SECTION 5: iOS Testing Workflow
        tasks['children'].append(self._create_testing_workflow())

        return tasks

    def _create_environment_setup(self) -> Dict[str, Any]:
        """Create testing environment setup section"""
        return {
            'id': 'ios-environment-setup',
            'name': 'iOS Testing Environment Setup',
            'type': 'parent',
            'children': [
                {
                    'id': 'apple-developer-provisioning',
                    'name': 'Apple Developer Account & Provisioning',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Set up Apple Developer account and provisioning profiles for app signing',
                        'tags': ['OSCP:LOW', 'MANUAL', 'IOS', 'SETUP'],
                        'notes': """
iOS App Signing & Provisioning:

Provisioning Identity:
- Collection of public/private keys tied to Apple developer account
- Required to sign apps for physical device installation
- $99/year paid Apple Developer Program OR free (limited) option

Paid Developer Program ($99/year):
- Sign apps with official developer certificate
- Run apps on unlimited physical devices
- 1-year signing validity
- Full access to all iOS SDK features

Free Development Option (Xcode 7.2+):
1. Xcode → Preferences → Accounts → + (Add Apple ID)
2. Enter Apple ID credentials
3. Click Apple ID → Manage Certificates
4. + → Apple Development → Done
5. Connect iPhone via USB → Trust computer on device
6. Run app from Xcode
7. If error appears on device:
   Settings → General → VPN & Device Management → Trust profile

Provisioning Profile Storage:
Location: /Library/MobileDevice/ProvisioningProfiles
- Contains device IDs, app ID, certificate
- Apps signed by same certificate can share keychain items

Testing Options Summary:
| Option | Cost | Devices | Duration | Best For |
|--------|------|---------|----------|----------|
| Paid Developer | $99/year | Unlimited | 1 year | Professional testing |
| Free Developer | Free | 3 max | 7 days | Hobbyist, learning |
| Jailbroken | Free | Unlimited | Permanent | Full pentest, no limits |

Recommendation:
- Professional pentesting: Paid developer account
- Learning/practice: Free account OR jailbroken test device
- Full security assessment: Jailbroken device (unrestricted access)

Limitations Without Paid Account or Jailbreak:
- Cannot install arbitrary IPAs
- Cannot bypass code signing
- Limited to Xcode-built apps
                        """,
                        'alternatives': [
                            'Jailbroken device: No signing restrictions',
                            'iOS Simulator: No device needed (very limited)',
                            'Team developer account: Share paid certificate'
                        ],
                        'success_indicators': [
                            'Developer certificate installed in Keychain',
                            'Device appears in Xcode devices list',
                            'Test app installs and runs successfully'
                        ],
                        'failure_indicators': [
                            '"Untrusted Developer" error on device',
                            'Device not recognized by Xcode',
                            'Code signing error during build'
                        ],
                        'next_steps': [
                            'Install test app on physical device',
                            'Verify provisioning profile on device',
                            'Consider jailbreak for unrestricted testing',
                            'Set up iOS Simulator for quick tests'
                        ]
                    }
                },
                {
                    'id': 'ios-simulator-setup',
                    'name': 'iOS Simulator Configuration (macOS)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Set up iOS Simulator for app testing (macOS required)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'IOS', 'SETUP'],
                        'notes': """
iOS Simulator Setup (macOS Only):

Critical Limitation:
- Simulator ≠ Emulator
- Simulates iOS behavior, doesn't run actual iOS
- x86_64 architecture vs ARM on real devices
- Much more limited than jailbroken physical device
- Cannot test: Keychain, SEP, hardware features

Installation:
1. Install Xcode from Mac App Store (REQUIRED - official only!)
2. Open Xcode → Xcode menu → Open Developer Tools → Simulator
3. Select device type: Click device name → Choose model/iOS version
4. Simulator launches as separate window

Simulator File Locations:
Base Directory: /Users/<username>/Library/Developer/CoreSimulator/Devices

Find Currently Booted Simulator:
```bash
xcrun simctl list | grep Booted
# Output: iPhone 8 (BF5DA4F8-6BBE-4EA0-BA16-7E3AFD16C06C) (Booted)
```

App Data Location:
```bash
# Container data (user files, databases)
cd /Users/<username>/Library/Developer/CoreSimulator/Devices/{UID}/data/Containers/Data/Application

# App binary (built from Xcode)
cd /Users/<username>/Library/Developer/Xcode/DerivedData/{AppName}/Build/Products/Debug-iphonesimulator/
```

Finding App Files:
```bash
# 1. Get booted simulator UID
SIMULATOR_UID=$(xcrun simctl list | grep Booted | grep -oE '[A-F0-9-]{36}')

# 2. Navigate to app containers
cd /Users/<username>/Library/Developer/CoreSimulator/Devices/$SIMULATOR_UID/data/Containers/Data/Application

# 3. Find app by modification time or bundle ID
ls -lt
```

Simulator Advantages:
- No physical device needed
- Fast iteration (build → test)
- Easy debugging with Xcode
- Uses macOS proxy settings automatically

Simulator Limitations:
- Architecture mismatch (x86_64 vs ARM)
- Missing hardware features (Touch ID, Face ID, cameras)
- Different memory/CPU constraints
- Cannot test binary analysis (different architecture)
- Some security features don't work (Keychain Access API differs)

Best Use Cases:
- Quick UI/functionality testing
- Burp Suite proxy testing (inherits macOS settings)
- Source code debugging
- API integration testing

NOT Suitable For:
- Binary analysis/reverse engineering
- Runtime manipulation testing
- Full security assessment
- Performance testing
- Hardware-dependent features
                        """,
                        'alternatives': [
                            'Physical device: Required for thorough testing',
                            'Corellium: Virtual iOS device (enterprise, $$$$)',
                            'Jailbroken device: Full pentest capabilities'
                        ],
                        'success_indicators': [
                            'Simulator boots successfully',
                            'App builds and installs in simulator',
                            'Can access app files in filesystem'
                        ],
                        'failure_indicators': [
                            'Xcode not installed from App Store',
                            'Simulator crashes on launch',
                            'App won\'t install (build errors)'
                        ],
                        'next_steps': [
                            'Install Burp certificate in simulator',
                            'Configure macOS proxy settings',
                            'Build and test app in simulated environment',
                            'Understand limitations vs real device'
                        ]
                    }
                },
                {
                    'id': 'jailbreak-decision-guide',
                    'name': 'Jailbreak Decision & Methods',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Understand jailbreak necessity and available methods',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'IOS', 'JAILBREAK'],
                        'notes': """
iOS Jailbreak Decision Guide:

What is Jailbreaking?
- Process of circumventing Apple code signing restrictions
- Allows running unsigned code on iOS devices
- Patches integrity checks that verify app signatures
- Removes OS-imposed sandbox restrictions
- Grants root filesystem access

Why iOS Requires Jailbreak (Unlike Android):
- Android: Can unlock bootloader → flash custom ROM → root access
- iOS: Bootloader ONLY boots Apple-signed images (hardware enforced)
- Cannot flash custom iOS or bypass via bootloader
- MUST exploit iOS vulnerabilities to gain code execution

Jailbreak Challenges:
- Apple patches exploits in iOS updates rapidly
- Jailbreaks become obsolete with new iOS versions
- Downgrading iOS limited by SHSH blobs + signing windows
- Check current signing windows: https://ipsw.me
- Device on unsupported iOS = cannot jailbreak (until new exploit)

Signing Windows & SHSH Blobs:
- Apple controls which iOS versions can be installed
- Challenge-response mechanism (SHSH blobs) required
- Signing window: Period Apple signs specific iOS version
- Once window closes: Cannot install that version
- Result: Time-sensitive jailbreak availability

Jailbreak Types:
| Type | Reboot Behavior | Computer Needed | Persistence | Example |
|------|-----------------|-----------------|-------------|---------|
| Tethered | Must re-jailbreak with computer every boot | Always | No | Rare now |
| Semi-tethered | Boots non-jailbroken, need computer to re-jailbreak | Reboot only | No | Older tools |
| Semi-untethered | Boots non-jailbroken, app on device re-jailbreaks | Initial setup | No | unc0ver, Taurine |
| Untethered | Permanent jailbreak, survives reboot | Initial setup | Yes | Rare, highly valued |

Popular Jailbreak Tools 2025:

Checkra1n (Hardware Exploit - Unpatchable):
- Chips: A7 through A11 (iPhone 5s through iPhone X)
- iOS Versions: 12.0 - 16.x (partial support on newer)
- Type: Semi-untethered
- Exploit: Checkm8 (bootrom, cannot be patched!)
- URL: https://checkra.in/
- Best for: Pentesting (reliable, works forever)

Palera1n (Checkm8-based):
- Chips: A8-A11 (iPhone 6 through iPhone X)
- iOS Versions: 15.0 - 16.5
- Type: Semi-untethered
- URL: https://palera.in/
- Note: Newer than checkra1n, better iOS 15+ support

Unc0ver (Software Exploit):
- Chips: Various (A7-A13)
- iOS Versions: 11.0 - 14.8
- Type: Semi-untethered
- URL: https://unc0ver.dev/
- Note: Widespread support, stable

Taurine (Software Exploit):
- iOS Versions: 14.0 - 14.3
- Type: Semi-untethered
- Newer tool, alternative to unc0ver

Device Compatibility Check:
| Device | Chip | Checkra1n | Palera1n | Unc0ver |
|--------|------|-----------|----------|---------|
| iPhone 5s - 6s Plus | A7-A9 | ✓ | ✓ | ✓ |
| iPhone 7/7 Plus | A10 | ✓ | ✓ | ✓ |
| iPhone 8/8 Plus/X | A11 | ✓ | ✓ | ✓ (iOS ≤14.8) |
| iPhone XS/XR/11 | A12-A13 | ✗ | ✗ | ✓ (iOS ≤14.8) |
| iPhone 12+ | A14+ | ✗ | ✗ | ✗ (as of 2025) |

Non-Jailbreak Testing:
- Limited to app sandbox analysis
- Static IPA analysis (if obtained)
- Backup analysis (iTunes/iCloud backups)
- Can use Frida via patched IPA (no jailbreak needed!)
- See: ios-pentesting-without-jailbreak.md

Jailbreak Benefits for Pentesting:
✓ Full filesystem access (/var, /private, /System)
✓ Install unauthorized tools (Frida, OpenSSH, Cycript)
✓ Bypass jailbreak detection mechanisms
✓ Runtime manipulation (memory, processes)
✓ Deep security analysis (kernel, IPC, etc.)
✓ Test protection bypasses

Jailbreak Risks (Regular Users):
✗ Voids Apple warranty
✗ Security vulnerabilities exposed
✗ Device/app instability
✗ No official Apple support
✗ Malware risk if installing random packages

Pentesting Recommendation:
- Acquire dedicated test device (old iPhone 6s-X era)
- Checkra1n on A7-A11 = BEST option (unpatchable hardware exploit)
- NEVER jailbreak personal or production devices
- Budget option: Used iPhone 8 (~$100-200) + Checkra1n
- Keep test device on jailbreakable iOS version

Resources:
- Can I Jailbreak?: https://canijailbreak.com/
- The iPhone Wiki: https://www.theiphonewiki.com/
- r/jailbreak Reddit: Latest tools and compatibility info
                        """,
                        'alternatives': [
                            'Non-jailbreak testing: Limited app-level analysis',
                            'iOS Simulator: Quick testing (very limited)',
                            'Corellium: Enterprise virtual iOS ($$$$)'
                        ],
                        'success_indicators': [
                            'Jailbreak method identified for your device',
                            'iOS version compatible with jailbreak tool',
                            'Test device acquired (not production device)'
                        ],
                        'failure_indicators': [
                            'Latest iOS version (no jailbreak yet)',
                            'A12+ chip on iOS 15+ (no jailbreak)',
                            'Only have production device (cannot jailbreak)'
                        ],
                        'next_steps': [
                            'Acquire compatible test device if needed',
                            'Backup device before attempting jailbreak',
                            'Choose jailbreak tool based on chip/iOS version',
                            'If no jailbreak: Plan non-jailbreak testing approach'
                        ]
                    }
                },
                {
                    'id': 'checkra1n-jailbreak-process',
                    'name': 'Checkra1n Jailbreak Process (A7-A11)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Step-by-step jailbreak with checkra1n (hardware exploit)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'IOS', 'JAILBREAK'],
                        'notes': """
Checkra1n Jailbreak Process (A7-A11 Devices):

Compatible Devices (Checkm8 Hardware Exploit):
- iPhone: 5s, 6/6 Plus, 6s/6s Plus, SE (1st gen), 7/7 Plus, 8/8 Plus, X
- iPad: Air, Air 2, mini 2-4, Pro (9.7", 10.5", 12.9" 1st/2nd gen)
- iPod touch: 6th, 7th generation
- Chips: A7, A8, A9, A10, A11
- ADVANTAGE: Hardware exploit = Apple CANNOT patch it!

Supported iOS Versions:
- iOS 12.0 - 14.x: Full support, very stable
- iOS 15.x - 16.x: Partial support, may have bugs
- Check: https://checkra.in/ for latest compatibility

Requirements:
- macOS or Linux computer (Windows support via RA1N USB)
- USB cable (Lightning to USB-A or USB-C)
- Compatible iOS device
- ~30 minutes time

Pre-Jailbreak Preparation:

Step 1: Backup Device (CRITICAL):
```bash
# Option 1: iTunes/Finder (macOS Catalina+)
# Connect device → Finder → Backup → Encrypt backup → Back Up Now

# Option 2: iCloud
# Settings → [Your Name] → iCloud → iCloud Backup → Back Up Now

# Option 3: libimobiledevice (Linux/macOS)
idevicebackup2 backup --full ~/ios-backup/
```

Step 2: Disable Passcode & Find My:
```
Settings → Face ID & Passcode → Turn Passcode Off
Settings → [Your Name] → Find My → Find My iPhone → Off
```
Why: Passcode can interfere with jailbreak process

Step 3: Download Checkra1n:
- URL: https://checkra.in/
- macOS: checkra1n.app (DMG installer)
- Linux: checkra1n (AppImage)
- Verify signature (optional but recommended)

Jailbreak Process:

Step 1: Install Checkra1n Application:
```bash
# macOS
# Download checkra1n DMG → Mount → Drag to Applications

# Linux
chmod +x checkra1n
# May need to install dependencies:
sudo apt install usbmuxd libimobiledevice6 libusb-1.0-0
```

Step 2: Run Checkra1n:
```bash
# macOS
open /Applications/checkra1n.app

# Linux (may need sudo for USB access)
sudo ./checkra1n
```

Step 3: Connect Device:
- Connect iPhone via USB cable
- Unlock device
- Trust computer if prompted

Step 4: Start Jailbreak:
- Checkra1n GUI → "Start" button
- Application will guide you through DFU mode

Step 5: Enter DFU Mode (Follow On-Screen Instructions):
Different for each device type:

iPhone X/8/8 Plus:
1. Press Volume Up, release
2. Press Volume Down, release
3. Hold Side button until screen goes black
4. While holding Side, press Volume Down
5. Hold both for 5 seconds
6. Release Side, keep holding Volume Down for 10 seconds

iPhone 7/7 Plus:
1. Hold Side + Volume Down
2. Keep holding until screen goes black
3. Release Side, keep holding Volume Down

iPhone 6s and earlier:
1. Hold Home + Power/Side
2. Keep holding until screen goes black
3. Release Power/Side, keep holding Home

Step 6: Wait for Exploitation:
- Checkra1n will:
  * Upload exploit payload (pongoOS)
  * Patch kernel
  * Boot jailbroken iOS
  * Install checkra1n loader app
- Takes 2-5 minutes
- Device will reboot several times (NORMAL)

Step 7: Success Confirmation:
- Checkra1n GUI shows "All Done"
- Device boots to home screen
- New app: "checkra1n" appears on home screen

Post-Jailbreak Setup:

Step 1: Install Cydia/Sileo:
1. Open checkra1n app on device
2. Tap "Cydia" or "Sileo" (package manager options)
3. Install selected package manager
4. Wait for installation (2-3 minutes)

Step 2: Install Essential Tools:
Open Cydia/Sileo and install:

```
OpenSSH - Remote terminal access
- Source: Default (BigBoss)
- Enables: ssh root@<device-ip>
- Default password: alpine (CHANGE IMMEDIATELY)

Frida - Dynamic instrumentation
- Source: https://build.frida.re
- Package: Frida
- Enables: Runtime hooking, pentesting

NewTerm 2 - On-device terminal
- Source: Default (Chariz)
- Enables: Command line on device
```

Step 3: Change Default Passwords (CRITICAL):
```bash
# SSH into device
ssh root@<device-ip>
# Password: alpine

# Change root password
passwd root
# Enter new strong password

# Change mobile user password
passwd mobile
# Enter new strong password

# Disconnect
exit
```

Why: "alpine" is publicly known, devices get compromised!

Re-Jailbreaking After Reboot:

Checkra1n = Semi-untethered jailbreak
- Reboot: Device boots normally (non-jailbroken state)
- To re-jailbreak:
  1. Connect device to computer
  2. Run checkra1n again
  3. Click "Start"
  4. NO need to re-enter DFU mode usually
  5. Quick re-jailbreak (1 minute)
  6. No data loss

Troubleshooting:

Error -20:
- Cause: Passcode still enabled OR Find My iPhone on
- Fix: Disable both, retry

Error -78:
- Cause: USB connection issue
- Fix: Try different USB cable/port, retry

Error -92:
- Cause: Device communication problem
- Fix: Restart device and computer, use original Apple cable

Stuck in Recovery Mode:
- Cause: DFU mode failed
- Fix: Force restart (hold Power + Volume Down until Apple logo)

Bootloop (Continuous Rebooting):
- Cause: Jailbreak failed, corrupted install
- Fix: Enter recovery mode, restore via iTunes/Finder (LOSE JAILBREAK)
- Recovery: Hold Volume Down while connecting to iTunes

Device Won't Boot After Jailbreak:
- Enter DFU mode again
- Checkra1n → Options → Safe Mode → Start
- This boots with minimal tweaks loaded

Verification:

Test Jailbreak Success:
```bash
# SSH access works
ssh root@<device-ip>

# Cydia/Sileo app present
# Check home screen

# Root filesystem accessible
cd /var
ls -la

# Can install packages
apt-get update
```

Resources:
- Checkra1n official: https://checkra.in/
- Jailbreak support: r/jailbreak
- Package repos: Default repos in Cydia
                        """,
                        'alternatives': [
                            'Palera1n: Newer alternative for A8-A11 + iOS 15+',
                            'Unc0ver: Software exploit for A7-A13 (iOS ≤14.8)',
                            'Manual kernel exploit: Advanced, not recommended'
                        ],
                        'success_indicators': [
                            'Checkra1n shows "All Done" message',
                            'Device boots to iOS home screen',
                            'checkra1n app appears on device',
                            'Cydia/Sileo successfully installed'
                        ],
                        'failure_indicators': [
                            'Error codes (-20, -78, -92)',
                            'Device stuck in DFU/Recovery mode',
                            'Bootloop after jailbreak attempt',
                            'checkra1n app missing after boot'
                        ],
                        'next_steps': [
                            'Install OpenSSH from Cydia',
                            'Change root and mobile passwords',
                            'Install Frida for dynamic analysis',
                            'Set up SSH access (WiFi or USB)',
                            'Install pentesting tools from Cydia'
                        ]
                    }
                },
                {
                    'id': 'jailbreak-detection-bypass-methods',
                    'name': 'Jailbreak Detection & Bypass Techniques',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Understand and bypass iOS app jailbreak detection',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'IOS', 'BYPASS'],
                        'notes': """
iOS Jailbreak Detection & Bypass:

Why Apps Detect Jailbreak:
- Banking/financial apps: Prevent malware exposure
- DRM/streaming apps: Protect copyrighted content
- Gaming apps: Prevent cheating/modding
- Enterprise apps: Enforce corporate security policies
- Developer paranoia: "Jailbreak = insecure"

Common Detection Methods:

Method 1: File System Checks
Looks for jailbreak artifacts:
```
Common Files/Paths:
/Applications/Cydia.app
/Library/MobileSubstrate/
/bin/bash
/usr/sbin/sshd
/etc/apt
/private/var/lib/apt
/private/var/lib/cydia
/private/var/mobile/Library/SBSettings/Themes
```

Code Example:
```objective-c
if ([[NSFileManager defaultManager] fileExistsAtPath:@"/Applications/Cydia.app"]) {
    // Jailbreak detected!
}
```

Method 2: Sandbox Violation Tests
Tries operations that should fail in sandbox:
```objective-c
// Try to write outside sandbox
NSString *path = @"/private/test.txt";
[@"test" writeToFile:path atomically:YES encoding:NSUTF8StringEncoding error:nil];

// If succeeds → jailbroken
```

Method 3: API Behavior Checks
- system() call: Returns 1 on jailbroken (0 on stock)
- fork() process: Succeeds on jailbroken (fails on stock)
- dyld function checks: Detects injected libraries

```c
// system() check
if (system(NULL) != 0) {
    // Jailbroken
}
```

Method 4: URL Scheme Checks
```objective-c
// Check if Cydia URL scheme works
if ([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"cydia://"]]) {
    // Jailbroken
}
```

Method 5: OpenSSH Detection
- Check if port 22 listening
- Test SSH connection to localhost

Bypass Techniques:

Method 1: Objection (Easiest - Recommended):
```bash
# Launch app with objection
objection --gadget com.example.bankapp explore

# In objection shell
ios jailbreak disable

# Hooks common detection functions automatically
# Works for ~80% of apps
```

How it works:
- Hooks file existence checks → always return false
- Hooks system() → return 0
- Hooks fork() → return error
- Blocks URL scheme checks

Method 2: Liberty Lite (Cydia Tweak):
Installation:
1. Add Cydia repo: https://ryleyangus.com/repo/
2. Search "Liberty Lite"
3. Install Liberty Lite
4. Open Liberty Lite app
5. Enable for target app
6. Configure detection methods to block
7. Respring device
8. Launch app

Advantages:
- Per-app configuration
- Persistent (survives app updates usually)
- GUI configuration

Method 3: Manual Frida Hooking:
```javascript
// jailbreak-bypass.js
// Usage: frida -U -f com.example.app -l jailbreak-bypass.js --no-pause

// Hook file existence checks
var fopen = Module.findExportByName(null, "fopen");
if (fopen) {
    Interceptor.replace(fopen, new NativeCallback(function(path, mode) {
        var pathStr = Memory.readUtf8String(path);
        
        // Block jailbreak paths
        var jailbreakPaths = [
            "/Applications/Cydia.app",
            "/bin/bash",
            "/usr/sbin/sshd",
            "/etc/apt",
            "/private/var/lib/apt",
            "/Library/MobileSubstrate"
        ];
        
        for (var i = 0; i < jailbreakPaths.length; i++) {
            if (pathStr.indexOf(jailbreakPaths[i]) !== -1) {
                console.log("[*] Blocked file check: " + pathStr);
                return NULL;  // File doesn't exist
            }
        }
        
        // Original function for normal paths
        return fopen(path, mode);
    }, 'pointer', ['pointer', 'pointer']));
}

// Hook stat() - file status check
var stat = Module.findExportByName(null, "stat");
if (stat) {
    Interceptor.replace(stat, new NativeCallback(function(path, buf) {
        var pathStr = Memory.readUtf8String(path);
        
        if (pathStr.includes("/Applications/Cydia.app") ||
            pathStr.includes("/bin/bash") ||
            pathStr.includes("/Library/MobileSubstrate")) {
            console.log("[*] Blocked stat check: " + pathStr);
            return -1;  // File doesn't exist
        }
        
        return stat(path, buf);
    }, 'int', ['pointer', 'pointer']));
}

// Hook system() calls
var system = Module.findExportByName(null, "system");
if (system) {
    Interceptor.replace(system, new NativeCallback(function(cmd) {
        console.log("[*] Blocked system() call");
        return 0;  // Non-jailbroken return value
    }, 'int', ['pointer']));
}

// Hook fork() calls
var fork = Module.findExportByName(null, "fork");
if (fork) {
    Interceptor.replace(fork, new NativeCallback(function() {
        console.log("[*] Blocked fork() call");
        return -1;  // Fork failed (non-jailbroken behavior)
    }, 'int', []));
}

console.log("[+] Jailbreak bypass hooks installed");
```

Method 4: Binary Patching (Advanced):
Process:
1. Reverse engineer app binary (Ghidra/IDA)
2. Identify jailbreak detection functions
3. Patch binary to skip checks or always return "not jailbroken"
4. Re-sign IPA
5. Install patched app

Tools:
- Ghidra: Reverse engineering
- Hopper Disassembler: macOS/iOS binary analysis
- jtool2: iOS-specific binary tool
- ldid: Re-signing tool

Detection Indicators:

App Behavior When Detecting Jailbreak:
✗ Crashes immediately on launch
✗ Shows "Device is jailbroken" alert
✗ Exits silently after 2-3 seconds
✗ Disables critical features
✗ Refuses network connections

Verification Steps:

Test if Bypass Works:
1. Launch app with bypass active
2. Check for alert/crash
3. Verify full functionality
4. Test critical features (login, payments, etc.)
5. Monitor logs for detection messages

Console Logging:
```bash
# Monitor system logs for detection
idevicesyslog | grep -i jailbreak
idevicesyslog | grep -i cydia

# Frida console output
# Will show "[*] Blocked..." messages if bypass working
```

Advanced Detection (Harder to Bypass):

Integrity Checks:
- App code signature verification
- Binary checksum validation
- Runtime anti-tampering

Solutions:
- Disable code signing checks with Frida
- Patch checksum functions
- Use shadow tools (hide jailbreak deeper)

Bypass Success Rate by Method:
| Method | Success Rate | Difficulty | Persistence |
|--------|--------------|------------|-------------|
| Objection | 70-80% | Easy | Per-launch |
| Liberty Lite | 60-70% | Easy | Persistent |
| Manual Frida | 90-95% | Medium | Per-launch |
| Binary Patch | 95-99% | Hard | Permanent |

Troubleshooting:

App Still Detects Jailbreak:
1. Try multiple bypass methods together
2. Analyze app with Frida tracing to find detection
3. Research app-specific bypasses (GitHub, forums)
4. Consider binary patching

Bypass Causes App Crash:
- Hooks too aggressive
- Wrong function signatures
- App has anti-tampering
- Try different bypass method

Resources:
- objection: https://github.com/sensepost/objection
- Liberty Lite: https://ryleyangus.com/repo/
- Frida scripts: https://codeshare.frida.re (search "jailbreak bypass")
                        """,
                        'alternatives': [
                            'Shadow: Deep jailbreak hiding (Cydia tweak)',
                            'FlyJB X: Advanced bypass (paid, $2-5)',
                            'Hestia: Per-app bypass configuration',
                            'A-Bypass: Alternative bypass tweak',
                            'Manual binary patching: 100% control but complex'
                        ],
                        'success_indicators': [
                            'App launches without errors',
                            'No jailbreak detection alert appears',
                            'All app features fully accessible',
                            'Login and critical functions work normally'
                        ],
                        'failure_indicators': [
                            'App still crashes on jailbroken device',
                            'Detection alert still appears',
                            'Features remain disabled',
                            'App exits silently after launch'
                        ],
                        'next_steps': [
                            'Test multiple bypass methods if first fails',
                            'Analyze detection with Frida tracing',
                            'Research app-specific bypasses online',
                            'Document bypass method for future reference',
                            'Report difficult apps to bypass community'
                        ]
                    }
                }
            ]
        }

    def _create_frida_setup(self) -> Dict[str, Any]:
        """Create Frida installation and configuration section"""
        return {
            'id': 'frida-installation-config',
            'name': 'Frida Installation & Configuration',
            'type': 'parent',
            'children': [
                {
                    'id': 'frida-server-device-install',
                    'name': 'Install Frida Server on iOS Device',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Install Frida server on jailbroken iOS device',
                        'tags': ['OSCP:HIGH', 'IOS', 'SETUP', 'FRIDA'],
                        'notes': """
Frida Server Installation on Jailbroken Device:

Prerequisites:
- Jailbroken iOS device (checkra1n, unc0ver, etc.)
- Cydia or Sileo package manager installed
- Network connectivity (WiFi)

Installation Steps:

Step 1: Open Cydia or Sileo
- Launch Cydia/Sileo app on jailbroken device
- Wait for source refresh to complete

Step 2: Add Frida Repository
Navigate to: Manage → Sources → Edit → Add

Add URL: https://build.frida.re

Wait for repository to load (~30 seconds)

Step 3: Install Frida Package
1. Go to newly added "Frida" source
2. Find "Frida" package (shows latest version)
3. Tap "Install" or "Get"
4. Confirm installation
5. Wait for download and install (2-5 minutes depending on connection)
6. Tap "Respring" or "Restart SpringBoard" when prompted

Step 4: Verify Installation
```bash
# Method 1: Check process (via SSH)
ssh root@<device-ip>
ps aux | grep frida-server
# Should show: /usr/sbin/frida-server

# Method 2: Check version
frida-server --version
# Output: 16.x.x (or latest version)

# Method 3: Check if running
pgrep -fl frida
# Output: [PID] /usr/sbin/frida-server
```

Corellium Installation (Virtual Device):

If using Corellium virtual iOS:
1. Download Frida release: https://github.com/frida/frida/releases
2. Get: frida-gadget-[version]-ios-universal.dylib.gz
3. Unpack: gunzip frida-gadget-*.dylib.gz
4. Copy to: /Users/[you]/.cache/frida/gadget-ios.dylib
5. Frida will automatically use this gadget

Post-Installation:

Frida Auto-Start:
- Frida server starts automatically on device boot
- Runs as system service (launchd)
- No manual start required
- Listens on all interfaces

Frida Communication:
- USB: Preferred method (fast, reliable)
- Network: WiFi connection (slower but wireless)
- Port: Frida uses dynamic port allocation

Check Frida Status:
```bash
# On device (via SSH)
ssh root@<device-ip>

# Check if running
ps aux | grep frida-server

# Manual start (if stopped)
/usr/sbin/frida-server &

# Stop Frida
killall frida-server

# Restart Frida
killall frida-server && /usr/sbin/frida-server &
```

Common Issues:

Issue: Package Not Found
- Solution: Verify repo URL: https://build.frida.re (no trailing slash)
- Solution: Refresh sources (Cydia: pull down on Sources page)

Issue: Installation Fails
- Cause: Incompatible iOS version
- Solution: Check Frida compatibility on GitHub
- Solution: Try older Frida version

Issue: Frida Server Not Running
```bash
# Check if process exists
ps aux | grep frida

# If not running, start manually
/usr/sbin/frida-server &

# Make persistent (add to launch daemon)
# Usually done automatically by Cydia package
```

Issue: Version Mismatch with Client
- Frida server (iOS) and client (PC) versions MUST match
- Check versions, update as needed

File Locations:
- Binary: /usr/sbin/frida-server
- Config: /etc/frida/ (if exists)
- Logs: /var/log/frida/ (if logging enabled)

Updating Frida:
1. Open Cydia/Sileo
2. Navigate to "Installed" or "Updates"
3. If Frida update available, tap "Update"
4. Respring after update
5. Verify new version: frida-server --version
                        """,
                        'alternatives': [
                            'Manual install: Download .deb, dpkg -i frida.deb',
                            'Build from source: Advanced, not recommended',
                            'Frida gadget: Patch app without jailbreak (separate method)'
                        ],
                        'success_indicators': [
                            'Frida package installed successfully in Cydia',
                            'frida-server process running (ps aux | grep frida)',
                            'frida-server --version returns version number',
                            'No errors in installation log'
                        ],
                        'failure_indicators': [
                            'Repository URL not loading',
                            'Package shows incompatible iOS version',
                            'frida-server not in process list after install',
                            'Cydia installation errors'
                        ],
                        'next_steps': [
                            'Install Frida client tools on PC',
                            'Test Frida connection from PC to device',
                            'Verify frida-ps lists device processes',
                            'Install objection for higher-level Frida usage'
                        ]
                    }
                }
            ]
        }

    def _create_burp_setup(self) -> Dict[str, Any]:
        """Create Burp Suite proxy configuration section"""
        return {
            'id': 'burp-proxy-config',
            'name': 'Burp Suite Proxy Configuration',
            'type': 'parent',
            'children': []  # Will be populated with Burp setup tasks
        }

    def _create_basic_operations(self) -> Dict[str, Any]:
        """Create basic iOS testing operations section"""
        return {
            'id': 'ios-basic-ops',
            'name': 'Basic iOS Testing Operations',
            'type': 'parent',
            'children': []  # Will be populated with basic operations
        }

    def _create_testing_workflow(self) -> Dict[str, Any]:
        """Create complete testing workflow section"""
        return {
            'id': 'ios-testing-workflow-guide',
            'name': 'Complete iOS Testing Workflow',
            'type': 'parent',
            'children': []  # Will be populated with workflow guide
        }
