"""
macOS Kernel & Boot Security enumeration plugin

Generates tasks for macOS kernel-level security enumeration including:
- System Integrity Protection (SIP) bypass detection
- Kernel extension (kext) enumeration and analysis
- Sealed system snapshot verification
- NVRAM manipulation and boot-args analysis
- AMFI (AppleMobileFileIntegrity) configuration
- Kernel vulnerability detection and exploitation
- Secure boot configuration analysis
- Kernelcache extraction and reverse engineering

Extracted from HackTricks:
- macos-sip.md (284 lines)
- macos-kernel-extensions.md (272 lines)
- macos-kernel-vulnerabilities.md (100 lines)
- mac-os-architecture README.md (78 lines)
- macos-amfi-applemobilefileintegrity.md (135 lines)

Generated by: CrackPot v1.0
Total source lines: 869
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class MacOSKernelSecurityPlugin(ServicePlugin):
    """macOS kernel and boot security enumeration plugin"""

    @property
    def name(self) -> str:
        return "macos-kernel-security"

    @property
    def default_ports(self) -> List[int]:
        return []  # Not port-based, system-level enumeration

    @property
    def service_names(self) -> List[str]:
        return ['macos', 'darwin', 'osx']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect macOS systems"""
        # This plugin is triggered manually or via OS detection
        service = port_info.get('service', '').lower()
        os_info = port_info.get('os', '').lower()

        # Check for macOS indicators
        if any(indicator in service for indicator in ['macos', 'darwin', 'osx']):
            return True

        if any(indicator in os_info for indicator in ['mac', 'darwin', 'osx']):
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate macOS kernel security enumeration task tree"""

        tasks = {
            'id': 'macos-kernel-security',
            'name': 'macOS Kernel & Boot Security Enumeration',
            'type': 'parent',
            'children': []
        }

        # ===== PHASE 1: System Integrity Protection (SIP) =====
        sip_tasks = {
            'id': 'sip-enum',
            'name': 'System Integrity Protection (SIP) Analysis',
            'type': 'parent',
            'children': []
        }

        # Task 1.1: Check SIP status
        sip_tasks['children'].append({
            'id': 'sip-status',
            'name': 'Check SIP Status',
            'type': 'command',
            'metadata': {
                'command': 'csrutil status',
                'description': 'Check if System Integrity Protection is enabled',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'status': 'Display current SIP configuration status'
                },
                'success_indicators': [
                    'Shows "System Integrity Protection status: enabled" or "disabled"',
                    'Displays active configuration flags',
                    'Exit code 0 indicates successful query'
                ],
                'failure_indicators': [
                    'Command not found (not macOS)',
                    'Must run from Recovery Mode for accurate status',
                    'Permission denied'
                ],
                'next_steps': [
                    'If disabled: System vulnerable to rootkit installation',
                    'Check authenticated-root status for snapshot seal',
                    'Enumerate SIP-protected directories for bypass opportunities',
                    'Review NVRAM boot-args for SIP configuration'
                ],
                'alternatives': [
                    'Manual: nvram csr-active-config (Intel)',
                    'Manual: Check device tree lp-sip0 (ARM)',
                    'Manual: ls -lOd /System/Library to check "restricted" flag'
                ],
                'notes': 'SIP must be checked from Recovery Mode (Cmd+R on boot) for definitive status. From normal boot, status may be misleading. SIP protects /System, /bin, /sbin, /usr directories.'
            }
        })

        # Task 1.2: Check authenticated root (sealed snapshots)
        sip_tasks['children'].append({
            'id': 'authenticated-root',
            'name': 'Check Authenticated Root Status',
            'type': 'command',
            'metadata': {
                'command': 'csrutil authenticated-root status',
                'description': 'Verify if system volume snapshot is cryptographically sealed',
                'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'authenticated-root': 'Check sealed system snapshot status',
                    'status': 'Display current seal configuration'
                },
                'success_indicators': [
                    'Shows "enabled" - system snapshot is sealed',
                    'Shows "disabled" - snapshot modifications possible'
                ],
                'failure_indicators': [
                    'Command not available (pre-Big Sur)',
                    'Must run from Recovery Mode'
                ],
                'next_steps': [
                    'If disabled: System volume modifications persist across reboot',
                    'Check APFS snapshots with diskutil apfs list',
                    'Attempt SIP bypass via snapshot manipulation',
                    'Review mount points for writable system volumes'
                ],
                'alternatives': [
                    'Manual: diskutil apfs list | grep -A10 "Snapshot Sealed"',
                    'Manual: mount | grep "read-only" to check snapshot mount',
                    'Manual: Check /System/Volumes/Update/mnt1 for sealed volume'
                ],
                'notes': 'Introduced in macOS Big Sur (11.0). Sealed snapshots prevent system modification even with SIP bypass. Modifications to sealed volume prevent boot.'
            }
        })

        # Task 1.3: Enumerate SIP-protected paths
        sip_tasks['children'].append({
            'id': 'sip-protected-paths',
            'name': 'Enumerate SIP-Protected Paths',
            'type': 'command',
            'metadata': {
                'command': 'cat /System/Library/Sandbox/rootless.conf',
                'description': 'Read SIP configuration file showing protected paths and exceptions',
                'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                'flag_explanations': {},
                'success_indicators': [
                    'List of SIP-protected directories',
                    'Paths prefixed with * are exceptions (writable)',
                    'File readable without sudo'
                ],
                'failure_indicators': [
                    'File not found (custom configuration)',
                    'SIP protection on config file itself'
                ],
                'next_steps': [
                    'Identify exception paths (marked with *) for persistence',
                    'Check if /usr/local is writable',
                    'Test /usr/libexec/cups for SIP exceptions',
                    'Look for non-existent SIP-protected paths to create'
                ],
                'alternatives': [
                    'Manual: ls -lOd /System /bin /sbin /usr | grep restricted',
                    'Manual: ls -lOd /usr/libexec/cups | grep sunlnk',
                    'Manual: xattr -l <file> | grep com.apple.rootless'
                ],
                'notes': 'Paths with "restricted" flag cannot be modified. Paths with "sunlnk" flag cannot be deleted but contents are modifiable. Asterisk (*) prefix indicates SIP exception.'
            }
        })

        # Task 1.4: Check for SIP bypass vulnerabilities
        sip_tasks['children'].append({
            'id': 'sip-bypass-check',
            'name': 'Check for Known SIP Bypass Vulnerabilities',
            'type': 'parent',
            'children': [
                {
                    'id': 'sip-bypass-shrootless',
                    'name': 'CVE-2021-30892 (Shrootless) Check',
                    'type': 'command',
                    'metadata': {
                        'command': 'ls -la /etc/zshenv && sw_vers | grep ProductVersion',
                        'description': 'Check for Shrootless vulnerability (system_installd zshenv abuse)',
                        'tags': ['OSCP:HIGH', 'CVE', 'MACOS'],
                        'flag_explanations': {
                            '-la': 'List all files with permissions'
                        },
                        'success_indicators': [
                            '/etc/zshenv exists and is writable',
                            'macOS version < 12.0.1 (vulnerable)',
                            'Can create malicious /etc/zshenv'
                        ],
                        'failure_indicators': [
                            '/etc/zshenv protected or non-existent',
                            'macOS version patched (>= 12.0.1)'
                        ],
                        'next_steps': [
                            'Create /etc/zshenv with SIP bypass payload',
                            'Wait for system_installd to invoke zsh',
                            'Payload runs with com.apple.rootless.install.heritable entitlement',
                            'Disable SIP via csr_set_allow_all()'
                        ],
                        'alternatives': [
                            'Check ~/.zshenv for per-user privilege escalation',
                            'Monitor system_installd process spawns',
                            'Check for other shell rc files: /etc/bashrc, /etc/profile'
                        ],
                        'notes': 'Shrootless (CVE-2021-30892) allows SIP bypass via /etc/zshenv abuse. system_installd runs zsh which executes /etc/zshenv with heritable SIP bypass entitlement. Patched in macOS Monterey 12.0.1.'
                    }
                },
                {
                    'id': 'sip-bypass-installer',
                    'name': 'CVE-2022-22583 (Installer /tmp Mount) Check',
                    'type': 'command',
                    'metadata': {
                        'command': 'mount | grep /tmp && sw_vers',
                        'description': 'Check for installer package /tmp mount vulnerability',
                        'tags': ['OSCP:MEDIUM', 'CVE', 'MACOS'],
                        'flag_explanations': {},
                        'success_indicators': [
                            '/tmp is not SIP-protected',
                            'Can mount virtual images on /tmp',
                            'macOS version < 12.3 (vulnerable)'
                        ],
                        'failure_indicators': [
                            '/tmp has SIP protection',
                            'Cannot mount images on /tmp',
                            'Patched version (>= 12.3)'
                        ],
                        'next_steps': [
                            'Mount virtual image on /tmp during installation',
                            'system_installd writes post-install script to mounted image',
                            'Unmount and replace with malicious post-install script',
                            'Script runs with SIP bypass entitlement'
                        ],
                        'alternatives': [
                            'Check for other writable /tmp subdirectories',
                            'Monitor installer package execution',
                            'Use dtrace to trace system_installd file operations'
                        ],
                        'notes': 'CVE-2022-22583 abuses system_installd writing post-install scripts to /tmp subdirectories. /tmp itself not SIP-protected, allowing mount hijacking. Patched in macOS Monterey 12.3.'
                    }
                },
                {
                    'id': 'sip-bypass-systemmigrationd',
                    'name': 'systemmigrationd Environment Variable Abuse',
                    'type': 'command',
                    'metadata': {
                        'command': 'ps aux | grep systemmigrationd && ls -la /usr/libexec/systemmigrationd',
                        'description': 'Check for systemmigrationd bash/perl environment variable abuse',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'flag_explanations': {
                            'aux': 'Show all processes with details'
                        },
                        'success_indicators': [
                            'systemmigrationd process running',
                            'Binary has SIP bypass entitlements',
                            'BASH_ENV or PERL5OPT environment variables writable'
                        ],
                        'failure_indicators': [
                            'systemmigrationd not running',
                            'Environment variables ignored',
                            'Process sandboxed'
                        ],
                        'next_steps': [
                            'Set BASH_ENV to malicious script path',
                            'Set PERL5OPT to load malicious Perl module',
                            'Trigger systemmigrationd execution',
                            'Malicious code runs with SIP bypass'
                        ],
                        'alternatives': [
                            'Monitor launchd for systemmigrationd spawns',
                            'Check other daemons with SIP entitlements',
                            'Review /System/Library/LaunchDaemons/*.plist for entitled processes'
                        ],
                        'notes': 'Presented at DEF CON 31. systemmigrationd executes bash/perl scripts which honor BASH_ENV and PERL5OPT environment variables. Runs with com.apple.rootless.install entitlement.'
                    }
                }
            ]
        })

        # Task 1.5: NVRAM boot-args manipulation
        sip_tasks['children'].append({
            'id': 'nvram-boot-args',
            'name': 'Enumerate NVRAM Boot Arguments',
            'type': 'command',
            'metadata': {
                'command': 'sudo nvram -p | grep -E "(boot-args|csr-active-config)"',
                'description': 'Read NVRAM variables affecting SIP and kernel debugging',
                'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'nvram': 'Non-Volatile RAM configuration tool',
                    '-p': 'Print all NVRAM variables',
                    'grep -E': 'Filter for boot arguments and SIP config'
                },
                'success_indicators': [
                    'Shows boot-args with debug flags',
                    'csr-active-config reveals SIP status (Intel)',
                    'Identifies kernel debugging enabled'
                ],
                'failure_indicators': [
                    'NVRAM variables protected by SIP',
                    'Requires com.apple.rootless.restricted-nvram-variables entitlement',
                    'Permission denied without root'
                ],
                'next_steps': [
                    'If csr-active-config is 0x67 or 0x77: SIP partially disabled',
                    'Check for amfi_get_out_of_my_way boot-arg (AMFI disabled)',
                    'Look for debug=0x144 (kernel debugging enabled)',
                    'Test NVRAM write capabilities with restricted variables'
                ],
                'alternatives': [
                    'Manual: nvram boot-args (read only boot arguments)',
                    'Manual: nvram csr-active-config (Intel SIP status)',
                    'Manual: ioreg -l | grep lp-sip0 (ARM SIP status)',
                    'Recovery Mode: csrutil status (definitive SIP status)'
                ],
                'notes': 'SIP configuration stored in csr-active-config (Intel) or lp-sip0 device tree (ARM). NVRAM writes require com.apple.rootless.restricted-nvram-variables.heritable entitlement or SIP disabled. Common bypass boot-args: amfi_get_out_of_my_way=1, cs_enforcement_disable=1.'
            }
        })

        tasks['children'].append(sip_tasks)

        # ===== PHASE 2: Kernel Extensions (Kexts) =====
        kext_tasks = {
            'id': 'kext-enum',
            'name': 'Kernel Extension Analysis',
            'type': 'parent',
            'children': []
        }

        # Task 2.1: List loaded kernel extensions
        kext_tasks['children'].append({
            'id': 'kmutil-showloaded',
            'name': 'List Loaded Kernel Extensions',
            'type': 'command',
            'metadata': {
                'command': 'sudo kmutil showloaded --sort',
                'description': 'Enumerate all loaded kernel extensions sorted by load address',
                'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'kmutil': 'Kernel management utility (replaces kextstat)',
                    'showloaded': 'Display all loaded kernel extensions',
                    '--sort': 'Sort by load address'
                },
                'success_indicators': [
                    'List of loaded kexts with bundle IDs',
                    'Load addresses and memory sizes shown',
                    'Version information displayed'
                ],
                'failure_indicators': [
                    'No non-Apple kexts found',
                    'Permission denied without sudo',
                    'System locked down (no third-party kexts)'
                ],
                'next_steps': [
                    'Identify non-Apple kexts (potential attack surface)',
                    'Check kext versions against CVE databases',
                    'Inspect third-party kext for vulnerabilities',
                    'Enumerate kext dependencies'
                ],
                'alternatives': [
                    'Legacy: kextstat (deprecated, still works)',
                    'Filter third-party: kmutil showloaded | grep -v com.apple',
                    'Show auxiliary collection: kmutil showloaded --collection aux',
                    'Manual: ls -la /Library/Extensions /System/Library/Extensions'
                ],
                'notes': 'kmutil replaces kextstat in modern macOS. Third-party kexts require Reduced Security mode on Apple Silicon. Look for unusual bundle IDs not from com.apple.*.'
            }
        })

        # Task 2.2: Check kext loading security settings
        kext_tasks['children'].append({
            'id': 'kext-security-settings',
            'name': 'Check Kext Loading Security',
            'type': 'command',
            'metadata': {
                'command': 'sudo spctl kext-consent status && sudo systemextensionsctl list',
                'description': 'Check if third-party kexts are allowed and list approved developers',
                'tags': ['OSCP:HIGH', 'MACOS'],
                'flag_explanations': {
                    'spctl': 'Security policy control utility',
                    'kext-consent': 'Kernel extension consent management',
                    'status': 'Show current kext approval status',
                    'systemextensionsctl': 'System extensions control (user-space drivers)',
                    'list': 'List all system extensions'
                },
                'success_indicators': [
                    'Shows kext consent status',
                    'Lists approved developer team IDs',
                    'System extensions enumerated'
                ],
                'failure_indicators': [
                    'All third-party kexts blocked',
                    'Reduced Security not enabled',
                    'No user-approved kexts'
                ],
                'next_steps': [
                    'If kexts allowed: Attempt malicious kext loading',
                    'Enumerate approved developer certificates',
                    'Check System Extensions for attack surface',
                    'Review /Library/Extensions for staging area'
                ],
                'alternatives': [
                    'Manual: sqlite3 /var/db/SystemPolicyConfiguration/KextPolicy "SELECT * FROM kext_policy"',
                    'Manual: ls /Library/StagedExtensions (kext staging area)',
                    'Manual: log show --predicate "subsystem == \'com.apple.kext\'" --last 1h',
                    'Recovery Mode: Startup Security Utility to check policy'
                ],
                'notes': 'Apple Silicon requires Reduced Security + "Allow user management of kernel extensions" enabled in Recovery. Kexts require Apple Developer ID signing + notarization. Staging directory: /Library/StagedExtensions.'
            }
        })

        # Task 2.3: Extract kexts from kernelcache
        kext_tasks['children'].append({
            'id': 'kernelcache-extraction',
            'name': 'Extract Kexts from Kernelcache',
            'type': 'parent',
            'children': [
                {
                    'id': 'find-kernelcache',
                    'name': 'Locate Kernelcache',
                    'type': 'command',
                    'metadata': {
                        'command': 'find /System/Volumes/Preboot -name "kernelcache" 2>/dev/null',
                        'description': 'Find kernelcache location (pre-compiled kernel + kexts)',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'flag_explanations': {
                            'find': 'Search filesystem',
                            '/System/Volumes/Preboot': 'Boot volume containing kernelcache',
                            '-name': 'Match filename',
                            '2>/dev/null': 'Suppress permission errors'
                        },
                        'success_indicators': [
                            'Kernelcache path found in Preboot volume',
                            'File size ~30-50MB',
                            'UUID-based path identified'
                        ],
                        'failure_indicators': [
                            'No kernelcache found',
                            'Permission denied on Preboot volume',
                            'SIP prevents access'
                        ],
                        'next_steps': [
                            'Copy kernelcache for offline analysis',
                            'Check for symbols: nm -a kernelcache | wc -l',
                            'Extract kexts with kextex tool',
                            'Decompress if IMG4 format'
                        ],
                        'alternatives': [
                            'macOS: /System/Library/Caches/com.apple.kernelcaches/kernelcache',
                            'iOS: /System/Library/Caches/com.apple.kernelcaches/kernelcache',
                            'Download from Apple: ipsw.me or theiphonewiki.com',
                            'Extract from firmware: ipsw extract --kernel firmware.ipsw'
                        ],
                        'notes': 'Kernelcache is pre-linked kernel + essential kexts in compressed format. /System/Library/Extensions contains no binaries (moved to kernelcache). Download Kernel Debug Kit (KDK) from github.com/dortania/KdkSupportPkg for symbols.'
                    }
                },
                {
                    'id': 'decompress-kernelcache',
                    'name': 'Decompress IMG4 Kernelcache',
                    'type': 'command',
                    'metadata': {
                        'command': 'pyimg4 im4p extract -i kernelcache.release.* -o kernelcache.extracted',
                        'description': 'Decompress IMG4-format kernelcache for analysis',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'flag_explanations': {
                            'pyimg4': 'IMG4 format manipulation tool (pip install pyimg4)',
                            'im4p': 'IMG4 payload subcommand',
                            'extract': 'Extract payload from IMG4 container',
                            '-i': 'Input IMG4 file',
                            '-o': 'Output extracted payload'
                        },
                        'success_indicators': [
                            'Extracted file created',
                            'File size larger than compressed',
                            'Mach-O headers visible'
                        ],
                        'failure_indicators': [
                            'Not IMG4 format',
                            'Decryption key required',
                            'Corrupted kernelcache'
                        ],
                        'next_steps': [
                            'List kexts: kextex -l kernelcache.extracted',
                            'Extract specific kext: kextex -e com.apple.security.sandbox kernelcache.extracted',
                            'Check for symbols: nm -a kernelcache.extracted',
                            'Load in Ghidra/IDA for reverse engineering'
                        ],
                        'alternatives': [
                            'img4tool -e kernelcache.release.* -o kernelcache.extracted',
                            'ipsw extract --kernel firmware.ipsw',
                            'Manual: Extract from IPSW (change .ipsw to .zip and unzip)'
                        ],
                        'notes': 'IMG4 format contains: IM4P (payload, often LZFSE compressed), IM4M (manifest with signature), optional IM4R (APNonce anti-replay). Install tools: pip install pyimg4 or brew install img4tool.'
                    }
                },
                {
                    'id': 'extract-kexts',
                    'name': 'Extract Individual Kexts',
                    'type': 'command',
                    'metadata': {
                        'command': 'kextex_all kernelcache.extracted',
                        'description': 'Extract all kexts from kernelcache to separate files',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'flag_explanations': {
                            'kextex_all': 'Extract all kexts from kernelcache',
                            'kernelcache.extracted': 'Decompressed kernelcache file'
                        },
                        'success_indicators': [
                            'binaries/ directory created with kexts',
                            'Each kext as separate Mach-O binary',
                            'Bundle identifiers preserved'
                        ],
                        'failure_indicators': [
                            'kextex tool not installed',
                            'Kernelcache not decompressed',
                            'Corrupted kernelcache'
                        ],
                        'next_steps': [
                            'Check kext for symbols: nm -a binaries/com.apple.security.sandbox',
                            'Reverse engineer security kexts (Sandbox, AMFI)',
                            'Search for vulnerabilities in third-party kexts',
                            'Compare kext versions against CVE databases'
                        ],
                        'alternatives': [
                            'Extract single kext: kextex -e com.apple.security.sandbox kernelcache.extracted',
                            'List kexts only: kextex -l kernelcache.extracted',
                            'Manual: Use Mach-O parser to extract segments'
                        ],
                        'notes': 'kextex tool: github.com/kennytm/kextex. Interesting kexts for security research: com.apple.security.sandbox, com.apple.driver.AppleMobileFileIntegrity, com.apple.security.quarantine. Check symbols before analysis: nm -a <kext>.'
                    }
                }
            ]
        })

        # Task 2.4: Check for kext vulnerabilities
        kext_tasks['children'].append({
            'id': 'kext-vuln-check',
            'name': 'Check for Kernel Extension Vulnerabilities',
            'type': 'parent',
            'children': [
                {
                    'id': 'cve-2024-44243',
                    'name': 'CVE-2024-44243 (Sigma) - storagekitd Kext Loading',
                    'type': 'command',
                    'metadata': {
                        'command': 'ps aux | grep storagekitd && sw_vers | grep ProductVersion',
                        'description': 'Check for storagekitd unsigned kext loading vulnerability',
                        'tags': ['OSCP:HIGH', 'CVE', 'MACOS'],
                        'flag_explanations': {
                            'ps aux': 'List all running processes',
                            'grep storagekitd': 'Filter for storagekitd daemon',
                            'sw_vers': 'Show macOS version'
                        },
                        'success_indicators': [
                            'storagekitd process running',
                            'macOS version < 15.2 (vulnerable)',
                            'Has com.apple.storagekitd.kernel-management entitlement'
                        ],
                        'failure_indicators': [
                            'storagekitd not running',
                            'Patched version (>= 15.2)',
                            'Cannot abuse entitlement'
                        ],
                        'next_steps': [
                            'Abuse storagekitd to load unsigned kext',
                            'Call IOService::AddPersonalitiesFromKernelModule with malicious bundle',
                            'Kext executes in ring-0 before SIP validation',
                            'Disable SIP with csr_set_allow_all(1) from kext'
                        ],
                        'alternatives': [
                            'Check entitlements: codesign -d --entitlements - /usr/libexec/storagekitd',
                            'Monitor kext loads: log stream --predicate "subsystem == \'com.apple.kext\'"',
                            'Detect: kmutil showloaded | grep -v com.apple'
                        ],
                        'notes': 'CVE-2024-44243 (Sigma) discovered by Microsoft. storagekitd has com.apple.storagekitd.kernel-management entitlement allowing kext staging. SIP trust checks performed AFTER kext staging, allowing code execution. Patched in macOS Sequoia 15.2.'
                    }
                },
                {
                    'id': 'kext-2024-0day',
                    'name': 'CVE-2024-23225 - XNU VM Out-of-Bounds Write',
                    'type': 'command',
                    'metadata': {
                        'command': 'uname -r && sw_vers',
                        'description': 'Check for in-the-wild kernel 0-day (March 2024)',
                        'tags': ['OSCP:HIGH', 'CVE', 'MACOS'],
                        'flag_explanations': {
                            'uname -r': 'Display kernel version',
                            'sw_vers': 'Show macOS version'
                        },
                        'success_indicators': [
                            'macOS < 14.4 / 13.6.5 / 12.7.4 (vulnerable)',
                            'XNU kernel version < 23E214',
                            'Actively exploited in wild'
                        ],
                        'failure_indicators': [
                            'Patched version',
                            'ProductVersion >= 14.4 (Sonoma)',
                            'Cannot trigger OOB write'
                        ],
                        'next_steps': [
                            'Trigger via crafted XPC message to libxpc',
                            'OOB write in XNU virtual-memory subsystem',
                            'Obtain arbitrary kernel read/write',
                            'Bypass PAC/KTRR protections'
                        ],
                        'alternatives': [
                            'Check patch level: authenticate sudo sysctl kern.osversion',
                            'Mitigate: launchctl disable system/com.apple.analyticsd',
                            'Mitigate: launchctl disable system/com.apple.rtcreportingd',
                            'Update to macOS 14.4 or later'
                        ],
                        'notes': 'CVE-2024-23225: OOB write in XNU VM subsystem. CVE-2024-23296: RTKit memory corruption (paired exploit). Exploited in wild March 2024. Triggered via XPC message buffer overflow. Full chain: userspace → XPC → kernel OOB write → PAC bypass.'
                    }
                },
                {
                    'id': 'kext-mig-confusion',
                    'name': 'CVE-2023-41075 - MIG Type Confusion',
                    'type': 'command',
                    'metadata': {
                        'command': 'sw_vers | grep -E "(14.0|14.1|13.5|13.6)"',
                        'description': 'Check for MIG type confusion vulnerability in IOKit',
                        'tags': ['OSCP:MEDIUM', 'CVE', 'MACOS'],
                        'flag_explanations': {
                            'sw_vers': 'Show macOS version',
                            'grep -E': 'Match vulnerable versions'
                        },
                        'success_indicators': [
                            'macOS Sonoma 14.0-14.1 (vulnerable)',
                            'macOS Ventura 13.5-13.6 (vulnerable)',
                            'MIG glue-code exploitable'
                        ],
                        'failure_indicators': [
                            'Patched version (>= 14.2 or >= 13.7)',
                            'Cannot trigger type confusion',
                            'Mitigations active'
                        ],
                        'next_steps': [
                            'Send malformed mach_msg() to IOKit user client',
                            'Trigger type confusion in MIG-generated code',
                            'OOB write into kernel heap zones',
                            'Escalate to root via heap manipulation'
                        ],
                        'alternatives': [
                            'Heap spray: IOSurfaceFastSetValue',
                            'Spray ipc_kmsg buffers with port pointers',
                            'Overwrite ip_kobject of dangling port',
                            'Jump to shellcode via PAC-forged address'
                        ],
                        'notes': 'MIG (Mach Interface Generator) type confusion. Reply message reinterpreted with larger OOB descriptor. Public exploits weaponize via heap spraying. Leads to controlled kernel heap corruption and root escalation.'
                    }
                }
            ]
        })

        tasks['children'].append(kext_tasks)

        # ===== PHASE 3: APFS Sealed Snapshots =====
        snapshot_tasks = {
            'id': 'apfs-snapshots',
            'name': 'APFS Sealed System Snapshot Analysis',
            'type': 'parent',
            'children': []
        }

        # Task 3.1: List APFS snapshots
        snapshot_tasks['children'].append({
            'id': 'diskutil-apfs-list',
            'name': 'Enumerate APFS Volumes and Snapshots',
            'type': 'command',
            'metadata': {
                'command': 'diskutil apfs list',
                'description': 'List all APFS volumes, snapshots, and seal status',
                'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'diskutil': 'Disk utility for macOS',
                    'apfs': 'APFS filesystem operations',
                    'list': 'List all APFS containers and volumes'
                },
                'success_indicators': [
                    'Shows APFS containers with volumes',
                    'Snapshot information displayed',
                    'Seal status (Sealed: Yes/No/Broken) shown',
                    'Mount points identified'
                ],
                'failure_indicators': [
                    'No APFS volumes found (HFS+ system)',
                    'Permission denied',
                    'Incomplete snapshot information'
                ],
                'next_steps': [
                    'Identify System volume mount point (usually /System/Volumes/Update/mnt1)',
                    'Check Data volume mount (/System/Volumes/Data)',
                    'If seal broken: System modifications persist across reboot',
                    'Verify snapshot read-only status'
                ],
                'alternatives': [
                    'Manual: mount | grep apfs',
                    'Manual: ls -la /System/Volumes/',
                    'Manual: tmutil listlocalsnapshots /',
                    'Check seal: csrutil authenticated-root status'
                ],
                'notes': 'macOS Big Sur+ separates System (sealed snapshot, read-only) and Data (user data, writable). Snapshot mounted at /. Modifications to sealed snapshot prevent boot. Data/System separation simplifies updates.'
            }
        })

        # Task 3.2: Check snapshot mount status
        snapshot_tasks['children'].append({
            'id': 'snapshot-mount-check',
            'name': 'Verify Snapshot Mount and Read-Only Status',
            'type': 'command',
            'metadata': {
                'command': 'mount | grep -E "apfs.*(sealed|read-only)"',
                'description': 'Check if system snapshot is mounted read-only',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'mount': 'Display mounted filesystems',
                    'grep -E': 'Filter for APFS sealed/read-only mounts'
                },
                'success_indicators': [
                    'Snapshot mounted at / with "sealed" flag',
                    '"read-only" flag present',
                    'System volume immutable'
                ],
                'failure_indicators': [
                    'No sealed snapshot found',
                    'System volume writable',
                    'Seal broken or disabled'
                ],
                'next_steps': [
                    'If read-only: SIP bypass required for system modifications',
                    'If writable: Persistence in system directories possible',
                    'Check /System/Volumes/Data for writable locations',
                    'Attempt snapshot remount as writable'
                ],
                'alternatives': [
                    'Manual: diskutil apfs list | grep -A5 "Snapshot"',
                    'Manual: ls -l /System/Volumes/',
                    'Manual: stat /System to check filesystem',
                    'Check logs: log show --predicate "subsystem == \'com.apple.apfs\'" --last 1h'
                ],
                'notes': 'Sealed snapshot prevents tampering even with SIP bypass. System modifications require authenticated-root disabled + seal broken. User data in /System/Volumes/Data remains writable.'
            }
        })

        # Task 3.3: Attempt snapshot manipulation
        snapshot_tasks['children'].append({
            'id': 'snapshot-manipulation',
            'name': 'Test Snapshot Modification Capabilities',
            'type': 'manual',
            'metadata': {
                'description': 'Attempt to modify sealed system snapshot (requires SIP bypass)',
                'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                'steps': [
                    '1. Boot into Recovery Mode (Cmd+R)',
                    '2. Disable authenticated root: csrutil authenticated-root disable',
                    '3. Reboot into normal mode',
                    '4. Identify snapshot: diskutil apfs list',
                    '5. Mount snapshot writable: sudo mount -uw /',
                    '6. Modify system files',
                    '7. Create new snapshot: sudo bless --folder /System/Library/CoreServices --bootefi --create-snapshot',
                    '8. Reboot and verify modifications persist'
                ],
                'success_indicators': [
                    'authenticated-root disabled',
                    'Snapshot mounted writable',
                    'System files modified',
                    'New snapshot created',
                    'Modifications survive reboot'
                ],
                'failure_indicators': [
                    'Cannot disable authenticated-root without Recovery Mode',
                    'mount -uw fails (sealed snapshot)',
                    'Modifications lost on reboot',
                    'System fails to boot (seal broken)'
                ],
                'next_steps': [
                    'Install persistent rootkit in /System',
                    'Modify MRT (Malware Removal Tool)',
                    'Tamper with system daemons',
                    'Establish kernel-level persistence'
                ],
                'alternatives': [
                    'Mount over SIP-protected directories (old vulnerability)',
                    'Use installer package with Apple certificate',
                    'Abuse system_installd entitlements',
                    'Target /System/Volumes/Data for persistence instead'
                ],
                'notes': 'Snapshot modification requires: 1) SIP bypass, 2) authenticated-root disabled, 3) Recovery Mode access. Breaking seal prevents boot. Target /System/Volumes/Data for persistence without snapshot manipulation. Most practical: abuse writable exception paths within sealed snapshot.'
            }
        })

        tasks['children'].append(snapshot_tasks)

        # ===== PHASE 4: AMFI (AppleMobileFileIntegrity) =====
        amfi_tasks = {
            'id': 'amfi-enum',
            'name': 'AMFI (AppleMobileFileIntegrity) Analysis',
            'type': 'parent',
            'children': []
        }

        # Task 4.1: Check AMFI boot arguments
        amfi_tasks['children'].append({
            'id': 'amfi-boot-args',
            'name': 'Check AMFI Boot Arguments',
            'type': 'command',
            'metadata': {
                'command': 'sudo nvram boot-args | grep -iE "(amfi|cs_enforcement)"',
                'description': 'Check for AMFI-disabling boot arguments in NVRAM',
                'tags': ['OSCP:HIGH', 'MACOS'],
                'flag_explanations': {
                    'nvram': 'Non-Volatile RAM utility',
                    'boot-args': 'Kernel boot arguments variable',
                    'grep -iE': 'Case-insensitive search for AMFI flags'
                },
                'success_indicators': [
                    'amfi_get_out_of_my_way=1 found (AMFI disabled)',
                    'cs_enforcement_disable=1 found (code signing disabled)',
                    'amfi_allow_any_signature=1 found',
                    'amfi_unrestricted_task_for_pid=1 found'
                ],
                'failure_indicators': [
                    'No AMFI boot arguments present',
                    'AMFI fully enabled',
                    'Cannot modify boot-args (SIP protected)'
                ],
                'next_steps': [
                    'If AMFI disabled: Unsigned code execution possible',
                    'Test unsigned binary execution',
                    'Attempt task_for_pid without entitlements',
                    'Load unsigned dynamic libraries'
                ],
                'alternatives': [
                    'Check all boot args: sudo nvram -p',
                    'Recovery Mode: nvram boot-args="amfi_get_out_of_my_way=1"',
                    'Check AMFI kext: kmutil showloaded | grep AppleMobileFileIntegrity',
                    'Monitor AMFI: log stream --predicate "subsystem == \'com.apple.AMFI\'"'
                ],
                'notes': 'AMFI boot arguments: amfi_get_out_of_my_way=1 (disable all), cs_enforcement_disable=1 (disable code signing), amfi_allow_any_signature=1 (accept any signature), amfi_unrestricted_task_for_pid=1 (allow task_for_pid). Requires SIP disabled + NVRAM write access.'
            }
        })

        # Task 4.2: Enumerate AMFI dependencies
        amfi_tasks['children'].append({
            'id': 'amfi-dependencies',
            'name': 'Enumerate AMFI Kext Dependencies',
            'type': 'command',
            'metadata': {
                'command': 'kextstat | grep " 19 " | cut -c2-5,50- | cut -d "(" -f1',
                'description': 'Find kexts that depend on AMFI (potential attack surface)',
                'tags': ['OSCP:MEDIUM', 'MACOS'],
                'flag_explanations': {
                    'kextstat': 'List loaded kernel extensions (legacy)',
                    'grep " 19 "': 'Filter for AMFI kext index',
                    'cut': 'Extract dependency information'
                },
                'success_indicators': [
                    'List of AMFI-dependent kexts',
                    'Security-critical kexts identified',
                    'Attack surface enumerated'
                ],
                'failure_indicators': [
                    'kextstat deprecated (use kmutil)',
                    'Cannot determine dependencies',
                    'AMFI not loaded'
                ],
                'next_steps': [
                    'Research vulnerabilities in dependent kexts',
                    'Analyze Sandbox.kext (depends on AMFI)',
                    'Check AppleSystemPolicy.kext',
                    'Investigate EndpointSecurity.kext'
                ],
                'alternatives': [
                    'Modern: sudo kmutil showloaded --variant-suffix release | grep -A10 AppleMobileFileIntegrity',
                    'Check AMFI API consumers',
                    'Monitor AMFI mach messages: port 18 (HOST_AMFID_PORT)',
                    'Trace amfid daemon: sudo dtruss -p $(pgrep amfid)'
                ],
                'notes': 'AMFI.kext provides API for code signature verification. Key dependencies: Sandbox.kext (sandbox enforcement), AppleSystemPolicy.kext (Gatekeeper), EndpointSecurity.kext (ES framework). AMFI communicates with userspace amfid daemon via mach port 18.'
            }
        })

        # Task 4.3: Analyze amfid daemon
        amfi_tasks['children'].append({
            'id': 'amfid-analysis',
            'name': 'Analyze amfid Userspace Daemon',
            'type': 'command',
            'metadata': {
                'command': 'ps aux | grep amfid && sudo lsof -p $(pgrep amfid)',
                'description': 'Enumerate amfid daemon (user-mode AMFI code signature verification)',
                'tags': ['OSCP:MEDIUM', 'MACOS'],
                'flag_explanations': {
                    'ps aux': 'List all processes',
                    'grep amfid': 'Filter for amfid daemon',
                    'lsof -p': 'List open files for process',
                    'pgrep': 'Get PID by process name'
                },
                'success_indicators': [
                    'amfid process running as root',
                    'Mach port 18 (HOST_AMFID_PORT) open',
                    'libmis.dyld loaded (signature validation)',
                    'MobileDevice.framework loaded'
                ],
                'failure_indicators': [
                    'amfid not running (AMFI disabled)',
                    'Cannot inspect process (SIP)',
                    'Mach port not visible'
                ],
                'next_steps': [
                    'Monitor amfid mach messages: sudo dtruss -m mach_msg -p $(pgrep amfid)',
                    'Set breakpoint in mach_msg to inspect requests',
                    'Analyze libmis.dyld for bypass opportunities',
                    'Check provisioning profiles in /var/MobileDeviceProvisioningProfiles'
                ],
                'alternatives': [
                    'Check entitlements: codesign -d --entitlements - /usr/libexec/amfid',
                    'Dump CDHash: codesign -dvv /usr/libexec/amfid',
                    'Monitor logs: log stream --predicate "process == \'amfid\'"',
                    'Intercept MIG calls with LLDB'
                ],
                'notes': 'amfid runs in userspace for code signature verification. AMFI.kext sends requests via mach port 18. amfid uses libmis.dyld (inside MobileDevice.framework) for validation. Historically abused by jailbreaks via backdoored libmis. SIP protects special ports from hijacking.'
            }
        })

        # Task 4.4: Check provisioning profiles
        amfi_tasks['children'].append({
            'id': 'provisioning-profiles',
            'name': 'Enumerate Code Signing Provisioning Profiles',
            'type': 'command',
            'metadata': {
                'command': 'find /var/MobileDeviceProvisioningProfiles -name "*.mobileprovision" -o -name "*.provisionprofile" 2>/dev/null',
                'description': 'Find provisioning profiles used for code signing',
                'tags': ['OSCP:LOW', 'MACOS'],
                'flag_explanations': {
                    'find': 'Search filesystem',
                    '/var/MobileDeviceProvisioningProfiles': 'Standard profile location',
                    '-name': 'Match filename pattern',
                    '-o': 'OR operator for multiple patterns'
                },
                'success_indicators': [
                    'Provisioning profiles found',
                    'Developer or Enterprise profiles present',
                    'Profiles readable'
                ],
                'failure_indicators': [
                    'No profiles found',
                    'Directory doesn\'t exist (iOS-specific)',
                    'Profiles encrypted'
                ],
                'next_steps': [
                    'Dump profile: security cms -D -i <profile>',
                    'Extract entitlements from profile',
                    'Check for enterprise profile (ProvisionsAllDevices: true)',
                    'Identify developer certificates'
                ],
                'alternatives': [
                    'Parse profile: openssl asn1parse -inform der -in <profile>',
                    'Check embedded profile in app: codesign -d --entitlements - <app>',
                    'Extract from IPA: unzip app.ipa && cat Payload/*.app/embedded.mobileprovision',
                    'macOS location: ~/Library/MobileDevice/Provisioning\\ Profiles/'
                ],
                'notes': 'Provisioning profiles contain: AppIDName, DeveloperCertificates, Entitlements, ProvisionedDevices (developer) or ProvisionsAllDevices (enterprise). Enterprise profiles allow installation on any device. Profiles expire (ExpirationDate, TimeToLive fields).'
            }
        })

        tasks['children'].append(amfi_tasks)

        # ===== PHASE 5: Kernel Debugging & Exploitation =====
        debug_tasks = {
            'id': 'kernel-debug',
            'name': 'Kernel Debugging and Exploitation',
            'type': 'parent',
            'children': []
        }

        # Task 5.1: Check kernel debugging status
        debug_tasks['children'].append({
            'id': 'kernel-debug-check',
            'name': 'Check Kernel Debugging Configuration',
            'type': 'command',
            'metadata': {
                'command': 'sudo nvram boot-args | grep -iE "(debug|kdp)" && sysctl kern.bootargs',
                'description': 'Check if kernel debugging is enabled via boot arguments',
                'tags': ['OSCP:MEDIUM', 'MACOS'],
                'flag_explanations': {
                    'nvram boot-args': 'Read boot arguments from NVRAM',
                    'grep -iE': 'Search for debug/KDP flags',
                    'sysctl kern.bootargs': 'Show active kernel boot arguments'
                },
                'success_indicators': [
                    'debug=0x144 found (kernel debugging enabled)',
                    'kdp_match_name set (KDP target specified)',
                    'kcsuffix=development (development kernel)',
                    '-v found (verbose boot)'
                ],
                'failure_indicators': [
                    'No debug flags in boot-args',
                    'Kernel debugging disabled',
                    'SIP prevents kernel debugging'
                ],
                'next_steps': [
                    'Enable debugging: sudo nvram boot-args="debug=0x144 kdp_match_name=target"',
                    'Attach LLDB over KDP (Kernel Debug Protocol)',
                    'Set breakpoints in kernel code',
                    'Live kernel memory inspection'
                ],
                'alternatives': [
                    'Check all sysctl: sysctl -a | grep kern',
                    'Verify KASLR: sysctl kern.kaslr_enable (should be 1)',
                    'Check panic logs: ls -la /Library/Logs/DiagnosticReports/',
                    'Development kernel: csrutil enable --without debug (from Recovery)'
                ],
                'notes': 'Common debug boot-args: debug=0x144 (kernel debugging), debug=0x100 (enable KDP), kdp_match_name=<name> (KDP target), kcsuffix=development (dev kernel). Requires SIP disabled or csrutil enable --without debug. KDP requires Thunderbolt/USB-C connection to host Mac.'
            }
        })

        # Task 5.2: Setup kernel debugging
        debug_tasks['children'].append({
            'id': 'kernel-debug-setup',
            'name': 'Setup Remote Kernel Debugging (KDP)',
            'type': 'manual',
            'metadata': {
                'description': 'Configure remote kernel debugging via KDP over Thunderbolt/USB-C',
                'tags': ['OSCP:LOW', 'MANUAL', 'MACOS'],
                'steps': [
                    '1. Download and install Kernel Debug Kit (KDK) matching target macOS version',
                    '   - Source: github.com/dortania/KdkSupportPkg/releases',
                    '   - Mount DMG, extract with Suspicious Package tool',
                    '2. On target Mac: sudo nvram boot-args="debug=0x100 kdp_match_name=target-mac"',
                    '3. Reboot target Mac',
                    '4. Connect target and host Mac with Thunderbolt or USB-C cable',
                    '5. On host Mac: lldb',
                    '6. (lldb) kdp-remote "udp://target-mac"',
                    '7. (lldb) bt  # Get kernel backtrace',
                    '8. (lldb) register read  # Inspect registers',
                    '9. Set breakpoints: (lldb) b <function_name>',
                    '10. Continue execution: (lldb) continue'
                ],
                'success_indicators': [
                    'KDP connection established',
                    'LLDB attached to kernel_task',
                    'Can read kernel memory',
                    'Breakpoints hit successfully'
                ],
                'failure_indicators': [
                    'KDP connection timeout',
                    'Wrong KDK version (symbols mismatch)',
                    'SIP blocks kernel debugging',
                    'Cable/network issues'
                ],
                'next_steps': [
                    'Load kext symbols: target modules load --file <kext> --slide <addr>',
                    'Identify kext load address: sudo kmutil showloaded',
                    'Set breakpoint in kext: b kext_function',
                    'Dump kernel structures: memory read <address>',
                    'Trigger vulnerability to hit breakpoint'
                ],
                'alternatives': [
                    'One-shot panic analysis: sudo kdpwrit dump latest.kcdata',
                    'Symbolicate panic: kmutil analyze-panic latest.kcdata -o report.txt',
                    'VM debugging: Debug kernel in VM without KDP',
                    'DTrace for live tracing (limited by SIP)'
                ],
                'notes': 'KDP (Kernel Debug Protocol) provides read-only kernel access. Cannot write memory or dynamically patch. For dynamic instrumentation: patch binary on-disk, use kernel function hooking (mach_override), or migrate to hypervisor. KDK must EXACTLY match target macOS build.'
            }
        })

        # Task 5.3: Analyze kernel panic logs
        debug_tasks['children'].append({
            'id': 'kernel-panic-analysis',
            'name': 'Analyze Kernel Panic Reports',
            'type': 'command',
            'metadata': {
                'command': 'ls -lth /Library/Logs/DiagnosticReports/Kernel*.panic | head -5',
                'description': 'Find and list recent kernel panic logs for vulnerability indicators',
                'tags': ['OSCP:MEDIUM', 'MACOS'],
                'flag_explanations': {
                    'ls': 'List directory contents',
                    '-lth': 'Long format, sorted by time (newest first), human-readable sizes',
                    'head -5': 'Show only 5 most recent panics'
                },
                'success_indicators': [
                    'Recent panic logs found',
                    'Panic reports readable',
                    'Crash information available'
                ],
                'failure_indicators': [
                    'No panic logs (stable system)',
                    'Logs cleared/rotated',
                    'Permission denied'
                ],
                'next_steps': [
                    'Symbolicate panic: kmutil analyze-panic <panic.kcdata> -o report.txt',
                    'Identify crashed kext/module',
                    'Check for exploitable crashes (heap overflow, UAF)',
                    'Search panic signature in CVE databases',
                    'Reproduce panic with crafted input'
                ],
                'alternatives': [
                    'View panic: cat /Library/Logs/DiagnosticReports/Kernel_*.panic',
                    'Parse kcdata: sudo kdpwrit dump latest.kcdata',
                    'Check Console.app for panic details',
                    'System logs: log show --predicate "subsystem == \'com.apple.kernel\'" --last 1d'
                ],
                'notes': 'Kernel panic logs in /Library/Logs/DiagnosticReports/. Format: Kernel_YYYY-MM-DD-HHMMSS_<hostname>.panic or .kcdata. Panic reports contain: backtrace, register state, loaded kexts, panic string. Look for: heap corruption, NULL dereference, page faults in specific kexts.'
            }
        })

        # Task 5.4: Kernel fuzzing preparation
        debug_tasks['children'].append({
            'id': 'kernel-fuzzing',
            'name': 'Kernel Fuzzing Toolkit Setup',
            'type': 'manual',
            'metadata': {
                'description': 'Setup tools for kernel vulnerability research and fuzzing',
                'tags': ['OSCP:LOW', 'RESEARCH', 'MACOS'],
                'steps': [
                    '1. Install Luftrauser (Mach message fuzzer)',
                    '   - Source: github.com/preshing/luftrauser',
                    '   - Targets MIG subsystems',
                    '2. Setup oob-executor (IPC OOB primitive generator)',
                    '   - Used in CVE-2024-23225 research',
                    '3. Install kmutil for kext analysis',
                    '   - Built-in on macOS 11+',
                    '   - Usage: kmutil inspect -b <bundle_id>',
                    '4. Setup syzkaller for macOS (if available)',
                    '   - Kernel system call fuzzer',
                    '5. Configure development kernel',
                    '   - Boot-args: kcsuffix=development debug=0x144',
                    '6. Install AFL++ or Honggfuzz for userspace fuzzing',
                    '   - Target AMFI, XPC services, IOKit user clients'
                ],
                'success_indicators': [
                    'Fuzzing tools installed',
                    'Development kernel running',
                    'Can fuzz MIG subsystems',
                    'Crash monitoring active'
                ],
                'failure_indicators': [
                    'Tools incompatible with macOS version',
                    'Cannot enable development kernel',
                    'SIP blocks fuzzing',
                    'Crashes not captured'
                ],
                'next_steps': [
                    'Fuzz IOKit user clients: Luftrauser + IOConnectCallMethod',
                    'Target MIG interfaces: search for mach_msg handlers',
                    'Fuzz XPC services: enumerate with launchctl list',
                    'Monitor for panics: tail -f /Library/Logs/DiagnosticReports/Kernel*',
                    'Triage crashes with kmutil analyze-panic'
                ],
                'alternatives': [
                    'Static analysis: Ghidra/IDA on extracted kexts',
                    'Code review: XNU source code (opensource.apple.com)',
                    'Past CVE study: Search "macOS kernel CVE" on Google',
                    'Bug bounty: Submit findings to Apple Security Bounty'
                ],
                'notes': 'Key fuzzing targets: IOKit user clients (IOConnectCallMethod), MIG subsystems (mach_msg), XPC services (launchd), AMFI (code signature validation). Development kernel required for verbose debugging. Reference: Apple Platform Security Guide, *OS Internals series, The Mac Hacker\'s Handbook.'
            }
        })

        tasks['children'].append(debug_tasks)

        # ===== PHASE 6: Exploitation Workflow =====
        exploit_tasks = {
            'id': 'kernel-exploit',
            'name': 'Kernel Exploitation Workflow',
            'type': 'parent',
            'children': []
        }

        # Task 6.1: Identify kernel version and patch level
        exploit_tasks['children'].append({
            'id': 'kernel-version',
            'name': 'Identify Kernel Version and Build',
            'type': 'command',
            'metadata': {
                'command': 'uname -a && sw_vers && sysctl kern.osversion kern.osrelease kern.version',
                'description': 'Comprehensive kernel and OS version enumeration for CVE matching',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'MACOS'],
                'flag_explanations': {
                    'uname -a': 'Print all system information',
                    'sw_vers': 'macOS version details',
                    'sysctl': 'Query kernel parameters',
                    'kern.osversion': 'Build version (e.g., 23E214)',
                    'kern.osrelease': 'Darwin kernel version',
                    'kern.version': 'Full kernel version string with build date'
                },
                'success_indicators': [
                    'Full version information displayed',
                    'Build number identified',
                    'Darwin kernel version shown',
                    'Architecture confirmed (x86_64 or arm64)'
                ],
                'failure_indicators': [
                    'Incomplete version information',
                    'Cannot determine patch level'
                ],
                'next_steps': [
                    'Cross-reference build number with CVE databases',
                    'Check Apple security updates page for patch status',
                    'Search exploitdb: searchsploit macos <version>',
                    'Identify unpatched CVEs for kernel version'
                ],
                'alternatives': [
                    'Manual: system_profiler SPSoftwareDataType',
                    'Manual: cat /System/Library/CoreServices/SystemVersion.plist',
                    'Manual: About This Mac from Apple menu',
                    'Check patch level: sw_vers -productVersion'
                ],
                'notes': 'Build version (kern.osversion) is critical for CVE matching. Format: <major><minor><patch><letter><build>. Example: 23E214 = macOS 14.4 (Sonoma). Cross-reference with support.apple.com/en-us/HT201222 for security updates.'
            }
        })

        # Task 6.2: Search for exploits
        exploit_tasks['children'].append({
            'id': 'exploit-search',
            'name': 'Search Exploit Databases',
            'type': 'command',
            'metadata': {
                'command': 'searchsploit macos kernel && searchsploit xnu',
                'description': 'Search ExploitDB for macOS kernel exploits',
                'tags': ['OSCP:HIGH', 'RESEARCH', 'MACOS'],
                'flag_explanations': {
                    'searchsploit': 'Search ExploitDB local database',
                    'macos kernel': 'Search term for macOS kernel exploits',
                    'xnu': 'Search for XNU kernel exploits'
                },
                'success_indicators': [
                    'Relevant exploits found',
                    'PoC code available',
                    'Exploits match kernel version'
                ],
                'failure_indicators': [
                    'No exploits found for version',
                    'Exploits outdated/patched',
                    'No public exploits available'
                ],
                'next_steps': [
                    'Download exploit: searchsploit -m <EDB-ID>',
                    'Read exploit code and requirements',
                    'Check if exploit matches kernel version',
                    'Compile and test exploit',
                    'Search GitHub for PoCs: github.com/search?q=macos+kernel+exploit'
                ],
                'alternatives': [
                    'Online: exploit-db.com',
                    'GitHub: Search "macOS CVE-<year>-<number>"',
                    'Packet Storm: packetstormsecurity.com',
                    'Google: "macOS <version> kernel exploit site:github.com"',
                    'CVE Details: cvedetails.com/vendor/49/Apple.html'
                ],
                'notes': 'Key exploits: CVE-2024-44243 (Sigma/storagekitd), CVE-2024-23225 (XNU VM OOB), CVE-2023-41075 (MIG type confusion), CVE-2021-30892 (Shrootless), CVE-2022-22583 (installer). Check exploit requirements: SIP status, macOS version, architecture.'
            }
        })

        # Task 6.3: Privilege escalation post-exploit
        exploit_tasks['children'].append({
            'id': 'privesc-post-exploit',
            'name': 'Post-Exploitation Privilege Escalation',
            'type': 'manual',
            'metadata': {
                'description': 'Leverage kernel access for complete system compromise',
                'tags': ['OSCP:HIGH', 'PRIVESC', 'MACOS'],
                'steps': [
                    '1. Disable SIP from kernel context',
                    '   - Call csr_set_allow_all(1)',
                    '   - Or clear csr-active-config in NVRAM',
                    '2. Disable AMFI',
                    '   - Set boot-args: amfi_get_out_of_my_way=1',
                    '   - Or patch AMFI.kext in memory',
                    '3. Elevate to root',
                    '   - Patch process credentials in kernel',
                    '   - Or inject into root process via task port',
                    '4. Bypass Gatekeeper',
                    '   - Remove quarantine xattr: xattr -d com.apple.quarantine',
                    '   - Or disable Gatekeeper: spctl --master-disable',
                    '5. Install persistence',
                    '   - Rootkit in /System (SIP bypass required)',
                    '   - Launch daemon: /Library/LaunchDaemons/',
                    '   - Kext: /Library/Extensions/ (requires approval)',
                    '6. Dump credentials',
                    '   - Keychain: security dump-keychain -d',
                    '   - Memory: Dump process memory for secrets',
                    '7. Disable logging/forensics',
                    '   - Clear logs: rm -rf /var/log/*',
                    '   - Disable unified logging: log erase --all'
                ],
                'success_indicators': [
                    'SIP disabled from kernel',
                    'Root shell obtained',
                    'Persistence established',
                    'Credentials dumped',
                    'System fully compromised'
                ],
                'failure_indicators': [
                    'Cannot patch kernel structures',
                    'SIP re-enables on reboot',
                    'Persistence detected and removed',
                    'Kernel panic on manipulation'
                ],
                'next_steps': [
                    'Establish C2 communication',
                    'Lateral movement to other devices',
                    'Data exfiltration',
                    'Cover tracks and anti-forensics'
                ],
                'alternatives': [
                    'User-mode persistence: LaunchAgents instead of LaunchDaemons',
                    'TCC bypass: Direct database manipulation',
                    'Keychain access: Abuse get-task-allow entitlement',
                    'Non-kernel persistence: Login items, cron, .zshrc'
                ],
                'notes': 'With kernel access: full system control. Priorities: 1) Disable SIP/AMFI, 2) Elevate to root, 3) Install persistence, 4) Dump credentials, 5) Cover tracks. Kernel-level persistence survives most cleanups but risky (kernel panics). User-mode persistence more stable. Document all actions for OSCP writeup.'
            }
        })

        tasks['children'].append(exploit_tasks)

        # ===== PHASE 7: Research & Documentation =====
        research_tasks = {
            'id': 'research-docs',
            'name': 'Research and Documentation',
            'type': 'parent',
            'children': []
        }

        # Task 7.1: Download references
        research_tasks['children'].append({
            'id': 'download-references',
            'name': 'Download macOS Security References',
            'type': 'manual',
            'metadata': {
                'description': 'Collect essential macOS security research resources',
                'tags': ['OSCP:LOW', 'RESEARCH', 'MACOS'],
                'steps': [
                    '1. Apple Platform Security Guide',
                    '   - https://support.apple.com/guide/security/welcome/web',
                    '   - Official documentation on security features',
                    '2. XNU Source Code',
                    '   - https://opensource.apple.com/source/xnu/',
                    '   - Darwin kernel source for code review',
                    '3. *OS Internals (Jonathan Levin)',
                    '   - http://newosxbook.com/',
                    '   - Volume I: User Mode',
                    '   - Volume III: Security & Insecurity',
                    '4. The Mac Hacker\'s Handbook',
                    '   - Classic reference for macOS exploitation',
                    '5. Kernel Debug Kit (KDK)',
                    '   - github.com/dortania/KdkSupportPkg/releases',
                    '   - Required for kernel debugging',
                    '6. Apple Security Updates',
                    '   - https://support.apple.com/en-us/HT201222',
                    '   - Track patched vulnerabilities',
                    '7. Security Research Blogs',
                    '   - Objective-See: objective-see.com/blog.html',
                    '   - Pwn2Own results: zerodayinitiative.com',
                    '   - Google Project Zero: googleprojectzero.blogspot.com'
                ],
                'success_indicators': [
                    'Key references downloaded',
                    'Documentation accessible offline',
                    'Research papers collected'
                ],
                'failure_indicators': [
                    'Resources unavailable',
                    'Links broken',
                    'Cannot download'
                ],
                'next_steps': [
                    'Study SIP bypass techniques',
                    'Review CVE write-ups',
                    'Practice kernel debugging',
                    'Analyze XNU source code for vulnerabilities'
                ],
                'alternatives': [
                    'Books: "The Art of Mac Malware" by Patrick Wardle',
                    'Courses: Offensive Security macOS exploitation',
                    'CTF: Practice kernel exploitation challenges',
                    'Bug bounty: Apple Security Bounty program'
                ],
                'notes': 'Essential reading order: 1) Apple Security Guide (understand protections), 2) *OS Internals Vol III (exploitation), 3) CVE write-ups (real-world examples), 4) XNU source (code-level understanding). Objective-See blog by Patrick Wardle is gold mine for macOS security research.'
            }
        })

        # Task 7.2: Setup research VM
        research_tasks['children'].append({
            'id': 'research-vm-setup',
            'name': 'Setup macOS Research Virtual Machine',
            'type': 'manual',
            'metadata': {
                'description': 'Create isolated macOS environment for kernel research',
                'tags': ['OSCP:LOW', 'RESEARCH', 'MACOS'],
                'steps': [
                    '1. Choose VM platform',
                    '   - VMware Fusion (Intel/ARM)',
                    '   - Parallels Desktop (ARM native)',
                    '   - VirtualBox (Intel only, limited)',
                    '2. Download macOS installer',
                    '   - App Store: Latest macOS',
                    '   - IPSW.me: Specific versions',
                    '3. Create VM with development settings',
                    '   - 4+ CPU cores',
                    '   - 8+ GB RAM',
                    '   - 60+ GB disk',
                    '4. Disable SIP in VM',
                    '   - Boot Recovery: Cmd+R',
                    '   - csrutil disable',
                    '   - csrutil authenticated-root disable',
                    '5. Install development tools',
                    '   - Xcode: xcode-select --install',
                    '   - Homebrew: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"',
                    '   - Python 3: brew install python3',
                    '6. Install research tools',
                    '   - Ghidra: brew install --cask ghidra',
                    '   - IDA Free: hex-rays.com/ida-free/',
                    '   - Hopper: brew install --cask hopper-disassembler',
                    '7. Snapshot VM for recovery',
                    '   - Create "Clean Development" snapshot',
                    '   - Snapshot before each exploit test'
                ],
                'success_indicators': [
                    'VM running macOS',
                    'SIP disabled',
                    'Development tools installed',
                    'Snapshot created'
                ],
                'failure_indicators': [
                    'Cannot disable SIP in VM',
                    'VM performance issues',
                    'Tools incompatible'
                ],
                'next_steps': [
                    'Test kernel exploits safely in VM',
                    'Practice kext loading',
                    'Experiment with SIP bypasses',
                    'Restore from snapshot after kernel panics'
                ],
                'alternatives': [
                    'Physical Mac: Dedicated test machine',
                    'Cloud: MacStadium or similar (expensive)',
                    'Docker: Limited, macOS container restrictions',
                    'Hackintosh: Legal gray area, hardware dependent'
                ],
                'notes': 'VM essential for kernel research - prevents bricking physical Mac. Snapshots critical - kernel exploits cause panics. VMware Fusion best for Intel, Parallels for Apple Silicon. Always test in VM before physical hardware. SIP disabled in VM != production environment.'
            }
        })

        tasks['children'].append(research_tasks)

        return tasks


# Module exports
__all__ = ['MacOSKernelSecurityPlugin']
