# iOS App Analysis Plugin Documentation

**Plugin Name:** `ios-app-analysis`
**Version:** 1.0
**Generated by:** CrackPot v1.0
**Date:** 2025-10-07

---

## Overview

The iOS App Analysis plugin provides comprehensive security testing tasks for iOS applications, focusing on app-level vulnerabilities and runtime analysis. This complements the existing `ios_binary_exploit`, `ios_hooking`, and `ios_pentesting` plugins by focusing specifically on:

- **App Extensions** (Custom Keyboards, Share, Widgets)
- **WebView Security** (UIWebView, WKWebView, SFSafariViewController)
- **Serialization/Encoding** (NSCoding, NSSecureCoding, Codable)
- **Entitlements Extraction** (from compiled binaries)
- **Static Analysis** (Binary flags, class dump, strings)
- **Dynamic Analysis** (Frida, Objection, SSL pinning bypass)

---

## Statistics

- **Source Files Mined:** 4 HackTricks markdown files (501 lines total)
- **Output Plugin:** 2,147 lines
- **Tasks Generated:** 75 tasks
- **Task Sections:** 6 major categories
- **OSCP Metadata:** Full flag explanations, manual alternatives, success/failure indicators

---

## Detection Criteria

The plugin detects iOS testing opportunities based on:

```python
# Service/version indicators
- 'ios' in service name
- 'iphone' or 'ipad' in service
- 'darwin' in version string
- 'mobile' in service
- SSH port (22) with iOS device
- usbmuxd port (62078)
```

**Default Ports:** 22 (SSH), 62078 (usbmuxd)

**Service Names:** `['ios', 'ios-app', 'mobile', 'iphone', 'ipad']`

---

## Task Categories

### 1. App Extensions Analysis (16 tasks)

**Purpose:** Security testing of iOS app extensions

**Key Tasks:**
- Identify app extensions (`.appex` files, `NSExtensionPointIdentifier`)
- Analyze data sharing (App Groups, shared containers)
- Test extension restrictions (keyboard restrictions, widget permissions)
- Dynamic analysis (Frida IPC tracing, Objection exploration)

**Notable Commands:**
```bash
# Find extensions
find /var/containers/Bundle/Application -name '*.appex' -type d

# Search for extension identifiers
grep -r NSExtensionPointIdentifier /var/containers/Bundle/Application/*/Info.plist

# Hook extension input
frida -U -n Extension -l hook_extension_input.js
```

**Security Focus:**
- Custom keyboards have network access (data exfiltration risk)
- Shared containers may expose sensitive data
- Extensions communicate via XPC (inter-process communication)

---

### 2. WebView Security Analysis (28 tasks)

**Purpose:** Comprehensive WebView vulnerability testing

**Subtasks:**

#### a) WebView Type Identification
- `rabin2 -zz AppBinary | egrep "UIWebView$"` - **CRITICAL:** UIWebView is deprecated, vulnerable to XSS
- `rabin2 -zz AppBinary | egrep "WKWebView$"` - Modern, secure WebView
- `rabin2 -zz AppBinary | egrep "SFSafariViewController"` - Full Safari (most secure)

#### b) Configuration Checks
- **JavaScript enablement:** `grep -i "javascriptenabled"` - Should be disabled unless required
- **Secure content:** `grep -i "hasonlysecurecontent"` - Detects mixed content (HTTP in HTTPS)
- **File URL access:** `grep -i "allowFileAccessFromFileURLs"` - **CRITICAL VULN** if enabled

#### c) Protocol Handler Testing
- `loadHTMLString`, `loadData`, `loadRequest`, `loadFileURL` method identification
- Test file:// URL access for local file disclosure
- Test custom schemes (tel://, sms://, app-scheme://)

#### d) JavaScript Bridge Analysis
- **UIWebView:** JSContext bridge (`[webView valueForKeyPath:@"javaScriptContext"]`)
- **WKWebView:** WKScriptMessageHandler (`window.webkit.messageHandlers`)
- Test for command injection via JS bridge

#### e) Dynamic Testing
- Heap inspection: `ObjC.choose(ObjC.classes.WKWebView)`
- Safari Web Inspector debugging (requires macOS)

**Critical Vulnerabilities:**
1. **UIWebView usage** - Automatically vulnerable to XSS (JS cannot be disabled)
2. **allowUniversalAccessFromFileURLs=true** - Can read ANY file accessible to app
3. **Unvalidated JS bridge** - Command injection, privilege escalation
4. **loadFileURL with directory path** - Entire directory readable

---

### 3. Serialization & Encoding Analysis (15 tasks)

**Purpose:** Test object persistence security

**Serialization Methods:**
- **NSCoding** - Legacy, vulnerable to deserialization attacks
- **NSSecureCoding** - Type-safe deserialization (but no encryption/signing)
- **Swift Codable** - Modern, clean JSON/PropertyList serialization
- **NSKeyedArchiver** - File persistence

**Key Security Tests:**

#### a) Find Serialization Usage
```bash
rabin2 -zz AppBinary | grep -i "NSCoding\|encodeWithCoder\|initWithCoder"
rabin2 -zz AppBinary | grep -i "NSSecureCoding\|supportsSecureCoding"
rabin2 -zz AppBinary | grep -i "Codable\|JSONEncoder"
```

#### b) Locate Serialized Files
```bash
find /var/mobile/Containers/Data/Application -name '*.plist' -o -name '*.archive'
```

#### c) Test Deserialization Attacks
- NSCoding: Type confusion, object injection
- Modify archived files and reload
- Check for HMAC/signature (usually missing)

#### d) Third-Party Library Checks
- JSON libraries: Generally safe
- XML parsing: **XXE vulnerability** if external entities enabled

**Critical Checks:**
- NSSecureCoding `supportsSecureCoding` must return `true`
- Use `decodeObjectOfClass:forKey:` NOT `decodeObject:forKey:`
- Serialized data should be encrypted at rest
- Add HMAC for integrity (NSSecureCoding doesn't provide this)

---

### 4. Entitlements Analysis (13 tasks)

**Purpose:** Extract and analyze app permissions

**Extraction Methods (work on encrypted binaries!):**

#### a) Binary Extraction
```bash
# Binwalk (automatic)
binwalk -e -y=xml AppBinary

# Radare2 (manual)
r2 -qc 'izz~PropertyList' AppBinary

# Grep (on device, works on encrypted!)
grep -a -A 50 'PropertyList' AppBinary
```

#### b) Mobile Provision Extraction
```bash
# Find profile
find /var/containers/Bundle/Application -name embedded.mobileprovision

# Decode PKCS#7
security cms -D -i embedded.mobileprovision

# Extract just entitlements
security cms -D -i embedded.mobileprovision | plutil -extract Entitlements xml1 -o - --
```

**Security Analysis Checklist:**

1. **App Groups** (`com.apple.security.application-groups`)
   - Check for excessive data sharing
   - Review shared container contents
   - Verify encryption

2. **Keychain Access** (`keychain-access-groups`)
   - Should be scoped to app only
   - Check for cross-app sharing
   - Verify `kSecAttrAccessible` flags

3. **Network Entitlements**
   - VPN capabilities should only be in VPN apps
   - Network extensions = powerful (can intercept all traffic)

4. **Dangerous Entitlements**
   - `get-task-allow` = **CRITICAL VULN** (debuggable in production)
   - `task_for_pid-allow` (private)
   - `run-unsigned-code`
   - `com.apple.private.*` (suspicious without Apple approval)

---

### 5. Static Analysis Tasks (4 tasks)

**Binary Security Checks:**
```bash
# Check security flags
otool -hv AppBinary  # Look for PIE (ASLR), stack canaries

# Class dump (Objective-C)
class-dump AppBinary -H -o headers/

# Strings analysis
strings AppBinary | grep -iE "password|secret|token|api_key"

# Info.plist review
plutil -p Info.plist  # Check ATS, URL schemes, permissions
```

**Key Checks:**
- PIE flag set (position-independent executable for ASLR)
- Stack canaries enabled
- No hardcoded credentials/API keys
- App Transport Security (ATS) properly configured
- URL schemes validated in code

---

### 6. Dynamic Analysis Tasks (4 tasks)

**Runtime Testing Setup:**

#### a) Frida Setup
```bash
# Verify connection
frida-ps -U

# Attach to app
frida -U -n AppName

# Load script
frida -U -n AppName -l hook_script.js
```

#### b) Objection (High-level Frida wrapper)
```bash
# Start interactive session
objection -g AppName explore

# Useful commands:
ios info binary              # App info
ios hooking list classes     # List all classes
ios keychain dump            # Extract keychain
ios nsuserdefaults get       # Dump preferences
ios cookies get              # Extract cookies
ios plist cat /path/to/file  # Read plist
```

#### c) SSL Pinning Bypass
```bash
# Objection (automatic)
objection -g AppName explore --startup-command "ios sslpinning disable"

# Manual Frida script
frida -U -f com.app.bundle -l ssl-pinning-bypass.js
```

#### d) Jailbreak Detection Bypass
```bash
# Objection
objection -g AppName explore --startup-command "ios jailbreak disable"

# Alternative: Cydia tweaks (Liberty Lite, Shadow)
```

---

## OSCP Exam Preparation Features

Every task includes:

1. **Flag Explanations:** What each command-line flag does and WHY
2. **Manual Alternatives:** 2-3 alternative approaches (for when tools fail)
3. **Success Indicators:** 2+ signs the command worked
4. **Failure Indicators:** 2+ common failure modes
5. **Next Steps:** 3-5 follow-up actions
6. **Notes:** Context, tool sources, exam tips

**Example Task Metadata:**
```python
{
    'command': 'rabin2 -zz AppBinary | egrep "UIWebView$"',
    'description': 'Detect deprecated UIWebView (vulnerable to XSS)',
    'tags': ['OSCP:HIGH', 'QUICK_WIN', 'VULN'],
    'flag_explanations': {
        'rabin2': 'Binary analysis tool (part of radare2)',
        '-zz': 'Extract all strings including data sections',
        'egrep "UIWebView$"': 'Match class name at end of line'
    },
    'success_indicators': [
        'UIWebView class references found',
        'String offsets displayed'
    ],
    'failure_indicators': [
        'No matches (app uses WKWebView)',
        'Binary encrypted (decrypt first)'
    ],
    'next_steps': [
        'Report as vulnerability (UIWebView deprecated iOS 12+)',
        'Check for JavaScript enablement',
        'Test for XSS via loadHTMLString'
    ],
    'alternatives': [
        'Manual: strings AppBinary | grep UIWebView',
        'class-dump: class-dump AppBinary | grep UIWebView',
        'Source: grep -r UIWebView *.m'
    ],
    'notes': 'UIWebView = CRITICAL VULN - JS cannot be disabled'
}
```

---

## Notable Vulnerabilities Covered

1. **UIWebView XSS** - Deprecated but still in legacy apps, JavaScript cannot be disabled
2. **WKWebView File Disclosure** - `allowUniversalAccessFromFileURLs=true` allows reading any file
3. **NSCoding Deserialization** - Type confusion, object injection attacks
4. **XXE in XML Parsers** - External entity injection if not disabled
5. **get-task-allow Entitlement** - Production apps debuggable (memory dump, code injection)
6. **App Groups Data Leakage** - Sensitive data in shared containers
7. **JavaScript Bridge Injection** - Unvalidated native method calls from JS
8. **SSL Pinning Bypass** - Traffic interception via Frida/Objection

---

## Integration with Existing Plugins

**Complements (no overlap):**

- **ios_binary_exploit.py** - Binary-level exploitation (buffer overflows, ROP chains)
- **ios_hooking.py** - Runtime method hooking, swizzling
- **ios_pentesting.py** - General iOS testing methodology

**This plugin focuses on:** Application-layer security (extensions, WebViews, serialization, entitlements)

---

## Usage Example

```bash
# 1. Create target profile
crack track new ios-device.local

# 2. Import scan (if SSH detected with iOS indicators)
crack track import ios-device.local scan.xml

# 3. Plugin auto-detects iOS and generates 75 tasks:
#    - App Extensions: 16 tasks
#    - WebView Analysis: 28 tasks
#    - Serialization: 15 tasks
#    - Entitlements: 13 tasks
#    - Static Analysis: 4 tasks
#    - Dynamic Analysis: 4 tasks

# 4. View tasks
crack track show ios-device.local

# 5. Execute task
crack track run ios-device.local find-uiwebview-22

# 6. Document findings (source required!)
crack track finding ios-device.local \
  --type vulnerability \
  --description "UIWebView usage found (XSS risk)" \
  --source "rabin2 -zz analysis: 0x00123456"

# 7. Export OSCP writeup
crack track export ios-device.local > ios_writeup.md
```

---

## Tool Requirements

**Binary Analysis:**
- radare2 (rabin2, r2)
- binwalk
- class-dump (Objective-C)
- dsdump (Swift)
- otool (macOS/Xcode)

**Device Access:**
- SSH (jailbroken device)
- USB forwarding (usbmuxd)

**Runtime Analysis:**
- Frida (frida, frida-ps, frida-trace)
- Objection
- Cycript (alternative)

**macOS Tools:**
- security (cms decode)
- plutil (plist manipulation)
- Safari (Web Inspector debugging)

**Optional:**
- iFunBox / iExplorer (file browsing)
- Burp Suite (traffic interception)
- Cydia tweaks (SSL Kill Switch, Liberty Lite)

---

## Educational Notes

**Why This Plugin?**

iOS app security testing requires understanding multiple frameworks:
- UIKit (UIWebView, SFSafariViewController)
- WebKit (WKWebView, JavaScript bridge)
- Foundation (NSCoding, NSKeyedArchiver)
- Security (Entitlements, Keychain)

This plugin provides **complete workflows** from identification to exploitation, with OSCP exam focus (manual alternatives when tools fail, command explanations, time awareness).

**Key Takeaways:**

1. **UIWebView is always vulnerable** (report even if no active exploit)
2. **Entitlements extraction works on encrypted binaries** (grep -a)
3. **NSSecureCoding doesn't encrypt** (common misconception)
4. **get-task-allow=true in production = critical vuln** (full debugger access)
5. **App Groups share data** (check for sensitive info in shared containers)

---

## References

**HackTricks Sources:**
- `mobile-pentesting/ios-pentesting/ios-app-extensions.md` (57 lines)
- `mobile-pentesting/ios-pentesting/ios-webviews.md` (313 lines)
- `mobile-pentesting/ios-pentesting/ios-serialisation-and-encoding.md` (81 lines)
- `mobile-pentesting/ios-pentesting/extracting-entitlements-from-compiled-application.md` (50 lines)

**Apple Documentation:**
- iOS Security Guide
- App Extension Programming Guide
- WebKit Framework Reference
- Entitlements Reference

**OWASP:**
- OWASP MASTG (Mobile Application Security Testing Guide)
- iOS Platform Interaction Testing

---

**Generated:** 2025-10-07 by CrackPot v1.0
**Plugin File:** `/home/kali/OSCP/crack/track/services/ios_app_analysis.py`
**Total Lines:** 2,147
**Total Tasks:** 75
**Status:** Production Ready
