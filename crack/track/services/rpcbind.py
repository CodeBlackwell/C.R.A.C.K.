"""
RPCbind/Portmapper service enumeration plugin

Generates tasks for RPCbind enumeration including:
- RPC service discovery (rpcinfo)
- NIS (Network Information Service) enumeration
- NFS share discovery
- RPC user enumeration (rusersd)
- Filtered port bypass techniques

Extracted from HackTricks: pentesting-rpcbind.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class RPCbindPlugin(ServicePlugin):
    """RPCbind/Portmapper enumeration plugin"""

    @property
    def name(self) -> str:
        return "rpcbind"

    @property
    def default_ports(self) -> List[int]:
        return [111, 32771]

    @property
    def service_names(self) -> List[str]:
        return ['rpcbind', 'portmap', 'portmapper', 'sunrpc']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect RPCbind/Portmapper services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate RPCbind enumeration task tree"""
        version = service_info.get('version', '')
        os_type = service_info.get('ostype', '')

        tasks = {
            'id': f'rpcbind-enum-{port}',
            'name': f'RPCbind/Portmapper Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: Basic RPC Service Enumeration
        tasks['children'].append({
            'id': f'rpcinfo-{port}',
            'name': 'Enumerate RPC Services',
            'type': 'command',
            'metadata': {
                'command': f'rpcinfo {target}',
                'description': 'List all RPC services registered with portmapper',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                'flag_explanations': {
                    'rpcinfo': 'Query RPC portmapper for registered services',
                    f'{target}': 'Target IP/hostname',
                },
                'success_indicators': [
                    'List of RPC programs (nfs, mountd, ypserv, rusersd, etc.)',
                    'Program numbers, versions, and ports shown',
                    'Protocol types (tcp/udp) displayed',
                ],
                'failure_indicators': [
                    'rpcinfo: can\'t contact portmapper (service down)',
                    'No response (firewalled)',
                    'Empty program list',
                ],
                'next_steps': [
                    'If NFS found: Enumerate shares (see NFS tasks below)',
                    'If ypserv (NIS) found: Attack NIS domain (see NIS tasks)',
                    'If rusersd found: Enumerate users (see rusersd tasks)',
                    'Check for vulnerable RPC services: rpcbind 2.x CVEs',
                ],
                'alternatives': [
                    f'rpcinfo -p {target}  # Detailed program/version/port list',
                    f'nmap -sSUC -p {port} {target}  # Nmap RPC enumeration',
                ],
                'notes': 'Port 111/TCP+UDP is portmapper (maps RPC program numbers to ports). NFS, NIS, mountd commonly found. Oracle Solaris uses 32771 instead of 111.',
                'estimated_time': '1-2 minutes'
            }
        })

        # TASK 2: Detailed Nmap RPC Scan
        tasks['children'].append({
            'id': f'nmap-rpc-{port}',
            'name': 'Detailed Nmap RPC Scan',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sSUC -p {port} {target}',
                'description': 'Comprehensive RPC enumeration with NSE scripts',
                'tags': ['OSCP:HIGH', 'ENUM', 'AUTOMATED'],
                'flag_explanations': {
                    '-sS': 'TCP SYN scan',
                    '-sU': 'UDP scan (portmapper is TCP+UDP)',
                    '-C': 'Equivalent to -sC (default NSE scripts)',
                    f'-p {port}': 'Target port',
                },
                'success_indicators': [
                    'RPC program list with versions',
                    'OS fingerprint (Unix variant)',
                    'NFS/NIS/RPC services identified',
                ],
                'failure_indicators': [
                    'Port filtered',
                    'No RPC services found',
                ],
                'next_steps': [
                    'Identify Unix OS variant (Solaris, Linux, AIX, HP-UX)',
                    'Check for NFS shares',
                    'Look for NIS domain',
                    'Enumerate discovered RPC services',
                ],
                'alternatives': [
                    f'nmap --script rpc-grind {target}  # Brute-force RPC program numbers',
                    f'rpcinfo -p {target}',
                ],
                'notes': 'Portmapper reveals OS type + running services. Critical for Unix pentests. Often leads to NFS share enumeration.',
                'estimated_time': '3-5 minutes'
            }
        })

        # TASK 3: NFS Share Discovery (if NFS detected)
        tasks['children'].append({
            'id': f'rpc-nfs-{port}',
            'name': 'NFS Share Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'showmount-{port}',
                    'name': 'List NFS Exports',
                    'type': 'command',
                    'metadata': {
                        'command': f'showmount -e {target}',
                        'description': 'List exported NFS shares (if nfs/mountd found)',
                        'tags': ['OSCP:HIGH', 'ENUM', 'NFS'],
                        'flag_explanations': {
                            'showmount': 'Query NFS mountd for exported filesystems',
                            '-e': 'Show export list',
                        },
                        'success_indicators': [
                            'Export list displayed',
                            'Share paths shown (/, /home, /var, etc.)',
                            'Access restrictions listed (everyone, specific IPs)',
                        ],
                        'failure_indicators': [
                            'clnt_create: RPC: Program not registered (NFS not running)',
                            'mount.nfs: access denied by server',
                            'Timeout',
                        ],
                        'next_steps': [
                            'Mount accessible shares: mount -t nfs {target}:/path /mnt/nfs',
                            'Check for sensitive files: /etc/passwd, /root/.ssh, /home',
                            'Look for writable shares (upload backdoor)',
                            'See NFS plugin tasks for detailed enumeration',
                        ],
                        'alternatives': [
                            f'nmap --script nfs-ls,nfs-showmount {target}',
                            f'rpcinfo -p {target} | grep nfs  # Check if NFS running',
                        ],
                        'notes': 'NFS often exports /, /home with weak ACLs. Mount with no_root_squash = root access. See port 2049 NFS plugin for full workflow.',
                    }
                },
                {
                    'id': f'nfs-access-{port}',
                    'name': 'Test NFS Share Access',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Manually mount and explore NFS shares',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'NFS'],
                        'success_indicators': [
                            'Share mounted successfully',
                            'Files accessible',
                            'Write access gained (writable share)',
                        ],
                        'next_steps': [
                            'mkdir /mnt/nfs',
                            'mount -t nfs {target}:/<share_path> /mnt/nfs',
                            'ls -la /mnt/nfs',
                            'Check permissions: touch /mnt/nfs/test.txt',
                            'Search for creds: grep -r password /mnt/nfs',
                            'If writable: Upload reverse shell, SSH key, etc.',
                        ],
                        'alternatives': [
                            'Use NFS plugin tasks (port 2049) for comprehensive enumeration',
                        ],
                        'notes': 'Root squashing disabled = UID 0 preserved. Create user with matching UID on attacker box to bypass permissions. Unmount: umount /mnt/nfs',
                    }
                }
            ]
        })

        # TASK 4: NIS (Network Information Service) Enumeration
        tasks['children'].append({
            'id': f'rpc-nis-{port}',
            'name': 'NIS (ypserv) Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'nis-domain-discover-{port}',
                    'name': 'Discover NIS Domain Name',
                    'type': 'manual',
                    'metadata': {
                        'description': 'NIS requires domain name to query (critical first step)',
                        'tags': ['OSCP:HIGH', 'MANUAL', 'NIS'],
                        'success_indicators': [
                            'Domain name found (from config, DNS, brute-force)',
                            'ypbind responds to domain query',
                        ],
                        'next_steps': [
                            'Check common domains: domain.local, company name, "default"',
                            'Brute-force: for d in $(cat domains.txt); do ypwhich -d $d {target} 2>&1 | grep -v "not running"; done',
                            'DNS TXT records: dig TXT +short {target}',
                            'Sniff network traffic for NIS packets',
                            'Once found, proceed to password extraction',
                        ],
                        'alternatives': [
                            'Guess domain: company name, hostname, "default", "localdomain"',
                        ],
                        'notes': 'NIS (Yellow Pages) stores user/password hashes centrally. Domain name is not secret but required for queries. Without it, NIS enumeration fails.',
                    }
                },
                {
                    'id': f'nis-passwd-{port}',
                    'name': 'Extract NIS Password Hashes',
                    'type': 'command',
                    'metadata': {
                        'command': f'# Install: apt-get install nis\n# Verify NIS server:\nypwhich -d <NIS_DOMAIN> {target}\n# Extract password hashes:\nypcat -d <NIS_DOMAIN> -h {target} passwd.byname',
                        'description': 'Dump encrypted user passwords from NIS',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'NIS'],
                        'flag_explanations': {
                            'apt-get install nis': 'Install NIS client tools',
                            'ypwhich -d <NIS_DOMAIN>': 'Verify NIS server responds to domain',
                            'ypcat': 'Extract NIS maps (databases)',
                            '-d <NIS_DOMAIN>': 'Specify NIS domain name',
                            '-h': 'Specify NIS server IP',
                            'passwd.byname': 'NIS map containing password hashes',
                        },
                        'success_indicators': [
                            'Password hashes dumped (user:encryptedpass format)',
                            'Unix crypt/MD5/SHA hashes extracted',
                            'Root account hash obtained',
                        ],
                        'failure_indicators': [
                            'ypwhich: can\'t communicate with ypbind (domain wrong)',
                            'No such map (passwd.byname not exported)',
                            'Access denied',
                        ],
                        'next_steps': [
                            'Crack hashes: john --wordlist=rockyou.txt nis-passwd.txt',
                            'Identify hash type: $1$ = MD5, $6$ = SHA-512',
                            'Extract other maps: ypcat -d <DOMAIN> -h {target} hosts.byname',
                            'Get group info: ypcat -d <DOMAIN> -h {target} group.byname',
                        ],
                        'alternatives': [
                            'Manually query: ypcat passwd.byname (if NIS client configured)',
                            'Extract all maps: ypcat -x (list available maps)',
                        ],
                        'notes': 'NIS transmits hashes in plaintext. Common maps: passwd.byname, passwd.byuid, group.byname, hosts.byname, mail.aliases. Target root account first.',
                        'estimated_time': '5-10 minutes (plus cracking time)'
                    }
                },
                {
                    'id': f'nis-maps-{port}',
                    'name': 'Enumerate Other NIS Maps',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Extract additional NIS databases (hosts, groups, etc.)',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'NIS'],
                        'success_indicators': [
                            'Hosts database extracted (internal network IPs)',
                            'Group memberships revealed',
                            'Mail aliases discovered',
                        ],
                        'next_steps': [
                            'ypcat -d <DOMAIN> -h {target} hosts.byname  # Internal IPs',
                            'ypcat -d <DOMAIN> -h {target} hosts.byaddr  # Reverse lookup',
                            'ypcat -d <DOMAIN> -h {target} group.byname  # Group memberships',
                            'ypcat -d <DOMAIN> -h {target} group.bygid',
                            'ypcat -d <DOMAIN> -h {target} mail.aliases  # Email aliases',
                            'Build network map from hosts data',
                            'Identify privileged groups (wheel, sudo, admin)',
                        ],
                        'alternatives': [
                            'List all maps: ypcat -x',
                        ],
                        'notes': 'NIS maps per HackTricks: passwd (UIDs), group (GIDs), hosts (network topology), mail.aliases (email routing). Group.byname reveals admin users.',
                    }
                }
            ]
        })

        # TASK 5: RPC User Enumeration (rusersd)
        tasks['children'].append({
            'id': f'rpc-rusersd-{port}',
            'name': 'RPC User Enumeration (rusersd)',
            'type': 'parent',
            'children': [
                {
                    'id': f'rusers-{port}',
                    'name': 'Enumerate Logged-In Users',
                    'type': 'command',
                    'metadata': {
                        'command': f'rusers {target}',
                        'description': 'List currently logged-in users via rusersd',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'RPC'],
                        'flag_explanations': {
                            'rusers': 'Query rusersd RPC service for user list',
                        },
                        'success_indicators': [
                            'List of logged-in users',
                            'Usernames, terminals, login times shown',
                        ],
                        'failure_indicators': [
                            'rusersd: RPC: Program not registered',
                            'No users logged in',
                            'Service not running',
                        ],
                        'next_steps': [
                            'Build username wordlist for brute-force',
                            'Check for active admin sessions',
                            'Monitor login patterns (timing for attacks)',
                            'Cross-reference with NIS passwd data',
                        ],
                        'alternatives': [
                            f'rpcinfo {target} | grep rusersd  # Check if service running',
                            f'nmap --script rpc-grind {target}',
                        ],
                        'notes': 'rusersd (port varies, check rpcinfo). Shows active users like "who" command remotely. Rare service but valuable for user enumeration. See port 1026 for detailed rusersd pentesting.',
                    }
                }
            ]
        })

        # TASK 6: Bypass Filtered Portmapper
        tasks['children'].append({
            'id': f'rpc-bypass-{port}',
            'name': 'Bypass Filtered Portmapper (Advanced)',
            'type': 'manual',
            'metadata': {
                'description': 'Access NFS when port 111 is filtered but NFS ports open',
                'tags': ['OSCP:LOW', 'ADVANCED', 'BYPASS'],
                'success_indicators': [
                    'Local portmapper tunnel created',
                    'NFS shares accessible via tunnel',
                    'Standard tools work through tunnel',
                ],
                'next_steps': [
                    '1. Scan for open NFS ports: nmap -p 2049,32768-33000 {target}',
                    '2. Setup local portmapper: rpcbind (install if needed)',
                    '3. Create SSH tunnel: ssh -L 111:localhost:111 user@{target}',
                    '4. Simulate portmapper responses locally',
                    '5. Use standard NFS tools through localhost',
                    'Full guide: https://medium.com/@sebnemK/how-to-bypass-filtered-portmapper-port-111-27cee52416bc',
                ],
                'alternatives': [
                    'Direct NFS mount if port known: mount -t nfs -o port=2049 {target}:/share /mnt',
                    'Use nmap to find NFS ports, bypass portmapper entirely',
                ],
                'notes': 'Technique: NFS ports open but portmapper filtered. Simulate portmapper locally, tunnel NFS traffic. Complex setup. Last resort when standard enumeration fails.',
            }
        })

        # TASK 7: Shodan Reconnaissance
        tasks['children'].append({
            'id': f'rpc-shodan-{port}',
            'name': 'Shodan/Censys RPC Reconnaissance',
            'type': 'manual',
            'metadata': {
                'description': 'Find exposed RPC services on internet',
                'tags': ['OSCP:LOW', 'RESEARCH', 'RECON'],
                'success_indicators': [
                    'Exposed portmapper services found',
                    'NIS servers identified',
                    'NFS exports discovered',
                ],
                'next_steps': [
                    'Shodan: port:111 portmap',
                    'Shodan: port:111 nfs',
                    'Shodan: port:111 ypserv',
                    'Censys: services.port:111',
                    'Check if target IP in results',
                    'Verify findings with rpcinfo',
                ],
                'alternatives': [
                    'Censys.io web interface',
                    'Google: site:shodan.io portmap nfs',
                ],
                'notes': 'Thousands of exposed portmapper services exist. Often lead to open NFS shares with sensitive data. Report insecure NFS exports.',
            }
        })

        # TASK 8: Configuration Analysis
        tasks['children'].append({
            'id': f'rpc-config-{port}',
            'name': 'RPC Configuration Analysis',
            'type': 'manual',
            'metadata': {
                'description': 'Review RPC config files if file access exists',
                'tags': ['OSCP:LOW', 'POST_EXPLOIT', 'MANUAL'],
                'success_indicators': [
                    'RPC service configs found',
                    'Access controls identified',
                    'NIS domain revealed',
                ],
                'next_steps': [
                    'Check /etc/rpc (RPC program name mappings)',
                    'Check /etc/default/nfs (NFS server config)',
                    'Check /etc/exports (NFS export list with permissions)',
                    'Check /var/yp/<domain> (NIS maps on server)',
                    'Check /etc/default/nis (NIS client/server config)',
                    'Look for weak export rules: *(rw,no_root_squash)',
                ],
                'alternatives': [
                    'If shell: cat /etc/exports',
                    'If shell: ypcat -x (list NIS maps)',
                ],
                'notes': '/etc/exports shows NFS ACLs. *(rw,no_root_squash) = world-writable as root (critical). NIS config in /etc/default/nis or /etc/yp.conf.',
            }
        })

        return tasks
