"""
NTP service enumeration plugin

Generates tasks for NTP enumeration including:
- Basic time synchronization checks
- Monlist amplification detection (CVE/DDoS vector)
- NTP version detection and CVE lookup
- Configuration analysis
- NTS (Network Time Security) reconnaissance

Extracted from HackTricks: pentesting-ntp.md
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class NTPPlugin(ServicePlugin):
    """NTP (Network Time Protocol) enumeration plugin"""

    @property
    def name(self) -> str:
        return "ntp"

    @property
    def default_ports(self) -> List[int]:
        return [123, 4460]

    @property
    def service_names(self) -> List[str]:
        return ['ntp', 'ntpd', 'chrony', 'chronyd', 'timesyncd', 'nts-ke']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect NTP services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check ports (123/udp for NTP, 4460/tcp for NTS-KE)
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate NTP enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', '')

        tasks = {
            'id': f'ntp-enum-{port}',
            'name': f'NTP Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # Determine if this is NTS-KE port (4460/tcp) or standard NTP (123/udp)
        is_nts_ke = (port == 4460)

        if is_nts_ke:
            # NTS-KE (Network Time Security Key Establishment) - Port 4460/TCP
            tasks['children'].append({
                'id': f'nts-ke-enum-{port}',
                'name': 'NTS-KE TLS Reconnaissance',
                'type': 'parent',
                'children': [
                    {
                        'id': f'nts-tls-scan-{port}',
                        'name': 'Enumerate TLS Ciphers and Certificate',
                        'type': 'command',
                        'metadata': {
                            'command': f'nmap -sV -p {port} --script ssl-enum-ciphers,ssl-cert {target}',
                            'description': 'Enumerate NTS-KE TLS configuration (RFC 8915)',
                            'tags': ['OSCP:LOW', 'ENUM', 'TLS'],
                            'flag_explanations': {
                                '-sV': 'Service version detection',
                                '--script ssl-enum-ciphers': 'List supported TLS cipher suites',
                                '--script ssl-cert': 'Extract TLS certificate info',
                            },
                            'success_indicators': [
                                'TLS 1.3 supported (required for NTS)',
                                'AEAD ciphers listed (AES-GCM, ChaCha20-Poly1305)',
                                'Valid certificate found',
                            ],
                            'failure_indicators': [
                                'No TLS support',
                                'Weak ciphers (non-AEAD)',
                                'Self-signed or expired certificate',
                            ],
                            'next_steps': [
                                'Check for weak cipher suites (non-AEAD = vulnerable)',
                                'Verify certificate validity and issuer',
                                'Test ALPN protocol: openssl s_client -connect {target}:4460 -alpn ntske/1',
                            ],
                            'alternatives': [
                                f'openssl s_client -connect {target}:4460 -alpn ntske/1 -tls1_3',
                                f'testssl.sh {target}:4460',
                            ],
                            'notes': 'NTS moves crypto to TLS 1.3 on port 4460. Check for CVE-2023-33192 (ntpd-rs DoS via malformed NTS cookie). Self-signed certs are common but risky.',
                        }
                    }
                ]
            })
            return tasks

        # Standard NTP enumeration (port 123/UDP)

        # TASK 1: Basic NTP Query
        tasks['children'].append({
            'id': f'ntp-readvar-{port}',
            'name': 'NTP Basic Information Query',
            'type': 'command',
            'metadata': {
                'command': f'ntpq -c readvar {target}',
                'description': 'Query NTP server status and variables',
                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'ENUM'],
                'flag_explanations': {
                    'ntpq': 'NTP query tool (standard with ntpd)',
                    '-c readvar': 'Read server variables (version, stratum, peers)',
                },
                'success_indicators': [
                    'Server responds with variables',
                    'Version identified',
                    'Stratum level shown (1-16, lower = more accurate)',
                    'Reference clock listed',
                ],
                'failure_indicators': [
                    'Timeout / no response',
                    'Connection refused',
                    'Access denied (restrict noquery)',
                ],
                'next_steps': [
                    'Check stratum (1=GPS/atomic, 16=unsynchronized)',
                    'Identify version for CVE research',
                    'Query peer list: ntpq -c peers {target}',
                    'Check associations: ntpq -c associations {target}',
                ],
                'alternatives': [
                    f'ntpq -c rv {target}  # Short form',
                    f'nmap --script ntp-info {target} -p {port}',
                    f'chronyc -n tracking -h {target}  # If chrony detected',
                ],
                'notes': 'Port 123/UDP. ntpq talks to ntpd. chronyc talks to chronyd. Version critical for CVE matching. Stratum 16 = not synced (suspicious).',
                'estimated_time': '1-2 minutes'
            }
        })

        # TASK 2: Peer Enumeration
        tasks['children'].append({
            'id': f'ntp-peers-{port}',
            'name': 'Enumerate NTP Peers',
            'type': 'command',
            'metadata': {
                'command': f'ntpq -c peers {target}',
                'description': 'List upstream NTP servers (attack surface discovery)',
                'tags': ['OSCP:MEDIUM', 'ENUM'],
                'flag_explanations': {
                    '-c peers': 'List peer time sources',
                },
                'success_indicators': [
                    'Peer list displayed',
                    'IP addresses of upstream NTP servers',
                    'Reachability flags shown',
                ],
                'failure_indicators': [
                    'Empty peer list',
                    'Access denied',
                    'No response',
                ],
                'next_steps': [
                    'Check peer diversity (single source = poisoning risk)',
                    'Test if peers are reachable externally',
                    'Look for private IPs (internal network topology)',
                    'Check associations for more detail: ntpq -c associations {target}',
                ],
                'alternatives': [
                    f'nmap --script ntp-monlist {target} -p {port}  # Legacy mode-7',
                    f'chronyc -n sources -v -h {target}  # chrony equivalent',
                ],
                'notes': 'Peers with "*" are active synchronization sources. Fewer than 4 peers = RFC 8633 BCP violation (poisoning risk).',
            }
        })

        # TASK 3: Monlist Amplification Check (CRITICAL CVE/DDoS)
        tasks['children'].append({
            'id': f'ntp-monlist-{port}',
            'name': 'Check for Monlist Amplification (CVE)',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sU -p {port} --script ntp-monlist {target}',
                'description': 'Test for legacy mode-7 monlist (DDoS amplification vector)',
                'tags': ['OSCP:HIGH', 'VULN_SCAN', 'CRITICAL'],
                'flag_explanations': {
                    '-sU': 'UDP scan (NTP is UDP)',
                    '--script ntp-monlist': 'Query mode-7 monlist command',
                },
                'success_indicators': [
                    'VULNERABLE - monlist returned 600 host addresses',
                    'Large response (200x amplification factor)',
                    'Output shows client IPs that queried server',
                ],
                'failure_indicators': [
                    'Monlist disabled (good security)',
                    'No response to mode-7 queries',
                    'Empty monlist (no clients recorded)',
                ],
                'next_steps': [
                    'If VULNERABLE: Report to network owner (DDoS vector)',
                    'Mitigation: Upgrade to ntp 4.2.8p15+ and add "disable monitor"',
                    'Check if this is amplifier used in wild: Shodan "port:123 monlist:true"',
                    'Test amplification: compare request size (8 bytes) to response size (428-468 bytes/entry)',
                ],
                'alternatives': [
                    f'ntpdc -c monlist {target}  # Direct mode-7 query (often blocked)',
                    f'ntpdc -c listpeers {target}',
                    f'zgrab2 ntp --monlist --timeout 3 -f targets.txt',
                ],
                'notes': 'CRITICAL: monlist returns up to 600 host IPs with ~200x amplification. Used in 2024 5.6 Tbps Cloudflare DDoS. Disabled by default in ntp 4.2.7+. Legacy deployments still vulnerable.',
                'estimated_time': '2-3 minutes'
            }
        })

        # TASK 4: Legacy Mode-7 Enumeration
        tasks['children'].append({
            'id': f'ntp-mode7-{port}',
            'name': 'Legacy Mode-7 Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'ntpdc-sysinfo-{port}',
                    'name': 'Query System Information',
                    'type': 'command',
                    'metadata': {
                        'command': f'ntpdc -c sysinfo {target}',
                        'description': 'Get NTP system stats (mode-7, often disabled)',
                        'tags': ['OSCP:MEDIUM', 'ENUM'],
                        'flag_explanations': {
                            'ntpdc': 'Legacy NTP control protocol client (mode-7)',
                            '-c sysinfo': 'Get system information',
                        },
                        'success_indicators': [
                            'System stats displayed',
                            'Uptime, packet counts shown',
                        ],
                        'failure_indicators': [
                            'Timed out (mode-7 disabled)',
                            'Connection refused',
                        ],
                        'next_steps': [
                            'Try other mode-7 commands: listpeers, kerninfo',
                            'If all fail: Mode-7 properly disabled (good security)',
                        ],
                        'alternatives': [
                            f'ntpdc -c listpeers {target}',
                            f'ntpdc -c kerninfo {target}',
                        ],
                        'notes': 'Mode-7 deprecated and often disabled (>= ntpd 4.2.8p9). Use ntpq (mode-6) instead. If mode-7 works, server is outdated.',
                    }
                }
            ]
        })

        # TASK 5: Chrony-Specific Enumeration (if detected)
        if 'chrony' in product.lower():
            tasks['children'].append({
                'id': f'chrony-enum-{port}',
                'name': 'Chrony-Specific Enumeration',
                'type': 'parent',
                'children': [
                    {
                        'id': f'chronyc-tracking-{port}',
                        'name': 'Chrony Tracking Status',
                        'type': 'command',
                        'metadata': {
                            'command': f'chronyc -a -n tracking -h {target}',
                            'description': 'Query chrony synchronization status',
                            'tags': ['OSCP:MEDIUM', 'ENUM'],
                            'flag_explanations': {
                                'chronyc': 'Chrony control client (modern alternative to ntpd)',
                                '-a': 'Enable authentication',
                                '-n': 'Disable DNS resolution',
                                'tracking': 'Show tracking status',
                                '-h': 'Specify host',
                            },
                            'success_indicators': [
                                'Reference ID shown',
                                'Stratum level displayed',
                                'System time offset shown',
                            ],
                            'failure_indicators': [
                                'Access denied (cmdallow not configured)',
                                'Connection refused',
                            ],
                            'next_steps': [
                                'Check sources: chronyc -a -n sources -v -h {target}',
                                'Check sourcestats: chronyc -a -n sourcestats -h {target}',
                            ],
                            'alternatives': [
                                f'chronyc -a -n sources -v -h {target}',
                                f'nmap --script ntp-info {target}',
                            ],
                            'notes': 'Chrony is default in modern Linux (RHEL 8+, Ubuntu 18+). Only limited commands work remotely (require cmdallow in config). Most admin commands need local access.',
                        }
                    }
                ]
            })

        # TASK 6: Comprehensive Nmap NTP Scripts
        tasks['children'].append({
            'id': f'nmap-ntp-{port}',
            'name': 'Comprehensive Nmap NTP Scripts',
            'type': 'command',
            'metadata': {
                'command': f'nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p {port} {target}',
                'description': 'Run all safe NTP enumeration and vulnerability scripts',
                'tags': ['OSCP:HIGH', 'VULN_SCAN', 'AUTOMATED'],
                'flag_explanations': {
                    '-sU': 'UDP scan (NTP is UDP-based)',
                    '-sV': 'Version detection',
                    '--script "ntp* and (discovery or vuln) and not (dos or brute)"': 'Run discovery + vuln scripts, exclude DoS and brute-force',
                },
                'success_indicators': [
                    'Scripts executed successfully',
                    'Vulnerabilities detected',
                    'Version and config info gathered',
                ],
                'failure_indicators': [
                    'No response (service down or firewalled)',
                    'All scripts timeout',
                ],
                'next_steps': [
                    'Review ntp-info output for version',
                    'Check ntp-monlist for amplification',
                    'Analyze any CVEs reported',
                ],
                'alternatives': [
                    f'nmap -sU -p {port} --script ntp-monlist {target}  # Just monlist check',
                    f'nmap -sU -p {port} --script ntp-info {target}  # Just info',
                ],
                'notes': 'Combines: ntp-info (version), ntp-monlist (amplification), and other discovery scripts. UDP scans slower than TCP.',
                'estimated_time': '5-10 minutes'
            }
        })

        # TASK 7: CVE Research (Version-Specific)
        if version:
            tasks['children'].append({
                'id': f'ntp-cve-{port}',
                'name': f'CVE Research: {product} {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-ntp-{port}',
                        'name': f'SearchSploit: {product} {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit ntp {version}',
                            'description': 'Search exploit-db for known NTP exploits',
                            'tags': ['OSCP:HIGH', 'RESEARCH'],
                            'flag_explanations': {
                                'searchsploit': 'Local exploit-db search',
                                f'{version}': 'Target version',
                            },
                            'success_indicators': [
                                'Exploits found for version',
                                'CVE numbers listed',
                            ],
                            'failure_indicators': [
                                'No exploits found',
                            ],
                            'next_steps': [
                                'Review exploit details: searchsploit -x <EDB-ID>',
                                'Check CVEs: CVE-2023-26551 to CVE-2023-26555 (ntpq OOB writes)',
                                'CVE-2023-33192: ntpd-rs DoS via NTS cookie',
                            ],
                            'alternatives': [
                                'Google: "ntp {version} exploit"',
                                'NVD: https://nvd.nist.gov/vuln/search/results?query=ntp+{version}',
                            ],
                            'notes': 'Focus on: CVE-2023-26551-55 (ntp 4.2.8p15 libntp OOB writes), CVE-2023-33192 (ntpd-rs < 0.3.3 NTS DoS). Upgrade to 4.2.8p16+ or latest chrony.',
                        }
                    }
                ]
            })

        # TASK 8: Configuration File Analysis
        tasks['children'].append({
            'id': f'ntp-config-{port}',
            'name': 'Examine NTP Configuration Files',
            'type': 'manual',
            'metadata': {
                'description': 'Review NTP config if file access exists (SSH/FTP/NFS)',
                'tags': ['OSCP:LOW', 'POST_EXPLOIT', 'MANUAL'],
                'success_indicators': [
                    'Restrict directives found (access controls)',
                    'Peer IPs discovered',
                    'NTS configuration identified',
                ],
                'next_steps': [
                    'Check /etc/ntp.conf (ntpd)',
                    'Check /etc/chrony/chrony.conf (chrony)',
                    'Check /etc/systemd/timesyncd.conf (timesyncd - client only)',
                    'Look for: restrict lines (ACLs), disable monitor, kod (Kiss-o-Death)',
                    'Check peer count (< 4 = RFC 8633 violation)',
                    'Verify NTS enabled: nts enable, nts keys /etc/ntp/nts.key',
                ],
                'alternatives': [
                    'If shell: cat /etc/ntp.conf | grep -v "^#"',
                    'If shell: cat /etc/chrony/chrony.conf | grep -v "^#"',
                ],
                'notes': 'Good config has: restrict default noquery kod limited, disable monitor, >= 4 diverse peers, NTS enabled. Bad: no restrictions, monlist enabled, single peer (SPOF).',
            }
        })

        # TASK 9: Time-Shift Attack Detection (Advanced)
        tasks['children'].append({
            'id': f'ntp-timeshif-{port}',
            'name': 'Time-Shift Attack Analysis',
            'type': 'manual',
            'metadata': {
                'description': 'Detect on-path time manipulation (Khronos/Chronos research)',
                'tags': ['OSCP:LOW', 'ADVANCED', 'MITM'],
                'success_indicators': [
                    'Suspicious time drift detected',
                    'Inconsistent responses from peers',
                    'Leap-second state anomalies',
                ],
                'next_steps': [
                    'Query multiple times: ntpq -c rv {target} (repeat 10x, check consistency)',
                    'Compare offset values across queries',
                    'Check for panic events in logs (if accessible)',
                    'Modern chrony 4.4+ has maxdistance/maxjitter filters',
                ],
                'alternatives': [
                    'Shodan/Censys: Find other NTP servers to cross-check time',
                    'Use diverse NTP pools for validation',
                ],
                'notes': 'Even with NTS, on-path attacker can delay packets to shift time. Khronos draft proposes diverse server checks. RFC 8633 recommends >= 4 peers to detect manipulation. Check for sudden time jumps > 1000s (panic threshold).',
            }
        })

        # TASK 10: Shodan/Censys Reconnaissance
        tasks['children'].append({
            'id': f'ntp-shodan-{port}',
            'name': 'Shodan/Censys NTP Reconnaissance',
            'type': 'manual',
            'metadata': {
                'description': 'Find vulnerable NTP servers on internet',
                'tags': ['OSCP:LOW', 'RESEARCH', 'RECON'],
                'success_indicators': [
                    'Vulnerable servers identified',
                    'Monlist-enabled hosts found',
                    'NTS-KE servers discovered',
                ],
                'next_steps': [
                    'Shodan: port:123 "ntpd"',
                    'Shodan: port:123 monlist:true  # Vulnerable to amplification',
                    'Censys: services.port:123 AND services.service_name:NTP',
                    'Shodan: port:4460 "ntske"  # NTS-KE servers',
                    'Check if target IP in results',
                ],
                'alternatives': [
                    'Censys.io web interface',
                    'Google: site:shodan.io ntp monlist',
                ],
                'notes': 'Thousands of monlist-enabled servers still exist (2024 data). Used in reflection DDoS. Report findings to ISPs/CERT.',
            }
        })

        return tasks
