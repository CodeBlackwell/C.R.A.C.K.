"""
MongoDB NoSQL database service enumeration plugin

Generates tasks for MongoDB enumeration including:
- Database listing (mongodb-databases NSE script)
- Server information and statistics (mongodb-info)
- Authentication bypass testing (no-auth misconfiguration)
- Manual enumeration via mongo shell
- Data extraction from collections

Extracted from: Nmap Cookbook Chapter 5 - Auditing Databases
Generated by: CrackPot v1.0
Date: 2025-10-08
"""

from typing import Dict, Any, List
from .base import ServicePlugin
from .registry import ServiceRegistry


@ServiceRegistry.register
class MongoDBPlugin(ServicePlugin):
    """MongoDB NoSQL database enumeration plugin"""

    @property
    def name(self) -> str:
        return "mongodb"

    @property
    def default_ports(self) -> List[int]:
        return [27017, 27018, 27019, 28017]

    @property
    def service_names(self) -> List[str]:
        return ['mongodb', 'mongo', 'mongod']

    def detect(self, port_info: Dict[str, Any]) -> bool:
        """Detect MongoDB services"""
        service = port_info.get('service', '').lower()
        port = port_info.get('port')

        # Check service name
        if any(svc in service for svc in self.service_names):
            return True

        # Check common ports
        if port in self.default_ports:
            return True

        return False

    def get_task_tree(self, target: str, port: int, service_info: Dict[str, Any]) -> Dict[str, Any]:
        """Generate MongoDB enumeration task tree"""
        version = service_info.get('version', '')
        product = service_info.get('product', 'MongoDB')

        tasks = {
            'id': f'mongodb-enum-{port}',
            'name': f'MongoDB Enumeration (Port {port})',
            'type': 'parent',
            'children': []
        }

        # TASK 1: NSE Enumeration (databases + info)
        tasks['children'].append({
            'id': f'mongodb-nse-enum-{port}',
            'name': 'MongoDB NSE Enumeration',
            'type': 'command',
            'metadata': {
                'command': f'nmap -p{port} --script mongodb-databases,mongodb-info {target}',
                'description': 'Enumerate MongoDB databases and server information via NSE scripts',
                'tags': ['OSCP:MEDIUM', 'MONGODB', 'NOSQL', 'QUICK_WIN', 'AUTOMATED'],
                'flag_explanations': {
                    '--script mongodb-databases': 'List all databases in MongoDB installation (listDatabases command)',
                    '--script mongodb-info': 'Get MongoDB build info, version, system details, server status',
                    '-p': f'Target port ({port})'
                },
                'success_indicators': [
                    'Database list retrieved (admin, local, test, application databases)',
                    'MongoDB version identified',
                    'Server statistics obtained (uptime, connections, memory usage)',
                    'Authentication NOT required (misconfiguration - CRITICAL finding)'
                ],
                'failure_indicators': [
                    'Authentication required (secure configuration)',
                    'Connection refused',
                    'Empty database list (no access)',
                    'Firewall blocking connection'
                ],
                'next_steps': [
                    'If no authentication required:',
                    '  - Connect: mongo {target}:{port}',
                    '  - List databases: show dbs;',
                    '  - Select database: use <database_name>;',
                    '  - List collections: show collections;',
                    '  - Dump data: db.<collection>.find();',
                    '  - Count documents: db.<collection>.count();',
                    '  - Search for credentials: db.<collection>.find({{"username":{{"$exists":true}}}});',
                    '',
                    'If authentication required:',
                    '  - Try default credentials (admin:admin, root:root)',
                    '  - Brute-force authentication (hydra, custom script)',
                    '  - Check for CVEs in detected version'
                ],
                'alternatives': [
                    f'Manual connection test: mongo {target}:{port}',
                    'MongoDB Compass GUI tool',
                    f'Python: pymongo.MongoClient("mongodb://{target}:{port}")',
                    f'Check for exposed web admin: http://{target}:28017',
                    'Metasploit: auxiliary/scanner/mongodb/mongodb_login',
                    'NoSQLMap: python nosqlmap.py -t {target}:{port}'
                ],
                'notes': 'CRITICAL: MongoDB often runs WITHOUT authentication by default (misconfiguration). This is a QUICK WIN - always test for no-auth access first. Default databases: admin (system users/roles), local (replication data), test (default empty DB). Save with -oA for OSCP documentation. Time estimate: 1-3 minutes.'
            }
        })

        # TASK 2: Manual Connection Test
        tasks['children'].append({
            'id': f'mongodb-manual-connect-{port}',
            'name': 'Manual MongoDB Connection Test',
            'type': 'command',
            'metadata': {
                'command': f'mongo {target}:{port}',
                'description': 'Test direct connection to MongoDB without authentication (common misconfiguration)',
                'tags': ['MANUAL', 'OSCP:HIGH', 'MONGODB', 'QUICK_WIN'],
                'flag_explanations': {
                    'mongo': 'MongoDB shell client',
                    f'{target}:{port}': 'Connection string (host:port)'
                },
                'success_indicators': [
                    'MongoDB shell prompt appears (>)',
                    'Connection established without password prompt',
                    'Can execute commands (show dbs, show collections)',
                    'Welcome message displays MongoDB version'
                ],
                'failure_indicators': [
                    'Authentication required',
                    'Connection refused',
                    'Timeout (firewall blocking)',
                    'Error: "not authorized" or "requires authentication"'
                ],
                'next_steps': [
                    'If successful connection (no auth):',
                    '',
                    '1. List all databases:',
                    '   > show dbs',
                    '',
                    '2. Switch to database:',
                    '   > use <database_name>',
                    '',
                    '3. List collections in database:',
                    '   > show collections',
                    '',
                    '4. Count documents in collection:',
                    '   > db.<collection>.count()',
                    '',
                    '5. View sample documents:',
                    '   > db.<collection>.find().limit(5).pretty()',
                    '',
                    '6. Search for specific data:',
                    '   > db.<collection>.find({{"field":"value"}})',
                    '',
                    '7. Find documents with specific fields (credential hunting):',
                    '   > db.<collection>.find({{"password":{{"$exists":true}}}})',
                    '   > db.<collection>.find({{"apikey":{{"$exists":true}}}})',
                    '   > db.<collection>.find({{"token":{{"$exists":true}}}})',
                    '',
                    '8. Dump entire collection to JSON:',
                    '   > mongoexport --host {target}:{port} --db <database> --collection <collection> --out dump.json',
                    '',
                    '9. Document findings for OSCP report:',
                    '   - List all databases accessed',
                    '   - Document exact queries used',
                    '   - Screenshot interesting data',
                    '   - Note lack of authentication'
                ],
                'alternatives': [
                    'If mongo shell not available:',
                    '  - Install MongoDB tools: apt install mongodb-clients',
                    '  - Use MongoDB Compass GUI',
                    '  - Python script with pymongo library',
                    '  - NoSQL injection via web application',
                    '',
                    'Connection string variants:',
                    '  - mongo mongodb://{target}:{port}',
                    '  - mongo --host {target} --port {port}',
                    '  - mongo mongodb://{target}:{port}/<database_name>'
                ],
                'notes': 'OSCP CRITICAL: MongoDB without authentication is COMMON in lab environments and CTFs. This is often the intended foothold. Always test manual connection FIRST before automated scanning. Default port 27017. Web admin interface may be exposed on port 28017 (HTTP). Document EXACT commands used for OSCP report.'
            }
        })

        # TASK 3: Database Enumeration (detailed)
        tasks['children'].append({
            'id': f'mongodb-db-enum-{port}',
            'name': 'Database and Collection Enumeration',
            'type': 'parent',
            'children': [
                {
                    'id': f'mongodb-list-dbs-{port}',
                    'name': 'List All Databases',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Enumerate all MongoDB databases and their sizes',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'MONGODB'],
                        'command': '> show dbs',
                        'success_indicators': [
                            'Database list displayed with sizes',
                            'Application databases identified (non-default names)',
                            'admin, local, test databases visible'
                        ],
                        'next_steps': [
                            'Common databases to investigate:',
                            '  - admin: User credentials, roles, system info',
                            '  - local: Replication data, startup logs',
                            '  - test: Default empty database (check for misuse)',
                            '  - Application-specific DBs: Focus here for credentials/data',
                            '',
                            'Target non-default databases first',
                            'Document database names and sizes for OSCP report'
                        ],
                        'alternatives': [
                            'JavaScript query: db.adminCommand("listDatabases")',
                            'Python: client.list_database_names()'
                        ],
                        'notes': 'Databases: admin (system), local (replication), test (default). Focus on application databases for sensitive data.'
                    }
                },
                {
                    'id': f'mongodb-dump-collections-{port}',
                    'name': 'Enumerate Collections and Documents',
                    'type': 'manual',
                    'metadata': {
                        'description': 'List collections in database and extract documents',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'MONGODB'],
                        'command': '> use <database>; show collections; db.<collection>.find().pretty()',
                        'next_steps': [
                            'For each application database:',
                            '',
                            '1. Switch to database:',
                            '   > use <database_name>',
                            '',
                            '2. List collections:',
                            '   > show collections',
                            '',
                            '3. View collection schema (sample document):',
                            '   > db.<collection>.findOne()',
                            '',
                            '4. Count documents:',
                            '   > db.<collection>.count()',
                            '',
                            '5. Search for credentials:',
                            '   > db.users.find({}, {username:1, password:1, email:1})',
                            '   > db.accounts.find({role:"admin"})',
                            '   > db.config.find({type:"credentials"})',
                            '',
                            '6. Export collection:',
                            '   $ mongoexport --host {target}:{port} --db <db> --collection <coll> --out data.json',
                            '',
                            '7. Look for interesting collections:',
                            '   - users, accounts, customers (credentials)',
                            '   - config, settings (API keys, secrets)',
                            '   - sessions, tokens (session hijacking)',
                            '   - logs (sensitive data leakage)'
                        ],
                        'alternatives': [
                            'Export all collections in database:',
                            '  mongodump --host {target}:{port} --db <database> --out /path/to/dump',
                            'Query with filters:',
                            '  db.collection.find({field:"value"})',
                            'Limit output:',
                            '  db.collection.find().limit(10)'
                        ],
                        'notes': 'Focus on users, config, accounts collections. Look for password, apiKey, token fields. Export data with mongoexport for offline analysis.'
                    }
                },
                {
                    'id': f'mongodb-credential-hunt-{port}',
                    'name': 'Automated Credential Hunting',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Search MongoDB collections for credentials, API keys, tokens',
                        'tags': ['MANUAL', 'OSCP:HIGH', 'MONGODB', 'CREDS'],
                        'command': '> db.<collection>.find({"password":{"$exists":true}})',
                        'next_steps': [
                            'Credential hunting queries:',
                            '',
                            '// Find documents with password field',
                            'db.<collection>.find({"password":{"$exists":true}})',
                            '',
                            '// Find documents with API key',
                            'db.<collection>.find({"apiKey":{"$exists":true}})',
                            'db.<collection>.find({"api_key":{"$exists":true}})',
                            '',
                            '// Find documents with token',
                            'db.<collection>.find({"token":{"$exists":true}})',
                            'db.<collection>.find({"access_token":{"$exists":true}})',
                            '',
                            '// Find admin users',
                            'db.users.find({"role":"admin"})',
                            'db.users.find({"isAdmin":true})',
                            '',
                            '// Search by field names (case-insensitive)',
                            'db.<collection>.find({"$or":[',
                            '  {"password":{"$exists":true}},',
                            '  {"secret":{"$exists":true}},',
                            '  {"apiKey":{"$exists":true}}',
                            ']})',
                            '',
                            '// Export credentials to file',
                            'mongoexport --host {target}:{port} --db <db> --collection users --fields username,password,email --out creds.json'
                        ],
                        'alternatives': [
                            'GUI tools: MongoDB Compass (visual data exploration)',
                            'NoSQLMap: Automated NoSQL injection and data extraction',
                            'Custom Python script with pymongo'
                        ],
                        'notes': 'MongoDB stores passwords in plaintext or hashed. Check hash format and crack if needed. Document EXACT query and results for OSCP report.'
                    }
                }
            ]
        })

        # TASK 4: Authentication Testing (if required)
        tasks['children'].append({
            'id': f'mongodb-auth-test-{port}',
            'name': 'MongoDB Authentication Testing',
            'type': 'parent',
            'children': [
                {
                    'id': f'mongodb-default-creds-{port}',
                    'name': 'Test Default Credentials',
                    'type': 'manual',
                    'metadata': {
                        'description': 'Try common default MongoDB credentials',
                        'tags': ['MANUAL', 'OSCP:MEDIUM', 'MONGODB'],
                        'command': f'mongo {target}:{port}/admin -u admin -p admin',
                        'next_steps': [
                            'Try these default credentials:',
                            '  - admin:admin',
                            '  - root:root',
                            '  - mongodb:mongodb',
                            '  - admin:<blank>',
                            '  - root:<blank>',
                            '',
                            'Connection syntax:',
                            '  mongo {target}:{port}/<database> -u <username> -p <password>',
                            '',
                            'Connection string format:',
                            '  mongo mongodb://<username>:<password>@{target}:{port}/<database>'
                        ],
                        'alternatives': [
                            'Hydra brute-force: hydra -L users.txt -P passwords.txt mongodb://{target}:{port}',
                            'Metasploit: auxiliary/scanner/mongodb/mongodb_login',
                            'Custom Python script with pymongo'
                        ],
                        'notes': 'If authentication enabled, default credentials rarely work. Focus on no-auth misconfiguration instead.'
                    }
                }
            ]
        })

        # TASK 5: Web Interface Check
        web_port = 28017 if port == 27017 else port + 1000
        tasks['children'].append({
            'id': f'mongodb-web-admin-{port}',
            'name': 'Check for Exposed Web Admin Interface',
            'type': 'command',
            'metadata': {
                'command': f'curl -s http://{target}:{web_port}/ | head -20',
                'description': f'Check if MongoDB HTTP status interface is exposed on port {web_port}',
                'tags': ['OSCP:LOW', 'MONGODB', 'WEB', 'QUICK_WIN'],
                'flag_explanations': {
                    '-s': 'Silent mode (no progress bar)',
                    'head -20': 'Show first 20 lines of response'
                },
                'success_indicators': [
                    'HTTP 200 response',
                    'MongoDB web interface HTML returned',
                    'Server status visible in browser'
                ],
                'failure_indicators': [
                    'Connection refused',
                    'HTTP 404 Not Found',
                    'HTTP interface disabled (secure configuration)'
                ],
                'next_steps': [
                    f'If accessible, open in browser: http://{target}:{web_port}/',
                    'Web interface may show:',
                    '  - Server status and statistics',
                    '  - Database and collection listings',
                    '  - Current operations and queries',
                    '  - Log file contents',
                    'Document findings for OSCP report'
                ],
                'alternatives': [
                    f'Browser: http://{target}:{web_port}/',
                    f'nmap --script http-title -p{web_port} {target}'
                ],
                'notes': 'MongoDB HTTP interface (port 28017) deprecated in 3.2+ but may still be enabled on older installations. Provides read-only view of server status.'
            }
        })

        # TASK 6: Exploitation Resources
        tasks['children'].append({
            'id': f'mongodb-exploit-{port}',
            'name': 'MongoDB Exploitation Resources',
            'type': 'manual',
            'metadata': {
                'description': 'MongoDB-specific exploitation techniques and resources',
                'tags': ['MONGODB', 'RESEARCH', 'OSCP:LOW'],
                'next_steps': [
                    'MongoDB Exploitation Vectors:',
                    '',
                    '1. No Authentication (most common):',
                    '   - Direct data access',
                    '   - Credential extraction',
                    '   - Data modification/destruction',
                    '',
                    '2. NoSQL Injection (via web app):',
                    '   - Bypass authentication: {"username":"admin", "password":{"$ne":""}}',
                    '   - Data extraction: {"username":{"$regex":"^a"}}',
                    '   - Tool: NoSQLMap (https://github.com/codingo/NoSQLMap)',
                    '',
                    '3. Server-Side JavaScript Injection:',
                    '   - $where operator with JavaScript',
                    '   - mapReduce function injection',
                    '   - Example: db.collection.find({"$where":"this.username == \'" + INPUT + "\'"})',
                    '',
                    '4. Known CVEs:',
                    '   - CVE-2013-1892: Privilege escalation',
                    '   - CVE-2015-1609: Unauthenticated file access',
                    '   - CVE-2016-6494: Authentication bypass',
                    '   - CVE-2019-2386: Unauth RCE (MongoDB Compass)',
                    '',
                    '5. Post-Exploitation:',
                    '   - Create admin user (if db.createUser() available)',
                    '   - Enable authentication for persistence',
                    '   - Export entire database for offline analysis',
                    '   - Modify application data for privilege escalation'
                ],
                'alternatives': [
                    'NoSQL injection cheat sheet: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection',
                    'HackTricks MongoDB: https://book.hacktricks.xyz/pentesting/27017-27018-mongodb',
                    'searchsploit mongodb'
                ],
                'notes': 'MongoDB exploitation typically focuses on no-auth access or NoSQL injection via web apps. Direct database exploits are rare in OSCP.'
            }
        })

        # TASK 7: CVE Research (conditional on version)
        if version:
            tasks['children'].append({
                'id': f'mongodb-cve-{port}',
                'name': f'Exploit Research: MongoDB {version}',
                'type': 'parent',
                'children': [
                    {
                        'id': f'searchsploit-mongodb-{port}',
                        'name': f'SearchSploit: MongoDB {version}',
                        'type': 'command',
                        'metadata': {
                            'command': f'searchsploit mongodb {version}',
                            'description': 'Search ExploitDB for MongoDB vulnerabilities',
                            'tags': ['OSCP:MEDIUM', 'RESEARCH', 'MONGODB'],
                            'success_indicators': [
                                'Exploits found for specific version',
                                'CVE numbers identified'
                            ],
                            'next_steps': [
                                'Review exploit details',
                                'Test in controlled environment',
                                'Check exploit requirements (auth, specific config)'
                            ],
                            'alternatives': [
                                'Google: "MongoDB {version} exploit"',
                                'MongoDB Security Advisories: https://www.mongodb.com/alerts'
                            ],
                            'notes': 'Focus on pre-authentication exploits. Most MongoDB vulnerabilities require authentication.'
                        }
                    }
                ]
            })

        return tasks
