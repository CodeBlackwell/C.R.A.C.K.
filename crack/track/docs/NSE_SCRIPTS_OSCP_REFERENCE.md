# NSE Scripts OSCP Reference

**Source:** Nmap Cookbook Chapter 9 Part 1 - NSE Basics
**Version:** 1.0
**Generated by:** CrackPot NSE Mining Agent
**Purpose:** Comprehensive NSE script reference for OSCP pentesting

---

## Table of Contents

1. [NSE Categories](#nse-categories)
2. [Core NSE Concepts](#core-nse-concepts)
3. [HTTP Scripts](#http-scripts)
4. [SMB Scripts](#smb-scripts)
5. [SSH Scripts](#ssh-scripts)
6. [FTP Scripts](#ftp-scripts)
7. [Database Scripts](#database-scripts)
8. [Mail Scripts](#mail-scripts)
9. [Vulnerability Detection Scripts](#vulnerability-detection-scripts)
10. [Brute Force Scripts](#brute-force-scripts)
11. [Script Arguments Reference](#script-arguments-reference)
12. [NSE Libraries](#nse-libraries)
13. [Writing Custom NSE Scripts](#writing-custom-nse-scripts)

---

## NSE Categories

NSE scripts are organized into categories for easy selection:

### Safe Scripts (`--script=safe`)
- **Purpose:** Non-intrusive enumeration
- **OSCP Relevance:** HIGH
- **Risk:** Low (won't crash services or trigger IDS)
- **Examples:** `http-title`, `ssh-hostkey`, `ssl-cert`, `smb-os-discovery`
- **Use Case:** Initial service enumeration

### Default Scripts (`-sC` or `--script=default`)
- **Purpose:** Well-tested, commonly useful scripts
- **OSCP Relevance:** HIGH
- **Risk:** Low to Medium
- **Examples:** `banner`, `http-methods`, `ssh2-enum-algos`
- **Use Case:** Standard enumeration during service detection

### Discovery Scripts (`--script=discovery`)
- **Purpose:** Active enumeration (users, shares, directories)
- **OSCP Relevance:** HIGH
- **Risk:** Low to Medium
- **Examples:** `http-enum`, `smb-enum-shares`, `dns-nsid`, `snmp-info`
- **Use Case:** Post-service detection enumeration

### Vuln Scripts (`--script=vuln`)
- **Purpose:** Vulnerability detection (CVEs, known exploits)
- **OSCP Relevance:** HIGH
- **Risk:** High (may trigger IDS, slow scans)
- **Examples:** `smb-vuln-ms17-010`, `http-shellshock`, `ssl-heartbleed`
- **Use Case:** Automated vulnerability scanning

### Auth Scripts (`--script=auth`)
- **Purpose:** Authentication testing (default creds, auth bypass)
- **OSCP Relevance:** MEDIUM
- **Risk:** Medium
- **Examples:** `http-auth-finder`, `ftp-anon`, `mysql-empty-password`
- **Use Case:** Finding weak authentication

### Brute Scripts (`--script=brute`)
- **Purpose:** Credential brute-forcing
- **OSCP Relevance:** LOW (last resort)
- **Risk:** VERY HIGH (account lockouts, very noisy)
- **Examples:** `ssh-brute`, `ftp-brute`, `http-brute`
- **Use Case:** When all else fails (not recommended for OSCP exam)

### Intrusive Scripts (`--script=intrusive`)
- **Purpose:** Active exploitation attempts
- **OSCP Relevance:** LOW (manual exploitation preferred)
- **Risk:** VERY HIGH (may crash services)
- **Examples:** Exploit modules
- **Use Case:** Lab environments only

### Excluded Categories (Don't use for OSCP)
- `dos` - Denial of service attacks
- `fuzzer` - Fuzz testing (crashes services)
- `malware` - Malware detection (not pentesting)
- `external` - External resource dependencies

---

## Core NSE Concepts

### Script Selection

```bash
# Single script
nmap --script http-enum <target>

# Multiple scripts (comma-separated)
nmap --script http-enum,http-methods,http-headers <target>

# Category
nmap --script safe <target>

# Wildcard pattern
nmap --script "http-*" <target>

# Multiple categories (OR logic)
nmap --script "safe or intrusive" <target>

# Exclude category
nmap --script "not intrusive" <target>

# Complex logic
nmap --script "(http-* or smb-*) and safe" <target>
```

### Script Arguments

```bash
# Single argument
nmap --script http-enum --script-args http-enum.basepath=/admin/ <target>

# Multiple arguments (comma-separated)
nmap --script http-brute --script-args userdb=users.txt,passdb=pass.txt <target>

# Arguments file
nmap --script http-enum --script-args-file args.txt <target>

# Global arguments (all scripts)
nmap --script-args http.useragent="Custom Agent" <target>
```

### Script Help

```bash
# View script description
nmap --script-help http-enum

# View all HTTP scripts
nmap --script-help "http-*"

# View category scripts
nmap --script-help safe

# List all scripts
nmap --script-help all | less
```

### Script Paths

Default script locations:
- **Linux:** `/usr/share/nmap/scripts/`
- **Windows:** `C:\Program Files\Nmap\scripts\`
- **macOS:** `/usr/local/share/nmap/scripts/`

Update script database:
```bash
nmap --script-updatedb
```

---

## HTTP Scripts

### http-enum
**Purpose:** Directory and file brute-forcing with NSE fingerprint database
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
# Basic usage
nmap --script http-enum -p80 <target>

# Custom base path
nmap --script http-enum --script-args http-enum.basepath=/admin/ -p80 <target>

# Custom fingerprint file
nmap --script http-enum --script-args http-enum.fingerprintfile=/custom/fingerprints.txt -p80 <target>
```

**Flag Explanations:**
- `http-enum.basepath` - Set custom base directory (e.g., `/admin/`, `/app/`)
- `http-enum.fingerprintfile` - Path to custom fingerprint database
- `http-enum.displayall` - Display all attempted paths (verbose)

**Success Indicators:**
- Directories/files found (e.g., `/admin`, `/backup`, `/upload`)
- Fingerprints matched (CMS versions, server types)

**Database:** Uses `/usr/share/nmap/nselib/data/http-fingerprints.lua`

**Extend Database:**
```lua
-- Add to http-fingerprints.lua
table.insert(fingerprints, {
  category = "cms",
  probes = {
    {path = "/wp-admin/"},
    {path = "/wp-content/"}
  },
  matches = {
    {match = "wp-login", output = "WordPress Detected"}
  }
})
```

---

### http-methods
**Purpose:** Enumerate supported HTTP methods
**OSCP Relevance:** HIGH
**Category:** safe

```bash
nmap --script http-methods -p80 <target>

# Test specific path
nmap --script http-methods --script-args http-methods.url-path=/admin/ -p80 <target>

# Test all common paths
nmap --script http-methods --script-args http-methods.test-all -p80 <target>
```

**Dangerous Methods:**
- `PUT` - File upload vulnerability
- `DELETE` - File deletion
- `TRACE` - XST (Cross-Site Tracing) attacks
- `CONNECT` - Proxy abuse

**Success Output:**
```
| http-methods:
|   Supported Methods: GET HEAD POST OPTIONS TRACE PUT DELETE
|   Potentially risky methods: TRACE PUT DELETE
```

---

### http-sql-injection
**Purpose:** Automated SQL injection detection
**OSCP Relevance:** MEDIUM (manual testing preferred)
**Category:** intrusive

```bash
nmap --script http-sql-injection -p80 <target>

# Custom crawling depth
nmap --script http-sql-injection --script-args http.max-depth=3 -p80 <target>
```

**Warning:** Generates significant traffic, may trigger WAF/IDS.

---

### http-shellshock
**Purpose:** Detect Shellshock vulnerability (CVE-2014-6271)
**OSCP Relevance:** HIGH
**Category:** vuln

```bash
nmap --script http-shellshock --script-args uri=/cgi-bin/status -p80 <target>

# Test multiple CGI paths
nmap --script http-shellshock --script-args uri=/cgi-bin/test,/scripts/test.cgi -p80 <target>
```

**Success Indicators:**
- "VULNERABLE" output
- CGI paths identified

**Manual Verification:**
```bash
curl -A "() { :; }; echo; echo vulnerable" http://target/cgi-bin/status
```

---

### http-wordpress-enum
**Purpose:** WordPress user/plugin/theme enumeration
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
# Enumerate users
nmap --script http-wordpress-enum --script-args search-limit=10 -p80 <target>

# All enumeration types
nmap --script http-wordpress-enum --script-args type="themes,plugins,users",search-limit=50 -p80 <target>
```

**Arguments:**
- `type` - Enumeration type (`users`, `plugins`, `themes`, `timthumb`)
- `search-limit` - Maximum items to enumerate

**Next Steps:**
- Use `wpscan` for comprehensive WordPress testing
- Brute-force enumerated usernames

---

## SMB Scripts

### smb-enum-shares
**Purpose:** Enumerate SMB shares
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
# Null session
nmap --script smb-enum-shares -p445 <target>

# With credentials
nmap --script smb-enum-shares --script-args smbuser=admin,smbpass=password -p445 <target>
```

**Success Output:**
```
| smb-enum-shares:
|   account_used: <blank>
|   \\192.168.1.100\ADMIN$:
|     Type: STYPE_DISKTREE_HIDDEN
|     Access: <none>
|   \\192.168.1.100\C$:
|     Type: STYPE_DISKTREE_HIDDEN
|     Access: <none>
|   \\192.168.1.100\IPC$:
|     Type: STYPE_IPC_HIDDEN
|     Access: READ/WRITE
```

**Next Steps:**
- Connect to accessible shares: `smbclient //<target>/<share> -N`
- Download files: `smbmap -H <target> -R --download`

---

### smb-vuln-ms17-010
**Purpose:** Detect EternalBlue vulnerability
**OSCP Relevance:** HIGH
**Category:** vuln

```bash
nmap --script smb-vuln-ms17-010 -p445 <target>
```

**Success Output:**
```
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
```

**Exploitation:**
```bash
# Metasploit
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target>
exploit
```

---

### smb-os-discovery
**Purpose:** Enumerate OS version and domain information
**OSCP Relevance:** HIGH
**Category:** discovery, safe

```bash
nmap --script smb-os-discovery -p445 <target>
```

**Success Output:**
```
| smb-os-discovery:
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   Computer name: WORKSTATION01
|   NetBIOS computer name: WORKSTATION01
|   Domain name: contoso.local
|   FQDN: WORKSTATION01.contoso.local
```

---

### smb-enum-users
**Purpose:** Enumerate local/domain users via RPC
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
# Null session
nmap --script smb-enum-users -p445 <target>

# With credentials
nmap --script smb-enum-users --script-args smbuser=admin,smbpass=password -p445 <target>
```

**Next Steps:**
- Save usernames for brute-force attacks
- Password spraying with common passwords

---

## SSH Scripts

### ssh2-enum-algos
**Purpose:** Enumerate SSH algorithms (ciphers, MACs, key exchange)
**OSCP Relevance:** HIGH
**Category:** discovery, safe

```bash
nmap --script ssh2-enum-algos -p22 <target>
```

**Success Output:**
```
| ssh2-enum-algos:
|   kex_algorithms: (6)
|       diffie-hellman-group-exchange-sha256
|       diffie-hellman-group14-sha1
|   encryption_algorithms: (4)
|       aes128-ctr
|       aes256-ctr
|   mac_algorithms: (2)
|       hmac-sha2-256
|       hmac-sha2-512
```

**Weak Algorithms:**
- **Ciphers:** `3des-cbc`, `arcfour`, `aes128-cbc`
- **MACs:** `hmac-md5`, `hmac-sha1-96`
- **Key Exchange:** `diffie-hellman-group1-sha1` (Logjam)

---

### ssh-auth-methods
**Purpose:** Enumerate authentication methods for user
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
nmap --script ssh-auth-methods --script-args ssh.user=root -p22 <target>

# Test multiple users
nmap --script ssh-auth-methods --script-args ssh.user=admin -p22 <target>
nmap --script ssh-auth-methods --script-args ssh.user=backup -p22 <target>
```

**Success Output:**
```
| ssh-auth-methods:
|   Supported authentication methods:
|     publickey
|     password
|     keyboard-interactive
```

**Interpretation:**
- `password` enabled = Brute-force vector
- `publickey` only = Test known SSH keys
- `keyboard-interactive` = Potential MFA bypass

---

### ssh-hostkey
**Purpose:** Extract SSH host public keys
**OSCP Relevance:** MEDIUM
**Category:** discovery, safe

```bash
nmap --script ssh-hostkey --script-args ssh_hostkey=full -p22 <target>
```

**Success Output:**
```
| ssh-hostkey:
|   2048 ab:cd:ef:12:34:56 (RSA)
|   256 gh:ij:kl:78:90:12 (ECDSA)
|   256 mn:op:qr:34:56:78 (ED25519)
```

**Analysis:**
- RSA < 2048 bits = Weak
- Check against compromised key databases
- Compare with `ssh-keyscan` output

---

### sshv1
**Purpose:** Detect SSH Protocol 1 support
**OSCP Relevance:** MEDIUM
**Category:** vuln

```bash
nmap --script sshv1 -p22 <target>
```

**Vulnerability:** CVE-1999-0662
**Impact:** SSHv1 has fundamental security flaws (session key recovery, insertion attacks)
**Severity:** HIGH if supported

---

### ssh-run
**Purpose:** Execute commands via SSH (requires credentials)
**OSCP Relevance:** LOW
**Category:** intrusive

```bash
nmap --script ssh-run --script-args="ssh-run.cmd='id',ssh-run.username=admin,ssh-run.password=password" -p22 <target>

# With private key
nmap --script ssh-run --script-args="ssh-run.cmd='uname -a',ssh-run.username=user,ssh-run.keyfile=/path/to/id_rsa" -p22 <target>
```

**Use Case:** Quick post-exploitation enumeration without interactive shell

---

## FTP Scripts

### ftp-anon
**Purpose:** Test for anonymous FTP login
**OSCP Relevance:** HIGH
**Category:** auth, safe

```bash
nmap --script ftp-anon -p21 <target>
```

**Success Output:**
```
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| drwxr-xr-x   2 ftp      ftp          4096 Jan 01 00:00 pub
| -rw-r--r--   1 ftp      ftp           612 Jan 01 00:00 welcome.txt
```

**Next Steps:**
- Download all files: `wget -m ftp://anonymous:anonymous@<target>`
- Check for writable directories

---

### ftp-vsftpd-backdoor
**Purpose:** Detect vsftpd 2.3.4 backdoor
**OSCP Relevance:** HIGH
**Category:** vuln, exploit

```bash
nmap --script ftp-vsftpd-backdoor -p21 <target>
```

**Backdoor Trigger:** Username ending in `:)` (smiley face)
**Backdoor Port:** 6200 (root shell)

**Manual Exploitation:**
```bash
# Trigger backdoor
telnet <target> 21
USER backdoored:)
PASS anything

# Connect to backdoor
nc <target> 6200
```

---

## Database Scripts

### mysql-empty-password
**Purpose:** Test for blank MySQL root password
**OSCP Relevance:** HIGH
**Category:** auth

```bash
nmap --script mysql-empty-password -p3306 <target>
```

---

### mysql-dump-hashes
**Purpose:** Dump MySQL password hashes
**OSCP Relevance:** HIGH
**Category:** brute (requires auth)

```bash
nmap --script mysql-dump-hashes --script-args="username=root,password=''" -p3306 <target>
```

**Next Steps:**
- Crack hashes: `hashcat -m 300 hashes.txt rockyou.txt` (MySQL5)
- Crack hashes: `hashcat -m 21100 hashes.txt rockyou.txt` (MySQL8)

---

### ms-sql-empty-password
**Purpose:** Test for blank sa password
**OSCP Relevance:** HIGH
**Category:** auth

```bash
nmap --script ms-sql-empty-password -p1433 <target>
```

---

### ms-sql-ntlm-info
**Purpose:** Extract Windows domain info via NTLM
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
nmap --script ms-sql-ntlm-info -p1433 <target>
```

**Success Output:**
```
| ms-sql-ntlm-info:
|   Target_Name: CONTOSO
|   NetBIOS_Domain_Name: CONTOSO
|   NetBIOS_Computer_Name: DC01
|   DNS_Domain_Name: contoso.local
|   DNS_Computer_Name: DC01.contoso.local
|   DNS_Tree_Name: contoso.local
```

---

## Mail Scripts

### smtp-enum-users
**Purpose:** Enumerate SMTP users via VRFY/EXPN/RCPT TO
**OSCP Relevance:** HIGH
**Category:** discovery

```bash
# Default method (VRFY)
nmap --script smtp-enum-users -p25 <target>

# Specify method
nmap --script smtp-enum-users --script-args smtp-enum-users.methods={VRFY,EXPN,RCPT} -p25 <target>

# Custom user list
nmap --script smtp-enum-users --script-args userdb=users.txt -p25 <target>
```

**Methods:**
- `VRFY` - Verify user exists
- `EXPN` - Expand mailing list
- `RCPT TO` - Recipient check

---

### smtp-open-relay
**Purpose:** Test if server is open relay
**OSCP Relevance:** MEDIUM
**Category:** discovery

```bash
nmap --script smtp-open-relay -p25 <target>
```

**Security Issue:** Open relay allows mail spoofing, spam distribution

---

## Vulnerability Detection Scripts

### ssl-heartbleed
**Purpose:** Detect Heartbleed vulnerability (CVE-2014-0160)
**OSCP Relevance:** MEDIUM
**Category:** vuln

```bash
nmap --script ssl-heartbleed -p443 <target>
```

---

### http-vuln-cve2017-5638
**Purpose:** Apache Struts2 RCE
**OSCP Relevance:** MEDIUM
**Category:** vuln

```bash
nmap --script http-vuln-cve2017-5638 -p80 <target>
```

---

## Brute Force Scripts

### ssh-brute
**Purpose:** SSH password brute-force
**OSCP Relevance:** LOW (last resort, triggers lockouts)
**Category:** brute, intrusive

```bash
# Basic brute-force
nmap --script ssh-brute -p22 <target>

# Custom wordlists
nmap --script ssh-brute --script-args userdb=users.txt,passdb=pass.txt -p22 <target>

# Stop after first valid account
nmap --script ssh-brute --script-args brute.firstonly=true -p22 <target>

# Time limit
nmap --script ssh-brute --script-args unpwdb.timelimit=10m -p22 <target>
```

**NSE Brute Library Arguments:**
- `userdb` - Username wordlist
- `passdb` - Password wordlist
- `brute.firstonly` - Stop after first success
- `brute.mode` - `user` (all passwords per user) or `pass` (all users per password)
- `unpwdb.timelimit` - Time limit (e.g., `30m`, `1h`)

**Warning:** SSH brute-force is SLOW, NOISY, and often triggers account lockouts. Not recommended for OSCP exam.

---

## Script Arguments Reference

### Global HTTP Arguments

```bash
--script-args http.useragent="Custom User-Agent"
--script-args http.max-cache-size=1000000
--script-args http.pipeline=25
--script-args http.max-body-size=8388608
```

### Global Brute Force Arguments

```bash
--script-args userdb=/path/to/users.txt
--script-args passdb=/path/to/passwords.txt
--script-args brute.credfile=/path/to/user:pass.txt
--script-args brute.firstonly=true
--script-args brute.mode=user
--script-args unpwdb.timelimit=30m
--script-args brute.delay=3
```

### SMB Arguments

```bash
--script-args smbuser=username
--script-args smbpass=password
--script-args smbdomain=DOMAIN
--script-args smbhash=ntlmhash
--script-args smbnoguest=true
```

### Script-Specific Arguments

View all arguments for a script:
```bash
nmap --script-help <script-name>
```

Example for http-enum:
```bash
$ nmap --script-help http-enum
http-enum
Categories: discovery safe
  Enumerates directories used by popular web applications and servers.

Arguments:
  http-enum.basepath (default: /)
  http-enum.fingerprintfile (default: nselib/data/http-fingerprints.lua)
  http-enum.displayall (boolean, default: false)
```

---

## NSE Libraries

NSE provides powerful libraries for script development:

### http
```lua
local http = require "http"

-- HTTP GET
local response = http.get(host, port, "/admin")

-- HTTP POST
local response = http.post(host, port, "/login", nil, nil, {username="admin", password="pass"})

-- Identify 404 pages
local is_404 = http.identify_404(host, port)

-- Parse HTML
local links = http.grab_page(host, port, "/")
```

### brute
```lua
local brute = require "brute"
local creds = require "creds"

-- Define driver
Driver = {
  new = function(self, host, port)
    local o = {}
    setmetatable(o, self)
    self.__index = self
    o.host = host
    o.port = port
    return o
  end,

  connect = function(self)
    -- Connection logic
  end,

  login = function(self, username, password)
    -- Login attempt logic
    if success then
      return true, creds.Account:new(username, password, creds.State.VALID)
    end
    return false, brute.Error:new("Login failed")
  end,

  disconnect = function(self)
    -- Disconnect logic
  end
}

-- Execute brute-force
local engine = brute.Engine:new(Driver, host, port)
engine:start()
```

### vulns
```lua
local vulns = require "vulns"
local vuln = require "vuln"

-- Define vulnerability
local vuln_table = {
  title = "MS17-010 EternalBlue",
  state = vulns.STATE.NOT_VULN,
  IDS = {CVE = 'CVE-2017-0144'},
  risk_factor = "HIGH",
  scores = {
    CVSSv2 = "9.3 (HIGH) (AV:N/AC:M/Au:N/C:C/I:C/A:C)",
  },
  description = [[
    Remote Code Execution vulnerability in Microsoft SMBv1 servers.
  ]],
  references = {
    'https://technet.microsoft.com/en-us/library/security/ms17-010.aspx',
  },
  dates = {
    disclosure = {year = '2017', month = '03', day = '14'},
  },
}

-- Check vulnerability
local status, result = check_vuln(host, port)
if status then
  vuln_table.state = vulns.STATE.VULN
end

return vulns.Report:new(SCRIPT_NAME, host, port):add_vulns(vuln_table)
```

### stdnse
```lua
local stdnse = require "stdnse"

-- Get script arguments
local basepath = stdnse.get_script_args(SCRIPT_NAME..".basepath") or "/"

-- Debug output
stdnse.debug1("Testing path: %s", path)

-- Print verbose
stdnse.verbose1("Found directory: %s", dir)

-- Format output
return stdnse.format_output(true, results)
```

### nmap
```lua
local nmap = require "nmap"

-- Create socket
local socket = nmap.new_socket()
socket:set_timeout(5000)
socket:connect(host, port)
socket:send("GET / HTTP/1.0\r\n\r\n")
local response = socket:receive()
socket:close()

-- Registry operations
nmap.registry[SCRIPT_NAME] = nmap.registry[SCRIPT_NAME] or {}

-- Add port to scan
local port_table = {number=8080, protocol="tcp"}
nmap.set_port_state(host, port_table, "open")
```

---

## Writing Custom NSE Scripts

### Basic Script Template

```lua
local http = require "http"
local stdnse = require "stdnse"
local shortport = require "shortport"

description = [[
Custom script description for OSCP enumeration.
Detects custom application vulnerability.
]]

author = "Your Name"
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"
categories = {"discovery", "safe"}

---
-- @usage
-- nmap --script custom-script -p80 <target>
--
-- @output
-- | custom-script:
-- |   Vulnerability: Custom Vuln
-- |   Status: VULNERABLE
--
-- @args custom-script.basepath Base path for testing (default: /)

-- Rule to determine when script runs
portrule = shortport.http

-- Main action function
action = function(host, port)
  local basepath = stdnse.get_script_args(SCRIPT_NAME..".basepath") or "/"

  -- Perform HTTP request
  local response = http.get(host, port, basepath.."admin")

  -- Check response
  if response.status == 200 and response.body:match("Admin Panel") then
    return stdnse.format_output(true, {
      "Admin panel accessible at: "..basepath.."admin",
      "Status: VULNERABLE"
    })
  end

  return "Not vulnerable"
end
```

### Hostrule, Portrule, Prerule, Postrule

```lua
local shortport = require "shortport"
local nmap = require "nmap"

-- Hostrule: Runs once per host
hostrule = function(host)
  return host.os and host.os.family == "Windows"
end

-- Portrule: Runs once per port
portrule = shortport.http  -- HTTP/HTTPS ports
portrule = shortport.port_or_service({80, 443}, "http")
portrule = function(host, port)
  return port.number == 8080 and port.state == "open"
end

-- Prerule: Runs before any scanning
prerule = function()
  return true
end

-- Postrule: Runs after all scanning
postrule = function()
  return nmap.registry[SCRIPT_NAME] ~= nil
end
```

### Testing Custom Scripts

```bash
# Test script syntax
nmap --script-trace --script /path/to/script.nse <target>

# Debug output
nmap -d --script /path/to/script.nse <target>

# Update script database
nmap --script-updatedb
```

---

## OSCP NSE Workflow

### Phase 1: Discovery (Safe Scripts)

```bash
# Service enumeration
nmap -sV -sC -p- <target> -oA discovery

# HTTP enumeration
nmap -sV --script "http-* and safe" -p80,443,8080,8443 <target>

# SMB enumeration
nmap -sV --script "smb-* and safe" -p139,445 <target>

# SSH enumeration
nmap -sV --script ssh2-enum-algos,ssh-hostkey,ssh-auth-methods -p22 <target>
```

### Phase 2: Vulnerability Scanning

```bash
# Comprehensive vuln scan
nmap -sV --script vuln -p <open-ports> <target> -oA vulns

# Service-specific vulns
nmap --script smb-vuln-* -p445 <target>
nmap --script http-shellshock,http-vuln-* -p80 <target>
```

### Phase 3: Authentication Testing

```bash
# Anonymous/default access
nmap --script "auth or default" -p <ports> <target>

# Specific auth tests
nmap --script ftp-anon,mysql-empty-password,ms-sql-empty-password -p21,3306,1433 <target>
```

### Phase 4: Brute Force (Last Resort)

```bash
# ONLY if other methods fail
# Use small wordlists to avoid lockouts
nmap --script ssh-brute --script-args userdb=users-short.txt,passdb=pass-short.txt -p22 <target>
```

---

## NSE Best Practices for OSCP

1. **Start with safe scripts** - Use `--script=safe` for initial enumeration
2. **Avoid brute force** - Triggers lockouts, very slow
3. **Verify vulnerabilities manually** - NSE may have false positives
4. **Document NSE usage** - Include exact commands in OSCP report
5. **Use script arguments** - Customize scripts for better results
6. **Combine with manual testing** - NSE doesn't replace manual enumeration
7. **Check script help** - `nmap --script-help <script>` before using
8. **Save all output** - Use `-oA` flag for comprehensive documentation
9. **Test incrementally** - Don't run all scripts at once
10. **Understand what scripts do** - Review script source before running

---

## Resources

- **Nmap NSE Documentation:** https://nmap.org/book/nse.html
- **NSE Script Database:** https://nmap.org/nsedoc/
- **NSE Library Reference:** https://nmap.org/nsedoc/lib/
- **Writing NSE Scripts:** https://nmap.org/book/nse-tutorial.html
- **NSE GitHub Repository:** https://github.com/nmap/nmap/tree/master/scripts

---

## Advanced NSE Techniques (Chapter 9 Part 2)

### HTTP Pipelining for Performance

**Concept:** Send multiple HTTP requests in a single TCP packet

**Default Behavior:**
- NSE http library auto-pipelines 40 requests
- Auto-adjusts based on Keep-Alive header and network conditions

**Manual Control:**
```bash
# Increase pipelining for speed (if server supports Keep-Alive)
nmap --script http-enum --script-args http.pipeline=100 <target>

# Disable pipelining (troubleshooting)
nmap --script http-enum --script-args http.pipeline=1 <target>

# Monitor pipelined requests
nmap --script http-enum --script-args http.pipeline=100 --packet-trace <target>
```

**Test Server Support:**
```bash
curl -I http://target/ | grep -i "keep-alive"
# If present, increase http.pipeline for faster scans
```

**Custom Script Implementation:**
```lua
local reqs = nil
reqs = http.pipeline_add('/admin/', nil, reqs)
reqs = http.pipeline_add('/backup/', nil, reqs)
reqs = http.pipeline_add('/uploads/', nil, reqs)
local results = http.pipeline(host, port, reqs)

for i, req in pairs(results) do
    stdnse.print_debug(1, "Request #%d returned status %d", i, req.status)
end
```

**OSCP Usage:**
- Speeds up http-enum by 50%+ on cooperative servers
- Reduces TCP connections (less noisy)
- May fail on some web servers (reduce pipeline value)

---

### Exception Handling (Reliability)

**Concept:** Graceful error handling for network operations

**Pattern:**
```lua
-- Define cleanup function
local catch = function() socket:close() end

-- Create try function
local try = nmap.new_try(catch)

-- Wrap risky operations
try(socket:connect(host, port))
response = try(mysql.receiveGreeting(socket))
```

**Use Cases:**
- Socket operations (may fail on connection)
- File I/O (missing files, permissions)
- Data parsing (malformed responses)

**OSCP Application:**
- Prevents script crashes on unstable targets
- Ensures cleanup (close sockets, files)
- Provides meaningful error messages

---

### Vulnerability Reporting (vulns library)

**Standardized vulnerability output format introduced in NSE**

**Vulnerability States:**
```lua
vulns.STATE.VULN              -- Confirmed vulnerable
vulns.STATE.LIKELY_VULN       -- Probable (needs verification)
vulns.STATE.NOT_VULN          -- Not vulnerable
vulns.STATE.EXPLOIT           -- Exploitable (with PoC)
vulns.STATE.DoS               -- DoS vulnerability
```

**Basic Usage:**
```lua
local vulns = require "vulns"

local vuln = {
    title = "PHP-CGI Remote Code Execution (CVE-2012-1823)",
    state = vulns.STATE.NOT_VULN,
    IDS = {CVE = "2012-1823", BID = "53388"},
    description = [[PHP-CGI allows RCE via query string...]],
    risk_factor = "High",
    references = {"http://cve.mitre.org/cgi-bin/cvename.cgi?name=2012-1823"}
}

local vuln_report = vulns.Report:new(SCRIPT_NAME, host, port)
return vuln_report:make_output(vuln)
```

**Show ALL Checks (including NOT VULNERABLE):**
```bash
nmap --script vuln --script-args vulns.showall <target>
```

**OSCP Documentation Strategy:**
```bash
# Complete audit trail
nmap --script vuln --script-args vulns.showall -oA vuln_audit <target>

# Filter for exploitable vulns
nmap --script vuln <target> | grep -A10 "VULNERABLE (Exploitable)"
```

---

### NSE Thread Parallelism

**Concept:** Run parallel network operations within script

**Thread Creation:**
```lua
local stdnse = require "stdnse"

local worker_function = function(target, port)
    local socket = nmap.new_socket()
    socket:connect(target, port)
    -- Do work
    socket:close()
end

-- Spawn worker threads
local co1 = stdnse.new_thread(worker_function, host.ip, 80)
local co2 = stdnse.new_thread(worker_function, host.ip, 443)
local co3 = stdnse.new_thread(worker_function, host.ip, 8080)
```

**Mutexes (prevent race conditions):**
```lua
local mutex = nmap.mutex(shared_object)

-- Lock resource
mutex("lock")

-- Critical section
shared_table[key] = value

-- Release lock
mutex("done")
```

**Condition Variables (thread synchronization):**
```lua
local condvar = nmap.condvar(shared_object)

-- Thread 1: Wait for signal
condvar("wait")

-- Thread 2: Signal waiting thread
condvar("signal")

-- Broadcast to all waiting threads
condvar("broadcast")
```

**OSCP Application:**
- http-slowloris (opens multiple connections concurrently)
- Parallel port scanning within script
- Multi-threaded brute-forcing

---

### Web Crawling (httpspider library)

**Automated web application crawling:**

```lua
local httpspider = require "httpspider"

action = function(host, port)
    local crawler = httpspider.Crawler:new(host, port, '/', {
        scriptname = SCRIPT_NAME,
        withinhost = 1,          -- Stay within host
        maxdepth = 3,            -- Max link depth
        maxpagecount = 20        -- Max pages to crawl
    })

    crawler:set_timeout(10000)

    while(true) do
        local status, r = crawler:crawl()
        if (not(status)) then break end

        if (r.response.body) then
            -- Process page content
            local parsed = url.parse(tostring(r.url))
            if parsed.path and parsed.path:match(".*.php") then
                -- Test PHP files for vulnerabilities
            end
        end
    end

    return results
end
```

**Crawler Limitations Display:**
```lua
local limitations = crawler:getLimitations()
-- Returns: "Spidering limited to: maxdepth=3; maxpagecount=20; withinhost=scanme.nmap.org"
```

**OSCP Usage:**
```bash
# Crawl + test for XSS
nmap --script http-phpself-xss --script-args httpspider.maxpagecount=50 <target>

# Crawl + SQLi detection
nmap --script http-sql-injection --script-args httpspider.maxdepth=5 <target>
```

---

### Debug Levels for Troubleshooting

**-d[1-9] flag provides granular debug output:**

```bash
# Level 1: Basic debug info
nmap --script http-enum -d1 <target>

# Level 4: Recommended for NSE (shows HTTP requests/responses)
nmap --script http-enum -d4 <target>

# Level 9: Extreme verbosity (packet dumps)
nmap --script http-enum -d9 <target>
```

**Debug Output by Level:**
- `-d1`: Basic script execution flow
- `-d2`: Script arguments, library loading
- `-d3`: Function calls, variable values
- `-d4`: **HTTP requests/responses, network operations (OSCP RECOMMENDED)**
- `-d5-d9`: Raw socket operations, packet dumps

**OSCP Debug Strategy:**
```bash
# Quick debug
nmap --script <script> -d4 <target>

# Save debug output
nmap --script <script> -d4 <target> 2>&1 | tee debug.log

# Search for errors
nmap --script <script> -d4 <target> 2>&1 | grep -i error
```

**Additional Debug Tools:**
```bash
# Line-by-line script execution
nmap --script http-enum --script-trace <target>

# Packet-level details
nmap --script http-enum --packet-trace <target>

# Combine for deep debugging
nmap --script <script> -d4 --script-trace --packet-trace <target>
```

---

### Script Timeout Control

**Prevent scripts from hanging indefinitely:**

```bash
# Global script timeout (all scripts)
nmap --script vuln --script-timeout 120s <target>

# Timeout in minutes
nmap --script http-slowloris --script-timeout 5m <target>

# No timeout (dangerous)
nmap --script http-enum --script-timeout 0 <target>
```

**OSCP Timeout Recommendations:**
- Quick checks: 30s
- Enumeration: 2-5m
- Brute-force: 10-30m (use small wordlists)
- Vuln scans: 5m

**Per-Script Timeout (script-specific arg):**
```bash
nmap --script http-brute --script-args unpwdb.timelimit=30m <target>
```

---

### Custom NSE Libraries

**Creating reusable code:**

```lua
-- File: /usr/share/nmap/nselib/mylibrary.lua
local stdnse = require "stdnse"

function hello(msg, name)
    return stdnse.format("%s %s", msg, name)
end

function extract_version(banner)
    -- Reusable version extraction logic
    return banner:match("Version: ([%d%.]+)")
end

-- Make functions available
return {
    hello = hello,
    extract_version = extract_version
}
```

**Using custom library:**
```lua
local mylibrary = require "mylibrary"

action = function(host, port)
    local greeting = mylibrary.hello("Hello", "OSCP")
    local version = mylibrary.extract_version(banner)
    return stdnse.format("%s - Version: %s", greeting, version)
end
```

**OSCP Application:**
- Share code between custom scripts
- Reusable parsing functions
- Domain-specific libraries (AD, cloud APIs)

---

### Script Chaining Workflows

**Combine multiple scripts for comprehensive enumeration:**

**HTTP Complete Assessment:**
```bash
nmap -p80,443 \
  --script http-title,http-server-header \
  --script http-enum,http-methods,http-headers \
  --script http-vuln-*,http-waf-detect \
  <target>
```

**SMB Full Enumeration:**
```bash
nmap -p445 \
  --script smb-os-discovery \
  --script smb-enum-shares,smb-enum-users,smb-enum-groups \
  --script smb-vuln-* \
  <target>
```

**Database Complete Check:**
```bash
nmap -p3306 \
  --script mysql-info,mysql-empty-password \
  --script mysql-databases,mysql-users \
  --script mysql-brute --script-args userdb=users.txt \
  <target>
```

---

### Performance Optimization Techniques

**1. HTTP Pipelining:**
```bash
# Increase from default 40 to 100
nmap --script http-enum --script-args http.pipeline=100 <target>
```

**2. Parallelization Control:**
```bash
# Control NSE parallelism
nmap --script http-enum --min-parallelism 10 --max-parallelism 100 <target>
```

**3. Script Timeout:**
```bash
# Prevent hung scripts
nmap --script vuln --script-timeout 120s <target>
```

**4. Multiple Scripts in Parallel:**
```bash
# Comma-separated scripts run concurrently
nmap --script http-enum,http-methods,http-headers <target>
```

---

## Advanced OSCP Workflows

### Complete Enumeration Chain

```bash
# Phase 1: Discovery (Fast)
nmap -p- -T4 --min-rate 1000 -oA discovery <target>

# Phase 2: Service Detection
nmap -sV -sC -p <discovered_ports> -oA services <target>

# Phase 3: HTTP Deep Dive (if web found)
nmap --script http-enum,http-methods,http-headers,http-title \
     --script-args http.pipeline=100 \
     -p <http_ports> -oA http_enum <target>

# Phase 4: Vulnerability Scan (Chapter 9 Part 2 vulns library)
nmap --script vuln --script-args vulns.showall \
     -p <discovered_ports> -oA vuln_audit <target>

# Phase 5: Targeted Exploitation
nmap --script http-shellshock,smb-vuln-ms17-010 \
     -d4 --script-timeout 5m <target>
```

### Debug and Troubleshoot

```bash
# When script fails silently
nmap --script <script> -d4 --script-trace <target>

# When script hangs
nmap --script <script> --script-timeout 2m <target>

# When HTTP script fails
nmap --script http-enum --script-args http.pipeline=1 -d4 <target>

# Save complete debug log
nmap --script <script> -d9 --script-trace <target> 2>&1 | tee full_debug.log
```

---

## NSE Script Development Best Practices

**1. Use vulns library for vulnerability reporting:**
```lua
local vulns = require "vulns"
-- Provides standardized output format
```

**2. Implement exception handling:**
```lua
local catch = function() socket:close() end
local try = nmap.new_try(catch)
```

**3. Add threading for parallel operations:**
```lua
local co = stdnse.new_thread(worker_func, host.ip, port)
```

**4. Use httpspider for web crawling:**
```lua
local crawler = httpspider.Crawler:new(host, port, '/', {...})
```

**5. Optimize with HTTP pipelining:**
```lua
local reqs = http.pipeline_add('/path1', nil, reqs)
local results = http.pipeline(host, port, reqs)
```

---

## Troubleshooting Guide

### Common Issues and Solutions

**1. Script Not Found:**
```bash
# Update script database
nmap --script-updatedb

# Check if script exists
ls /usr/share/nmap/scripts/ | grep <script-name>
```

**2. Script Timeout:**
```bash
# Increase timeout
nmap --script <script> --script-timeout 300s <target>
```

**3. HTTP Pipelining Fails:**
```bash
# Disable pipelining
nmap --script http-enum --script-args http.pipeline=1 <target>

# Check server support
curl -I http://target/ | grep -i keep-alive
```

**4. Argument Parsing Errors:**
```bash
# Check format (no spaces around =)
# WRONG: --script-args user = admin
# RIGHT: --script-args user=admin

# Quote values with spaces
--script-args http.useragent="Mozilla 5.0"
```

**5. Script Fails Silently:**
```bash
# Enable debug
nmap --script <script> -d4 <target>

# Check dependencies
head -20 /usr/share/nmap/scripts/<script>.nse
```

---

## Quick Reference Tables

### Advanced NSE Flags

| Flag | Purpose | Example |
|------|---------|---------|
| `-d4` | NSE debug (HTTP/network ops) | `nmap --script http-enum -d4 <target>` |
| `--script-trace` | Line-by-line execution | `nmap --script http-enum --script-trace <target>` |
| `--script-timeout` | Prevent hanging | `nmap --script vuln --script-timeout 2m <target>` |
| `--packet-trace` | Packet-level debug | `nmap --script http-enum --packet-trace <target>` |

### HTTP Pipelining Values

| Value | Use Case | Speed | Reliability |
|-------|----------|-------|-------------|
| `1` | Disabled (troubleshooting) | Slow | High |
| `40` | Default | Normal | High |
| `100` | Fast server | Fast | Medium |
| `200+` | Very fast server | Very Fast | Low |

### Vulnerability States (vulns library)

| State | Lua Constant | Meaning |
|-------|--------------|---------|
| `VULNERABLE` | `vulns.STATE.VULN` | Confirmed vulnerable |
| `VULNERABLE (Exploitable)` | `vulns.STATE.EXPLOIT` | Exploitable with PoC |
| `VULNERABLE (DoS)` | `vulns.STATE.DoS` | DoS vulnerability |
| `LIKELY VULNERABLE` | `vulns.STATE.LIKELY_VULN` | Probable (verify manually) |
| `NOT VULNERABLE` | `vulns.STATE.NOT_VULN` | Not vulnerable |

---

## Integration with CRACK Track

**NSE scan profiles available in:**
```
/home/kali/OSCP/crack/track/data/scan_profiles.json
```

**Advanced profiles include:**
- `nse-vuln-comprehensive` - All vuln category scripts
- `nse-script-chaining-http` - Multi-script HTTP enumeration
- `nse-http-pipelining` - Optimized HTTP scanning
- `nse-debug-levels` - Troubleshooting configurations
- `nse-parallel-scripting` - Concurrent script execution

**Usage:**
```bash
crack track import <target> nmap_scan.xml
# NSE script output auto-parsed and integrated into task tree
```

---

**Generated:** 2025-10-08
**Source:** Nmap Cookbook Chapter 9 Parts 1 & 2 (NSE Basics + Advanced Techniques)
**CRACK Track Integration:** NSE scan profiles available in `crack/track/data/scan_profiles.json`
**Version:** 2.0 (Extended with Advanced Techniques)
