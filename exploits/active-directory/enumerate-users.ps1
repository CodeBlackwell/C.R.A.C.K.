function LDAPSearch {
      param (
          [string]$LDAPQuery
      )

      $PDC = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name
      $DistinguishedName = ([adsi]'').distinguishedName

      $DirectoryEntry = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$PDC/$DistinguishedName")
      $DirectorySearcher = New-Object System.DirectoryServices.DirectorySearcher($DirectoryEntry, $LDAPQuery)

      return $DirectorySearcher.FindAll()
  }

  function Get-NestedGroupMember {
      <#
      .SYNOPSIS
          Recursively enumerates all members of an AD group including nested groups
      
      .PARAMETER GroupName
          Name of the AD group to enumerate
      
      .PARAMETER ShowTree
          Display hierarchical tree structure during enumeration
      
      .PARAMETER UsersOnly
          Return only user objects (exclude groups)
      
      .PARAMETER OutputFormat
          Choose output format: Objects (default), Table, List, Tree
      
      .PARAMETER Depth
          Internal parameter for recursion depth (do not use manually)
      
      .EXAMPLE
          Get-NestedGroupMember -GroupName "Service Personnel"
      
      .EXAMPLE
          Get-NestedGroupMember -GroupName "Domain Admins" -ShowTree -UsersOnly
      
      .EXAMPLE
          Get-NestedGroupMember -GroupName "IT Support" -OutputFormat Table | Export-Csv users.csv
      #>

      param (
          [Parameter(Mandatory=$true)]
          [string]$GroupName,

          [switch]$ShowTree,

          [switch]$UsersOnly,

          [ValidateSet("Objects","Table","List","Tree")]
          [string]$OutputFormat = "Objects",

          [int]$Depth = 0
      )

      # Internal recursion function
      function Recurse-Group {
          param (
              [string]$GName,
              [int]$D
          )

          $indent = "  " * $D

          if ($ShowTree) {
              Write-Host "$indent[+] $GName" -ForegroundColor Cyan
          }

          $groupResult = LDAPSearch -LDAPQuery "(&(objectCategory=group)(name=$GName))"

          if ($groupResult.Count -eq 0) {
              if ($ShowTree) {
                  Write-Host "$indent[-] Group not found" -ForegroundColor Red
              }
              return
          }

          $group = $groupResult[0]
          $members = $group.Properties.member

          if ($members.Count -eq 0) {
              return
          }

          foreach ($memberDN in $members) {
              $memberSearch = LDAPSearch -LDAPQuery "(distinguishedName=$memberDN)"

              if ($memberSearch.Count -gt 0) {
                  $member = $memberSearch[0]
                  $memberName = $member.Properties.name[0]
                  $objectClass = $member.Properties.objectclass

                  if ($objectClass -contains "group") {
                      if ($ShowTree) {
                          Write-Host "$indent  [GROUP] $memberName" -ForegroundColor Magenta
                      }

                      if (-not $UsersOnly) {
                          # Create group object
                          $groupObj = [PSCustomObject]@{
                              Type = "Group"
                              Name = $memberName
                              SAMAccountName = $member.Properties.samaccountname[0]
                              DistinguishedName = $memberDN
                              Description = $member.Properties.description[0]
                              Depth = $D
                          }
                          $script:AllMembers += $groupObj
                      }

                      Recurse-Group -GName $memberName -D ($D + 1)
                  }
                  elseif ($objectClass -contains "user") {
                      if ($ShowTree) {
                          Write-Host "$indent  [USER] $memberName" -ForegroundColor Green
                      }

                      # Create user object
                      $userObj = [PSCustomObject]@{
                          Type = "User"
                          Name = $memberName
                          SAMAccountName = $member.Properties.samaccountname[0]
                          DistinguishedName = $memberDN
                          Description = $member.Properties.description[0]
                          Email = $member.Properties.mail[0]
                          Enabled = -not ($member.Properties.useraccountcontrol[0] -band 2)
                          Depth = $D
                          RawObject = $member
                      }
                      $script:AllMembers += $userObj
                  }
              }
          }
      }

      # Initialize collection
      $script:AllMembers = @()

      # Start recursion
      Recurse-Group -GName $GroupName -D $Depth

      # Output based on format
      switch ($OutputFormat) {
          "Objects" {
              return $script:AllMembers
          }
          "Table" {
              $script:AllMembers | Format-Table Type, Name, SAMAccountName, Description -AutoSize
          }
          "List" {
              $script:AllMembers | Format-List Type, Name, SAMAccountName, Email, Description, DistinguishedName
          }
          "Tree" {
              # Tree already displayed with ShowTree
              return $script:AllMembers
          }
      }
  }

  # Helper function to get last user
  function Get-LastNestedUser {
      param (
          [Parameter(Mandatory=$true)]
          [string]$GroupName,

          [switch]$ShowAllAttributes
      )

      $users = Get-NestedGroupMember -GroupName $GroupName -UsersOnly

      if ($users.Count -eq 0) {
          Write-Host "No users found in group: $GroupName" -ForegroundColor Red
          return
      }

      $lastUser = $users[-1]

      Write-Host "`n========================================" -ForegroundColor Yellow
      Write-Host "LAST USER: $($lastUser.Name)" -ForegroundColor Yellow
      Write-Host "========================================" -ForegroundColor Yellow

      if ($ShowAllAttributes) {
          # Show ALL attributes from raw object
          foreach ($prop in $lastUser.RawObject.Properties.PropertyNames) {
              Write-Host "$prop : $($lastUser.RawObject.Properties[$prop])" -ForegroundColor White
          }
      } else {
          # Show common attributes
          $lastUser | Format-List Name, SAMAccountName, Email, Description, DistinguishedName
      }

      return $lastUser
  }

